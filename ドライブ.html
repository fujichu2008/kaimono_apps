<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ゆるドライブ</title>
<meta name="theme-color" content="#2b8a3e">
<style>
:root{
  --bg:#f0f7ff; --card:#ffffff; --line:#d7e6ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b8a3e; --accent-2:#18753a; --warn:#ef4444; --ok:#16a34a; --gold:#f5c542;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff 0%,#f7fbff 100%);border-bottom:1px solid var(--line)}
header .bar{max-width:880px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:10px;padding:8px 10px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button.ghost{background:#fff}
#gameWrap{max-width:880px;margin:10px auto;padding:10px}
.board{position:relative;margin:0 auto;background:linear-gradient(180deg,#cfe8ff 0%,#bfe0ff 50%,#dff4ff 100%);border-radius:18px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(0,0,0,.06);overflow:hidden;touch-action:manipulation}
.hud{position:absolute;left:0;top:0;right:0;display:flex;justify-content:space-between;gap:8px;padding:8px 10px;font-weight:700;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.6));backdrop-filter:blur(2px);z-index:3}
.hud .pill{background:#fff;border:1px solid var(--line);padding:4px 10px;border-radius:999px}
.world{position:absolute;inset:0}
.car{position:absolute;bottom:10%;left:50%;transform:translate(-50%,0);font-size:36px;z-index:2}
.car.shadow::after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);width:30px;height:6px;border-radius:999px;background:rgba(0,0,0,.15)}
.obj{position:absolute;transform:translate(-50%,-50%);font-size:28px;line-height:1}
/* メダル（○ or ☆） */
.medal{position:absolute;display:flex;align-items:center;justify-content:center;transform:translate(-50%,-50%);font-weight:800;color:#1f2937}
.medal.circle{width:46px;height:46px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8d6, #f9d879 45%, #e6b83d 60%, #c9972e 100%);border:2px solid #d4a025;box-shadow:0 4px 10px rgba(0,0,0,.18)}
.medal.star{width:52px;height:52px;}
.medal.star::before{content:'⭐';position:absolute;font-size:44px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));}
.medal .num{position:relative;}
.touchLayer{position:absolute;inset:0;z-index:4}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:20px;z-index:6}
.overlay.show{display:flex}
.overlay .card{background:#ffffff; color:var(--text); border-radius:16px; padding:14px 16px; border:1px solid var(--line); min-width:260px}
.toast{position:absolute;left:50%;top:18%;transform:translate(-50%,0);background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none;z-index:7}
.toast.show{display:block}
.hitFX{position:absolute;pointer-events:none;z-index:5;font-size:28px}
/* 紙吹雪 */
.confetti{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.95;pointer-events:none;z-index:8}
.board{height:70vh;max-height:720px;min-height:480px}
@media (max-width:480px){ .board{height:72vh;min-height:420px} }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">🚗 ゆるドライブ <span class="badge">v3.1</span></div>
      <div class="controls">
        <label>モード
          <select id="modeSelect" title="モード選択">
            <option value="kids" selected>やさしい（減点なし／時間制）</option>
            <option value="normal">ふつう（当たりで減点／時間制）</option>
          </select>
        </label>
        <button id="btnStart" class="primary">▶ はじめる</button>
        <button id="btnPause" class="ghost">⏸ 一時停止</button>
        <button id="btnRestart" class="ghost">↻ リスタート</button>
      </div>
    </div>
  </header>

  <div id="gameWrap">
    <div id="board" class="board" role="application" aria-label="ゆるドライブ ゲームエリア">
      <div class="hud">
        <div class="pill">スコア <span id="sc">0</span></div>
        <div class="pill">メダル <span id="medals">0</span></div>
        <div class="pill">タイマー <span id="time">60.0</span>s</div>
      </div>
      <div id="world" class="world" aria-hidden="true"></div>
      <div id="car" class="car shadow" aria-label="くるま">🚗</div>
      <div id="touchLayer" class="touchLayer"></div>
      <div id="toast" class="toast">+1</div>
      <div id="overlay" class="overlay" aria-live="polite">
        <div class="card">
          <h3 style="margin:6px 0 10px">タイムアップ！</h3>
          <p style="margin:0 0 10px">スコア：<b id="finalScore">0</b><br>獲得メダル：<b id="finalMedals">0</b></p>
          <button id="btnAgain" class="primary">もう一度</button>
        </div>
      </div>
    </div>
    <p style="opacity:.7;margin:10px 4px 0">操作：画面タップ＝その位置へ車がスムーズ移動 ／ キーボード ← → で左右（長押しで連続）</p>
  </div>

<script>
(() => {
  const board = document.getElementById('board');
  const world = document.getElementById('world');
  const carEl = document.getElementById('car');
  const touchLayer = document.getElementById('touchLayer');
  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalMedalsEl = document.getElementById('finalMedals');
  const scEl = document.getElementById('sc');
  const timeEl = document.getElementById('time');
  const medalsEl = document.getElementById('medals');
  const toast = document.getElementById('toast');
  const modeSelect = document.getElementById('modeSelect');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnAgain = document.getElementById('btnAgain');

  // 追加：🌳木オブジェクト、効果音、紙吹雪
  const EMOJI = { cone:'🚧', rock:'🪨', box:'📦', tree:'🌳' };

  const DIGIT_JA = ['ゼロ','いち','に','さん','よん','ご','ろく','なな','はち','きゅう'];

  const state = {
    running:false, paused:false,
    carX:0.5, carTargetX:0.5, carYRatio:0.82,
    speed:110, speedMax:170,
    // 出現バランス微調整：ややテンポアップ
    spawnMin:600, spawnMax:1100, spawnCd:0,
    medalProb:0.5, // メダル出現（0.45→0.5へ）
    objs:[], lastT:0,
    score:0, medals:0,
    timeLeft:60.0,
    mode:'kids',
    invul:0,
    combo:0  // 連続メダル用
  };

  // ====== 効果音（WebAudioで合成、外部ファイル不要） ======
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    return !!audioCtx;
  }
  function beep({type='sine', f1=880, f2=1320, dur=0.18, gain=0.05}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(f1, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+dur*0.7);
    g.gain.value = gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }
  function thud({f=110, dur=0.2, gain=0.08}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const n = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; n.type='triangle';
    o.frequency.setValueAtTime(f, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+dur);
    n.frequency.setValueAtTime(f*0.5, ctx.currentTime);
    n.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+dur);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); n.connect(g); g.connect(ctx.destination);
    o.start(); n.start(); o.stop(ctx.currentTime+dur); n.stop(ctx.currentTime+dur);
  }
  function playSnd(kind){
    if(kind==='medal'){ // チャリン系2音
      beep({type:'sine', f1:1000, f2:1600, dur:0.12, gain:0.05});
      setTimeout(()=>beep({type:'triangle', f1:800, f2:1400, dur:0.10, gain:0.045}), 60);
    }else if(kind==='hit'){
      thud({f:140, dur:0.22, gain:0.085});
    }else if(kind==='confetti'){
      beep({type:'square', f1:900, f2:1100, dur:0.08, gain:0.035});
    }
  }

  // ====== 紙吹雪（小／大） ======
  function rand(min,max){ return min + Math.random()*(max-min); }
  function confettiBurst({count=40, big=false}={}){
    const rect = board.getBoundingClientRect();
    for(let i=0;i<count;i++){
      const s = document.createElement('div');
      s.className='confetti';
      const x = rand(0, rect.width);
      const y = big ? rand(-20, 20) : rand(40, 120);
      s.style.left = x + 'px';
      s.style.top  = y + 'px';
      // ランダム色
      const colors = ['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#1abc9c'];
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      s.style.transform = `rotate(${Math.floor(rand(-30,30))}deg)`;
      board.appendChild(s);
      const dy = rect.height + rand(80,160);
      const dx = rand(-80,80);
      const rot = rand(180, 720);
      s.animate([
        {transform:`translate(0,0) rotate(0deg)`, opacity:1},
        {transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0.9}
      ], {duration: rand(1200, 2200), easing:'cubic-bezier(.2,.6,.2,1)'}).onfinish = ()=> s.remove();
    }
    playSnd('confetti');
  }

  function smallConfetti(){ confettiBurst({count:36, big:false}); }
  function bigConfetti(){ confettiBurst({count:180, big:true}); }

  function reset(){
    state.running=false; state.paused=false; state.lastT=0;
    state.carX=0.5; state.carTargetX=0.5;
    state.speed = (modeSelect.value==='kids'?110:120);
    state.speedMax = (modeSelect.value==='kids'?170:190);
    state.spawnMin = 600; state.spawnMax = 1100; state.spawnCd=0;
    state.medalProb = 0.5;
    state.objs.length=0; world.innerHTML='';
    state.score=0; state.medals=0; state.timeLeft=60.0; state.invul=0; state.combo=0;
    state.mode = modeSelect.value;
    overlay.classList.remove('show');
    updateHUD();
    placeCar();
  }

  function start(){ if(state.running) return; state.running=true; state.paused=false; state.lastT=performance.now(); requestAnimationFrame(loop); }
  function pause(){ state.paused=!state.paused; btnPause.textContent=state.paused?'▶ 再開':'⏸ 一時停止'; if(!state.paused){ state.lastT=performance.now(); requestAnimationFrame(loop);} }

  function updateHUD(){ scEl.textContent=state.score; medalsEl.textContent=state.medals; timeEl.textContent=state.timeLeft.toFixed(1); }

  function placeCar(){ const w = board.clientWidth; const x = clamp(state.carX,0.05,0.95)*w; carEl.style.left = x + 'px'; }

  function lerp(a,b,t){ return a + (b-a)*t; }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  function digitFontSize(d){ // 0が最大、9が最小（不自然すぎない範囲）
    return 42 - d*1.5; // 0→42px, 9→28.5px
  }

  function spawn(){
    const xRatio = 0.08 + Math.random()*0.84; // 8%〜92%
    const isMedal = Math.random() < state.medalProb;
    if(!isMedal){
      // 障害物（🚧📦🪨🌳）
      const p = Math.random();
      const type = p<0.4 ? 'cone' : (p<0.7? 'box' : (p<0.88?'rock':'tree'));
      const el = document.createElement('div');
      el.className='obj'; el.textContent = (type==='cone'? EMOJI.cone : type==='box'? EMOJI.box : type==='rock'? EMOJI.rock : EMOJI.tree);
      el.dataset.type=type;
      world.appendChild(el);
      const o = { el, type, xRatio, y:-30 };
      positionObj(o); state.objs.push(o);
    }else{
      // メダル（0-9、○or☆）
      const digit = Math.floor(Math.random()*10);
      const kind = Math.random() < 0.5 ? 'circle' : 'star';
      const el = document.createElement('div');
      el.className = `medal ${kind}`;
      el.dataset.type='medal'; el.dataset.digit=String(digit); el.dataset.kind=kind;
      const num = document.createElement('div'); num.className='num'; num.textContent=String(digit);
      num.style.fontSize = digitFontSize(digit)+ 'px';
      el.appendChild(num);
      world.appendChild(el);
      const o = { el, type:'medal', xRatio, y:-30, digit, kind };
      positionObj(o); state.objs.push(o);
    }
  }

  function positionObj(o){ const w = board.clientWidth; o.el.style.left = (o.xRatio*w) + 'px'; o.el.style.top  = (o.y) + 'px'; }

  // === PART SPLIT HERE ===  （後半はこの続きにそのまま貼り付け）

  function showToast(text='+1'){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 450);
  }

  function speakDigit(d){
    try{
      const u=new SpeechSynthesisUtterance(DIGIT_JA[d]||String(d));
      u.lang='ja-JP'; u.rate=1.0;
      speechSynthesis.speak(u);
    }catch(e){}
  }

  function showHitFX(){
    const fx = document.createElement('div'); fx.className='hitFX'; fx.textContent='💥';
    const rect = carEl.getBoundingClientRect(); const brect = board.getBoundingClientRect();
    fx.style.left = (rect.left - brect.left + rect.width/2) + 'px';
    fx.style.top  = (rect.top - brect.top) + 'px';
    board.appendChild(fx);
    fx.animate(
      [{transform:'translate(-50%,-50%) scale(1)',opacity:1},
       {transform:'translate(-50%,-20%) scale(1.6)',opacity:0}],
      {duration:500,easing:'ease-out'}
    ).onfinish=()=>fx.remove();
    carEl.animate(
      [{transform:'translate(-50%,0)'},
       {transform:'translate(-50%,0) rotate(-3deg)'},
       {transform:'translate(-50%,0) rotate(3deg)'},
       {transform:'translate(-50%,0)'}],
      {duration:280}
    );
  }

  function onCollectMedal(o){
    state.medals++;
    state.score += o.digit; // 数字分を加算
    state.combo++;
    showToast('+'+o.digit);
    speakDigit(o.digit);
    playSnd('medal');

    // 連続5回ごとに小紙吹雪
    if(state.combo>0 && state.combo % 5 === 0){
      smallConfetti();
    }
  }

  function onHitObstacle(){
    if(state.invul>0) return;
    state.combo = 0; // 連続取得リセット
    showHitFX();
    playSnd('hit');
    state.invul = 600; // 0.6s 無敵
    if(state.mode!== 'kids') state.score = Math.max(0, state.score - 10);
    state.speed = Math.max(90, state.speed - 20);
  }

  function endGame(){
    state.running=false;
    finalScoreEl.textContent=state.score;
    finalMedalsEl.textContent=state.medals;
    overlay.classList.add('show');
    // ゴール時は盛大な紙吹雪
    bigConfetti();
  }

  function loop(t){
    if(!state.running) return;
    if(state.paused){ requestAnimationFrame(loop); return; }
    const dtMs = state.lastT? Math.min(60, t - state.lastT) : 16; state.lastT = t; const dt = dtMs/1000;

    // 時間
    state.timeLeft = Math.max(0, state.timeLeft - dt);
    if(state.timeLeft<=0){ updateHUD(); endGame(); return; }

    // 車の移動
    state.carX = lerp(state.carX, state.carTargetX, Math.min(1, dt*6.5));
    placeCar();

    // スポーン
    state.spawnCd -= dtMs; if(state.spawnCd<=0){ spawn(); state.spawnCd = rand(state.spawnMin, state.spawnMax); }

    // 落下
    const vy = state.speed * dt; for(const o of state.objs){ o.y += vy; positionObj(o); }

    // 判定
    const carRect = carEl.getBoundingClientRect(); const brect = board.getBoundingClientRect();
    const carX = carRect.left - brect.left + carRect.width/2; const carY = carRect.top - brect.top + carRect.height*0.2;

    for(const o of state.objs){
      if(o._gone) continue;
      const ox = o.xRatio * board.clientWidth; const oy = o.y;
      const dx = Math.abs(ox - carX); const dy = Math.abs(oy - carY);
      if(dx < 26 && dy < 26){
        if(o.type==='medal') onCollectMedal(o); else onHitObstacle();
        o._gone=true; o.el.remove();
      }
    }

    // 掃除
    state.objs = state.objs.filter(o=>{
      if(o._gone) return false;
      if(o.y > board.clientHeight + 60){ o.el.remove(); return false; }
      return true;
    });

    // 緩やか加速と無敵減衰
    state.speed = Math.min(state.speedMax, state.speed + dt*6);
    if(state.invul>0) state.invul = Math.max(0, state.invul - dtMs);

    updateHUD();
    requestAnimationFrame(loop);
  }

  // 入力：タップ/クリック/ペン（初回でAudio解放）
  function unlockAudioOnce(){ ensureAudio(); touchLayer.removeEventListener('pointerdown', unlockAudioOnce); }
  touchLayer.addEventListener('pointerdown', unlockAudioOnce, {once:false});

  touchLayer.addEventListener('pointerdown',(e)=>{
    const rect = board.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width; state.carTargetX = clamp(x,0.05,0.95);
  });
  touchLayer.addEventListener('pointermove',(e)=>{
    if(e.pressure===0 && !e.buttons) return;
    const rect = board.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width; state.carTargetX = clamp(x,0.05,0.95);
  });

  // キー
  window.addEventListener('keydown',(e)=>{
    const step = 0.05;
    if(e.key==='ArrowLeft'){ state.carTargetX = clamp(state.carTargetX-step,0.05,0.95); e.preventDefault(); }
    if(e.key==='ArrowRight'){ state.carTargetX = clamp(state.carTargetX+step,0.05,0.95); e.preventDefault(); }
    if(e.key===' '){ pause(); e.preventDefault(); }
  });

  // ボタン
  btnStart.addEventListener('click', ()=>{ reset(); start(); });
  btnPause.addEventListener('click', ()=> pause());
  btnRestart.addEventListener('click', ()=>{ reset(); start(); });
  btnAgain && btnAgain.addEventListener('click', ()=>{ reset(); start(); });
  modeSelect.addEventListener('change', ()=>{ reset(); });

  // 初期
  reset();
})();
</script>
</body>
</html>
