<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ゆるドライブ</title>
<meta name="theme-color" content="#2b8a3e">
<style>
:root{
  --bg:#f0f7ff; --card:#ffffff; --line:#d7e6ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b8a3e; --accent-2:#18753a; --warn:#ef4444; --ok:#16a34a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff 0%,#f7fbff 100%);border-bottom:1px solid var(--line)}
header .bar{max-width:880px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 10px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button.ghost{background:#fff}
#gameWrap{max-width:880px;margin:10px auto;padding:10px}
.board{position:relative;margin:0 auto;background:linear-gradient(180deg,#cfe8ff 0%,#bfe0ff 50%,#dff4ff 100%);border-radius:18px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(0,0,0,.06);overflow:hidden;touch-action:manipulation}
.hud{position:absolute;left:0;top:0;right:0;display:flex;justify-content:space-between;gap:8px;padding:8px 10px;font-weight:700;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.6));backdrop-filter:blur(2px);z-index:3}
.hud .pill{background:#fff;border:1px solid var(--line);padding:4px 10px;border-radius:999px}
.world{position:absolute;inset:0}
.car{position:absolute;bottom:10%;left:50%;transform:translate(-50%,0);font-size:36px;z-index:2}
.car.shadow::after{content:"";position:absolute;left:50%;bottom:-6px;transform:translateX(-50%);width:30px;height:6px;border-radius:999px;background:rgba(0,0,0,.15)}
.obj{position:absolute;transform:translate(-50%,-50%);font-size:28px;line-height:1}
.touchLayer{position:absolute;inset:0;z-index:4}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:20px;z-index:6}
.overlay.show{display:flex}
.overlay .card{background:#ffffff; color:var(--text); border-radius:16px; padding:14px 16px; border:1px solid var(--line); min-width:260px}
.toast{position:absolute;left:50%;top:18%;transform:translate(-50%,0);background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none;z-index:7}
.toast.show{display:block}
.hitFX{position:absolute;pointer-events:none;z-index:5;font-size:28px}
.board{height:70vh;max-height:720px;min-height:480px}
@media (max-width:480px){ .board{height:72vh;min-height:420px} }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">🚗 ゆるドライブ <span class="badge">v2</span></div>
      <div class="controls">
        <label>モード
          <select id="modeSelect" title="モード選択">
            <option value="kids" selected>やさしい（減点なし／時間制）</option>
            <option value="normal">ふつう（当たりで減点／時間制）</option>
          </select>
        </label>
        <button id="btnStart" class="primary">▶ はじめる</button>
        <button id="btnPause" class="ghost">⏸ 一時停止</button>
        <button id="btnRestart" class="ghost">↻ リスタート</button>
      </div>
    </div>
  </header>

  <div id="gameWrap">
    <div id="board" class="board" role="application" aria-label="ゆるドライブ ゲームエリア">
      <div class="hud">
        <div class="pill">スコア <span id="sc">0</span></div>
        <div class="pill">⭐ <span id="stars">0</span></div>
        <div class="pill">タイマー <span id="time">60.0</span>s</div>
      </div>
      <div id="world" class="world" aria-hidden="true"></div>
      <div id="car" class="car shadow" aria-label="くるま">🚗</div>
      <div id="touchLayer" class="touchLayer"></div>
      <div id="toast" class="toast">+10</div>
      <div id="overlay" class="overlay" aria-live="polite">
        <div class="card">
          <h3 style="margin:6px 0 10px">タイムアップ！</h3>
          <p style="margin:0 0 10px">スコア：<b id="finalScore">0</b><br>獲得スター：<b id="finalStars">0</b></p>
          <button id="btnAgain" class="primary">もう一度</button>
        </div>
      </div>
    </div>
    <p style="opacity:.7;margin:10px 4px 0">操作：画面タップ＝その位置へ車がスムーズ移動 ／ キーボード ← → で左右（長押しで連続）</p>
  </div>

<script>
(() => {
  const board = document.getElementById('board');
  const world = document.getElementById('world');
  const carEl = document.getElementById('car');
  const touchLayer = document.getElementById('touchLayer');
  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalStarsEl = document.getElementById('finalStars');
  const scEl = document.getElementById('sc');
  const timeEl = document.getElementById('time');
  const starsEl = document.getElementById('stars');
  const toast = document.getElementById('toast');
  const modeSelect = document.getElementById('modeSelect');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnAgain = document.getElementById('btnAgain');

  const EMOJI = { star:'⭐', coin:'🟡', heart:'❤️', cone:'🚧', rock:'🪨', box:'📦' };

  const state = {
    running:false, paused:false,
    // 位置は0..1の正規化（左右端）
    carX:0.5, carTargetX:0.5, carYRatio:0.82,
    speed:120, // px/sec （ゆっくり）
    speedMax:190, // 上限も低め
    spawnMin:700, spawnMax:1200, spawnCd:0,
    objs:[], lastT:0,
    score:0, stars:0,
    timeLeft:60.0,
    mode:'kids',
    invul:0
  };

  function reset(){
    state.running=false; state.paused=false; state.lastT=0;
    state.carX=0.5; state.carTargetX=0.5;
    state.speed = (modeSelect.value==='kids'?110:120);
    state.speedMax = (modeSelect.value==='kids'?170:190);
    state.spawnMin = 700; state.spawnMax = 1200; state.spawnCd=0;
    state.objs.length=0; world.innerHTML='';
    state.score=0; state.stars=0; state.timeLeft=60.0; state.invul=0;
    state.mode = modeSelect.value;
    overlay.classList.remove('show');
    updateHUD();
    placeCar();
  }

  function start(){ if(state.running) return; state.running=true; state.paused=false; state.lastT=performance.now(); requestAnimationFrame(loop); }
  function pause(){ state.paused=!state.paused; btnPause.textContent=state.paused?'▶ 再開':'⏸ 一時停止'; if(!state.paused){ state.lastT=performance.now(); requestAnimationFrame(loop);} }

  function updateHUD(){ scEl.textContent=state.score; starsEl.textContent=state.stars; timeEl.textContent=state.timeLeft.toFixed(1); }

  function placeCar(){
    const w = board.clientWidth; const x = Math.max(0.05, Math.min(0.95, state.carX)) * w;
    carEl.style.left = x + 'px';
  }

  function lerp(a,b,t){ return a + (b-a)*t; }

  function spawn(){
    const xRatio = 0.08 + Math.random()*0.84; // 8%〜92%
    const isObstacle = Math.random() < 0.55;
    let type, char;
    if(isObstacle){
      const p = Math.random();
      type = p<0.6 ? 'cone' : (p<0.85? 'box' : 'rock');
      char = type==='cone'? EMOJI.cone : type==='box'? EMOJI.box : EMOJI.rock;
    }else{
      type = Math.random() < 0.6 ? 'star' : 'coin';
      char = type==='star'? EMOJI.star : EMOJI.coin;
    }
    const el = document.createElement('div');
    el.className='obj'; el.textContent=char; el.dataset.type=type;
    world.appendChild(el);
    const o = { el, type, xRatio, y:-30 };
    positionObj(o);
    state.objs.push(o);
  }

  function positionObj(o){
    const w = board.clientWidth; const h = board.clientHeight;
    o.el.style.left = (o.xRatio*w) + 'px';
    o.el.style.top  = (o.y) + 'px';
  }

  function showToast(text='+10'){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 450); }

  function showHitFX(){
    const fx = document.createElement('div'); fx.className='hitFX'; fx.textContent='💥';
    const rect = carEl.getBoundingClientRect(); const brect = board.getBoundingClientRect();
    fx.style.left = (rect.left - brect.left + rect.width/2) + 'px';
    fx.style.top  = (rect.top - brect.top) + 'px';
    board.appendChild(fx);
    fx.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:'translate(-50%,-20%) scale(1.6)',opacity:0}],{duration:500,easing:'ease-out'}).onfinish=()=>fx.remove();
    carEl.animate([{transform:'translate(-50%,0)'},{transform:'translate(-50%,0) rotate(-3deg)'},{transform:'translate(-50%,0) rotate(3deg)'},{transform:'translate(-50%,0)'}],{duration:280});
  }

  function onCollect(o){
    if(o.type==='star'){ state.stars++; state.score += 10; showToast('+10'); }
    else if(o.type==='coin'){ state.score += 5; showToast('+5'); }
  }

  function onHitObstacle(){
    if(state.invul>0) return;
    showHitFX(); state.invul = 600; // 0.6s 無敵
    // 減点（やさしいは減点なし）と軽い減速
    if(state.mode!== 'kids') state.score = Math.max(0, state.score - 10);
    state.speed = Math.max(90, state.speed - 20);
  }

  function endGame(){
    state.running=false;
    finalScoreEl.textContent=state.score;
    finalStarsEl.textContent=state.stars;
    overlay.classList.add('show');
  }

  function loop(t){
    if(!state.running) return;
    if(state.paused){ requestAnimationFrame(loop); return; }
    const dtMs = state.lastT? Math.min(60, t - state.lastT) : 16; // ms
    state.lastT = t;
    const dt = dtMs / 1000; // sec

    // 時間
    state.timeLeft = Math.max(0, state.timeLeft - dt);
    if(state.timeLeft<=0){ updateHUD(); endGame(); return; }

    // 車のスムーズ移動
    state.carX = lerp(state.carX, state.carTargetX, Math.min(1, dt*6.5));
    placeCar();

    // スポーン
    state.spawnCd -= dtMs;
    if(state.spawnCd<=0){ spawn(); state.spawnCd = rand(state.spawnMin, state.spawnMax); }

    // オブジェクトの落下
    const vy = state.speed * dt; // px
    for(const o of state.objs){ o.y += vy; positionObj(o); }

    // 衝突判定（円に近い簡易判定）
    const carRect = carEl.getBoundingClientRect();
    const brect = board.getBoundingClientRect();
    const carX = carRect.left - brect.left + carRect.width/2;
    const carY = carRect.top  - brect.top  + carRect.height*0.2; // 先端寄り

    for(const o of state.objs){
      if(o._gone) continue;
      const ox = o.xRatio * board.clientWidth;
      const oy = o.y;
      const dx = Math.abs(ox - carX);
      const dy = Math.abs(oy - carY);
      if(dx < 26 && dy < 26){
        if(o.type==='star' || o.type==='coin') onCollect(o);
        else onHitObstacle();
        o._gone = true; o.el.remove();
      }
    }

    // 画面外の掃除
    state.objs = state.objs.filter(o=>{ if(o._gone) return false; if(o.y > board.clientHeight + 60){ o.el.remove(); return false; } return true; });

    // じわっと加速（上限あり） & 無敵減衰
    state.speed = Math.min(state.speedMax, state.speed + dt*6);
    if(state.invul>0) state.invul = Math.max(0, state.invul - dtMs);

    updateHUD();
    requestAnimationFrame(loop);
  }

  function rand(a,b){ return a + Math.random()*(b-a); }

  // 入力：タップ/クリック/ペン → その位置に目標を設定
  touchLayer.addEventListener('pointerdown',(e)=>{
    const rect = board.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width; // 0..1
    state.carTargetX = Math.max(0.05, Math.min(0.95, x));
  });
  // ドラッグでも追従
  touchLayer.addEventListener('pointermove',(e)=>{
    if(e.pressure===0 && !e.buttons) return; // 非押下
    const rect = board.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width;
    state.carTargetX = Math.max(0.05, Math.min(0.95, x));
  });

  // キーボード：← → でターゲットを少しずつ
  window.addEventListener('keydown',(e)=>{
    const step = 0.05; // 5%ずつ
    if(e.key==='ArrowLeft'){ state.carTargetX = Math.max(0.05, state.carTargetX - step); e.preventDefault(); }
    if(e.key==='ArrowRight'){ state.carTargetX = Math.min(0.95, state.carTargetX + step); e.preventDefault(); }
    if(e.key===' '){ pause(); e.preventDefault(); }
  });

  // ボタン
  btnStart.addEventListener('click', ()=>{ reset(); start(); });
  btnPause.addEventListener('click', ()=> pause());
  btnRestart.addEventListener('click', ()=>{ reset(); start(); });
  btnAgain && btnAgain.addEventListener('click', ()=>{ reset(); start(); });
  modeSelect.addEventListener('change', ()=>{ reset(); });

  // 初期
  reset();
})();
</script>
</body>
</html>

