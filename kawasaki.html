<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Cyber-Kawasaki Holographic Map</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Consolas, sans-serif; }
        canvas { display: block; }
        
        #ui-container {
            position: absolute; top: 20px; left: 20px; color: #00f0ff;
            pointer-events: none; text-shadow: 0 0 10px #00f0ff; z-index: 10;
        }
        h1 {
            font-size: 24px; margin: 0; letter-spacing: 2px;
            border-bottom: 2px solid #00f0ff; display: inline-block; padding-bottom: 5px;
        }
        .subtitle { font-size: 12px; opacity: 0.8; margin-top: 5px; }

        /* ポップアップ情報パネル */
        #info-panel {
            position: absolute; bottom: 30px; right: 30px; width: 300px;
            background: rgba(0, 20, 40, 0.85);
            border: 1px solid #00f0ff; border-left: 5px solid #ff0055;
            padding: 20px; color: #fff;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            backdrop-filter: blur(5px); z-index: 10;
        }
        #info-panel.active { transform: translateX(0); }
        #info-title { font-size: 18px; color: #ff0055; font-weight: bold; margin-bottom: 10px; text-shadow: 0 0 5px #ff0055; }
        #info-desc { font-size: 14px; line-height: 1.6; color: #ddd; }
        
        /* ローディング & エラー画面 */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #00f0ff; z-index: 999; transition: opacity 1s;
        }
        #error-msg { color: #ff0055; margin-top: 20px; display: none; text-align: center; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="ui-container">
        <h1>KAWASAKI CITY 3D</h1>
        <div class="subtitle">SYSTEM: ONLINE / TARGET: KANAGAWA</div>
        <div class="subtitle">DRAG TO ROTATE / SCROLL TO ZOOM / HOVER FOR DATA</div>
    </div>

    <div id="info-panel">
        <div id="info-title">LOCATION NAME</div>
        <div id="info-desc">Description text goes here...</div>
    </div>

    <div id="loader">
        <div>INITIALIZING HOLOGRAPHIC SYSTEM...</div>
        <div id="error-msg">
            ERROR: FAILED TO LOAD LIBRARIES.<br>
            Please check your internet connection.<br>
            外部CDNへの接続が必要です。
        </div>
    </div>

    <script>
        // エラーハンドリング: ライブラリが読み込めなかった場合
        if (typeof THREE === 'undefined') {
            document.getElementById('error-msg').style.display = 'block';
            throw new Error("Three.js not loaded");
        }

        // --- 設定 ---
        const SCENE_CONFIG = {
            colorBg: 0x050505,
            colorGrid: 0x112233,
            colorRiver: 0x00aaff,
            colorBuilding: 0x223344,
            colorHighlight: 0x00f0ff
        };

        const LOCATIONS = [
            { id: 1, name: "JR川崎駅 & ラゾーナ", x: 0, z: 0, color: 0x00f0ff, desc: "市の中心ハブ。巨大ショッピングモールと直結する、人流と商業のエネルギーが集まる心臓部。" },
            { id: 2, name: "川崎大師 (平間寺)", x: 15, z: -5, color: 0xff0055, desc: "初詣の参拝客数は全国トップクラス。厄除けのお大師さまとして知られる、伝統と歴史の聖地。" },
            { id: 3, name: "川崎工場夜景エリア", x: 25, z: 10, color: 0xffaa00, desc: "千鳥町・浮島町エリア。配管やプラントの照明が織りなすSFのような光景は、世界中のファンを魅了する。" },
            { id: 4, name: "藤子・F・不二雄ミュージアム", x: -15, z: -15, color: 0x00ff88, desc: "多摩区にある夢の美術館。ドラえもんをはじめとする作品世界を体験できる、文化的なランドマーク。" },
            { id: 5, name: "等々力緑地", x: -5, z: -10, color: 0x55ff00, desc: "フロンターレの本拠地スタジアムやアリーナ、自然豊かな公園が融合したスポーツと憩いの拠点。" },
            { id: 6, name: "キングスカイフロント", x: 20, z: 5, color: 0xffffff, desc: "多摩川対岸の羽田空港を見据える、世界最高水準の研究開発が集まる国際戦略拠点。" }
        ];

        // --- 初期化 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(SCENE_CONFIG.colorBg);
        scene.fog = new THREE.FogExp2(SCENE_CONFIG.colorBg, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-30, 25, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // OrbitControlsの読み込み方が変わります (THREE名前空間の下に配置されます)
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- 光源 ---
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(-10, 20, -10);
        scene.add(dirLight);

        const blueLight = new THREE.PointLight(0x00f0ff, 5, 50);
        blueLight.position.set(0, 10, 0);
        scene.add(blueLight);

        // --- ワールド構築 ---

        // 1. 地面
        const gridHelper = new THREE.GridHelper(200, 100, SCENE_CONFIG.colorHighlight, SCENE_CONFIG.colorGrid);
        gridHelper.position.y = -0.1;
        scene.add(gridHelper);

        // 2. 多摩川
        const riverCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(-40, 0, -20),
            new THREE.Vector3(-10, 0, -15),
            new THREE.Vector3(10, 0, 0),
            new THREE.Vector3(30, 0, 10),
            new THREE.Vector3(50, 0, 20),
        ]);
        const riverGeo = new THREE.TubeGeometry(riverCurve, 64, 1.5, 8, false);
        const riverMat = new THREE.MeshBasicMaterial({ 
            color: SCENE_CONFIG.colorRiver, 
            transparent: true, opacity: 0.6, wireframe: true
        });
        const riverMesh = new THREE.Mesh(riverGeo, riverMat);
        scene.add(riverMesh);

        // 3. ビル群
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);
        const boxMat = new THREE.MeshPhongMaterial({ color: SCENE_CONFIG.colorBuilding, flatShading: true });
        const buildingCount = 800;
        const buildings = new THREE.InstancedMesh(boxGeo, boxMat, buildingCount);
        
        const dummy = new THREE.Object3D();
        for (let i = 0; i < buildingCount; i++) {
            let x = (Math.random() - 0.5) * 100;
            let z = (Math.random() - 0.5) * 60;
            const dist = Math.sqrt(x*x + z*z);
            const height = Math.max(0.5, Math.random() * 20 - dist * 0.5);
            
            if (height > 0.5) {
                dummy.position.set(x, height / 2, z);
                dummy.scale.set(1 + Math.random(), height, 1 + Math.random());
                dummy.updateMatrix();
                buildings.setMatrixAt(i, dummy.matrix);
            }
        }
        scene.add(buildings);

        // 4. パーティクル
        const particlesGeo = new THREE.BufferGeometry();
        const particlesCount = 1000;
        const posArray = new Float32Array(particlesCount * 3);
        for(let i=0; i<particlesCount*3; i++) {
            posArray[i] = (Math.random() - 0.5) * 150;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMat = new THREE.PointsMaterial({
            size: 0.2, color: SCENE_CONFIG.colorHighlight, transparent: true, opacity: 0.8
        });
        const particleSystem = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particleSystem);

        // 5. マーカー
        const markers = [];
        LOCATIONS.forEach(loc => {
            const geometry = new THREE.IcosahedronGeometry(1, 0);
            const material = new THREE.MeshBasicMaterial({ color: loc.color, wireframe: true });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(loc.x, 3, loc.z);
            mesh.userData = { id: loc.id, name: loc.name, desc: loc.desc };
            
            const lineGeo = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(loc.x, 0, loc.z),
                new THREE.Vector3(loc.x, 3, loc.z)
            ]);
            const lineMat = new THREE.LineBasicMaterial({ color: loc.color, transparent: true, opacity: 0.5 });
            const line = new THREE.Line(lineGeo, lineMat);

            scene.add(mesh);
            scene.add(line);
            markers.push(mesh);
        });

        // --- インタラクション ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredMarker = null;

        const infoPanel = document.getElementById('info-panel');
        const infoTitle = document.getElementById('info-title');
        const infoDesc = document.getElementById('info-desc');

        window.addEventListener('mousemove', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            controls.autoRotate = false;
        });

        // --- アニメーション ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            controls.update();
            particleSystem.rotation.y = time * 0.05;

            markers.forEach(marker => {
                marker.rotation.y += 0.02;
                marker.rotation.x += 0.01;
                marker.position.y = 3 + Math.sin(time * 2 + marker.userData.id) * 0.5;
            });

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(markers);

            if (intersects.length > 0) {
                const target = intersects[0].object;
                if (hoveredMarker !== target) {
                    hoveredMarker = target;
                    document.body.style.cursor = 'pointer';
                    target.scale.set(1.5, 1.5, 1.5);
                    infoTitle.textContent = target.userData.name;
                    infoDesc.textContent = target.userData.desc;
                    infoTitle.style.color = '#' + target.material.color.getHexString();
                    infoPanel.style.borderLeftColor = '#' + target.material.color.getHexString();
                    infoPanel.classList.add('active');
                }
            } else {
                if (hoveredMarker) {
                    hoveredMarker.scale.set(1, 1, 1);
                    hoveredMarker = null;
                    document.body.style.cursor = 'default';
                    infoPanel.classList.remove('active');
                    controls.autoRotate = true;
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 開始処理
        setTimeout(() => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').remove(), 1000);
            animate();
        }, 1000);
    </script>
</body>
</html>