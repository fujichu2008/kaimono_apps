
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no" />
<title>PromptSynth Player â€” AIä½œæ›²ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ Ã— JSONå†ç”Ÿ</title>
<style>
  :root{
    --bg:#070a12; --bg2:#0b1224;
    --card: rgba(255,255,255,.06);
    --card2: rgba(255,255,255,.08);
    --line: rgba(255,255,255,.10);
    --ink:#eaf1ff; --muted:#aab6cf;
    --pri:#6aa5ff; --pri2:#7c5cff;
    --ok:#22c55e; --warn:#fbbf24; --danger:#ff4d4f;
    --shadow: 0 18px 55px rgba(0,0,0,.55);
    --r:18px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic", "Meiryo", sans-serif;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; font-family:var(--sans); color:var(--ink); background: radial-gradient(1200px 800px at 20% 10%, rgba(106,165,255,.14), transparent 55%),
                                     radial-gradient(1200px 800px at 80% 10%, rgba(124,92,255,.14), transparent 55%),
                                     radial-gradient(1200px 900px at 50% 100%, rgba(34,197,94,.10), transparent 55%),
                                     linear-gradient(180deg, var(--bg), var(--bg2)); }
  a{ color:inherit; }
  .app{
    height:100%;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: linear-gradient(180deg, rgba(10,14,26,.90), rgba(10,14,26,.55));
    border-bottom:1px solid var(--line);
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    min-width: 240px;
  }
  .logo{
    width:36px; height:36px; border-radius:12px;
    background:
      radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.55), transparent 60%),
      radial-gradient(18px 18px at 70% 35%, rgba(255,255,255,.25), transparent 60%),
      linear-gradient(135deg, rgba(106,165,255,1), rgba(124,92,255,1));
    box-shadow: 0 14px 40px rgba(106,165,255,.18);
  }
  .brand h1{ font-size:14px; margin:0; line-height:1.1; font-weight:800; letter-spacing:.2px; }
  .brand small{ display:block; margin-top:2px; color:var(--muted); font-size:12px; font-weight:600; }
  .top-actions{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:9px 12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    border-radius:999px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    cursor:pointer; user-select:none;
    font-weight:750; font-size:12px;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16); }
  .pill:active{ transform: translateY(0px) scale(.99); }
  .pill.primary{ background: linear-gradient(135deg, rgba(106,165,255,.22), rgba(124,92,255,.22)); border-color: rgba(106,165,255,.35); }
  .pill.ok{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); }
  .pill.warn{ background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.28); }
  .pill.danger{ background: rgba(255,77,79,.12); border-color: rgba(255,77,79,.28); }

  main{
    flex:1;
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap:14px;
    padding:14px;
    overflow:hidden;
  }
  @media (max-width: 1080px){
    main{ grid-template-columns: 1fr; overflow:auto; }
  }

  .card{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
    border-radius: var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height: 0;
  }
  .card .hd{
    padding:14px 14px 10px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  }
  .card .hd h2{ margin:0; font-size:13px; letter-spacing:.2px; font-weight:850; }
  .card .hd p{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.45; font-weight:600; }
  .card .bd{
    padding:14px;
    overflow:auto;
    min-height: 0;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
  }
  .field{ grid-column: span 6; }
  .field.span12{ grid-column: 1 / -1; }
  .field.span4{ grid-column: span 4; }
  .field.span3{ grid-column: span 3; }
  .field.span8{ grid-column: span 8; }
  .label{
    font-size:12px; color:var(--muted); font-weight:800;
    margin:0 0 6px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .label .hint{ font-weight:700; font-size:11px; opacity:.9; }
  input[type="text"], input[type="number"], select, textarea{
    width:100%;
    padding:11px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.12);
    outline:none;
    background: rgba(0,0,0,.25);
    color: var(--ink);
    font-size:13px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }
  textarea{
    min-height: 140px;
    resize: vertical;
    font-family: var(--mono);
    line-height: 1.35;
  }
  .row{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .mini{
    font-size:11px; color:var(--muted); font-weight:700;
  }
  .chips{
    display:flex; flex-wrap:wrap; gap:8px;
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:9px 10px;
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    background: rgba(255,255,255,.05);
    cursor:pointer; user-select:none;
    font-size:12px; font-weight:800;
  }
  .chip input{ accent-color: var(--pri); }
  .slider{
    display:flex; gap:10px; align-items:center;
  }
  input[type="range"]{ width:100%; }
  .kbd{
    padding:2px 7px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    font-size:11px;
    font-weight:900;
    color: rgba(255,255,255,.85);
  }
  .sep{ height:1px; background: var(--line); margin:14px 0; }

  /* Player controls */
  .controls{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .transport{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    cursor:pointer; user-select:none;
    font-weight:900; font-size:12px;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
  .btn:active{ transform: translateY(0px) scale(.99); }
  .btn.primary{ background: linear-gradient(135deg, rgba(106,165,255,.25), rgba(124,92,255,.25)); border-color: rgba(106,165,255,.34); }
  .btn.ok{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); }
  .btn.warn{ background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.28); }
  .btn.danger{ background: rgba(255,77,79,.12); border-color: rgba(255,77,79,.28); }
  .btn.ghost{ background: rgba(0,0,0,.18); }
  .btn.small{ padding:8px 10px; border-radius: 12px; font-size:11px; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
  .status{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
  }
  .status .title{
    font-weight:900; font-size:12px;
  }
  .status .sub{
    color:var(--muted); font-size:11px; font-weight:750;
    margin-top:3px;
  }
  .status .right{
    text-align:right;
    min-width: 155px;
  }
  .status .time{
    font-family: var(--mono);
    font-size:12px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .status .beat{
    font-family: var(--mono);
    color:var(--muted);
    font-size:11px;
    font-weight:800;
  }
  .seek{
    display:flex; gap:10px; align-items:center;
  }
  .seek input[type="range"]{ width:100%; }
  .seek .mono{
    font-family:var(--mono); font-size:11px; color:var(--muted); font-weight:800;
    min-width: 120px; text-align:right;
  }

  .mix{
    display:flex; flex-direction:column; gap:10px;
  }
  .track{
    display:grid;
    grid-template-columns: 1.2fr .7fr .7fr auto auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
  }
  .track .name{
    font-weight:900; font-size:12px;
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  .tag{
    font-size:10px;
    font-weight:900;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.20);
    color: rgba(255,255,255,.80);
  }
  .tiny{
    font-size:10px; color:var(--muted); font-weight:800;
  }
  .track .tog{
    display:flex; gap:6px; justify-content:flex-end;
  }

  .vizWrap{
    border-top:1px solid var(--line);
    background: radial-gradient(800px 300px at 25% 25%, rgba(106,165,255,.10), transparent 55%),
                radial-gradient(700px 320px at 85% 35%, rgba(124,92,255,.10), transparent 55%),
                linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.25));
    padding:10px 12px 12px;
  }
  .vizRow{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  canvas{
    width:100%;
    height:220px;
    display:block;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    background: rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.16);
    border-radius: 999px;
    padding:10px 14px;
    color: rgba(255,255,255,.92);
    font-weight:900;
    font-size:12px;
    display:none;
    z-index:50;
    backdrop-filter: blur(10px);
    box-shadow: 0 18px 55px rgba(0,0,0,.45);
  }
  .err{
    margin-top:10px;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,77,79,.30);
    background: rgba(255,77,79,.10);
    color: rgba(255,255,255,.92);
    font-size:12px;
    font-weight:800;
    line-height:1.4;
    display:none;
  }

  dialog{
    width: min(860px, calc(100vw - 24px));
    border:none;
    border-radius: 18px;
    padding:0;
    background: rgba(10,14,26,.92);
    color: var(--ink);
    box-shadow: 0 30px 90px rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(12px);
  }
  dialog::backdrop{ background: rgba(0,0,0,.55); }
  .modalHd{
    padding:14px 14px 12px;
    border-bottom:1px solid rgba(255,255,255,.12);
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .modalHd h3{ margin:0; font-size:13px; font-weight:950; }
  .modalBd{
    padding:14px;
    max-height: min(70vh, 560px);
    overflow:auto;
  }
  .modalBd p, .modalBd li{
    margin: 0 0 10px;
    color: rgba(255,255,255,.85);
    font-size:12px;
    line-height:1.6;
    font-weight:650;
  }
  code.inline{
    font-family:var(--mono);
    font-size:11px;
    padding:2px 6px;
    border-radius:8px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
  }
  .pre{
    font-family: var(--mono);
    font-size: 11px;
    white-space: pre-wrap;
    background: rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.12);
    padding:12px;
    border-radius: 14px;
    line-height:1.35;
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>PromptSynth Player</h1>
        <small>AIä½œæ›²ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ Ã— JSONè²¼ã‚Šä»˜ã‘å†ç”Ÿï¼ˆWebAudioï¼‰</small>
      </div>
    </div>
    <div class="top-actions">
      <div class="pill primary" id="btnUnlock">ğŸ”“ éŸ³ã‚’è§£éŒ </div>
      <div class="pill" id="btnHelp">â“ ä½¿ã„æ–¹</div>
      <div class="pill" id="btnShortcuts">âŒ¨ï¸ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</div>
    </div>
  </header>

  <main>
    <!-- Prompt Builder -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>â‘  ä½œæ›²ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆJSONå½¢å¼ï¼‰ã‚’ç”Ÿæˆ</h2>
          <p>
            æ¡ä»¶ã‚’é¸æŠ + è‡ªç”±è¨˜è¿° â†’ ChatGPTã«è²¼ã‚‹ <b>ãƒªã‚¯ã‚¨ã‚¹ãƒˆJSON</b> ã‚’ä½œã‚Šã¾ã™ã€‚<br/>
            ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ã§ãã€AIã«ã¯ã€Œ<b>JSONã®ã¿ã§è¿”ã™</b>ã€ã‚ˆã†å¼·ãæŒ‡ç¤ºã—ã¾ã™ã€‚
          </p>
        </div>
        <div class="row">
          <div class="pill ok" id="btnGenPrompt">âœ¨ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</div>
          <div class="pill primary" id="btnCopyPrompt">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
        </div>
      </div>
      <div class="bd">
        <div class="grid">
          <div class="field span4">
            <div class="label">ã‚¸ãƒ£ãƒ³ãƒ«</div>
            <select id="genre">
              <option>Ambient</option>
              <option>Lo-fi</option>
              <option>Synthwave</option>
              <option>Cinematic</option>
              <option>EDM</option>
              <option>Hip-hop</option>
              <option>Jazz</option>
              <option>Chiptune</option>
              <option>Orchestral-ish</option>
              <option>Acoustic-ish</option>
            </select>
          </div>
          <div class="field span4">
            <div class="label">ãƒ ãƒ¼ãƒ‰</div>
            <select id="mood">
              <option>Dreamy</option>
              <option>Upbeat</option>
              <option>Calm</option>
              <option>Energetic</option>
              <option>Tense</option>
              <option>Heroic</option>
              <option>Sad</option>
              <option>Mysterious</option>
              <option>Playful</option>
            </select>
          </div>
          <div class="field span4">
            <div class="label">BPM <span class="hint" id="bpmLab">120</span></div>
            <div class="slider">
              <input id="bpm" type="range" min="60" max="180" value="120" />
            </div>
          </div>

          <div class="field span4">
            <div class="label">ã‚­ãƒ¼</div>
            <select id="key">
              <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option>
              <option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
            </select>
          </div>
          <div class="field span4">
            <div class="label">ã‚¹ã‚±ãƒ¼ãƒ«</div>
            <select id="scale">
              <option>major</option>
              <option>minor</option>
              <option>dorian</option>
              <option>mixolydian</option>
              <option>pentatonic</option>
              <option>harmonic_minor</option>
            </select>
          </div>
          <div class="field span4">
            <div class="label">æ‹å­</div>
            <select id="ts">
              <option>4/4</option>
              <option>3/4</option>
              <option>6/8</option>
            </select>
          </div>

          <div class="field span4">
            <div class="label">é•·ã•ï¼ˆå°ç¯€ï¼‰ <span class="hint" id="barsLab">16</span></div>
            <input id="bars" type="range" min="8" max="64" step="4" value="16" />
          </div>
          <div class="field span4">
            <div class="label">è¤‡é›‘ã•</div>
            <select id="complexity">
              <option>simple</option>
              <option selected>standard</option>
              <option>complex</option>
            </select>
          </div>
          <div class="field span4">
            <div class="label">ã‚¹ã‚¤ãƒ³ã‚°ï¼ˆ0.00-0.40ï¼‰ <span class="hint" id="swingLab">0.10</span></div>
            <input id="swing" type="range" min="0" max="0.40" step="0.01" value="0.10" />
          </div>

          <div class="field span12">
            <div class="label">ç·¨æˆï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</div>
            <div class="chips" id="instChips">
              <label class="chip"><input type="checkbox" id="iDrums" checked /> Drums</label>
              <label class="chip"><input type="checkbox" id="iBass" checked /> Bass</label>
              <label class="chip"><input type="checkbox" id="iChords" checked /> Chords/Pad</label>
              <label class="chip"><input type="checkbox" id="iLead" checked /> Lead</label>
              <label class="chip"><input type="checkbox" id="iArp" /> Arp</label>
              <label class="chip"><input type="checkbox" id="iFX" /> FX</label>
            </div>
          </div>

          <div class="field span12">
            <div class="label">è‡ªç”±è¨˜è¿°ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»å‚è€ƒãƒ»ç¦æ­¢äº‹é …ãªã©ï¼‰</div>
            <input id="free" type="text" placeholder="ä¾‹ï¼šå¤œã®é«˜é€Ÿé“è·¯ã€æ§ãˆã‚ãªã‚­ãƒƒã‚¯ã€é€æ˜æ„Ÿã®ã‚ã‚‹ãƒ‘ãƒƒãƒ‰ã€ãƒ¡ãƒ­ã¯çŸ­ãåå¾©ã€çµ‚ã‚ã‚Šã¯ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ ãªã©" />
            <div class="mini" style="margin-top:8px;">
              â€»ã“ã“ã«ã€Œå†ç”Ÿã—ã‚„ã™ã„ï¼ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã¯å¤šã™ããªã„ã€ã€ŒéŸ³ãŒå°–ã‚Šã™ããªã„ã€ç­‰ã®å¸Œæœ›ã‚‚æ›¸ãã¨å®‰å®šã—ã¾ã™ã€‚
            </div>
          </div>

          <div class="field span12">
            <div class="label">ChatGPTã¸è²¼ã‚‹ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆJSONã€ï¼ˆã“ã‚Œã‚’ã‚³ãƒ”ãƒ¼ï¼‰</div>
            <textarea id="promptOut" spellcheck="false"></textarea>
            <div class="row" style="justify-content:space-between; margin-top:10px;">
              <div class="mini">
                æ¨å¥¨ï¼šChatGPTã¸è²¼ã£ã¦ã€Œã“ã®JSONã«å¾“ã£ã¦ã€æ›²JSONã ã‘è¿”ã—ã¦ã€ã¨ä¾é ¼
              </div>
              <div class="row">
                <div class="btn small ghost" id="btnCopyPrompt2">ğŸ“‹ ã‚³ãƒ”ãƒ¼</div>
                <div class="btn small" id="btnPromptExample">ğŸ§¾ ä¾‹</div>
              </div>
            </div>
            <div class="err" id="promptErr"></div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="mini">
          ãƒã‚¤ãƒ³ãƒˆï¼šã“ã®ã‚¢ãƒ—ãƒªã¯ <b>æ›²ã®JSON</b> ã‚’å†ç”Ÿã—ã¾ã™ï¼ˆMP3ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚AIãŒè¿”ã™JSONã¯ã€å¾Œè¿°ã®ã€Œâ‘¡å†ç”Ÿã€æ¬„ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- Player -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>â‘¡ æ›²JSONã‚’è²¼ã‚Šä»˜ã‘ã¦å†ç”Ÿ</h2>
          <p>
            ChatGPTãŒç”Ÿæˆã—ãŸæ›²JSONã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ â†’ èª­ã¿è¾¼ã¿ â†’ å†ç”Ÿã€‚<br/>
            ãƒŸãƒ¥ãƒ¼ãƒˆ/ã‚½ãƒ­ã€ãƒˆãƒ©ãƒƒã‚¯éŸ³é‡/ãƒ‘ãƒ³ã€ãƒ†ãƒ³ãƒä¸Šæ›¸ãã€ãƒ«ãƒ¼ãƒ—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜ã«å¯¾å¿œã€‚
          </p>
        </div>
        <div class="row">
          <div class="pill" id="btnLoadDemo">ğŸ§ ãƒ‡ãƒ¢èª­è¾¼</div>
          <div class="pill ok" id="btnLoadJson">â¬‡ï¸ èª­ã¿è¾¼ã¿</div>
        </div>
      </div>
      <div class="bd">
        <div class="field span12">
          <div class="label">æ›²JSONè²¼ã‚Šä»˜ã‘</div>
          <textarea id="songIn" spellcheck="false" placeholder="ã“ã“ã«ChatGPTã®å‡ºåŠ›ï¼ˆæ›²JSONï¼‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
          <div class="row" style="justify-content:space-between; margin-top:10px;">
            <div class="row">
              <div class="btn small" id="btnMinify">â†˜ï¸ ãƒŸãƒ‹ãƒ•ã‚¡ã‚¤</div>
              <div class="btn small" id="btnPretty">â†—ï¸ æ•´å½¢</div>
              <div class="btn small ghost" id="btnClearSong">ğŸ§¹ ã‚¯ãƒªã‚¢</div>
            </div>
            <div class="row">
              <div class="btn small" id="btnSaveLib">ğŸ’¾ ä¿å­˜</div>
              <div class="btn small" id="btnShowLib">ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</div>
              <div class="btn small warn" id="btnDownloadJson">â¬‡ï¸ JSONä¿å­˜</div>
            </div>
          </div>
          <div class="err" id="songErr"></div>
        </div>

        <div class="sep"></div>

        <div class="controls">
          <div class="status">
            <div>
              <div class="title" id="nowTitle">æœªèª­ã¿è¾¼ã¿</div>
              <div class="sub" id="nowMeta">â€”</div>
            </div>
            <div class="right">
              <div class="time" id="nowTime">00:00 / 00:00</div>
              <div class="beat" id="nowBeat">beat 0.00</div>
            </div>
          </div>

          <div class="transport">
            <button class="btn primary" id="btnPlay">â–¶ï¸ å†ç”Ÿ</button>
            <button class="btn" id="btnPause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
            <button class="btn" id="btnStop" disabled>â¹ åœæ­¢</button>
            <button class="btn" id="btnRew" disabled>â® å…ˆé ­</button>
            <button class="btn" id="btnFwd" disabled>â­ +4æ‹</button>
            <button class="btn" id="btnLoop" disabled>ğŸ” ãƒ«ãƒ¼ãƒ—:OFF</button>
            <div class="mini" style="margin-left:auto;">
              Space:å†ç”Ÿ/åœæ­¢ã€€<span class="kbd">L</span>:ãƒ«ãƒ¼ãƒ—ã€€<span class="kbd">S</span>:åœæ­¢
            </div>
          </div>

          <div class="seek">
            <input id="seek" type="range" min="0" max="1" step="0.0005" value="0" disabled />
            <div class="mono" id="seekLab">â€”</div>
          </div>

          <div class="grid">
            <div class="field span6">
              <div class="label">ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡ <span class="hint" id="volLab">0.90</span></div>
              <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.90" disabled />
            </div>
            <div class="field span6">
              <div class="label">ãƒ†ãƒ³ãƒï¼ˆä¸Šæ›¸ãï¼‰ <span class="hint" id="tempoLab">Follow</span></div>
              <div class="row">
                <label class="chip" style="margin:0;">
                  <input type="checkbox" id="tempoOverride" />
                  ä¸Šæ›¸ãON
                </label>
                <input id="tempo" type="range" min="60" max="180" step="1" value="120" disabled />
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="mix">
            <div class="label">ãƒŸã‚­ã‚µãƒ¼ï¼ˆãƒˆãƒ©ãƒƒã‚¯ï¼‰ <span class="hint tiny">Mute/Soloãƒ»éŸ³é‡ãƒ»ãƒ‘ãƒ³</span></div>
            <div id="tracks"></div>
          </div>
        </div>
      </div>

      <div class="vizWrap">
        <div class="vizRow" style="justify-content:space-between;">
          <div class="mini">ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ï¼ˆã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ  + æ³¢å½¢ + ãƒ“ãƒ¼ãƒˆåå¿œï¼‰</div>
          <div class="row">
            <button class="btn small" id="btnVizMode">âœ¨ ãƒ¢ãƒ¼ãƒ‰: Glow</button>
            <button class="btn small ghost" id="btnReduceMotion">ğŸ«¥ è»½é‡:OFF</button>
          </div>
        </div>
        <div style="margin-top:10px;">
          <canvas id="viz" width="1200" height="440"></canvas>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Help Modal -->
  <dialog id="dlgHelp">
    <div class="modalHd">
      <div>
        <h3>ä½¿ã„æ–¹</h3>
        <div class="mini">AIä½œæ›²ï¼ˆJSONç”Ÿæˆï¼‰â†’ è²¼ã‚Šä»˜ã‘å†ç”Ÿã¾ã§ã‚’ä¸€æ°—é€šè²«ã§ã€‚</div>
      </div>
      <button class="btn small ghost" id="btnCloseHelp">é–‰ã˜ã‚‹</button>
    </div>
    <div class="modalBd">
      <p><b>STEP 1.</b> å·¦å´ã€Œâ‘ ã€ã§æ¡ä»¶ã‚’é¸ã‚“ã§ <code class="inline">âœ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</code> â†’ <code class="inline">ğŸ“‹ã‚³ãƒ”ãƒ¼</code></p>
      <p><b>STEP 2.</b> ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ã€Œã“ã®JSONã«å¾“ã£ã¦ã€æ›²JSONã ã‘è¿”ã—ã¦ã€ã¨ä¾é ¼ï¼ˆâ€»AIã®è¿”ç­”ã¯<b>JSONã®ã¿</b>ãŒç†æƒ³ï¼‰</p>
      <p><b>STEP 3.</b> å³å´ã€Œâ‘¡ã€ã«AIã®å‡ºåŠ›ã‚’è²¼ã‚Šä»˜ã‘ã¦ <code class="inline">â¬‡ï¸èª­ã¿è¾¼ã¿</code> â†’ å†ç”Ÿ</p>
      <p><b>ã‚³ãƒ„ï¼š</b> AIãŒèª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹ï¼ˆ```ï¼‰ã‚’æ··ãœã¦ã‚‚ã€èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§JSONéƒ¨åˆ†ã®æŠ½å‡ºã‚’è©¦ã¿ã¾ã™ã€‚ãŸã ã—æœ€ã‚‚å®‰å®šã™ã‚‹ã®ã¯ã€Œ<b>JSONã®ã¿</b>ã€ã§ã™ã€‚</p>
      <div class="sep"></div>
      <p><b>ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒèª­ã‚ã‚‹æ›²JSONã®ç‰¹å¾´</b></p>
      <ul>
        <li><code class="inline">schema_version</code> ãŒ <code class="inline">1.0</code></li>
        <li><code class="inline">tempo_bpm</code>ï¼ˆ60-180ï¼‰ã¨ <code class="inline">time_signature</code></li>
        <li><code class="inline">tracks[]</code> ã«ã‚¤ãƒ™ãƒ³ãƒˆé…åˆ—ï¼ˆ<code class="inline">t</code>=æ‹ã€<code class="inline">d</code>=æ‹ã€<code class="inline">n</code>=éŸ³å or MIDIã€<code class="inline">hit</code>=ãƒ‰ãƒ©ãƒ ç¨®åˆ¥ï¼‰</li>
      </ul>
      <p>ãƒ‰ãƒ©ãƒ ã® <code class="inline">hit</code> ã¯ <code class="inline">kick</code>, <code class="inline">snare</code>, <code class="inline">hat</code>, <code class="inline">clap</code>, <code class="inline">tom</code> ã‚’æ¨å¥¨ã€‚</p>
      <div class="sep"></div>
      <p><b>ã‚¹ãƒãƒ›ã§éŸ³ãŒå‡ºãªã„æ™‚</b>ï¼šä¸Šéƒ¨ã® <code class="inline">ğŸ”“éŸ³ã‚’è§£éŒ </code> ã‚’ã‚¿ãƒƒãƒ—ï¼ˆiOSå¯¾ç­–ï¼‰ã€‚</p>
    </div>
  </dialog>

  <!-- Shortcuts Modal -->
  <dialog id="dlgKeys">
    <div class="modalHd">
      <div>
        <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
        <div class="mini">æ“ä½œã‚’ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ã«</div>
      </div>
      <button class="btn small ghost" id="btnCloseKeys">é–‰ã˜ã‚‹</button>
    </div>
    <div class="modalBd">
      <ul>
        <li><span class="kbd">Space</span> å†ç”Ÿ / åœæ­¢</li>
        <li><span class="kbd">S</span> åœæ­¢</li>
        <li><span class="kbd">L</span> ãƒ«ãƒ¼ãƒ— ON/OFF</li>
        <li><span class="kbd">â†</span> å…ˆé ­ã¸ï¼ˆåœæ­¢æ™‚ï¼‰</li>
        <li><span class="kbd">â†’</span> +4æ‹ï¼ˆå†ç”Ÿä¸­ï¼‰</li>
      </ul>
    </div>
  </dialog>

  <!-- Library Modal -->
  <dialog id="dlgLib">
    <div class="modalHd">
      <div>
        <h3>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
        <div class="mini">ä¿å­˜ã—ãŸæ›²JSONã‚’å‘¼ã³å‡ºã—</div>
      </div>
      <div class="row">
        <button class="btn small warn" id="btnExportLib">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn small" id="btnImportLib">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn small ghost" id="btnCloseLib">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div class="mini">ã‚¯ãƒªãƒƒã‚¯ã§èª­ã¿è¾¼ã¿ã€‚å‰Šé™¤ã¯å³ç«¯ã€‚</div>
        <div class="mini">ä¿å­˜ã¯å³å´ã® <code class="inline">ğŸ’¾ä¿å­˜</code></div>
      </div>
      <div id="libList"></div>
      <div class="sep"></div>
      <div class="label">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªJSONï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ï¼‰</div>
      <textarea id="libArea" spellcheck="false" style="min-height:120px;"></textarea>
      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn small" id="btnCopyLib">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const nowISO = () => new Date().toISOString();
  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tid);
    toast._tid = setTimeout(() => (t.style.display="none"), 1600);
  };

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        document.body.removeChild(ta);
        return true;
      }catch(err){
        document.body.removeChild(ta);
        toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªï¼‰");
        return false;
      }
    }
  }

  function safeJsonStringify(obj){
    return JSON.stringify(obj, null, 2);
  }

  function stripFences(s){
    // remove triple backticks blocks
    return s.replace(/```[\s\S]*?```/g, (m) => {
      // try to keep inside if it's pure JSON-like: strip only backticks lines
      return m.replace(/^```.*\n?/g, "").replace(/```$/g, "");
    });
  }

  function extractJson(text){
    if(!text) return { ok:false, err:"ç©ºã§ã™" };
    let s = text.trim();
    s = stripFences(s).trim();
    // If there's leading/trailing commentary, take the largest {...} block.
    const first = s.indexOf("{");
    const last = s.lastIndexOf("}");
    if(first === -1 || last === -1 || last <= first){
      return { ok:false, err:"{...} å½¢å¼ã®JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };
    }
    const candidate = s.slice(first, last+1);
    try{
      const obj = JSON.parse(candidate);
      return { ok:true, obj, raw:candidate };
    }catch(e){
      return { ok:false, err:"JSONè§£æã«å¤±æ•—: " + e.message, raw:candidate };
    }
  }

  function fmtTime(sec){
    sec = Math.max(0, sec);
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function parseTimeSig(ts){
    const m = String(ts||"4/4").match(/^(\d+)\s*\/\s*(\d+)$/);
    if(!m) return { beatsPerBar:4, unit:4 };
    const num = clamp(parseInt(m[1],10)||4, 1, 12);
    const den = clamp(parseInt(m[2],10)||4, 1, 16);
    // For our beat grid we treat "beat" as a quarter note.
    // 6/8 => beatsPerBar=6*(8/4)=12 quarter-beat units? Thatâ€™s confusing.
    // To keep it stable, we map "beat" = quarter note; thus beatsPerBar = num * (4/den)
    const beatsPerBar = num * (4/den);
    return { beatsPerBar, unit:den, num };
  }

  // ---------- Prompt Builder ----------
  const schemaSpec = {
    schema_version: "1.0",
    title: "string",
    meta: {
      author: "string (optional)",
      created_utc: "ISO8601 string (optional)",
      description: "string (optional)",
      tags: ["string"]
    },
    tempo_bpm: "number 60-180",
    time_signature: "string e.g. 4/4",
    swing: "number 0.0-0.4 (optional)",
    master: {
      volume: "number 0-1",
      limiter: "boolean (optional)",
      reverb: { enabled:"boolean", mix:"0-0.5", decay_sec:"0.5-6.0" },
      delay: { enabled:"boolean", mix:"0-0.5", time_beats:"0.25/0.5/1.0/2.0", feedback:"0-0.7" }
    },
    arrangement: {
      length_beats: "number",
      loop_start_beats: "number",
      loop_end_beats: "number"
    },
    tracks: [
      {
        id: "string",
        name: "string",
        volume: "0-1",
        pan: "-1..1",
        instrument: {
          type: "synth | drums",
          wave: "sine|triangle|sawtooth|square (synth)",
          polyphony: "1-8 (synth)",
          attack: "sec",
          decay: "sec",
          sustain: "0-1",
          release: "sec",
          cutoff_hz: "200-6000 (optional)",
          resonance: "0.1-12 (optional)"
        },
        events: [
          { t:"beat", d:"beats", n:"note string like C4 or C#4 OR MIDI int 0-127 OR array of notes", v:"0-1" },
          { t:"beat", d:"beats", hit:"kick|snare|hat|clap|tom", v:"0-1" }
        ]
      }
    ]
  };

  function buildRequestJson(){
    const bpm = +$("#bpm").value;
    const bars = +$("#bars").value;
    const ts = $("#ts").value;
    const { beatsPerBar } = parseTimeSig(ts);
    const lengthBeats = Math.round(bars * beatsPerBar * 1000)/1000;

    const inst = [];
    if($("#iDrums").checked) inst.push("drums");
    if($("#iBass").checked) inst.push("bass");
    if($("#iChords").checked) inst.push("chords_or_pad");
    if($("#iLead").checked) inst.push("lead");
    if($("#iArp").checked) inst.push("arp");
    if($("#iFX").checked) inst.push("fx");

    const req = {
      request_type: "PromptSynthPlayer_CompositionRequest",
      request_version: "1.0",
      instruction: [
        "You are a music-JSON generator for a WebAudio player.",
        "Return ONLY a single JSON object (no markdown, no code fences, no explanations).",
        "The JSON must strictly follow the output_schema in this request.",
        "Use double quotes for all JSON keys and strings. No comments. No trailing commas.",
        "Keep event count reasonable (target <= 450 events total) so the browser can play smoothly.",
        "Use beats as time unit: t=beat position (0..length_beats), d=duration in beats.",
        "For note, use either MIDI int or note name like C4, D#3, or an array for chords.",
        "For drums, use hit: kick|snare|hat|clap|tom.",
        "Ensure arrangement.loop_end_beats == arrangement.length_beats unless a shorter loop is intended."
      ].join(" "),
      constraints: {
        genre: $("#genre").value,
        mood: $("#mood").value,
        tempo_bpm: bpm,
        time_signature: ts,
        key: $("#key").value,
        scale: $("#scale").value,
        bars,
        length_beats: lengthBeats,
        swing: +$("#swing").value,
        complexity: $("#complexity").value,
        instrumentation: inst,
        free_notes: $("#free").value || ""
      },
      output_schema: schemaSpec,
      output_example_minimal: {
        schema_version: "1.0",
        title: "Example Title",
        meta: { created_utc: nowISO(), tags: ["example"] },
        tempo_bpm: bpm,
        time_signature: ts,
        swing: +$("#swing").value,
        master: {
          volume: 0.9,
          limiter: true,
          reverb: { enabled:true, mix:0.16, decay_sec:2.2 },
          delay: { enabled:false, mix:0.12, time_beats:0.5, feedback:0.25 }
        },
        arrangement: { length_beats: lengthBeats, loop_start_beats: 0, loop_end_beats: lengthBeats },
        tracks: [
          {
            id: "lead",
            name: "Lead",
            volume: 0.8,
            pan: 0.1,
            instrument: { type:"synth", wave:"sawtooth", polyphony: 6, attack:0.01, decay:0.10, sustain:0.55, release:0.18, cutoff_hz:1800, resonance:1.2 },
            events: [{ t:0, d:1, n:"C4", v:0.9 }]
          }
        ]
      }
    };
    return req;
  }

  function generatePrompt(){
    $("#promptErr").style.display = "none";
    try{
      const req = buildRequestJson();
      $("#promptOut").value = safeJsonStringify(req);
      toast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”ŸæˆOK");
    }catch(e){
      $("#promptErr").textContent = "ç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.message;
      $("#promptErr").style.display = "block";
    }
  }

  // ---------- Audio Engine ----------
  class PromptSynthEngine{
    constructor(){
      this.ctx = null;
      this.masterIn = null;
      this.masterGain = null;
      this.masterComp = null;
      this.analyser = null;
      this.convolver = null;
      this.revGain = null;
      this.delay = null;
      this.delayGain = null;
      this.delayFb = null;
      this.delayFbGain = null;

      this.song = null;
      this.tracks = [];
      this.playing = false;

      this.bpm = 120;
      this.ts = "4/4";
      this.swing = 0.0;
      this.lengthBeats = 64;
      this.loop = false;
      this.loopStart = 0;
      this.loopEnd = 64;

      this.startTime = 0;
      this.offsetBeat = 0;
      this.lastSchedTime = 0;
      this._timer = null;

      this.lookahead = 0.06;
      this.scheduleAhead = 0.35;
      this._nextBeatPulse = -1;

      this.activeNodes = new Set();
      this.onBeatPulse = null;
    }

    ensureCtx(){
      if(this.ctx) return this.ctx;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) throw new Error("WebAudioãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
      this.ctx = new Ctx({ latencyHint:"interactive" });
      this._buildMaster();
      return this.ctx;
    }

    async unlock(){
      const ctx = this.ensureCtx();
      if(ctx.state !== "running"){
        await ctx.resume();
      }
      // iOS: create a tiny silent sound to ensure output path
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = 0.00001;
      o.frequency.value = 220;
      o.connect(g).connect(this.masterIn);
      o.start();
      o.stop(ctx.currentTime + 0.03);
      toast("éŸ³ã‚’è§£éŒ ã—ã¾ã—ãŸ");
    }

    _buildMaster(){
      const ctx = this.ctx;
      this.masterIn = ctx.createGain();
      this.masterGain = ctx.createGain();
      this.masterComp = ctx.createDynamicsCompressor();
      this.masterComp.threshold.value = -10;
      this.masterComp.knee.value = 24;
      this.masterComp.ratio.value = 8;
      this.masterComp.attack.value = 0.003;
      this.masterComp.release.value = 0.12;

      this.analyser = ctx.createAnalyser();
      this.analyser.fftSize = 2048;
      this.analyser.smoothingTimeConstant = 0.85;

      // Reverb (parallel)
      this.convolver = ctx.createConvolver();
      this.revGain = ctx.createGain();
      this.revGain.gain.value = 0.0;

      // Delay (parallel with feedback)
      this.delay = ctx.createDelay(2.0);
      this.delayGain = ctx.createGain();
      this.delayGain.gain.value = 0.0;
      this.delayFb = ctx.createGain();
      this.delayFbGain = ctx.createGain();
      this.delayFbGain.gain.value = 0.0;

      // routing:
      // masterIn -> comp -> masterGain -> analyser -> destination
      // reverb: masterIn -> convolver -> revGain -> masterGain
      // delay: masterIn -> delay -> delayGain -> masterGain
      // feedback: delay -> fbGain -> delay
      this.masterIn.connect(this.masterComp);
      this.masterComp.connect(this.masterGain);
      this.masterGain.connect(this.analyser);
      this.analyser.connect(ctx.destination);

      this.masterIn.connect(this.convolver);
      this.convolver.connect(this.revGain);
      this.revGain.connect(this.masterGain);

      this.masterIn.connect(this.delay);
      this.delay.connect(this.delayGain);
      this.delayGain.connect(this.masterGain);

      this.delay.connect(this.delayFbGain);
      this.delayFbGain.connect(this.delay);

      // default reverb impulse
      this._setReverbImpulse(2.2);
      // default
      this.setMasterVolume(0.9);
      this.setDelay(false, 0.12, 0.5, 0.25);
    }

    _setReverbImpulse(decaySec){
      const ctx = this.ctx;
      const rate = ctx.sampleRate;
      const length = Math.max(1, Math.floor(rate * clamp(decaySec, 0.5, 6.0)));
      const ir = ctx.createBuffer(2, length, rate);
      for(let ch=0; ch<2; ch++){
        const data = ir.getChannelData(ch);
        for(let i=0; i<length; i++){
          const t = i/length;
          const amp = Math.pow(1 - t, 3.2);
          data[i] = (Math.random()*2-1) * amp;
        }
      }
      this.convolver.buffer = ir;
    }

    setMasterVolume(v){
      this.ensureCtx();
      this.masterGain.gain.value = clamp(v, 0, 1.2);
    }

    setReverb(enabled, mix, decaySec){
      this.ensureCtx();
      this.revGain.gain.value = enabled ? clamp(mix, 0, 0.6) : 0.0;
      if(enabled) this._setReverbImpulse(decaySec ?? 2.2);
    }

    setDelay(enabled, mix, timeBeats, feedback){
      this.ensureCtx();
      this.delayGain.gain.value = enabled ? clamp(mix, 0, 0.7) : 0.0;
      this.delayFbGain.gain.value = enabled ? clamp(feedback, 0, 0.8) : 0.0;
      const spb = 60/this.bpm;
      const dt = clamp((timeBeats||0.5) * spb, 0.02, 1.8);
      this.delay.delayTime.value = dt;
    }

    setTempo(bpm){
      bpm = clamp(+bpm || 120, 40, 240);
      const was = this.bpm;
      if(this.playing && was !== bpm){
        const curBeat = this.getCurrentBeat();
        this.bpm = bpm;
        const spb = 60/this.bpm;
        this.startTime = this.ctx.currentTime - (curBeat - this.offsetBeat) * spb;
        // clear and reschedule indices
        this._resetScheduling(curBeat);
        // update delay time
        if(this.song?.master?.delay?.enabled){
          this.setDelay(true, this.song.master.delay.mix, this.song.master.delay.time_beats, this.song.master.delay.feedback);
        }
      }else{
        this.bpm = bpm;
      }
    }

    setLoop(on){
      this.loop = !!on;
    }

    _resetScheduling(fromBeat){
      for(const tr of this.tracks){
        tr.nextIndex = 0;
        const ev = tr.events;
        while(tr.nextIndex < ev.length && (ev[tr.nextIndex].t ?? 0) < fromBeat - 0.00001){
          tr.nextIndex++;
        }
      }
      this.lastSchedTime = this.ctx.currentTime;
      this._nextBeatPulse = Math.floor(fromBeat);
    }

    stopAllActive(fast=true){
      const ctx = this.ctx;
      const t0 = ctx?.currentTime || 0;
      for(const n of Array.from(this.activeNodes)){
        try{
          if(n._gain && n._gain.gain){
            const g = n._gain.gain;
            g.cancelScheduledValues(t0);
            g.setValueAtTime(g.value, t0);
            g.linearRampToValueAtTime(0.00001, t0 + (fast?0.03:0.12));
          }
          if(n.stop){
            n.stop(t0 + (fast?0.04:0.14));
          }
        }catch(e){}
        this.activeNodes.delete(n);
      }
    }

    loadSong(song){
      this.ensureCtx();
      this.stop();

      const issues = validateSong(song);
      if(!issues.ok){
        // Allow loading even with warnings if critical fields exist
        if(issues.fatal){
          throw new Error(issues.msg);
        }
      }

      this.song = song;
      this.bpm = clamp(+song.tempo_bpm || 120, 60, 180);
      this.ts = String(song.time_signature || "4/4");
      this.swing = clamp(+song.swing || 0, 0, 0.4);

      // arrangement
      const arr = song.arrangement || {};
      this.lengthBeats = +arr.length_beats || computeLengthBeats(song) || 64;
      this.loopStart = +arr.loop_start_beats || 0;
      this.loopEnd = +arr.loop_end_beats || this.lengthBeats;
      this.loopStart = clamp(this.loopStart, 0, this.lengthBeats);
      this.loopEnd = clamp(this.loopEnd, this.loopStart + 1e-6, this.lengthBeats);

      // master fx
      const m = song.master || {};
      this.setMasterVolume(m.volume ?? 0.9);
      const rev = m.reverb || {};
      this.setReverb(!!rev.enabled, rev.mix ?? 0.16, rev.decay_sec ?? 2.2);
      const del = m.delay || {};
      this.setDelay(!!del.enabled, del.mix ?? 0.12, del.time_beats ?? 0.5, del.feedback ?? 0.25);

      // build tracks
      this.tracks = (song.tracks || []).map((t, idx) => {
        const tg = this.ctx.createGain();
        const tp = this.ctx.createStereoPanner ? this.ctx.createStereoPanner() : null;
        tg.gain.value = clamp(+t.volume ?? 0.8, 0, 1.2);
        if(tp) tp.pan.value = clamp(+t.pan ?? 0, -1, 1);

        const nodeIn = tp ? tp : tg;
        tg.connect(nodeIn);
        nodeIn.connect(this.masterIn);

        const events = normalizeEvents(t.events || t.notes || []);
        events.sort((a,b) => (a.t||0) - (b.t||0));

        return {
          id: String(t.id || ("tr"+idx)),
          name: String(t.name || ("Track "+(idx+1))),
          kind: String(t.instrument?.type || "synth"),
          instrument: t.instrument || { type:"synth", wave:"sine", polyphony:6, attack:.01, decay:.1, sustain:.5, release:.18 },
          gain: tg,
          pan: tp,
          events,
          nextIndex: 0,
          muted: false,
          solo: false,
          uiVol: clamp(+t.volume ?? 0.8, 0, 1.2),
          uiPan: clamp(+t.pan ?? 0, -1, 1),
        };
      });

      // after new song
      this.offsetBeat = 0;
      this.startTime = 0;
      this.playing = false;
      this._resetScheduling(0);

      return issues; // includes warnings
    }

    play(){
      this.ensureCtx();
      if(!this.song) throw new Error("æ›²ãŒæœªèª­ã¿è¾¼ã¿ã§ã™");
      if(this.playing) return;

      this.ctx.resume?.();
      const spb = 60/this.bpm;
      this.startTime = this.ctx.currentTime;
      this.lastSchedTime = this.ctx.currentTime;
      this.playing = true;

      // Make sure indices align to offsetBeat
      this._resetScheduling(this.offsetBeat);

      this._timer = setInterval(() => this._schedulerTick(), Math.floor(this.lookahead*1000));
    }

    pause(){
      if(!this.playing) return;
      this.offsetBeat = this.getCurrentBeat();
      this.playing = false;
      clearInterval(this._timer);
      this._timer = null;
      this.stopAllActive(true);
    }

    stop(){
      this.playing = false;
      clearInterval(this._timer);
      this._timer = null;
      this.offsetBeat = 0;
      this._resetScheduling(0);
      this.stopAllActive(true);
    }

    seekToBeat(b){
      if(!this.song) return;
      b = clamp(+b || 0, 0, this.lengthBeats);
      this.offsetBeat = b;
      if(this.playing){
        const spb = 60/this.bpm;
        this.startTime = this.ctx.currentTime;
        this._resetScheduling(b);
        this.stopAllActive(true);
      }else{
        this._resetScheduling(b);
      }
    }

    getCurrentBeat(){
      if(!this.ctx) return 0;
      if(!this.playing) return clamp(this.offsetBeat, 0, this.lengthBeats);
      const spb = 60/this.bpm;
      const beat = (this.ctx.currentTime - this.startTime) / spb + this.offsetBeat;
      return beat;
    }

    _schedulerTick(){
      if(!this.playing || !this.song) return;
      const ctx = this.ctx;
      const spb = 60/this.bpm;

      const curBeat = this.getCurrentBeat();
      if(this.loop && curBeat >= this.loopEnd - 1e-6){
        this.seekToBeat(this.loopStart);
        return;
      }
      if(curBeat >= this.lengthBeats - 1e-6){
        // end
        this.pause();
        this.seekToBeat(0);
        return;
      }

      const curTime = ctx.currentTime;
      const aheadTime = curTime + this.scheduleAhead;
      const aheadBeat = (aheadTime - this.startTime) / spb + this.offsetBeat;

      // beat pulse callback
      const pulseBeat = Math.floor(curBeat);
      if(pulseBeat > this._nextBeatPulse){
        this._nextBeatPulse = pulseBeat;
        if(this.onBeatPulse) this.onBeatPulse(pulseBeat, curBeat);
      }

      // Determine solo/mute
      const anySolo = this.tracks.some(t => t.solo);
      for(const tr of this.tracks){
        const audible = anySolo ? tr.solo : !tr.muted;
        tr.gain.gain.value = audible ? tr.uiVol : 0.00001;
        if(tr.pan) tr.pan.pan.value = tr.uiPan;
      }

      // Schedule events
      for(const tr of this.tracks){
        const ev = tr.events;
        while(tr.nextIndex < ev.length){
          const e = ev[tr.nextIndex];
          const tBeat = +e.t || 0;
          if(tBeat > aheadBeat + 1e-6) break;

          // schedule if not behind too far
          if(tBeat >= curBeat - 0.25){
            const tSec = this.startTime + (tBeat - this.offsetBeat) * spb;
            const dBeats = Math.max(0.02, +e.d || 0.25);
            const dSec = dBeats * spb;

            // apply swing for 8th/16th offbeats (simple)
            const swing = this.swing || 0;
            if(swing > 0){
              const frac = tBeat % 1;
              // delay offbeats roughly
              if(Math.abs(frac - 0.5) < 1e-6){
                // 8th offbeat
                // add up to 0.2 beat
                const shift = swing * 0.25 * spb;
                // don't shift beyond bar boundary
                this._scheduleEvent(tr, e, tSec + shift, dSec);
              }else{
                this._scheduleEvent(tr, e, tSec, dSec);
              }
            }else{
              this._scheduleEvent(tr, e, tSec, dSec);
            }
          }
          tr.nextIndex++;
        }
      }
    }

    _scheduleEvent(tr, e, tSec, dSec){
      const inst = tr.instrument || {};
      const type = String(inst.type || tr.kind || "synth");
      if(type === "drums" || e.hit){
        this._scheduleDrum(tr, e, tSec, dSec);
      }else{
        this._scheduleSynth(tr, e, tSec, dSec);
      }
    }

    _scheduleSynth(tr, e, tSec, dSec){
      const ctx = this.ctx;
      const inst = tr.instrument || {};

      let notes = e.n;
      if(notes == null) return;
      if(Array.isArray(notes)) notes = notes;
      else notes = [notes];

      const wave = String(inst.wave || "sine");
      const A = clamp(+inst.attack ?? 0.01, 0.001, 2.0);
      const D = clamp(+inst.decay ?? 0.10, 0.001, 3.0);
      const S = clamp(+inst.sustain ?? 0.55, 0, 1);
      const R = clamp(+inst.release ?? 0.18, 0.01, 5.0);
      const vel = clamp(+e.v ?? 0.9, 0, 1);

      const cutoff = inst.cutoff_hz != null ? clamp(+inst.cutoff_hz, 120, 8000) : null;
      const Q = inst.resonance != null ? clamp(+inst.resonance, 0.1, 18) : 0.9;

      for(const n of notes){
        const freq = noteToFreq(n);
        if(!isFinite(freq) || freq <= 0) continue;

        const osc = ctx.createOscillator();
        osc.type = ["sine","triangle","sawtooth","square"].includes(wave) ? wave : "sine";
        osc.frequency.setValueAtTime(freq, tSec);

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.00001, tSec);

        let out = g;

        let filt = null;
        if(cutoff){
          filt = ctx.createBiquadFilter();
          filt.type = "lowpass";
          filt.frequency.setValueAtTime(cutoff, tSec);
          filt.Q.setValueAtTime(Q, tSec);
          osc.connect(filt);
          filt.connect(g);
        }else{
          osc.connect(g);
        }

        // envelope
        const peak = Math.max(0.00001, vel);
        const sustain = peak * S;
        g.gain.linearRampToValueAtTime(peak, tSec + A);
        g.gain.linearRampToValueAtTime(sustain, tSec + A + D);
        // release: at note end
        const endT = tSec + Math.max(0.03, dSec);
        g.gain.setValueAtTime(sustain, endT);
        g.gain.linearRampToValueAtTime(0.00001, endT + R);

        out.connect(tr.gain);

        osc._gain = g;
        this.activeNodes.add(osc);
        osc.onended = () => this.activeNodes.delete(osc);

        osc.start(tSec);
        osc.stop(endT + R + 0.02);
      }
    }

    _scheduleDrum(tr, e, tSec, dSec){
      const hit = String(e.hit || "hat");
      const v = clamp(+e.v ?? 1.0, 0, 1.2);
      switch(hit){
        case "kick": return this._kick(tr, tSec, v);
        case "snare": return this._snare(tr, tSec, v);
        case "clap": return this._clap(tr, tSec, v);
        case "tom": return this._tom(tr, tSec, v);
        case "hat":
        default: return this._hat(tr, tSec, v);
      }
    }

    _noiseBuffer(){
      const ctx = this.ctx;
      const len = Math.floor(ctx.sampleRate * 0.25);
      const b = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = b.getChannelData(0);
      for(let i=0;i<len;i++) d[i] = Math.random()*2-1;
      return b;
    }

    _kick(tr, t, v){
      const ctx = this.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(120, t);
      o.frequency.exponentialRampToValueAtTime(45, t + 0.11);
      g.gain.setValueAtTime(0.00001, t);
      g.gain.linearRampToValueAtTime(0.9*v, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.00001, t + 0.20);
      o.connect(g).connect(tr.gain);
      o._gain = g;
      this.activeNodes.add(o);
      o.onended = () => this.activeNodes.delete(o);
      o.start(t);
      o.stop(t + 0.22);
    }

    _snare(tr, t, v){
      const ctx = this.ctx;
      const src = ctx.createBufferSource();
      src.buffer = this._noiseBuffer();
      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(1800, t);
      bp.Q.setValueAtTime(0.9, t);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.00001, t);
      g.gain.linearRampToValueAtTime(0.7*v, t + 0.004);
      g.gain.exponentialRampToValueAtTime(0.00001, t + 0.16);
      src.connect(bp).connect(g).connect(tr.gain);
      src._gain = g;
      this.activeNodes.add(src);
      src.onended = () => this.activeNodes.delete(src);
      src.start(t);
      src.stop(t + 0.17);
    }

    _hat(tr, t, v){
      const ctx = this.ctx;
      const src = ctx.createBufferSource();
      src.buffer = this._noiseBuffer();
      const hp = ctx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.setValueAtTime(6000, t);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.00001, t);
      g.gain.linearRampToValueAtTime(0.35*v, t + 0.002);
      g.gain.exponentialRampToValueAtTime(0.00001, t + 0.06);
      src.connect(hp).connect(g).connect(tr.gain);
      src._gain = g;
      this.activeNodes.add(src);
      src.onended = () => this.activeNodes.delete(src);
      src.start(t);
      src.stop(t + 0.07);
    }

    _clap(tr, t, v){
      const ctx = this.ctx;
      const src = ctx.createBufferSource();
      src.buffer = this._noiseBuffer();
      const hp = ctx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.setValueAtTime(1200, t);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.00001, t);
      // multi-tap envelope
      const taps = [0.000, 0.012, 0.024, 0.038];
      for(const dt of taps){
        g.gain.setValueAtTime(0.00001, t + dt);
        g.gain.linearRampToValueAtTime(0.65*v, t + dt + 0.003);
        g.gain.exponentialRampToValueAtTime(0.00001, t + dt + 0.055);
      }
      src.connect(hp).connect(g).connect(tr.gain);
      src._gain = g;
      this.activeNodes.add(src);
      src.onended = () => this.activeNodes.delete(src);
      src.start(t);
      src.stop(t + 0.16);
    }

    _tom(tr, t, v){
      const ctx = this.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(220, t);
      o.frequency.exponentialRampToValueAtTime(120, t + 0.12);
      g.gain.setValueAtTime(0.00001, t);
      g.gain.linearRampToValueAtTime(0.55*v, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.00001, t + 0.22);
      o.connect(g).connect(tr.gain);
      o._gain = g;
      this.activeNodes.add(o);
      o.onended = () => this.activeNodes.delete(o);
      o.start(t);
      o.stop(t + 0.24);
    }
  }

  // ---------- Music parsing helpers ----------
  const NOTE_BASE = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 };
  function noteToFreq(n){
    if(typeof n === "number"){
      const midi = clamp(n, 0, 127);
      return 440 * Math.pow(2, (midi - 69)/12);
    }
    if(typeof n !== "string") return NaN;
    const s = n.trim();
    // Allow "C#4" "Db3"
    const m = s.match(/^([A-Ga-g])([#b]?)(-?\d+)$/);
    if(!m) return NaN;
    const letter = m[1].toUpperCase();
    const accidental = m[2];
    const oct = parseInt(m[3], 10);
    let sem = NOTE_BASE[letter] ?? 0;
    if(accidental === "#") sem += 1;
    if(accidental === "b") sem -= 1;
    const midi = (oct + 1) * 12 + sem;
    return 440 * Math.pow(2, (midi - 69)/12);
  }

  function normalizeEvents(events){
    // accept either {t,d,n} or legacy {t,d,hit} etc
    if(!Array.isArray(events)) return [];
    return events.map(e => ({
      t: +e.t || 0,
      d: e.d == null ? 0.25 : +e.d,
      n: e.n ?? e.note ?? e.notes,
      hit: e.hit ?? e.drum,
      v: e.v == null ? 1 : +e.v
    })).filter(e => isFinite(e.t) && isFinite(e.d));
  }

  function computeLengthBeats(song){
    let maxB = 0;
    for(const t of (song.tracks||[])){
      const ev = normalizeEvents(t.events || t.notes || []);
      for(const e of ev){
        const end = (+e.t||0) + Math.max(0, +e.d||0);
        if(end > maxB) maxB = end;
      }
    }
    return Math.ceil(maxB);
  }

  function validateSong(song){
    const fatal = (msg) => ({ ok:false, fatal:true, msg });
    const warn = (msg) => ({ ok:false, fatal:false, msg });

    if(!song || typeof song !== "object") return fatal("æ›²JSONãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    if(String(song.schema_version||"") !== "1.0") return warn("schema_version ãŒ 1.0 ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆèª­ã¿è¾¼ã¿ã¯è©¦è¡Œã—ã¾ã™ï¼‰");
    if(!Array.isArray(song.tracks) || song.tracks.length === 0) return fatal("tracks ãŒç©ºã§ã™");
    if(!(song.tempo_bpm >= 40 && song.tempo_bpm <= 240)) return warn("tempo_bpm ãŒæƒ³å®šç¯„å›²å¤–ã§ã™ï¼ˆ60-180æ¨å¥¨ï¼‰");
    if(!song.time_signature) return warn("time_signature ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ4/4æ‰±ã„ï¼‰");
    // event sanity
    let count = 0;
    for(const t of song.tracks){
      const ev = normalizeEvents(t.events || t.notes || []);
      count += ev.length;
      if(count > 2000) return warn("ã‚¤ãƒ™ãƒ³ãƒˆæ•°ãŒå¤šã™ãã¾ã™ï¼ˆå†ç”ŸãŒé‡ããªã‚‹å¯èƒ½æ€§ï¼‰");
    }
    return { ok:true, fatal:false, msg:"OK" };
  }

  // ---------- Visualizer ----------
  class Visualizer{
    constructor(canvas, engine){
      this.cv = canvas;
      this.cx = canvas.getContext("2d");
      this.engine = engine;
      this.mode = 0; // 0 glow, 1 wire, 2 minimal
      this.reduceMotion = false;
      this._raf = null;
      this._freq = null;
      this._time = null;
      this._particles = [];
      this._lastPulse = 0;
      this._pulse = 0;
      this._seed = 12345;
      this._lastTitle = "";

      this._resize();
      window.addEventListener("resize", () => this._resize());
      this._initParticles();
    }

    _resize(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const rect = this.cv.getBoundingClientRect();
      this.cv.width = Math.floor(rect.width * dpr);
      this.cv.height = Math.floor(rect.height * dpr);
      this.cx.setTransform(1,0,0,1,0,0);
      this.cx.scale(dpr, dpr);
    }

    _initParticles(){
      this._particles = [];
      const rect = this.cv.getBoundingClientRect();
      const n = 90;
      for(let i=0;i<n;i++){
        this._particles.push({
          x: Math.random()*rect.width,
          y: Math.random()*rect.height,
          vx: (Math.random()*2-1)*0.25,
          vy: (Math.random()*2-1)*0.20,
          r: 1 + Math.random()*3,
          a: 0.25 + Math.random()*0.35
        });
      }
    }

    setMode(){
      this.mode = (this.mode + 1) % 3;
    }
    setReduceMotion(on){
      this.reduceMotion = !!on;
    }

    setSeedFromTitle(title){
      title = String(title||"");
      if(title === this._lastTitle) return;
      this._lastTitle = title;
      let h = 2166136261;
      for(let i=0;i<title.length;i++){
        h ^= title.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      this._seed = h >>> 0;
    }

    _rand(){
      // xorshift
      let x = this._seed || 123;
      x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
      this._seed = x >>> 0;
      return (this._seed % 100000) / 100000;
    }

    start(){
      const loop = () => {
        this._draw();
        this._raf = requestAnimationFrame(loop);
      };
      if(!this._raf) loop();
    }
    stop(){
      if(this._raf) cancelAnimationFrame(this._raf);
      this._raf = null;
    }

    pulse(){
      this._pulse = 1.0;
    }

    _draw(){
      const ctx = this.cx;
      const w = this.cv.getBoundingClientRect().width;
      const h = this.cv.getBoundingClientRect().height;

      ctx.clearRect(0,0,w,h);

      // background
      const g = ctx.createLinearGradient(0,0,w,h);
      g.addColorStop(0, "rgba(106,165,255,0.18)");
      g.addColorStop(0.45, "rgba(124,92,255,0.12)");
      g.addColorStop(1, "rgba(34,197,94,0.10)");
      ctx.fillStyle = "rgba(0,0,0,0.22)";
      ctx.fillRect(0,0,w,h);

      // subtle glow overlay
      ctx.globalCompositeOperation = "lighter";
      ctx.fillStyle = g;
      ctx.globalAlpha = 0.10 + 0.12*this._pulse;
      ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = "source-over";

      // decay pulse
      this._pulse *= 0.90;

      // analyser data
      const an = this.engine?.analyser;
      let bass = 0, mid = 0, treble = 0;
      if(an){
        const fb = an.frequencyBinCount;
        if(!this._freq || this._freq.length !== fb){
          this._freq = new Uint8Array(fb);
          this._time = new Uint8Array(an.fftSize);
        }
        an.getByteFrequencyData(this._freq);
        an.getByteTimeDomainData(this._time);

        // energy
        const f = this._freq;
        const bN = Math.floor(f.length*0.08);
        const mN = Math.floor(f.length*0.22);
        const tN = Math.floor(f.length*0.55);
        bass = avg(f, 0, bN);
        mid = avg(f, bN, mN);
        treble = avg(f, mN, tN);
      }

      // particles
      if(!this.reduceMotion){
        ctx.globalCompositeOperation = "lighter";
        const rect = this.cv.getBoundingClientRect();
        for(const p of this._particles){
          p.x += p.vx * (1 + bass/120);
          p.y += p.vy * (1 + bass/170);
          if(p.x < -10) p.x = rect.width+10;
          if(p.x > rect.width+10) p.x = -10;
          if(p.y < -10) p.y = rect.height+10;
          if(p.y > rect.height+10) p.y = -10;
          const rr = p.r * (1 + this._pulse*0.6);
          ctx.beginPath();
          ctx.fillStyle = `rgba(180,220,255,${p.a + 0.10*(bass/255)})`;
          ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.globalCompositeOperation = "source-over";
      }

      // spectrum
      if(this._freq){
        const f = this._freq;
        const bins = this.mode === 2 ? 72 : 120;
        const step = Math.floor(f.length / bins);
        const pad = 12;
        const barW = (w - pad*2) / bins;
        const baseY = h - 16;
        for(let i=0;i<bins;i++){
          const v = f[i*step] / 255;
          const hh = (h*0.55) * Math.pow(v, 1.35);
          const x = pad + i*barW;
          const y = baseY - hh;

          if(this.mode === 1){
            ctx.strokeStyle = `rgba(106,165,255,${0.10 + v*0.45})`;
            ctx.lineWidth = 1;
            ctx.strokeRect(x+1, y, Math.max(1, barW-2), hh);
          }else{
            ctx.fillStyle = `rgba(124,92,255,${0.08 + v*0.55})`;
            ctx.fillRect(x+1, y, Math.max(1, barW-2), hh);
            if(this.mode === 0){
              // glow top
              ctx.fillStyle = `rgba(255,255,255,${0.03 + v*0.10})`;
              ctx.fillRect(x+1, y, Math.max(1, barW-2), Math.max(1, 2));
            }
          }
        }
      }

      // waveform
      if(this._time){
        const t = this._time;
        ctx.beginPath();
        const midY = Math.floor(h*0.36);
        const amp = 0.22*h * (0.7 + bass/255*0.5);
        for(let i=0;i<t.length;i++){
          const x = (i/(t.length-1)) * w;
          const y = midY + ((t[i]-128)/128) * amp;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.lineWidth = this.mode === 2 ? 1 : 1.6;
        ctx.strokeStyle = `rgba(220,240,255,${0.20 + 0.25*(mid/255)})`;
        ctx.stroke();
      }

      // info overlay
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("Bass " + Math.round(bass) + "  Mid " + Math.round(mid) + "  Treble " + Math.round(treble), 14, 22);
    }
  }

  function avg(arr, a, b){
    a = Math.max(0, a|0);
    b = Math.min(arr.length, b|0);
    let s = 0;
    let n = Math.max(1, b-a);
    for(let i=a;i<b;i++) s += arr[i];
    return s/n;
  }

  // ---------- App State ----------
  const engine = new PromptSynthEngine();
  const viz = new Visualizer($("#viz"), engine);
  viz.start();
  engine.onBeatPulse = () => viz.pulse();

  let loadedIssues = null;
  let uiTimer = null;

  const LIB_KEY = "promptsynth_library_v1";

  function setErr(el, msg){
    const box = $(el);
    if(!msg){
      box.style.display = "none";
      box.textContent = "";
      return;
    }
    box.textContent = msg;
    box.style.display = "block";
  }

  function updatePromptLabels(){
    $("#bpmLab").textContent = $("#bpm").value;
    $("#barsLab").textContent = $("#bars").value;
    $("#swingLab").textContent = (+$("#swing").value).toFixed(2);
  }

  function updatePlayerUIEnabled(on){
    $("#btnPause").disabled = !on;
    $("#btnStop").disabled = !on;
    $("#btnRew").disabled = !on;
    $("#btnFwd").disabled = !on;
    $("#btnLoop").disabled = !on;
    $("#seek").disabled = !on;
    $("#masterVol").disabled = !on;
    $("#tempo").disabled = !on;
  }

  function refreshNowPlaying(){
    const s = engine.song;
    if(!s){
      $("#nowTitle").textContent = "æœªèª­ã¿è¾¼ã¿";
      $("#nowMeta").textContent = "â€”";
      return;
    }
    $("#nowTitle").textContent = s.title || "Untitled";
    const tags = (s.meta?.tags || []).slice(0,6).join(", ");
    const meta = `BPM ${engine.bpm}  /  ${engine.ts}  /  tracks ${engine.tracks.length}${tags ? "  /  "+tags : ""}`;
    $("#nowMeta").textContent = meta;
    viz.setSeedFromTitle(s.title || "Untitled");
  }

  function rebuildTracksUI(){
    const wrap = $("#tracks");
    wrap.innerHTML = "";
    if(!engine.song) return;

    for(const tr of engine.tracks){
      const row = document.createElement("div");
      row.className = "track";

      const left = document.createElement("div");
      left.className = "name";
      left.innerHTML = `<span>${escapeHtml(tr.name)}</span><span class="tag">${escapeHtml(tr.kind)}</span><span class="tiny">events ${tr.events.length}</span>`;
      row.appendChild(left);

      // volume
      const vol = document.createElement("div");
      vol.innerHTML = `<div class="tiny">Vol</div>`;
      const volR = document.createElement("input");
      volR.type = "range"; volR.min = "0"; volR.max = "1.2"; volR.step = "0.01"; volR.value = String(tr.uiVol);
      volR.addEventListener("input", () => tr.uiVol = +volR.value);
      vol.appendChild(volR);
      row.appendChild(vol);

      // pan
      const pan = document.createElement("div");
      pan.innerHTML = `<div class="tiny">Pan</div>`;
      const panR = document.createElement("input");
      panR.type = "range"; panR.min = "-1"; panR.max = "1"; panR.step = "0.01"; panR.value = String(tr.uiPan);
      panR.addEventListener("input", () => tr.uiPan = +panR.value);
      pan.appendChild(panR);
      row.appendChild(pan);

      const tog = document.createElement("div");
      tog.className = "tog";

      const bMute = document.createElement("button");
      bMute.className = "btn small";
      bMute.textContent = tr.muted ? "Mute:ON" : "Mute:OFF";
      bMute.addEventListener("click", () => {
        tr.muted = !tr.muted;
        bMute.textContent = tr.muted ? "Mute:ON" : "Mute:OFF";
      });

      const bSolo = document.createElement("button");
      bSolo.className = "btn small";
      bSolo.textContent = tr.solo ? "Solo:ON" : "Solo:OFF";
      bSolo.addEventListener("click", () => {
        tr.solo = !tr.solo;
        bSolo.textContent = tr.solo ? "Solo:ON" : "Solo:OFF";
      });

      tog.appendChild(bMute);
      tog.appendChild(bSolo);
      row.appendChild(tog);

      wrap.appendChild(row);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setTransportPlayingUI(){
    if(engine.playing){
      $("#btnPlay").textContent = "âµ å†ç”Ÿä¸­";
      $("#btnPlay").disabled = true;
      $("#btnPause").disabled = false;
      $("#btnStop").disabled = false;
    }else{
      $("#btnPlay").textContent = "â–¶ï¸ å†ç”Ÿ";
      $("#btnPlay").disabled = !engine.song;
      $("#btnPause").disabled = true;
      $("#btnStop").disabled = !engine.song;
    }
  }

  function updateLoopBtn(){
    $("#btnLoop").textContent = engine.loop ? "ğŸ” ãƒ«ãƒ¼ãƒ—:ON" : "ğŸ” ãƒ«ãƒ¼ãƒ—:OFF";
  }

  function startUiTimer(){
    stopUiTimer();
    uiTimer = setInterval(() => {
      if(!engine.song){
        $("#nowTime").textContent = "00:00 / 00:00";
        $("#nowBeat").textContent = "beat 0.00";
        $("#seek").value = "0";
        $("#seekLab").textContent = "â€”";
        return;
      }
      const b = engine.getCurrentBeat();
      const spb = 60/engine.bpm;
      const sec = b*spb;
      const durSec = engine.lengthBeats*spb;
      $("#nowTime").textContent = `${fmtTime(sec)} / ${fmtTime(durSec)}`;
      $("#nowBeat").textContent = `beat ${b.toFixed(2)}`;
      $("#seek").value = String(clamp(b/engine.lengthBeats, 0, 1));
      $("#seekLab").textContent = `${(b).toFixed(2)} / ${engine.lengthBeats.toFixed(2)} beats`;
      $("#tempoLab").textContent = $("#tempoOverride").checked ? ("Override " + engine.bpm) : "Follow";
    }, 60);
  }
  function stopUiTimer(){
    if(uiTimer) clearInterval(uiTimer);
    uiTimer = null;
  }

  // ---------- Library ----------
  function loadLibrary(){
    try{
      const raw = localStorage.getItem(LIB_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function saveLibrary(arr){
    localStorage.setItem(LIB_KEY, JSON.stringify(arr));
  }

  function openLibrary(){
    const dlg = $("#dlgLib");
    const list = $("#libList");
    const area = $("#libArea");
    const lib = loadLibrary();

    list.innerHTML = "";
    if(lib.length === 0){
      list.innerHTML = `<div class="mini">ï¼ˆã¾ã ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
    }else{
      for(let i=0;i<lib.length;i++){
        const item = lib[i];
        const row = document.createElement("div");
        row.className = "status";
        row.style.marginBottom = "10px";
        row.style.cursor = "pointer";

        const left = document.createElement("div");
        left.innerHTML = `<div class="title">${escapeHtml(item.title || "Untitled")}</div>
                          <div class="sub">BPM ${item.tempo_bpm} / ${escapeHtml(item.time_signature||"4/4")} / tracks ${(item.tracks||[]).length}</div>`;
        const right = document.createElement("div");
        right.className = "right";

        const del = document.createElement("button");
        del.className = "btn small danger";
        del.textContent = "å‰Šé™¤";
        del.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const lib2 = loadLibrary();
          lib2.splice(i,1);
          saveLibrary(lib2);
          openLibrary();
          toast("å‰Šé™¤ã—ã¾ã—ãŸ");
        });

        right.appendChild(del);
        row.appendChild(left);
        row.appendChild(right);
        row.addEventListener("click", () => {
          $("#songIn").value = JSON.stringify(item, null, 2);
          dlg.close();
          toast("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚èª­ã¿è¾¼ã¿ã‚’æŠ¼ã—ã¦ãã ã•ã„");
        });
        list.appendChild(row);
      }
    }

    area.value = JSON.stringify(lib, null, 2);
    dlg.showModal();
  }

  // ---------- Demo Song ----------
  function demoSong(){
    return {
      schema_version: "1.0",
      title: "Neon Drive (Demo)",
      meta: {
        author: "PromptSynth Player",
        created_utc: nowISO(),
        description: "A small synthwave-ish loop demo for the JSON player.",
        tags: ["demo","synthwave","night","loop"]
      },
      tempo_bpm: 112,
      time_signature: "4/4",
      swing: 0.10,
      master: {
        volume: 0.92,
        limiter: true,
        reverb: { enabled: true, mix: 0.16, decay_sec: 2.4 },
        delay: { enabled: true, mix: 0.12, time_beats: 0.5, feedback: 0.22 }
      },
      arrangement: { length_beats: 64, loop_start_beats: 0, loop_end_beats: 64 },
      tracks: [
        {
          id: "dr",
          name: "Drums",
          volume: 0.95,
          pan: 0,
          instrument: { type:"drums", kit:"electro" },
          events: buildDrums()
        },
        {
          id: "bs",
          name: "Bass",
          volume: 0.78,
          pan: -0.05,
          instrument: { type:"synth", wave:"square", polyphony: 2, attack:0.01, decay:0.08, sustain:0.5, release:0.12, cutoff_hz:1200, resonance:1.1 },
          events: buildBass()
        },
        {
          id: "pd",
          name: "Pad",
          volume: 0.62,
          pan: 0.10,
          instrument: { type:"synth", wave:"triangle", polyphony: 6, attack:0.08, decay:0.25, sustain:0.75, release:0.45, cutoff_hz:2200, resonance:0.8 },
          events: buildPad()
        },
        {
          id: "ld",
          name: "Lead",
          volume: 0.72,
          pan: 0.15,
          instrument: { type:"synth", wave:"sawtooth", polyphony: 6, attack:0.01, decay:0.12, sustain:0.55, release:0.18, cutoff_hz:2600, resonance:1.2 },
          events: buildLead()
        }
      ]
    };

    function buildDrums(){
      const ev = [];
      for(let bar=0; bar<16; bar++){
        const base = bar*4;
        // kick
        ev.push({t:base+0, d:0.25, hit:"kick", v:1.0});
        ev.push({t:base+2, d:0.25, hit:"kick", v:0.95});
        // snare
        ev.push({t:base+1, d:0.25, hit:"snare", v:0.85});
        ev.push({t:base+3, d:0.25, hit:"snare", v:0.90});
        // hats 8th
        for(let i=0;i<8;i++){
          ev.push({t:base+i*0.5, d:0.125, hit:"hat", v:0.42 + (i%2?0.05:0)});
        }
        // clap every 4 bars
        if(bar % 4 === 3) ev.push({t:base+3.5, d:0.25, hit:"clap", v:0.55});
      }
      return ev;
    }

    function buildBass(){
      // D# minor-ish feel
      const prog = [
        {root:"D#2", bars:4},
        {root:"B1", bars:4},
        {root:"C#2", bars:4},
        {root:"A#1", bars:4},
      ];
      const ev = [];
      let beat = 0;
      for(const p of prog){
        for(let b=0;b<p.bars;b++){
          // pattern: root (1 beat), fifth (0.5), root(0.5), octave(1), root(1)
          ev.push({t:beat+0.0, d:1.0, n:p.root, v:0.92});
          ev.push({t:beat+1.0, d:0.5, n:transpose(p.root, 7), v:0.86});
          ev.push({t:beat+1.5, d:0.5, n:p.root, v:0.86});
          ev.push({t:beat+2.0, d:1.0, n:transpose(p.root, 12), v:0.90});
          ev.push({t:beat+3.0, d:1.0, n:p.root, v:0.88});
          beat += 4;
        }
      }
      return ev;
    }

    function buildPad(){
      const chords = [
        ["D#4","F#4","A#4"],
        ["B3","D#4","F#4"],
        ["C#4","E4","G#4"],
        ["A#3","D4","F4"],
      ];
      const ev = [];
      for(let i=0;i<16;i++){
        const base = i*4;
        const ch = chords[Math.floor(i/4)%4];
        ev.push({t:base+0, d:4, n:ch, v:0.55});
      }
      return ev;
    }

    function buildLead(){
      const motif = ["F#4","G#4","A#4","C#5","A#4","G#4","F#4","D#4"];
      const ev = [];
      for(let bar=0; bar<16; bar++){
        const base = bar*4;
        for(let i=0;i<8;i++){
          const t = base + i*0.5;
          const n = motif[(i + (bar%4)*2) % motif.length];
          const v = 0.58 + (i%2?0.10:0);
          ev.push({t, d:0.45, n, v});
        }
        if(bar%4===3){
          ev.push({t:base+3.5, d:0.5, n:"C#5", v:0.85});
        }
      }
      return ev;
    }

    function transpose(noteStr, semis){
      // quick transpose using MIDI conversion on note name
      const m = noteStr.match(/^([A-G])([#b]?)(-?\d+)$/);
      if(!m) return noteStr;
      const letter = m[1], acc = m[2], oct = parseInt(m[3],10);
      const base = NOTE_BASE[letter] ?? 0;
      const a = acc === "#" ? 1 : (acc==="b"? -1 : 0);
      let midi = (oct+1)*12 + base + a + semis;
      midi = clamp(midi, 0, 127);
      // back to note name (prefer sharps)
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const nn = names[midi%12];
      const oo = Math.floor(midi/12)-1;
      return nn + oo;
    }
  }

  // ---------- Wiring ----------
  // labels
  updatePromptLabels();
  $("#bpm").addEventListener("input", updatePromptLabels);
  $("#bars").addEventListener("input", updatePromptLabels);
  $("#swing").addEventListener("input", updatePromptLabels);

  // prompt actions
  $("#btnGenPrompt").addEventListener("click", generatePrompt);
  $("#btnCopyPrompt").addEventListener("click", () => copyText($("#promptOut").value));
  $("#btnCopyPrompt2").addEventListener("click", () => copyText($("#promptOut").value));
  $("#btnPromptExample").addEventListener("click", () => {
    generatePrompt();
    toast("ä¾‹ã¨ã—ã¦ç”Ÿæˆã—ã¾ã—ãŸï¼ˆã“ã®ã¾ã¾ä½¿ãˆã¾ã™ï¼‰");
  });

  // help/shortcuts
  $("#btnHelp").addEventListener("click", () => $("#dlgHelp").showModal());
  $("#btnCloseHelp").addEventListener("click", () => $("#dlgHelp").close());
  $("#btnShortcuts").addEventListener("click", () => $("#dlgKeys").showModal());
  $("#btnCloseKeys").addEventListener("click", () => $("#dlgKeys").close());

  // unlock
  $("#btnUnlock").addEventListener("click", async () => {
    try{
      await engine.unlock();
    }catch(e){
      toast("è§£éŒ ã«å¤±æ•—: " + e.message);
    }
  });

  // load JSON
  $("#btnLoadJson").addEventListener("click", () => {
    setErr("#songErr", null);
    try{
      const { ok, obj, err, raw } = extractJson($("#songIn").value);
      if(!ok) throw new Error(err);
      // load into engine
      loadedIssues = engine.loadSong(obj);
      refreshNowPlaying();
      rebuildTracksUI();

      // update controls
      updatePlayerUIEnabled(true);
      $("#btnPlay").disabled = false;
      setTransportPlayingUI();
      engine.setLoop(false);
      updateLoopBtn();

      $("#tempo").value = String(engine.bpm);
      $("#masterVol").value = String(clamp(engine.masterGain.gain.value,0,1));
      $("#volLab").textContent = (+$("#masterVol").value).toFixed(2);

      startUiTimer();

      // warnings
      if(loadedIssues && !loadedIssues.ok && !loadedIssues.fatal){
        setErr("#songErr", "æ³¨æ„: " + loadedIssues.msg);
      }else{
        toast("èª­ã¿è¾¼ã¿OK");
      }
    }catch(e){
      setErr("#songErr", e.message);
    }
  });

  // demo
  $("#btnLoadDemo").addEventListener("click", () => {
    const s = demoSong();
    $("#songIn").value = JSON.stringify(s, null, 2);
    toast("ãƒ‡ãƒ¢ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸï¼ˆèª­ã¿è¾¼ã¿ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰");
  });

  // minify/pretty
  $("#btnMinify").addEventListener("click", () => {
    try{
      const { ok, obj, err } = extractJson($("#songIn").value);
      if(!ok) throw new Error(err);
      $("#songIn").value = JSON.stringify(obj);
      toast("ãƒŸãƒ‹ãƒ•ã‚¡ã‚¤ã—ã¾ã—ãŸ");
    }catch(e){
      setErr("#songErr", e.message);
    }
  });
  $("#btnPretty").addEventListener("click", () => {
    try{
      const { ok, obj, err } = extractJson($("#songIn").value);
      if(!ok) throw new Error(err);
      $("#songIn").value = JSON.stringify(obj, null, 2);
      toast("æ•´å½¢ã—ã¾ã—ãŸ");
    }catch(e){
      setErr("#songErr", e.message);
    }
  });
  $("#btnClearSong").addEventListener("click", () => {
    $("#songIn").value = "";
    setErr("#songErr", null);
  });

  // transport
  $("#btnPlay").addEventListener("click", async () => {
    setErr("#songErr", null);
    try{
      await engine.unlock();
      engine.play();
      setTransportPlayingUI();
    }catch(e){
      setErr("#songErr", e.message);
    }
  });
  $("#btnPause").addEventListener("click", () => {
    engine.pause();
    setTransportPlayingUI();
  });
  $("#btnStop").addEventListener("click", () => {
    engine.stop();
    setTransportPlayingUI();
  });
  $("#btnRew").addEventListener("click", () => {
    engine.seekToBeat(0);
  });
  $("#btnFwd").addEventListener("click", () => {
    const b = engine.getCurrentBeat();
    engine.seekToBeat(Math.min(engine.lengthBeats, b + 4));
  });
  $("#btnLoop").addEventListener("click", () => {
    engine.setLoop(!engine.loop);
    updateLoopBtn();
  });

  // seek
  let seeking = false;
  $("#seek").addEventListener("input", () => {
    if(!engine.song) return;
    seeking = true;
    const r = +$("#seek").value;
    const b = r * engine.lengthBeats;
    $("#seekLab").textContent = `${b.toFixed(2)} / ${engine.lengthBeats.toFixed(2)} beats`;
  });
  $("#seek").addEventListener("change", () => {
    if(!engine.song) return;
    const r = +$("#seek").value;
    const b = r * engine.lengthBeats;
    engine.seekToBeat(b);
    seeking = false;
  });

  // master vol
  $("#masterVol").addEventListener("input", () => {
    const v = +$("#masterVol").value;
    engine.setMasterVolume(v);
    $("#volLab").textContent = v.toFixed(2);
  });

  // tempo override
  $("#tempoOverride").addEventListener("change", () => {
    if(!engine.song) return;
    if($("#tempoOverride").checked){
      engine.setTempo(+$("#tempo").value);
      toast("ãƒ†ãƒ³ãƒä¸Šæ›¸ãã‚’æœ‰åŠ¹åŒ–");
    }else{
      // revert to song tempo
      const sTempo = clamp(+engine.song.tempo_bpm || 120, 60, 180);
      engine.setTempo(sTempo);
      $("#tempo").value = String(sTempo);
      toast("æ›²ã®ãƒ†ãƒ³ãƒã«æˆ»ã—ã¾ã—ãŸ");
    }
  });
  $("#tempo").addEventListener("input", () => {
    if(!engine.song) return;
    const v = +$("#tempo").value;
    if($("#tempoOverride").checked){
      engine.setTempo(v);
    }else{
      $("#tempo").value = String(engine.bpm);
    }
  });

  // loop button init
  updateLoopBtn();

  // viz mode
  $("#btnVizMode").addEventListener("click", () => {
    viz.setMode();
    const name = ["Glow","Wire","Minimal"][viz.mode] || "Glow";
    $("#btnVizMode").textContent = "âœ¨ ãƒ¢ãƒ¼ãƒ‰: " + name;
  });
  $("#btnReduceMotion").addEventListener("click", () => {
    viz.setReduceMotion(!viz.reduceMotion);
    $("#btnReduceMotion").textContent = viz.reduceMotion ? "ğŸ«¥ è»½é‡:ON" : "ğŸ«¥ è»½é‡:OFF";
  });

  // save library
  $("#btnSaveLib").addEventListener("click", () => {
    setErr("#songErr", null);
    try{
      const { ok, obj, err } = extractJson($("#songIn").value);
      if(!ok) throw new Error(err);
      const lib = loadLibrary();
      // simple de-dup by title+created_utc
      const key = (obj.title||"") + "|" + (obj.meta?.created_utc||"");
      const exists = lib.some(x => ((x.title||"")+"|"+(x.meta?.created_utc||"")) === key);
      if(!exists) lib.unshift(obj);
      saveLibrary(lib.slice(0, 50));
      toast("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã—ãŸ");
    }catch(e){
      setErr("#songErr", e.message);
    }
  });

  // show library
  $("#btnShowLib").addEventListener("click", openLibrary);
  $("#btnCloseLib").addEventListener("click", () => $("#dlgLib").close());
  $("#btnCopyLib").addEventListener("click", () => copyText($("#libArea").value));

  $("#btnExportLib").addEventListener("click", () => {
    const lib = loadLibrary();
    $("#libArea").value = JSON.stringify(lib, null, 2);
    toast("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæº–å‚™OKï¼ˆä¸‹ã®JSONã‚’ã‚³ãƒ”ãƒ¼ï¼‰");
  });

  $("#btnImportLib").addEventListener("click", () => {
    try{
      const raw = $("#libArea").value.trim();
      if(!raw) throw new Error("ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨JSONãŒç©ºã§ã™");
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) throw new Error("é…åˆ—JSONã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      // basic validate items
      const cleaned = arr.filter(x => x && typeof x === "object" && Array.isArray(x.tracks));
      saveLibrary(cleaned.slice(0, 50));
      openLibrary();
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    }catch(e){
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: " + e.message);
    }
  });

  // download current json
  $("#btnDownloadJson").addEventListener("click", () => {
    try{
      const { ok, obj, err } = extractJson($("#songIn").value);
      if(!ok) throw new Error(err);
      const name = (obj.title || "song").replace(/[^\w\-]+/g, "_").slice(0, 40) || "song";
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `promptsynth_${name}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("JSONã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }catch(e){
      setErr("#songErr", e.message);
    }
  });

  // keyboard shortcuts
  window.addEventListener("keydown", (ev) => {
    const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
    if(tag === "textarea" || tag === "input" || tag === "select") return;

    if(ev.code === "Space"){
      ev.preventDefault();
      if(!engine.song) return;
      if(engine.playing){
        engine.pause();
      }else{
        engine.unlock().then(() => engine.play()).catch(()=>{});
      }
      setTransportPlayingUI();
    }else if(ev.key.toLowerCase() === "s"){
      if(engine.song){
        engine.stop();
        setTransportPlayingUI();
      }
    }else if(ev.key.toLowerCase() === "l"){
      if(engine.song){
        engine.setLoop(!engine.loop);
        updateLoopBtn();
      }
    }else if(ev.key === "ArrowLeft"){
      if(engine.song && !engine.playing){
        engine.seekToBeat(0);
      }
    }else if(ev.key === "ArrowRight"){
      if(engine.song){
        engine.seekToBeat(Math.min(engine.lengthBeats, engine.getCurrentBeat() + 4));
      }
    }
  });

  // Auto-generate initial prompt
  generatePrompt();
  startUiTimer();

  // reflect play/pause status periodically
  setInterval(() => setTransportPlayingUI(), 120);

})();
</script>
</div>
</body>
</html>
````
