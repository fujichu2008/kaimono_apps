<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ゆるキャラ飲酒トラッカー</title>
<meta name="theme-color" content="#3a7afe">
<style>
:root{
  /* 背景テーマ（朝夕夜） */
  --bg-morning: linear-gradient(180deg,#e6f3ff 0%, #ffffff 60%);
  --bg-evening: linear-gradient(180deg,#ffe6b3 0%, #ffffff 60%);
  --bg-night:   linear-gradient(180deg,#091834 0%, #152a52 60%);
  --bg-card: #ffffff;
  --line: #dbe4ff;
  --text: #0f172a;
  --muted:#64748b;
  --accent:#3a7afe;
  --ok:#16a34a;
  --warn:#ef4444;
  --gold:#f59e0b;
  --pill:#eef4ff;
  --tiny:#6b7280;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg-morning);
  transition:background .4s ease;
}

header{
  position:sticky; top:0; z-index:50;
  backdrop-filter:saturate(140%) blur(6px);
  background:rgba(255,255,255,.75);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:980px;margin:auto;padding:12px}

h1{font-size:18px;margin:0}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
.modeTabs{display:flex;gap:6px;flex-wrap:wrap}
.tabBtn{
  border:1px solid var(--line); background:#fff; color:var(--text);
  border-radius:999px; padding:6px 12px; cursor:pointer; font-weight:600;
}
.tabBtn.active{background:var(--accent); color:#fff; border-color:transparent}

main{min-height:100vh}

.card{
  background:var(--bg-card); border:1px solid var(--line);
  border-radius:14px; padding:12px;
}

/* ── サマリー（上部） ── */
#summary{
  display:grid; grid-template-columns:1fr; gap:10px;
}
.summaryRow{
  display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
}
.kpi{
  background:#fff; border:1px solid var(--line); border-radius:12px;
  padding:10px; text-align:center;
}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{font-size:18px;font-weight:800;margin-top:2px}
.tinySaved{
  font-size:12px; color:var(--tiny); text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* 分解バー（横一文字：デジ単風） */
#decompWrap{
  display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
}
#decompBar{
  position:relative; height:14px; border-radius:999px;
  background:linear-gradient(90deg,#c7d2fe,#93c5fd,#6ee7b7);
  overflow:hidden;
}
#decompMask{
  position:absolute; top:0; right:0; bottom:0;
  width:0%; background:rgba(255,255,255,.75); transition:width .6s ease;
}
#decompText{font-size:14px; color:var(--text)}
#eta{font-size:12px; color:var(--muted)}

/* ── 入力タイル ── */
.sectionTitle{display:flex;align-items:center;justify-content:space-between;margin:12px 0 6px}
.grid{
  display:grid; gap:10px;
  grid-template-columns:repeat(2,1fr);
}
@media(min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
@media(min-width:840px){ .grid{grid-template-columns:repeat(4,1fr)} }

.tile{
  position:relative; background:#fff; border:1px solid var(--line);
  border-radius:12px; padding:10px; cursor:pointer; user-select:none; touch-action:manipulation;
  transition:transform .05s ease;
}
.tile:active{transform:scale(.985)}
.tile .name{font-weight:800}
.tile .meta{font-size:12px;color:var(--muted)}
.badge{
  position:absolute; top:8px; right:8px; background:#0ea5e9; color:#fff;
  border-radius:999px; font-size:12px; line-height:1; padding:6px 8px; min-width:24px; text-align:center;
}
.swipeHint{position:absolute; left:8px; bottom:6px; font-size:11px; color:#94a3b8}

/* 固定フッター（当日合計） */
.fixedBar{
  position:sticky; bottom:0; left:0; right:0; z-index:40;
  background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(245,248,255,.95));
  border-top:1px solid var(--line); padding:8px 0;
}
.fixedStats{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
.kv{font-size:14px}
.kv b{font-size:16px}
.small{font-size:12px; color:var(--muted)}

/* ── タブ（入力 / 履歴） ── */
.appTabs{display:flex; gap:8px; margin-top:8px}
.appTabBtn{
  border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer;
}
.appTabBtn.active{background:var(--accent); color:#fff; border-color:transparent}

/* ── 履歴ビュー ── */
#historyView{display:none}
.historyHead{
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;
}
.rangeTabs{display:flex; gap:6px}
.chartCanvas{width:100%; height:260px; background:#fff; border:1px solid var(--line); border-radius:12px}

/* ── ゆるキャラ舞台 ── */
#mascotStage{
  margin-top:12px; position:relative; height:200px;
  border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.6);
  overflow:hidden;
}
#mascotCanvas{position:absolute; inset:0}

/* ── 背景テーマ切替 ── */
main[data-theme="morning"]{background:var(--bg-morning)}
main[data-theme="evening"]{background:var(--bg-evening)}
main[data-theme="night"]  {background:var(--bg-night)}
</style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <h1>ゆるキャラ飲酒トラッカー</h1>
      <div class="modeTabs" id="modeTabs">
        <button class="tabBtn active" data-mode="home">家飲み</button>
        <button class="tabBtn" data-mode="out">外食</button>
      </div>
    </div>
  </header>

  <main id="app" data-theme="morning">
    <div class="wrap">
      <!-- アプリ内タブ（入力 / 履歴） -->
      <div class="appTabs" id="appTabs">
        <button class="appTabBtn active" data-view="input">入力</button>
        <button class="appTabBtn" data-view="history">履歴</button>
      </div>

      <!-- 上部サマリー -->
      <section id="summary" class="card" style="margin-top:10px;">
        <div class="tinySaved" id="tinySaved"></div>
        <div class="summaryRow">
          <div class="kpi"><div class="label">総量</div><div class="value" id="sumLiters">0.0 L</div></div>
          <div class="kpi"><div class="label">純アル</div><div class="value" id="sumGrams">0 g</div></div>
          <div class="kpi"><div class="label">概算金額</div><div class="value" id="sumYen">¥0</div></div>
          <div class="kpi">
            <div class="label">分解進捗</div>
            <div id="decompWrap">
              <div id="decompBar"><div id="decompMask" style="width:0%"></div></div>
              <div>
                <div id="decompText">残量 0%</</div>
                <div id="eta">0%見込み --:--</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 入力ビュー -->
      <section id="inputView" class="card" style="margin-top:12px;">
        <div class="sectionTitle"><b>飲み物をタップで追加（左スワイプで-1 / 長押しで編集）</b></div>
        <div class="grid" id="presetGrid"></div>
      </section>

      <!-- 履歴ビュー -->
      <section id="historyView" class="card" style="margin-top:12px;">
        <div class="historyHead">
          <div class="rangeTabs" id="rangeTabs">
            <button class="tabBtn active" data-range="30d">直近30日</button>
            <button class="tabBtn" data-range="12m">過去12か月</button>
          </div>
          <div class="tinySaved" id="tinySavedHistory"></div>
        </div>
        <div style="margin-top:8px">
          <canvas id="chart" class="chartCanvas"></canvas>
        </div>
        <div id="mascotStage">
          <canvas id="mascotCanvas"></canvas>
        </div>
      </section>
    </div>

    <div class="fixedBar">
      <div class="wrap fixedStats">
        <div class="kv">今日の純アル：<b id="gToday">0</b> g</div>
        <div class="kv">今日の飲み代：<b id="yenToday">0</b> 円</div>
        <div class="kv">残量：<b id="leftPct">0%</b>（0%時刻 <span id="zeroEta">--:--</span>）</div>
        <div class="small">翌日10:00締切／残量バーは前日継続</div>
      </div>
    </div>
  </main>

<script>
/* =========================
   定数・保存キー・初期データ
   ========================= */
const LS_KEY_LOGS     = 'drink_logs_v1';        // { 'YYYY-MM-DD': [ {id, ml, abv, price, count, ts} ] }
const LS_KEY_PRESETS  = 'drink_presets_v1';     // { home:[], out:[] }
const LS_KEY_PROFILE  = 'drink_profile_v1';     // { weightKg, k }
const LS_KEY_SETTINGS = 'drink_settings_v1';    // { cutoffHour, monthlyBudget }
const CUTOFF_HOUR_DEFAULT = 10; // 翌日10:00締切
const DEFAULT_MONTHLY_BUDGET = 12000;

/* プロファイル（分解用） */
const DEFAULT_PROFILE = { weightKg: 70, k: 0.1 };// g/h/kg

/* 家飲み（コンビニ価格）※発泡酒あり／焼酎ロック・水割り */
const PRESETS_HOME = [
  { id:'beer350',   name:'ビール 350ml',     ml:350, abv:5,  price:220, color:'#fff2cc' },
  { id:'beer500',   name:'ビール 500ml',     ml:500, abv:5,  price:300, color:'#ffe8b3' },
  { id:'happoshu350', name:'発泡酒 350ml',   ml:350, abv:5,  price:160, color:'#f8ffcc' },
  { id:'happoshu500', name:'発泡酒 500ml',   ml:500, abv:5,  price:210, color:'#f0ff99' },
  { id:'chuhi350',  name:'チューハイ 350ml', ml:350, abv:9,  price:160, color:'#e8f4ff' },
  { id:'chuhi500',  name:'チューハイ 500ml', ml:500, abv:9,  price:210, color:'#d9ecff' },
  { id:'highball350', name:'ハイボール缶 350ml', ml:350, abv:7, price:180, color:'#f0f7ff' },
  { id:'sake180',   name:'日本酒 1合 180ml', ml:180, abv:15, price:300, color:'#fafafa' },
  { id:'wine150',   name:'ワイン 1杯 150ml', ml:150, abv:12, price:250, color:'#ffeaf3' },
  { id:'shaoxing90', name:'紹興酒 1杯 90ml', ml:90, abv:16, price:250, color:'#ffeee0' },
  { id:'shochu_rock', name:'焼酎 ロック 90ml', ml:90, abv:25, price:180, color:'#ffe0f0' },
  { id:'shochu_mizu', name:'焼酎 水割り 120ml', ml:120, abv:15, price:180, color:'#eaf9ff' }
];

/* 外食（大衆居酒屋価格）※焼酎ロック・水割り */
const PRESETS_OUT = [
  { id:'draft500',    name:'生ビール 中 500ml',   ml:500, abv:5,  price:500, color:'#ffe8b3' },
  { id:'chuhi350o',   name:'チューハイ 350ml',     ml:350, abv:8,  price:350, color:'#e8f4ff' },
  { id:'highball300', name:'ハイボール 300ml',     ml:300, abv:7,  price:400, color:'#f0f7ff' },
  { id:'sake180o',    name:'日本酒 1合 180ml',     ml:180, abv:15, price:400, color:'#fafafa' },
  { id:'wine120o',    name:'ワイン グラス 120ml',  ml:120, abv:12, price:400, color:'#ffeaf3' },
  { id:'shaoxing90o', name:'紹興酒 1杯 90ml',      ml:90,  abv:16, price:350, color:'#ffeee0' },
  { id:'shochu_rock_o', name:'焼酎 ロック 90ml',   ml:90,  abv:25, price:400, color:'#ffe0f0' },
  { id:'shochu_mizu_o', name:'焼酎 水割り 150ml',  ml:150, abv:13, price:400, color:'#eaf9ff' }
];

const DEFAULT_PRESETS = { home: PRESETS_HOME, out: PRESETS_OUT };

/* 保存/読込 */
const load = (k, d) => { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? d }catch(_){ return d } }
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* 共有ステート */
let state = {
  mode: 'home',                       // 'home' | 'out'
  view: 'input',                      // 'input' | 'history'
  presets: load(LS_KEY_PRESETS, DEFAULT_PRESETS),
  profile: load(LS_KEY_PROFILE, DEFAULT_PROFILE),
  settings: load(LS_KEY_SETTINGS, { cutoffHour: CUTOFF_HOUR_DEFAULT, monthlyBudget: DEFAULT_MONTHLY_BUDGET }),
  logs: load(LS_KEY_LOGS, {}),        // { 'YYYY-MM-DD': [entries] }
  undo: []
};

/* =========================
   ユーティリティ
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function yyyy_mm_dd(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10); }
function nowLocal(){ return new Date(); }
function todayKey(){ return yyyy_mm_dd(nowLocal()); }
function yesterdayKey(){ const d = nowLocal(); d.setDate(d.getDate()-1); return yyyy_mm_dd(d); }
function isBeforeCutoff(){ const h = nowLocal().getHours(); return h < (state.settings.cutoffHour ?? CUTOFF_HOUR_DEFAULT); }

function toYen(n){ return '¥' + (n|0).toLocaleString() }
function round1(n){ return Math.round(n*10)/10 }
function round2(n){ return Math.round(n*100)/100 }
function pureAlcoholG(ml, abv){ return round2(ml * (abv/100) * 0.8) }

function sumDay(key){
  const arr = state.logs[key] || [];
  let ml=0, g=0, yen=0;
  arr.forEach(it=>{
    const c = it.count || 1;
    ml  += (it.ml||0) * c;
    g   += pureAlcoholG(it.ml, it.abv) * c;
    yen += (it.price||0) * c;
  });
  return { ml, g:round2(g), yen: yen|0, liters: round1(ml/1000) };
}

function decompRateGph(){ const w = state.profile.weightKg || 70; const k = state.profile.k || 0.1; return w * k; }
function etaFromNowByG(totalG){
  const rate = decompRateGph(); if(totalG<=0 || rate<=0) return '--:--';
  const hours = totalG / rate; const eta = new Date(Date.now() + hours*3600*1000);
  const hh = String(eta.getHours()).padStart(2,'0'); const mm = String(eta.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`;
}

function applyTimeTheme(){
  const h = nowLocal().getHours();
  const main = $('#app');
  let theme = 'morning';
  if(h>=12 && h<18) theme = 'evening';
  else if(h>=18 || h<5) theme = 'night';
  main.setAttribute('data-theme', theme);
}

/* タブ切替（表示のON/OFF） */
function setAppView(view){
  state.view = view;
  $('#inputView').style.display   = (view==='input') ? 'block' : 'none';
  $('#historyView').style.display = (view==='history') ? 'block' : 'none';
  $$('#appTabs .appTabBtn').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
}

/* 家飲み/外食切替 */
function setMode(mode){
  state.mode = mode;
  $$('#modeTabs .tabBtn').forEach(b=> b.classList.toggle('active', b.dataset.mode===mode));
  renderPresetTiles();
  refreshTodaySummary();
}

/* 入力タイルの生成（安全フォールバック） */
const gridEl = document.getElementById('presetGrid');
function renderPresetTiles(){
  const list = state.presets[state.mode] || [];
  if (!gridEl) return;
  gridEl.innerHTML = '';

  const key = (typeof activeInputKey === 'function')
    ? activeInputKey()
    : (isBeforeCutoff() ? yesterdayKey() : todayKey());

  const arr = state.logs[key] || [];
  const counts = {};
  arr.forEach(e => counts[e.id] = (counts[e.id]||0) + (e.count||1));

  list.forEach(p=>{
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.style.background = p.color || '#fff';
    tile.dataset.id = p.id;
    tile.innerHTML = `
      <div class="name">${p.name}</div>
      <div class="meta">${p.ml}ml / ${p.abv}% ・ 約${toYen(p.price)}</div>
      <div class="badge" data-badge>0</div>
      <div class="swipeHint">←で-1 / 長押しで編集</div>
    `;
    attachTileHandlers(tile, p);
    gridEl.appendChild(tile);
  });

  gridEl.querySelectorAll('.tile').forEach(t=>{
    const id = t.dataset.id; const n = counts[id]||0;
    t.querySelector('[data-badge]').textContent = n;
  });
}

/* タイル操作 */
function attachTileHandlers(tile, preset){
  let startX=null, swiping=false, longPressTimer=null;

  const onTap = ()=>{ if(swiping) return; window.dispatchEvent(new CustomEvent('ui:addOne', { detail: { preset } })); };

  const onTouchStart = (e)=>{
    swiping=false; startX = e.touches?.[0]?.clientX ?? null;
    longPressTimer = setTimeout(()=>{ longPressTimer=null; editPreset(preset.id); }, 500);
  };
  const onTouchMove = (e)=>{
    if(startX==null) return;
    const dx = (e.touches?.[0]?.clientX ?? 0) - startX;
    if(dx < -30){ swiping = true;
      window.dispatchEvent(new CustomEvent('ui:removeOne', { detail: { presetId: preset.id }}));
      startX=null; clearTimeout(longPressTimer); longPressTimer=null;
    }
  };
  const onTouchEnd = ()=>{
    if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; onTap(); }
    startX=null; setTimeout(()=>{ swiping=false; }, 50);
  };

  tile.addEventListener('click', onTap);
  tile.addEventListener('touchstart', onTouchStart, {passive:true});
  tile.addEventListener('touchmove', onTouchMove, {passive:true});
  tile.addEventListener('touchend', onTouchEnd);
}

/* 長押し編集（簡易） */
function editPreset(id){
  const list = state.presets[state.mode] || [];
  const p = list.find(x=>x.id===id); if(!p) return;
  const name = prompt('表示名', p.name); if(name===null) return;
  const ml   = +prompt('容量(ml)', p.ml); if(Number.isNaN(ml)) return;
  const abv  = +prompt('度数(%)', p.abv); if(Number.isNaN(abv)) return;
  const price= +prompt('単価(円)', p.price); if(Number.isNaN(price)) return;
  p.name=name; p.ml=ml; p.abv=abv; p.price=price;
  save(LS_KEY_PRESETS, state.presets);
  renderPresetTiles();
}

/* イベント登録（ガード付き） */
const appTabsEl = document.getElementById('appTabs');
if (appTabsEl) {
  appTabsEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('.appTabBtn'); if(!btn) return;
    setAppView(btn.dataset.view);
  });
}

const modeTabsEl = document.getElementById('modeTabs');
if (modeTabsEl) {
  modeTabsEl.addEventListener('click', (e)=>{
    const b = e.target.closest('.tabBtn'); if(!b) return;
    setMode(b.dataset.mode);
  });
}

const rangeTabsEl = document.getElementById('rangeTabs');
if (rangeTabsEl) {
  rangeTabsEl.addEventListener('click', (e)=>{
    const b = e.target.closest('.tabBtn'); if(!b) return;
    document.querySelectorAll('#rangeTabs .tabBtn').forEach(x=>x.classList.toggle('active', x===b));
    window.dispatchEvent(new CustomEvent('ui:rangeChange', { detail: { range: b.dataset.range }}));
  });
}
</script>

<script>
/* =========================
   2/3: コアロジック
   ========================= */

/* 入力対象日（翌日10:00までは前日を入力対象に） */
function activeInputKey(){ return isBeforeCutoff() ? yesterdayKey() : todayKey(); }

/* ログ操作 */
function ensureDay(key){ state.logs[key] = state.logs[key] || []; return state.logs[key] }

function addOne(preset){
  const key = activeInputKey();
  const arr = ensureDay(key);
  arr.push({ id:preset.id, ml:preset.ml, abv:preset.abv, price:preset.price, count:1, ts: Date.now() });
  save(LS_KEY_LOGS, state.logs);
  state.undo.push({ type:'add', key, entryId:preset.id });
  onDataChanged();
}
function removeOne(presetId){
  const key = activeInputKey();
  const arr = ensureDay(key);
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i].id===presetId){
      const removed = arr.splice(i,1)[0];
      save(LS_KEY_LOGS, state.logs);
      state.undo.push({ type:'remove', key, entry: removed });
      onDataChanged();
      return true;
    }
  }
  return false;
}

/* 1/3からのUIイベント */
window.addEventListener('ui:addOne', (e)=> addOne(e.detail.preset));
window.addEventListener('ui:removeOne', (e)=> removeOne(e.detail.presetId));

/* サマリー（アクティブ日基準に統一） */
function renderTinySaved(){
  const now = nowLocal();
  const y = now.getFullYear(), m = now.getMonth();
  const budget = (state.settings.monthlyBudget ?? DEFAULT_MONTHLY_BUDGET)|0;

  // 月累計
  let spent = 0;
  for(const key in state.logs){
    const d = new Date(key);
    if(d.getFullYear()===y && d.getMonth()===m) spent += sumDay(key).yen;
  }
  const saved = Math.max(0, budget - spent);

  // 日表示（予算日割り vs 今日）
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const budgetPerDay = Math.round(budget / daysInMonth);
  const todaySum = sumDay(todayKey());
  const savedToday = Math.max(0, budgetPerDay - todaySum.yen);

  const UNITS_DAY = [
    { label:'コーヒー', yen:120, unit:'杯' },
    { label:'おにぎり', yen:150, unit:'個' },
    { label:'ラーメン', yen:800, unit:'杯' },
    { label:'メダカの餌', yen:300, unit:'袋' },
  ];
  const UNITS_MONTH = [
    { label:'寿司', yen:120, unit:'皿' },
    { label:'映画', yen:1800, unit:'本' },
    { label:'焼肉', yen:1000, unit:'人前' },
    { label:'ガソリン', yen:3000, unit:'半タンク' },
  ];

  const tinyDay = $('#tinySaved');
  const tinyMonth = $('#tinySavedHistory');

  if(savedToday >= 200){
    const u = UNITS_DAY[Math.floor(hashSeed(todayKey()) % UNITS_DAY.length)];
    const n = Math.max(1, Math.floor(savedToday / u.yen));
    tinyDay.textContent = `今日は ${toYen(savedToday)} セーブ（${u.label} × ${n}）`;
  }else{
    tinyDay.textContent = '';
  }

  if(saved >= 200){
    const u2 = UNITS_MONTH[Math.floor(hashSeed(`${y}-${m+1}`) % UNITS_MONTH.length)];
    const n2 = Math.max(1, Math.floor(saved / u2.yen));
    tinyMonth.textContent = `今月 ${toYen(saved)} セーブ（${u2.label} × ${n2}）`;
  }else{
    tinyMonth.textContent = '';
  }
}

function refreshTodaySummary(){
  const key = (typeof activeInputKey === 'function')
    ? activeInputKey()
    : (isBeforeCutoff() ? yesterdayKey() : todayKey());

  const sum = sumDay(key);
  $('#sumLiters').textContent = `${sum.liters.toFixed(1)} L`;
  $('#sumGrams').textContent  = `${sum.g} g`;
  $('#sumYen').textContent    = toYen(sum.yen);
  $('#gToday').textContent    = sum.g;
  $('#yenToday').textContent  = sum.yen.toLocaleString();

  refreshDecompBar();    // 前日継続ロジックあり
  renderPresetTiles();   // バッジ更新
  renderTinySaved();     // 極小表示
}

/* 分解バー（前日継続：直近飲酒日の最後の時刻を基準） */
function refreshDecompBar(){
  const yKey = yesterdayKey(), tKey = todayKey();
  const pick = (state.logs[yKey] && state.logs[yKey].length>0) ? yKey : tKey;
  const arr = state.logs[pick] || [];
  if(arr.length===0){ setDecompUI(0, '--:--'); return; }

  const totals = sumDay(pick);
  const rate = decompRateGph(); // g/h
  const lastTs = Math.max(...arr.map(x=> x.ts || Date.now()));
  const hoursSince = (Date.now() - lastTs) / 3600000;
  const remainG = Math.max(0, totals.g - rate * hoursSince);
  const pct = totals.g > 0 ? Math.max(0, Math.min(100, Math.round(remainG / totals.g * 100))) : 0;

  let etaStr = '--:--';
  if(rate>0 && totals.g>0){
    const eta = new Date(lastTs + (totals.g/rate)*3600*1000);
    const hh = String(eta.getHours()).padStart(2,'0');
    const mm = String(eta.getMinutes()).padStart(2,'0');
    etaStr = `${hh}:${mm}`;
  }
  setDecompUI(pct, etaStr);
}

function setDecompUI(pct, etaStr){
  $('#decompMask').style.width = `${100-pct}%`;
  $('#decompText').textContent = `残量 ${pct}%`;
  $('#eta').textContent = `0%見込み ${etaStr}`;
  $('#leftPct').textContent = `${pct}%`;
  $('#zeroEta').textContent = etaStr;
}

/* 乱数の固定化（同日/同月で固定） */
function hashSeed(s){
  let h = 2166136261>>>0;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619)>>>0; }
  return h >>> 0;
}

/* 変更時の再集計と通知 */
function onDataChanged(){
  refreshTodaySummary();
  const payload = buildHistoryDatasets();
  window.dispatchEvent(new CustomEvent('data:updated', { detail: payload }));
}

/* 履歴データ（直近30日 & 過去12か月） */
function buildHistoryDatasets(){
  const today = nowLocal();
  const daily = [];
  for(let i=29;i>=0;i--){
    const d = new Date(today); d.setDate(d.getDate()-i);
    const key = yyyy_mm_dd(d);
    const s = sumDay(key);
    daily.push({ key, date:new Date(d), g:s.g, yen:s.yen });
  }
  const monthly = [];
  for(let i=11;i>=0;i--){
    const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
    const y = d.getFullYear(), m = d.getMonth();
    let g=0, yen=0;
    for(const key in state.logs){
      const kd = new Date(key);
      if(kd.getFullYear()===y && kd.getMonth()===m){
        const s = sumDay(key); g += s.g; yen += s.yen;
      }
    }
    monthly.push({ ym:`${y}-${String(m+1).padStart(2,'0')}`, year:y, month:m, g:round2(g), yen: yen|0 });
  }
  return { daily, monthly };
}

/* 1分ごとに分解バーを更新（リアルタイム） */
setInterval(()=>{ try{ refreshDecompBar(); }catch(_){} }, 60000);

/* 初期起動タイミングで一度発火（safeBoot後にも呼ばれる想定） */
(function initOnce(){
  const payload = buildHistoryDatasets();
  window.dispatchEvent(new CustomEvent('data:updated', { detail: payload }));
})();
</script>



<script>
/* =========================
   3/3: グラフ & ゆるキャラ描画
   ========================= */

let lastPayload = { daily:[], monthly:[] };
let currentRange = '30d';
const chart = $('#chart');
const ctx = chart.getContext('2d');
const mascCanvas = $('#mascotCanvas');
const mctx = mascCanvas.getContext('2d');

/* DPR対応キャンバスサイズ調整 */
function fitCanvas(canvas, cssW, cssH){
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  return dpr;
}
function layoutCanvases(){
  const chartBox = chart.getBoundingClientRect();
  const mascBox  = mascCanvas.parentElement.getBoundingClientRect();
  fitCanvas(chart, Math.max(320, chartBox.width), Math.max(220, chartBox.height));
  fitCanvas(mascCanvas, Math.max(320, mascBox.width), Math.max(160, mascBox.height));
}

/* 描画ユーティリティ */
function line(ctx,x1,y1,x2,y2,w=1,style='#94a3b8'){ctx.beginPath();ctx.lineWidth=w;ctx.strokeStyle=style;ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
function text(ctx, s, x, y, size=12, color='#334155', align='left'){
  ctx.fillStyle=color; ctx.font=`${size}px system-ui`; ctx.textAlign=align; ctx.textBaseline='middle'; ctx.fillText(s,x,y);
}
function roundRect(ctx,x,y,w,h,r, fill, stroke){
  ctx.beginPath();const rr=Math.min(r,Math.min(w,h)/2);
  ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,x,rr); ctx.arcTo(x,y,x+w,y,rr);
  if(fill){ctx.fillStyle=fill; ctx.fill();} if(stroke){ctx.strokeStyle=stroke; ctx.stroke();}
}

/* グラフ描画 */
function drawChart(){
  layoutCanvases();
  ctx.clearRect(0,0,chart.width,chart.height);
  const dpr = window.devicePixelRatio || 1;
  const W = chart.width, H = chart.height;
  const padL = 48*dpr, padR = 52*dpr, padT = 18*dpr, padB = 28*dpr;
  const area = { x:padL, y:padT, w:W-padL-padR, h:H-padT-padB };

  const data = (currentRange==='30d') ? lastPayload.daily : lastPayload.monthly;
  if(!data || data.length===0){ text(ctx,'データなし',W/2,H/2,14*dpr,'#64748b','center'); return; }

  const maxG = Math.max(10, ...data.map(d=>d.g));
  const maxY = Math.max(1000, ...data.map(d=>d.yen));
  const barW = Math.max(6*dpr, Math.min(20*dpr, area.w/(data.length*1.3)));

  // 軸
  line(ctx, area.x, area.y, area.x, area.y+area.h, 1*dpr,'#cbd5e1');
  line(ctx, area.x+area.w, area.y, area.x+area.w, area.y+area.h, 1*dpr,'#cbd5e1');
  line(ctx, area.x, area.y+area.h, area.x+area.w, area.y+area.h, 1*dpr,'#cbd5e1');

  // g目盛
  for(let i=0;i<=4;i++){
    const gy=area.y+area.h-(i/4)*area.h;
    line(ctx,area.x,gy,area.x+area.w,gy,1*dpr,'#eef2f7');
    const gv=Math.round((i/4)*maxG);
    text(ctx,`${gv}g`,area.x-6*dpr,gy,11*dpr,'#64748b','right');
  }
  // yen目盛
  for(let i=0;i<=4;i++){
    const gy=area.y+area.h-(i/4)*area.h;
    const yv=Math.round((i/4)*maxY);
    text(ctx,`¥${(yv|0).toLocaleString()}`,area.x+area.w+6*dpr,gy,11*dpr,'#64748b','left');
  }

  // 棒
  const step=area.w/data.length;
  const bars=[];
  ctx.fillStyle='#93c5fd';
  data.forEach((d,i)=>{
    const x=area.x+i*step+(step-barW)/2;
    const h=d.g/maxG*area.h;
    const y=area.y+area.h-h;
    roundRect(ctx,x,y,barW,h,3*dpr,'#93c5fd');
    bars.push({i,x,y,w:barW,h,datum:d});
  });

  // 折れ線
  ctx.beginPath(); ctx.lineWidth=2*dpr; ctx.strokeStyle='#34d399';
  data.forEach((d,i)=>{
    const cx=area.x+i*step+step/2;
    const cy=area.y+area.h-(d.yen/maxY)*area.h;
    if(i===0) ctx.moveTo(cx,cy); else ctx.lineTo(cx,cy);
  });
  ctx.stroke();

  // xラベル
  const labelEvery=Math.ceil(data.length/6);
  data.forEach((d,i)=>{
    if(i%labelEvery!==0 && i!==data.length-1) return;
    let s=currentRange==='30d'
      ? `${String(d.date.getMonth()+1)}/${String(d.date.getDate())}`
      : d.ym.replace('-','/');
    text(ctx,s,area.x+i*step+step/2,area.y+area.h+12*dpr,11*dpr,'#64748b','center');
  });

  chart._bars=bars;
}

/* グラフクリックでキャラ切替 */
chart.addEventListener('click',(ev)=>{
  if(!chart._bars) return;
  const rect=chart.getBoundingClientRect(); const dpr=window.devicePixelRatio||1;
  const x=(ev.clientX-rect.left)*dpr; const y=(ev.clientY-rect.top)*dpr;
  const hit=chart._bars.find(b=>x>=b.x&&x<=b.x+b.w&&y>=b.y&&y<=b.y+b.h);
  if(!hit) return;
  if(currentRange==='30d'){ setMascotByDay(hit.datum); }
  else{ setMascotByMonth(hit.datum.year, hit.datum.month); }
});

/* データ更新イベント */
window.addEventListener('data:updated',(e)=>{
  lastPayload=e.detail||{daily:[],monthly:[]};
  drawChart();
  if(currentRange==='30d' && lastPayload.daily.length){
    setMascotByDay(lastPayload.daily[lastPayload.daily.length-1]);
  }else if(currentRange==='12m' && lastPayload.monthly.length){
    const dm=lastPayload.monthly[lastPayload.monthly.length-1];
    setMascotByMonth(dm.year,dm.month);
  }
});

/* レンジ切替イベント */
window.addEventListener('ui:rangeChange',(e)=>{
  currentRange=e.detail.range||'30d'; drawChart();
});

/* ゆるキャラ描画関数（簡易版） */
function drawMascot(textLine){
  layoutCanvases();
  const W=mascCanvas.width, H=mascCanvas.height, dpr=window.devicePixelRatio||1;
  mctx.clearRect(0,0,W,H);
  mctx.fillStyle='#e6f3ff'; mctx.fillRect(0,0,W,H);
  const cx=W/2, cy=H/2;
  // 本体
  mctx.fillStyle='#fff7ea'; mctx.beginPath(); mctx.arc(cx,cy,34*dpr,0,Math.PI*2); mctx.fill();
  mctx.fillStyle='#333'; mctx.beginPath(); mctx.arc(cx-10*dpr,cy-6*dpr,3*dpr,0,Math.PI*2); mctx.fill();
  mctx.beginPath(); mctx.arc(cx+10*dpr,cy-6*dpr,3*dpr,0,Math.PI*2); mctx.fill();
  // 口
  mctx.strokeStyle='#ef4444'; mctx.beginPath(); mctx.arc(cx,cy+6*dpr,6*dpr,0,Math.PI); mctx.stroke();
  // 吹き出し
  if(textLine){
    roundRect(mctx,cx-60*dpr,cy-60*dpr,120*dpr,26*dpr,10*dpr,'#fff','#ccc');
    text(mctx,textLine,cx,cy-47*dpr,12*dpr,'#000','center');
  }
}

/* キャラ制御 */
function setMascotByDay(d){
  let line=''; if(d.g===0) line='休肝日！'; else if(d.g<20) line='ほどほど♪'; else if(d.g<40) line='ほろ酔い～'; else line='飲みすぎ！';
  drawMascot(line);
}
function setMascotByMonth(y,m){
  drawMascot(`${y}/${m+1} のまとめ`);
}

/* 初期 */
layoutCanvases();
drawChart();
</script>


