<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>é…’ãƒ­ã‚°</title>
<style>
:root{
  --bg:#f7f9fc;
  --card:#ffffff;
  --text:#1b2230;
  --muted:#6b7280;
  --accent:#3b82f6;
  --line:#e5e7eb;
  --danger:#e53935;
  --good:#10b981;
  --warn:#f59e0b;
  /* ãƒ†ã‚£ãƒ³ãƒˆï¼ˆé…”ã„ã§èµ¤ã¿ï¼‰ */
  --tint-strength:0;           /* 0ã€œ1 */
  --hue-shift:0deg;            /* 0ã€œ18deg */
  --sat-boost:0%;              /* 0ã€œ18% */
  --light-boost:0%;            /* 0ã€œ4% */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif;
  color:var(--text);
  background:
    linear-gradient(160deg,
      hsl(calc(210 + var(--hue-shift)) 80% calc(98% - var(--light-boost))),
      hsl(calc(220 + var(--hue-shift)) calc(60% + var(--sat-boost)) calc(94% - var(--light-boost)))
    );
  transition:background-color .4s ease, filter .3s ease;
}
.container{max-width:980px; margin:0 auto; padding:20px 12px 80px}
h1{margin:0 0 12px; font-size:22px}
.topRow{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
.tabs{display:flex; gap:6px; background:#edf2ff; padding:4px; border-radius:10px}
.tabBtn{
  border:0; background:transparent; padding:8px 12px; border-radius:8px; cursor:pointer; color:#334155; font-weight:600;
}
.tabBtn[aria-pressed="true"]{background:var(--card); color:var(--text); box-shadow:0 1px 0 rgba(0,0,0,.05)}
.kpi{
  display:grid; gap:8px; grid-template-columns:repeat(4,1fr);
  margin:12px 0;
}
.card{
  background:var(--card); border:1px solid var(--line);
  border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.kpi h3{margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.02em}
.kpi .big{font-size:18px; font-weight:800}
.kpi small{color:var(--muted)}

.progressWrap{display:flex; gap:10px; align-items:center}
.progress{
  position:relative; height:10px; border-radius:999px; background:#eef2ff; overflow:hidden; flex:1;
}
.progress > i{display:block; height:100%; background:linear-gradient(90deg,#60a5fa,#ef4444); width:0%}
.eta{font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px; width:110px; text-align:right}
.editLink{color:var(--accent); font-size:12px; cursor:pointer; margin-left:6px; text-decoration:underline dotted}

.section{margin:12px 0}
.subTabs{display:flex; gap:6px; margin-bottom:8px}
.subTabs .seg{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; border-radius:999px;
  cursor:pointer; color:#334155; font-weight:700;
}
.subTabs .seg[aria-pressed="true"]{background:#e8f0ff; border-color:#c7dbff; color:#1e3a8a}

.tiles{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
@media(min-width:720px){ .tiles{grid-template-columns:repeat(3,minmax(0,1fr));} }
.tile{
  position:relative; display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px;
  cursor:pointer; user-select:none; transition:transform .03s ease, box-shadow .2s ease;
}
.tile:active{transform:scale(.99)}
.tile:hover{box-shadow:0 4px 14px rgba(0,0,0,.05)}
.tile .emoji{font-size:32px; flex-shrink:0; line-height:1}
.tile .info{flex:1}
.tile .name{font-weight:700; font-size:14px}
.tile .meta{font-size:12px; color:var(--muted)}
.badge{
  position:absolute; top:6px; right:6px; background:#e53935; color:#fff; font-weight:800; font-size:14px;
  min-width:26px; height:22px; padding:0 6px; border-radius:999px; display:none; align-items:center; justify-content:center;
  box-shadow:0 2px 4px rgba(0,0,0,.3);
}
.badge[data-show="1"]{display:flex}

.actionsRow{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
.smallBtn{
  background:#fff; border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700;
}
.smallBtn.danger{border-color:#fecaca; color:#b91c1c; background:#fff5f5}
.smallBtn.accent{border-color:#bfdbfe; color:#1d4ed8; background:#eff6ff}

.histHeader{display:flex; align-items:center; gap:8px; justify-content:space-between; margin:4px 0 8px}
.rangeTabs{display:flex; gap:6px}
.rangeTabs button{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; font-weight:800; border-radius:8px; cursor:pointer
}
.rangeTabs button[aria-pressed="true"]{background:#eef6ff; border-color:#c7dbff; color:#1e3a8a}

.histActions{display:flex; gap:6px; align-items:center}

.canvasWrap{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px; overflow:hidden}
#chart{width:100%; height:280px; display:block}
.sumRow{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:8px}
.sumCard h4{margin:0 0 4px; font-size:12px; color:var(--muted)}
.sumCard .big{font-size:18px; font-weight:900}
.comment{font-size:13px; color:#374151; margin-top:4px}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
#calendarPanel{margin-top:10px; padding:12px}
.calLegend{display:flex; gap:8px; align-items:center; font-size:12px; color:#374151; margin:6px 0}
.dot{width:14px; height:14px; border-radius:4px; border:1px solid #e5e7eb}
.grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; margin-top:8px}
.cell{
  position:relative; padding-top:100%; border-radius:8px; border:1px solid var(--line); background:#fff; overflow:hidden; cursor:default
}
.cell small{position:absolute; top:4px; left:6px; font-size:11px; color:#6b7280}
.cell .val{position:absolute; bottom:4px; right:6px; font-size:11px; color:#374151}
.cell[data-empty="1"]{background:transparent; border-color:transparent}

.scene{margin-top:10px; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; height:min(26vh,240px); position:relative}
.scene canvas, .scene svg{width:100%; height:100%; display:block}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modalBack{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px}
.modal{background:var(--card); border-radius:12px; border:1px solid var(--line); width:min(92vw,560px); max-height:88vh; overflow:auto; padding:14px}
.modal h3{margin:0 0 12px}
.formRow{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center; margin:10px 0}
input[type="number"],input[type="time"],input[type="date"],select{
  width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px
}
.range{display:flex; gap:8px; align-items:center}
.modal .footer{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
.btn{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800}
.btn.primary{background:#1d4ed8; color:#fff; border-color:#1d4ed8}
.btn.ghost{background:#eef2ff}
.note{font-size:12px; color:var(--muted)}
hr.sep{border:none; border-top:1px solid var(--line); margin:12px 0}

/* ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ï¼ˆè­¦å‘Šï¼‰ */
.snack{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
  display:none; max-width:92vw; box-shadow:0 8px 20px rgba(0,0,0,.3); font-size:14px
}
.snack[data-show="1"]{display:block}
.snack strong{color:#fff}
.snack .ok{color:#10b981}

/* reduced motion */
@media (prefers-reduced-motion: reduce){
  .tile:active{transform:none}
  .scene *{animation:none !important}
}
</style>
</head>
<body>
  <div class="container">
    <div class="topRow">
      <h1>é…’ãƒ­ã‚°</h1>
      <div class="tabs" role="tablist" aria-label="main tabs">
        <button class="tabBtn" id="tab-input" aria-pressed="true">å…¥åŠ›</button>
        <button class="tabBtn" id="tab-history" aria-pressed="false">å±¥æ­´</button>
      </div>
    </div>

    <!-- KPIï¼ˆå…¥åŠ›ç”»é¢ã‚’ã™ã£ãã‚Šï¼šå¯¾è±¡æ—¥/æ¨™æº–ãƒ‰ãƒªãƒ³ã‚¯/æµ®ã„ãŸãŠé‡‘ã¯éè¡¨ç¤ºï¼‰ -->
    <div class="kpi">
      <div class="card">
        <h3>ç·é‡ï¼ˆLï¼‰</h3>
        <div class="big" id="kpi-liters">0.00</div>
      </div>
      <div class="card">
        <h3>ç´”ã‚¢ãƒ«ï¼ˆgï¼‰</h3>
        <div class="big" id="kpi-grams">0</div>
      </div>
      <div class="card">
        <h3>æ¦‚ç®—é‡‘é¡ï¼ˆå††ï¼‰</h3>
        <div class="big" id="kpi-yen">Â¥0</div>
      </div>
      <div class="card">
        <h3>åˆ†è§£ç‡ <span id="kpi-startLabel" class="editLink" title="èµ·ç‚¹ã‚’ç·¨é›†">èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰</span></h3>
        <div class="progressWrap">
          <div class="progress" aria-label="åˆ†è§£ç‡">
            <i id="decomp-bar" style="width:0%"></i>
          </div>
          <div class="eta" id="decomp-eta">åˆ†è§£æ™‚é–“ --:--</div>
        </div>
      </div>
    </div>

    <!-- å…¥åŠ› -->
    <section id="sec-input" class="section">
      <div class="subTabs" role="tablist" aria-label="mode tabs">
        <button class="seg" id="seg-home" aria-pressed="true">å®¶é£²ã¿</button>
        <button class="seg" id="seg-out" aria-pressed="false">å¤–é£Ÿ</button>
        <button class="smallBtn accent" id="btn-settings">è¨­å®šï¼ˆä½“é‡ãƒ»è€æ€§ï¼‰</button>
      </div>

      <div class="tiles" id="tiles"></div>

      <div class="actionsRow">
        <button class="smallBtn danger" id="btn-clear">æœ¬æ—¥ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
        <div class="note">â€» æœ10:00ã¾ã§ã¯å‰æ—¥ã®è¨˜éŒ²ã‚’ç·¨é›†ã§ãã¾ã™</div>
      </div>
    </section>

    <!-- å±¥æ­´ -->
    <section id="sec-history" class="section" hidden>
      <div class="histHeader">
        <div class="rangeTabs" role="tablist" aria-label="range">
          <button class="rangeBtn" data-range="7d" aria-pressed="false">7d</button>
          <button class="rangeBtn" data-range="30d" aria-pressed="true">30d</button>
          <button class="rangeBtn" data-range="12m" aria-pressed="false">12m</button>
        </div>
        <div class="histActions">
          <button class="smallBtn" id="btn-toggle-calendar">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
          <div class="note" id="rangeLabel">ç›´è¿‘30æ—¥</div>
        </div>
      </div>

      <div class="sumRow">
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆå††ï¼‰</h4>
          <div class="big" id="sum-yen">Â¥0</div>
          <div class="comment" id="comment-money">â€”</div>
        </div>
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆç´”ã‚¢ãƒ«gï¼‰</h4>
          <div class="big" id="sum-g">0 g</div>
          <div class="comment" id="comment-grams">â€”</div>
        </div>
      </div>

      <div class="canvasWrap card" style="margin-top:8px">
        <canvas id="chart" width="1200" height="560"></canvas>
      </div>

      <!-- æ³¥é…”åº¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒˆã‚°ãƒ«è¡¨ç¤ºï¼‰ -->
      <div id="calendarPanel" class="card" hidden>
        <div class="calLegend">
          <span>æ³¥é…”åº¦ï¼š</span>
          <span class="dot" style="background:#e8f1ff"></span>ä½
          <span class="dot" style="background:#93c5fd"></span>ä¸­
          <span class="dot" style="background:#ef4444"></span>é«˜
          <span class="dot" style="background:#111827"></span>ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        </div>
        <div class="grid" id="calendarGrid"></div>
      </div>

      <div class="scene" id="scene">
        <!-- WebGL(Pixi)ã§æç”» -->
      </div>
    </section>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-settings">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="setTitle">
      <h3 id="setTitle">è¨­å®šï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h3>

      <div class="formRow">
        <label for="in-weight">ä½“é‡ï¼ˆkgï¼‰</label>
        <input type="number" id="in-weight" min="30" max="150" step="0.5" placeholder="ä¾‹: 70">
      </div>
      <div class="formRow">
        <label>åˆ†å¸ƒä¿‚æ•° rï¼ˆL/kgï¼‰</label>
        <select id="sel-r">
          <option value="0.70">å¹³å‡ï¼ˆ0.70ï¼‰</option>
          <option value="0.71">ç”·æ€§ã®ç›®å®‰ï¼ˆ0.71ï¼‰</option>
          <option value="0.58">å¥³æ€§ã®ç›®å®‰ï¼ˆ0.58ï¼‰</option>
        </select>
      </div>
      <div class="formRow">
        <label>Î²ï¼ˆg/L/æ™‚ï¼‰</label>
        <div class="range">
          <input type="range" id="in-beta" min="0.10" max="0.20" step="0.01">
          <div id="betaLabel" class="note">0.15</div>
        </div>
      </div>
      <div class="formRow">
        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«è€æ€§</label>
        <div>
          <label><input type="radio" name="tol" value="weak">å¼±ã„</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="normal" checked>æ™®é€š</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="strong">å¼·ã„</label>
        </div>
      </div>
      <details>
        <summary>è‡ªå·±è¨ºæ–­ã§æ±ºã‚ã‚‹ï¼ˆä»»æ„ï¼‰</summary>
        <div class="note">æ•°å•ã«ç­”ãˆã¦è€æ€§ä¿‚æ•°ã‚’è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚</div>
        <div style="margin-top:8px">
          <div class="formRow">
            <label>1) ã»ã‚é…”ã„ã¾ã§</label>
            <select class="q" data-w="0"><option value="0">1æ¯</option><option value="1">2æ¯</option><option value="2">3æ¯ä»¥ä¸Š</option></select>
          </div>
          <div class="formRow">
            <label>2) é¡”ã®èµ¤ã¿</label>
            <select class="q" data-w="0"><option value="0">ã™ãå‡ºã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼å‡ºãªã„</option></select>
          </div>
          <div class="formRow">
            <label>3) ç¿Œæœä¸èª¿</label>
            <select class="q" data-w="0"><option value="0">ã‚ˆãã‚ã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼ãªã„</option></select>
          </div>
          <div class="formRow">
            <label>4) é£²é…’é »åº¦</label>
            <select class="q" data-w="0"><option value="0">é€±1ä»¥ä¸‹</option><option value="1">é€±2â€“4</option><option value="2">ã»ã¼æ¯æ—¥</option></select>
          </div>
          <button class="btn ghost" id="btn-self">è‡ªå·±è¨ºæ–­ã‚’åæ˜ </button>
          <div class="note" id="selfNote"></div>
        </div>
      </details>

      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-settings">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-settings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- èµ·ç‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-start">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <h3 id="startTitle">åˆ†è§£ã®èµ·ç‚¹æ™‚åˆ»</h3>
      <div class="formRow">
        <label>ãƒ¢ãƒ¼ãƒ‰</label>
        <div>
          <label><input type="radio" name="startMode" value="auto" checked>è‡ªå‹•ï¼ˆæœ€çµ‚ç™»éŒ²ï¼‰</label>
          <label style="margin-left:14px"><input type="radio" name="startMode" value="manual">æ‰‹å‹•</label>
        </div>
      </div>
      <div id="manualArea">
        <div class="formRow">
          <label>å¯¾è±¡æ—¥</label>
          <input type="date" id="in-start-date">
        </div>
        <div class="formRow">
          <label>æ™‚åˆ»</label>
          <input type="time" id="in-start-time" step="60">
        </div>
        <div class="note">â€» å¤§ããå®Ÿæ…‹ã¨ã‚ºãƒ¬ã‚‹ã¨æ¨å®šãŒä¸æ­£ç¢ºã«ãªã‚Šã¾ã™ã€‚</div>
      </div>
      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-start">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-start">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ -->
  <div class="snack" id="snack"></div>

  <!-- â€» JS ã¨ Pixi ã®èª­ã¿è¾¼ã¿ã€ã‚¢ãƒ—ãƒªæœ¬ä½“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ 2/3ãƒ»3/3 ã§ç¶šãã¾ã™ -->
</body>

<!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ Part2ï¼šã“ã®ãƒ–ãƒ­ãƒƒã‚¯ä¸¸ã”ã¨ã‚’ Part1 ã® </body> ç›´å‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼ -->
<!-- Pixi (WebGL) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-filters@5/dist/pixi-filters.min.js"></script>

<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const tz = 'Asia/Tokyo';
const JPY = n => 'Â¥' + Math.round(n).toLocaleString('ja-JP');
const pad = n => String(n).padStart(2,'0');
const todayKey = () => {
  const now = new Date();
  const jst = new Date(now.toLocaleString('en-US', { timeZone: tz }));
  return jst.toISOString().slice(0,10);
};
const ymd = d => d.toISOString().slice(0,10);
const fmtHM = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const ls = {
  get(k,def){ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
function jstDateFromKey(key){ return new Date(key+'T00:00:00+09:00'); }
function jstNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:tz})); }
function addDays(d, n){ const t=new Date(d); t.setDate(t.getDate()+n); return t; }
function startOfMonth(d){ const t = new Date(d); t.setDate(1); t.setHours(0,0,0,0); return t; }
function endOfMonth(d){ const t = new Date(startOfMonth(d)); t.setMonth(t.getMonth()+1); t.setDate(0); t.setHours(23,59,59,999); return t; }

/* ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ========= */
const K_LOGS = 'drink_logs_v1';
const K_PRESETS = 'drink_presets_v1';
const K_PROFILE = 'drink_profile_v1';
const K_META = 'drink_logs_meta_v1';
const K_SETTINGS = 'drink_settings_v1';
const K_RANGE = 'hist_range_v1';

/* ========= çŠ¶æ…‹ ========= */
let logs = ls.get(K_LOGS, {});          // { 'YYYY-MM-DD': [ {id, ml, abv, price, count, ts}, ... ] }
let presets = ls.get(K_PRESETS, null);
let profile = ls.get(K_PROFILE, { weightKg: 70, beta: 0.15, r:0.70, tol:'normal', tol_mult:1.0 });
let meta = ls.get(K_META, {});           // { 'YYYY-MM-DD': { decompMode:'auto'|'manual', decompStartTs:number } }
let settings = ls.get(K_SETTINGS, { cutoffHour:10, monthlyBudget:12000, compareBasis:'WHO' });
let histRange = ls.get(K_RANGE, '30d');

/* ========= ãƒ—ãƒªã‚»ãƒƒãƒˆ ========= */
if(!presets){
  presets = {
    home: [
      {id:'beer350', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«350ml', ml:350, abv:5, price:220},
      {id:'beer500', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«500ml', ml:500, abv:5, price:290},
      {id:'happ350', emoji:'ğŸ»', name:'ç™ºæ³¡é…’350ml', ml:350, abv:5, price:170},
      {id:'happ500', emoji:'ğŸ»', name:'ç™ºæ³¡é…’500ml', ml:500, abv:5, price:210},
      {id:'chu350', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:160},
      {id:'chu500', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤500ml', ml:500, abv:7, price:200},
      {id:'hb350',  emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«ç¼¶350ml', ml:350, abv:7, price:170},
      {id:'sake180',emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:220},
      {id:'wine120',emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:200},
      {id:'shaox',  emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:180},
      {id:'sho_rock', emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90, abv:25, price:120},
      {id:'sho_mizu', emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120, abv:20, price:120},
    ],
    out: [
      {id:'nama500', emoji:'ğŸº', name:'ç”Ÿä¸­500ml', ml:500, abv:5, price:600},
      {id:'chu350o', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:450},
      {id:'hball300',emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«300ml', ml:300, abv:7, price:480},
      {id:'sake180o',emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:580},
      {id:'wine120o',emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:650},
      {id:'shaoxo',  emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:520},
      {id:'sho_roko',emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90, abv:25, price:550},
      {id:'sho_mizuo',emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120, abv:20, price:520},
    ]
  };
  ls.set(K_PRESETS, presets);
}

/* ========= 10:00ç· åˆ‡ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ ========= */
function activeInputKey(){
  const now = jstNow();
  const hour = now.getHours();
  if(hour < settings.cutoffHour){
    const yest = addDays(jstDateFromKey(todayKey()), -1);
    return ymd(yest);
  }
  return todayKey();
}

/* ========= ãƒ­ã‚°æ“ä½œ ========= */
function addOne(preset){
  const key = activeInputKey();
  logs[key] = logs[key] || [];
  const ts = jstNow().getTime();
  logs[key].push({ ...preset, count:1, ts });
  ls.set(K_LOGS, logs);
  // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãªã‚‰èµ·ç‚¹ï¼æœ€çµ‚ç™»éŒ²ã¸ï¼ˆæ‰‹å‹•æ™‚ã¯ç¶­æŒï¼‰
  const m = meta[key];
  if(!m || m.decompMode !== 'manual'){
    meta[key] = { decompMode:'auto' };
    ls.set(K_META, meta);
  }
  renderAll();
}
function removeOne(id){
  const key = activeInputKey();
  const arr = logs[key] || [];
  const idx = arr.length-1 - arr.slice().reverse().findIndex(v=>v.id===id);
  if(idx>=0 && idx<arr.length){
    arr.splice(idx,1);
    if(arr.length===0) delete logs[key];
    ls.set(K_LOGS, logs);
    renderAll();
  }
}
function clearActiveDay(){
  const key = activeInputKey();
  delete logs[key];
  // åˆ†è§£èµ·ç‚¹ãƒ¡ã‚¿ã‚‚æ¶ˆã™
  delete meta[key];
  ls.set(K_LOGS, logs);
  ls.set(K_META, meta);
  // è¦‹ãŸç›®ã‚’å³ãƒªã‚»ãƒƒãƒˆ
  applyIntoxTint(0);
  renderAll();
}

/* ========= é›†è¨ˆ ========= */
function sumDay(key){
  const arr = logs[key] || [];
  let ml=0, g=0, yen=0, lastTs=0;
  for(const it of arr){
    ml += it.ml;
    g  += it.ml * (it.abv/100) * 0.8; // ç´”ã‚¢ãƒ«
    yen+= it.price;
    lastTs = Math.max(lastTs, it.ts||0);
  }
  return { ml, g, yen, lastTs, count:arr.length, items:arr };
}
function sumMonth(key){ // key: YYYY-MM (JST)
  const res = { g:0, yen:0 };
  for(const k in logs){
    if(k.startsWith(key)){
      const s = sumDay(k);
      res.g += s.g; res.yen += s.yen;
    }
  }
  return res;
}

/* ========= åˆ†è§£ãƒ¢ãƒ‡ãƒ« ========= */
function toleranceMult(){ // å¼±:0.85/æ™®:1.00/å¼·:1.15
  if(profile.tol==='weak') return 0.85;
  if(profile.tol==='strong') return 1.15;
  return profile.tol_mult || 1.0;
}
function rateGph(){ // g / hour
  return (profile.beta||0.15) * (profile.r||0.70) * (profile.weightKg||70) * toleranceMult();
}

/* ========= åˆ†è§£å¯¾è±¡æ—¥ãƒ»èµ·ç‚¹ ========= */
function resolveDecompTargetDay(){
  const t = todayKey();
  const y = ymd(addDays(jstDateFromKey(t), -1));
  if(logs[y]) return y;
  if(logs[t]) return t;
  return null;
}
function resolveStartTs(dayKey){
  if(!dayKey) return null;
  const m = meta[dayKey];
  if(m && m.decompMode==='manual' && m.decompStartTs) return m.decompStartTs;
  // è‡ªå‹•ï¼æœ€çµ‚ç™»éŒ²ï¼‹60åˆ†ï¼ˆå¸åãƒ‡ã‚£ãƒ¬ã‚¤ã‚’åæ˜ ï¼‰
  const { lastTs } = sumDay(dayKey);
  if(!lastTs) return null;
  return lastTs + 60*60*1000;
}

/* ========= æ®‹é‡ãƒ»é€²æ— ========= */
function computeRemain(){
  const key = resolveDecompTargetDay();
  if(!key) return { total_g:0, remain_g:0, progress:0, eta:null, startTs:null, dayKey:null };
  const { g:total_g } = sumDay(key);
  const startTs = resolveStartTs(key);
  if(!startTs) return { total_g, remain_g:0, progress:0, eta:null, startTs:null, dayKey:key };
  const now = jstNow().getTime();
  const elapsed_h = Math.max(0, (now - startTs)/3600000);
  const speed = rateGph();
  const remain_g = Math.max(0, total_g - speed * elapsed_h);
  const need_h = total_g / speed;
  const done = clamp(elapsed_h / need_h, 0, 1);
  const eta = new Date(startTs + need_h*3600000);
  return { total_g, remain_g, progress:Math.round(done*100), eta, startTs, dayKey:key };
}

/* ========= ãƒ†ã‚£ãƒ³ãƒˆï¼ˆèµ¤ã¿ï¼‰ ========= */
function applyIntoxTint(remain_g){
  const G_SCALE = 60; // 60gã§æœ€å¤§å¯„ã›
  let s = clamp(remain_g / G_SCALE, 0, 1);
  s = Math.pow(s, 0.8);
  const hue = 18 * s, sat = 18*s, light = 4*s;
  document.documentElement.style.setProperty('--tint-strength', s.toFixed(3));
  document.documentElement.style.setProperty('--hue-shift', hue+'deg');
  document.documentElement.style.setProperty('--sat-boost', sat+'%');
  document.documentElement.style.setProperty('--light-boost', light+'%');
}

/* ========= ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ« ========= */
const elTiles = document.getElementById('tiles');
const segHome = document.getElementById('seg-home');
const segOut = document.getElementById('seg-out');
let mode = 'home';

function renderPresetTiles(){
  elTiles.innerHTML = '';
  const list = presets[mode];
  const key = activeInputKey();
  const cnts = {};
  (logs[key]||[]).forEach(it => { cnts[it.id] = (cnts[it.id]||0)+1; });
  for(const p of list){
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.id = p.id;
    tile.innerHTML = `
      <div class="emoji">${p.emoji}</div>
      <div class="info">
        <div class="name">${p.name}</div>
        <div class="meta">${p.ml}ml / ${p.abv}% ãƒ» ç´„${JPY(p.price)}</div>
      </div>
      <div class="badge" ${cnts[p.id]? 'data-show="1"':''}>${cnts[p.id] ? (cnts[p.id]>99?'99+':cnts[p.id]) : ''}</div>
    `;
    tile.addEventListener('click', (e)=> { if(e.target.classList.contains('badge')) return; addOne(p); });
    tile.querySelector('.badge').addEventListener('click', (e)=>{ e.stopPropagation(); removeOne(p.id); });
    elTiles.appendChild(tile);
  }
}

/* ========= KPIæç”» ========= */
function renderKPI(){
  const key = activeInputKey();
  const s = sumDay(key);
  document.getElementById('kpi-liters').textContent = (s.ml/1000).toFixed(2);
  document.getElementById('kpi-grams').textContent = Math.round(s.g);
  document.getElementById('kpi-yen').textContent = JPY(s.yen);

  // åˆ†è§£
  const d = computeRemain();
  document.getElementById('decomp-bar').style.width = d.progress + '%';
  document.getElementById('decomp-eta').textContent = d.eta? ('åˆ†è§£æ™‚é–“ ' + fmtHM(d.eta)) : 'åˆ†è§£æ™‚é–“ --:--';

  // èµ·ç‚¹ãƒ©ãƒ™ãƒ«ã¯ã€Œæ‰‹å‹•ãªã‚‰æ‰‹å‹•ã€ã€Œè‡ªå‹•ã¯æœ€çµ‚ç™»éŒ²+60åˆ†ï¼ˆå®ŸåŠ¹ï¼‰ã€ã‚’è¡¨ç¤º
  let startLbl = 'èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰';
  if(d.dayKey){
    const m = meta[d.dayKey];
    const effTs = (m && m.decompMode==='manual' && m.decompStartTs)
      ? m.decompStartTs
      : resolveStartTs(d.dayKey);
    if(m && m.decompMode==='manual' && m.decompStartTs){
      startLbl = `èµ·ç‚¹: ${fmtHM(new Date(m.decompStartTs))}ï¼ˆæ‰‹å‹•ï¼‰`;
    }else{
      startLbl = `èµ·ç‚¹: ${effTs ? fmtHM(new Date(effTs)) : '--:--'}ï¼ˆè‡ªå‹•ï¼‰`;
    }
  }
  document.getElementById('kpi-startLabel').textContent = startLbl;

  // ãƒ†ã‚£ãƒ³ãƒˆ
  applyIntoxTint(d.remain_g);
}

/* ========= å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ========= */
function buildHistory(){
  // daily 7 / 30
  function daily(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const d = addDays(jstDateFromKey(todayKey()), -i);
      const k = ymd(d);
      const s = sumDay(k);
      arr.push({ date:d, key:k, g: s.g||0, yen: s.yen||0 });
    }
    return arr;
  }
  // monthly 12
  function monthly(n){
    const arr=[];
    let d = startOfMonth(jstNow());
    for(let i=n-1;i>=0;i--){
      const m = new Date(d); m.setMonth(m.getMonth()-i);
      const ym = m.toISOString().slice(0,7);
      const s = sumMonth(ym);
      arr.push({ date:m, ym, g:s.g||0, yen:s.yen||0 });
    }
    return arr;
  }
  return {
    daily7: daily(7),
    daily30: daily(30),
    monthly12: monthly(12)
  };
}

/* ========= ã‚°ãƒ©ãƒ•æç”» ========= */
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
function drawChart(range, data){
  if(!canvas) return;
  // DPI
  const ratio = window.devicePixelRatio||1;
  canvas.width = canvas.clientWidth*ratio;
  canvas.height= canvas.clientHeight*ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  const padL = 46, padR = 46, padT = 18, padB = 38;
  const plotW = W - padL - padR, plotH = H - padT - padB;

  // ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ0å¯¾ç­–ã‚’åšã‚ã«ï¼‰
  const maxG = Math.max(10, Math.ceil((Math.max(0.1, ...data.map(d=>d.g))) *1.3/10)*10);
  const maxY = Math.max(1000, Math.ceil((Math.max(1, ...data.map(d=>d.yen))) *1.3/1000)*1000);

  // è»¸
  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y = padT + plotH - plotH*i/4;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
  }
  // ãƒ©ãƒ™ãƒ«
  ctx.fillStyle='#6b7280'; ctx.font='12px system-ui, sans-serif';
  ctx.fillText(`${maxG} g`, 4, padT+8);
  const rLabel = `${(maxY/1000)}k Â¥`;
  ctx.fillText(rLabel, W- padR + 8, padT+8);

  // æ£’ï¼ˆgï¼‰
  const n = data.length;
  const gap = 6;
  const bw = Math.max(6, Math.floor((plotW - gap*(n-1))/n));
  ctx.fillStyle = '#60a5fa';
  data.forEach((d, i)=>{
    const x = padL + i*(bw+gap);
    const h = Math.round((d.g / maxG) * plotH);
    ctx.fillRect(x, padT + plotH - h, bw, h);
  });

  // æŠ˜ã‚Œç·šï¼ˆÂ¥ï¼‰
  ctx.strokeStyle='#ef4444'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    const y = padT + plotH - (d.yen / maxY) * plotH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle='#ef4444';
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    const y = padT + plotH - (d.yen / maxY) * plotH;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  // Xãƒ©ãƒ™ãƒ«
  ctx.fillStyle='#6b7280'; ctx.textAlign='center'; ctx.font='11px system-ui, sans-serif';
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    let lbl='';
    if(range==='12m'){
      const m = d.date.getMonth()+1; lbl = `${m}æœˆ`;
    }else{
      const m = d.date.getMonth()+1, day=d.date.getDate();
      lbl = `${m}/${day}`;
    }
    ctx.fillText(lbl, x, H-18);
  });
}

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ³¥é…”åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰ ========= */
function stageFromTotalG(g){
  // ã‚¶ãƒƒã‚¯ãƒªé–¾å€¤ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¯åˆ¥æ‰±ã„ï¼‰
  if(g<=20) return 0;        // ä½
  if(g<=60) return 1;        // ä¸­
  if(g<=120) return 2;       // é«˜
  return 3;                  // ã¨ã¦ã‚‚é«˜ã„ï¼ˆâ‰’ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå¯„ã‚Šï¼‰
}
function colorForStage(s){
  return ['#e8f1ff','#93c5fd','#ef4444','#111827'][s] || '#e8f1ff';
}
function renderCalendar(){
  const panel = document.getElementById('calendarPanel');
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML='';
  // å½“æœˆï¼ˆ1æ—¥ã‹ã‚‰æœ«æ—¥ï¼‰
  const now = jstNow();
  const first = startOfMonth(now);
  const last = endOfMonth(now);
  const startW = first.getDay(); // 0:æ—¥
  // å‰ã®ç©ºç™½
  for(let i=0;i<startW;i++){
    const c=document.createElement('div'); c.className='cell'; c.dataset.empty='1'; grid.appendChild(c);
  }
  // æ—¥ä»˜
  for(let d=1; d<= last.getDate(); d++){
    const key = first.toISOString().slice(0,7)+'-'+pad(d);
    const s = sumDay(key);
    const st = stageFromTotalG(s.g||0);
    const c = document.createElement('div');
    c.className='cell';
    c.style.background = colorForStage(st);
    c.innerHTML = `<small>${d}</small><div class="val">${s.g? Math.round(s.g): ''}</div>`;
    grid.appendChild(c);
  }
}

/* ========= ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šèµ·ç‚¹ ========= */
function getDecompEditDay(){
  return resolveDecompTargetDay() || activeInputKey();
}
function openStartModal(){
  const m = document.getElementById('modal-start');
  const day = getDecompEditDay();
  const md = (day && meta[day]) ? meta[day] : { decompMode:'auto' };
  document.querySelectorAll('input[name="startMode"]').forEach(r=> r.checked = (r.value === (md.decompMode||'auto')));
  document.getElementById('in-start-date').value = day || todayKey();
  const effTs = (md.decompMode==='manual' && md.decompStartTs) ? md.decompStartTs : (day ? resolveStartTs(day) : null);
  const t = effTs ? new Date(effTs) : jstNow();
  document.getElementById('in-start-time').value = `${pad(t.getHours())}:${pad(t.getMinutes())}`;
  document.getElementById('modal-start').style.display='flex';
}
function closeStartModal(){ document.getElementById('modal-start').style.display='none'; }
function saveStartModal(){
  const day = document.getElementById('in-start-date').value || getDecompEditDay();
  if(!day){ closeStartModal(); return; }
  const mode = document.querySelector('input[name="startMode"]:checked').value;
  if(mode==='auto'){
    meta[day] = { decompMode:'auto' };
  }else{
    const t = document.getElementById('in-start-time').value || '00:00';
    const ts = new Date(`${day}T${t}:00+09:00`).getTime();
    meta[day] = { decompMode:'manual', decompStartTs: ts };
  }
  ls.set(K_META, meta);
  closeStartModal();
  renderKPI(); drawScene();
}

/* ========= ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¨­å®š ========= */
function openSettings(){
  const m = document.getElementById('modal-settings');
  document.getElementById('in-weight').value = profile.weightKg||70;
  document.getElementById('sel-r').value = String(profile.r||0.70);
  document.getElementById('in-beta').value = profile.beta||0.15;
  document.getElementById('betaLabel').textContent = (profile.beta||0.15).toFixed(2);
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked = (r.value === (profile.tol||'normal')));
  m.style.display='flex';
}
document.getElementById('in-beta').addEventListener('input', (e)=> document.getElementById('betaLabel').textContent = Number(e.target.value).toFixed(2));
function closeSettings(){ document.getElementById('modal-settings').style.display='none'; }
function saveSettings(){
  const w = parseFloat(document.getElementById('in-weight').value)||70;
  const r = parseFloat(document.getElementById('sel-r').value)||0.70;
  const b = parseFloat(document.getElementById('in-beta').value)||0.15;
  const tol = document.querySelector('input[name="tol"]:checked').value;
  profile.weightKg = clamp(w, 30, 150);
  profile.r = r; profile.beta = clamp(b,0.10,0.20); profile.tol = tol;
  ls.set(K_PROFILE, profile);
  closeSettings();
  renderAll();
}

/* ========= å±¥æ­´ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========= */
function renderSummaryCards(range, data){
  let sumY=0, sumG=0;
  data.forEach(d=>{ sumY+=d.yen; sumG+=d.g; });
  document.getElementById('sum-yen').textContent = JPY(sumY);
  document.getElementById('sum-g').textContent = `${Math.round(sumG)} g`;

  // é‡‘é¡ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè»½ã„æ›ç®—ï¼‰
  const moneyIdeas = [
    {name:'ã‚³ãƒ¼ãƒ’ãƒ¼', price:150, icon:'â˜•'},
    {name:'ãŠã«ãã‚Š', price:140, icon:'ğŸ™'},
    {name:'ç‰›ä¸¼', price:500, icon:'ğŸš'},
    {name:'æ˜ ç”»', price:1900, icon:'ğŸ¬'},
    {name:'ã‚µã‚¦ãƒŠ', price:1200, icon:'â™¨ï¸'},
    {name:'éŸ³æ¥½ã‚µãƒ–ã‚¹ã‚¯(æœˆ)', price:980, icon:'ğŸ§'},
    {name:'éƒ½å†…ç‰‡é“', price:200, icon:'ğŸšƒ'}
  ];
  const pick = moneyIdeas[Math.floor(Math.random()*moneyIdeas.length)];
  const n = Math.floor(sumY / pick.price);
  document.getElementById('comment-money').textContent = n>0 ? `${pick.icon} ${pick.name} ${n} å›ã¶ã‚“` : 'â€”';

  // æ‘‚å–é‡ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆåŸºæº–ã¯è»½ã‚ã®æ–‡è¨€ï¼‰
  const basis = settings.compareBasis || 'WHO';
  const now = jstNow();
  const wkStart = addDays(now, -6);
  const weekG = buildHistory().daily7.reduce((a,b)=>a+b.g,0);
  const days = (range==='7d'?7 : range==='30d'?30 : 30);
  const avgDay = sumG / days;
  let gramsMsg='â€”';
  if(basis==='WHO'){
    gramsMsg = `åˆè¨ˆ ${Math.round(sumG)}gã€‚æ°´åˆ†ãƒ»ç¡çœ ã‚’æ„è­˜ã—ã¦æ•´ãˆã¾ã—ã‚‡ã†ã€‚`;
  }else if(basis==='JP'){
    const mult = (avgDay/20).toFixed(2);
    gramsMsg = `1æ—¥å¹³å‡ ${avgDay.toFixed(1)}gï¼ˆç›®å®‰20g/æ—¥ã® ${mult} å€ï¼‰ã€‚`;
  }else if(basis==='UK'){
    const mult = (weekG/112).toFixed(2);
    gramsMsg = `ä»Šé€± ${Math.round(weekG)}gï¼ˆUKä½ãƒªã‚¹ã‚¯112g/é€±ã® ${mult} å€ï¼‰ã€‚`;
  }else if(basis==='US'){
    const drinksDay = (avgDay/14).toFixed(2);
    gramsMsg = `å¹³å‡ ${drinksDay} ç±³å›½æ¯/æ—¥ï¼ˆ14g/æ¯ï¼‰ã€‚`;
  }
  document.getElementById('comment-grams').textContent = gramsMsg;
}
function renderHistory(){
  const payload = buildHistory();
  const range = histRange||'30d';
  const ds = range==='7d'? payload.daily7 : range==='30d'? payload.daily30 : payload.monthly12;
  drawChart(range, ds);
  renderSummaryCards(range, ds);
  document.getElementById('rangeLabel').textContent = range==='7d'?'ç›´è¿‘7æ—¥': range==='30d'?'ç›´è¿‘30æ—¥':'éå»12ã‹æœˆ';
  drawScene(); // ã‚·ãƒ¼ãƒ³ã‚‚æ›´æ–°
}

/* ========= ã‚·ãƒ¼ãƒ³ï¼ˆPixiï¼‰ï¼šPart3ã§æœ¬å®Ÿè£…ã€‚ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ ========= */
let __pixiApp = null;
function drawScene(){
  // Part3 ã§å·®ã—æ›¿ãˆã€‚ã“ã“ã¯ no-op ã§å®‰å…¨ã«ã—ã¦ãŠã
  const host = document.getElementById('scene');
  host.innerHTML = '';
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById('tab-input').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','true');
  document.getElementById('tab-history').setAttribute('aria-pressed','false');
  document.getElementById('sec-input').hidden=false;
  document.getElementById('sec-history').hidden=true;
  drawScene();
});
document.getElementById('tab-history').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','false');
  document.getElementById('tab-history').setAttribute('aria-pressed','true');
  document.getElementById('sec-input').hidden=true;
  document.getElementById('sec-history').hidden=false;
  renderHistory();
});
segHome.addEventListener('click', ()=>{ segHome.setAttribute('aria-pressed','true'); segOut.setAttribute('aria-pressed','false'); mode='home'; renderPresetTiles(); });
segOut.addEventListener('click', ()=>{ segOut.setAttribute('aria-pressed','true'); segHome.setAttribute('aria-pressed','false'); mode='out'; renderPresetTiles(); });

document.getElementById('btn-clear').addEventListener('click', ()=>{ if(confirm('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ã®å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) clearActiveDay(); });
document.getElementById('btn-settings').addEventListener('click', openSettings);
document.getElementById('btn-close-settings').addEventListener('click', closeSettings);
document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
document.getElementById('btn-self').addEventListener('click', (e)=>{
  const qs = [...document.querySelectorAll('#modal-settings select.q')];
  const score = qs.reduce((a,s)=> a + Number(s.value), 0);
  let tol='normal', mult=1.0, msg='';
  if(score <=5){ tol='weak'; mult=0.85; msg='è€æ€§ã€Œå¼±ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=0.85ï¼‰'; }
  else if(score <=9){ tol='normal'; mult=1.0; msg='è€æ€§ã€Œæ™®é€šã€ã‚’æ¨å¥¨ï¼ˆtol=1.0ï¼‰'; }
  else { tol='strong'; mult=1.15; msg='è€æ€§ã€Œå¼·ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=1.15ï¼‰'; }
  profile.tol = tol; profile.tol_mult = mult;
  document.getElementById('selfNote').textContent = msg;
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked = (r.value === tol));
});

document.getElementById('kpi-startLabel').addEventListener('click', openStartModal);
document.getElementById('btn-close-start').addEventListener('click', closeStartModal);
document.getElementById('btn-save-start').addEventListener('click', saveStartModal);

// å±¥æ­´ãƒ¬ãƒ³ã‚¸
document.querySelectorAll('.rangeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.rangeBtn').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    histRange = btn.dataset.range; ls.set(K_RANGE, histRange);
    renderHistory();
  });
});

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ‡æ›¿
document.getElementById('btn-toggle-calendar').addEventListener('click', ()=>{
  const p = document.getElementById('calendarPanel');
  const isHidden = p.hasAttribute('hidden');
  if(isHidden){ p.removeAttribute('hidden'); renderCalendar(); }
  else{ p.setAttribute('hidden',''); }
});

/* ========= ãƒ«ãƒ¼ãƒˆ ========= */
function renderAll(){
  renderPresetTiles();
  renderKPI();
  if(document.getElementById('sec-history').hidden===false){
    renderHistory();
  }else{
    drawScene();
  }
}
window.addEventListener('load', ()=>{
  document.querySelectorAll('.rangeBtn').forEach(b=> b.setAttribute('aria-pressed', String(b.dataset.range===histRange)));
  if(!profile.weightKg) profile.weightKg = 70;
  if(!profile.beta) profile.beta = 0.15;
  if(!profile.r) profile.r = 0.70;
  renderAll();
  setInterval(()=>{ renderKPI(); drawScene(); }, 60*1000);
});
</script>
<!-- â–²â–²â–² ã“ã“ã¾ã§ Part2 â–¼ è²¼ã‚Šä»˜ã‘ä½ç½®ã¯ Part1 ã® </body> ç›´å‰ â–²â–²â–² -->

<!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ Part3ï¼šPart2 ã®ç›´å¾Œï¼ˆ</body>ã®ç›´å‰ï¼‰ã«è²¼ã‚Šä»˜ã‘ â–¼â–¼â–¼ -->
<script>
// === è¡Œå‹•ãƒ©ãƒ³ãƒ€ãƒ ç”¨ãƒ˜ãƒ«ãƒ‘ï¼ˆã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ Part3 å†…ã ã‘ã§å®Œçµï¼‰ ===
function makeRng(seedStr){
  let h = 2166136261 >>> 0;
  for(let i=0;i<seedStr.length;i++){ h ^= seedStr.charCodeAt(i); h = Math.imul(h, 16777619); }
  return ()=> ((h = Math.imul(h ^ (h>>>15), 2246822507) ^ Math.imul(h ^ (h>>>13), 3266489909))>>>0) / 4294967296;
}
function pickWeighted(rng, pairs){ // [{v:'read', w:0.4}, ...]
  const s = pairs.reduce((a,p)=>a+p.w,0);
  let r = rng()*s;
  for(const p of pairs){ if((r-=p.w)<=0) return p.v; }
  return pairs.at(-1).v;
}

// ã™ã§ã« Part2 ã§å®£è¨€æ¸ˆã¿: let __pixiApp = null;
// ã“ã“ã§ã¯ã€Œä¸Šæ›¸ãå®Ÿè£…ç‰ˆã€ã® drawScene ã‚’æä¾›ã™ã‚‹
function drawScene(){
  const host = document.getElementById('scene');
  if(!host) return;
  host.innerHTML = '';

  // === BAC ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®šï¼ˆç·©ã‚ï¼š3æ¯ã§è­¦å¯Ÿã«ç›´è¡Œã—ãªã„ï¼‰ ===
  const dayKey = resolveDecompTargetDay();
  const totalG = dayKey ? sumDay(dayKey).g : 0;
  const r = profile.r||0.70, w = profile.weightKg||70;
  const betaEff = (profile.beta||0.15) * (profile.tol==='weak'?0.85:profile.tol==='strong'?1.15:(profile.tol_mult||1));
  const startTs = dayKey ? resolveStartTs(dayKey) : null;
  const now = jstNow().getTime();
  const t_h = (!startTs)? 0 : Math.max(0, (now - startTs)/3600000);
  const bacNow  = Math.max(0, (totalG/(r*w)) - betaEff*t_h) * 0.1;     // g/dL
  const bacPeak = Math.max(bacNow, ((totalG/(r*w)) - betaEff*1) * 0.1); // +1h è¿‘ä¼¼

  function decideStage(x){
    if(x < 0.03) return 'S0';   // ã—ã‚‰ãµï¼ˆè‡ªå®…/é›»è»Šï¼‰
    if(x < 0.05) return 'S1';   // ã»ã‚é…”ã„ï¼ˆå¤– or é›»è»Šï¼‰
    if(x < 0.07) return 'S2';   // å±…é…’å±‹ãƒ»æ¥½ã—ã„
    if(x < 0.10) return 'S3';   // å±…é…’å±‹ãƒ»ã‘ã£ã“ã†é…”ã†ï¼ˆã‚«ãƒ©ã‚ªã‚±OKï¼‰
    if(x < 0.12) return 'S4';   // ç¹è¯è¡—ãƒ»ãµã‚‰ã¤ã
    if(x < 0.16) return 'S5';   // å…¬åœ’ãƒ™ãƒ³ãƒ
    if(x < 0.20) return 'S6';   // å…¬åœ’ãƒ™ãƒ³ãƒï¼ˆãã£ãŸã‚Šï¼‰
    return 'S7';                // è­¦å¯Ÿï¼ˆãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼‰
  }
  const stage = decideStage(Math.max(bacNow, bacPeak));

  // åŒæ—¥Ã—ã‚¹ãƒ†ãƒ¼ã‚¸ã§å®‰å®šã™ã‚‹ RNGï¼ˆã‚·ãƒ¼ãƒ³ãƒ»è¡Œå‹•ã®ãƒ©ãƒ³ãƒ€ãƒ å®‰å®šåŒ–ï¼‰
  const seed = `${dayKey||todayKey()}|${stage}`;
  const rng = makeRng(seed);
  const reduce = window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;

  // æ—¢å­˜ã® Pixi App ã‚’ç ´æ£„ã—ã¦ä½œã‚Šç›´ã—ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
  if(__pixiApp){ __pixiApp.destroy(true, {children:true, texture:true, baseTexture:true}); __pixiApp = null; }

  const app = new PIXI.Application({
    width: host.clientWidth || 800,
    height: host.clientHeight || 240,
    backgroundAlpha: 0,
    antialias: true,
    autoDensity: true,
    resolution: Math.min(window.devicePixelRatio || 1, 1.75),
    powerPreference: 'high-performance'
  });
  host.appendChild(app.view);
  __pixiApp = app;
  const W = app.renderer.width, H = app.renderer.height;

  // === ã‚·ãƒ¼ãƒ³ï¼ˆãƒ™ãƒ¼ã‚¹ï¼‰é¸æŠï¼šS0/S1 ã¯ è‡ªå®…(living) or é›»è»Š(train) ã‚’æ—¥ä»˜ã‚·ãƒ¼ãƒ‰ã§ãƒ©ãƒ³ãƒ€ãƒ 
  let base = 'living';
  if(stage==='S0'){ base = (rng()<0.5)? 'living' : 'train'; }
  else if(stage==='S1'){ base = (rng()<0.625)? 'downtown' : 'train'; }
  else if(stage==='S2'||stage==='S3'){ base = 'izakaya'; }
  else if(stage==='S4'){ base = 'downtown'; }
  else if(stage==='S5'||stage==='S6'){ base = 'park'; }
  else if(stage==='S7'){ base = 'jail'; }

  // === è¡Œå‹•ãƒ©ãƒ³ãƒ€ãƒ ï¼šè‡ªå®…ï¼é›»è»Šã®ã¿é‡ã¿ä»˜ãã§æ±ºå®š
  let action = 'idle';
  if(base==='living'){
    action = pickWeighted(rng, [
      {v:'home_read',    w:0.40}, // ğŸ“–
      {v:'home_phone',   w:0.40}, // ğŸ“±
      {v:'home_stretch', w:0.20}  // ğŸ§˜
    ]);
  }else if(base==='train'){
    action = pickWeighted(rng, [
      {v:'trn_stand_phone', w:0.35},
      {v:'trn_stand_idle',  w:0.25},
      {v:'trn_seat_sleep',  w:0.20},
      {v:'trn_seat_phone',  w:0.15},
      {v:'trn_seat_read',   w:0.05}
    ]);
  }

  // === ãƒ¬ã‚¤ãƒ¤
  const L0 = new PIXI.Container(), L1 = new PIXI.Container(), L2 = new PIXI.Container(), FX = new PIXI.Container();
  app.stage.addChild(L0, L1, L2, FX);

  // === èƒŒæ™¯
  const isNightBase = (base==='downtown'||base==='izakaya'||base==='jail'||base==='train');
  const bgTop = isNightBase ? 0x0c1220 : 0xeaf2ff;
  const bgBottom = isNightBase ? 0x0f172a : 0xdfeaff;

  const skyTop = new PIXI.Sprite(PIXI.Texture.WHITE); skyTop.tint=bgTop; skyTop.width=W; skyTop.height=H*0.6;
  const skyBot = new PIXI.Sprite(PIXI.Texture.WHITE); skyBot.tint=bgBottom; skyBot.width=W; skyBot.height=H*0.4; skyBot.y=H*0.6;
  L0.addChild(skyTop, skyBot);

  if(isNightBase){
    const stars = new PIXI.Graphics(); stars.alpha=0.55;
    const n = 60 + Math.floor(rng()*40);
    for(let i=0;i<n;i++){
      const x=rng()*W, y=rng()*H*0.5, r=rng()*1.2+0.3;
      stars.beginFill(0xffffff).drawCircle(x,y,r).endFill();
    }
    L0.addChild(stars);
  }else{
    const clouds = new PIXI.Graphics(); clouds.alpha=0.25;
    for(let i=0;i<6;i++){
      const x=(i*120)%(W+240)-120, y=30+(i%3)*22;
      clouds.beginFill(0xffffff).drawEllipse(x,y,82,24).endFill();
      clouds.drawEllipse(x+56,y+10,58,18).endFill();
    }
    L0.addChild(clouds);
  }

  // === ãƒ™ãƒ¼ã‚¹ã”ã¨ã®éª¨æ ¼
  let neon=null, windowBands=null, handles=null, tvGlow=null, steam=null, cat=null;

  if(base==='downtown' || base==='jail'){
    const buildings = new PIXI.Container();
    for(let i=0;i<10;i++){
      const g=new PIXI.Graphics();
      const bw=50+(i%3)*16, bh=H*0.35+(i%5)*10, x=(i*100)%(W+200)-100, y=H-bh-44;
      g.beginFill(0x1e293b).drawRect(x,y,bw,bh).endFill();
      for(let r=0;r<5;r++)for(let c=0;c<3;c++){
        if(((i+r+c)%2)===0) g.beginFill((i%2)?0xf59e0b:0x334155).drawRect(x+10+c*14,y+12+r*22,10,14).endFill();
      }
      buildings.addChild(g);
    }
    L1.addChild(buildings);
    if(base==='jail'){
      const wall=new PIXI.Graphics(); wall.beginFill(0x111827).drawRect(60,44,W-120,H-120).endFill();
      const bars=new PIXI.Graphics(); for(let i=0;i<9;i++) bars.beginFill(0x374151).drawRect(100+i*60,44,12,H-120).endFill();
      L1.addChild(wall,bars);
    }
  }

  if(base==='izakaya'){
    const noren = new PIXI.Graphics();
    noren.beginFill(0xf5a524).drawRoundedRect(60,80,W-120,110,8).endFill();
    L1.addChild(noren);
    const lanterns = new PIXI.Container();
    for(let i=0;i<6;i++){
      const x = 120 + i*((W-240)/5);
      const l = new PIXI.Text('ğŸ®',{fontSize:48}); l.anchor.set(0.5); l.x=x; l.y=76 + Math.sin(i)*2;
      lanterns.addChild(l);
    }
    L1.addChild(lanterns);
  }

  if(base==='park'){
    const ground = new PIXI.Graphics();
    ground.beginFill(0x84cc16).drawRect(0,H-48,W,48).endFill();
    L2.addChild(ground);
    const bench = new PIXI.Graphics();
    bench.beginFill(0x9ca3af).drawRoundedRect(140,H-84,180,16,6).endFill();
    bench.beginFill(0x9ca3af).drawRect(150,H-116,20,32).drawRect(290,H-116,20,32).endFill();
    L2.addChild(bench);
  }

  if(base==='living'){
    // å£ã¨åºŠ
    const wall=new PIXI.Graphics(); wall.beginFill(0xf3f4f6).drawRect(0,0,W,H-56).endFill();
    const floor=new PIXI.Graphics(); floor.beginFill(0xe5e7eb).drawRect(0,H-56,W,56).endFill();
    L1.addChild(wall,floor);

    // çª“
    const wx=36, wy=26, ww=Math.min(260,W*0.45), wh=Math.min(110,H*0.42);
    const win=new PIXI.Graphics();
    win.beginFill(0xffffff).drawRoundedRect(wx,wy,ww,wh,8).endFill();
    win.lineStyle(3,0x94a3b8,1).drawRoundedRect(wx,wy,ww,wh,8);
    L1.addChild(win);

    // TVï¼ˆãƒ•ãƒªãƒƒã‚«ãƒ¼ï¼‰
    const tvw=160, tvh=88, tvx=W-200, tvy=H-56-20-tvh;
    const tv=new PIXI.Graphics(); tv.beginFill(0x0b1020).drawRoundedRect(tvx,tvy,tvw,tvh,6).endFill();
    tvGlow=new PIXI.Sprite(PIXI.Texture.WHITE);
    tvGlow.tint=0x60a5fa; tvGlow.alpha=0.12; tvGlow.x=tvx+tvw*0.5; tvGlow.y=tvy+tvh*0.5;
    tvGlow.anchor.set(0.5); tvGlow.width=tvw*1.4; tvGlow.height=tvh*1.4;
    tvGlow.filters=[new PIXI.filters.BlurFilter({strength:10})];
    L2.addChild(tv,tvGlow);

    // ã‚¹ã‚¿ãƒ³ãƒ‰ãƒ©ã‚¤ãƒˆ
    const lampX=ww+wx+24;
    const lampStem=new PIXI.Graphics(); lampStem.beginFill(0x9ca3af).drawRect(lampX, H-56-100, 6, 100).endFill();
    const lampShade=new PIXI.Graphics(); lampShade.beginFill(0xd1d5db).drawPolygon([lampX-24,H-56-100, lampX+24,H-56-100, lampX,H-56-140]).endFill();
    const lampGlow=new PIXI.Sprite(PIXI.Texture.WHITE);
    lampGlow.tint=0xfff3c4; lampGlow.alpha=0.18; lampGlow.x=lampX; lampGlow.y=H-56-120;
    lampGlow.anchor.set(0.5); lampGlow.width=220; lampGlow.height=220; lampGlow.filters=[new PIXI.filters.BlurFilter({strength:18})];
    L2.addChild(lampStem,lampShade,lampGlow);

    // ã‚½ãƒ•ã‚¡ï¼†å°ç‰©
    const sx=80, sy=H-56-46, sw=200, sh=46;
    const sofa=new PIXI.Graphics(); sofa.beginFill(0x94a3b8).drawRoundedRect(sx,sy,sw,sh,10).endFill();
    const cushion=new PIXI.Graphics();
    cushion.beginFill(0xe2e8f0).drawRoundedRect(sx+18,sy+10,64,26,6).endFill();
    cushion.drawRoundedRect(sx+96,sy+10,64,26,6).endFill();
    L2.addChild(sofa,cushion);

    const plant=new PIXI.Text('ğŸŒ¿',{fontSize:28}); plant.x=sx-36; plant.y=H-56-50; L2.addChild(plant);
    const mug=new PIXI.Text('â˜•',{fontSize:26}); mug.x=sx+sw+16; mug.y=H-56-38; L2.addChild(mug);
    steam=new PIXI.Text('â™¨ï¸',{fontSize:20}); steam.x=mug.x+12; steam.y=mug.y-18; steam.alpha=0.7; L2.addChild(steam);

    cat=new PIXI.Text('ğŸˆâ€â¬›',{fontSize:32}); cat.anchor.set(0.5,1); cat.x=sx+sw*0.2; cat.y=sy; L2.addChild(cat);
  }

  if(base==='train'){
    // è»Šå†…
    const body=new PIXI.Graphics(); body.beginFill(0xe5e7eb).drawRect(0,0,W,H).endFill();
    const floor=new PIXI.Graphics(); floor.beginFill(0xd1d5db).drawRect(0,H-42,W,42).endFill();
    L1.addChild(body,floor);

    // é€£ç¶šçª“ï¼†å¤–æ™¯
    windowBands=new PIXI.Container();
    const wh=70, wy=40, ww=110, gap=20;
    for(let i=0;i<6;i++){
      const x=20+i*(ww+gap);
      const frame=new PIXI.Graphics();
      frame.beginFill(0xffffff).drawRoundedRect(x,wy,ww,wh,10).endFill();
      frame.lineStyle(3,0x94a3b8,1).drawRoundedRect(x,wy,ww,wh,10);
      const band=new PIXI.Container(); band.x=x; band.y=wy+4;
      const mask=new PIXI.Graphics(); mask.beginFill(0xffffff).drawRoundedRect(x,wy,ww,wh,10).endFill();
      band.mask=mask; L1.addChild(mask);
      for(let k=0;k<12;k++){
        const g=new PIXI.Graphics();
        const bw=16+(k%3)*6, bh=14+(k%5)*10, gx=(k*28)%(ww+100)-40, gy=wh-8-bh;
        g.beginFill(0x1e293b).drawRect(gx,gy,bw,bh).endFill();
        band.addChild(g);
      }
      windowBands.addChild(band); L1.addChild(frame);
    }
    L1.addChild(windowBands);

    // åŠã‚Šé©
    handles=new PIXI.Container();
    for(let i=0;i<10;i++){
      const x=20+i*(W-40)/9;
      const rope=new PIXI.Graphics();
      rope.lineStyle(3,0x9ca3af,1).moveTo(x,0).lineTo(x,22);
      rope.beginFill(0xffffff).drawCircle(x,32,8).endFill();
      rope.lineStyle(2,0x9ca3af,1).drawCircle(x,32,8);
      handles.addChild(rope);
    }
    L2.addChild(handles);

    // åº§å¸­
    const seat=new PIXI.Graphics();
    seat.beginFill(0x94a3b8).drawRoundedRect(20,H-48,W-40,24,8).endFill();
    L2.addChild(seat);
  }

  // === ä¸»äººå…¬ï¼ˆè¡¨æƒ…ã¯ã‚¹ãƒ†ãƒ¼ã‚¸ã§æ±ºå®šï¼‰
  const faceByStage = { S0:'ğŸ™‚', S1:'ğŸš¶', S2:'ğŸ™‚', S3:'ğŸ˜Œ', S4:'ğŸ¥´', S5:'ğŸ˜µâ€ğŸ’«', S6:'ğŸ¥´', S7:'ğŸ˜µ' };
  const actor = new PIXI.Text(faceByStage[stage]||'ğŸ™‚', {
    fontFamily:'"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui',
    fontSize: Math.min(180, H*0.7),
  });
  actor.anchor.set(0.5,0.95); L2.addChild(actor);

  function placeActor(){
    if(base==='living'){ actor.x=Math.min(W*0.62, W-120); actor.y=H-56; }
    else if(base==='train'){ actor.x=W*0.5; actor.y=H-42; }
    else if(base==='park'){ actor.x=W*0.35; actor.y=H-48; }
    else { actor.x=W*0.2; actor.y=H*0.82; }
  }
  placeActor();

  // ã‚°ãƒ­ãƒ¼
  const glow = new PIXI.Text(actor.text, actor.style);
  glow.anchor.copyFrom(actor.anchor); glow.x=actor.x; glow.y=actor.y;
  glow.alpha = isNightBase?0.35:0.20;
  glow.filters=[new PIXI.filters.BlurFilter({strength:6,quality:3})];
  glow.blendMode = PIXI.BLEND_MODES.SCREEN;
  FX.addChild(glow);

  // ãƒã‚ªãƒ³ï¼ˆå¤œã®å±‹å¤–ï¼‰
  if(base==='izakaya' || base==='downtown'){
    neon = new PIXI.Text(base==='izakaya'?'å±…é…’å±‹':'KARAOKE', {
      fontFamily:'"Montserrat","Noto Sans JP",system-ui',
      fontSize: 24, fill: 0xf43f5e, fontWeight: 900
    });
    neon.anchor.set(0.5); neon.x=W-120; neon.y=90; L2.addChild(neon);
  }

  // ã‚¢ã‚¯ã‚»ã‚µãƒªï¼ˆğŸ“–ğŸ“±ğŸ’¤ğŸ§˜ï¼‰
  const acc = new PIXI.Container(); L2.addChild(acc);
  function addEmoji(txt, size, dx, dy){
    const t = new PIXI.Text(txt,{fontSize:size});
    t.anchor.set(0.5,1); t.x=actor.x+dx; t.y=actor.y+dy; acc.addChild(t); return t;
  }
  let book=null, phone=null, zzz=null, yoga=null;
  if(action==='home_read' || action==='trn_seat_read'){ book = addEmoji('ğŸ“–', 42, -24, -10); }
  if(action.includes('phone')){ phone = addEmoji('ğŸ“±', 38, 24, -18); }
  if(action==='home_stretch'){ yoga = addEmoji('ğŸ§˜', 40, -40, -6); }
  if(action==='trn_seat_sleep'){ zzz = addEmoji('ğŸ’¤', 28, -28, -52); }

  // MotionBlurï¼ˆé«˜ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã¿ï¼‰
  if(!reduce && (['S4','S5','S6'].includes(stage))){
    app.stage.filters = [ new PIXI.filters.MotionBlurFilter([2,0], 0.20) ];
  }

  // === ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€Ÿåº¦ã¯ä¸€å®šã€é…”ã„ï¼ãµã‚‰ã¤ãå¼·åŒ–ï¼‰ ===
  let t=0, px=0, pause=0;
  const swayBy   = {S0:2, S1:3, S2:4, S3:6, S4:8, S5:11, S6:13, S7:0.5};
  const jitterBy = {S0:0.15,S1:0.2,S2:0.35,S3:0.6,S4:0.9,S5:1.3,S6:1.6,S7:0};
  const pauseChance = {S0:0, S1:0, S2:0.02, S3:0.03, S4:0.06, S5:0.10, S6:0.12, S7:0.4}[stage]||0;

  app.ticker.add((delta)=>{
    const dt = delta/60; t+=dt;
    const sway=swayBy[stage]||3, jit=jitterBy[stage]||0.2;

    // å±‹å¤–ã§ãŸã¾ã«ç«‹ã¡æ­¢ã¾ã‚‹
    if(pause>0) pause-=dt; else if(!reduce && (base==='downtown'||base==='izakaya') && Math.random()<pauseChance*dt) pause=0.2+rng()*0.8;

    if(base==='living'){
      actor.x += Math.sin(t*0.4)*0.6;
      actor.y = H-56 + (action==='home_stretch' ? -4*Math.sin(t*1.1) : 0);
      actor.rotation = (Math.sin(t*2.0)*sway + Math.sin(t*9.0)*jit) * Math.PI/180;
      if(tvGlow) tvGlow.alpha = 0.09 + 0.04*Math.max(0, Math.sin(t*6.3+1.2));
      if(steam)  steam.y = (H-74) - Math.sin(t*1.9)*0.8;
      if(cat){ cat.x += Math.sin(t*0.6)*0.7; cat.rotation = Math.sin(t*1.2)*0.08; }
      if(book)  book.rotation = Math.sin(t*2.2)*0.06;
      if(phone) phone.alpha = 0.8 + 0.2*Math.max(0, Math.sin(t*7.0));
    }else if(base==='train'){
      const wob = Math.sin(t*1.8)*2 + Math.sin(t*0.37)*1.2;
      actor.y = (action.startsWith('trn_seat')) ? (H-42 + 0.5*wob) : (H-42 + wob);
      actor.rotation = (Math.sin(t*3.1)*(sway*0.6) + Math.sin(t*11.3)*(jit*0.6)) * Math.PI/180;

      if(windowBands){ for(const band of windowBands.children){ band.x -= dt*40; if(band.x < -140) band.x += 130; } }
      if(handles) handles.y = Math.sin(t*1.5)*1.5;
      if(phone) phone.alpha = 0.85 + 0.15*Math.max(0, Math.sin(t*8.0));
      if(zzz){ zzz.y -= 12*dt; zzz.alpha = 0.9 - ((Math.abs(Math.sin(t*1.2))+0.1)*0.2); if(zzz.y < actor.y-80){ zzz.y = actor.y-52; zzz.alpha=0.9; } }
    }else{
      const walk = (pause>0) ? 0 : 1;
      px += (2.0 * walk);
      const serp = Math.sin(t*2.1)*4 + Math.sin(t*1.3)*2;
      const drift= Math.sin(t*0.25)*18 + Math.sin(t*0.6)*6;
      actor.x = 80 + ((px % (W+220)) - 110) + drift + serp;
      actor.y = H*0.82 + Math.sin(t*1.4)*4 + Math.sin(t*3.0)*2;
      actor.rotation = (Math.sin(t*2.0)*sway + Math.sin(t*9.5)*jit) * Math.PI/180;

      L1.x = - (px * 0.15) % (W*2);
      L2.x = - (px * 0.30) % (W*2);
    }

    if(neon){ const flick=0.85 + 0.15*Math.max(0, Math.sin(t*7.0)); neon.alpha=flick; glow.alpha=0.35+0.15*Math.sin(t*3.3); }
    else { glow.alpha=isNightBase?0.30:0.18; }

    // ã‚¢ã‚¯ã‚»ã‚µãƒªè¿½å¾“
    for(const child of acc.children){ child.x += (actor.x - glow.x); child.y += (actor.y - glow.y); }
    glow.x = actor.x; glow.y = actor.y;
  });

  // ã‚¯ãƒªãƒƒã‚¯ã§è»½ã„ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆå±‹å†…ã¯å°ã•ã‚ï¼‰
  if(!reduce){
    app.stage.eventMode='static'; app.stage.hitArea=app.screen;
    app.stage.on('pointerdown', ()=>{
      actor.vy = (base==='living'||base==='train') ? -5 : -7;
      actor.jt = (base==='living'||base==='train') ? 0.22 : 0.28;
    });
    app.ticker.add((delta)=>{
      const dt=delta/60;
      if(actor.jt>0){
        const baseY = (base==='living')? (H-56) : (base==='train')? (H-42) : (H*0.82);
        actor.vy += 24*dt; actor.y += actor.vy; actor.jt -= dt;
        if(actor.y>baseY){ actor.y=baseY; actor.vy=0; actor.jt=0; }
      }
    });
  }

  // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
  const onResize = ()=> app.renderer.resize(host.clientWidth, host.clientHeight);
  window.addEventListener('resize', onResize, {passive:true});
}
</script>
<!-- â–²â–²â–² ã“ã“ã¾ã§ Part3 â–²â–²â–² -->




</html>
