<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>é…’ãƒ­ã‚°</title>
<style>
:root{
  --bg:#f7f9fc;
  --card:#ffffff;
  --text:#1b2230;
  --muted:#6b7280;
  --accent:#3b82f6;
  --line:#e5e7eb;
  --danger:#e53935;
  --good:#10b981;
  --warn:#f59e0b;
  /* ãƒ†ã‚£ãƒ³ãƒˆï¼ˆé…”ã„ã§èµ¤ã¿ï¼‰ */
  --tint-strength:0;           /* 0ã€œ1 */
  --hue-shift:0deg;            /* 0ã€œ18deg */
  --sat-boost:0%;              /* 0ã€œ18% */
  --light-boost:0%;            /* 0ã€œ4% */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif;
  color:var(--text);
  background:
    linear-gradient(160deg,
      hsl(calc(210 + var(--hue-shift)) 80% calc(98% - var(--light-boost))),
      hsl(calc(220 + var(--hue-shift)) calc(60% + var(--sat-boost)) calc(94% - var(--light-boost)))
    );
  transition:background-color .4s ease, filter .3s ease;
}
.container{max-width:980px; margin:0 auto; padding:20px 12px 80px}
h1{margin:0 0 12px; font-size:22px}
.topRow{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
.tabs{display:flex; gap:6px; background:#edf2ff; padding:4px; border-radius:10px}
.tabBtn{
  border:0; background:transparent; padding:8px 12px; border-radius:8px; cursor:pointer; color:#334155; font-weight:600;
}
.tabBtn[aria-pressed="true"]{background:var(--card); color:var(--text); box-shadow:0 1px 0 rgba(0,0,0,.05)}
.kpi{
  display:grid; gap:8px; grid-template-columns:repeat(4,1fr);
  margin:12px 0;
}
.card{
  background:var(--card); border:1px solid var(--line);
  border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.kpi h3{margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.02em}
.kpi .big{font-size:18px; font-weight:800}
.kpi small{color:var(--muted)}

.progressWrap{display:flex; gap:10px; align-items:center}
.progress{
  position:relative; height:10px; border-radius:999px; background:#eef2ff; overflow:hidden; flex:1;
}
.progress > i{display:block; height:100%; background:linear-gradient(90deg,#60a5fa,#ef4444); width:0%}
.eta{font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px; width:140px; text-align:right}
.editLink{color:var(--accent); font-size:12px; cursor:pointer; margin-left:6px; text-decoration:underline dotted}

.section{margin:12px 0}
.subTabs{display:flex; gap:6px; margin-bottom:8px}
.subTabs .seg{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; border-radius:999px;
  cursor:pointer; color:#334155; font-weight:700;
}
.subTabs .seg[aria-pressed="true"]{background:#e8f0ff; border-color:#c7dbff; color:#1e3a8a}

.tiles{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
@media(min-width:720px){ .tiles{grid-template-columns:repeat(3,minmax(0,1fr));} }
.tile{
  position:relative; display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px;
  cursor:pointer; user-select:none; transition:transform .03s ease, box-shadow .2s ease;
}
.tile:active{transform:scale(.99)}
.tile:hover{box-shadow:0 4px 14px rgba(0,0,0,.05)}
.tile .emoji{font-size:32px; flex-shrink:0; line-height:1}
.tile .info{flex:1}
.tile .name{font-weight:700; font-size:14px}
.tile .meta{font-size:12px; color:var(--muted)}
.badge{
  position:absolute; top:6px; right:6px; background:#e53935; color:#fff; font-weight:800; font-size:14px;
  min-width:26px; height:22px; padding:0 6px; border-radius:999px; display:none; align-items:center; justify-content:center;
  box-shadow:0 2px 4px rgba(0,0,0,.3);
}
.badge[data-show="1"]{display:flex}

.actionsRow{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
.smallBtn{
  background:#fff; border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700;
}
.smallBtn.danger{border-color:#fecaca; color:#b91c1c; background:#fff5f5}
.smallBtn.accent{border-color:#bfdbfe; color:#1d4ed8; background:#eff6ff}

.histHeader{display:flex; align-items:center; gap:8px; justify-content:space-between; margin:4px 0 8px; flex-wrap:wrap}
.rangeTabs{display:flex; gap:6px}
.rangeTabs button{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; font-weight:800; border-radius:8px; cursor:pointer
}
.rangeTabs button[aria-pressed="true"]{background:#eef6ff; border-color:#c7dbff; color:#1e3a8a}
.canvasWrap{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px; overflow:hidden}
#chart{width:100%; height:280px; display:block}
.sumRow{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:8px}
.sumCard h4{margin:0 0 4px; font-size:12px; color:var(--muted)}
.sumCard .big{font-size:18px; font-weight:900}
.comment{font-size:13px; color:#374151; margin-top:4px}

.scene{margin-top:10px; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; height:min(26vh,240px); position:relative}
.scene svg{width:100%; height:100%; display:block}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modalBack{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:30}
.modal{background:var(--card); border-radius:12px; border:1px solid var(--line); width:min(92vw,760px); max-height:88vh; overflow:auto; padding:14px}
.modal h3{margin:0 0 12px}
.formRow{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center; margin:10px 0}
input[type="number"],input[type="time"],input[type="date"],select{
  width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px
}
.range{display:flex; gap:8px; align-items:center}
.modal .footer{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
.btn{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800}
.btn.primary{background:#1d4ed8; color:#fff; border-color:#1d4ed8}
.btn.ghost{background:#eef2ff}
.note{font-size:12px; color:var(--muted)}
hr.sep{border:none; border-top:1px solid var(--line); margin:12px 0}

/* ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ï¼ˆè­¦å‘Šï¼‰ */
.snack{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
  display:none; max-width:92vw; box-shadow:0 8px 20px rgba(0,0,0,.3); font-size:14px; z-index:40;
}
.snack[data-show="1"]{display:block}
.snack strong{color:#fff}
.snack .ok{color:#10b981}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ³¥é…”åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰ */
.calHead{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.calGrid{
  display:grid; grid-template-columns:repeat(7, 1fr); gap:6px;
}
.calDow{font-size:12px; color:#6b7280; text-align:center; margin-bottom:4px}
.calCell{
  aspect-ratio:1/1; border-radius:8px; border:1px solid var(--line);
  display:flex; align-items:flex-start; justify-content:flex-end; padding:6px; font-size:11px; color:#111827; position:relative;
}
.calCell.out{opacity:.35}
.legend{display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-top:8px}
.legend .box{width:16px; height:12px; border-radius:4px; border:1px solid var(--line)}

@media (prefers-reduced-motion: reduce){
  .tile:active{transform:none}
  .scene *{animation:none !important}
}
</style>
</head>
<body>
  <div class="container">
    <div class="topRow">
      <h1>é…’ãƒ­ã‚°</h1>
      <div class="tabs" role="tablist" aria-label="main tabs">
        <button class="tabBtn" id="tab-input" aria-pressed="true">å…¥åŠ›</button>
        <button class="tabBtn" id="tab-history" aria-pressed="false">å±¥æ­´</button>
      </div>
    </div>

    <!-- KPIï¼ˆå…¥åŠ›ï¼‰ -->
    <div class="kpi">
      <div class="card">
        <h3>ç·é‡ï¼ˆLï¼‰</h3>
        <div class="big" id="kpi-liters">0.00</div>
      </div>
      <div class="card">
        <h3>ç´”ã‚¢ãƒ«ï¼ˆgï¼‰</h3>
        <div class="big" id="kpi-grams">0</div>
      </div>
      <div class="card">
        <h3>æ¦‚ç®—é‡‘é¡ï¼ˆå††ï¼‰</h3>
        <div class="big" id="kpi-yen">Â¥0</div>
      </div>
      <div class="card">
        <h3>åˆ†è§£ç‡ <span id="kpi-startLabel" class="editLink" title="èµ·ç‚¹ã‚’ç·¨é›†">èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰</span></h3>
        <div class="progressWrap">
          <div class="progress" aria-label="åˆ†è§£ç‡">
            <i id="decomp-bar" style="width:0%"></i>
          </div>
          <div class="eta" id="decomp-eta">åˆ†è§£æ™‚é–“ --:--</div>
        </div>
      </div>
    </div>

    <!-- å…¥åŠ› -->
    <section id="sec-input" class="section">
      <div class="subTabs" role="tablist" aria-label="mode tabs">
        <button class="seg" id="seg-home" aria-pressed="true">å®¶é£²ã¿</button>
        <button class="seg" id="seg-out" aria-pressed="false">å¤–é£Ÿ</button>
        <button class="smallBtn accent" id="btn-settings">è¨­å®šï¼ˆä½“é‡ãƒ»è€æ€§ï¼‰</button>
      </div>

      <div class="tiles" id="tiles"></div>

      <div class="actionsRow">
        <button class="smallBtn danger" id="btn-clear">æœ¬æ—¥ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
        <div class="note">â€» æœ10:00ã¾ã§ã¯å‰æ—¥ã®è¨˜éŒ²ã‚’ç·¨é›†ã§ãã¾ã™</div>
      </div>
    </section>

    <!-- å±¥æ­´ -->
    <section id="sec-history" class="section" hidden>
      <div class="histHeader">
        <div style="display:flex; gap:8px; align-items:center">
          <div class="rangeTabs" role="tablist" aria-label="range">
            <button class="rangeBtn" data-range="7d" aria-pressed="false">7d</button>
            <button class="rangeBtn" data-range="30d" aria-pressed="true">30d</button>
            <button class="rangeBtn" data-range="12m" aria-pressed="false">12m</button>
          </div>
          <button class="smallBtn accent" id="btn-cal">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
        </div>
        <div class="note" id="rangeLabel">ç›´è¿‘30æ—¥</div>
      </div>

      <div class="sumRow">
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆå††ï¼‰</h4>
          <div class="big" id="sum-yen">Â¥0</div>
          <div class="comment" id="comment-money">â€”</div>
        </div>
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆç´”ã‚¢ãƒ«gï¼‰</h4>
          <div class="big" id="sum-g">0 g</div>
          <div class="comment" id="comment-grams">â€”</div>
        </div>
      </div>

      <div class="canvasWrap card" style="margin-top:8px">
        <canvas id="chart" width="1200" height="560"></canvas>
      </div>

      <div class="scene" id="scene">
        <!-- SVGã¯JSã§æç”» -->
      </div>
    </section>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-settings">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="setTitle">
      <h3 id="setTitle">è¨­å®šï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h3>

      <div class="formRow">
        <label for="in-weight">ä½“é‡ï¼ˆkgï¼‰</label>
        <input type="number" id="in-weight" min="30" max="150" step="0.5" placeholder="ä¾‹: 70">
      </div>
      <div class="formRow">
        <label>åˆ†å¸ƒä¿‚æ•° rï¼ˆL/kgï¼‰</label>
        <select id="sel-r">
          <option value="0.70">å¹³å‡ï¼ˆ0.70ï¼‰</option>
          <option value="0.71">ç”·æ€§ã®ç›®å®‰ï¼ˆ0.71ï¼‰</option>
          <option value="0.58">å¥³æ€§ã®ç›®å®‰ï¼ˆ0.58ï¼‰</option>
        </select>
      </div>
      <div class="formRow">
        <label>Î²ï¼ˆg/L/æ™‚ï¼‰</label>
        <div class="range">
          <input type="range" id="in-beta" min="0.10" max="0.20" step="0.01">
          <div id="betaLabel" class="note">0.15</div>
        </div>
      </div>
      <div class="formRow">
        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«è€æ€§</label>
        <div>
          <label><input type="radio" name="tol" value="weak">å¼±ã„</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="normal" checked>æ™®é€š</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="strong">å¼·ã„</label>
        </div>
      </div>
      <details>
        <summary>è‡ªå·±è¨ºæ–­ã§æ±ºã‚ã‚‹ï¼ˆä»»æ„ï¼‰</summary>
        <div class="note">æ•°å•ã«ç­”ãˆã¦è€æ€§ä¿‚æ•°ã‚’è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚</div>
        <div style="margin-top:8px">
          <div class="formRow">
            <label>1) ã»ã‚é…”ã„ã¾ã§</label>
            <select class="q" data-w="0"><option value="0">1æ¯</option><option value="1">2æ¯</option><option value="2">3æ¯ä»¥ä¸Š</option></select>
          </div>
          <div class="formRow">
            <label>2) é¡”ã®èµ¤ã¿</label>
            <select class="q" data-w="0"><option value="0">ã™ãå‡ºã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼å‡ºãªã„</option></select>
          </div>
          <div class="formRow">
            <label>3) ç¿Œæœä¸èª¿</label>
            <select class="q" data-w="0"><option value="0">ã‚ˆãã‚ã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼ãªã„</option></select>
          </div>
          <div class="formRow">
            <label>4) é£²é…’é »åº¦</label>
            <select class="q" data-w="0"><option value="0">é€±1ä»¥ä¸‹</option><option value="1">é€±2â€“4</option><option value="2">ã»ã¼æ¯æ—¥</option></select>
          </div>
          <button class="btn ghost" id="btn-self">è‡ªå·±è¨ºæ–­ã‚’åæ˜ </button>
          <div class="note" id="selfNote"></div>
        </div>
      </details>

      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-settings">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-settings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- èµ·ç‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-start">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <h3 id="startTitle">åˆ†è§£ã®èµ·ç‚¹æ™‚åˆ»</h3>
      <div class="formRow">
        <label>ãƒ¢ãƒ¼ãƒ‰</label>
        <div>
          <label><input type="radio" name="startMode" value="auto" checked>è‡ªå‹•ï¼ˆæœ€çµ‚ç™»éŒ²ï¼‰</label>
          <label style="margin-left:14px"><input type="radio" name="startMode" value="manual">æ‰‹å‹•</label>
        </div>
      </div>
      <div id="manualArea">
        <div class="formRow">
          <label>å¯¾è±¡æ—¥</label>
          <input type="date" id="in-start-date">
        </div>
        <div class="formRow">
          <label>æ™‚åˆ»</label>
          <input type="time" id="in-start-time" step="60">
        </div>
        <div class="note">â€» å¤§ããå®Ÿæ…‹ã¨ã‚ºãƒ¬ã‚‹ã¨æ¨å®šãŒä¸æ­£ç¢ºã«ãªã‚Šã¾ã™ã€‚</div>
      </div>
      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-start">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-start">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ³¥é…”åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰ -->
  <div class="modalBack" id="modal-cal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calTitle">
      <div class="calHead">
        <button class="btn" id="cal-prev">â—€</button>
        <h3 id="calTitle" style="margin:0">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
        <button class="btn" id="cal-next">â–¶</button>
      </div>
      <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:4px">
        <div class="calDow">æ—¥</div><div class="calDow">æœˆ</div><div class="calDow">ç«</div><div class="calDow">æ°´</div><div class="calDow">æœ¨</div><div class="calDow">é‡‘</div><div class="calDow">åœŸ</div>
      </div>
      <div id="calGrid" class="calGrid"></div>
      <div class="legend">
        <span class="box" style="background:#e5e7eb"></span><span class="note">ä¼‘è‚/ãªã—</span>
        <span class="box" style="background:#93c5fd"></span><span class="note">ã—ã‚‰ãµ</span>
        <span class="box" style="background:#86efac"></span><span class="note">ã»ã‚é…”ã„</span>
        <span class="box" style="background:#fde68a"></span><span class="note">è‰¯ã„æ°—åˆ†</span>
        <span class="box" style="background:#fb923c"></span><span class="note">ãµã‚‰ã¤ã</span>
        <span class="box" style="background:#fca5a5"></span><span class="note">ãã£ãŸã‚Š</span>
        <span class="box" style="background:#f87171"></span><span class="note">å±é™ºåŸŸ</span>
        <span class="box" style="background:#a78bfa"></span><span class="note">ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</span>
      </div>
      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-cal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ -->
  <div class="snack" id="snack"></div>

<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const tz = 'Asia/Tokyo';
const JPY = n => 'Â¥' + Math.round(n).toLocaleString('ja-JP');
const pad = n => String(n).padStart(2,'0');
const todayKey = () => {
  const now = new Date();
  const jst = new Date(now.toLocaleString('en-US', { timeZone: tz }));
  return jst.toISOString().slice(0,10);
};
const ymd = d => d.toISOString().slice(0,10);
const fmtHM = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const ls = {
  get(k,def){ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): def }catch(e){ return def } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
function jstDateFromKey(key){ return new Date(key+'T00:00:00+09:00'); }
function jstNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:tz})); }
function addDays(d, n){ const t=new Date(d); t.setDate(t.getDate()+n); return t; }
function startOfMonth(d){ const t = new Date(d); t.setDate(1); t.setHours(0,0,0,0); return t; }
function endOfMonth(d){ const t = new Date(startOfMonth(d)); t.setMonth(t.getMonth()+1); t.setDate(0); t.setHours(23,59,59,999); return t; }

/* ========= ãƒ‡ãƒ¼ã‚¿æ ¼ç´ ========= */
const K_LOGS = 'drink_logs_v1';
const K_PRESETS = 'drink_presets_v1';
const K_PROFILE = 'drink_profile_v1';
const K_META = 'drink_logs_meta_v1';
const K_SETTINGS = 'drink_settings_v1';
const K_RANGE = 'hist_range_v1';
const K_FORCE_SOBER = 'force_sober_v1';

let logs = ls.get(K_LOGS, {});          // { 'YYYY-MM-DD': [ {id, ml, abv, price, count, ts}, ... ] }
let presets = ls.get(K_PRESETS, null);
let profile = ls.get(K_PROFILE, { weightKg: 70, beta: 0.15, r:0.70, tol:'normal', tol_mult:1.0 });
let meta = ls.get(K_META, {});           // { 'YYYY-MM-DD': { decompMode:'auto'|'manual', decompStartTs:number } }
let settings = ls.get(K_SETTINGS, { cutoffHour:10, monthlyBudget:12000, compareBasis:'WHO' });
let histRange = ls.get(K_RANGE, '30d');
let forceSober = ls.get(K_FORCE_SOBER, false);

/* ========= ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆå›ºå®šçµµæ–‡å­—ãƒ»å®¶/å¤–ã§ä¾¡æ ¼é•ã„ï¼‰ ========= */
if(!presets){
  presets = {
    home: [
      {id:'beer350', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«350ml', ml:350, abv:5, price:220},
      {id:'beer500', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«500ml', ml:500, abv:5, price:290},
      {id:'happ350', emoji:'ğŸ»', name:'ç™ºæ³¡é…’350ml', ml:350, abv:5, price:170},
      {id:'happ500', emoji:'ğŸ»', name:'ç™ºæ³¡é…’500ml', ml:500, abv:5, price:210},
      {id:'chu350', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:160},
      {id:'chu500', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤500ml', ml:500, abv:7, price:200},
      {id:'hb350',  emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«ç¼¶350ml', ml:350, abv:7, price:170},
      {id:'sake180',emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:220},
      {id:'wine120',emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:200},
      {id:'shaox',  emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:180},
      {id:'sho_rock', emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90, abv:25, price:120},
      {id:'sho_mizu', emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120, abv:20, price:120},
    ],
    out: [
      {id:'nama500', emoji:'ğŸº', name:'ç”Ÿä¸­500ml', ml:500, abv:5, price:600},
      {id:'chu350o', emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:450},
      {id:'hball300',emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«300ml', ml:300, abv:7, price:480},
      {id:'sake180o',emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:580},
      {id:'wine120o',emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:650},
      {id:'shaoxo',  emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:520},
      {id:'sho_roko',emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90, abv:25, price:550},
      {id:'sho_mizuo',emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120, abv:20, price:520},
    ]
  };
  ls.set(K_PRESETS, presets);
}

/* ========= 10:00ç· åˆ‡ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ ========= */
function activeInputKey(){
  const now = jstNow();
  const hour = now.getHours();
  if(hour < settings.cutoffHour){
    const yest = addDays(jstDateFromKey(todayKey()), -1);
    return ymd(yest);
  }
  return todayKey();
}

/* ========= ãƒ­ã‚°æ“ä½œ ========= */
function wipeDay(key){
  delete logs[key];
  delete meta[key];
  ls.set(K_LOGS, logs);
  ls.set(K_META, meta);
}
function addOne(preset){
  const key = activeInputKey();
  logs[key] = logs[key] || [];
  const ts = jstNow().getTime();
  logs[key].push({ ...preset, count:1, ts });
  ls.set(K_LOGS, logs);

  // ã‚¯ãƒªã‚¢å¾Œã®å¼·åˆ¶ã—ã‚‰ãµã‚’è§£é™¤
  forceSober = false;
  ls.set(K_FORCE_SOBER, false);

  // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãªã‚‰èµ·ç‚¹ï¼æœ€çµ‚ç™»éŒ²ã¸ï¼ˆæ‰‹å‹•æ™‚ã¯å¤‰ãˆãªã„ï¼‰
  const m = meta[key];
  if(!m || m.decompMode !== 'manual'){
    meta[key] = { decompMode:'auto' };
    ls.set(K_META, meta);
  }
  assessRiskInline(); // ç·é‡ã®ã¿
  renderAll();
}
function removeOne(id){
  const key = activeInputKey();
  const arr = logs[key] || [];
  const idx = arr.findIndexLast? arr.findIndexLast(v=>v.id===id) : (arr.length-1 - arr.slice().reverse().findIndex(v=>v.id===id));
  if(idx>=0 && idx<arr.length){
    arr.splice(idx,1);
    if(arr.length===0){
      wipeDay(key);
      forceSober = true; ls.set(K_FORCE_SOBER, true);
    }else{
      ls.set(K_LOGS, logs);
    }
    renderAll();
  }
}
function clearActiveDay(){
  const key = activeInputKey();
  wipeDay(key);
  forceSober = true; ls.set(K_FORCE_SOBER, true);
  renderAll();
}

/* ========= é›†è¨ˆ ========= */
function sumDay(key){
  const arr = logs[key] || [];
  let ml=0, g=0, yen=0, lastTs=0;
  for(const it of arr){
    ml += it.ml;
    g  += it.ml * (it.abv/100) * 0.8; // ç´”ã‚¢ãƒ«
    yen+= it.price;
    lastTs = Math.max(lastTs, it.ts||0);
  }
  return { ml, g, yen, lastTs, count:arr.length, items:arr };
}
function sumMonth(key){ // key: YYYY-MM (JST)
  const res = { g:0, yen:0 };
  for(const k in logs){
    if(k.startsWith(key)){
      const s = sumDay(k);
      res.g += s.g; res.yen += s.yen;
    }
  }
  return res;
}

/* ========= åˆ†è§£ãƒ¢ãƒ‡ãƒ«ï¼ˆÎ²Ã—rÃ—ä½“é‡Ã—è€æ€§ï¼‰ ========= */
function toleranceMult(){ // å¼±:0.85/æ™®:1.00/å¼·:1.15
  if(profile.tol==='weak') return 0.85;
  if(profile.tol==='strong') return 1.15;
  return profile.tol_mult || 1.0;
}
function rateGph(){ // g / hour
  return (profile.beta||0.15) * (profile.r||0.70) * (profile.weightKg||70) * toleranceMult();
}

/* ========= åˆ†è§£èµ·ç‚¹ ========= */
function resolveDecompTargetDay(){
  const t = todayKey();
  const y = ymd(addDays(jstDateFromKey(t), -1));
  if(logs[y]) return y;
  if(logs[t]) return t;
  return null;
}
function resolveStartTs(dayKey){
  if(!dayKey) return null;
  const m = meta[dayKey];
  if(m && m.decompMode==='manual' && m.decompStartTs) return m.decompStartTs;
  const { lastTs } = sumDay(dayKey);
  if(!lastTs) return null;
  // å¸åãƒ‡ã‚£ãƒ¬ã‚¤ï¼ˆ60åˆ†ï¼‰ã‚’å®‰å…¨å´ã«è€ƒæ…®
  return lastTs + 60*60*1000;
}

/* ========= æ®‹é‡ãƒ»é€²æ— ========= */
function computeRemain(){
  if(forceSober){
    return { total_g:0, remain_g:0, progress:0, eta:null, startTs:null, dayKey:null };
  }
  const key = resolveDecompTargetDay();
  if(!key) return { total_g:0, remain_g:0, progress:0, eta:null, startTs:null, dayKey:null };
  const { g:total_g } = sumDay(key);
  const startTs = resolveStartTs(key);
  if(!startTs) return { total_g, remain_g:0, progress:0, eta:null, startTs:null, dayKey:key };
  const now = jstNow().getTime();
  const elapsed_h = Math.max(0, (now - startTs)/3600000);
  const speed = rateGph();
  const remain_g = Math.max(0, total_g - speed * elapsed_h);
  const need_h = total_g / speed;
  const done = clamp(elapsed_h / need_h, 0, 1);
  const eta = new Date(startTs + need_h*3600000);
  return { total_g, remain_g, progress:Math.round(done*100), eta, startTs, dayKey:key };
}

/* ========= ãƒ†ã‚£ãƒ³ãƒˆï¼ˆèµ¤ã¿ï¼‰ ========= */
function applyIntoxTint(remain_g){
  const G_SCALE = 60; // 60gã§æœ€å¤§å¯„ã›
  let s = clamp(remain_g / G_SCALE, 0, 1);
  s = Math.pow(s, 0.8);
  const hue = 18 * s, sat = 18*s, light = 4*s;
  document.documentElement.style.setProperty('--tint-strength', s.toFixed(3));
  document.documentElement.style.setProperty('--hue-shift', hue+'deg');
  document.documentElement.style.setProperty('--sat-boost', sat+'%');
  document.documentElement.style.setProperty('--light-boost', light+'%');
}

/* ========= UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šå…¥åŠ›ã‚¿ã‚¤ãƒ« ========= */
const elTiles = document.getElementById('tiles');
const segHome = document.getElementById('seg-home');
const segOut = document.getElementById('seg-out');

let mode = 'home';
function renderPresetTiles(){
  elTiles.innerHTML = '';
  const list = presets[mode];
  const key = activeInputKey();
  const cnts = {};
  (logs[key]||[]).forEach(it => { cnts[it.id] = (cnts[it.id]||0)+1; });
  for(const p of list){
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.id = p.id;
    tile.innerHTML = `
      <div class="emoji">${p.emoji}</div>
      <div class="info">
        <div class="name">${p.name}</div>
        <div class="meta">${p.ml}ml / ${p.abv}% ãƒ» ç´„${JPY(p.price)}</div>
      </div>
      <div class="badge" ${cnts[p.id]? 'data-show="1"':''}>${cnts[p.id] ? (cnts[p.id]>99?'99+':cnts[p.id]) : ''}</div>
    `;
    tile.addEventListener('click', (e)=> {
      if(e.target.classList.contains('badge')) return;
      addOne(p);
    });
    tile.querySelector('.badge').addEventListener('click', (e)=>{
      e.stopPropagation();
      removeOne(p.id);
    });
    elTiles.appendChild(tile);
  }
}

/* ========= KPIæç”»ï¼ˆä½™è¨ˆãªè¡¨è¨˜ã‚’å‰Šé™¤ï¼ETAâ†’åˆ†è§£æ™‚é–“ï¼‰ ========= */
function renderKPI(){
  const key = activeInputKey();
  const s = sumDay(key);
  document.getElementById('kpi-liters').textContent = (s.ml/1000).toFixed(2);
  document.getElementById('kpi-grams').textContent = Math.round(s.g);
  document.getElementById('kpi-yen').textContent = JPY(s.yen);

  const d = computeRemain();
  document.getElementById('decomp-bar').style.width = d.progress + '%';
  document.getElementById('decomp-eta').textContent = d.eta? ('åˆ†è§£æ™‚é–“ ' + fmtHM(d.eta)) : 'åˆ†è§£æ™‚é–“ --:--';

  let startLbl = 'èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰';
  if(d.dayKey){
    const m = meta[d.dayKey];
    const lm = sumDay(d.dayKey).lastTs;
    const autoTime = lm? fmtHM(new Date(lm)) : '--:--';
    if(m && m.decompMode==='manual' && m.decompStartTs){
      startLbl = `èµ·ç‚¹: ${fmtHM(new Date(m.decompStartTs))}ï¼ˆæ‰‹å‹•ï¼‰`;
    }else{
      startLbl = `èµ·ç‚¹: ${autoTime}ï¼ˆè‡ªå‹•ï¼‰`;
    }
  }
  document.getElementById('kpi-startLabel').textContent = startLbl;

  applyIntoxTint(d.remain_g);
}

/* ========= å±¥æ­´ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰ ========= */
function buildHistory(){
  const now = jstNow();
  function daily(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const d = addDays(jstDateFromKey(todayKey()), -i);
      const k = ymd(d);
      const s = sumDay(k);
      arr.push({ date:d, key:k, g: s.g||0, yen: s.yen||0 });
    }
    return arr;
  }
  function monthly(n){
    const arr=[];
    let d = startOfMonth(now);
    for(let i=n-1;i>=0;i--){
      const m = new Date(d); m.setMonth(m.getMonth()-i);
      const ym = m.toISOString().slice(0,7);
      const s = sumMonth(ym);
      arr.push({ date:m, ym, g:s.g||0, yen:s.yen||0 });
    }
    return arr;
  }
  return { daily7: daily(7), daily30: daily(30), monthly12: monthly(12) };
}

/* ========= ã‚°ãƒ©ãƒ•æç”»ï¼ˆCanvasï¼‰ï¼šéè¡¨ç¤ºâ†’è¡¨ç¤ºã®å¹…0å¯¾ç­– ========= */
const canvas = document.getElementById('chart');
const ctx = canvas.getContext('2d');
function drawChart(range, data){
  // å¹…0ã®å ´åˆã¯å¾Œã§å†è©¦è¡Œ
  const Wc = canvas.clientWidth || 0;
  if(Wc < 50){
    requestAnimationFrame(()=> drawChart(range, data));
    return;
  }
  const ratio = window.devicePixelRatio||1;
  canvas.width = canvas.clientWidth*ratio;
  canvas.height= canvas.clientHeight*ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  const padL = 46, padR = 46, padT = 18, padB = 38;
  const plotW = W - padL - padR, plotH = H - padT - padB;

  const maxG = Math.max(10, Math.ceil(Math.max(...data.map(d=>d.g))*1.2/10)*10);
  const maxY = Math.max(1000, Math.ceil(Math.max(...data.map(d=>d.yen))*1.2/1000)*1000);

  ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y = padT + plotH - plotH*i/4;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
  }
  ctx.fillStyle='#6b7280'; ctx.font='12px system-ui, sans-serif';
  ctx.fillText(`${maxG} g`, 4, padT+8);
  const rLabel = `${(maxY/1000)}k Â¥`;
  ctx.fillText(rLabel, W- padR + 8, padT+8);

  const n = data.length;
  const gap = 4;
  const bw = Math.max(4, Math.floor((plotW - gap*(n-1))/n));
  data.forEach((d, i)=>{
    const x = padL + i*(bw+gap);
    const h = Math.round((d.g / maxG) * plotH);
    ctx.fillStyle = '#60a5fa';
    ctx.fillRect(x, padT + plotH - h, bw, h);
  });

  ctx.strokeStyle='#ef4444'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    const y = padT + plotH - (d.yen / maxY) * plotH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle='#ef4444';
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    const y = padT + plotH - (d.yen / maxY) * plotH;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  ctx.fillStyle='#6b7280';
  ctx.textAlign='center';
  ctx.font='11px system-ui, sans-serif';
  data.forEach((d,i)=>{
    const x = padL + i*(bw+gap) + bw/2;
    let lbl='';
    if(range==='12m'){
      const m = d.date.getMonth()+1;
      lbl = `${m}æœˆ`;
    }else{
      const m = d.date.getMonth()+1, day=d.date.getDate();
      lbl = `${m}/${day}`;
    }
    ctx.fillText(lbl, x, H-18);
  });
}

/* ========= ãƒ¬ãƒ³ã‚¸åˆ¥åˆè¨ˆï¼†ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ¨™æº–ãƒ‰ãƒªãƒ³ã‚¯é–¢é€£ã¯å‰Šé™¤ï¼‰ ========= */
const moneyIdeas = [
  {name:'ã‚³ãƒ¼ãƒ’ãƒ¼', price:150, icon:'â˜•'},
  {name:'ãŠã«ãã‚Š', price:140, icon:'ğŸ™'},
  {name:'ç‰›ä¸¼', price:500, icon:'ğŸš'},
  {name:'æ˜ ç”»', price:1900, icon:'ğŸ¬'},
  {name:'ã‚µã‚¦ãƒŠ', price:1200, icon:'â™¨ï¸'},
  {name:'éŸ³æ¥½ã‚µãƒ–ã‚¹ã‚¯(æœˆ)', price:980, icon:'ğŸ§'},
  {name:'éƒ½å†…ç‰‡é“', price:200, icon:'ğŸšƒ'}
];
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function renderSummaryCards(range, data){
  let sumY=0, sumG=0;
  data.forEach(d=>{ sumY+=d.yen; sumG+=d.g; });
  document.getElementById('sum-yen').textContent = JPY(sumY);
  document.getElementById('sum-g').textContent = `${Math.round(sumG)} g`;

  const m = pickRandom(moneyIdeas);
  const n = Math.floor(sumY / m.price);
  document.getElementById('comment-money').textContent = n>0 ? `${m.icon} ${m.name} ${n} å›ã¶ã‚“` : 'â€”';

  const basis = settings.compareBasis || 'WHO';
  const weekG = buildHistory().daily7.reduce((a,b)=>a+b.g,0);
  const avgDay = (range==='30d' ? (sumG/30) : (sumG / (range==='7d'?7:30)));
  let gramsMsg='â€”';

  if(basis==='WHO'){
    gramsMsg = `${Math.round(sumG)}gï¼ˆé©é‡ã®åˆ¤æ–­ã¯é›£ã—ã„ã®ã§ã€æ°´åˆ†ãƒ»ç¡çœ ã‚’æ„è­˜ï¼‰`;
  }else if(basis==='JP'){
    const mult = (avgDay/20).toFixed(2);
    gramsMsg = `1æ—¥å¹³å‡ ${avgDay.toFixed(1)}gï¼ˆæ—¥æœ¬ã®ç›®å®‰20g/æ—¥ã® ${mult} å€ï¼‰`;
  }else if(basis==='UK'){
    const mult = (weekG/112).toFixed(2);
    gramsMsg = `ä»Šé€± ${Math.round(weekG)}gï¼ˆUKä½ãƒªã‚¹ã‚¯112g/é€±ã® ${mult} å€ï¼‰`;
  }else if(basis==='US'){
    const drinksDay = (sumG/ (range==='7d'?7:30) / 14).toFixed(2);
    gramsMsg = `å¹³å‡ ${drinksDay} æ¯(14g)/æ—¥ç›¸å½“`;
  }
  document.getElementById('comment-grams').textContent = gramsMsg;
}

/* ========= ã‚¢ãƒ‹ãƒ¡/ä¹±æ•°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
let sceneRaf = null;
function createEmoji(svgNS, char, size){
  const t = document.createElementNS(svgNS,'text');
  t.setAttribute('x', '0');
  t.setAttribute('y', '0');
  t.setAttribute('text-anchor','middle');
  t.setAttribute('dominant-baseline','central');
  t.setAttribute('font-size', String(size));
  t.setAttribute('font-family','"Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",system-ui');
  t.textContent = char;
  return t;
}
// PRNG
function cyrb53(str, seed = 0){
  let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
  for (let i = 0, ch; i < str.length; i++){
    ch = str.charCodeAt(i);
    h1 = Math.imul(h1 ^ ch, 2654435761);
    h2 = Math.imul(h2 ^ ch, 1597334677);
  }
  h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
  h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
  return 4294967296 * (2097151 & h2) + (h1 >>> 0);
}
function mulberry32(a){
  return function(){
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function seededRngFrom(seedStr){ return mulberry32(cyrb53(seedStr) >>> 0); }
function chooseWeighted(rng, options){
  const tot = options.reduce((a,o)=>a+o.w,0);
  let x = rng()*tot, acc=0;
  for(const o of options){ acc += o.w; if(x <= acc) return o.v; }
  return options[options.length-1].v;
}

/* ========= å±é™ºåŸŸï¼ˆãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼‰äº‹å‰è­¦å‘Šï¼šç·é‡ãƒ™ãƒ¼ã‚¹ã®ã¿ ========= */
function estimateBACNow(){
  const key = resolveDecompTargetDay();
  if(forceSober || !key) return 0;
  const s = sumDay(key);
  const r = profile.r||0.70; const w = profile.weightKg||70;
  const beta = (profile.beta||0.15) * toleranceMult();
  const startTs = resolveStartTs(key); if(!startTs) return 0;
  const t_h = Math.max(0, (jstNow().getTime() - startTs)/3600000);
  const A_L = s.g / 1.0;
  const BAC = Math.max(0, (A_L / (r*w)) - beta * t_h); // g/L
  return BAC * 0.1; // g/dL
}
function getBacSnapshot(){
  if(forceSober){
    return { bacNow:0, bacPeak:0, total_g:0, dayKey: resolveDecompTargetDay() };
  }
  const bacNow = estimateBACNow(); // g/dL
  const sKey = resolveDecompTargetDay();
  const tot_g = sKey ? sumDay(sKey).g : 0;
  const betaEff = (profile.beta||0.15)*toleranceMult(); // g/L/h
  const r=profile.r||0.70, w=profile.weightKg||70;
  let peak_gL = 0;
  if(sKey){
    peak_gL = Math.max(bacNow*10, (tot_g/(r*w)) - betaEff*1); // g/L
  }
  const bacPeak = Math.max(0, peak_gL*0.1); // g/dL
  return { bacNow, bacPeak, total_g: tot_g, dayKey: sKey };
}
function assessRiskInline(){
  const BAC_now_dl = estimateBACNow(); // g/dL
  const betaEff = (profile.beta||0.15) * toleranceMult(); // g/L/æ™‚
  const r = profile.r||0.70, w = profile.weightKg||70;
  const sKey = resolveDecompTargetDay();
  const tot_g = sKey ? sumDay(sKey).g : 0;
  const BAC_peak_g_per_L = Math.max(BAC_now_dl * 10, (tot_g / (r*w)) - betaEff * 1); // g/L
  const BAC_peak_dl = Math.max(0, BAC_peak_g_per_L * 0.1); // g/dL

  let level = null, msg = '';
  if (BAC_peak_dl >= 0.20 || BAC_now_dl >= 0.16){
    level = 'RED';     msg = 'è¨˜æ†¶éšœå®³ã®ãƒªã‚¹ã‚¯ãŒéå¸¸ã«é«˜ã„ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚ä»¥é™ã®é£²é…’ã¯å¼·ãéæ¨å¥¨ã€‚æ°´åˆ†ã¨ä¼‘æ¯ã‚’ã€‚';
  } else if (BAC_peak_dl >= 0.16 || BAC_now_dl >= 0.12){
    level = 'ORANGE';  msg = 'ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚ã“ã“ã§æ‰“ã¡æ­¢ã‚ã«ã—ã¦æ•´ãˆã¾ã—ã‚‡ã†ã€‚';
  } else if (BAC_peak_dl >= 0.12){
    level = 'YELLOW';  msg = 'æ³¨æ„ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚æ°´åˆ†ãƒ»é£Ÿäº‹ãƒ»ä¼‘æ¯ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚';
  }
  if (level){
    showSnack(`${msg}ï¼ˆæ¨å®šBAC ä»Š:${(BAC_now_dl*1000).toFixed(1)}â€° / å…ˆ:${(BAC_peak_dl*1000).toFixed(1)}â€°ï¼‰`);
  }
}

/* ========= ã‚¹ãƒ†ãƒ¼ã‚¸æ±ºå®šãƒ»è¡Œå‹• ========= */
function decideStage(bacNow, bacPeak, total_g){
  if(total_g<=0 || (bacNow===0 && bacPeak<0.005)) return 'S0'; // ä¼‘æ†©ï¼ˆå®¶ï¼‰
  const b = Math.max(bacNow, bacPeak);
  if(b>=0.20 || bacNow>=0.18) return 'S7'; // ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼è­¦å¯Ÿ
  if(b>=0.16) return 'S6';   // å±é™ºåŸŸ
  if(b>=0.13) return 'S5';   // ãã£ãŸã‚Š
  if(b>=0.10) return 'S4';   // ãµã‚‰ã¤ã
  if(b>=0.06) return 'S3';   // ã‹ãªã‚Šé…”ã†ï¼ˆå±…é…’å±‹ï¼‰
  if(b>=0.03) return 'S2';   // ã»ã‚é…”ã„ï¼ˆå±…é…’å±‹ï¼‰
  return 'S1';               // ã—ã‚‰ãµï¼ˆç¹è¯è¡—ï¼‰
}
function pickAction(stage, dayKey, total_g){
  const rng = seededRngFrom(`${dayKey||'none'}|${stage}|${Math.floor(total_g||0)}`);
  const W = {
    S3: [{v:'karaoke',w:30},{v:'nuis_bump',w:10},{v:'nuis_spill',w:5},{v:'none',w:55}],
    S4: [{v:'karaoke',w:35},{v:'nuis_bump',w:25},{v:'nuis_spill',w:15},{v:'none',w:25}],
    S5: [{v:'karaoke',w:10},{v:'nuis_bump',w:30},{v:'nuis_spill',w:30},{v:'none',w:30}],
    S6: [{v:'karaoke',w:0 },{v:'nuis_bump',w:40},{v:'nuis_spill',w:40},{v:'none',w:20}],
    S7: [{v:'none',w:100}],
  };
  const opts = W[stage] || [{v:'none', w:100}];
  return chooseWeighted(rng, opts);
}

/* ========= ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰å›ºå®šï¼ä¸å®‰å®šã•ã§æ¼”å‡ºï¼‰ ========= */
const MOTION_BY_STAGE = {
  // speedã¯ã»ã¼ä¸€å®šã€‚ä¸å®‰å®šã•ï¼ˆsway, wander, jitter, drift, pauseï¼‰ã§æ®µéšè¡¨ç¾
  S0:{speed:5.0, sway:0.4, bob:0.4, wander:0.1, drift:0.0, jitter:0.0, pause:0.0},
  S1:{speed:5.0, sway:0.6, bob:0.6, wander:0.2, drift:0.1, jitter:0.0, pause:0.0},
  S2:{speed:5.0, sway:1.0, bob:0.9, wander:0.4, drift:0.15, jitter:0.05, pause:0.0},
  S3:{speed:5.0, sway:1.6, bob:1.2, wander:0.7, drift:0.25, jitter:0.08, pause:0.02},
  S4:{speed:5.0, sway:2.4, bob:1.4, wander:1.2, drift:0.45, jitter:0.12, pause:0.05},
  S5:{speed:5.0, sway:3.2, bob:1.6, wander:1.8, drift:0.65, jitter:0.16, pause:0.10},
  S6:{speed:5.0, sway:4.5, bob:2.0, wander:2.4, drift:0.9,  jitter:0.22, pause:0.18},
  S7:{speed:0.6, sway:0.3, bob:0.2, wander:0.1, drift:0.0,  jitter:0.0,  pause:0.4}, // ã»ã¼é™æ­¢
};
// motionã‚’ä½¿ã£ã¦ã€Œè›‡è¡Œã€ã€Œãƒ‰ãƒªãƒ•ãƒˆã€ã€Œä¸€æ™‚åœæ­¢ã€ã€Œãµã‚‰ã¤ãã‚¹ãƒ‘ã‚¤ã‚¯ã€ã‚’åˆæˆ
function animateEmojiActor(group, stage, seedStr, boundsW=800, baselineY=230, extraTick=null){
  if(sceneRaf) cancelAnimationFrame(sceneRaf);
  const reduce = window.matchMedia?.('(prefers-reduced-motion: reduce)').matches;
  if(reduce) return;

  const motion = MOTION_BY_STAGE[stage] || MOTION_BY_STAGE.S1;
  const rng = seededRngFrom(seedStr || 'anim');
  const phase1 = rng()*Math.PI*2, phase2 = rng()*Math.PI*2, phase3 = rng()*Math.PI*2, phase4 = rng()*Math.PI*2;

  const t0 = performance.now();
  const left=120, right=boundsW-120;
  function loop(t){
    const s=(t-t0)/1000;

    // ä¸€æ™‚åœæ­¢ï¼ˆé«˜ãƒ¬ãƒ™ãƒ«ã»ã©åœæ­¢çª“ãŒç™ºç”Ÿï¼‰
    const pauseGate = motion.pause>0 ? (Math.sin(s*0.7 + phase4)> (1 - motion.pause*2)) : false;
    const speed = pauseGate ? 0.6 : motion.speed;

    // æ°´å¹³å¾€å¾©ï¼‹è›‡è¡Œï¼ˆserpentineï¼‰
    const u = 0.5 + 0.5*Math.sin(s*speed*0.45 + phase1);
    let x = left + (right-left)*u;

    // ãƒ‰ãƒªãƒ•ãƒˆï¼ˆã‚†ã£ãã‚Šå³å·¦ã«æµã‚Œã‚‹ï¼‰
    x += Math.sin(s*0.35 + phase2) * (8*motion.drift);

    // ãƒ©ãƒ³ãƒ€ãƒ è›‡è¡Œã®ä¸Šä¹—ã›
    x += Math.sin(s*2.4 + phase3) * (4*motion.wander);

    // ä¸Šä¸‹ãƒœãƒ–
    const y = baselineY + Math.sin(s*1.8 + phase2)*motion.bob;

    // ãµã‚‰ã¤ãï¼ˆå›è»¢+ã‚¸ãƒƒã‚¿ãƒ¼ï¼‰
    let rot = Math.sin(s*2.1 + phase1)*motion.sway;
    rot += (Math.sin(s*10 + phase3))* (motion.jitter*6);

    // ãŸã¾ã«ã‚¹ãƒ‘ã‚¤ã‚¯ï¼ˆã‚ˆã‚ã‘ï¼‰
    if(motion.jitter>0.1 && (Math.sin(s*3.3 + phase4) > 0.96)){
      rot += Math.sin(s*18)*6*motion.jitter; // ç¬é–“çš„ã«å¤§ãã
      x += Math.sin(s*12)*4*motion.jitter;
    }

    group.setAttribute('transform',`translate(${x.toFixed(1)},${y.toFixed(1)}) rotate(${rot.toFixed(1)})`);

    if(typeof extraTick==='function') extraTick({s,x,y,rot});
    sceneRaf = requestAnimationFrame(loop);
  }
  sceneRaf = requestAnimationFrame(loop);
}

/* ========= è¡Œå‹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========= */
function renderActionOverlays(svg, actorGroup, action){
  const svgNS='http://www.w3.org/2000/svg';
  function addTextToGroup(txt, size, dx, dy){
    const t=document.createElementNS(svgNS,'text');
    t.setAttribute('text-anchor','middle');
    t.setAttribute('dominant-baseline','central');
    t.setAttribute('font-size',String(size));
    t.setAttribute('font-family','"Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",system-ui');
    t.textContent=txt;
    t.setAttribute('transform',`translate(${dx},${dy})`);
    actorGroup.appendChild(t);
    return t;
  }
  let tick=null;
  if(action==='karaoke'){
    addTextToGroup('ğŸ¤', 44, 36, -8);
    const notes=[addTextToGroup('ğŸµ', 30, -20, -50),
                 addTextToGroup('â™ª', 26, -8, -70),
                 addTextToGroup('ğŸ¶', 28,  10,-90)];
    tick=({s})=>{
      notes.forEach((n,i)=>{
        const phase=s+i*0.7;
        const y=-50 - i*22 - (Math.sin(phase*1.2)+1)*10;
        const x=(-20 + i*14) + Math.sin(phase*2.0)*6;
        n.setAttribute('transform',`translate(${x.toFixed(1)},${y.toFixed(1)}) rotate(${(Math.sin(phase)*8).toFixed(1)})`);
        n.setAttribute('opacity', (0.7+0.3*Math.sin(phase*1.5)).toFixed(2));
      });
    };
  }
  if(action==='nuis_bump' || action==='nuis_spill'){
    const angry = addTextToGroup('ğŸ˜ ', 58, -70, -4);
    const mark = addTextToGroup('ğŸ’¢', 28, -94, -38);
    if(action==='nuis_spill'){
      const spill = addTextToGroup('ğŸº', 36, 28, 24);
      const bang  = addTextToGroup('ğŸ’¥', 26, 56, 34);
      spill.setAttribute('transform','translate(28,24) rotate(-60)');
      tick=({s})=>{
        const k = (Math.sin(s*10)+1)/2;
        angry.setAttribute('transform',`translate(${-70 + Math.sin(s*12)*3},${-4})`);
        mark.setAttribute('opacity',(0.6+0.4*k).toFixed(2));
        bang.setAttribute('opacity',(0.5+0.5*Math.sin(s*8)).toFixed(2));
      };
    }else{
      tick=({s})=>{
        const k = Math.sin(s*9);
        angry.setAttribute('transform',`translate(${-70 + k*3},${-4})`);
        mark.setAttribute('opacity',(0.6+0.4*Math.sin(s*12)).toFixed(2));
      };
    }
  }
  return tick;
}

/* ========= ã‚·ãƒ¼ãƒ³æç”»ï¼ˆæ®µéšï¼‹ãƒ©ãƒ³ãƒ€ãƒ ï¼‹è¡Œå‹•ï¼‰ ========= */
function drawScene(){
  const host = document.getElementById('scene');
  host.innerHTML='';
  const { bacNow, bacPeak, total_g, dayKey } = getBacSnapshot();
  const stage = decideStage(bacNow, bacPeak, total_g);

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox','0 0 800 360');

  // ãƒ™ãƒ¼ã‚¹ã‚·ãƒ¼ãƒ³é¸æŠï¼ˆS0ã¯å®¶å›ºå®šï¼šã—ã‚‰ãµã§å±…é…’å±‹ã«ãªã‚‰ãªã„ï¼‰
  let base='living';
  if(stage==='S1') base='downtown';
  else if(stage==='S2' || stage==='S3') base='izakaya';
  else if(stage==='S4') base='downtown';
  else if(stage==='S5' || stage==='S6') base='park';
  else if(stage==='S7') base='jail';

  // åŒæ—¥ãƒ»åŒã‚¹ãƒ†ãƒ¼ã‚¸ã§ä¸€è²«ã™ã‚‹è»½ã„ãƒ©ãƒ³ãƒ€ãƒ 
  const rng = seededRngFrom(`${dayKey||'none'}|${stage}`);
  const bgColorNight = ['#0f172a','#0b132b','#0c1220'][Math.floor(rng()*3)] || '#0f172a';

  // èƒŒæ™¯æ•·ã
  const bg = document.createElementNS(svgNS,'rect');
  bg.setAttribute('x','0'); bg.setAttribute('y','0');
  bg.setAttribute('width','800'); bg.setAttribute('height','360');
  bg.setAttribute('fill', (base==='downtown'||base==='jail') ? bgColorNight : '#e6f0ff');
  svg.appendChild(bg);

  function rect(x,y,w,h,fill){ const r=document.createElementNS(svgNS,'rect'); r.setAttribute('x',x); r.setAttribute('y',y); r.setAttribute('width',w); r.setAttribute('height',h); r.setAttribute('fill',fill); return r; }
  function circle(cx,cy,r,fill){ const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r); c.setAttribute('fill',fill); return c; }
  function text(x,y,str,size=24){ const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('font-size',size); t.setAttribute('font-family','"Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",system-ui'); t.textContent=str; return t; }

  // èƒŒæ™¯ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  if(base==='living'){
    svg.appendChild(rect(0,260,800,100,'#f3f4f6'));
    const sofaColors=['#cbd5e1','#94a3b8','#a8a29e'];
    svg.appendChild(rect(80,200,200,80, sofaColors[Math.floor(rng()*sofaColors.length)]));
    svg.appendChild(rect(500,180,140,100,'#9ca3af'));
    if(rng()<0.6){ svg.appendChild(rect(520,190,100,60,'#111827')); }
  }
  if(base==='park'){
    const ground=['#84cc16','#65a30d','#93c5fd'][Math.floor(rng()*3)];
    svg.appendChild(rect(0,280,800,80, ground));
    if(rng()<0.7) svg.appendChild(circle(700,80,40,'#fde68a'));
    svg.appendChild(rect(120,240,180,20,'#9ca3af'));
    svg.appendChild(rect(130,200,20,40,'#9ca3af'));
    svg.appendChild(rect(260,200,20,40,'#9ca3af'));
  }
  if(base==='izakaya'){
    svg.appendChild(rect(0,270,800,90,'#1f2937'));
    svg.appendChild(rect(60,80,680,190, rng()<0.5?'#f59e0b':'#fbbf24'));
    for(let i=0;i<6;i++){
      const c = rng()<0.5?'#ef4444':'#fb7185';
      svg.appendChild(circle(120+ i*110, 70, 18, c));
      svg.appendChild(circle(120+ i*110, 70, 8, '#ffffff'));
    }
    svg.appendChild(rect(220,230,360,20,'#92400e'));
    if(rng()<0.6){ svg.appendChild(text(240,210, rng()<0.5?'ğŸ¢':'ğŸ£',28)); }
    if(rng()<0.5){ svg.appendChild(text(300,210,'ğŸº',28)); }
  }
  if(base==='downtown'){
    svg.appendChild(rect(0,300,800,60,'#0b1020'));
    for(let i=0;i<6;i++){
      const x = 40 + i*120;
      svg.appendChild(rect(x,120,80,160,'#1e293b'));
      for(let w=0; w<3; w++){
        for(let h=0; h<3; h++){
          svg.appendChild(rect(x+12+w*22,140+h*40,14,18, rng()<.5?'#f59e0b':'#334155'));
        }
      }
    }
    svg.appendChild(rect(620,110,120,40, rng()<0.5?'#ef4444':'#22c55e'));
  }
  if(base==='jail'){
    svg.appendChild(rect(0,260,800,100,'#0b1020'));
    svg.appendChild(rect(80,40,640,240,'#111827'));
    for(let i=0;i<9;i++){ svg.appendChild(rect(120+i*60,40,12,240,'#374151')); }
    svg.appendChild(rect(80,40,640,12,'#374151'));
    svg.appendChild(rect(80,268,640,12,'#374151'));
    svg.appendChild(text(680,240,'ğŸ‘®',36));
  }

  // å½¹è€…ï¼ˆçµµæ–‡å­—ï¼‰
  const actorEmojiMap = { S0:'ğŸ™‚', S1:'ğŸš¶', S2:'ğŸ™‚', S3:'ğŸ˜Œ', S4:'ğŸ¥´', S5:'ğŸ˜µâ€ğŸ’«', S6:'ğŸ¥´', S7:'ğŸ˜µ' };
  const actorSize = 120;
  const actorGroup = document.createElementNS(svgNS,'g');
  const actor = createEmoji(svgNS, actorEmojiMap[stage] || 'ğŸ™‚', actorSize);
  actorGroup.appendChild(actor);
  svg.appendChild(actorGroup);
  host.appendChild(svg);

  // è¡Œå‹•ï¼ˆé«˜ãƒ¬ãƒ™ãƒ«æ™‚ï¼‰
  let action = pickAction(stage, dayKey||'none', total_g);
  if(stage==='S7') action='none';
  const extraTick = renderActionOverlays(svg, actorGroup, action);

  const baselineY = (base==='park') ? 250 : (base==='downtown' ? 290 : 230);
  const seedStr = `${dayKey||'none'}|${stage}|anim`;
  animateEmojiActor(actorGroup, stage, seedStr, 800, baselineY, extraTick);

  // ãƒ¢ãƒ–
  if(base==='park'){ svg.appendChild(text(320,280,'ğŸ•',28)); if(Math.random()<0.6) svg.appendChild(text(360,280,'ğŸ•Šï¸',22)); }
  if(base==='izakaya'){ if(Math.random()<0.5) svg.appendChild(text(520,220,'ğŸ™‚',24)); if(Math.random()<0.5) svg.appendChild(text(560,220,'ğŸº',24)); }
  if(base==='downtown'){ svg.appendChild(text(140,300,'ğŸš¶â€â™€ï¸',26)); svg.appendChild(text(700,300,'ğŸš•',26)); }
}

/* ========= æ³¥é…”åº¦ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰â†’è‰² ========= */
function stageToColor(stage){
  return ({
    S0:'#e5e7eb', // ãªã—
    S1:'#93c5fd', // ã—ã‚‰ãµ
    S2:'#86efac', // ã»ã‚é…”ã„
    S3:'#fde68a', // è‰¯ã„æ°—åˆ†
    S4:'#fb923c', // ãµã‚‰ã¤ã
    S5:'#fca5a5', // ãã£ãŸã‚Š
    S6:'#f87171', // å±é™ºåŸŸ
    S7:'#a78bfa', // ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
  })[stage] || '#e5e7eb';
}

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ³¥é…”åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰ ========= */
let calMonth = null; // è¡¨ç¤ºä¸­ã®æœˆï¼ˆDateï¼‰
function calcStageForDay(key){
  const s = sumDay(key);
  if(!s || !s.g) return 'S0';
  // ãã®æ—¥ã®ãƒ”ãƒ¼ã‚¯ã‚’å˜ç´”æ¨å®šï¼ˆåˆ†å¸ƒã§å‰²ã‚‹ï¼‰
  const r=profile.r||0.70, w=profile.weightKg||70;
  const peak = (s.g/(r*w))*0.1; // g/dL
  return decideStage(0, peak, s.g);
}
function openCalendar(){
  const m = document.getElementById('modal-cal');
  calMonth = startOfMonth(jstNow());
  renderCalendar();
  m.style.display='flex';
}
function closeCalendar(){
  document.getElementById('modal-cal').style.display='none';
}
function shiftMonth(delta){
  calMonth.setMonth(calMonth.getMonth()+delta);
  renderCalendar();
}
function renderCalendar(){
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  const title = document.getElementById('calTitle');
  const y = calMonth.getFullYear(), mo = calMonth.getMonth()+1;
  title.textContent = `${y}å¹´${mo}æœˆ`;

  const first = new Date(calMonth); // JSTç›¸å½“å‰æ
  const last = endOfMonth(calMonth);
  const firstDow = first.getDay(); // æ—¥=0
  const days = last.getDate();

  // å‰æœˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
  for(let i=0;i<firstDow;i++){
    const cell = document.createElement('div');
    cell.className='calCell out';
    grid.appendChild(cell);
  }
  // å½“æœˆ
  for(let d=1; d<=days; d++){
    const cell = document.createElement('div');
    cell.className='calCell';
    const k = `${y}-${pad(mo)}-${pad(d)}`;
    const st = calcStageForDay(k);
    cell.style.background = stageToColor(st);
    cell.textContent = d;
    cell.title = `æ³¥é…”åº¦: ${st} / ${k}`;
    grid.appendChild(cell);
  }
  // æ¬¡æœˆãƒ—ãƒ¬ãƒ¼ã‚¹ï¼ˆ6è¡Œã«ãªã‚‹ã¾ã§åŸ‹ã‚ã‚‹ï¼‰
  const totalCells = firstDow + days;
  const remain = (Math.ceil(totalCells/7)*7) - totalCells;
  for(let i=0;i<remain;i++){
    const cell = document.createElement('div');
    cell.className='calCell out';
    grid.appendChild(cell);
  }
}

/* ========= ç¿Œæœ7æ™‚ã®äºˆæ¸¬ï¼ˆæ“¬ä¼¼äºˆç´„ï¼‰ ========= */
function hangoverScheduleNote(){
  const target = new Date(jstNow()); target.setDate(target.getDate()+1);
  target.setHours(7,0,0,0);
  const d = computeRemain();
  const speed = rateGph();
  const nowG = d.remain_g;
  const hoursTo7 = (target.getTime() - jstNow().getTime())/3600000;
  const remain7 = Math.max(0, nowG - speed*hoursTo7);
  const R1 = clamp(remain7/10,0,1);
  const R2 = clamp((resolveDecompTargetDay()? sumDay(resolveDecompTargetDay()).g:0)/60,0,1);
  const score = clamp(0.6*R1 + 0.4*R2, 0,1);
  if(score>=0.7){
    showSnack(`ğŸ˜µ æ˜æœ7æ™‚ã€äºŒæ—¥é…”ã„æ³¨æ„ã®å¯èƒ½æ€§ï¼ˆæ®‹ã‚Šç´„${Math.round(remain7)}gäºˆæ¸¬ï¼‰`);
  }
}

/* ========= ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ ========= */
let snackTimer=null;
function showSnack(text){
  const el = document.getElementById('snack');
  el.textContent = text;
  el.setAttribute('data-show','1');
  clearTimeout(snackTimer);
  snackTimer = setTimeout(()=> el.removeAttribute('data-show'), 4000);
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById('tab-input').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','true');
  document.getElementById('tab-history').setAttribute('aria-pressed','false');
  document.getElementById('sec-input').hidden=false;
  document.getElementById('sec-history').hidden=true;
});
document.getElementById('tab-history').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','false');
  document.getElementById('tab-history').setAttribute('aria-pressed','true');
  document.getElementById('sec-input').hidden=true;
  document.getElementById('sec-history').hidden=false;
  renderHistory();
});

segHome.addEventListener('click', ()=>{ segHome.setAttribute('aria-pressed','true'); segOut.setAttribute('aria-pressed','false'); mode='home'; renderPresetTiles(); });
segOut.addEventListener('click', ()=>{ segOut.setAttribute('aria-pressed','true'); segHome.setAttribute('aria-pressed','false'); mode='out'; renderPresetTiles(); });

document.getElementById('btn-clear').addEventListener('click', ()=>{
  if(confirm('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ã®å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) clearActiveDay();
});

document.getElementById('btn-settings').addEventListener('click', openSettings);
document.getElementById('btn-close-settings').addEventListener('click', closeSettings);
document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
document.getElementById('btn-self').addEventListener('click', doSelfAssess);

document.getElementById('kpi-startLabel').addEventListener('click', openStartModal);
document.getElementById('btn-close-start').addEventListener('click', closeStartModal);
document.getElementById('btn-save-start').addEventListener('click', saveStartModal);

document.querySelectorAll('.rangeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.rangeBtn').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    histRange = btn.dataset.range; ls.set(K_RANGE, histRange);
    renderHistory();
  });
});

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
document.getElementById('btn-cal').addEventListener('click', openCalendar);
document.getElementById('btn-close-cal').addEventListener('click', closeCalendar);
document.getElementById('cal-prev').addEventListener('click', ()=> shiftMonth(-1));
document.getElementById('cal-next').addEventListener('click', ()=> shiftMonth(1));

/* ========= è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ========= */
function openSettings(){
  const m = document.getElementById('modal-settings');
  document.getElementById('in-weight').value = profile.weightKg||70;
  document.getElementById('sel-r').value = String(profile.r||0.70);
  document.getElementById('in-beta').value = profile.beta||0.15;
  document.getElementById('betaLabel').textContent = (profile.beta||0.15).toFixed(2);
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked = (r.value === (profile.tol||'normal')));
  m.style.display='flex';
}
document.getElementById('in-beta').addEventListener('input', (e)=> document.getElementById('betaLabel').textContent = Number(e.target.value).toFixed(2));
function closeSettings(){ document.getElementById('modal-settings').style.display='none'; }
function saveSettings(){
  const w = parseFloat(document.getElementById('in-weight').value)||70;
  const r = parseFloat(document.getElementById('sel-r').value)||0.70;
  const b = parseFloat(document.getElementById('in-beta').value)||0.15;
  const tol = document.querySelector('input[name="tol"]:checked').value;
  profile.weightKg = clamp(w, 30, 150);
  profile.r = r; profile.beta = clamp(b,0.10,0.20); profile.tol = tol;
  ls.set(K_PROFILE, profile);
  closeSettings();
  renderAll();
}
function doSelfAssess(){
  const qs = [...document.querySelectorAll('#modal-settings select.q')];
  const score = qs.reduce((a,s)=> a + Number(s.value), 0);
  let tol='normal', mult=1.0, msg='';
  if(score <=5){ tol='weak'; mult=0.85; msg='è€æ€§ã€Œå¼±ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=0.85ï¼‰'; }
  else if(score <=9){ tol='normal'; mult=1.0; msg='è€æ€§ã€Œæ™®é€šã€ã‚’æ¨å¥¨ï¼ˆtol=1.0ï¼‰'; }
  else { tol='strong'; mult=1.15; msg='è€æ€§ã€Œå¼·ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=1.15ï¼‰'; }
  profile.tol = tol; profile.tol_mult = mult;
  document.getElementById('selfNote').textContent = msg;
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked = (r.value === tol));
}

/* ========= èµ·ç‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šUIè£œåŠ© ========= */
function currentStartMode(){
  return document.querySelector('input[name="startMode"]:checked')?.value || 'auto';
}
function updateStartModeUI(){
  const mode = currentStartMode();
  document.getElementById('manualArea').style.opacity = (mode==='manual') ? 1 : 0.5;
}
function openStartModal(){
  const m = document.getElementById('modal-start');
  const day = resolveDecompTargetDay();
  const md = meta[day]||{decompMode:'auto'};
  document.querySelectorAll('input[name="startMode"]').forEach(r=> r.checked = (r.value === (md.decompMode||'auto')));
  const dt = day? jstDateFromKey(day) : jstNow();
  document.getElementById('in-start-date').value = ymd(dt);
  const time = md.decompStartTs? new Date(md.decompStartTs) : jstNow();
  document.getElementById('in-start-time').value = `${pad(time.getHours())}:${pad(time.getMinutes())}`;
  updateStartModeUI();
  m.style.display='flex';
}
document.querySelectorAll('input[name="startMode"]').forEach(r=>{
  r.addEventListener('change', updateStartModeUI);
});
['in-start-date','in-start-time'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', ()=>{
    const manual = document.querySelector('input[name="startMode"][value="manual"]');
    if (manual && !manual.checked){
      manual.checked = true;
      updateStartModeUI();
    }
  });
});
function closeStartModal(){ document.getElementById('modal-start').style.display='none'; }
function saveStartModal(){
  const dayInput = document.getElementById('in-start-date').value;
  const fallbackDay = resolveDecompTargetDay();
  const day = dayInput || fallbackDay;
  if(!day){ closeStartModal(); return; }
  const mode = document.querySelector('input[name="startMode"]:checked').value;
  if(mode==='auto'){
    meta[day] = { decompMode:'auto' };
  }else{
    const t = document.getElementById('in-start-time').value || '00:00';
    const ts = new Date(`${day}T${t}:00+09:00`).getTime();
    meta[day] = { decompMode:'manual', decompStartTs: ts };
  }
  ls.set(K_META, meta);
  closeStartModal();
  renderAll();
}

/* ========= å±¥æ­´ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========= */
function renderHistory(){
  const payload = buildHistory();
  const range = histRange||'30d';
  const ds = range==='7d'? payload.daily7 : range==='30d'? payload.daily30 : payload.monthly12;
  renderSummaryCards(range, ds);
  document.getElementById('rangeLabel').textContent = range==='7d'?'ç›´è¿‘7æ—¥': range==='30d'?'ç›´è¿‘30æ—¥':'éå»12ã‹æœˆ';
  drawChart(range, ds);
  drawScene();
}

/* ========= ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========= */
function renderAll(){
  renderPresetTiles();
  renderKPI();
  if(document.getElementById('sec-history').hidden===false){
    renderHistory();
  }else{
    drawScene();
  }
}

/* ========= åˆæœŸèµ·å‹• ========= */
window.addEventListener('load', ()=>{
  document.querySelectorAll('.rangeBtn').forEach(b=> b.setAttribute('aria-pressed', String(b.dataset.range===histRange)));
  if(!profile.weightKg) profile.weightKg = 70;
  if(!profile.beta) profile.beta = 0.15;
  if(!profile.r) profile.r = 0.70;

  // åˆå›ï¼šãƒ­ã‚°ãŒå…¨ãç„¡ã‘ã‚Œã°ã—ã‚‰ãµå›ºå®šã§é–‹å§‹
  if(Object.keys(logs||{}).length === 0){
    forceSober = true; ls.set(K_FORCE_SOBER, true);
  }

  renderAll();
  setInterval(()=>{ renderKPI(); drawScene(); }, 60*1000);
  setTimeout(hangoverScheduleNote, 1200);
});
</script>
</body>
</html>
