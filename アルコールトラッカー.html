<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ã‚†ã‚‹ã‚­ãƒ£ãƒ©é£²é…’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<meta name="theme-color" content="#3a7afe">
<style>
:root{
  /* èƒŒæ™¯ãƒ†ãƒ¼ãƒï¼ˆæœå¤•å¤œï¼‰ */
  --bg-morning: linear-gradient(180deg,#e6f3ff 0%, #ffffff 60%);
  --bg-evening: linear-gradient(180deg,#ffe6b3 0%, #ffffff 60%);
  --bg-night:   linear-gradient(180deg,#091834 0%, #152a52 60%);
  --bg-card: #ffffff;
  --line: #dbe4ff;
  --text: #0f172a;
  --muted:#64748b;
  --accent:#3a7afe;
  --ok:#16a34a;
  --warn:#ef4444;
  --gold:#f59e0b;
  --pill:#eef4ff;
  --tiny:#6b7280;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg-morning);
  transition:background .4s ease;
}

header{
  position:sticky; top:0; z-index:50;
  backdrop-filter:saturate(140%) blur(6px);
  background:rgba(255,255,255,.75);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:980px;margin:auto;padding:12px}

h1{font-size:18px;margin:0}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
.modeTabs{display:flex;gap:6px;flex-wrap:wrap}
.tabBtn{
  border:1px solid var(--line); background:#fff; color:var(--text);
  border-radius:999px; padding:6px 12px; cursor:pointer; font-weight:600;
}
.tabBtn.active{background:var(--accent); color:#fff; border-color:transparent}

main{min-height:100vh}

.card{
  background:var(--bg-card); border:1px solid var(--line);
  border-radius:14px; padding:12px;
}

/* â”€â”€ ã‚µãƒãƒªãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰ â”€â”€ */
#summary{
  display:grid; grid-template-columns:1fr; gap:10px;
}
.summaryRow{
  display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
}
.kpi{
  background:#fff; border:1px solid var(--line); border-radius:12px;
  padding:10px; text-align:center;
}
.kpi .label{font-size:12px;color:var(--muted)}
.kpi .value{font-size:18px;font-weight:800;margin-top:2px}
.tinySaved{
  font-size:12px; color:var(--tiny); text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* åˆ†è§£ãƒãƒ¼ï¼ˆæ¨ªä¸€æ–‡å­—ï¼šãƒ‡ã‚¸å˜é¢¨ï¼‰ */
#decompWrap{
  display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
}
#decompBar{
  position:relative; height:14px; border-radius:999px;
  background:linear-gradient(90deg,#c7d2fe,#93c5fd,#6ee7b7);
  overflow:hidden;
}
#decompMask{
  position:absolute; top:0; right:0; bottom:0;
  width:0%; background:rgba(255,255,255,.75); transition:width .6s ease;
}
#decompText{font-size:14px; color:var(--text)}
#eta{font-size:12px; color:var(--muted)}

/* â”€â”€ å…¥åŠ›ã‚¿ã‚¤ãƒ« â”€â”€ */
.sectionTitle{display:flex;align-items:center;justify-content:space-between;margin:12px 0 6px}
.grid{
  display:grid; gap:10px;
  grid-template-columns:repeat(2,1fr);
}
@media(min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
@media(min-width:840px){ .grid{grid-template-columns:repeat(4,1fr)} }

.tile{
  position:relative; background:#fff; border:1px solid var(--line);
  border-radius:12px; padding:10px; cursor:pointer; user-select:none; touch-action:manipulation;
  transition:transform .05s ease;
}
.tile:active{transform:scale(.985)}
.tile .name{font-weight:800}
.tile .meta{font-size:12px;color:var(--muted)}
.badge{
  position:absolute; top:8px; right:8px; background:#0ea5e9; color:#fff;
  border-radius:999px; font-size:12px; line-height:1; padding:6px 8px; min-width:24px; text-align:center;
}
.swipeHint{position:absolute; left:8px; bottom:6px; font-size:11px; color:#94a3b8}

/* å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå½“æ—¥åˆè¨ˆï¼‰ */
.fixedBar{
  position:sticky; bottom:0; left:0; right:0; z-index:40;
  background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(245,248,255,.95));
  border-top:1px solid var(--line); padding:8px 0;
}
.fixedStats{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
.kv{font-size:14px}
.kv b{font-size:16px}
.small{font-size:12px; color:var(--muted)}

/* â”€â”€ ã‚¿ãƒ–ï¼ˆå…¥åŠ› / å±¥æ­´ï¼‰ â”€â”€ */
.appTabs{display:flex; gap:8px; margin-top:8px}
.appTabBtn{
  border:1px solid var(--line); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer;
}
.appTabBtn.active{background:var(--accent); color:#fff; border-color:transparent}

/* â”€â”€ å±¥æ­´ãƒ“ãƒ¥ãƒ¼ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆæœ¬ä½“ã¯å¾Œç¶šJSï¼‰ â”€â”€ */
#historyView{display:none}
.historyHead{
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;
}
.rangeTabs{display:flex; gap:6px}
.chartCanvas{width:100%; height:260px; background:#fff; border:1px solid var(--line); border-radius:12px}

/* â”€â”€ ã‚†ã‚‹ã‚­ãƒ£ãƒ©èˆå°ï¼ˆå±¥æ­´ã®ä¸‹ã€å¾Œç¶šJSã§åˆ¶å¾¡ï¼‰ â”€â”€ */
#mascotStage{
  margin-top:12px; position:relative; height:200px;
  border:1px solid var(--line); border-radius:14px; background:rgba(255,255,255,.6);
  overflow:hidden;
}
#mascotCanvas{position:absolute; inset:0}

/* â”€â”€ èƒŒæ™¯ãƒ†ãƒ¼ãƒåˆ‡æ›¿ï¼ˆdata-themeã§åˆ‡æ›¿ï¼‰ â”€â”€ */
main[data-theme="morning"]{background:var(--bg-morning)}
main[data-theme="evening"]{background:var(--bg-evening)}
main[data-theme="night"]  {background:var(--bg-night)}
/* headerã¯é€ã‘ã‚‹ã®ã§bodyã«åˆã‚ã›ä¸è¦ */
</style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <h1>ã‚†ã‚‹ã‚­ãƒ£ãƒ©é£²é…’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
      <div class="modeTabs" id="modeTabs">
        <button class="tabBtn active" data-mode="home">å®¶é£²ã¿</button>
        <button class="tabBtn" data-mode="out">å¤–é£Ÿ</button>
      </div>
    </div>
  </header>

  <main id="app" data-theme="morning">
    <div class="wrap">
      <!-- ã‚¢ãƒ—ãƒªå†…ã‚¿ãƒ–ï¼ˆå…¥åŠ› / å±¥æ­´ï¼‰ -->
      <div class="appTabs" id="appTabs">
        <button class="appTabBtn active" data-view="input">å…¥åŠ›</button>
        <button class="appTabBtn" data-view="history">å±¥æ­´</button>
      </div>

      <!-- ä¸Šéƒ¨ã‚µãƒãƒªãƒ¼ -->
      <section id="summary" class="card" style="margin-top:10px;">
        <div class="tinySaved" id="tinySaved">ä»Šæ—¥ã¯ Â¥0 ã‚»ãƒ¼ãƒ–ï¼ˆè¡¨ç¤ºä¾‹ï¼‰</div>
        <div class="summaryRow">
          <div class="kpi"><div class="label">ç·é‡</div><div class="value" id="sumLiters">0.0 L</div></div>
          <div class="kpi"><div class="label">ç´”ã‚¢ãƒ«</div><div class="value" id="sumGrams">0 g</div></div>
          <div class="kpi"><div class="label">æ¦‚ç®—é‡‘é¡</div><div class="value" id="sumYen">Â¥0</div></div>
          <div class="kpi">
            <div class="label">åˆ†è§£é€²æ—</div>
            <div id="decompWrap">
              <div id="decompBar"><div id="decompMask" style="width:0%"></div></div>
              <div>
                <div id="decompText">æ®‹é‡ 0%</div>
                <div id="eta">0%è¦‹è¾¼ã¿ --:--</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- å…¥åŠ›ãƒ“ãƒ¥ãƒ¼ -->
      <section id="inputView" class="card" style="margin-top:12px;">
        <div class="sectionTitle"><b>é£²ã¿ç‰©ã‚’ã‚¿ãƒƒãƒ—ã§è¿½åŠ ï¼ˆå·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã§-1 / é•·æŠ¼ã—ã§ç·¨é›†ï¼‰</b></div>
        <div class="grid" id="presetGrid"></div>
      </section>

      <!-- å±¥æ­´ãƒ“ãƒ¥ãƒ¼ï¼ˆå¾Œç¶šJSã§åˆ‡æ›¿è¡¨ç¤ºï¼†æç”»ï¼‰ -->
      <section id="historyView" class="card" style="margin-top:12px;">
        <div class="historyHead">
          <div class="rangeTabs" id="rangeTabs">
            <button class="tabBtn active" data-range="30d">ç›´è¿‘30æ—¥</button>
            <button class="tabBtn" data-range="12m">éå»12ã‹æœˆ</button>
          </div>
          <div class="tinySaved" id="tinySavedHistory">ä»Šæœˆ Â¥0 ã‚»ãƒ¼ãƒ–ï¼ˆè¡¨ç¤ºä¾‹ï¼‰</div>
        </div>
        <div style="margin-top:8px">
          <canvas id="chart" class="chartCanvas"></canvas>
        </div>

        <!-- ã‚†ã‚‹ã‚­ãƒ£ãƒ©èˆå°ï¼ˆã‚°ãƒ©ãƒ•ä¸‹ï¼‰ï¼šæ—¥/æœˆã«é€£å‹•ã€ã‚³ãƒŸã‚«ãƒ«è¡¨ç¾ -->
        <div id="mascotStage">
          <canvas id="mascotCanvas"></canvas>
        </div>
      </section>

    </div>

    <div class="fixedBar">
      <div class="wrap fixedStats">
        <div class="kv">ä»Šæ—¥ã®ç´”ã‚¢ãƒ«ï¼š<b id="gToday">0</b> g</div>
        <div class="kv">ä»Šæ—¥ã®é£²ã¿ä»£ï¼š<b id="yenToday">0</b> å††</div>
        <div class="kv">æ®‹é‡ï¼š<b id="leftPct">0%</b>ï¼ˆ0%æ™‚åˆ» <span id="zeroEta">--:--</span>ï¼‰</div>
        <div class="small">ç¿Œæ—¥10:00ç· åˆ‡ï¼æ®‹é‡ãƒãƒ¼ã¯å‰æ—¥ç¶™ç¶š</div>
      </div>
    </div>
  </main>

<script>
/* =========================
   å®šæ•°ãƒ»ä¿å­˜ã‚­ãƒ¼ãƒ»åˆæœŸãƒ‡ãƒ¼ã‚¿
   ========================= */
const LS_KEY_LOGS     = 'drink_logs_v1';        // { 'YYYY-MM-DD': [ {id, ml, abv, price, count, ts} ] }
const LS_KEY_PRESETS  = 'drink_presets_v1';     // { home:[], out:[] }
const LS_KEY_PROFILE  = 'drink_profile_v1';     // { weightKg, k }
const LS_KEY_SETTINGS = 'drink_settings_v1';    // { cutoffHour }
const CUTOFF_HOUR_DEFAULT = 10; // ç¿Œæ—¥10:00ç· åˆ‡

/* ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆåˆ†è§£ç”¨ï¼‰ */
const DEFAULT_PROFILE = { weightKg: 70, k: 0.1 };// g/h/kg

/* å®¶é£²ã¿ï¼ˆã‚³ãƒ³ãƒ“ãƒ‹ä¾¡æ ¼ï¼‰â€»ç™ºæ³¡é…’ã‚ã‚Šï¼ç„¼é…ãƒ­ãƒƒã‚¯ãƒ»æ°´å‰²ã‚Š */
const PRESETS_HOME = [
  { id:'beer350',   name:'ãƒ“ãƒ¼ãƒ« 350ml',   ml:350, abv:5,  price:220, color:'#fff2cc' },
  { id:'beer500',   name:'ãƒ“ãƒ¼ãƒ« 500ml',   ml:500, abv:5,  price:300, color:'#ffe8b3' },
  { id:'happoshu350', name:'ç™ºæ³¡é…’ 350ml', ml:350, abv:5,  price:160, color:'#f8ffcc' },
  { id:'happoshu500', name:'ç™ºæ³¡é…’ 500ml', ml:500, abv:5,  price:210, color:'#f0ff99' },
  { id:'chuhi350',  name:'ãƒãƒ¥ãƒ¼ãƒã‚¤ 350ml', ml:350, abv:9, price:160, color:'#e8f4ff' },
  { id:'chuhi500',  name:'ãƒãƒ¥ãƒ¼ãƒã‚¤ 500ml', ml:500, abv:9, price:210, color:'#d9ecff' },
  { id:'highball350', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«ç¼¶ 350ml', ml:350, abv:7, price:180, color:'#f0f7ff' },
  { id:'sake180',   name:'æ—¥æœ¬é…’ 1åˆ 180ml', ml:180, abv:15, price:300, color:'#fafafa' },
  { id:'wine150',   name:'ãƒ¯ã‚¤ãƒ³ 1æ¯ 150ml', ml:150, abv:12, price:250, color:'#ffeaf3' },
  { id:'shaoxing90', name:'ç´¹èˆˆé…’ 1æ¯ 90ml', ml:90, abv:16, price:250, color:'#ffeee0' },
  { id:'shochu_rock', name:'ç„¼é… ãƒ­ãƒƒã‚¯ 90ml', ml:90, abv:25, price:180, color:'#ffe0f0' },
  { id:'shochu_mizu', name:'ç„¼é… æ°´å‰²ã‚Š 120ml', ml:120, abv:15, price:180, color:'#eaf9ff' }
];

/* å¤–é£Ÿï¼ˆå¤§è¡†å±…é…’å±‹ä¾¡æ ¼ï¼‰â€»ç„¼é…ãƒ­ãƒƒã‚¯ãƒ»æ°´å‰²ã‚Š */
const PRESETS_OUT = [
  { id:'draft500',  name:'ç”Ÿãƒ“ãƒ¼ãƒ« ä¸­ 500ml', ml:500, abv:5, price:500, color:'#ffe8b3' },
  { id:'chuhi350o', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤ 350ml',   ml:350, abv:8, price:350, color:'#e8f4ff' },
  { id:'highball300', name:'ãƒã‚¤ãƒœãƒ¼ãƒ« 300ml', ml:300, abv:7, price:400, color:'#f0f7ff' },
  { id:'sake180o',  name:'æ—¥æœ¬é…’ 1åˆ 180ml',  ml:180, abv:15, price:400, color:'#fafafa' },
  { id:'wine120o',  name:'ãƒ¯ã‚¤ãƒ³ ã‚°ãƒ©ã‚¹ 120ml', ml:120, abv:12, price:400, color:'#ffeaf3' },
  { id:'shaoxing90o', name:'ç´¹èˆˆé…’ 1æ¯ 90ml', ml:90, abv:16, price:350, color:'#ffeee0' },
  { id:'shochu_rock_o', name:'ç„¼é… ãƒ­ãƒƒã‚¯ 90ml', ml:90, abv:25, price:400, color:'#ffe0f0' },
  { id:'shochu_mizu_o', name:'ç„¼é… æ°´å‰²ã‚Š 150ml', ml:150, abv:13, price:400, color:'#eaf9ff' }
];

/* æ—¢å®šã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ãƒƒãƒˆ */
const DEFAULT_PRESETS = { home: PRESETS_HOME, out: PRESETS_OUT };

/* ä¿å­˜/èª­è¾¼ */
const load = (k, d) => {
  try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? d }catch(_){ return d }
}
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* å…±æœ‰ã‚¹ãƒ†ãƒ¼ãƒˆ */
let state = {
  mode: 'home',                       // 'home' | 'out'
  view: 'input',                      // 'input' | 'history'
  presets: load(LS_KEY_PRESETS, DEFAULT_PRESETS),
  profile: load(LS_KEY_PROFILE, DEFAULT_PROFILE),
  settings: load(LS_KEY_SETTINGS, { cutoffHour: CUTOFF_HOUR_DEFAULT }),
  logs: load(LS_KEY_LOGS, {}),        // { 'YYYY-MM-DD': [entries] }
  undo: []
};

/* =========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* æ—¥ä»˜ï¼šä»Šæ—¥/æ˜¨æ—¥ã€ç· åˆ‡å‡¦ç†ã«å¿…è¦ */
function yyyy_mm_dd(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
}
function nowLocal(){ return new Date(); }
function todayKey(){ return yyyy_mm_dd(nowLocal()); }
function yesterdayKey(){
  const d = nowLocal(); d.setDate(d.getDate()-1); return yyyy_mm_dd(d);
}
/* ç¿Œæ—¥10:00ç· åˆ‡ï¼š10:00æœªæº€ãªã‚‰â€œå‰æ—¥â€ã‚’ã¾ã å…¥åŠ›å¯¾è±¡ã«å«ã‚ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã§ä½¿ç”¨ */
function isBeforeCutoff(){
  const h = nowLocal().getHours();
  return h < (state.settings.cutoffHour ?? CUTOFF_HOUR_DEFAULT);
}

/* å°è¨ˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function toYen(n){ return 'Â¥' + (n|0).toLocaleString() }
function round1(n){ return Math.round(n*10)/10 }
function round2(n){ return Math.round(n*100)/100 }

/* ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«(g) */
function pureAlcoholG(ml, abv){ return round2(ml * (abv/100) * 0.8) }

/* åˆè¨ˆç®—å‡º */
function sumDay(key){
  const arr = state.logs[key] || [];
  let ml = 0, g = 0, yen = 0;
  arr.forEach(it=>{
    const c = it.count || 1;
    ml  += (it.ml||0) * c;
    g   += pureAlcoholG(it.ml, it.abv) * c;
    yen += (it.price||0) * c;
  });
  return { ml, g:round2(g), yen: yen|0, liters: round1(ml/1000) };
}

/* åˆ†è§£ãƒ¢ãƒ‡ãƒ«ï¼šETA/æ®‹é‡ï¼ˆå‰æ—¥ç¶™ç¶šãƒ­ã‚¸ãƒƒã‚¯ã¯æœ¬ä½“ã§åˆ¶å¾¡ï¼‰ */
function decompRateGph(){
  const w = state.profile.weightKg || 70;
  const k = state.profile.k || 0.1;
  return w * k; // g/h
}
function etaFromNowByG(totalG){
  const rate = decompRateGph();
  if(totalG<=0 || rate<=0) return '--:--';
  const hours = totalG / rate;
  const eta = new Date(Date.now() + hours*3600*1000);
  const hh = String(eta.getHours()).padStart(2,'0');
  const mm = String(eta.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

/* ãƒ†ãƒ¼ãƒï¼ˆæœå¤•å¤œï¼‰åˆ‡æ›¿ï¼šèµ·å‹•æ™‚é–“ã«å¿œã˜ã¦ */
function applyTimeTheme(){
  const h = nowLocal().getHours();
  const main = $('#app');
  let theme = 'morning';
  if(h>=12 && h<18) theme = 'evening';
  else if(h>=18 || h<5) theme = 'night';
  main.setAttribute('data-theme', theme);
}

/* ã‚¿ãƒ–UIã®è¦‹ãŸç›®æ›´æ–° */
function setAppView(view){
  state.view = view;
  $('#inputView').style.display   = (view==='input') ? 'block' : 'none';
  $('#historyView').style.display = (view==='history') ? 'block' : 'none';
  $$('#appTabs .appTabBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.view===view);
  });
}

/* å®¶é£²ã¿/å¤–é£Ÿã‚¿ãƒ–åˆ‡æ›¿ */
function setMode(mode){
  state.mode = mode; // 'home' | 'out'
  $$('#modeTabs .tabBtn').forEach(b=>{
    b.classList.toggle('active', b.dataset.mode===mode);
  });
  renderPresetTiles();
  refreshTodaySummary();
}

/* =========================
   å…¥åŠ›ã‚¿ã‚¤ãƒ«ã®ç”Ÿæˆï¼ˆã‚¿ãƒƒãƒ—+ / å·¦ã‚¹ãƒ¯ã‚¤ãƒ—- / é•·æŠ¼ã—ç·¨é›†ï¼‰
   ========================= */
const gridEl = $('#presetGrid');

function renderPresetTiles(){
  const list = state.presets[state.mode] || [];
  gridEl.innerHTML = '';
  // ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆåˆ†ã‚’å…ˆã«é›†è¨ˆã—ã¦ãƒãƒƒã‚¸ã«åæ˜ 
  const key = isBeforeCutoff() ? yesterdayKey() : todayKey(); // 10æ™‚å‰ã¯ã€Œå‰æ—¥ã€ã‚’å…¥åŠ›å¯¾è±¡ã«ã™ã‚‹ä»•æ§˜ã«åˆã‚ã›ã‚‰ã‚Œã‚‹
  const arr = state.logs[key] || [];
  const counts = {};
  arr.forEach(e => counts[e.id] = (counts[e.id]||0) + (e.count||1));

  list.forEach(p=>{
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.style.background = p.color || '#fff';
    tile.dataset.id = p.id;
    tile.innerHTML = `
      <div class="name">${p.name}</div>
      <div class="meta">${p.ml}ml / ${p.abv}% ãƒ» ç´„${toYen(p.price)}</div>
      <div class="badge" data-badge>0</div>
      <div class="swipeHint">â†ã§-1 / é•·æŠ¼ã—ã§ç·¨é›†</div>
    `;
    attachTileHandlers(tile, p);
    gridEl.appendChild(tile);
  });

  // åˆæœŸãƒãƒƒã‚¸åæ˜ 
  gridEl.querySelectorAll('.tile').forEach(t=>{
    const id = t.dataset.id; const n = counts[id]||0;
    t.querySelector('[data-badge]').textContent = n;
  });
}

/* ã‚¿ã‚¤ãƒ«æ“ä½œãƒãƒ³ãƒ‰ãƒ©ã®é››å½¢ï¼ˆæœ¬ä½“ãƒ­ã‚¸ãƒƒã‚¯ã¯æ¬¡ãƒ–ãƒ­ãƒƒã‚¯ã§ï¼‰ */
function attachTileHandlers(tile, preset){
  let startX=null, swiping=false, longPressTimer=null;

  const onTap = ()=>{
    if(swiping) return;
    // æœ¬ä½“ã§å®Ÿè£…ï¼šaddOne(preset)
    window.dispatchEvent(new CustomEvent('ui:addOne', { detail: { preset } }));
  };

  const onTouchStart = (e)=>{
    swiping=false;
    startX = e.touches?.[0]?.clientX ?? null;
    longPressTimer = setTimeout(()=>{ longPressTimer=null; editPreset(preset.id); }, 500);
  };
  const onTouchMove = (e)=>{
    if(startX==null) return;
    const dx = (e.touches?.[0]?.clientX ?? 0) - startX;
    if(dx < -30){ // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ -1
      swiping = true;
      window.dispatchEvent(new CustomEvent('ui:removeOne', { detail: { presetId: preset.id }}));
      startX=null;
      clearTimeout(longPressTimer); longPressTimer=null;
    }
  };
  const onTouchEnd = ()=>{
    if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer=null; onTap(); }
    startX=null;
    setTimeout(()=>{ swiping=false; }, 50);
  };

  // ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚æ“ä½œå¯èƒ½
  tile.addEventListener('click', onTap);
  tile.addEventListener('touchstart', onTouchStart, {passive:true});
  tile.addEventListener('touchmove', onTouchMove, {passive:true});
  tile.addEventListener('touchend', onTouchEnd);
}

/* ãƒ—ãƒªã‚»ãƒƒãƒˆé•·æŠ¼ã—ç·¨é›†ï¼ˆç°¡æ˜“ï¼‰ */
function editPreset(id){
  const list = state.presets[state.mode] || [];
  const p = list.find(x=>x.id===id);
  if(!p) return;
  const name = prompt('è¡¨ç¤ºå', p.name); if(name===null) return;
  const ml   = +prompt('å®¹é‡(ml)', p.ml); if(Number.isNaN(ml)) return;
  const abv  = +prompt('åº¦æ•°(%)', p.abv); if(Number.isNaN(abv)) return;
  const price= +prompt('å˜ä¾¡(å††)', p.price); if(Number.isNaN(price)) return;
  p.name=name; p.ml=ml; p.abv=abv; p.price=price;
  save(LS_KEY_PRESETS, state.presets);
  renderPresetTiles();
}

/* UIã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå…¥åŠ›/å±¥æ­´ã‚¿ãƒ–åˆ‡æ›¿ã€å®¶/å¤–åˆ‡æ›¿ï¼‰ */
$('#appTabs').addEventListener('click', (e)=>{
  const btn = e.target.closest('.appTabBtn'); if(!btn) return;
  setAppView(btn.dataset.view);
});
$('#modeTabs').addEventListener('click', (e)=>{
  const b = e.target.closest('.tabBtn'); if(!b) return;
  setMode(b.dataset.mode);
});
$('#rangeTabs').addEventListener('click', (e)=>{
  const b = e.target.closest('.tabBtn'); if(!b) return;
  $$('#rangeTabs .tabBtn').forEach(x=>x.classList.toggle('active', x===b));
  // å¾Œç¶šãƒ–ãƒ­ãƒƒã‚¯ã§ã‚°ãƒ©ãƒ•æç”»å‡¦ç†ã‚’å‘¼ã¶
  window.dispatchEvent(new CustomEvent('ui:rangeChange', { detail: { range: b.dataset.range }}));
});

/* åˆæœŸãƒ†ãƒ¼ãƒï¼†åˆæœŸãƒ“ãƒ¥ãƒ¼é©ç”¨ */
applyTimeTheme();
setAppView('input');
setMode('home'); // renderPresetTiles() å†…ã§ã¾ã¨ã‚ã¦è¡¨ç¤ºæ›´æ–°

/* ===== ã“ã“ã‹ã‚‰å…ˆï¼ˆã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ä¿å­˜ãƒ»åˆ†è§£ãƒãƒ¼ãƒ»ä»Šæ—¥/ä»Šæœˆé›†è¨ˆãƒ»ã‚°ãƒ©ãƒ•ãƒ»ãƒã‚¹ã‚³ãƒƒãƒˆæç”»ãªã©ï¼‰ã¯
         æ¬¡ã® 2/3, 3/3 ã§å®Ÿè£…ã—ã¾ã™ ===== */
</script>


<script>
/* =========================
   2/3: ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
   - è¿½åŠ /å‰Šé™¤ & ä¿å­˜
   - ç¿Œæ—¥10æ™‚ç· åˆ‡ï¼ˆå…¥åŠ›å¯¾è±¡æ—¥ã®æ±ºå®šï¼‰
   - ã‚µãƒãƒªãƒ¼ï¼ˆL/g/Â¥ï¼‰æ›´æ–°
   - åˆ†è§£ãƒãƒ¼ï¼ˆå‰æ—¥ç¶™ç¶šï¼‰è¨ˆç®—ãƒ»åæ˜ 
   - æµ®ã„ãŸãŠé‡‘ï¼ˆå°è¡¨ç¤ºï¼‰
   - å±¥æ­´é›†è¨ˆãƒ‡ãƒ¼ã‚¿ï¼ˆ30æ—¥/12ã‹æœˆï¼‰æ•´å½¢
   ========================= */

/* å…¥åŠ›å¯¾è±¡æ—¥ï¼ˆç¿Œæ—¥10:00ã¾ã§ã¯å‰æ—¥ã‚’é–‹æ”¾ï¼‰ */
function activeInputKey(){
  return isBeforeCutoff() ? yesterdayKey() : todayKey();
}

/* ãƒ­ã‚°ã®æ“ä½œ */
function ensureDay(key){ state.logs[key] = state.logs[key] || []; return state.logs[key] }

function addOne(preset){
  const key = activeInputKey();
  const arr = ensureDay(key);
  arr.push({ id:preset.id, ml:preset.ml, abv:preset.abv, price:preset.price, count:1, ts: Date.now() });
  save(LS_KEY_LOGS, state.logs);
  state.undo.push({ type:'add', key, entryId:preset.id });
  onDataChanged();
}

function removeOne(presetId){
  const key = activeInputKey();
  const arr = ensureDay(key);
  for(let i=arr.length-1;i>=0;i--){
    if(arr[i].id===presetId){
      const removed = arr.splice(i,1)[0];
      save(LS_KEY_LOGS, state.logs);
      state.undo.push({ type:'remove', key, entry: removed });
      onDataChanged();
      return true;
    }
  }
  return false;
}

/* UIã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1/3ã§ç™ºç«ï¼‰ */
window.addEventListener('ui:addOne', (e)=> addOne(e.detail.preset));
window.addEventListener('ui:removeOne', (e)=> removeOne(e.detail.presetId));

/* ä»Šæ—¥/å‰æ—¥ã®åˆè¨ˆï¼ˆã‚µãƒãƒªãƒ¼è¡¨ç¤ºç”¨ï¼‰ */
function refreshTodaySummary(){
  // ã€Œå½“æ—¥åˆè¨ˆã€ã¯â€œä»Šæ—¥ã®ã‚­ãƒ¼â€ã§å‡ºã™
  const today = todayKey();
  const t   = sumDay(today);
  $('#gToday').textContent = t.g;
  $('#yenToday').textContent = t.yen.toLocaleString();
  $('#sumLiters').textContent = `${t.liters.toFixed(1)} L`;
  $('#sumGrams').textContent = `${t.g} g`;
  $('#sumYen').textContent = toYen(t.yen);

  // æ®‹é‡ãƒãƒ¼ã¯ã€Œæ˜¨æ—¥ or ä»Šæ—¥ã€ã®â€œç›´è¿‘é£²é…’æ—¥ã®æœ€å¾Œã®æ™‚åˆ»â€ã§é€²æ—ã‚’å‡ºã™
  refreshDecompBar();

  // ã‚¿ã‚¤ãƒ«ã®ãƒãƒƒã‚¸å†æç”»ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ã§ã‚«ã‚¦ãƒ³ãƒˆï¼‰
  renderPresetTiles();

  // æ¥µå°ã®ã€Œæµ®ã„ãŸãŠé‡‘ã€è¡¨ç¤º
  renderTinySaved();
}

/* åˆ†è§£ãƒãƒ¼ï¼ˆæ¨ªæ£’ï¼‰ãƒ­ã‚¸ãƒƒã‚¯
   - æ˜¨æ—¥â†’ä»Šæ—¥ã‚’ã¾ãŸã„ã§ã‚‚â€œå‰æ—¥ã®æœ€å¾Œã®é£²é…’æ™‚åˆ»â€ã‹ã‚‰æ¸›è¡°ç¶™ç¶š
   - æ¡ä»¶ï¼šæ˜¨æ—¥ã«é£²é…’ãŒã‚ã‚Œã°ã€Œæ˜¨æ—¥ã€ã‚’å„ªå…ˆã€ç„¡ã‘ã‚Œã°ä»Šæ—¥ã‚’å‚ç…§
*/
function refreshDecompBar(){
  const yKey = yesterdayKey(), tKey = todayKey();
  const pick = (state.logs[yKey] && state.logs[yKey].length>0) ? yKey : tKey;
  const arr = state.logs[pick] || [];
  if(arr.length===0){
    // ä½•ã‚‚é£²ã‚“ã§ãªã‘ã‚Œã°ã‚¼ãƒ­è¡¨ç¤º
    setDecompUI(0, '--:--');
    return;
  }
  const totals = sumDay(pick);
  const rate = decompRateGph(); // g/h
  // æœ€çµ‚é£²é…’æ™‚åˆ»ï¼ˆentriesã®tsæœ€å¤§ï¼‰
  const lastTs = Math.max(...arr.map(x=> x.ts || Date.now()));
  const hoursSince = (Date.now() - lastTs) / 3600000;
  const remainG = Math.max(0, totals.g - rate * hoursSince);
  const pct = totals.g > 0 ? Math.max(0, Math.min(100, Math.round(remainG / totals.g * 100))) : 0;

  // ETA = æœ€çµ‚é£²é…’æ™‚åˆ» + totals.g/rate
  let etaStr = '--:--';
  if(rate>0 && totals.g>0){
    const eta = new Date(lastTs + (totals.g/rate)*3600*1000);
    const hh = String(eta.getHours()).padStart(2,'0');
    const mm = String(eta.getMinutes()).padStart(2,'0');
    etaStr = `${hh}:${mm}`;
  }
  setDecompUI(pct, etaStr);
}

function setDecompUI(pct, etaStr){
  // pct% ã‚’æ®‹é‡ã¨ã—ã¦è¡¨ç¤ºï¼ˆãƒãƒ¼ã¯å³ã‹ã‚‰ç™½ãƒã‚¹ã‚¯ã§æ¸›ã‚‰ã™ï¼‰
  $('#decompMask').style.width = `${100-pct}%`;
  $('#decompText').textContent = `æ®‹é‡ ${pct}%`;
  $('#eta').textContent = `0%è¦‹è¾¼ã¿ ${etaStr}`;
  $('#leftPct').textContent = `${pct}%`;
  $('#zeroEta').textContent = etaStr;
}

/* ã€Œæµ®ã„ãŸãŠé‡‘ã€ãƒŸãƒ‹è¡¨ç¤º
   - æœˆäºˆç®—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ12,000å††ï¼‰ã¨å½“æœˆå®Ÿç¸¾ã®å·®
   - å°ã•ãä¸€è¡Œã€æ—¥/æœˆã§è¡¨ç¾ã‚’å°‘ã—å¤‰ãˆã‚‹
*/
const DEFAULT_MONTHLY_BUDGET = 12000;
function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` }
function sumMonthYen(year, month){
  // month: 0-11
  let yen = 0;
  for(const key in state.logs){
    const d = new Date(key);
    if(d.getFullYear()===year && d.getMonth()===month){
      yen += sumDay(key).yen;
    }
  }
  return yen|0;
}
const UNITS_DAY = [
  { label:'ã‚³ãƒ¼ãƒ’ãƒ¼', yen:120, unit:'æ¯' },
  { label:'ãŠã«ãã‚Š', yen:150, unit:'å€‹' },
  { label:'ãƒ©ãƒ¼ãƒ¡ãƒ³', yen:800, unit:'æ¯' },
  { label:'ãƒ¡ãƒ€ã‚«ã®é¤Œ', yen:300, unit:'è¢‹' },
];
const UNITS_MONTH = [
  { label:'å¯¿å¸', yen:120, unit:'çš¿' },
  { label:'æ˜ ç”»', yen:1800, unit:'æœ¬' },
  { label:'ç„¼è‚‰', yen:1000, unit:'äººå‰' },
  { label:'ã‚¬ã‚½ãƒªãƒ³', yen:3000, unit:'åŠã‚¿ãƒ³ã‚¯' },
];

function renderTinySaved(){
  const now = nowLocal();
  const y = now.getFullYear(), m = now.getMonth();
  const budget = (state.settings.monthlyBudget ?? DEFAULT_MONTHLY_BUDGET)|0;
  const spent = sumMonthYen(y, m);
  const saved = Math.max(0, budget - spent);
  const daySum = sumDay(todayKey());
  const tinyDay = $('#tinySaved');
  const tinyMonth = $('#tinySavedHistory');

  // æ—¥è¡¨ç¤ºï¼ˆä»Šæ—¥ç¯€ç´„åˆ†ã®è»½ã„éŠã³ï¼‰: å®¶é£²ã¿å·®é¡ãªã©ã¯å°†æ¥æ‹¡å¼µã€ã“ã“ã§ã¯ã€Œäºˆç®—æ—¥å‰²ã‚Š-ä»Šæ—¥ã®æ”¯å‡ºã€ã‚’ç°¡æ˜“ã«
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const budgetPerDay = Math.round(budget / daysInMonth);
  const savedToday = Math.max(0, budgetPerDay - daySum.yen);
  if(savedToday >= 200){
    const u = UNITS_DAY[Math.floor(hashSeed(todayKey()) % UNITS_DAY.length)];
    const n = Math.max(1, Math.floor(savedToday / u.yen));
    tinyDay.textContent = `ä»Šæ—¥ã¯ ${toYen(savedToday)} ã‚»ãƒ¼ãƒ–ï¼ˆ${u.label} Ã— ${n}ï¼‰`;
  }else{
    tinyDay.textContent = '';
  }

  // æœˆè¡¨ç¤ºï¼ˆå±¥æ­´ãƒ“ãƒ¥ãƒ¼å´ï¼‰
  if(saved >= 200){
    const u2 = UNITS_MONTH[Math.floor(hashSeed(monthKey(now)) % UNITS_MONTH.length)];
    const n2 = Math.max(1, Math.floor(saved / u2.yen));
    tinyMonth.textContent = `ä»Šæœˆ ${toYen(saved)} ã‚»ãƒ¼ãƒ–ï¼ˆ${u2.label} Ã— ${n2}ï¼‰`;
  }else{
    tinyMonth.textContent = '';
  }
}

/* ä¹±æ•°ã®å›ºå®šåŒ–ï¼ˆåŒæ—¥ãƒ»åŒæœˆä¸­ã¯è¡¨ç¤ºãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
function hashSeed(s){
  let h = 2166136261>>>0;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619)>>>0; }
  return h % 1e9;
}

/* ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã®å†æç”»ä¸€æ‹¬ */
function onDataChanged(){
  refreshTodaySummary();
  // å±¥æ­´ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦ã€æ¬¡ï¼ˆ3/3ï¼‰ã®ã‚°ãƒ©ãƒ•æç”»ã¸æ¸¡ã™
  const payload = buildHistoryDatasets();
  window.dispatchEvent(new CustomEvent('data:updated', { detail: payload }));
}

/* å±¥æ­´ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆ30æ—¥ï¼šæ—¥åˆ¥ã€12ã‹æœˆï¼šæœˆåˆ¥ï¼‰ */
function buildHistoryDatasets(){
  const today = nowLocal();
  // 30æ—¥æ—¥åˆ¥
  const daily = [];
  for(let i=29;i>=0;i--){
    const d = new Date(today); d.setDate(d.getDate()-i);
    const key = yyyy_mm_dd(d);
    const s = sumDay(key);
    daily.push({ key, date:new Date(d), g:s.g, yen:s.yen });
  }
  // 12ã‹æœˆæœˆåˆ¥
  const monthly = [];
  for(let i=11;i>=0;i--){
    const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
    const y = d.getFullYear(), m = d.getMonth();
    let g=0, yen=0;
    // ãã®æœˆã®å…¨æ—¥ã‚’åˆç®—
    for(const key in state.logs){
      const kd = new Date(key);
      if(kd.getFullYear()===y && kd.getMonth()===m){
        const s = sumDay(key);
        g += s.g; yen += s.yen;
      }
    }
    monthly.push({ ym:`${y}-${String(m+1).padStart(2,'0')}`, year:y, month:m, g:round2(g), yen: yen|0 });
  }
  return { daily, monthly };
}

/* 1åˆ†ã”ã¨ã«åˆ†è§£ãƒãƒ¼ã‚’æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ï¼‰ */
setInterval(refreshDecompBar, 60000);

/* åˆæœŸèµ·å‹•ï¼šã‚µãƒãƒªãƒ¼/å±¥æ­´ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ç™ºç« */
onDataChanged();

/* å±¥æ­´ãƒ¬ãƒ³ã‚¸åˆ‡æ›¿ï¼ˆ1/3ã§ç™ºç«ï¼‰â†’ 3/3ã®æç”»ã§ä½¿ç”¨ */
window.addEventListener('ui:rangeChange', ()=>{
  const payload = buildHistoryDatasets();
  window.dispatchEvent(new CustomEvent('data:updated', { detail: payload }));
});
</script>


<script>
/* =========================
   3/3: ã‚°ãƒ©ãƒ• & ã‚†ã‚‹ã‚­ãƒ£ãƒ©æç”»
   - äºŒè»¸ã‚°ãƒ©ãƒ•ï¼ˆå·¦=gæ£’ã€å³=Â¥æŠ˜ã‚Œç·šï¼‰
   - ç›´è¿‘30æ—¥/12ã‹æœˆåˆ‡æ›¿
   - æ£’ã‚¯ãƒªãƒƒã‚¯ã§ãã®æ—¥ã®ã‚­ãƒ£ãƒ©ã¸åˆ‡æ›¿ï¼ˆã‚³ãƒŸã‚«ãƒ«è¡¨ç¾ï¼‰
   - æœˆæ£’ã‚¯ãƒªãƒƒã‚¯ã§æœˆæ¬¡ã¾ã¨ã‚ã‚­ãƒ£ãƒ©
   - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«å†æç”»
   ========================= */

let lastPayload = { daily:[], monthly:[] };
let currentRange = '30d';
const chart = $('#chart');
const ctx = chart.getContext('2d');
const mascCanvas = $('#mascotCanvas');
const mctx = mascCanvas.getContext('2d');

/* DPRå¯¾å¿œã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚µã‚¤ã‚º */
function fitCanvas(canvas, cssW, cssH){
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  return dpr;
}
function layoutCanvases(){
  const chartBox = chart.getBoundingClientRect();
  const mascBox  = mascCanvas.parentElement.getBoundingClientRect();
  fitCanvas(chart, Math.max(320, chartBox.width), Math.max(220, chartBox.height));
  fitCanvas(mascCanvas, Math.max(320, mascBox.width), Math.max(160, mascBox.height));
}

/* è»½ã„æç”»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function line(ctx,x1,y1,x2,y2,w=1,style='#94a3b8'){ ctx.beginPath(); ctx.lineWidth=w; ctx.strokeStyle=style; ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
function text(ctx, s, x, y, size=12, color='#334155', align='left'){ ctx.fillStyle=color; ctx.font=`${size}px system-ui, -apple-system, Segoe UI, Roboto`; ctx.textAlign=align; ctx.textBaseline='middle'; ctx.fillText(s,x,y); }
function roundRect(ctx,x,y,w,h,r, fill, stroke){ ctx.beginPath(); const rr=Math.min(r,Math.min(w,h)/2);
  ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr);
  if(fill){ctx.fillStyle=fill; ctx.fill();} if(stroke){ctx.strokeStyle=stroke; ctx.stroke();}
}

/* ç¾åœ¨ã®ãƒ¬ãƒ³ã‚¸ã«å¿œã˜ã¦æç”» */
function drawChart(){
  layoutCanvases();
  ctx.clearRect(0,0,chart.width,chart.height);
  const dpr = window.devicePixelRatio || 1;
  const W = chart.width, H = chart.height;
  const padL = 48*dpr, padR = 52*dpr, padT = 18*dpr, padB = 28*dpr;

  const area = { x:padL, y:padT, w:W-padL-padR, h:H-padT-padB };

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  const data = (currentRange==='30d') ? lastPayload.daily : lastPayload.monthly;
  if(!data || data.length===0){ text(ctx,'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', W/2, H/2, 14*dpr, '#64748b', 'center'); return; }

  // ã‚¹ã‚±ãƒ¼ãƒ«
  const maxG = Math.max(10, ...data.map(d=>d.g));
  const maxY = Math.max(1000, ...data.map(d=>d.yen));
  const barW = Math.max(6*dpr, Math.min(20*dpr, area.w / (data.length*1.3)));

  // è»¸
  ctx.globalAlpha = 1;
  line(ctx, area.x, area.y, area.x, area.y+area.h, 1*dpr, '#cbd5e1'); // yå·¦
  line(ctx, area.x+area.w, area.y, area.x+area.w, area.y+area.h, 1*dpr, '#cbd5e1'); // yå³
  line(ctx, area.x, area.y+area.h, area.x+area.w, area.y+area.h, 1*dpr, '#cbd5e1'); // x

  // ç›®ç››ï¼ˆå·¦ï¼šg 4æœ¬ï¼‰
  for(let i=0;i<=4;i++){
    const gy = area.y + area.h - (i/4)*area.h;
    line(ctx, area.x, gy, area.x+area.w, gy, 1*dpr, '#eef2f7');
    const gv = Math.round((i/4)*maxG);
    text(ctx, `${gv}g`, area.x-6*dpr, gy, 11*dpr, '#64748b', 'right');
  }
  // ç›®ç››ï¼ˆå³ï¼šÂ¥ 4æœ¬ï¼‰
  for(let i=0;i<=4;i++){
    const gy = area.y + area.h - (i/4)*area.h;
    const yv = Math.round((i/4)*maxY);
    text(ctx, `Â¥${(yv|0).toLocaleString()}`, area.x+area.w+6*dpr, gy, 11*dpr, '#64748b', 'left');
  }

  // æ£’ï¼ˆgï¼‰
  const step = area.w / data.length;
  const bars = []; // ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨
  ctx.fillStyle = '#93c5fd';
  data.forEach((d, i)=>{
    const x = area.x + i*step + (step - barW)/2;
    const h = d.g / maxG * area.h;
    const y = area.y + area.h - h;
    roundRect(ctx, x, y, barW, h, 3*dpr, '#93c5fd');
    bars.push({ i, x, y, w:barW, h, datum:d });
  });

  // æŠ˜ã‚Œç·šï¼ˆÂ¥ï¼‰
  ctx.beginPath();
  ctx.lineWidth = 2*dpr;
  ctx.strokeStyle = '#34d399';
  data.forEach((d,i)=>{
    const cx = area.x + i*step + step/2;
    const cy = area.y + area.h - (d.yen / maxY) * area.h;
    if(i===0) ctx.moveTo(cx, cy); else ctx.lineTo(cx, cy);
  });
  ctx.stroke();

  // xç›®ç››ï¼ˆç–ã«ï¼‰
  ctx.fillStyle = '#475569';
  const labelEvery = Math.ceil(data.length / 6);
  data.forEach((d,i)=>{
    if(i%labelEvery!==0 && i!==data.length-1) return;
    let s='';
    if(currentRange==='30d'){
      s = `${String(d.date.getMonth()+1).padStart(2,'0')}/${String(d.date.getDate()).padStart(2,'0')}`;
    }else{
      s = d.ym.replace('-','/');
    }
    text(ctx, s, area.x + i*step + step/2, area.y + area.h + 12*dpr, 11*dpr, '#64748b', 'center');
  });

  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç°¡æ˜“ï¼ˆç›´è¿‘é¸æŠï¼‰
  chart._bars = bars;
}

/* ã‚¯ãƒªãƒƒã‚¯ã§æ£’ã‚’ãƒ’ãƒƒãƒˆ â†’ ã‚­ãƒ£ãƒ©ã¸åæ˜  & å°ã•ãªãƒãƒƒãƒ— */
chart.addEventListener('click', (ev)=>{
  if(!chart._bars) return;
  const rect = chart.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const x = (ev.clientX - rect.left) * dpr;
  const y = (ev.clientY - rect.top) * dpr;
  const hit = chart._bars.find(b => x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h);
  if(!hit) return;

  if(currentRange==='30d'){
    // æ—¥ã®gã§ã‚­ãƒ£ãƒ©çŠ¶æ…‹
    setMascotByDay(hit.datum);
  }else{
    // æœˆæ¬¡ã¾ã¨ã‚
    setMascotByMonth(hit.datum.year, hit.datum.month);
  }
});

/* ãƒ¬ãƒ³ã‚¸åˆ‡æ›¿ï¼ˆ1/3 ã‹ã‚‰ç™ºç«ï¼‰ */
window.addEventListener('ui:rangeChange', (e)=>{
  currentRange = e.detail.range || '30d';
  drawChart();
  // ãƒ¬ãƒ³ã‚¸åˆ‡æ›¿æ™‚ç‚¹ã®ä»£è¡¨å€¤ã§ãƒã‚¹ã‚³ãƒƒãƒˆã‚‚æ›´æ–°
  if(currentRange==='30d' && lastPayload.daily.length){
    setMascotByDay(lastPayload.daily[lastPayload.daily.length-1]); // ç›´è¿‘
  }else if(currentRange==='12m' && lastPayload.monthly.length){
    const dm = lastPayload.monthly[lastPayload.monthly.length-1];
    setMascotByMonth(dm.year, dm.month);
  }
});

/* ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆ2/3 ã‹ã‚‰ç™ºç«ï¼‰â†’ å†æç”» */
window.addEventListener('data:updated', (e)=>{
  lastPayload = e.detail || { daily:[], monthly:[] };
  drawChart();
  // ã¾ãšã¯ä»Šæ—¥å´ã®çŠ¶æ…‹ã«åˆã‚ã›ã¦è¡¨ç¤º
  if(currentRange==='30d' && lastPayload.daily.length){
    setMascotByDay(lastPayload.daily[lastPayload.daily.length-1]);
  }else if(currentRange==='12m' && lastPayload.monthly.length){
    const dm = lastPayload.monthly[lastPayload.monthly.length-1];
    setMascotByMonth(dm.year, dm.month);
  }
});

/* ã—ãã„å€¤ï¼ˆåˆæœŸæ¨å¥¨å€¤ï¼‰ */
const G_TIPSY = 20;  // ã»ã‚é…”ã„ç›®å®‰
const G_DRUNK = 40;  // é£²ã¿ã™ãç›®å®‰

/* æ—¥å˜ä½ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹ */
function setMascotByDay(d){
  const g = d?.g || 0;
  let stateName = 'rest'; // ç¦é…’
  if(g>0 && g<=G_TIPSY) stateName='normal';
  else if(g>G_TIPSY && g<=G_DRUNK) stateName='tipsy';
  else if(g>G_DRUNK) stateName='drunk';

  const line = daySpeech(stateName, g, d.yen);
  drawMascot({ mode:'day', state:stateName, speech: line, gram:g });
}

/* æœˆå˜ä½ã®ã‚µãƒãƒªãƒ¼ã‹ã‚‰ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹ */
function setMascotByMonth(year, month){
  const s = summarizeMonth(year, month);
  // ã‚¹ã‚³ã‚¢ï¼šç¦é…’æ—¥å¤šã„ï¼†é£²ã¿ã™ãå°‘ãªã„â†’è‰¯
  const score = Math.max(0, (s.restDays*2) - (s.bingeDays*2) + (30 - Math.min(30, s.days))*0.3);
  let scene = 'balanced';
  if(s.bingeDays >= 7) scene = 'party';
  if(s.restDays >= 10 && s.bingeDays <= 2) scene = 'medal';

  const line = monthSpeech(scene, s);
  drawMascot({ mode:'month', scene, speech: line, summary:s });
}

/* æœˆé›†è¨ˆã®è©³ç´°ï¼ˆé£²ã¿ã™ãæ—¥ã€ç¦é…’æ—¥ã€å¤–é£Ÿæ¯”ç‡ãªã©ï¼‰ */
function summarizeMonth(year, month){
  let days = 0, restDays=0, bingeDays=0, outCount=0, allCount=0, yen=0, gsum=0;
  for(const key in state.logs){
    const d = new Date(key);
    if(d.getFullYear()===year && d.getMonth()===month){
      days++;
      const arr = state.logs[key]||[];
      const s = sumDay(key);
      yen += s.yen; gsum += s.g;
      if(s.g===0) restDays++;
      if(s.g>G_DRUNK) bingeDays++;
      arr.forEach(e=>{ allCount++; if(String(e.id).endsWith('_o')) outCount++; });
    }
  }
  const outRatio = allCount? (outCount/allCount):0;
  return { year, month, days, restDays, bingeDays, outRatio, yen, g:round2(gsum) };
}

/* ã‚»ãƒªãƒ•ï¼ˆæ—¥ï¼‰ */
function daySpeech(state, g, yen){
  const arr = {
    rest: [
      'ä»Šæ—¥ã¯ãƒãƒ³ã‚¢ãƒ«ã§å¿«çœ ï¼',
      'ä¼‘è‚æ—¥ã‚²ãƒƒãƒˆï¼',
      'æ°´åˆ†ã¨ã£ã¦æ—©å¯ã—ã‚ˆï½'
    ],
    normal: [
      'ã»ã©ã»ã©ãŒã„ã¡ã°ã‚“ãŠã„ã—ã„ï¼',
      'ã„ã„æ°—åˆ†â™ª',
      'ã”ã¯ã‚“ã‚‚é€²ã‚€ï½'
    ],
    tipsy: [
      'ã»ã‚é…”ã„ã€ã„ã„å¤œï¼',
      'ã“ã®ã¸ã‚“ã§ãŠæ°´ï½',
      'æ˜æ—¥ã‚‚å…ƒæ°—ã«ã„ã“ã†'
    ],
    drunk: [
      'ã‚ã‚Œâ€¦åºŠãŒå›ã£ã¦ã‚‹â€¦',
      'ãŠæ°´â€¦ãŠæ°´â€¦ï¼',
      'ä»Šæ—¥ã¯ã‚ˆãå¯ã‚ˆã†â€¦'
    ]
  };
  const list = arr[state] || ['OK!'];
  return list[Math.floor(hashSeed(`${state}-${todayKey()}`)%list.length)];
}

/* ã‚»ãƒªãƒ•ï¼ˆæœˆï¼‰ */
function monthSpeech(scene, s){
  const monthStr = `${s.year}/${String(s.month+1).padStart(2,'0')}`;
  if(scene==='medal'){
    return `${monthStr} ã¯è¡¨å½°ï¼ç¦é…’${s.restDays}æ—¥ğŸ‘`;
  }else if(scene==='party'){
    return `${monthStr} ã¯ã«ãã‚„ã‹ï¼é£²ã¿ã™ã${s.bingeDays}æ—¥ğŸ’¦`;
  }else{
    return `${monthStr} ã¾ã¨ã‚ï¼šãƒãƒ©ãƒ³ã‚¹è‰¯ãï¼`;
  }
}

/* ã‚†ã‚‹ã‚­ãƒ£ãƒ©æç”»ï¼ˆSVGãªã—ã®Canvasç°¡æ˜“ï¼‰ */
function drawMascot(opts){
  layoutCanvases();
  const dpr = window.devicePixelRatio || 1;
  const W = mascCanvas.width, H = mascCanvas.height;
  mctx.clearRect(0,0,W,H);

  // èƒŒæ™¯ï¼ˆæ™‚é–“å¸¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²ï¼‰
  const theme = $('#app').getAttribute('data-theme') || 'morning';
  let bgTop='#e6f3ff', bgBot='#ffffff';
  if(theme==='evening'){ bgTop='#ffe6b3'; bgBot='#ffffff'; }
  if(theme==='night'){ bgTop='#091834'; bgBot='#152a52'; }
  const grad = mctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, bgTop); grad.addColorStop(1, bgBot);
  mctx.fillStyle = grad; mctx.fillRect(0,0,W,H);

  // åœ°é¢
  mctx.fillStyle = theme==='night' ? '#0f1d3a' : '#eaf3ff';
  mctx.fillRect(0, H-30*dpr, W, 30*dpr);

  // å°ç‰©ï¼ˆå­£ç¯€/ãƒ©ãƒ³ãƒ€ãƒ ã®ãƒŸãƒ‹æ¼”å‡ºï¼šè»½ãï¼‰
  if(theme!=='night'){
    mctx.fillStyle = 'rgba(255,255,255,0.6)';
    for(let i=0;i<6;i++){
      const x = ( (i*97 + hashSeed(todayKey())) % W );
      mctx.beginPath(); mctx.arc(x, 20*dpr + (i%2)*8*dpr, 3*dpr, 0, Math.PI*2); mctx.fill();
    }
  }

  // ã‚­ãƒ£ãƒ©ä½ç½®
  const cx = W/2, cy = H/2 + 10*dpr, R = 34*dpr;

  // çŠ¶æ…‹æ±ºå®š
  let state = opts.state || 'normal'; // day: rest/normal/tipsy/drunk
  let scene = opts.scene || null;     // month: medal/party/balanced

  // ä½“
  roundRect(mctx, cx-R, cy-R, R*2, R*2, R, '#fff7ea', '#e6d8c9');
  // å½±
  mctx.fillStyle = 'rgba(0,0,0,0.08)';
  mctx.beginPath(); mctx.ellipse(cx, cy+R-6*dpr, 26*dpr, 7*dpr, 0, 0, Math.PI*2); mctx.fill();

  // é¡”è‰²ï¼ˆæ®‹é‡ã‚„çŠ¶æ…‹ã§é ¬è‰²ï¼‰
  function cheeks(color){
    mctx.fillStyle = color;
    mctx.beginPath(); mctx.arc(cx-12*dpr, cy-2*dpr, 5*dpr, 0, Math.PI*2); mctx.fill();
    mctx.beginPath(); mctx.arc(cx+12*dpr, cy-2*dpr, 5*dpr, 0, Math.PI*2); mctx.fill();
  }

  // ç›®ãƒ»å£
  function face(normal=true){
    // ç›®
    mctx.fillStyle='#1f2937';
    mctx.beginPath(); mctx.arc(cx-10*dpr, cy-6*dpr, 2.6*dpr, 0, Math.PI*2); mctx.fill();
    mctx.beginPath(); mctx.arc(cx+10*dpr, cy-6*dpr, 2.6*dpr, 0, Math.PI*2); mctx.fill();
    // å£
    mctx.strokeStyle='#ef4444'; mctx.lineWidth=1.6*dpr;
    mctx.beginPath();
    if(normal){ mctx.arc(cx, cy+2*dpr, 6*dpr, 0, Math.PI); }
    else{ mctx.moveTo(cx-6*dpr, cy+6*dpr); mctx.quadraticCurveTo(cx, cy+2*dpr, cx+6*dpr, cy+6*dpr); }
    mctx.stroke();
  }

  function sweat(){
    mctx.fillStyle='#60a5fa';
    mctx.beginPath(); mctx.ellipse(cx+18*dpr, cy-12*dpr, 3*dpr, 5*dpr, Math.PI/6, 0, Math.PI*2); mctx.fill();
  }

  // ãƒãƒ¼ã‚ºï¼ˆè…•ï¼‰
  function arms(raise=false){
    mctx.strokeStyle='#e6d8c9'; mctx.lineWidth=5*dpr; mctx.lineCap='round';
    mctx.beginPath();
    mctx.moveTo(cx-R+10*dpr, cy-6*dpr);
    mctx.lineTo(cx-R+10*dpr-(raise?8*dpr:0), cy-6*dpr-(raise?8*dpr:0));
    mctx.stroke();
    mctx.beginPath();
    mctx.moveTo(cx+R-10*dpr, cy-6*dpr);
    mctx.lineTo(cx+R-10*dpr+(raise?8*dpr:0), cy-6*dpr-(raise?8*dpr:0));
    mctx.stroke();
  }

  // ã‚·ãƒ¼ãƒ³ï¼ˆå¤œã¯æç¯ã€æœã¯å°é³¥ï¼‰
  if(theme==='night'){
    mctx.fillStyle='#ffad42';
    roundRect(mctx, cx-60*dpr, cy-R-28*dpr, 20*dpr, 22*dpr, 6*dpr, '#ffad42');
    roundRect(mctx, cx+40*dpr, cy-R-34*dpr, 20*dpr, 22*dpr, 6*dpr, '#ffad42');
  }else if(theme==='morning'){
    mctx.fillStyle='#60a5fa';
    mctx.beginPath(); mctx.arc(cx-66*dpr, cy-R-24*dpr, 5*dpr, 0, Math.PI*2); mctx.fill();
  }

  // çŠ¶æ…‹åˆ¥ã®é¡”ãƒ»é ¬ãƒ»è…•
  if(scene){ // æœˆã‚·ãƒ¼ãƒ³å„ªå…ˆ
    if(scene==='medal'){ cheeks('#fecaca'); face(true); arms(true);
      // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼
      mctx.fillStyle='#f59e0b';
      roundRect(mctx, cx+48*dpr, cy-16*dpr, 16*dpr, 12*dpr, 3*dpr, '#f59e0b');
      roundRect(mctx, cx+51*dpr, cy-4*dpr, 10*dpr, 4*dpr, 2*dpr, '#b45309');
    }else if(scene==='party'){ cheeks('#fecaca'); face(false); arms(true); sweat();
    }else{ cheeks('#fde68a'); face(true); arms(false); }
  }else{
    if(state==='rest'){ cheeks('#ffd1dc'); face(true); arms(false); }
    if(state==='normal'){ cheeks('#ffd1dc'); face(true); arms(true); }
    if(state==='tipsy'){ cheeks('#fecaca'); face(true); arms(true); }
    if(state==='drunk'){ cheeks('#fecaca'); face(false); arms(false); sweat(); }
  }

  // å¹ãå‡ºã—
  const speech = opts.speech || '';
  if(speech){
    const boxW = Math.min(W-20*dpr, Math.max(120*dpr, mctx.measureText(speech).width + 24*dpr));
    const bx = Math.max(10*dpr, Math.min(W-boxW-10*dpr, cx - boxW/2));
    const by = 12*dpr;
    roundRect(mctx, bx, by, boxW, 26*dpr, 10*dpr, 'rgba(255,255,255,0.9)', '#e5e7eb');
    mctx.beginPath(); mctx.moveTo(cx-6*dpr, by+26*dpr);
    mctx.lineTo(cx, by+34*dpr); mctx.lineTo(cx+6*dpr, by+26*dpr); mctx.closePath();
    mctx.fillStyle='rgba(255,255,255,0.9)'; mctx.fill(); mctx.strokeStyle='#e5e7eb'; mctx.stroke();
    text(mctx, speech, bx+12*dpr, by+13*dpr, 12*dpr, '#0f172a', 'left');
  }
}

/* åˆæœŸæç”» */
layoutCanvases();
drawChart();
// åˆæœŸã®ãƒã‚¹ã‚³ãƒƒãƒˆï¼ˆä»Šæ—¥ã®çŠ¶æ…‹ï¼‰
if(lastPayload.daily.length){
  setMascotByDay(lastPayload.daily[lastPayload.daily.length-1]);
}

/* ãƒªã‚µã‚¤ã‚ºã§å†æç”» */
window.addEventListener('resize', ()=>{
  drawChart();
  // ç›´è¿‘ã®è¡¨ç¤ºã‚’å†æ²ï¼ˆãƒ¬ãƒ³ã‚¸ã«å¿œã˜ã¦ï¼‰
  if(currentRange==='30d' && lastPayload.daily.length){
    setMascotByDay(lastPayload.daily[lastPayload.daily.length-1]);
  }else if(currentRange==='12m' && lastPayload.monthly.length){
    const dm = lastPayload.monthly[lastPayload.monthly.length-1];
    setMascotByMonth(dm.year, dm.month);
  }
});
</script>


