<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>é…’ãƒ­ã‚°</title>
<style>
:root{
  --bg:#f7f9fc;
  --card:#ffffff;
  --text:#1b2230;
  --muted:#6b7280;
  --accent:#3b82f6;
  --line:#e5e7eb;
  --danger:#e53935;
  --good:#10b981;
  --warn:#f59e0b;
  /* ãƒ†ã‚£ãƒ³ãƒˆï¼ˆé…”ã„ã§èµ¤ã¿ï¼‰ */
  --tint-strength:0;           /* 0ã€œ1 */
  --hue-shift:0deg;            /* 0ã€œ18deg */
  --sat-boost:0%;              /* 0ã€œ18% */
  --light-boost:0%;            /* 0ã€œ4% */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif;
  color:var(--text);
  background:
    linear-gradient(160deg,
      hsl(calc(210 + var(--hue-shift)) 80% calc(98% - var(--light-boost))),
      hsl(calc(220 + var(--hue-shift)) calc(60% + var(--sat-boost)) calc(94% - var(--light-boost)))
    );
  transition:background-color .4s ease, filter .3s ease;
}
/* â€”â€” Red tint overlay by drinking â€”â€” */
body::after{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  background: rgba(255, 0, 0, calc(var(--tint-strength) * 0.18)); /* ã»ã‚“ã®ã‚Šèµ¤ */
  z-index: 0;
}
/* ä¸»è¦UIã¯ä¸Šã«æ¥ã‚‹ã‚ˆã†ã« */
.container, .modalBack, .snack { position: relative; z-index: 1; }

.container{max-width:980px; margin:0 auto; padding:20px 12px 80px}
h1{margin:0 0 4px; font-size:22px}
.appDate{
  font-size:12px; color:var(--muted); margin:0 0 12px;
}
.topRow{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
.tabs{display:flex; gap:6px; background:#edf2ff; padding:4px; border-radius:10px}
.tabBtn{
  border:0; background:transparent; padding:8px 12px; border-radius:8px; cursor:pointer; color:#334155; font-weight:600;
}
.tabBtn[aria-pressed="true"]{background:var(--card); color:var(--text); box-shadow:0 1px 0 rgba(0,0,0,.05)}

/* KPI */
.kpi{
  display:grid; gap:8px; grid-template-columns:repeat(4,1fr);
  margin:12px 0;
}
.card{
  background:var(--card); border:1px solid var(--line);
  border-radius:12px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.kpi h3{margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.02em}
.kpi .big{font-size:18px; font-weight:800}
.kpi small{color:var(--muted)}

.progressWrap{display:flex; gap:10px; align-items:center}
.progress{
  position:relative; height:10px; border-radius:999px; background:#eef2ff; overflow:hidden; flex:1;
}
/* â˜… é€²æ—ãƒãƒ¼ï¼šå±é™ºâ†’å®‰å…¨ = èµ¤â†’é’ ã«å¤‰æ›´ */
.progress > i{display:block; height:100%; background:linear-gradient(90deg,#ef4444,#60a5fa); width:0%}
.eta{font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px; width:140px; text-align:right}
.editLink{color:var(--accent); font-size:12px; cursor:pointer; margin-left:6px; text-decoration:underline dotted}

/* å¯¾è±¡æ—¥ãƒ©ãƒ™ãƒ«ï¼ˆå…¥åŠ›ç”»é¢ä¸Šè¨˜ã®å°ã•ãªæ—¥ä»˜ãƒ”ãƒ«ï¼‰ */
.activeDay {
  font-size: 12px;
  color: var(--muted);
  margin: 2px 0 6px;
}
.activeDay .pill{
  display:inline-block;
  padding:2px 8px;
  border:1px solid var(--line);
  border-radius:999px;
  background:#fff;
  font-weight:700;
  margin-right:6px;
}

/* å…¥åŠ› */
.section{margin:12px 0}
.subTabs{display:flex; gap:6px; margin-bottom:8px}
.subTabs .seg{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; border-radius:999px;
  cursor:pointer; color:#334155; font-weight:700;
}
.subTabs .seg[aria-pressed="true"]{background:#e8f0ff; border-color:#c7dbff; color:#1e3a8a}

.tiles{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
@media(min-width:720px){ .tiles{grid-template-columns:repeat(3,minmax(0,1fr));} }
.tile{
  position:relative; display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); background:var(--card); border-radius:12px; padding:10px;
  cursor:pointer; user-select:none; transition:transform .03s ease, box-shadow .2s ease;
}
.tile:active{transform:scale(.99)}
.tile:hover{box-shadow:0 4px 14px rgba(0,0,0,.05)}
.tile .emoji{font-size:32px; flex-shrink:0; line-height:1}
.tile .info{flex:1}
.tile .name{font-weight:700; font-size:14px}
.tile .meta{font-size:12px; color:var(--muted)}
.badge{
  position:absolute; top:6px; right:6px; background:#e53935; color:#fff; font-weight:800; font-size:14px;
  min-width:26px; height:22px; padding:0 6px; border-radius:999px; display:none; align-items:center; justify-content:center;
  box-shadow:0 2px 4px rgba(0,0,0,.3);
}
.badge[data-show="1"]{display:flex}

.actionsRow{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
.smallBtn{
  background:#fff; border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700;
}
.smallBtn.danger{border-color:#fecaca; color:#b91c1c; background:#fff5f5}
.smallBtn.accent{border-color:#bfdbfe; color:#1d4ed8; background:#eff6ff}

/* å±¥æ­´ */
.histHeader{display:flex; align-items:center; gap:8px; justify-content:space-between; margin:4px 0 8px}
.rangeTabs{display:flex; gap:6px}
.rangeTabs button{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; font-weight:800; border-radius:8px; cursor:pointer
}
.rangeTabs button[aria-pressed="true"]{background:#eef6ff; border-color:#c7dbff; color:#1e3a8a}

.histActions{display:flex; gap:6px; align-items:center}

.canvasWrap{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px; overflow:hidden}
#chart{width:100%; height:280px; display:block}
.sumRow{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:8px}
.sumCard h4{margin:0 0 4px; font-size:12px; color:var(--muted)}
.sumCard .big{font-size:18px; font-weight:900}
.comment{font-size:13px; color:#374151; margin-top:4px}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå¸¸æ™‚è¡¨ç¤ºãƒ»æœˆåˆ‡æ›¿ãƒ»åˆè¨ˆï¼‰ */
#calendarPanel{margin-top:10px; padding:12px}
.calHeader{
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; margin:4px 0 6px;
}
.calBtn{
  border:1px solid var(--line); background:#fff; border-radius:10px;
  padding:6px 10px; cursor:pointer; font-weight:800;
}
.calTitle{ font-weight:900; letter-spacing:.02em; }
.calTotals{
  display:flex; flex-wrap:wrap; gap:6px 10px; align-items:center;
  font-size:12px; color:#374151; margin:4px 0 2px;
}
.calChip{
  background:#f3f4f6; border:1px solid var(--line);
  padding:4px 8px; border-radius:999px; font-weight:700;
}
.calLegend{display:flex; gap:8px; align-items:center; font-size:12px; color:#374151; margin:6px 0}
.dot{width:14px; height:14px; border-radius:4px; border:1px solid #e5e7eb}
.grid{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; margin-top:8px}
.cell{
  position:relative; padding-top:100%; border-radius:8px; border:1px solid var(--line); background:#fff; overflow:hidden; cursor:default
}
.cell small{position:absolute; top:4px; left:6px; font-size:11px; color:#6b7280}
/* ã‚»ãƒ«ä¸‹éƒ¨ã®è¡¨ç¤ºï¼šBæ¡ˆï¼ˆå·¦ã«çµµæ–‡å­—ã€å³ã«æ•°å€¤ï¼‰ */
.cell .val{
  position:absolute; bottom:4px; left:4px; right:4px;
  font-size:11px; line-height:1.1; color:#374151;
  display:flex; gap:6px; align-items:center; justify-content:flex-start;
}
.cell[data-empty="1"]{background:transparent; border-color:transparent}

/* ã‚·ãƒ¼ãƒ³ï¼ˆPixiã‚’ã“ã“ã«æç”»ï¼‰ */
.scene{margin-top:10px; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; height:min(26vh,240px); position:relative}
.scene canvas, .scene svg{width:100%; height:100%; display:block}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modalBack{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px}
.modal{background:var(--card); border-radius:12px; border:1px solid var(--line); width:min(92vw,560px); max-height:88vh; overflow:auto; padding:14px}
.modal h3{margin:0 0 12px}
.formRow{display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center; margin:10px 0}
input[type="number"],input[type="time"],input[type="date"],select{
  width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px
}
.range{display:flex; gap:8px; align-items:center}
.modal .footer{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
.btn{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800}
.btn.primary{background:#1d4ed8; color:#fff; border-color:#1d4ed8}
.btn.ghost{background:#eef2ff}
.note{font-size:12px; color:var(--muted)}
hr.sep{border:none; border-top:1px solid var(--line); margin:12px 0}

/* ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ï¼ˆè­¦å‘Šï¼‰ */
.snack{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
  display:none; max-width:92vw; box-shadow:0 8px 20px rgba(0,0,0,.3); font-size:14px
}
.snack[data-show="1"]{display:block}

/* KPI & ã‚¿ã‚¤ãƒ«åœ§ç¸®ï¼ˆiPhoneï¼‰ */
@media (max-width: 430px){
  .container{ padding:12px 10px 64px; }
  .kpi{ grid-template-columns:repeat(2,1fr); gap:6px; margin:8px 0; }
  .card{ padding:10px; }
  .kpi h3{ font-size:11px; margin-bottom:4px; }
  .kpi .big{ font-size:16px; }
  .progress{ height:8px; }
  .eta{ width:auto; font-size:11px; }
  .tiles{ gap:8px; }
  .tile{ padding:8px; }
  .tile .emoji{ font-size:28px; }
  .tile .name{ font-size:13px; }
  .tile .meta{ font-size:11px; }
  .actionsRow{ margin-top:6px; }
}

/* reduced motion */
@media (prefers-reduced-motion: reduce){
  .tile:active{transform:none}
  .scene *{animation:none !important}
}

/* â€”â€” æ—¥åˆ¥å†…è¨³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç°¡æ˜“ãƒ†ãƒ¼ãƒ–ãƒ« â€”â€” */
.dayTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.dayTable th, .dayTable td {
  border-bottom: 1px solid var(--line);
  padding: 6px 8px;
  text-align: right;
}
.dayTable th:first-child, .dayTable td:first-child { text-align: left; }
.dayTable tfoot td {
  font-weight: 800;
}
</style>
</head>
<body>
  <div class="container">
    <div class="topRow">
      <div>
        <h1>é…’ãƒ­ã‚°</h1>
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹ã®å°ã•ãªæ—¥ä»˜ï¼š10æ™‚ã¾ã§ã¯å‰æ—¥ã‚’è¡¨ç¤ºã€10æ™‚ã«åˆ‡æ›¿ -->
        <div class="appDate" id="ui-active-date">â€”</div>
      </div>
      <div class="tabs" role="tablist" aria-label="main tabs">
        <button class="tabBtn" id="tab-input" aria-pressed="true">å…¥åŠ›</button>
        <button class="tabBtn" id="tab-history" aria-pressed="false">å±¥æ­´</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpi">
      <div class="card">
        <h3>ç·é‡ï¼ˆLï¼‰</h3>
        <div class="big" id="kpi-liters">0.00</div>
      </div>
      <div class="card">
        <h3>ç´”ã‚¢ãƒ«ï¼ˆgï¼‰</h3>
        <div class="big" id="kpi-grams">0</div>
      </div>
      <div class="card">
        <h3>æ¦‚ç®—é‡‘é¡ï¼ˆå††ï¼‰</h3>
        <div class="big" id="kpi-yen">Â¥0</div>
      </div>
      <div class="card">
        <h3>åˆ†è§£ç‡ <span id="kpi-startLabel" class="editLink" title="èµ·ç‚¹ã‚’ç·¨é›†">èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰</span></h3>
        <div class="progressWrap">
          <div class="progress" aria-label="åˆ†è§£ç‡">
            <i id="decomp-bar" style="width:0%"></i>
          </div>
          <div class="eta" id="decomp-eta">åˆ†è§£æ™‚é–“ --:--</div>
        </div>
      </div>
    </div>

    <!-- å…¥åŠ› -->
    <section id="sec-input" class="section">
      <!-- å…¥åŠ›ã‚¿ãƒ–ä¸Šã®å¯¾è±¡æ—¥è¡¨ç¤ºï¼ˆ10:00ã¾ã§ã¯å‰æ—¥ï¼‰ -->
      <div class="activeDay" id="active-day-wrap">
        <span class="pill" id="active-day-pill">â€”</span>
        <span>â€» æœ10:00ã¾ã§ã¯å‰æ—¥ã®è¨˜éŒ²ã‚’è¡¨ç¤ºãƒ»ç·¨é›†</span>
      </div>

      <div class="subTabs" role="tablist" aria-label="mode tabs">
        <button class="seg" id="seg-home" aria-pressed="true">å®¶é£²ã¿</button>
        <button class="seg" id="seg-out" aria-pressed="false">å¤–é£Ÿ</button>
        <button class="smallBtn accent" id="btn-settings">è¨­å®šï¼ˆä½“é‡ãƒ»è€æ€§ï¼‰</button>
      </div>

      <div class="tiles" id="tiles"></div>

      <div class="actionsRow">
        <button class="smallBtn danger" id="btn-clear">æœ¬æ—¥ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
        <div class="note">â€» æœ10:00ã¾ã§ã¯å‰æ—¥ã®è¨˜éŒ²ã‚’ç·¨é›†ã§ãã¾ã™</div>
      </div>
    </section>

    <!-- å±¥æ­´ -->
    <section id="sec-history" class="section" hidden>
      <div class="histHeader">
        <div class="rangeTabs" role="tablist" aria-label="range">
          <button class="rangeBtn" data-range="7d" aria-pressed="false">7d</button>
          <button class="rangeBtn" data-range="30d" aria-pressed="true">30d</button>
          <button class="rangeBtn" data-range="12m" aria-pressed="false">12m</button>
        </div>
        <div class="histActions">
          <div class="note" id="rangeLabel">ç›´è¿‘30æ—¥</div>
        </div>
      </div>

      <div class="sumRow">
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆå††ï¼‰</h4>
          <div class="big" id="sum-yen">Â¥0</div>
          <div class="comment" id="comment-money">â€”</div>
        </div>
        <div class="sumCard card">
          <h4>åˆè¨ˆï¼ˆç´”ã‚¢ãƒ«gï¼‰</h4>
          <div class="big" id="sum-g">0 g</div>
          <div class="comment" id="comment-grams">â€”</div>
        </div>
      </div>

      <div class="canvasWrap card" style="margin-top:8px">
        <canvas id="chart" width="1200" height="560"></canvas>
      </div>

      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå½“è©²æœˆ é‡‘é¡åˆè¨ˆï¼‹ç´”ã‚¢ãƒ«åˆè¨ˆãƒ»ã‚»ãƒ«ã¯ç´”ã‚¢ãƒ«ã®ã¿è¡¨ç¤ºãƒ»çµµæ–‡å­—ãƒãƒƒã‚¸ï¼‰ -->
      <div id="calendarPanel" class="card">
        <div class="calHeader">
          <button class="calBtn" id="cal-prev" aria-label="å‰ã®æœˆ">â€¹</button>
          <div class="calTitle" id="cal-title">â€”</div>
          <button class="calBtn" id="cal-next" aria-label="æ¬¡ã®æœˆ">â€º</button>
        </div>

        <!-- æœˆã®åˆè¨ˆï¼ˆÂ¥åˆè¨ˆ / ç´”ã‚¢ãƒ«åˆè¨ˆï¼‰ -->
        <div class="calTotals" id="cal-totals"></div>

        <div class="calLegend">
          <span>æ³¥é…”åº¦ï¼š</span>
          <span class="dot" style="background:#e8f1ff"></span>ä½
          <span class="dot" style="background:#93c5fd"></span>ä¸­
          <span class="dot" style="background:#ef4444"></span>é«˜
          <span class="dot" style="background:#111827"></span>ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        </div>
        <div class="grid" id="calendarGrid"></div>
      </div>

      <div class="scene" id="scene">
        <!-- WebGL(Pixi)ã§æç”»ï¼ˆPart3ã§ï¼‰ -->
      </div>
    </section>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-settings">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="setTitle">
      <h3 id="setTitle">è¨­å®šï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h3>

      <div class="formRow">
        <label for="in-weight">ä½“é‡ï¼ˆkgï¼‰</label>
        <input type="number" id="in-weight" min="30" max="150" step="0.5" placeholder="ä¾‹: 70">
      </div>
      <div class="formRow">
        <label>åˆ†å¸ƒä¿‚æ•° rï¼ˆL/kgï¼‰</label>
        <select id="sel-r">
          <option value="0.70">å¹³å‡ï¼ˆ0.70ï¼‰</option>
          <option value="0.71">ç”·æ€§ã®ç›®å®‰ï¼ˆ0.71ï¼‰</option>
          <option value="0.58">å¥³æ€§ã®ç›®å®‰ï¼ˆ0.58ï¼‰</option>
        </select>
      </div>
      <div class="formRow">
        <label>Î²ï¼ˆg/L/æ™‚ï¼‰</label>
        <div class="range">
          <input type="range" id="in-beta" min="0.10" max="0.20" step="0.01">
          <div id="betaLabel" class="note">0.15</div>
        </div>
      </div>
      <div class="formRow">
        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«è€æ€§</label>
        <div>
          <label><input type="radio" name="tol" value="weak">å¼±ã„</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="normal" checked>æ™®é€š</label>
          <label style="margin-left:14px"><input type="radio" name="tol" value="strong">å¼·ã„</label>
        </div>
      </div>
      <details>
        <summary>è‡ªå·±è¨ºæ–­ã§æ±ºã‚ã‚‹ï¼ˆä»»æ„ï¼‰</summary>
        <div class="note">æ•°å•ã«ç­”ãˆã¦è€æ€§ä¿‚æ•°ã‚’è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚</div>
        <div style="margin-top:8px">
          <div class="formRow">
            <label>1) ã»ã‚é…”ã„ã¾ã§</label>
            <select class="q" data-w="0"><option value="0">1æ¯</option><option value="1">2æ¯</option><option value="2">3æ¯ä»¥ä¸Š</option></select>
          </div>
          <div class="formRow">
            <label>2) é¡”ã®èµ¤ã¿</label>
            <select class="q" data-w="0"><option value="0">ã™ãå‡ºã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼å‡ºãªã„</option></select>
          </div>
          <div class="formRow">
            <label>3) ç¿Œæœä¸èª¿</label>
            <select class="q" data-w="0"><option value="0">ã‚ˆãã‚ã‚‹</option><option value="1">æ™‚ã€…</option><option value="2">ã»ã¼ãªã„</option></select>
          </div>
          <div class="formRow">
            <label>4) é£²é…’é »åº¦</label>
            <select class="q" data-w="0"><option value="0">é€±1ä»¥ä¸‹</option><option value="1">é€±2â€“4</option><option value="2">ã»ã¼æ¯æ—¥</option></select>
          </div>
          <button class="btn ghost" id="btn-self">è‡ªå·±è¨ºæ–­ã‚’åæ˜ </button>
          <div class="note" id="selfNote"></div>
        </div>
      </details>

      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-settings">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-settings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- èµ·ç‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-start">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <h3 id="startTitle">åˆ†è§£ã®èµ·ç‚¹æ™‚åˆ»</h3>
      <div class="formRow">
        <label>ãƒ¢ãƒ¼ãƒ‰</label>
        <div>
          <label><input type="radio" name="startMode" value="auto" checked>è‡ªå‹•ï¼ˆæœ€çµ‚ç™»éŒ²ï¼‰</label>
          <label style="margin-left:14px"><input type="radio" name="startMode" value="manual">æ‰‹å‹•</label>
        </div>
      </div>
      <div id="manualArea">
        <div class="formRow">
          <label>å¯¾è±¡æ—¥</label>
          <input type="date" id="in-start-date">
        </div>
        <div class="formRow">
          <label>æ™‚åˆ»</label>
          <input type="time" id="in-start-time" step="60">
        </div>
        <div class="note">â€» å¤§ããå®Ÿæ…‹ã¨ã‚ºãƒ¬ã‚‹ã¨æ¨å®šãŒä¸æ­£ç¢ºã«ãªã‚Šã¾ã™ã€‚</div>
      </div>
      <hr class="sep">
      <div class="footer">
        <button class="btn" id="btn-close-start">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="btn-save-start">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ—¥åˆ¥å†…è¨³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modal-day">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
      <h3 id="dayTitle">â€”</h3>
      <div id="daySummary" class="note" style="margin-bottom:8px">â€”</div>
      <div class="canvasWrap card" style="margin:8px 0">
        <table class="dayTable" id="dayTable">
          <!-- JSã§æŒ¿å…¥ -->
        </table>
      </div>
      <div class="footer">
        <button class="btn primary" id="btn-close-day">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ -->
  <div class="snack" id="snack"></div>

  <!-- â€» JSï¼ˆãƒ‘ãƒ¼ãƒˆ2/3ãƒ»3/3ã§èª­ã¿è¾¼ã¿ï¼‰ -->

<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const tz = 'Asia/Tokyo';
const JPY = n => 'Â¥' + Math.round(n).toLocaleString('ja-JP');
const pad = n => String(n).padStart(2,'0');

// JSTã§ "YYYY-MM-DD"
const ymdJST = (d) => {
  const j = new Date(d.toLocaleString('en-US', { timeZone: tz }));
  return `${j.getFullYear()}-${pad(j.getMonth()+1)}-${pad(j.getDate())}`;
};
// JSTã§ "YYYY-MM"
const ymJST = (d) => {
  const j = new Date(d.toLocaleString('en-US', { timeZone: tz }));
  return `${j.getFullYear()}-${pad(j.getMonth()+1)}`;
};
const todayKey = () => ymdJST(new Date());
const jstNow = () => new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
const jstDateFromKey = key => new Date(key+'T00:00:00+09:00');
const addDays = (d, n)=>{ const t=new Date(d); t.setDate(t.getDate()+n); return t; };
const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
const ls = { get(k,def){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch(_){return def} }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)); } };

// ç”»é¢ä¸Šã®æ—¥ä»˜è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸‹ï¼†å…¥åŠ›ãƒ”ãƒ«ï¼‰
const fmtWeek = d => ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
const fmtKeyJP = key => { const d=jstDateFromKey(key); return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${fmtWeek(d)}ï¼‰`; };
function updateActiveDateUI(){
  const key = activeInputKey();
  const s = fmtKeyJP(key);
  const el1 = document.getElementById('ui-active-date');
  const el2 = document.getElementById('active-day-pill');
  if(el1) el1.textContent = s;
  if(el2) el2.textContent = s;
}

/* ========= ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ ========= */
let __snackTimer=null;
function showSnack(text){
  const el=document.getElementById('snack'); if(!el) return;
  el.textContent=text; el.setAttribute('data-show','1');
  clearTimeout(__snackTimer); __snackTimer=setTimeout(()=>el.removeAttribute('data-show'),5000);
}

/* ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ========= */
const K_LOGS='drink_logs_v1', K_PRESETS='drink_presets_v1', K_PROFILE='drink_profile_v1', K_META='drink_logs_meta_v1', K_SETTINGS='drink_settings_v1', K_RANGE='hist_range_v1', K_CAL_SEL='hist_cal_sel_v1';

/* ========= çŠ¶æ…‹ ========= */
let logs = ls.get(K_LOGS, {});                      // { 'YYYY-MM-DD': [ {id, emoji, name, ml, abv, price, ts}, ... ] }
let presets = ls.get(K_PRESETS, null);
let profile = ls.get(K_PROFILE, { weightKg:70, beta:0.15, r:0.70, tol:'normal', tol_mult:1.0 });
let meta = ls.get(K_META, {});                      // { 'YYYY-MM-DD': { decompMode:'auto'|'manual', decompStartTs?:number, preWarnShown?:bool, warn7Shown?:bool } }
let settings = ls.get(K_SETTINGS, { cutoffHour:10, monthlyBudget:12000 });
let histRange = ls.get(K_RANGE, '30d');
let calSel = ls.get(K_CAL_SEL, todayKey().slice(0,7));

/* ========= ãƒ—ãƒªã‚»ãƒƒãƒˆ ========= */
if(!presets){
  presets = {
    home: [
      {id:'beer350', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«350ml', ml:350, abv:5, price:220},
      {id:'beer500', emoji:'ğŸº', name:'ãƒ“ãƒ¼ãƒ«500ml', ml:500, abv:5, price:290},
      {id:'happ350', emoji:'ğŸ»', name:'ç™ºæ³¡é…’350ml', ml:350, abv:5, price:170},
      {id:'happ500', emoji:'ğŸ»', name:'ç™ºæ³¡é…’500ml', ml:500, abv:5, price:210},
      {id:'chu350',  emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:160},
      {id:'chu500',  emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤500ml', ml:500, abv:7, price:200},
      {id:'hb350',   emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«ç¼¶350ml', ml:350, abv:7, price:170},
      {id:'sake180', emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:220},
      {id:'wine120', emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:200},
      {id:'shaox',   emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:180},
      {id:'sho_rock',emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90,  abv:25, price:120},
      {id:'sho_mizu',emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120,abv:20, price:120},
    ],
    out: [
      {id:'nama500',  emoji:'ğŸº', name:'ç”Ÿä¸­500ml', ml:500, abv:5,  price:600},
      {id:'chu350o',  emoji:'ğŸ¹', name:'ãƒãƒ¥ãƒ¼ãƒã‚¤350ml', ml:350, abv:7, price:450},
      {id:'hball300', emoji:'ğŸ¥ƒ', name:'ãƒã‚¤ãƒœãƒ¼ãƒ«300ml', ml:300, abv:7, price:480},
      {id:'sake180o', emoji:'ğŸ¶', name:'æ—¥æœ¬é…’1åˆ(180ml)', ml:180, abv:15, price:580},
      {id:'wine120o', emoji:'ğŸ·', name:'ãƒ¯ã‚¤ãƒ³1æ¯(120ml)', ml:120, abv:12, price:650},
      {id:'shaoxo',   emoji:'ğŸ®', name:'ç´¹èˆˆé…’1æ¯(100ml)', ml:100, abv:16, price:520},
      {id:'sho_roko', emoji:'ğŸ¥ƒ', name:'ç„¼é…ãƒ­ãƒƒã‚¯(90ml)', ml:90,  abv:25, price:550},
      {id:'sho_mizuo',emoji:'ğŸ¥ƒ', name:'ç„¼é…æ°´å‰²ã‚Š(120ml)', ml:120,abv:20, price:520},
    ]
  };
  ls.set(K_PRESETS, presets);
}

/* ========= ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ï¼ˆ10:00ç· ã‚ï¼‰ ========= */
function activeInputKey(){
  const now = jstNow(); const hour = now.getHours();
  if(hour < (settings.cutoffHour||10)){ const yest = addDays(jstDateFromKey(todayKey()), -1); return ymdJST(yest); }
  return todayKey();
}

/* ========= ãƒ­ã‚°æ“ä½œ ========= */
function addOne(preset){
  const key = activeInputKey();
  logs[key] = logs[key] || [];
  logs[key].push({ ...preset, ts: jstNow().getTime() });
  ls.set(K_LOGS, logs);
  // è‡ªå‹•èµ·ç‚¹ï¼ˆæ‰‹å‹•ã§ä¸Šæ›¸ãã•ã‚Œã¦ã„ãªã‘ã‚Œã°ï¼‰
  if(!meta[key] || meta[key].decompMode!=='manual'){ meta[key] = { decompMode:'auto' }; ls.set(K_META, meta); }
  assessRiskInline(); warnPreBlackout(); warnNotSoberBy7();
  renderAll();
}
function removeOne(id){
  const key = activeInputKey(); const arr = logs[key] || [];
  const idx = arr.length-1 - arr.slice().reverse().findIndex(v=>v.id===id);
  if(idx>=0){ arr.splice(idx,1); if(arr.length===0) delete logs[key]; ls.set(K_LOGS, logs); renderAll(); }
}
function clearActiveDay(){
  const key = activeInputKey();
  delete logs[key]; delete meta[key];
  ls.set(K_LOGS, logs); ls.set(K_META, meta);
  applyIntoxTint(0); renderAll();
}

/* ========= é›†è¨ˆ ========= */
function sumDay(key){
  const arr = logs[key]||[]; let ml=0,g=0,yen=0,lastTs=0;
  for(const it of arr){ ml+=it.ml; g+= it.ml*(it.abv/100)*0.8; yen+=it.price; lastTs=Math.max(lastTs,it.ts||0); }
  return { ml,g,yen,lastTs,count:arr.length, items:arr };
}
function sumMonth(ym){ let g=0,yen=0; for(const k in logs){ if(k.startsWith(ym)){ const s=sumDay(k); g+=s.g; yen+=s.yen; } } return {g,yen}; }

/* ========= åˆ†è§£ãƒ¢ãƒ‡ãƒ« ========= */
function toleranceMult(){ if(profile.tol==='weak') return 0.85; if(profile.tol==='strong') return 1.15; return profile.tol_mult||1.0; }
function rateGph(){ return (profile.beta||0.15)*(profile.r||0.70)*(profile.weightKg||70)*toleranceMult(); }

/* ========= åˆ†è§£èµ·ç‚¹ ========= */
function resolveDecompTargetDay(){
  const t=todayKey(); const y=ymdJST(addDays(jstDateFromKey(t),-1));
  if(logs[y])return y; if(logs[t])return t; return null;
}
function resolveStartTs(dayKey){
  if(!dayKey) return null;
  const m = meta[dayKey];
  if(m && m.decompMode==='manual' && m.decompStartTs) return m.decompStartTs;
  const { lastTs } = sumDay(dayKey);
  return lastTs? lastTs + 60*60*1000 : null; // å¸åãƒ‡ã‚£ãƒ¬ã‚¤+60åˆ†
}

/* ========= é€²æ— ========= */
function computeRemain(){
  const key = resolveDecompTargetDay();
  if(!key) return { total_g:0, remain_g:0, progress:0, eta:null, startTs:null, dayKey:null };
  const total_g = sumDay(key).g||0;
  const startTs = resolveStartTs(key);
  if(!startTs) return { total_g, remain_g:0, progress:0, eta:null, startTs:null, dayKey:key };
  const speed = rateGph(); const now= jstNow().getTime();
  const elapsed_h = Math.max(0,(now-startTs)/3600000);
  const remain_g = Math.max(0, total_g - speed*elapsed_h);
  const need_h = total_g / speed; const done = clamp(elapsed_h / need_h, 0, 1);
  const eta = new Date(startTs + need_h*3600000);
  return { total_g, remain_g, progress:Math.round(done*100), eta, startTs, dayKey:key };
}

/* ========= è¦‹ãŸç›®ãƒ†ã‚£ãƒ³ãƒˆï¼ˆ10:00ã§ãƒªã‚»ãƒƒãƒˆï¼‰ ========= */
function applyIntoxTint(remain_g){
  const hour = jstNow().getHours();
  if(hour >= (settings.cutoffHour || 10)){
    // 10æ™‚ä»¥é™ã¯èƒŒæ™¯ãƒ†ã‚£ãƒ³ãƒˆã®ã¿å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼ˆé€²æ—è¨ˆç®—ã¯ç¶™ç¶šï¼‰
    remain_g = 0;
  }
  const G_SCALE=60;
  let s = clamp(remain_g / G_SCALE, 0, 1);
  s = Math.pow(s, 0.85);
  s = Math.min(s, 0.75); // æœ€å¤§ã§ã‚‚ã»ã‚“ã®ã‚Š
  const hue=18*s, sat=18*s, light=4*s;
  document.documentElement.style.setProperty('--tint-strength', s.toFixed(3));
  document.documentElement.style.setProperty('--hue-shift', hue+'deg');
  document.documentElement.style.setProperty('--sat-boost', sat+'%');
  document.documentElement.style.setProperty('--light-boost', light+'%');
}

/* ========= ã‚¿ã‚¤ãƒ«æç”» ========= */
const elTiles = document.getElementById('tiles');
let mode='home';
function renderPresetTiles(){
  if(!elTiles) return;
  elTiles.innerHTML='';
  const list = presets[mode]||[];
  const key = activeInputKey();
  const cnts = {}; (logs[key]||[]).forEach(it=>{ cnts[it.id]=(cnts[it.id]||0)+1; });
  for(const p of list){
    const tile = document.createElement('div'); tile.className='tile'; tile.dataset.id=p.id;
    tile.innerHTML = `
      <div class="emoji">${p.emoji}</div>
      <div class="info">
        <div class="name">${p.name}</div>
        <div class="meta">${p.ml}ml / ${p.abv}% ãƒ» ç´„${JPY(p.price)}</div>
      </div>
      <div class="badge" ${cnts[p.id]? 'data-show="1"':''}>${cnts[p.id] ? (cnts[p.id]>99?'99+':cnts[p.id]) : ''}</div>
    `;
    tile.addEventListener('click', (e)=>{ if(e.target.classList.contains('badge')) return; addOne(p); });
    tile.querySelector('.badge').addEventListener('click', (e)=>{ e.stopPropagation(); removeOne(p.id); });
    elTiles.appendChild(tile);
  }
}

/* ========= KPIæç”» ========= */
function fmtHM(d){ const z=n=>String(n).padStart(2,'0'); return `${z(d.getHours())}:${z(d.getMinutes())}`; }
function isCarryover(d){
  if(!d || !d.dayKey) return false;
  const hour = jstNow().getHours();
  if(hour < (settings.cutoffHour || 10)) return false; // æ³¨è¨˜ã¯10:00ä»¥é™ã®ã¿
  const yest = ymdJST(addDays(jstDateFromKey(todayKey()), -1));
  return (d.dayKey === yest) && (d.remain_g > 0);
}
function renderKPI(){
  const key = activeInputKey(); const s = sumDay(key);
  document.getElementById('kpi-liters').textContent = (s.ml/1000).toFixed(2);
  document.getElementById('kpi-grams').textContent = Math.round(s.g);
  document.getElementById('kpi-yen').textContent   = JPY(s.yen);

  const d = computeRemain();
  const bar = document.getElementById('decomp-bar');
  if(bar) bar.style.width = d.progress + '%';

  let etaText = d.eta ? ('åˆ†è§£æ™‚é–“ ' + fmtHM(d.eta)) : 'åˆ†è§£æ™‚é–“ --:--';
  if(isCarryover(d)) etaText += 'ï¼ˆå‰æ—¥åˆ†ï¼‰';
  document.getElementById('decomp-eta').textContent = etaText;

  let startLbl = 'èµ·ç‚¹: --:--ï¼ˆè‡ªå‹•ï¼‰';
  if(d.dayKey){
    const m = meta[d.dayKey]; const lm = sumDay(d.dayKey).lastTs;
    const autoTime = lm? fmtHM(new Date(lm)) : '--:--';
    startLbl = (m && m.decompMode==='manual' && m.decompStartTs) ? `èµ·ç‚¹: ${fmtHM(new Date(m.decompStartTs))}ï¼ˆæ‰‹å‹•ï¼‰` : `èµ·ç‚¹: ${autoTime}ï¼ˆè‡ªå‹•ï¼‰`;
  }
  document.getElementById('kpi-startLabel').textContent = startLbl;

  applyIntoxTint(d.remain_g);
}

/* ========= 7æ—¥/30æ—¥/12ãƒ¶æœˆãƒ‡ãƒ¼ã‚¿ ========= */
function buildHistory(){
  function daily(n){
    const arr=[]; const base=jstDateFromKey(todayKey());
    for(let i=n-1;i>=0;i--){ const d=addDays(base,-i); const k=ymdJST(d); const s=sumDay(k);
      arr.push({date:d, key:k, g:s.g||0, yen:s.yen||0}); }
    return arr;
  }
  function monthly(n){
    const arr=[]; const now=jstNow();
    for(let i=n-1;i>=0;i--){ const m=new Date(now); m.setMonth(m.getMonth()-i,1); m.setHours(0,0,0,0);
      const ym=ymJST(m); const s=sumMonth(ym);
      arr.push({date:m, ym, g:s.g||0, yen:s.yen||0}); }
    return arr;
  }
  return { daily7:daily(7), daily30:daily(30), monthly12:monthly(12) };
}

/* ========= ã‚°ãƒ©ãƒ• ========= */
const canvas = document.getElementById('chart'); const ctx = canvas.getContext('2d');
function drawChart(range, data){
  const ratio = window.devicePixelRatio || 1;
  canvas.width  = canvas.clientWidth  * ratio;
  canvas.height = canvas.clientHeight * ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);

  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);

  const W=canvas.clientWidth, H=canvas.clientHeight;
  const padL=56, padR=56, padT=28, padB=38; // ç›®ç››ãƒ©ãƒ™ãƒ«ç”¨ã«å·¦å³ä½™ç™½ã‚’å°‘ã—æ‹¡å¤§
  const plotW=W-padL-padR, plotH=H-padT-padB;

  const maxG=Math.max(10,Math.ceil(Math.max(1,...data.map(d=>d.g))*1.2/10)*10);
  const maxY=Math.max(1000,Math.ceil(Math.max(1,...data.map(d=>d.yen))*1.2/1000)*1000);

  // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ï¼ˆ5æœ¬ï¼‰
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=padT+plotH-plotH*i/4;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
  }

  // ===== å‡¡ä¾‹ï¼ˆã‚°ãƒ©ãƒ•å†…ï¼‰ =====
  const legendX = padL + 4, legendY = 18;
  // æ£’ã‚µãƒ³ãƒ—ãƒ«ï¼ˆç´”ã‚¢ãƒ«ï¼‰
  ctx.fillStyle = '#60a5fa';
  ctx.fillRect(legendX, legendY-9, 14, 14);
  ctx.fillStyle = '#374151';
  ctx.font = '12px system-ui,sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('ç´”ã‚¢ãƒ« (g)', legendX + 20, legendY+2);
  // ç·šã‚µãƒ³ãƒ—ãƒ«ï¼ˆé‡‘é¡ï¼‰
  const lineX1 = legendX + 110, lineX2 = lineX1 + 28, lineY = legendY-2;
  ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(lineX1, lineY); ctx.lineTo(lineX2, lineY); ctx.stroke();
  ctx.fillStyle = '#ef4444';
  ctx.beginPath(); ctx.arc((lineX1+lineX2)/2, lineY, 3, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#374151';
  ctx.fillText('é‡‘é¡ (Â¥)', lineX2 + 8, legendY+2);

  // ===== è»¸ãƒ©ãƒ™ãƒ«ï¼ˆç¸¦ãƒ»å˜ä½ä»˜ãï¼‰ =====
  ctx.save();
  ctx.font='12px system-ui,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  // å·¦ï¼šç´”ã‚¢ãƒ«(g)
  ctx.translate(12, padT + plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#60a5fa';
  ctx.fillText('ç´”ã‚¢ãƒ« (g)', 0, 0);
  ctx.restore();

  ctx.save();
  ctx.font='12px system-ui,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  // å³ï¼šé‡‘é¡(Â¥)
  ctx.translate(W-12, padT + plotH/2);
  ctx.rotate(Math.PI/2);
  ctx.fillStyle='#ef4444';
  ctx.fillText('é‡‘é¡ (Â¥)', 0, 0);
  ctx.restore();

  // ===== è»¸ã®æ•°å€¤ç›®ç››ï¼ˆå·¦=ç´”ã‚¢ãƒ«, å³=é‡‘é¡ï¼‰ =====
  const tickCount = 5; // 0ã€œmaxã®5æ®µ
  ctx.font='11px system-ui,sans-serif';
  ctx.fillStyle='#6b7280';
  ctx.textBaseline='middle';

  // å·¦è»¸ç›®ç››ï¼ˆå€¤ã®ã¿ã€å˜ä½ã¯ç¸¦ãƒ©ãƒ™ãƒ«ã§ç¤ºã™ï¼‰
  for(let i=0;i<tickCount;i++){
    const y = padT + plotH - (plotH * i/(tickCount-1));
    const v = Math.round(maxG * i/(tickCount-1));
    // ç›®ç››ç·šï¼ˆçŸ­ã„ãƒãƒƒã‚¯ï¼‰
    ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(padL-4, y); ctx.lineTo(padL, y); ctx.stroke();
    // ç›®ç››ãƒ©ãƒ™ãƒ«
    ctx.textAlign='right';
    ctx.fillText(String(v), padL-6, y);
  }

  // å³è»¸ç›®ç››ï¼ˆkè¡¨è¨˜ï¼š1000å††ä»¥ä¸Šãªã‚‰ 2k ç­‰ï¼‰
  const fmtYTick = (val)=>{
    if(maxY >= 1000) return Math.round(val/1000)+'k';
    return String(val);
  };
  for(let i=0;i<tickCount;i++){
    const y = padT + plotH - (plotH * i/(tickCount-1));
    const v = Math.round(maxY * i/(tickCount-1));
    // ãƒãƒƒã‚¯
    ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(W-padR, y); ctx.lineTo(W-padR+4, y); ctx.stroke();
    // ãƒ©ãƒ™ãƒ«
    ctx.textAlign='left';
    ctx.fillText(fmtYTick(v), W-padR+6, y);
  }

  // ===== æ£’ã‚°ãƒ©ãƒ•ï¼ˆç´”ã‚¢ãƒ« gï¼‰=====
  const n=data.length, gap=6, bw=Math.max(6,Math.floor((plotW-gap*(n-1))/n));
  ctx.fillStyle='#60a5fa';
  data.forEach((d,i)=>{
    const x=padL+i*(bw+gap);
    const h=Math.round((d.g/maxG)*plotH);
    ctx.fillRect(x, padT+plotH-h, bw, h);
  });

  // ===== æŠ˜ã‚Œç·šï¼ˆé‡‘é¡ Â¥ï¼‰=====
  ctx.strokeStyle='#ef4444'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((d,i)=>{
    const x=padL+i*(bw+gap)+bw/2;
    const y=padT+plotH-(d.yen/maxY)*plotH;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle='#ef4444';
  data.forEach((d,i)=>{
    const x=padL+i*(bw+gap)+bw/2;
    const y=padT+plotH-(d.yen/maxY)*plotH;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });

  // Xè»¸ãƒ©ãƒ™ãƒ«
  ctx.fillStyle='#6b7280'; ctx.textAlign='center'; ctx.font='11px system-ui,sans-serif';
  data.forEach((d,i)=>{
    const x=padL+i*(bw+gap)+bw/2;
    const m=d.date.getMonth()+1, day=d.date.getDate();
    const lbl= (range==='12m')? `${m}æœˆ` : `${m}/${day}`;
    ctx.fillText(lbl,x,H-18);
  });
}


/* ========= é‡‘é¡æ›ç®—ï¼ˆé«˜é¡å“ã¾ã§ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰ ========= */
// EarPodsç›¸å½“ã¯å‰Šé™¤æ¸ˆã¿
const moneyCatalog = [
  {name:'éƒ½å†…ç‰‡é“',              price:200,     icon:'ğŸšƒ'},
  {name:'ãŠã«ãã‚Š',              price:140,     icon:'ğŸ™'},
  {name:'ã‚³ãƒ¼ãƒ’ãƒ¼',              price:150,     icon:'â˜•'},
  {name:'ã‚±ãƒ¼ã‚­ã‚»ãƒƒãƒˆ',          price:800,     icon:'ğŸ°'},
  {name:'éŸ³æ¥½ã‚µãƒ–ã‚¹ã‚¯(æœˆ)',      price:980,     icon:'ğŸ§'},
  {name:'ç‰›ä¸¼',                  price:500,     icon:'ğŸš'},
  {name:'ã‚µã‚¦ãƒŠ',                price:1200,    icon:'â™¨ï¸'},
  {name:'æ›¸ç±1å†Š',               price:1500,    icon:'ğŸ“˜'},
  {name:'æ˜ ç”»',                  price:1900,    icon:'ğŸ¬'},
  {name:'ãƒ•ãƒ¬ãƒ³ãƒãƒ•ãƒ«ã‚³ãƒ¼ã‚¹(1å›)', price:12000,   icon:'ğŸ½ï¸'},
  {name:'ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹ã‚¤ãƒ¤ãƒ›ãƒ³',     price:15000,   icon:'ğŸ§'},
  {name:'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ1å°',          price:50000,   icon:'ğŸ“±'},
  {name:'ãƒãƒ¼ãƒˆPC1å°',            price:120000,  icon:'ğŸ’»'},
  {name:'é›»å‹•ã‚¢ã‚·ã‚¹ãƒˆè‡ªè»¢è»Š',     price:140000,  icon:'ğŸš²'},
  {name:'ã‚²ãƒ¼ãƒŸãƒ³ã‚°PC',           price:250000,  icon:'ğŸ–¥ï¸'},
  {name:'è»½è‡ªå‹•è»Š1å°',            price:1200000, icon:'ğŸš—'},
];
function pickComparisonByTotal(sumY){
  if(!Number.isFinite(sumY) || sumY <= 0) return null;
  let chosen = moneyCatalog[0];
  for(const item of moneyCatalog){
    if(item.price <= sumY) chosen = item; else break;
  }
  const n = Math.max(1, Math.floor(sumY / chosen.price));
  return { icon: chosen.icon, text: `${chosen.name} Ã— ${n} å›ã¶ã‚“` };
}
function renderSummaryCards(range,data){
  let sumY=0,sumG=0; data.forEach(d=>{ sumY+=d.yen; sumG+=d.g; });
  document.getElementById('sum-yen').textContent=JPY(sumY);
  document.getElementById('sum-g').textContent=`${Math.round(sumG)} g`;
  const cmp = pickComparisonByTotal(sumY);
  document.getElementById('comment-money').textContent = cmp ? `${cmp.icon} ${cmp.text}` : 'â€”';
  document.getElementById('comment-grams').textContent = sumG===0? 'ãƒŠã‚¤ã‚¹ä¼‘è‚æ—¥ğŸ‘Œ' : sumG<120? 'æ§ãˆã‚ã§è‰¯ã„ãƒãƒ©ãƒ³ã‚¹ğŸ‘' : sumG<300? 'å°‘ã—å¤šã‚ã€‚æ°´åˆ†ã¨ç¡çœ ã‚’ã—ã£ã‹ã‚Šã€‚' : 'ã‹ãªã‚Šå¤šã‚ã€‚æ•°æ—¥ã¯ä¼‘è‚æ—¥ã‚’ã€‚';
}

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ========= */
function ymLabel(ym){ const [Y,M]=ym.split('-').map(Number); return `${Y}å¹´${M}æœˆ`; }
function shiftYM(ym,delta){ let [Y,M]=ym.split('-').map(Number); M+=delta; while(M<=0){M+=12;Y--;} while(M>12){M-=12;Y++;} return `${Y}-${String(M).padStart(2,'0')}`; }
function stageFromTotalG(g){ if(g<=20)return 0; if(g<=60)return 1; if(g<=120)return 2; return 3; }
function colorForStage(s){ return ['#e8f1ff','#93c5fd','#ef4444','#111827'][s]||'#e8f1ff'; }

// ãã®æ—¥ã®é£²é…’ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå®¶/å¤–/ä¸¡æ–¹â†’å¤–å„ªå…ˆï¼‰
function drinkingStyleOfDay(key){
  const arr = logs[key] || [];
  let hasHome=false, hasOut=false;
  for(const it of arr){
    if((presets.home||[]).some(p=>p.id===it.id)) hasHome=true;
    if((presets.out||[]).some(p=>p.id===it.id))  hasOut=true;
  }
  if(hasOut) return 'out';
  if(hasHome) return 'home';
  return null;
}

function renderCalendar(){
  const panel=document.getElementById('calendarPanel'); const grid=document.getElementById('calendarGrid'); const title=document.getElementById('cal-title'); const totals=document.getElementById('cal-totals');
  if(!panel||!grid) return;
  if(title) title.textContent=ymLabel(calSel);

  // æœˆåˆè¨ˆï¼šé‡‘é¡ã¨ç´”ã‚¢ãƒ«
  let monthlyG=0, monthlyY=0;
  for(const k in logs){ if(k.startsWith(calSel)){ const s=sumDay(k); monthlyG += (s.g||0); monthlyY += (s.yen||0); } }

  // ä¸Šéƒ¨ãƒãƒƒãƒ—è¡¨ç¤ºï¼šé‡‘é¡åˆè¨ˆã¨ç´”ã‚¢ãƒ«åˆè¨ˆ
  if(totals){
    totals.innerHTML = [
      `<span class="calChip">é‡‘é¡åˆè¨ˆ ${JPY(monthlyY)}</span>`,
      `<span class="calChip">ç´”ã‚¢ãƒ«åˆè¨ˆ ${Math.round(monthlyG)} g</span>`
    ].join(' ');
  }

  // ã‚°ãƒªãƒƒãƒ‰
  grid.innerHTML='';
  const first = new Date(`${calSel}-01T00:00:00+09:00`);
  const endTmp = new Date(first); endTmp.setMonth(endTmp.getMonth()+1); endTmp.setDate(0);
  const last = endTmp; const startW = first.getDay();

  for(let i=0;i<startW;i++){ const c=document.createElement('div'); c.className='cell'; c.dataset.empty='1'; grid.appendChild(c); }

  for(let d=1; d<=last.getDate(); d++){
    const key=`${calSel}-${pad(d)}`; const s=sumDay(key); const g=Math.round(s.g||0); const st=stageFromTotalG(g);
    const style = drinkingStyleOfDay(key);
    const icon = style==='out' ? 'ğŸ®' : style==='home' ? 'ğŸ ' : '';
    const c=document.createElement('div'); c.className='cell'; c.style.background=colorForStage(st); c.dataset.key=key;
    c.innerHTML=`<small>${d}</small><div class="val">${icon? `<span>${icon}</span>`:''}<span>${g>0? `${g}g` : ''}</span></div>`;
    grid.appendChild(c);
  }

  // ã‚»ãƒ«ã‚¿ãƒƒãƒ—ã§æ—¥åˆ¥å†…è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  grid.onclick = (ev)=>{
    const cell = ev.target.closest('.cell');
    if(!cell || cell.dataset.empty==='1' || !cell.dataset.key) return;
    openDayDetail(cell.dataset.key);
  };
}

/* ========= æ—¥åˆ¥å†…è¨³ ========= */
function openDayDetail(key){
  const list = logs[key] || [];
  const s = sumDay(key); // {ml,g,yen,count,items}
  const byName = {}; // ç¨®é¡åˆ¥é›†è¨ˆï¼šnameã”ã¨ã« count / ml / g / yen
  for(const it of list){
    const name = it.name || 'ä¸æ˜';
    if(!byName[name]) byName[name] = { count:0, ml:0, g:0, yen:0, emoji: it.emoji || '' };
    byName[name].count += 1;
    byName[name].ml    += (it.ml || 0);
    byName[name].g     += (it.ml*(it.abv/100)*0.8) || 0;
    byName[name].yen   += (it.price || 0);
  }

  // ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¦ç´„
  const dt = jstDateFromKey(key);
  const title = document.getElementById('dayTitle');
  const summary = document.getElementById('daySummary');
  if(title)  title.textContent = `${dt.getMonth()+1}/${dt.getDate()} ã®å†…è¨³`;
  if(summary) summary.textContent = `ç´”ã‚¢ãƒ«åˆè¨ˆï¼š${Math.round(s.g||0)} gã€€ï½œã€€é‡‘é¡åˆè¨ˆï¼š${JPY(s.yen||0)}ã€€ï½œã€€ã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼š${s.count||0}`;

  // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“
  const tbodyRows = Object.entries(byName).sort((a,b)=> (b[1].yen)-(a[1].yen)).map(([name, v])=>{
    const em = v.emoji || '';
    return `<tr>
      <td>${em} ${name}</td>
      <td>${v.count}</td>
      <td>${Math.round(v.ml)} ml</td>
      <td>${Math.round(v.g)} g</td>
      <td>${JPY(v.yen)}</td>
    </tr>`;
  }).join('');

  const html = `
    <thead>
      <tr><th>ç¨®é¡</th><th>æ•°</th><th>é‡</th><th>ç´”ã‚¢ãƒ«</th><th>é‡‘é¡</th></tr>
    </thead>
    <tbody>${tbodyRows || `<tr><td colspan="5" style="text-align:center;color:var(--muted)">è¨˜éŒ²ãªã—</td></tr>`}</tbody>
    <tfoot>
      <tr><td>åˆè¨ˆ</td><td>${s.count||0}</td><td>${Math.round(s.ml||0)} ml</td><td>${Math.round(s.g||0)} g</td><td>${JPY(s.yen||0)}</td></tr>
    </tfoot>
  `;
  const tbl = document.getElementById('dayTable');
  if(tbl) tbl.innerHTML = html;

  // è¡¨ç¤º
  document.getElementById('modal-day').style.display='flex';
}

/* ========= ãƒªã‚¹ã‚¯ï¼ˆBACæ¨å®šï¼‰ ========= */
function estimateBAC(){
  const key=resolveDecompTargetDay(); if(!key) return { bn:0, bp:0, key:null };
  const totalG = sumDay(key).g||0; const r=profile.r||0.70; const w=profile.weightKg||70; const betaEff=(profile.beta||0.15)*toleranceMult();
  const st=resolveStartTs(key); if(!st) return { bn:0, bp:0, key };
  const now=jstNow().getTime(); const t_h=Math.max(0,(now-st)/3600000);
  const bn=Math.max(0,(totalG/(r*w)) - betaEff*t_h) * 0.1;  // g/dL
  const bp=Math.max(bn, ((totalG/(r*w)) - betaEff*1) * 0.1); // +1h
  return { bn, bp, key };
}
function assessRiskInline(){
  const { bn, bp } = estimateBAC(); const x=Math.max(bn,bp);
  if(x>=0.12 && x<0.16) showSnack('ã“ã®ãƒšãƒ¼ã‚¹ã ã¨è¨˜æ†¶ãŒæ›–æ˜§ã«ãªã‚‹æã‚Œã€‚æ°´åˆ†ã¨ãƒšãƒ¼ã‚¹èª¿æ•´ã‚’ã€‚');
  else if(x>=0.16 && x<0.18) showSnack('ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚ã„ã£ãŸã‚“ä¼‘ã¿ã¾ã›ã‚“ã‹ï¼Ÿ');
}
function nextMorning7JST(){ const t=jstNow(); const d=new Date(t); d.setDate(d.getDate()+1); d.setHours(7,0,0,0); return d; }
function warnNotSoberBy7(){
  const d=computeRemain(); if(!d.dayKey || d.startTs==null) return;
  const m=meta[d.dayKey]||{decompMode:'auto'}; if(m.warn7Shown) return;
  const speed=rateGph(); const hoursTo7=Math.max(0,(nextMorning7JST()-jstNow())/3600000); const remainAt7=Math.max(0,(d.remain_g||0)-speed*hoursTo7);
  if(remainAt7>0){ showSnack(`ğŸ˜µ æ˜æœ7æ™‚ã¾ã§ã«æŠœã‘ãªã„äºˆæ¸¬ï¼šæ®‹ã‚Šç´„${Math.round(remainAt7)}gã€‚`); meta[d.dayKey]={...m,warn7Shown:true}; ls.set(K_META, meta); }
}
function warnPreBlackout(){
  const { bn, bp, key } = estimateBAC(); if(!key) return;
  const m=meta[key]||{decompMode:'auto'}; if(m.preWarnShown) return;
  const x=Math.max(bn,bp);
  if(x>=0.18 && x<0.20){ showSnack(`âš ï¸ ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ‰‹å‰ã‹ã‚‚ã€‚æ¨å®šãƒ”ãƒ¼ã‚¯ ${(x*1000).toFixed(0)}â€°ã€‚`); meta[key]={...m,preWarnShown:true}; ls.set(K_META, meta); }
}

/* ========= å±¥æ­´ ========= */
function renderHistory(){
  const payload=buildHistory(); const range=histRange||'30d';
  const ds = range==='7d'? payload.daily7 : range==='30d'? payload.daily30 : payload.monthly12;
  drawChart(range, ds); renderSummaryCards(range, ds);
  document.getElementById('rangeLabel').textContent = range==='7d'?'ç›´è¿‘7æ—¥':range==='30d'?'ç›´è¿‘30æ—¥':'éå»12ã‹æœˆ';
  renderCalendar();
  if(typeof drawScene==='function') drawScene();
}

/* ========= ç”»é¢é·ç§» & ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById('tab-input').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','true');
  document.getElementById('tab-history').setAttribute('aria-pressed','false');
  document.getElementById('sec-input').hidden=false;
  document.getElementById('sec-history').hidden=true;
  renderAll();
});
document.getElementById('tab-history').addEventListener('click', ()=>{
  document.getElementById('tab-input').setAttribute('aria-pressed','false');
  document.getElementById('tab-history').setAttribute('aria-pressed','true');
  document.getElementById('sec-input').hidden=true;
  document.getElementById('sec-history').hidden=false;
  renderHistory();
});

document.getElementById('seg-home').addEventListener('click', ()=>{ mode='home'; document.getElementById('seg-home').setAttribute('aria-pressed','true'); document.getElementById('seg-out').setAttribute('aria-pressed','false'); renderPresetTiles(); });
document.getElementById('seg-out').addEventListener('click', ()=>{ mode='out';  document.getElementById('seg-out').setAttribute('aria-pressed','true'); document.getElementById('seg-home').setAttribute('aria-pressed','false'); renderPresetTiles(); });
document.getElementById('btn-clear').addEventListener('click', ()=>{ if(confirm('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥ã®å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) clearActiveDay(); });

// è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
function openSettings(){
  document.getElementById('in-weight').value = profile.weightKg||70;
  document.getElementById('sel-r').value = String(profile.r||0.70);
  document.getElementById('in-beta').value = profile.beta||0.15;
  document.getElementById('betaLabel').textContent = (profile.beta||0.15).toFixed(2);
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked = (r.value === (profile.tol||'normal')));
  document.getElementById('modal-settings').style.display='flex';
}
function closeSettings(){ document.getElementById('modal-settings').style.display='none'; }
function saveSettings(){
  const w=parseFloat(document.getElementById('in-weight').value)||70;
  const r=parseFloat(document.getElementById('sel-r').value)||0.70;
  const b=parseFloat(document.getElementById('in-beta').value)||0.15;
  const tol=document.querySelector('input[name="tol"]:checked').value;
  profile.weightKg=clamp(w,30,150); profile.r=r; profile.beta=clamp(b,0.10,0.20); profile.tol=tol; ls.set(K_PROFILE, profile);
  closeSettings(); renderAll();
}
document.getElementById('btn-settings').addEventListener('click', openSettings);
document.getElementById('btn-close-settings').addEventListener('click', closeSettings);
document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
document.getElementById('btn-self').addEventListener('click', ()=>{
  const qs=[...document.querySelectorAll('#modal-settings select.q')];
  const score=qs.reduce((a,s)=>a+Number(s.value),0); let tol='normal', mult=1.0, msg='';
  if(score<=5){ tol='weak'; mult=0.85; msg='è€æ€§ã€Œå¼±ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=0.85ï¼‰'; }
  else if(score<=9){ tol='normal'; mult=1.0; msg='è€æ€§ã€Œæ™®é€šã€ã‚’æ¨å¥¨ï¼ˆtol=1.0ï¼‰'; }
  else { tol='strong'; mult=1.15; msg='è€æ€§ã€Œå¼·ã„ã€ã‚’æ¨å¥¨ï¼ˆtol=1.15ï¼‰'; }
  profile.tol=tol; profile.tol_mult=mult; document.getElementById('selfNote').textContent=msg;
  document.querySelectorAll('input[name="tol"]').forEach(r=> r.checked=(r.value===tol));
});

// èµ·ç‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«
document.getElementById('kpi-startLabel').addEventListener('click', ()=>{
  const day=resolveDecompTargetDay(); const md=meta[day]||{decompMode:'auto'};
  document.querySelectorAll('input[name="startMode"]').forEach(r=> r.checked = (r.value === (md.decompMode||'auto')));
  const dt=day? jstDateFromKey(day) : jstNow(); document.getElementById('in-start-date').value = ymdJST(dt);
  const time=md.decompStartTs? new Date(md.decompStartTs): jstNow();
  document.getElementById('in-start-time').value = `${pad(time.getHours())}:${pad(time.getMinutes())}`;
  document.getElementById('manualArea').style.opacity = (md.decompMode==='manual')?1:0.5;
  document.getElementById('modal-start').style.display='flex';
});
document.querySelectorAll('input[name="startMode"]').forEach(r=>{
  r.addEventListener('change', ()=>{ document.getElementById('manualArea').style.opacity = (r.value==='manual')?1:0.5; });
});
document.getElementById('btn-close-start').addEventListener('click', ()=> document.getElementById('modal-start').style.display='none');
document.getElementById('btn-save-start').addEventListener('click', ()=>{
  const day=resolveDecompTargetDay(); if(!day){ document.getElementById('modal-start').style.display='none'; return; }
  const mode=document.querySelector('input[name="startMode"]:checked').value;
  if(mode==='auto'){ meta[day]={decompMode:'auto'}; }
  else {
    const d=document.getElementById('in-start-date').value || day;
    const t=document.getElementById('in-start-time').value || '00:00';
    const ts=new Date(`${d}T${t}:00+09:00`).getTime();
    meta[day]={decompMode:'manual', decompStartTs:ts};
  }
  ls.set(K_META, meta); document.getElementById('modal-start').style.display='none'; renderAll(); warnPreBlackout(); warnNotSoberBy7();
});

// å±¥æ­´ãƒ¬ãƒ³ã‚¸
document.querySelectorAll('.rangeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.rangeBtn').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true'); histRange=btn.dataset.range; ls.set(K_RANGE, histRange); renderHistory();
  });
});

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“
const _prev=document.getElementById('cal-prev'), _next=document.getElementById('cal-next');
if(_prev) _prev.addEventListener('click', ()=>{ calSel=shiftYM(calSel,-1); ls.set(K_CAL_SEL,calSel); renderCalendar(); });
if(_next) _next.addEventListener('click', ()=>{ calSel=shiftYM(calSel,+1); ls.set(K_CAL_SEL,calSel); renderCalendar(); });

// æ—¥åˆ¥å†…è¨³ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
document.getElementById('btn-close-day').addEventListener('click', ()=>{
  document.getElementById('modal-day').style.display='none';
});

/* ========= å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========= */
function renderAll(){
  renderPresetTiles(); renderKPI(); updateActiveDateUI();
  if(document.getElementById('sec-history').hidden===false) renderHistory();
}

/* ========= èµ·å‹• ========= */
window.addEventListener('load', ()=>{
  // æ—¢å®šå€¤è£œæ­£
  if(!profile.weightKg) profile.weightKg=70;
  if(!profile.beta) profile.beta=0.15;
  if(!profile.r) profile.r=0.70;

  renderAll();
  // 1åˆ†ã”ã¨ã«åˆ†è§£é€²æ—/æ—¥ä»˜UIæ›´æ–°
  setInterval(()=>{ renderKPI(); updateActiveDateUI(); if(typeof drawScene==='function') drawScene(); warnNotSoberBy7(); }, 60*1000);
});
</script>
```

<!-- Pixi: ã‚·ãƒ¼ãƒ³æç”»ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/pixi.js@7/dist/pixi.min.js"></script>
<script src="https://unpkg.com/pixi-filters@6/dist/pixi-filters.js"></script>

<script>
/* =======================
   Pixi ã‚·ãƒ¼ãƒ³æç”»ï¼ˆPart3ï¼‰
   ======================= */

let __pixiApp = null;
let __stageState = { stage:'S0', base:'living', action:'home_read' };
let __lastPickTs = 0;

function ensurePixiApp(){
  const host = document.getElementById('scene');
  if(!host || !window.PIXI) return null;

  if(!__pixiApp){
    __pixiApp = new PIXI.Application({
      backgroundAlpha: 0,
      antialias: true,
      resizeTo: host,
    });
    host.innerHTML = '';
    host.appendChild(__pixiApp.view);

    __pixiApp.$L = {
      BG:   new PIXI.Container(),
      MID:  new PIXI.Container(),
      ACT:  new PIXI.Container(),
      FX:   new PIXI.Container(),
      UI:   new PIXI.Container(),
    };
    __pixiApp.stage.addChild(__pixiApp.$L.BG, __pixiApp.$L.MID, __pixiApp.$L.ACT, __pixiApp.$L.FX, __pixiApp.$L.UI);
  }
  return __pixiApp;
}

/* ---- ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®šï¼ˆé…”ã„æ®µéšï¼‰ ---- */
function decideStage(){
  const { bn, bp } = (typeof estimateBAC==='function') ? estimateBAC() : {bn:0,bp:0};
  const x = Math.max(bn, bp); // g/dL
  if(x >= 0.20) return 'S7';
  if(x >= 0.17) return 'S6';
  if(x >= 0.14) return 'S5';
  if(x >= 0.11) return 'S4';
  if(x >= 0.08) return 'S3';
  if(x >= 0.05) return 'S2';
  if(x >= 0.02) return 'S1';
  return 'S0';
}

/* ---- ãƒ™ãƒ¼ã‚¹èƒŒæ™¯ã¨è¡Œå‹•ã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆ90ç§’å›ºå®šï¼‰ ---- */
function pickBaseAndAction(stage){
  const now = Date.now();
  if(__stageState.stage === stage && (now - __lastPickTs) < 90_000){
    return { base: __stageState.base, action: __stageState.action };
  }

  let base, action;
  if(stage==='S0'){
    base = Math.random()<0.6 ? 'living' : 'train';
    action = base==='living' ? (Math.random()<0.5?'home_read':(Math.random()<0.5?'home_phone':'home_stretch'))
                             : (Math.random()<0.5?'trn_stand_phone':(Math.random()<0.5?'trn_seat_read':'trn_seat_sleep'));
  }else if(stage==='S1'){
    base = 'downtown_day';
    action = Math.random()<0.5?'walk':'walk_phone';
  }else if(stage==='S2'){
    base = 'izakaya';
    action = ['cheers','talk','phone'][Math.floor(Math.random()*3)];
  }else if(stage==='S3'){
    base = 'izakaya';
    action = ['karaoke','loud','cheers'][Math.floor(Math.random()*3)];
  }else if(stage==='S4'){
    base = 'downtown_night';
    action = Math.random()<0.5?'stagger':'stagger_phone';
  }else if(stage==='S5'){
    base = 'park_night';
    action = Math.random()<0.5?'bench_slump':'bench_sleep';
  }else if(stage==='S6'){
    base = Math.random()<0.5 ? 'park_night' : 'downtown_night';
    action = Math.random()<0.5 ? 'bench_slump' : 'stagger_hard';
  }else{ // S7
    base = 'jail';
    action = 'hold';
  }

  __lastPickTs = now;
  return { base, action };
}

/* ---- èƒŒæ™¯æ§‹ç¯‰ï¼ˆEmojiï¼‹å›³å½¢ï¼‰ ---- */
function buildBackground(app, base){
  const { BG, MID } = app.$L;
  BG.removeChildren(); MID.removeChildren();

  const W = app.renderer.width, H = app.renderer.height;
  const rect = (x,y,w,h, c)=>{ const g=new PIXI.Graphics(); g.beginFill(c).drawRoundedRect(x,y,w,h,8).endFill(); return g; };
  const text = (str, size, x, y, a=0.5)=>{ const t=new PIXI.Text(str,{fontSize:size}); t.anchor.set(0.5,a); t.x=x; t.y=y; return t; };

  if(base==='living'){
    BG.addChild(rect(0,0,W,H,0xEAF2FF));
    MID.addChild(rect(0,H-40,W,40,0xE5E7EB));
    MID.addChild(rect(24,H-80,120,40,0xCBD5E1));
    MID.addChild(rect(W-180,H-120,140,90,0x9CA3AF));
    MID.addChild(rect(W-165,H-110,110,60,0x111827));
    MID.addChild(text('ğŸ ', Math.min(40, H*0.25), 24+60, H-88));
  }else if(base==='train'){
    BG.addChild(rect(0,0,W,H,0xE6F0FF));
    MID.addChild(rect(0,H-36,W,36,0x9CA3AF));
    for(let i=0;i<4;i++){
      MID.addChild(rect(20+i*(W/4),20,(W/4)-40,46,0xD1E9FF));
      MID.addChild(text('ğŸšƒ', 20, 20+i*(W/4)+(W/8)-20, 24, 0.5));
    }
    for(let i=0;i<6;i++){
      const x = 40 + i*(W/6.5);
      MID.addChild(text('ğŸ«³', 20, x, 80, 0.5));
    }
  }else if(base==='downtown_day'){
    BG.addChild(rect(0,0,W,H,0xDFF1FF));
    MID.addChild(rect(0,H-40,W,40,0x0B1020));
    for(let i=0;i<5;i++){
      const x = 20 + i*(W/5);
      MID.addChild(rect(x, H-160, 70, 120, 0x1E293B));
      MID.addChild(text('ğŸ¢', 24, x+35, H-160+10, 0.5));
    }
  }else if(base==='downtown_night'){
    BG.addChild(rect(0,0,W,H,0x0F172A));
    MID.addChild(rect(0,H-40,W,40,0x0B1020));
    for(let i=0;i<5;i++){
      const x = 20 + i*(W/5);
      MID.addChild(rect(x, H-160, 70, 120, 0x1E293B));
      MID.addChild(text('ğŸŒƒ', 24, x+35, H-160+10, 0.5));
    }
    MID.addChild(rect(W-120, H-210, 100, 40, 0xEF4444));
    MID.addChild(text('ğŸ¶', 24, W-70, H-190, 0.5));
  }else if(base==='izakaya'){
    BG.addChild(rect(0,0,W,H,0xFFF3D6));
    MID.addChild(rect(0,H-50,W,50,0x1F2937));
    MID.addChild(rect(40,80,W-80,100,0xF59E0B));
    for(let i=0;i<Math.max(4, Math.floor(W/120)); i++){
      MID.addChild(text('ğŸ®', 24, 80 + i*100, 74, 0.5));
    }
    MID.addChild(rect(W/2-160, H-90, 320, 16, 0x92400E));
  }else if(base==='park_night'){
    BG.addChild(rect(0,0,W,H,0x0B1020));
    MID.addChild(rect(0,H-40,W,40,0x123222));
    MID.addChild(text('ğŸŒ™', 26, W-36, 20, 0.5));
    MID.addChild(rect(80, H-80, 180, 10, 0x9CA3AF));
    MID.addChild(rect(90, H-110, 20, 30, 0x9CA3AF));
    MID.addChild(rect(230,H-110, 20, 30, 0x9CA3AF));
  }else if(base==='jail'){
    BG.addChild(rect(0,0,W,H,0x0B1020));
    MID.addChild(rect(40,40,W-80,H-80,0x111827));
    for(let i=0;i<8;i++){ MID.addChild(rect(60+i*((W-120)/8),40,8,H-80,0x374151)); }
    MID.addChild(rect(40,40,W-80,8,0x374151));
    MID.addChild(rect(40,H-48,W-80,8,0x374151));
    MID.addChild(text('ğŸ‘®', 34, W-60, H-70, 0.5));
  }
}

/* ---- ä¸»äººå…¬ãƒ»ã‚¢ãƒ‹ãƒ¡ ---- */
function buildActor(app, base, action, stage){
  const { ACT, FX } = app.$L;
  ACT.removeChildren(); FX.removeChildren();

  const W = app.renderer.width, H = app.renderer.height;

  const faceByStage = {
    S0:'ğŸ™‚', S1:'ğŸ™‚', S2:'ğŸ™‚', S3:'ğŸ˜Œ',
    S4:'ğŸ¥´', S5:'ğŸ˜µâ€ğŸ’«', S6:'ğŸ¥´', S7:'ğŸ˜µ'
  };
  const fontPx = Math.max(18, Math.min(26, Math.round(H*0.12)));
  const actor = new PIXI.Text(faceByStage[stage]||'ğŸ™‚', {
    fontFamily:'"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui',
    fontSize: fontPx
  });
  actor.anchor.set(0.5, 0.95);
  ACT.addChild(actor);

  function place(){
    if(base==='living'){ actor.x=Math.min(W*0.62, W-120); actor.y=H-56; }
    else if(base==='train'){ actor.x=W*0.5; actor.y=H-42; }
    else if(base==='park_night'){ actor.x=W*0.35; actor.y=H-48; }
    else if(base==='jail'){ actor.x=W*0.2; actor.y=H*0.82; }
    else { actor.x=W*0.2; actor.y=H*0.82; }
  }
  place();

  // å¤œã¯å¼±ã‚°ãƒ­ãƒ¼
  const night = /night|jail/.test(base);
  const glow = new PIXI.Text(actor.text, actor.style);
  glow.anchor.copyFrom(actor.anchor); glow.x=actor.x; glow.y=actor.y;
  glow.alpha = night ? 0.15 : 0.10;
  const blur = new PIXI.BlurFilter(); // pixi-filters ã¯ä¸è¦ã€æ¨™æº–ã®BlurFilterã‚’ä½¿ç”¨
  blur.blur = 3; blur.quality = 2;
  glow.filters = [blur];
  glow.blendMode = PIXI.BLEND_MODES.SCREEN;
  FX.addChild(glow);

  // ã‚¢ã‚¯ã‚»ã‚µãƒªï¼ˆğŸ“–ğŸ“±ğŸ’¤ğŸ¤ãªã©ï¼‰
  const acc = new PIXI.Container(); ACT.addChild(acc);
  const addEmoji = (txt, size, dx, dy)=>{
    const t = new PIXI.Text(txt,{fontSize:size});
    t.anchor.set(0.5,1); t.x=actor.x+dx; t.y=actor.y+dy; acc.addChild(t); return t;
  };
  let book=null, phone=null, zzz=null, mic=null, angry=null;
  if(action.includes('read')){ book = addEmoji('ğŸ“–', Math.round(fontPx*0.9), -16, -6); }
  if(action.includes('phone')){ phone = addEmoji('ğŸ“±', Math.round(fontPx*0.82), 16, -10); }
  if(action.includes('sleep')){ zzz = addEmoji('ğŸ’¤', Math.round(fontPx*0.72), -18, -28); }
  if(action==='karaoke'){ mic = addEmoji('ğŸ¤', Math.round(fontPx*0.9), 22, -22); }
  if(stage==='S3' && Math.random()<0.4){ angry = addEmoji('ğŸ˜¡', Math.round(fontPx*0.9), 56, -32); }

  // ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å¼·åº¦ï¼†é€Ÿåº¦
  const swayBy   = {S0:0.8, S1:1.2, S2:1.6, S3:2.2, S4:3.0, S5:3.8, S6:4.6, S7:0.3};
  const jitterBy = {S0:0.03,S1:0.05,S2:0.07,S3:0.10,S4:0.14,S5:0.18,S6:0.22,S7:0.01};
  const moveSpeed= {
    walk:0.6, walk_phone:0.55, cheers:0.4, talk:0.35, karaoke:0.35, loud:0.35,
    stagger:0.28, stagger_phone:0.26, stagger_hard:0.22,
    bench_slump:0.08, bench_sleep:0.05, hold:0.0,
    home_read:0.08, home_phone:0.10, home_stretch:0.12,
    trn_stand_phone:0.10, trn_seat_read:0.06, trn_seat_sleep:0.04
  }[action] || 0.1;

  let t=0;
  if(__pixiApp.$ticker){ __pixiApp.ticker.remove(__pixiApp.$ticker); }
  __pixiApp.$ticker = (delta)=>{
    t += delta/60;

    // è‡ªç„¶ãªæºã‚Œ
    const baseDeg = swayBy[stage] || 1.5;
    const jitter  = jitterBy[stage] || 0.05;
    actor.angle = Math.sin(t*2.2) * baseDeg + (Math.random()-0.5)*jitter;
    glow.angle  = actor.angle;

    // è¡Œå‹•åˆ¥ã‚¢ãƒ‹ãƒ¡
    if(action.startsWith('walk') || action.startsWith('stagger')){
      const dx = (action.includes('stagger') ? 0.8 : 1.4) * moveSpeed;
      actor.x += dx; if(actor.x > __pixiApp.renderer.width - 24) actor.x = 24;
      glow.x = actor.x;
      if(phone) phone.y = actor.y - 10 + Math.sin(t*6)*1.2;
    }else if(action==='karaoke'){
      if(mic){ mic.y = actor.y - 18 + Math.sin(t*8)*1.5; }
    }else if(action==='home_stretch'){
      actor.y = (Math.sin(t*2)*2) + (__pixiApp.renderer.height-56);
      glow.y  = actor.y;
    }else if(action==='trn_seat_sleep'){
      actor.angle = -6 + Math.sin(t*1.2)*0.6;
      glow.angle  = actor.angle;
      if(zzz){ zzz.alpha = 0.5 + 0.5*Math.sin(t*2.5); }
    }
    if(action.startsWith('bench')){
      actor.angle = -10 + Math.sin(t*1.5)*0.8;
      glow.angle  = actor.angle;
      if(zzz){ zzz.alpha = 0.5 + 0.5*Math.sin(t*2.5); }
    }

    // ã‚¢ã‚¯ã‚»ã‚µãƒªä½ç½®è¿½å¾“
    if(book){ book.x=actor.x-16; book.y=actor.y-6; }
    if(phone){ phone.x=actor.x+16; phone.y=actor.y-10; }
    if(mic){ mic.x=actor.x+22; }
    if(angry){ angry.alpha = 0.6 + 0.4*Math.sin(t*4); angry.x = actor.x+56; }
  };
  __pixiApp.ticker.add(__pixiApp.$ticker);
}

/* ---- ãƒ¡ã‚¤ãƒ³ï¼šdrawSceneï¼ˆPart2ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰ ---- */
function drawScene(){
  const app = ensurePixiApp();
  if(!app) return;

  const stage = decideStage();
  const pick = pickBaseAndAction(stage);

  __stageState = { stage, base: pick.base, action: pick.action };

  buildBackground(app, pick.base);
  buildActor(app, pick.base, pick.action, stage);
}

/* ---- ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚å†æç”» ---- */
window.addEventListener('resize', ()=>{
  if(__pixiApp) { drawScene(); }
});
</script>

</body>
</html>
