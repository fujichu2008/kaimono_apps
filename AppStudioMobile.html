<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>AppStudioMobile v2</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --surface-color: #252526;
            --accent-color: #007acc;
            --text-color: #d4d4d4;
            --border-color: #3e3e42;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --tab-height: 50px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

                /* --- Tabs (Top Navigation) --- */
        .tabs {
            display: flex;
            height: var(--tab-height);
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0; /* ç¸®å°é˜²æ­¢ */
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s, background 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--text-color);
            border-bottom-color: var(--accent-color);
            background-color: rgba(255,255,255,0.05);
        }

        /* --- Main Views --- */
        .view {
            display: none;
            flex: 1;
            /* height: calc(100vh - var(--tab-height)); Removed for flex layout */
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .view.active {
            display: flex;
            flex-direction: column;
        }

        /* --- Help Styles --- */
        .help-container {
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            font-family: "Segoe UI", sans-serif;
        }
        .help-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }
        .help-header h1 {
            font-size: 24px;
            color: var(--accent-color);
            margin: 0;
        }
        .help-section {
            margin-bottom: 25px;
            background: var(--surface-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .help-section h2 {
            font-size: 18px;
            color: var(--success-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        .help-card {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .help-card-icon { font-size: 24px; margin-bottom: 5px; display: block; }
        .help-card-title { font-weight: bold; font-size: 13px; color: var(--accent-color); }
        .help-card-desc { font-size: 11px; color: #aaa; margin-top: 4px; line-height: 1.4; }

        .step-list { list-style: none; padding: 0; }
        .step-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        .step-num {
            background: var(--accent-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }
        .step-text { font-size: 13px; line-height: 1.5; }

        /* --- Editor Styles --- */
                .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ã“ã®è¦ç´ å†…ã«é–‰ã˜è¾¼ã‚ã‚‹ */
            min-height: 0; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚ˆã‚‹Flexã‚¢ã‚¤ãƒ†ãƒ ã®è‡ªå‹•è†¨å¼µã‚’é˜²ãã€ä¸Šéƒ¨ãƒãƒ¼ã‚’åœ§è¿«ã•ã›ãªã„ */
        }

                        .CodeMirror {
            height: 100%;
            font-family: "Menlo", "Consolas", "Monaco", monospace;
            font-size: 14px;
            line-height: 1.5;
        }
                /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        .CodeMirror-scroll {
            -webkit-overflow-scrolling: touch;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã™ã‚‹è¨­å®š */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
            display: block;
            background: transparent;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.3);
            border-radius: 6px;
            border: 2px solid var(--bg-color);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        #code-editor {
            flex: 1;
            width: 100%;
            background-color: var(--bg-color);
            color: #ce9178;
            border: none;
            padding: 15px;
            padding-top: 35px; /* Space for stats/copy btn */
            font-family: "Menlo", "Consolas", "Monaco", monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
       
        #code-stats {
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 10px;
            color: #666;
            background: rgba(30,30,30,0.8);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
        }

        /* Copy Button Styles */
        .copy-float-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            z-index: 10;
        }
        .copy-float-btn:active {
            background-color: var(--accent-color);
        }

                .toolbar {
            height: 50px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            flex-shrink: 0; /* ç¸®å°é˜²æ­¢ */
        }

                        .file-bar {
            height: 45px;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            flex-shrink: 0;
        }

        .app-name-display {
            flex: 1;
            color: #aaa;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 5px;
        }

        .tool-btn {
            background-color: #333;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 32px;
        }

        .tool-btn span {
            font-size: 11px;
            white-space: nowrap;
        }

        .spacer { flex: 1; }

        .tool-btn:active {
            background-color: #444;
            transform: scale(0.98);
        }

        .tool-btn.primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .tool-btn.danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
            background: transparent;
        }
       
        .tool-btn.warning {
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        /* Tabs inside Modal */
        .modal-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .modal-tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Run View Styles --- */
        #app-frame {
            flex: 1;
            width: 100%;
            border: none;
            background-color: white;
        }

        .run-controls {
            height: 50px;
            background-color: var(--surface-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 15px;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Library Styles --- */
        .library-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

                .lib-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .lib-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .lib-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-color);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        .lib-actions {
            display: flex;
            flex-shrink: 0;
            gap: 4px;
        }
        .lib-meta {
            font-size: 11px;
            color: #888;
            width: 100%;
        }
        .lib-history {
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(0, 122, 204, 0.1);
            border-radius: 4px;
            font-size: 11px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            width: 100%;
        }
        .lib-history:hover {
            background: rgba(0, 122, 204, 0.2);
            color: white;
        }
        .lib-actions button {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-load { background-color: var(--accent-color); color: white; }
        .btn-del { background-color: var(--danger-color); border: 1px solid var(--danger-color); color: white; font-weight: bold; font-size: 16px; }

        /* --- Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal {
            background: var(--surface-color);
            width: 90%;
            max-height: 85vh;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal h2 { margin-bottom: 15px; font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .modal h3 { margin: 15px 0 10px 0; font-size: 14px; color: var(--accent-color); }
       
        .modal input, .modal textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .modal textarea {
            min-height: 80px;
            resize: vertical;
        }
       
        .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-cancel { background: #444; color: white; }
        .btn-confirm { background: var(--accent-color); color: white; }
        .btn-action { background: #333; border: 1px solid #555; color: #ddd; }

                /* Notification */
        #notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 40, 40, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 300;
            white-space: nowrap;
        }
       
        .section-desc {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

        <nav class="tabs">
        <button class="tab-btn active" onclick="switchTab('editor')">ã‚¨ãƒ‡ã‚£ã‚¿</button>
        <button class="tab-btn" onclick="switchTab('run')">å®Ÿè¡Œç”»é¢</button>
        <button class="tab-btn" onclick="switchTab('library')">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</button>
        <button class="tab-btn" onclick="switchTab('help')">ãƒ˜ãƒ«ãƒ—</button>
    </nav>

    
        <section id="view-editor" class="view active">
                        <div class="toolbar">
            <button class="tool-btn warning" onclick="openPromptModal()">
                <span>ğŸ¤– AIæŒ‡ç¤º</span>
            </button>
            <button class="tool-btn" onclick="openFixModal()">
                <span>ğŸ› ï¸ ä¿®æ­£</span>
            </button>
            <button class="tool-btn" onclick="undo()" title="å…ƒã«æˆ»ã™" style="min-width: 40px;">
                <span>â†©ï¸</span>
            </button>
            <button class="tool-btn" onclick="redo()" title="ã‚„ã‚Šç›´ã—" style="min-width: 40px;">
                <span>â†ªï¸</span>
            </button>
                                    <div class="spacer"></div>
            <button class="tool-btn" onclick="openConsultModal()" style="margin-right: 5px; border-color: #666;">
                <span>ğŸ§ AIç›¸è«‡</span>
            </button>
            <button class="tool-btn danger" onclick="clearCode()">
                <span>ğŸ—‘ ã‚¯ãƒªã‚¢</span>
            </button>
        </div>
                <div class="file-bar">
            <div id="app-name-display" class="app-name-display">(æ–°è¦ä½œæˆä¸­)</div>
            <button class="tool-btn" onclick="pasteCode()" title="å…¨ã‚³ãƒ¼ãƒ‰ä¸Šæ›¸ããƒšãƒ¼ã‚¹ãƒˆ">
                <span>ğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆ</span>
            </button>
            <button class="tool-btn primary" onclick="runCode()">
                <span>â–¶ å®Ÿè¡Œ</span>
            </button>
            <button class="tool-btn" onclick="openSaveModal()">
                <span>ğŸ’¾ ä¿å­˜</span>
            </button>
        </div>
        <div class="editor-container">
            <div id="code-stats">0è¡Œ / 0æ–‡å­—</div>
            <button class="copy-float-btn" onclick="copyFullCode()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <textarea id="code-editor" placeholder="ã“ã“ã«HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." spellcheck="false"></textarea>
        </div>
    </section>

    <section id="view-run" class="view">
        <div class="run-controls">
            <button class="tool-btn" onclick="runInNewWindow()">
                <span>â†— åˆ¥çª“ã§å®Ÿè¡Œ</span>
            </button>
            <button class="tool-btn primary" onclick="reloadFrame()" style="margin-left: 10px;">
                <span>â†» ãƒªãƒ­ãƒ¼ãƒ‰</span>
            </button>
        </div>
        <iframe id="app-frame" sandbox="allow-scripts allow-forms allow-popups allow-modals allow-same-origin"></iframe>
    </section>

    <section id="view-library" class="view">
        <div class="library-list" id="library-container">
            </div>
    </section>

    <div id="save-modal" class="modal-overlay">
        <div class="modal">
            <h2>ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
            <input type="text" id="filename-input" placeholder="ã‚¢ãƒ—ãƒªåã‚’å…¥åŠ› (ä¾‹: MyGame)">
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="saveToLibrary()">ã‚¢ãƒ—ãƒªä¿å­˜</button>
                <button class="btn-confirm" style="background: #4caf50;" onclick="downloadHTML()">HTML DL</button>
                <button class="btn-confirm" style="background: #333;" onclick="uploadToGitHub()">GitHub Repo</button>
            </div>
            <div class="modal-buttons" style="margin-top:10px;">
                <button class="btn-cancel" onclick="closeModal('save-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="consult-modal" class="modal-overlay">
        <div class="modal">
            <h2>AIç›¸è«‡ (ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ”¹å–„)</h2>
            <p class="section-desc">AIã«ç›¸è«‡ã—ãŸã„å†…å®¹ã‚’é¸æŠãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼"> ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </label>
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="ãƒã‚°ç‰¹å®š"> ãƒã‚°ç‰¹å®š
                </label>
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"> ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
                </label>
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨ºæ–­"> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
                </label>
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„"> ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„
                </label>
                <label style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                    <input type="checkbox" name="consult-cat" value="æ¡ç‚¹(100ç‚¹æº€ç‚¹)"> æ¡ç‚¹(100ç‚¹æº€ç‚¹)
                </label>
            </div>

            <textarea id="consult-text" placeholder="å…·ä½“çš„ãªç›¸è«‡å†…å®¹ (ä¾‹: ã€‡ã€‡ã®æ©Ÿèƒ½ãŒå‹•ã‹ãªã„ã€ã‚‚ã£ã¨ã‚³ãƒ¼ãƒ‰ã‚’åŠ¹ç‡åŒ–ã—ãŸã„ã€XXãªæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„ç­‰)..." style="height:100px;"></textarea>
            
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="copyConsultPrompt()">ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ & ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn-cancel" onclick="closeModal('consult-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="modal-overlay">
        <div class="modal">
                        <h2>AIæŒ‡ç¤º (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ)</h2>
            <p class="section-desc">AIã¸ã®æŒ‡ç¤ºå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <div style="position: relative;">
                <textarea id="ai-instruction" placeholder="ä¾‹: ãƒœã‚¿ãƒ³ã®è‰²ã‚’èµ¤ã«ã—ã¦ã€é…ç½®ã‚’ä¸­å¤®å¯„ã›ã«ã™ã‚‹..." style="height:80px;"></textarea>
                <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 4px;">
                    <button id="mic-btn" onclick="toggleSpeechRecognition()" style="background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; border-radius: 4px; padding: 2px 6px; font-size: 14px; cursor: pointer; min-width: 28px; transition: all 0.2s;">ğŸ¤</button>
                    <button onclick="document.getElementById('ai-instruction').value = ''" style="background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">âœ•</button>
                </div>
            </div>
           
                        <h3 style="margin-top:15px;">å‡ºåŠ›å½¢å¼ã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼</h3>
            <div class="modal-buttons">
                <button class="btn-action" onclick="copyPrompt('full')">â‘  ãƒ•ãƒ«</button>
                <button class="btn-action" onclick="copyPrompt('manual')">â‘¡ æ‰‹å‹•ä¿®æ­£</button>
                <button class="btn-action" onclick="copyPrompt('auto')">â‘¢ ã‚ªãƒ¼ãƒˆä¿®æ­£</button>
            </div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn-cancel" onclick="closeModal('prompt-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="fix-modal" class="modal-overlay">
        <div class="modal">
            <h2>ä¿®æ­£ãƒ„ãƒ¼ãƒ«</h2>
            <div class="modal-tabs">
                <button class="modal-tab-btn active" onclick="switchFixTab('auto')">â‘  ã‚ªãƒ¼ãƒˆ(JSON)</button>
                <button class="modal-tab-btn" onclick="switchFixTab('manual')">â‘¡ æ‰‹å‹•ä¿®æ­£</button>
            </div>

            <div id="tab-auto" class="tab-content active">
                <p class="section-desc">AIãŒç”Ÿæˆã—ãŸJSONã‚’è²¼ã‚Šä»˜ã‘ã¦é©ç”¨ã—ã¾ã™ã€‚</p>
                <div style="display: flex; gap: 5px; margin-bottom: 5px; justify-content: flex-end;">
                    <button class="btn-action" onclick="pasteToJsonInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none;">ğŸ“‹ è²¼ä»˜</button>
                    <button class="btn-action" onclick="clearJsonInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none; color: var(--danger-color); border-color: var(--danger-color);">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
                </div>
                <textarea id="json-input" placeholder='[{"before":"...", "after":"..."}]' style="height:120px;"></textarea>
                <div class="modal-buttons">
                    <button class="btn-confirm" onclick="applyAutoFix()">JSONé©ç”¨</button>
                </div>
            </div>

            <div id="tab-manual" class="tab-content">
                <p class="section-desc">æ¤œç´¢ã—ã¦ç½®æ›ã—ã¾ã™ã€‚</p>
                <textarea id="manual-find" placeholder="æ¤œç´¢ (ä¿®æ­£å‰)" style="height:60px;"></textarea>
                <textarea id="manual-replace" placeholder="ç½®æ› (ä¿®æ­£å¾Œ)" style="height:60px;"></textarea>
                <div class="modal-buttons">
                    <button class="btn-confirm" style="background:#ff9800;" onclick="applyManualFix()">æ‰‹å‹•ç½®æ›</button>
                </div>
            </div>

            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn-cancel" onclick="closeModal('fix-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

            <div id="history-modal" class="modal-overlay">
        <div class="modal">
            <h2>æ›´æ–°å±¥æ­´</h2>
            <div id="history-content" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: #ddd; max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn-cancel" onclick="closeModal('history-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

            <section id="view-help" class="view" style="overflow-y: auto;">
        <div class="help-container" style="max-width: 800px; margin: 0 auto;">
            <div class="help-header">
                <h1>AppStudio Mobile</h1>
                <p style="font-size: 12px; color: #888;">AIå…±å‰µå‹ãƒ»ãƒ¢ãƒã‚¤ãƒ«é–‹ç™ºç’°å¢ƒ v2</p>
            </div>

            
            <div class="help-section">
                <h2>ğŸ“± AppStudio Mobileã¨ã¯ï¼Ÿ</h2>
                <p style="font-size: 13px; line-height: 1.6;">
                    ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹ã€é«˜æ©Ÿèƒ½ãªã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ï¼†å®Ÿè¡Œç’°å¢ƒã§ã™ã€‚<br>
                    <strong>ã€ŒChatGPTã‚„Claudeãªã©ã®AIã€</strong>ã¨é€£æºã™ã‚‹ã“ã¨ã‚’å‰æã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€
                    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆã‹ã‚‰ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã¾ã§ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œã†ãŸã‚ã®å°‚ç”¨ãƒ„ãƒ¼ãƒ«ã‚’æ­è¼‰ã—ã¦ã„ã¾ã™ã€‚<br>
                    ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚’è¡Œã‚ãšã€ãƒ‡ãƒ¼ã‚¿ã¯ãŠä½¿ã„ã®ç«¯æœ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ã‚¢ã§é«˜é€Ÿã«å‹•ä½œã—ã¾ã™ã€‚
                </p>
            </div>

            
            <div class="help-section">
                <h2>ğŸš€ é–‹ç™ºã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</h2>
                <ul class="step-list">
                    <li class="step-item">
                        <span class="step-num">1</span>
                        <div class="step-text">
                            <strong>AIã«æŒ‡ç¤º (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ)</strong><br>
                            ã€ŒğŸ¤– AIæŒ‡ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…¥åŠ›ï¼ˆéŸ³å£°å…¥åŠ›å¯¾å¿œï¼‰ã€‚<br>
                            ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã€å¤–éƒ¨ã®AIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚
                        </div>
                    </li>
                    <li class="step-item">
                        <span class="step-num">2</span>
                        <div class="step-text">
                            <strong>ã‚³ãƒ¼ãƒ‰ã®é©ç”¨</strong><br>
                            AIãŒç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ã€ŒğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã§ä¸€ç™ºä¸Šæ›¸ãã‚‚å¯èƒ½ã§ã™ã€‚
                        </div>
                    </li>
                    <li class="step-item">
                        <span class="step-num">3</span>
                        <div class="step-text">
                            <strong>å®Ÿè¡Œï¼†ç¢ºèª</strong><br>
                            ã€Œâ–¶ å®Ÿè¡Œã€ã‚¿ãƒ–ã§å‹•ä½œç¢ºèªã€‚ç”»é¢ãŒå°ã•ã„å ´åˆã¯ã€Œâ†— åˆ¥çª“ã§å®Ÿè¡Œã€ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã§ãã¾ã™ã€‚
                        </div>
                    </li>
                    <li class="step-item">
                        <span class="step-num">4</span>
                        <div class="step-text">
                            <strong>ä¿®æ­£ï¼†æ”¹å–„</strong><br>
                            ã€ŒğŸ› ï¸ ä¿®æ­£ã€æ©Ÿèƒ½ã‚„ã€ŒğŸ§ AIç›¸è«‡ã€ã‚’ä½¿ã£ã¦ã€ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ã‚’AIã«ä¾é ¼ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’è‚²ã¦ã¦ã„ãã¾ã™ã€‚
                        </div>
                    </li>
                </ul>
            </div>

            
            <div class="help-section">
                <h2>âœ¨ ãƒ‘ãƒ¯ãƒ•ãƒ«ãªAIæ”¯æ´æ©Ÿèƒ½</h2>
                <div class="help-grid">
                    <div class="help-card">
                        <span class="help-card-icon">ğŸ› ï¸</span>
                        <div class="help-card-title">ã‚ªãƒ¼ãƒˆä¿®æ­£ (JSON)</div>
                        <div class="help-card-desc" style="text-align: left;">
                            AIãŒå‡ºåŠ›ã—ãŸJSONå½¢å¼ã®ä¿®æ­£å·®åˆ†ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ã€ã‚³ãƒ¼ãƒ‰å†…ã®è©²å½“ç®‡æ‰€ã‚’è‡ªå‹•ã§ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç½®æ›ã—ã¾ã™ã€‚é•·ã„ã‚³ãƒ¼ãƒ‰ã®å…¨ç½®æ›ä¸è¦ï¼
                        </div>
                    </div>
                    <div class="help-card">
                        <span class="help-card-icon">ğŸ§</span>
                        <div class="help-card-title">AIç›¸è«‡ & æ¡ç‚¹</div>
                        <div class="help-card-desc" style="text-align: left;">
                            ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒã‚°ç‰¹å®šã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãªã©ã€AIã«å°‚é–€çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ±‚ã‚ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã€‚100ç‚¹æº€ç‚¹ã®æ¡ç‚¹æ©Ÿèƒ½ã‚‚ã€‚
                        </div>
                    </div>
                    <div class="help-card">
                        <span class="help-card-icon">ğŸ¤</span>
                        <div class="help-card-title">éŸ³å£°å…¥åŠ›</div>
                        <div class="help-card-desc" style="text-align: left;">
                            ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆæ™‚ã«ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’ä½¿ãˆã°ã€æ€ã„ã¤ã„ãŸã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è©±ã™ã ã‘ã§ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã€‚ç§»å‹•ä¸­ã®é–‹ç™ºã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«ã€‚
                        </div>
                    </div>
                    <div class="help-card">
                        <span class="help-card-icon">ğŸ“š</span>
                        <div class="help-card-title">å±¥æ­´ç®¡ç†</div>
                        <div class="help-card-desc" style="text-align: left;">
                            ä¿å­˜ã—ãŸã‚¢ãƒ—ãƒªã«ã¯ã€AIã¸ã®æŒ‡ç¤ºå±¥æ­´ã‚‚è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚å¾Œã‹ã‚‰ã€Œã©ã‚“ãªæŒ‡ç¤ºã§ä½œã£ãŸã‹ã€ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ç¢ºèªå¯èƒ½ã€‚
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="help-section">
                <h2>ğŸ’¾ ä¿å­˜ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
                <p style="font-size: 13px; line-height: 1.6; margin-bottom: 10px;">
                    ã€ŒğŸ’¾ ä¿å­˜ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã§ãã¾ã™ã€‚
                </p>
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; font-size: 13px;">
                    <ul style="padding-left: 20px; list-style-type: disc;">
                        <li style="margin-bottom: 6px;"><strong>ã‚¢ãƒ—ãƒªä¿å­˜</strong>: ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«DB(IndexedDB)ã«ä¿å­˜ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã„ã¤ã§ã‚‚å‘¼ã³å‡ºã›ã¾ã™ã€‚</li>
                        <li style="margin-bottom: 6px;"><strong>HTML DL</strong>: å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚Webã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ã™ã‚Œã°ãã®ã¾ã¾å…¬é–‹å¯èƒ½ã€‚</li>
                        <li><strong>GitHub Repo</strong>: GitHubã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã¸ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ›´æ–°ã€‚</li>
                    </ul>
                </div>
            </div>

            
            <div class="help-section">
                <h2>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨åˆ¶ç´„</h2>
                <p style="font-size: 12px; color: #ccc; line-height: 1.6;">
                    ãƒ»<strong>å¤–éƒ¨é€šä¿¡ç¦æ­¢</strong>: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰å†…ã§ã®å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ï¼ˆfetch/XHRç­‰ï¼‰ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                    ãƒ»<strong>ãƒ‡ãƒ¼ã‚¿ä¿å­˜</strong>: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã™ã‚‹ã¨æ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€é‡è¦ãªã‚³ãƒ¼ãƒ‰ã¯GitHubç­‰ã¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚<br>
                    ãƒ»<strong>JavaScript</strong>: å®Ÿè¡Œç”»é¢ã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ‚ªæ„ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã«ã¯ååˆ†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>

            <div style="height: 50px;"></div>
        </div>
    </section>

    <div id="notification">Message</div>

    <script>
                // --- State & Elements ---
        const textarea = document.getElementById('code-editor');
                const editor = CodeMirror.fromTextArea(textarea, {
            mode: "htmlmixed",
            theme: "monokai",
            lineNumbers: true,
            lineWrapping: false, // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ï¼ˆæŠ˜ã‚Šè¿”ã—OFFï¼‰
            tabSize: 2
        });
        editor.setSize("100%", "100%");

                const stats = document.getElementById('code-stats');
        const frame = document.getElementById('app-frame');
        const filenameInput = document.getElementById('filename-input');
        const appNameDisplay = document.getElementById('app-name-display');
        const libraryContainer = document.getElementById('library-container');
        const notification = document.getElementById('notification');

        let currentAppHistory = [];
        let pendingAiInstruction = "";
        let currentAppName = ""; // ç¾åœ¨ç·¨é›†ä¸­ã®ã‚¢ãƒ—ãƒªå(ä¿å­˜æ¸ˆã¿ã®å ´åˆ)

        // --- Editor Logic ---
                editor.on('change', updateStats);

        function undo() { editor.undo(); }
        function redo() { editor.redo(); }

        function updateStats() {
            const text = editor.getValue();
            const lines = editor.lineCount();
            const chars = text.length;
            stats.textContent = `${lines}è¡Œ / ${chars}æ–‡å­—`;
        }

                        async function pasteCode() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) return showToast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™");
                if(editor.getValue().trim().length > 0) {
                      if(!confirm("ã€è­¦å‘Šã€‘\nã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å†…å®¹ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
                }
                editor.setValue(text);
                showToast("å…¨ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
            } catch (err) {
                showToast("è²¼ã‚Šä»˜ã‘å¤±æ•—: æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            }
        }

                        function clearCode() {
            if(confirm("ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n(ç·¨é›†ä¸­ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™)")) {
                editor.setValue("");
                currentAppName = "";
                appNameDisplay.textContent = "(æ–°è¦ä½œæˆä¸­)";
                currentAppHistory = [];
            }
        }

        // --- New: Copy Function ---
                function copyFullCode() {
            const code = editor.getValue();
            if(!code) {
                showToast("ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            navigator.clipboard.writeText(code).then(() => {
                showToast("å…¨ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
            }).catch(err => {
                showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
            });
        }

                        // --- Help Logic ---
        // (ãƒ˜ãƒ«ãƒ—ã¯ã‚¿ãƒ–åŒ–ã•ã‚Œã¾ã—ãŸ)

        // --- New: AI & Fix Logic ---
        function openConsultModal() {
            document.getElementById('consult-modal').style.display = 'flex';
        }
        
        function copyConsultPrompt() {
            const categories = Array.from(document.querySelectorAll('input[name="consult-cat"]:checked')).map(cb => cb.value).join(', ');
            const details = document.getElementById('consult-text').value;
            const currentCode = editor.getValue();
            
            const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ç›¸è«‡ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åˆ†æãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚\n\n[ç›¸è«‡ã‚«ãƒ†ã‚´ãƒª]\n${categories || 'å…¨èˆ¬'}\n\n[è©³ç´°ãƒ»æ‚©ã¿]\n${details}\n\n[ä¾é ¼äº‹é …]\n1. ç¾çŠ¶ã®åˆ†æã¨å•é¡Œç‚¹ã®æŒ‡æ‘˜\n2. å…·ä½“çš„ãªæ”¹å–„æ¡ˆãƒ»è§£æ±ºç­–ã®æç¤º\n3. (ã‚‚ã—ã€Œæ¡ç‚¹ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆ) ã‚³ãƒ¼ãƒ‰å“è³ªã‚’100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—ã€æ¸›ç‚¹ç†ç”±ã¨æ”¹å–„ã§ä¼¸ã³ã‚‹ç‚¹æ•°ã‚’æç¤º\n4. **ãã®æ”¹å–„ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®ã€AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨˜è¿°ä¾‹** (ãƒ„ãƒ¼ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦å³åº§ã«ä¿®æ­£é©ç”¨å¯èƒ½ãªæŒ‡ç¤º)\n\n[å¯¾è±¡ã‚³ãƒ¼ãƒ‰]\n\`\`\`html\n${currentCode}\n\`\`\``;
            
            const textArea = document.createElement("textarea");
            textArea.value = prompt;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("ç›¸è«‡ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                closeModal('consult-modal');
            } catch (e) {
                alert("ã‚³ãƒ”ãƒ¼å¤±æ•—");
            }
            document.body.removeChild(textArea);
        }

        function openPromptModal() {
            document.getElementById('prompt-modal').style.display = 'flex';
        }
        function openFixModal() {
            document.getElementById('fix-modal').style.display = 'flex';
        }

        function switchFixTab(tab) {
            document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
           
            // Activate specific tab
            const btnIndex = tab === 'auto' ? 0 : 1;
            document.querySelectorAll('.modal-tab-btn')[btnIndex].classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

                                                function copyPrompt(type) {
            let prompt = "";
            const currentCode = editor.getValue();
            const instructionInput = document.getElementById('ai-instruction');
            const instruction = instructionInput.value;
            const instructionText = instruction ? `\nå…·ä½“çš„ãªæŒ‡ç¤º:\n${instruction}\n` : "";
            
            if (type === 'full') {
                // ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰
                prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ã€ä¿®æ­£ãƒ»æ”¹å–„ã—ãŸå®Œå…¨ãªãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\n1. å†’é ­ã«ã€ä¿®æ­£ç®‡æ‰€ãƒ»åˆ¶ç´„æ¡ä»¶ãƒ»æ”¹å–„ææ¡ˆã‚’ç°¡æ½”ãªã‚³ãƒ¡ãƒ³ãƒˆã§è¨˜è¿°ã€‚\n2. ãã®å¾Œã€ä¿®æ­£æ¸ˆã¿ã®å®Œå…¨ãªãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã€‚\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
            } else if (type === 'manual') {
                // æ‰‹å‹•ä¿®æ­£ (Before/Afterè¡¨ç¤º)
                prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\nä¿®æ­£å¯¾è±¡ã®ç®‡æ‰€ã«ã¤ã„ã¦ã€ä¿®æ­£å‰(Before)ã¨ä¿®æ­£å¾Œ(After)ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¯¾ã«ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\nä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ¤œç´¢ã—ã¦ç‰¹å®šã§ãã‚‹ã‚ˆã†ã«ã€çœç•¥ã›ãšæ­£ç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ä¾‹:\n### ä¿®æ­£ç®‡æ‰€1\n**ä¿®æ­£å‰(Before)**\n\`\`\`html\n<div class="old">...</div>\n\`\`\`\n**ä¿®æ­£å¾Œ(After)**\n\`\`\`html\n<div class="new">...</div>\n\`\`\`\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
            } else if (type === 'auto' || type === 'json') {
                // ã‚ªãƒ¼ãƒˆä¿®æ­£ (JSON)
                prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\n1. ã¾ãšã€ä¿®æ­£æ–¹é‡ãƒ»åˆ¶ç´„ãƒ»æ”¹å–„æ¡ˆã‚’ç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚\n2. æ¬¡ã«ã€ã‚³ãƒ¼ãƒ‰ç½®æ›ç”¨ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ **Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯(\`\`\`json ... \`\`\`)** ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nJSONå½¢å¼:\n[\n  {"before": "ä¿®æ­£å‰ã®ç½®æ›å¯¾è±¡ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†(ä¸€æ„ã«ç‰¹å®šã§ãã‚‹é•·ã•)", "after": "ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰"}\n]\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
            }

            const onCopy = () => {
                showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
                if (instruction) pendingAiInstruction = instruction; // å±¥æ­´ä¿å­˜ç”¨ã«ä¿æŒ
                instructionInput.value = "";
                closeModal('prompt-modal');
            };

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIã‚’è©¦è¡Œã—ã€å¤±æ•—æ™‚ã¯execCommandã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            navigator.clipboard.writeText(prompt).then(onCopy).catch(err => {
                const textArea = document.createElement("textarea");
                textArea.value = prompt;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    onCopy();
                } catch (e) {
                    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
                document.body.removeChild(textArea);
            });
        }

        async function pasteToJsonInput() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('json-input').value = text;
                showToast("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
            } catch (err) {
                showToast("è²¼ã‚Šä»˜ã‘å¤±æ•—: æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            }
        }

        function clearJsonInput() {
            document.getElementById('json-input').value = "";
        }

                                        function applyAutoFix() {
            let jsonStr = document.getElementById('json-input').value;
            if (!jsonStr.trim()) return showToast("JSONãŒç©ºã§ã™");

            const firstOpen = jsonStr.indexOf('[');
            const lastClose = jsonStr.lastIndexOf(']');
            
            if (firstOpen !== -1 && lastClose !== -1 && lastClose > firstOpen) {
                jsonStr = jsonStr.substring(firstOpen, lastClose + 1);
            } else {
                jsonStr = jsonStr.replace(/^```[a-z]*\s*/i, '').replace(/\s*```$/i, '');
            }

            try {
                const fixes = JSON.parse(jsonStr);
                let code = editor.getValue();
                code = code.replace(/\r\n/g, '\n'); // æ”¹è¡Œæ­£è¦åŒ–
                
                let count = 0;

                if (!Array.isArray(fixes)) throw new Error("é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");

                // Helper: Entity conversion
                const decodeEnt = (s) => s.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&#039;/g, "'");
                const encodeEnt = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

                for (const fix of fixes) {
                    if (!fix.before || !fix.after) continue;

                    let target = fix.before.replace(/\r\n/g, '\n');
                    let replacement = fix.after.replace(/\r\n/g, '\n');
                    
                    // å€™è£œç”Ÿæˆ (åŒå€¤è¡¨ç¾ã®å±•é–‹)
                    const variants = new Set([
                        target,
                        decodeEnt(target),
                        encodeEnt(target),
                        decodeEnt(decodeEnt(target))
                    ]);

                    let bestMatch = null;
                    let totalFound = 0;

                    // 1. å®Œå…¨ä¸€è‡´ã‚¹ã‚­ãƒ£ãƒ³
                    for (const cand of variants) {
                        if (code.includes(cand)) {
                            const occurrences = code.split(cand).length - 1;
                            totalFound += occurrences;
                            if (occurrences > 0) bestMatch = cand;
                        }
                    }

                    // 2. ãƒ’ãƒƒãƒˆãªã—ãªã‚‰Trimä¸€è‡´ã‚¹ã‚­ãƒ£ãƒ³
                    if (totalFound === 0) {
                         const variantsTrim = new Set();
                         for (const v of variants) variantsTrim.add(v.trim());
                         
                         for (const cand of variantsTrim) {
                            if (code.includes(cand)) {
                                const occurrences = code.split(cand).length - 1;
                                totalFound += occurrences;
                                if (occurrences > 0) bestMatch = cand;
                            }
                         }
                    }

                                        if (totalFound === 0) {
                        // å¤±æ•—æƒ…å ±ã‚’ã‚»ãƒƒãƒˆã—ã¦æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã¸èª˜å°
                        const failJson = JSON.stringify([fix], null, 2);
                        document.getElementById('manual-find').value = target;
                        document.getElementById('manual-replace').value = replacement;
                        
                        prompt("ä¿®æ­£å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nä»¥ä¸‹ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦AIã«å†æŒ‡ç¤ºã™ã‚‹ã‹ã€\nè‡ªå‹•å…¥åŠ›ã•ã‚ŒãŸã€Œâ‘¡ æ‰‹å‹•ä¿®æ­£ã€ã‚¿ãƒ–ã§å¾®èª¿æ•´ã—ã¦ãã ã•ã„ã€‚", failJson);
                        
                        switchFixTab('manual');
                        return;
                    }
                    if (totalFound > 1) {
                        alert("ä¿®æ­£ä¸­æ–­: å¯¾è±¡ã‚³ãƒ¼ãƒ‰ãŒè¤‡æ•°ç®‡æ‰€(ã¾ãŸã¯è¤‡æ•°ã®è¡¨ç¾ã§)è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\nèª¤ç½®æ›ã‚’é˜²ããŸã‚ã€å¯¾è±¡ã‚³ãƒ¼ãƒ‰(before)ã‚’ã‚ˆã‚Šé•·ããƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ã¦ãã ã•ã„ã€‚");
                        return;
                    }

                    // replaceãƒ†ã‚­ã‚¹ãƒˆã®å½¢å¼åˆã‚ã›
                    if (bestMatch) {
                        if (bestMatch === decodeEnt(target)) replacement = decodeEnt(replacement);
                        else if (bestMatch === encodeEnt(target)) replacement = encodeEnt(replacement);
                        else if (bestMatch === decodeEnt(decodeEnt(target))) replacement = decodeEnt(decodeEnt(replacement));
                        
                        code = code.replace(bestMatch, replacement);
                        count++;
                    }
                }

                editor.setValue(code);
                showToast(`${count}ç®‡æ‰€ã®ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸ\n(å½¢å¼ã‚†ã‚‰ãè‡ªå‹•è£œæ­£)`);
                document.getElementById('json-input').value = "";
                closeModal('fix-modal');

            } catch (e) {
                console.error(e);
                alert("JSONã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

                function applyManualFix() {
            const findText = document.getElementById('manual-find').value;
            const replaceText = document.getElementById('manual-replace').value;

            if (!findText) return showToast("æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            let code = editor.getValue();
            if (code.includes(findText)) {
                const newCode = code.split(findText).join(replaceText);
                editor.setValue(newCode);
                showToast("ç½®æ›ã—ã¾ã—ãŸ");
                closeModal('fix-modal');
            } else {
                showToast("å¯¾è±¡æ–‡å­—åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            }
        }
       
        

                                // --- Run Logic ---
        function runCode() {
            let code = editor.getValue();
            if(!code.trim()) {
                showToast("ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™");
                return;
            }

            // Inject Debug Script
            const debugScript = `
            <script>
                (function(){
                    const send = (type, args) => {
                        try {
                            window.parent.postMessage({
                                type: 'console',
                                level: type,
                                args: Array.from(args).map(a => String(a))
                            }, '*');
                        } catch(e) {}
                    };
                    const originalLog = console.log;
                    const originalError = console.error;
                    console.log = function(...args) { originalLog.apply(console, args); send('log', args); };
                    console.error = function(...args) { originalError.apply(console, args); send('error', args); };
                    window.onerror = function(msg, url, line) { send('error', [msg + " (Line: " + line + ")"]); };
                })();
            <\/script>`;

            if (code.includes('<head>')) {
                code = code.replace('<head>', '<head>' + debugScript);
            } else {
                code = debugScript + code;
            }

            switchTab('run');
            // Override frame content with debug code after view switch
            setTimeout(() => {
                frame.srcdoc = code;
            }, 50);
        }

                function reloadFrame() {
            const code = editor.getValue();
            frame.srcdoc = code;
        }

                function runInNewWindow() {
            const code = editor.getValue();
            const win = window.open("", "_blank");
            if(win) {
                win.document.open();
                win.document.write(code);
                win.document.close();
            } else {
                showToast("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            }
        }

                        // --- Navigation Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const index = ['editor', 'run', 'library', 'help'].indexOf(tabName);
            if (document.querySelectorAll('.tab-btn')[index]) {
                document.querySelectorAll('.tab-btn')[index].classList.add('active');
            }

            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');

            if(tabName === 'library') {
                renderLibrary();
            }
            if(tabName === 'run') {
                const code = editor.getValue();
                frame.srcdoc = code;
            }
        }

                // --- Save / Load Logic ---
        function openSaveModal() {
            document.getElementById('save-modal').style.display = 'flex';
            // æ—¢å­˜ã®åå‰ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°æ—¥æ™‚ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’ã‚»ãƒƒãƒˆ
            if (currentAppName) {
                filenameInput.value = currentAppName;
            } else {
                const now = new Date();
                filenameInput.value = `App_${now.getHours()}${now.getMinutes()}`;
            }
        }

                function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- IndexedDB Wrapper ---
        const DB_NAME = 'AppStudioDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'apps';

        const idb = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                    };
                    req.onsuccess = (e) => resolve(e.target.result);
                    req.onerror = (e) => reject(e);
                });
            },
            getAll: async () => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result.reverse());
                    req.onerror = () => reject(req.error);
                });
            },
            get: async (id) => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const req = tx.objectStore(STORE_NAME).get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            put: async (item) => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).put(item);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            delete: async (id) => {
                const db = await idb.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }
        };

        async function saveToLibrary() {
            const name = filenameInput.value || "Untitled";
            const code = editor.getValue();
            
            if(!code.trim()) {
                showToast("ä¿å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“");
                closeModal('save-modal');
                return;
            }

            // å±¥æ­´ã®è¿½åŠ 
            if (pendingAiInstruction) {
                const ts = new Date().toLocaleString();
                currentAppHistory.unshift(`[${ts}] ${pendingAiInstruction}`);
                pendingAiInstruction = ""; // æ¶ˆè²»
            }

            const appData = {
                id: Date.now(),
                name: name,
                code: code,
                date: new Date().toLocaleString(),
                history: currentAppHistory
            };

                        try {
                await idb.put(appData);
                showToast(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                // ä¿å­˜æˆåŠŸã—ãŸã‚‰çŠ¶æ…‹ã‚’æ›´æ–°
                currentAppName = name;
                appNameDisplay.textContent = name;
            } catch (e) {
                showToast("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
            closeModal('save-modal');
        }

                function downloadHTML() {
            const name = filenameInput.value || "index";
            const code = editor.getValue();
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeModal('save-modal');
        }

                        async function uploadToGitHub() {
            const code = editor.getValue();
            if(!code.trim()) return showToast("ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™");

            // Load Config
            const savedToken = localStorage.getItem('gh_token') || "";
            const savedRepo = localStorage.getItem('gh_repo') || "";

            // 1. Token Input
            const token = prompt("GitHub Personal Access Token (repoæ¨©é™) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", savedToken);
            if(!token) return;

            // 2. Repo Input
            const repo = prompt("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: user/repo):\nâ€»ãƒªãƒã‚¸ãƒˆãƒªã¯äº‹å‰ã«ä½œæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™", savedRepo);
            if(!repo || !repo.includes('/')) {
                alert("ãƒªãƒã‚¸ãƒˆãƒªåã¯ 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå' ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // Save Config
            localStorage.setItem('gh_token', token);
            localStorage.setItem('gh_repo', repo);

            const name = filenameInput.value || "index";
            const path = name.endsWith('.html') ? name : name + '.html';
            
            showToast("GitHubã¸æ¥ç¶šä¸­...");

            try {
                const headers = {
                    "Authorization": `token ${token}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json"
                };

                // 3. Check existing file to get SHA (for update)
                const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
                let sha = null;

                const checkResp = await fetch(apiUrl, { headers });
                if (checkResp.ok) {
                    const fileData = await checkResp.json();
                    sha = fileData.sha;
                } else if (checkResp.status !== 404) {
                    throw new Error(`ç¢ºèªã‚¨ãƒ©ãƒ¼: ${checkResp.status} ${checkResp.statusText}`);
                }

                // 4. Create or Update file (PUT)
                // æ—¥æœ¬èªå¯¾å¿œã®ãŸã‚UTF-8ã‚’Base64ã«å¤‰æ›
                const contentBase64 = window.btoa(unescape(encodeURIComponent(code)));

                const body = {
                    message: `Update ${path} via AppStudioMobile`,
                    content: contentBase64,
                    ...(sha && { sha }) // shaãŒã‚ã‚Œã°å«ã‚ã‚‹ï¼ˆæ›´æ–°ç”¨ï¼‰
                };

                const putResp = await fetch(apiUrl, {
                    method: "PUT",
                    headers,
                    body: JSON.stringify(body)
                });

                if (!putResp.ok) {
                    const err = await putResp.json();
                    throw new Error(err.message || putResp.statusText);
                }

                const data = await putResp.json();
closeModal('save-modal');
const ghUrl = data.content.html_url;

if(confirm("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\nGitHubã®URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’é–‹ãã¾ã™)")) {
    navigator.clipboard.writeText(ghUrl).then(() => showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(() => prompt("URL:", ghUrl));
} else {
    window.open(ghUrl, "_blank");
}

            } catch(e) {
                console.error(e);
                alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + e.message + "\nãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¨©é™(repo)ã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ãƒªãƒã‚¸ãƒˆãƒªåãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„");
            }
        }

        async function renderLibrary() {
            libraryContainer.innerHTML = '';
            let library = [];
            try {
                library = await idb.getAll();
            } catch(e) {
                console.error(e);
            }

            if(library.length === 0) {
                libraryContainer.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px;">ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            library.forEach(app => {
                const el = document.createElement('div');
                el.className = 'lib-item';
                el.innerHTML = `
                    <div class="lib-header">
                        <div class="lib-title">${escapeHtml(app.name)}</div>
                        <div class="lib-actions">
                            <button class="btn-load" onclick="loadApp(${app.id})">èª­è¾¼</button>
                            <button class="btn-action" onclick="shareApp(${app.id})">âœ‰ï¸</button>
                            <button class="btn-del" onclick="deleteApp(${app.id})">Ã—</button>
                        </div>
                    </div>
                    <div class="lib-meta">
                        ${app.date} | ${app.code.length} chars
                    </div>
                    ${ app.history && app.history.length > 0 
                        ? `<div class="lib-history" onclick="showHistoryModal(${app.id})">ğŸ’¡ ${escapeHtml(app.history[0])}</div>` 
                        : '' }
                `;
                libraryContainer.appendChild(el);
            });
        }

                        async function loadApp(id) {
            const app = await idb.get(id);
            if(app) {
                if(editor.getValue().length > 0 && !confirm("ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¯å¤±ã‚ã‚Œã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
                editor.setValue(app.code);
                // ãƒ¡ã‚¿æƒ…å ±å¾©å…ƒ
                currentAppName = app.name;
                appNameDisplay.textContent = app.name;
                filenameInput.value = app.name;
                currentAppHistory = app.history || []; 
                pendingAiInstruction = "";
                
                switchTab('editor');
                setTimeout(() => editor.refresh(), 10);
                showToast(`ã€Œ${app.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            }
        }

        async function showHistoryModal(id) {
            const app = await idb.get(id);
            if(app && app.history) {
                const content = app.history.join('\n\n');
                document.getElementById('history-content').textContent = content;
                document.getElementById('history-modal').style.display = 'flex';
            }
        }

        async function deleteApp(id) {
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await idb.delete(id);
            renderLibrary();
        }

        async function shareApp(id) {
            const app = await idb.get(id);
            if(!app) return;

            try {
                const blob = new Blob([app.code], { type: 'text/html' });
                const fileName = app.name.endsWith('.html') ? app.name : app.name + '.html';
                const file = new File([blob], fileName, { type: 'text/html' });

                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: app.name,
                        text: 'AppStudioMobileã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã§ã™ã€‚'
                    });
                } else {
                    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰(ãƒ¡ãƒ¼ãƒ«æ·»ä»˜ç­‰)ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                }
            } catch (err) {
                if (err.name !== 'AbortError') showToast("é€ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼: " + err.message);
            }
        }

                // --- Speech Recognition ---
        let recognition = null;
        let isRecording = false;

        function toggleSpeechRecognition() {
            const btn = document.getElementById('mic-btn');
            const textarea = document.getElementById('ai-instruction');

            if (isRecording) {
                if (recognition) recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecording = true;
                btn.style.color = '#ff4444';
                btn.style.borderColor = '#ff4444';
                btn.style.animation = 'pulse-mic 1.5s infinite';
                showToast("éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã—ãŸ...");
            };

            recognition.onend = () => {
                isRecording = false;
                btn.style.color = '#ccc';
                btn.style.borderColor = '#555';
                btn.style.animation = 'none';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (transcript) {
                    const current = textarea.value;
                    textarea.value = current + (current ? "\n" : "") + transcript;
                    showToast("éŸ³å£°ã‚’è¿½è¨˜ã—ã¾ã—ãŸ");
                }
            };

            recognition.onerror = (event) => {
                console.error(event.error);
                showToast("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error);
                isRecording = false;
                btn.style.color = '#ccc';
                btn.style.borderColor = '#555';
                btn.style.animation = 'none';
            };

            recognition.start();
        }

        // Add mic animation style
        const style = document.createElement('style');
        style.innerHTML = `@keyframes pulse-mic { 0% { background: rgba(255, 0, 0, 0.1); } 50% { background: rgba(255, 0, 0, 0.4); } 100% { background: rgba(255, 0, 0, 0.1); } }`;
        document.head.appendChild(style);

        // --- Utilities ---
        function showToast(msg) {
            notification.textContent = msg;
            notification.style.opacity = '1';
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 2000);
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

                // Listen for console messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'console') {
                const msg = `[${event.data.level.toUpperCase()}] ${event.data.args.join(' ')}`;
                showToast(msg);
            }
        });

        // Initialize
        updateStats();
    </script>
























<script id="lfs-meta" type="application/json">
{
  "appId": "f5791908991642ab755dd87876ba27f0",
  "createdAt": "2026-01-05T22:09:30.050Z",
  "schema": 2,
  "title": "AppStudioMobile v2",
  "savedAt": "2026-01-14T13:19:46.360Z",
  "aiInstruction": "ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã‚’ã€AppStudioã¨åŒç­‰ä»¥ä¸Šã«å¤§å¹…ã«æ‹¡å……ã™ã‚‹ã€‚",
  "comment": "ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã‚’ã€AppStudioã¨åŒç­‰ä»¥ä¸Šã«å¤§å¹…ã«æ‹¡å……ã™ã‚‹ã€‚",
  "sourceMode": "project",
  "runId": "c42746db758465933d2c97ea98b1ba69"
}
</script>
</body>
</html>