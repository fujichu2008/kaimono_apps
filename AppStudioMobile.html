<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AppStudio Mobile</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            forge: { 800: '#1e1e2e', 900: '#181825', 700: '#313244', accent: '#89b4fa', surface: '#45475a' }
          },
          fontFamily: {
            mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
          }
        }
      }
    }
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    body { background-color: #181825; color: #cdd6f4; -webkit-tap-highlight-color: transparent; }
    /* スクロールバー非表示（スマホライク） */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #45475a; border-radius: 2px; }

    :root{
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    /* iOS旧仕様 fallback */
    @supports (padding-top: constant(safe-area-inset-top)) {
      :root{
        --safe-top: constant(safe-area-inset-top);
        --safe-bottom: constant(safe-area-inset-bottom);
      }
    }

    .safe-area-pb { padding-bottom: var(--safe-bottom); }
    .pt-safe { padding-top: calc(var(--safe-top) + 8px); }
    .glass-panel { background: rgba(30, 30, 46, 0.95); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.08); }
    
    /* エディタ用 */
    .editor-textarea {
      font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
      line-height: 1.5;
      tab-size: 2;
    }
    
    /* タップ時のアニメーション */
    .tap-effect:active { transform: scale(0.96); opacity: 0.8; }
    
    /* モーダルアニメーション */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-sm">
<div id="app" class="h-full flex flex-col relative">

  <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] w-[90%] pointer-events-none transition-all duration-300"
       :class="toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-4'">
    <div class="bg-gray-800/95 text-white px-4 py-3 rounded-xl shadow-2xl border border-gray-600 flex items-center gap-3 backdrop-blur-md">
      <i class="fas" :class="toast.icon"></i>
      <div class="flex-1">
        <div class="font-bold text-xs">{{ toast.title }}</div>
        <div class="text-[10px] text-gray-400" v-if="toast.message">{{ toast.message }}</div>
      </div>
    </div>
  </div>

  <header v-if="activeTab !== 'run'" class="bg-forge-800 border-b border-forge-700 flex items-center justify-between px-4 pt-safe pb-3 shrink-0 z-30 sticky top-0">
    <div class="font-bold text-gray-100 text-lg flex items-center gap-1 tracking-tight">
      <i class="fas fa-layer-group text-forge-accent mr-1"></i>
      AppStudio
      <span class="text-[9px] bg-forge-700 text-forge-accent px-1.5 py-0.5 rounded font-bold border border-forge-700 ml-1">MOBILE</span>
    </div>

    <div class="flex gap-3">
      <button @click="showHelp" class="text-gray-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full bg-forge-700/50 tap-effect">
        <i class="fas fa-question"></i>
      </button>
    </div>
  </header>

  <main class="flex-1 relative overflow-hidden bg-forge-900">
    
    <div v-if="activeTab === 'library'" class="h-full overflow-y-auto p-4 pb-24">
      <div class="flex justify-between items-end mb-4">
        <h2 class="text-xl font-bold text-white">My Apps</h2>
        <div class="text-xs text-gray-500">{{ apps.length }} projects</div>
      </div>

      <button @click="createNewApp" 
              class="w-full py-4 mb-6 rounded-xl border-2 border-dashed border-gray-600 text-gray-400 font-bold flex flex-col items-center justify-center gap-2 hover:bg-forge-800 hover:border-forge-accent hover:text-white transition tap-effect">
        <i class="fas fa-plus-circle text-2xl"></i>
        <span>新規アプリ作成</span>
      </button>

      <div class="space-y-3">
        <div v-for="app in sortedApps" :key="app.id" 
             @click="openApp(app)"
             class="bg-forge-800 p-4 rounded-xl border border-forge-700 shadow-lg active:bg-forge-700 transition relative group tap-effect">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-blue-300 text-base truncate pr-8">{{ app.title }}</h3>
            <button @click.stop="deleteApp(app.id)" class="text-gray-600 hover:text-red-400 p-2 -mr-2 -mt-2 z-10">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
          <div class="text-[10px] text-gray-500 font-mono mb-2">ID: {{ app.id.slice(0,8) }}</div>
          <div class="text-xs text-gray-400 line-clamp-2 min-h-[2.5em]">
            {{ app.comment || 'No description' }}
          </div>
          <div class="mt-3 flex justify-between items-center border-t border-forge-700 pt-2">
            <span class="text-[10px] text-gray-500">{{ formatDate(app.updatedAt) }}</span>
            <span class="text-[10px] bg-forge-700 px-2 py-0.5 rounded text-gray-300">HTML</span>
          </div>
        </div>
      </div>
      
      <div v-if="apps.length === 0" class="text-center text-gray-600 mt-10 text-xs">
        アプリがありません。<br>「新規アプリ作成」から始めましょう。
      </div>
    </div>

    <div v-show="activeTab === 'editor'" class="h-full flex flex-col bg-gray-900">
      <div class="bg-forge-800 p-2 border-b border-forge-700 shrink-0 flex flex-col gap-2">
        <div class="flex items-center gap-2">
           <input v-model="currentApp.title" placeholder="アプリ名" 
                  class="flex-1 bg-transparent text-white font-bold text-sm focus:outline-none placeholder-gray-600 truncate" />
           <button @click="modals.saveSelect = true" class="bg-blue-600 text-white text-[10px] px-3 py-1.5 rounded font-bold flex items-center gap-1 tap-effect shadow-lg shadow-blue-900/30 whitespace-nowrap">
             <i class="fas fa-save"></i> 保存
           </button>
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar items-center">
           <button @click="openAiModal" class="bg-purple-900/80 text-purple-100 border border-purple-700 text-[10px] px-3 py-1.5 rounded flex items-center gap-1 tap-effect shadow whitespace-nowrap">
             <i class="fas fa-robot"></i> 1. AI指示
           </button>
           
           <i class="fas fa-chevron-right text-[10px] text-gray-600"></i>

           <button @click="pasteCode" class="bg-gray-700 text-white text-[10px] px-3 py-1.5 rounded flex items-center gap-1 tap-effect shadow whitespace-nowrap">
             <i class="fas fa-paste"></i> 2. 全貼付
           </button>

           <button @click="modals.patchSelect = true" class="bg-teal-800 text-teal-100 border border-teal-600 text-[10px] px-3 py-1.5 rounded flex items-center gap-1 tap-effect shadow whitespace-nowrap">
             <i class="fas fa-wrench"></i> 2. 部分修正
           </button>

           <div class="w-px bg-gray-600 mx-1 h-4"></div>

           <button @click="clearCode" class="bg-gray-800 text-red-400 border border-gray-700 text-[10px] px-3 py-1.5 rounded flex items-center gap-1 tap-effect shadow whitespace-nowrap">
             <i class="fas fa-eraser"></i> クリア
           </button>
        </div>
      </div>

      <div class="flex-1 relative w-full h-full">
        <textarea id="code-editor" v-model="currentApp.code"
                  class="w-full h-full bg-[#1e1e2e] text-gray-300 p-3 editor-textarea text-xs resize-none outline-none focus:bg-[#181825] transition-colors"
                  spellcheck="false"
                  placeholder="ここにHTMLコードを貼り付けてください..."></textarea>
        
        <button @click="copyCode" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-forge-700/80 text-white flex items-center justify-center shadow-lg border border-gray-600 tap-effect backdrop-blur z-10" title="全コピー">
           <i class="fas fa-copy"></i>
        </button>
      </div>
    </div>

    <div v-show="activeTab === 'run'" class="h-full flex flex-col bg-white">
      <div class="h-9 bg-gray-100 border-b border-gray-300 flex items-center justify-between px-3 shrink-0">
        <span class="text-xs text-gray-500 font-bold flex items-center gap-1">
          <i class="fas fa-mobile-screen"></i> Preview
        </span>
        <div class="flex items-center gap-3">
           <button @click="openInNewWindow" class="text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 px-2 py-0.5 rounded border border-blue-200">
             <i class="fas fa-external-link-alt"></i> <span class="hidden sm:inline">別窓で開く</span>
           </button>
           <button @click="reloadPreview" class="text-gray-500 w-8 h-8 flex items-center justify-center">
             <i class="fas fa-rotate-right"></i>
           </button>
        </div>
      </div>
      
      <div class="flex-1 relative w-full h-full">
        <iframe id="preview-frame" class="w-full h-full border-none bg-white"></iframe>
      </div>

      <div class="h-24 bg-forge-900 border-t border-forge-700 shrink-0 flex flex-col" :class="{'hidden': !consoleVisible}">
        <div class="flex justify-between items-center px-2 py-1 bg-forge-800">
          <span class="text-[10px] text-gray-400 font-mono">Console Log</span>
          <button @click="logs=[]" class="text-[10px] text-gray-500"><i class="fas fa-ban"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-2 font-mono text-[10px] space-y-1">
          <div v-for="(log, i) in logs" :key="i" :class="log.color">
            <span class="opacity-50 mr-1">{{ log.time }}</span> {{ log.msg }}
          </div>
          <div v-if="logs.length===0" class="text-gray-600 italic">No logs...</div>
        </div>
      </div>
    </div>

  </main>

  <nav class="glass-panel h-16 pb-safe flex justify-around items-center shrink-0 z-30 safe-area-pb">
    <button @click="switchTab('library')" 
            class="flex flex-col items-center justify-center w-full h-full gap-1 transition-colors"
            :class="activeTab === 'library' ? 'text-forge-accent' : 'text-gray-500'">
      <i class="fas fa-folder-open text-lg"></i>
      <span class="text-[10px] font-bold">ライブラリ</span>
    </button>
    
    <button @click="switchTab('editor')" 
            class="flex flex-col items-center justify-center w-full h-full gap-1 transition-colors"
            :class="activeTab === 'editor' ? 'text-yellow-400' : 'text-gray-500'">
      <i class="fas fa-code text-lg"></i>
      <span class="text-[10px] font-bold">エディタ</span>
    </button>
    
    <button @click="switchTab('run')" 
            class="flex flex-col items-center justify-center w-full h-full gap-1 transition-colors"
            :class="activeTab === 'run' ? 'text-green-400' : 'text-gray-500'">
      <i class="fas fa-play text-lg"></i>
      <span class="text-[10px] font-bold">実行</span>
    </button>
  </nav>

  <transition name="fade">
  <div v-if="modals.ai" class="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm" @click.self="modals.ai=false">
    <div class="bg-forge-900 w-full sm:w-[480px] rounded-t-2xl sm:rounded-2xl border border-gray-700 shadow-2xl p-5 pb-8 sm:pb-5 transform transition-transform flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-white font-bold text-sm"><i class="fas fa-robot text-purple-400 mr-2"></i>AIプロンプト作成</h3>
        <button @click="modals.ai=false" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>

      <div class="bg-gray-800 p-1 rounded-lg flex mb-3 shrink-0">
        <button @click="aiMode='full'" class="flex-1 py-1.5 text-xs font-bold rounded transition" :class="aiMode==='full' ? 'bg-purple-600 text-white shadow' : 'text-gray-400'">
          ① フル作成
        </button>
        <button @click="aiMode='patch'" class="flex-1 py-1.5 text-xs font-bold rounded transition" :class="aiMode==='patch' ? 'bg-green-600 text-white shadow' : 'text-gray-400'">
          ② 部分修正(JSON)
        </button>
      </div>
      
      <p class="text-xs text-gray-400 mb-2" v-if="aiMode==='full'">
        新規作成または、コード全体を書き直させる場合に使います。
      </p>
      <p class="text-xs text-gray-400 mb-2" v-else>
        部分的な変更です。AIにJSON形式で差分を出力させ、ワンタップで適用します。
      </p>

      <textarea v-model="aiInstruction" class="w-full h-24 bg-gray-800 rounded p-3 text-sm text-white mb-4 border border-gray-600 focus:border-purple-500 outline-none resize-none" placeholder="指示を入力 (例: ボタンを赤くして)"></textarea>
      
      <button @click="copyPrompt" class="w-full py-3 rounded text-white text-xs font-bold shadow-lg tap-effect flex items-center justify-center gap-2"
              :class="aiMode==='full' ? 'bg-purple-600' : 'bg-green-600'">
        <i class="fas fa-copy"></i>
        <span>プロンプトをコピー ({{ aiMode==='full'?'Full':'JSON' }})</span>
      </button>
    </div>
  </div>
  </transition>

  <transition name="fade">
  <div v-if="modals.jsonPatch" class="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm" @click.self="modals.jsonPatch=false">
    <div class="bg-forge-900 w-full sm:w-[480px] rounded-t-2xl sm:rounded-2xl border border-gray-700 shadow-2xl p-5 pb-8 sm:pb-5 transform transition-transform flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-white font-bold text-sm"><i class="fas fa-file-import text-green-400 mr-2"></i>JSONパッチ適用</h3>
        <button @click="modals.jsonPatch=false" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      <p class="text-xs text-gray-400 mb-3">
        AIが出力したJSONをそのまま貼り付けてください。<br>
        (マークダウン ```json 等が含まれていてもOK)
      </p>
      <textarea v-model="jsonInput" class="w-full h-32 bg-gray-800 rounded p-3 text-[10px] font-mono text-gray-300 mb-4 border border-gray-600 focus:border-green-500 outline-none resize-none" placeholder='{ "patches": [ { "find": "...", "replace": "..." } ] }'></textarea>
      
      <button @click="applyJsonPatch" class="w-full py-3 rounded bg-green-700 text-white text-xs font-bold shadow-lg tap-effect">
        適用する
      </button>
    </div>
  </div>
  </transition>

  <transition name="fade">
  <div v-if="modals.manualPatch" class="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm" @click.self="modals.manualPatch=false">
    <div class="bg-forge-900 w-full sm:w-[480px] rounded-t-2xl sm:rounded-2xl border border-gray-700 shadow-2xl p-5 pb-8 sm:pb-5 transform transition-transform flex flex-col max-h-[90vh]">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-white font-bold text-sm"><i class="fas fa-search text-gray-400 mr-2"></i>手動 置換</h3>
        <button @click="modals.manualPatch=false" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="space-y-3">
        <div>
           <label class="text-[10px] text-gray-400">検索 (Before)</label>
           <textarea v-model="manualFind" class="w-full h-16 bg-gray-800 rounded p-2 text-[10px] font-mono text-gray-300 border border-gray-600 focus:border-blue-500 outline-none resize-none"></textarea>
        </div>
        <div class="flex justify-center text-gray-500"><i class="fas fa-arrow-down"></i></div>
        <div>
           <label class="text-[10px] text-gray-400">置換 (After)</label>
           <textarea v-model="manualReplace" class="w-full h-16 bg-gray-800 rounded p-2 text-[10px] font-mono text-gray-300 border border-gray-600 focus:border-blue-500 outline-none resize-none"></textarea>
        </div>
      </div>
      
      <button @click="applyManualPatch" class="w-full py-3 mt-4 rounded bg-blue-700 text-white text-xs font-bold shadow-lg tap-effect">
        置換実行
      </button>
    </div>
  </div>
  </transition>

  <transition name="fade">
  <div v-if="modals.patchSelect" class="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm" @click.self="modals.patchSelect=false">
    <div class="bg-forge-900 w-full sm:w-[320px] rounded-t-2xl sm:rounded-2xl border border-gray-700 shadow-2xl p-6 transform transition-transform">
      <h3 class="text-white font-bold text-center mb-6">修正方法を選択</h3>
      
      <div class="space-y-3">
        <button @click="modals.jsonPatch=true; modals.patchSelect=false" 
                class="w-full py-4 rounded-xl bg-green-700 text-white font-bold shadow-lg flex items-center justify-center gap-3 tap-effect border border-green-500">
          <i class="fas fa-magic text-lg"></i>
          <div class="text-left">
            <div class="text-xs">オート修正 (JSON)</div>
            <div class="text-[10px] opacity-80 font-normal">AIのJSONを適用</div>
          </div>
        </button>
        
        <button @click="modals.manualPatch=true; modals.patchSelect=false" 
                class="w-full py-4 rounded-xl bg-gray-700 text-white font-bold shadow-lg flex items-center justify-center gap-3 tap-effect border border-gray-600">
          <i class="fas fa-pen-to-square text-lg"></i>
          <div class="text-left">
            <div class="text-xs">手動修正</div>
            <div class="text-[10px] opacity-80 font-normal">検索して置換</div>
          </div>
        </button>
      </div>

      <button @click="modals.patchSelect=false" class="mt-6 w-full py-2 text-gray-500 text-xs">キャンセル</button>
    </div>
  </div>
  </transition>

  <transition name="fade">
  <div v-if="modals.saveSelect" class="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm" @click.self="modals.saveSelect=false">
    <div class="bg-forge-900 w-full sm:w-[320px] rounded-t-2xl sm:rounded-2xl border border-gray-700 shadow-2xl p-6 transform transition-transform">
      <h3 class="text-white font-bold text-center mb-6">保存先を選択</h3>
      
      <div class="space-y-3">
        <button @click="saveToDb" 
                class="w-full py-4 rounded-xl bg-blue-700 text-white font-bold shadow-lg flex items-center justify-center gap-3 tap-effect border border-blue-500">
          <i class="fas fa-database text-lg"></i>
          <div class="text-left">
            <div class="text-xs">アプリ内に保存</div>
            <div class="text-[10px] opacity-80 font-normal">ライブラリに追加</div>
          </div>
        </button>
        
        <button @click="downloadHtml" 
                class="w-full py-4 rounded-xl bg-gray-700 text-white font-bold shadow-lg flex items-center justify-center gap-3 tap-effect border border-gray-600">
          <i class="fas fa-file-arrow-down text-lg"></i>
          <div class="text-left">
            <div class="text-xs">HTMLファイルとして保存</div>
            <div class="text-[10px] opacity-80 font-normal">端末にダウンロード</div>
          </div>
        </button>
      </div>

      <button @click="modals.saveSelect=false" class="mt-6 w-full py-2 text-gray-500 text-xs">キャンセル</button>
    </div>
  </div>
  </transition>

  <div v-if="modals.help" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm p-4" @click.self="modals.help=false">
    <div class="bg-forge-900 w-full max-w-sm rounded-2xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
      <div class="p-4 border-b border-gray-700 bg-forge-800 flex justify-between items-center">
        <h3 class="font-bold text-white"><i class="fas fa-book-open text-green-400 mr-2"></i>使い方ガイド</h3>
        <button @click="modals.help=false"><i class="fas fa-times text-gray-400"></i></button>
      </div>
      <div class="p-5 overflow-y-auto text-sm text-gray-300 space-y-4">
        <div class="space-y-2">
          <h4 class="font-bold text-white border-l-2 border-purple-500 pl-2">1. フル作成モード</h4>
          <p class="text-xs text-gray-400">コード全体を生成します。新規作成時や大幅改修時に使用し、エディタの「全貼付」で反映させます。</p>
        </div>
        <div class="space-y-2">
          <h4 class="font-bold text-white border-l-2 border-green-500 pl-2">2. 部分修正(JSON)モード <span class="text-green-400 text-[10px]">推奨</span></h4>
          <p class="text-xs text-gray-400">
             AIが修正箇所をJSON形式で出力します。JSONをコピーし、「JSON適用」ボタンから貼り付けるだけで、<strong class="text-white">ピンポイントでコードが修正</strong>されます。<br>
             長いコードの修正に最適です。
          </p>
        </div>
        <div class="space-y-2">
          <h4 class="font-bold text-white border-l-2 border-blue-500 pl-2">3. プレビュー</h4>
          <p class="text-xs text-gray-400">
             「別窓で開く」を使うと、ブラウザの全画面でアプリの動作を確認できます。
          </p>
        </div>
      </div>
      <div class="p-4 border-t border-gray-700 bg-forge-800">
         <button @click="modals.help=false" class="w-full py-2 bg-blue-600 rounded font-bold text-white">OK</button>
      </div>
    </div>
  </div>

</div>

<script>
const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

// --- DB Utility (Simple Wrapper) ---
const DB_NAME = 'AppStationMobileDB';
const DB_VER = 1;
const STORE = 'apps';

const dbPromise = new Promise((resolve, reject) => {
  const req = indexedDB.open(DB_NAME, DB_VER);
  req.onupgradeneeded = (e) => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains(STORE)) {
      db.createObjectStore(STORE, { keyPath: 'id' });
    }
  };
  req.onsuccess = () => resolve(req.result);
  req.onerror = () => reject(req.error);
});

async function dbGetAll() {
  const db = await dbPromise;
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

async function dbPut(item) {
  const db = await dbPromise;
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).put(JSON.parse(JSON.stringify(item)));
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

async function dbDelete(id) {
  const db = await dbPromise;
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).delete(id);
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
  });
}

// --- MAIN APP ---
createApp({
  setup() {
    const activeTab = ref('library');
    const apps = ref([]);
    const consoleVisible = ref(true);
    const logs = ref([]);
    
    // State for current editing app
    const currentApp = reactive({
      id: '',
      title: '',
      code: '',
      comment: '',
      updatedAt: null
    });

    const modals = reactive({ ai: false, help: false, jsonPatch: false, manualPatch: false, patchSelect: false, saveSelect: false });
    const aiInstruction = ref('');
    const aiMode = ref('full'); // 'full' | 'patch'
    const jsonInput = ref('');
    const manualFind = ref('');
    const manualReplace = ref('');
    
    const toast = reactive({ show: false, title: '', message: '', icon: '' });

    // Computed
    const sortedApps = computed(() => {
      return [...apps.value].sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
    });

    // Methods
    const showToast = (title, message='', icon='fa-check-circle', duration=2000) => {
      toast.title = title;
      toast.message = message;
      toast.icon = icon;
      toast.show = true;
      setTimeout(() => toast.show = false, duration);
    };

    const loadApps = async () => {
      try {
        apps.value = await dbGetAll();
      } catch(e) { console.error(e); }
    };

    const createNewApp = () => {
      const id = 'app_' + Date.now().toString(36);
      currentApp.id = id;
      currentApp.title = 'New App';
      currentApp.code = ''; // Start empty for clean paste
      currentApp.comment = '';
      currentApp.updatedAt = new Date().toISOString();
      
      // Default template
      currentApp.code = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Mobile App</title>
  <style>
    body { font-family: sans-serif; display: grid; place-items: center; height: 100vh; margin: 0; background: #f0f4f8; }
    .card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
    button { background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Hello World!</h1>
    <p>AIで作ったコードをここに貼ろう。</p>
    <button onclick="alert('OK!')">Click Me</button>
  </div>

<script id="lfs-meta" type="application/json">
{
  "appId": "74dd51a7aebe31eeb25e5b6ade6495bc",
  "createdAt": "2026-01-04T22:37:05.922Z",
  "schema": 2,
  "title": "AppStudio Mobile",
  "savedAt": "2026-01-04T22:37:05.922Z",
  "aiInstruction": "",
  "comment": "",
  "sourceMode": "project",
  "runId": "e285755a1ca71d3677914869affa4061"
}
</script>
</body>
</html>`;

      switchTab('editor');
    };

    const openApp = (app) => {
      Object.assign(currentApp, app);
      switchTab('editor');
    };

    const deleteApp = async (id) => {
      if(!confirm('本当に削除しますか？')) return;
      await dbDelete(id);
      await loadApps();
      showToast('削除しました', '', 'fa-trash');
    };

    const saveToDb = async () => {
      if(!currentApp.code) return;
      currentApp.updatedAt = new Date().toISOString();
      
      // Attempt to extract title from HTML
      const m = currentApp.code.match(/<title>(.*?)<\/title>/);
      if(m && m[1]) {
        if(currentApp.title === 'New App') currentApp.title = m[1];
      }

      await dbPut(currentApp);
      await loadApps();
      modals.saveSelect = false;
      showToast('保存しました');
    };

    const downloadHtml = () => {
      if(!currentApp.code) return;
      const title = currentApp.title || 'myapp';
      const filename = title.replace(/[\\/:*?"<>|]/g, '_') + '.html';
      
      const blob = new Blob([currentApp.code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      modals.saveSelect = false;
      showToast('ダウンロードしました', '', 'fa-download');
    };

    const pasteCode = async () => {
      try {
        const text = await navigator.clipboard.readText();
        if(text) {
          if(currentApp.code.length > 10 && !confirm("現在のコードを上書きしますか？")) return;
          currentApp.code = text;
          showToast('全貼付完了', '', 'fa-paste');
        } else {
          showToast('クリップボードが空です', '', 'fa-exclamation-triangle');
        }
      } catch(e) {
        alert("貼り付けに失敗しました。\nブラウザの制限のため、手動で貼り付けてください。");
      }
    };

    const copyCode = async () => {
      if(!currentApp.code) return;
      try {
        await navigator.clipboard.writeText(currentApp.code);
        showToast('コードをコピーしました', '', 'fa-copy');
      } catch(e) {
        alert("コピー失敗");
      }
    };

    const clearCode = () => {
      if(currentApp.code && !confirm("エディタの内容を全て消去しますか？")) return;
      currentApp.code = '';
      showToast('クリアしました', '', 'fa-eraser');
    };

    // --- Tab Switching & Preview Logic ---
    const switchTab = async (tab) => {
      activeTab.value = tab;
      if (tab === 'run') {
        await nextTick();
        reloadPreview();
      }
    };

    const reloadPreview = () => {
      const frame = document.getElementById('preview-frame');
      if(!frame) return;
      
      logs.value = []; 
      
      const shim = `
      <script>
        (function(){
          const send = (t, m) => window.parent.postMessage({type:'console', level:t, msg:m}, '*');
          const fmt = (a) => a.map(x => typeof x==='object'?JSON.stringify(x):String(x)).join(' ');
          console.log = (...a) => { send('info', fmt(a)); };
          console.error = (...a) => { send('error', fmt(a)); };
          console.warn = (...a) => { send('warn', fmt(a)); };
          window.onerror = (msg, url, line) => { send('error', msg + ' (line:' + line + ')'); };
        })();
      <\/script>`;
      
      let html = currentApp.code || '';
      if(html.includes('<head>')) {
        html = html.replace('<head>', '<head>' + shim);
      } else {
        html = shim + html;
      }
      frame.srcdoc = html;
    };
    
    const openInNewWindow = () => {
      const blob = new Blob([currentApp.code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    };

    // --- AI & Patch Logic ---
    const openAiModal = () => {
      aiInstruction.value = '';
      aiMode.value = 'patch'; // Default to patch for efficiency
      modals.ai = true;
    };

    const copyPrompt = async () => {
      let prompt = '';
      
      if (aiMode.value === 'full') {
        prompt = `あなたは優秀なWebエンジニアです。
以下の単一HTMLファイルで動作するアプリのコードを、指示に従って修正（または新規作成）してください。

[現在のコード]
\`\`\`html
${currentApp.code}
\`\`\`

[指示]
${aiInstruction.value}

[制約]
- 必ずHTML/CSS/JSを1つのHTMLファイルにまとめてください。
- ライブラリはCDNを使用してください。
- 解説は最小限にし、修正後の「完全なHTMLコード」を出力してください。`;
      } else {
        // Patch (JSON) Mode
        prompt = `あなたはコード修正のエキスパートです。
以下のアプリコードを修正してください。修正は差分のみをJSON形式で出力してください。

[現在のコード(参考)]
\`\`\`html
${currentApp.code}
\`\`\`

[修正指示]
${aiInstruction.value}

[重要:出力形式]
以下のJSON形式で出力してください。解説は不要です。
\`\`\`json
{
  "patches": [
    {
      "find": "(置換対象のコードをそのまま記述。改行やインデントも含めて一意に特定できる十分な長さのブロック)",
      "replace": "(置換後のコード)"
    }
  ]
}
\`\`\`

[制約]
- "find"フィールドのコードは、ファイル内で **必ず一箇所だけ** マッチするように範囲を調整してください。
- 複数の箇所を修正する場合は、配列にオブジェクトを追加してください。`;
      }

      try {
        await navigator.clipboard.writeText(prompt);
        modals.ai = false;
        showToast('プロンプトをコピーしました', 'AIに貼り付けてください', 'fa-copy', 2500);
      } catch(e) {
        alert("コピー失敗");
      }
    };
    
    // Parse JSON safely (strips markdown fences if present)
    const parseLooseJson = (str) => {
      try {
        // remove ```json ... ```
        let cleaned = str.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(cleaned);
      } catch(e) {
        return null;
      }
    };

    const applyJsonPatch = () => {
      const data = parseLooseJson(jsonInput.value);
      if (!data) {
        alert("JSONのパースに失敗しました。形式を確認してください。");
        return;
      }
      
      const patches = Array.isArray(data) ? data : (data.patches || [data]);
      let tempCode = currentApp.code;
      let successCount = 0;
      
      try {
        for (const p of patches) {
          const findStr = p.find || p.original;
          const replStr = p.replace || p.modified;
          
          if(!findStr) continue;
          
          // Check uniqueness
          const parts = tempCode.split(findStr);
          if (parts.length === 1) {
            throw new Error(`置換対象が見つかりません:\n${findStr.slice(0,50)}...`);
          }
          if (parts.length > 2) {
            throw new Error(`置換対象が複数(${parts.length-1}件)見つかりました。特定できません:\n${findStr.slice(0,50)}...`);
          }
          
          // Apply
          tempCode = parts.join(replStr);
          successCount++;
        }
        
        currentApp.code = tempCode;
        jsonInput.value = ''; // clear
        modals.jsonPatch = false;
        showToast('修正適用完了', `${successCount}件のパッチを適用しました`, 'fa-check-double');
        
      } catch(e) {
        alert("適用エラー:\n" + e.message);
      }
    };
    
    const applyManualPatch = () => {
      const f = manualFind.value;
      const r = manualReplace.value;
      if (!f) return;
      
      const parts = currentApp.code.split(f);
      if (parts.length === 1) {
        alert("対象が見つかりません");
        return;
      }
      // Manual allows replacement even if multiple, but warn
      if (parts.length > 2) {
        if(!confirm(`対象が ${parts.length-1} 箇所あります。すべて置換しますか？`)) return;
      }
      
      currentApp.code = parts.join(r);
      modals.manualPatch = false;
      showToast('手動置換完了');
    };
    
    // --- Helper ---
    const formatDate = (iso) => {
      if(!iso) return '';
      const d = new Date(iso);
      return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    };
    
    const showHelp = () => { modals.help = true; };

    // Console message listener
    window.addEventListener('message', (e) => {
      if(e.data && e.data.type === 'console') {
        const time = new Date().toLocaleTimeString().split(' ')[0];
        let color = 'text-gray-300';
        if(e.data.level === 'error') color = 'text-red-400';
        if(e.data.level === 'warn') color = 'text-yellow-400';
        logs.value.push({ time, msg: e.data.msg, color });
        // Scroll to bottom
        nextTick(() => {
          const c = document.querySelector('.overflow-y-auto');
          if(c && c.lastElementChild) c.lastElementChild.scrollIntoView();
        });
      }
    });

    onMounted(() => {
      loadApps();
      if(!localStorage.getItem('appstation_mobile_v2_seen')) {
        modals.help = true;
        localStorage.setItem('appstation_mobile_v2_seen', '1');
      }
    });

    return {
      activeTab, apps, currentApp, sortedApps,
      modals, aiInstruction, aiMode, jsonInput, manualFind, manualReplace,
      logs, consoleVisible, toast,
      switchTab, createNewApp, openApp, saveToDb, downloadHtml, deleteApp,
      pasteCode, copyCode, clearCode, reloadPreview, openInNewWindow,
      openAiModal, copyPrompt, applyJsonPatch, applyManualPatch,
      formatDate, showHelp
    };
  }
}).mount('#app');
</script>
</body>
</html>