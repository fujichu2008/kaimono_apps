<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>調達クエスト — 理不尽依頼ディフェンス（iPad版 MVP）</title>
<meta name="theme-color" content="#4a6b4a" />
<style>
  :root{
    /* 昭和オフィス感（セピア×緑） */
    --paper:#f4f1e3;           /* 背景：黄ばんだ紙 */
    --ink:#1f2a1f;             /* テキスト濃い目 */
    --faint-ink:#3f4a3f;       
    --steel:#3b6b77;           /* スチール家具青緑 */
    --green:#6b8e23;           /* 緑電話色 */
    --lcd:#cfe7c3;             /* 電卓液晶 */
    --line:#d9d2be;            /* 紙の罫線 */
    --alert:#b65c39;           /* 赤茶インク */
    --ok:#2e7d32;              /* OK緑 */
    --bad:#8b2e1a;
    --boss:#6b2333;            /* 鬼部長カラー */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: "Yuji Syuku","Hiragino Maru Gothic ProN","Hiragino Kaku Gothic ProN","Kosugi Maru","Yu Gothic", system-ui, -apple-system, "Apple Color Emoji", "Segoe UI Emoji", cursive;
    background: repeating-linear-gradient(0deg,var(--paper),var(--paper) 28px,#f0ecd9 29px) fixed;
    color:var(--ink);
    -webkit-user-select:none; user-select:none;
    touch-action: pan-x pan-y;
  }
  .app{max-width:1024px; margin:0 auto; min-height:100%; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 12px 12px; gap:12px}
  header{
    position: sticky; top:0; z-index:50; background:linear-gradient(#f6f3e6aa,#f6f3e600);
    backdrop-filter: blur(2px);
    padding-top: env(safe-area-inset-top);
  }
  .hud{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; align-items:center}
  .gauge{background:var(--lcd); border:2px solid var(--line); border-radius:10px; padding:6px 10px; box-shadow: inset 0 1px 0 #ffffff80, 0 1px 0 #0000000f}
  .gauge label{font-size:12px; letter-spacing:.05em; color:var(--faint-ink)}
  .bar{height:10px; background:#0001; border-radius:6px; overflow:hidden; margin-top:4px}
  .bar>i{display:block; height:100%; width:50%; background:linear-gradient(90deg,var(--green),#7aa842)}
  .counter{font-variant-numeric: tabular-nums; font-weight:700}

  .lanes{position:relative; flex:1; min-height:360px; border:2px dashed var(--line); border-radius:14px; background:linear-gradient(#f7f4e6,#f2eedf); overflow:hidden}
  .lane-divider{position:absolute; left:50%; top:0; bottom:0; width:2px; background: repeating-linear-gradient(180deg, #cabfa3, #cabfa3 8px, transparent 8px, transparent 16px)}
  .note{position:absolute; left:8px; right:8px; top:8px; display:flex; gap:8px; align-items:center}
  .stamp{font-size:12px; color:var(--alert); border:2px solid var(--alert); border-radius:6px; padding:2px 6px; transform: rotate(-5deg); box-shadow: 0 0 0 2px #0000, inset 0 0 0 2px #0000}

  .card{position:absolute; width:min(92%, 520px); left:50%; transform:translateX(-50%);
        background:#fffef5; border:2px solid #d2c9ac; border-radius:12px; padding:10px 12px; 
        box-shadow: 0 6px 12px #00000014; 
        font-size:18px; line-height:1.4; letter-spacing:.02em;
        touch-action:none}
  .card .meta{display:flex; gap:8px; align-items:center; color:#6b6b5a; font-size:12px}
  .tag{display:inline-block; border:1px dashed #a89d7d; padding:0 6px; border-radius:999px; font-size:11px; color:#70684d; background:#fff9d9}
  .title{margin:6px 0 2px; font-weight:700}
  .body{font-size:16px}
  .ghost{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); opacity:.35; pointer-events:none; font-size:22px; color:#2d3b2d; text-align:center}

  .buckets{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:12px}
  .bucket{background:linear-gradient(#e6efde,#d9e8cd); border:2px solid #a9c39a; border-radius:14px; min-height:92px; padding:10px; display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; text-align:center; transition: transform .08s}
  .bucket i{font-size:20px}
  .bucket b{font-size:14px}
  .bucket[data-type="spec"]{background:linear-gradient(#efe9d7,#e5dcc4)}
  .bucket[data-type="price"]{background:linear-gradient(#e1eddc,#d3e5cd)}
  .bucket[data-type="delivery"]{background:linear-gradient(#e0ecf0,#d1e2e8)}
  .bucket[data-type="shikakari"]{background:linear-gradient(#eee4e2,#e4d6d3)}
  .bucket[data-type="idle"]{background:linear-gradient(#f3f3ef,#e6e6de)}
  .bucket.tap{transform: scale(0.98)}

  footer{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:700; background:var(--green); color:#fff; box-shadow:0 4px 0 #4b6518; transform: translateY(0); transition:.1s}
  .btn:active{transform: translateY(2px); box-shadow:0 2px 0 #4b6518}
  .muted{background:#879e85; box-shadow:0 4px 0 #6d826b}

  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#000a; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; opacity:0; pointer-events:none}
  .toast.show{animation:pop 1.5s ease}
  @keyframes pop{ 0%{opacity:0; transform:translateX(-50%) translateY(10px)} 12%{opacity:1; transform:translateX(-50%) translateY(0)} 80%{opacity:1} 100%{opacity:0} }

  /* タイトル／リザルト画面 */
  .overlay{position:fixed; inset:0; background:linear-gradient(#f6f2e4ee,#f4f1e3ee); display:flex; align-items:center; justify-content:center; z-index:100}
  .panel{max-width:760px; width:min(92%,760px); text-align:center; padding:28px 20px; border:3px double #b9b096; border-radius:18px; background:#fffdf5ee; box-shadow:0 8px 24px #0000001a}
  .logo{font-family:'Yuji Syuku',serif; font-size:48px; letter-spacing:.18em; color:#2b392b; text-shadow:0 2px 0 #ffffffaa, 0 3px 6px #0000001a; animation:gloom 4s ease-in-out infinite}
  .subtitle{margin-top:4px; color:#4d5a4d; letter-spacing:.2em}
  .start{margin-top:18px}
  .results h2{margin:0 0 8px; font-size:28px}
  .results .stat{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin:12px 0}
  .results .stat div{background:#f6f3e6; border:1px solid #d8cfb4; border-radius:10px; padding:10px 8px}
  .results .comment{margin-top:12px; color:#2b2b2b}
  @keyframes gloom{0%,100%{transform:translateY(0)} 50%{transform:translateY(1px)}}

  /* 横向きで2レーン */
  @media (orientation: landscape){
    .lanes{min-height:420px}
    .lane-divider{display:block}
  }
  @media (orientation: portrait){
    .lane-divider{display:none}
  }
</style>
</head>
<body>
<div class="overlay" id="titleScreen">
  <div class="panel">
    <div class="logo">調達クエスト</div>
    <div class="subtitle">— 悲哀とユーモアの理不尽依頼ディフェンス —</div>
    <div class="start"><button class="btn" id="titleStart">▶ スタート</button></div>
  </div>
</div>

<div class="overlay" id="resultScreen" style="display:none">
  <div class="panel results">
    <h2 id="resultTitle">勤務評価</h2>
    <div class="stat">
      <div>⏱️ 時間<br><b id="rTime">00:00</b></div>
      <div>🏷️ スコア<br><b id="rScore">0</b></div>
      <div>📈 評価<br><b id="rEval">0</b></div>
      <div>🧠 心<br><b id="rHP">0</b></div>
    </div>
    <div class="stat">
      <div>✅ 正答<br><b id="rOK">0</b></div>
      <div>❌ ミス<br><b id="rNG">0</b></div>
      <div>🕳️ 落下
        <br><b id="rDrop">0</b></div>
      <div>👹 鬼部長
        <br><b id="rBoss">—</b></div>
    </div>
    <div class="comment" id="rComment">講評が入ります</div>
    <div class="start" style="display:flex; gap:8px; justify-content:center">
      <button class="btn" id="retryBtn">🔁 もう一度</button>
      <button class="btn" id="backTitleBtn">🏠 タイトルへ</button>
    </div>
  </div>
</div>

<div class="app">
  <header>
    <div class="hud">
      <div class="gauge" id="hpBox"><label>🧠 心のHP</label><div class="bar"><i id="hpBar" style="width:80%"></i></div></div>
      <div class="gauge" id="unreadBox"><label>🔔 未読(Teams)</label><div class="counter" id="unread">0</div></div>
      <div class="gauge" id="evalBox"><label>📈 評価</label><div class="bar"><i id="evalBar" style="width:10%"></i></div></div>
      <div class="gauge" id="scoreBox"><label>🏷️ スコア</label><div class="counter" id="score">0</div></div>
      <div class="gauge"><label>⏳ 残り</label><div class="counter" id="timeLeft">03:00</div></div>
    </div>
  </header>

  <div class="lanes" id="lanes">
    <div class="note">
      <span class="stamp">至急多め</span>
      <span class="stamp" style="transform:rotate(8deg)">仕様未定注意</span>
    </div>
    <div class="lane-divider"></div>
    <div class="ghost" id="ghost">タイルを<strong>タップ</strong>で仕分け / 長押しで<strong>ドラッグ→タイル</strong>でもOK</div>
  </div>

  <div class="buckets">
    <div class="bucket" data-type="spec"><i>🧩</i><b>仕様未定系</b></div>
    <div class="bucket" data-type="price"><i>💸</i><b>価格無茶振り系</b></div>
    <div class="bucket" data-type="delivery"><i>⏱️</i><b>納期地獄系</b></div>
    <div class="bucket" data-type="shikakari"><i>🗂️</i><b>仕掛かり案件地獄系</b></div>
    <div class="bucket" data-type="idle"><i>🫥</i><b>放置で良し系</b></div>
  </div>

  <footer>
    <button class="btn muted" id="muteBtn">🔇 Mute</button>
  </footer>
</div>
<div class="toast" id="toast">Level Up!!</div>

<script>
(function(){
  const lanes = document.getElementById('lanes');
  const ghost = document.getElementById('ghost');
  const hpBar = document.getElementById('hpBar');
  const evalBar = document.getElementById('evalBar');
  const unreadEl = document.getElementById('unread');
  const scoreEl = document.getElementById('score');
  const timeLeftEl = document.getElementById('timeLeft');
  const muteBtn = document.getElementById('muteBtn');
  const toast = document.getElementById('toast');
  const titleScreen = document.getElementById('titleScreen');
  const titleStart = document.getElementById('titleStart');
  const resultScreen = document.getElementById('resultScreen');
  const rTime = document.getElementById('rTime');
  const rScore = document.getElementById('rScore');
  const rEval = document.getElementById('rEval');
  const rHP = document.getElementById('rHP');
  const rOK = document.getElementById('rOK');
  const rNG = document.getElementById('rNG');
  const rDrop = document.getElementById('rDrop');
  const rBoss = document.getElementById('rBoss');
  const rComment = document.getElementById('rComment');
  const retryBtn = document.getElementById('retryBtn');
  const backTitleBtn = document.getElementById('backTitleBtn');

  // ======= ゲームパラメータ
  const TOTAL_MS = 180000; // 3分
  const BOSS_MS  = 150000; // 2:30
  const DROP_PENALTY = {hp:-4, eval:-3, score:-8}; // 未処理追加ペナルティ

  // 状態
  let hp=80, evalv=10, unread=0, score=0, running=false, muted=false;
  let spawnTimer=0, spawnInterval=1900; // ms（時間で短縮）
  let cards=[];
  let elapsed=0, lastDiffTick=0; // 経過時間
  let bossActive=false; let bossSeen=false;
  let statOK=0, statNG=0, statDrop=0;

  // ===== プール安全構築
  const ALLOWED_TYPES = new Set(['spec','price','delivery','shikakari','idle']);
  const userPool = [];
  const defaults = (()=>{
    const byTypeWeight = {
      spec:     { ok:{hp:+1, eval:+4, score:+12}, ng:{hp:-6, eval:-3, score:-7} },
      price:    { ok:{hp: 0, eval:+4, score:+11}, ng:{hp:-6, eval:-3, score:-7} },
      delivery: { ok:{hp: 0, eval:+4, score:+12}, ng:{hp:-8, eval:-3, score:-8} },
      shikakari:{ ok:{hp:+1, eval:+3, score:+10}, ng:{hp:-3, eval:-3, score:-6} },
      idle:     { ok:{hp:+2, eval:+1, score: +6}, ng:{hp:-1, eval:-1, score:-3} },
    };
    const make = (type, texts)=>texts.map(t=>({type, text:t, ...byTypeWeight[type]}));

    const specTexts = ['仕様まだ。価格だけ出して','仕様変わるかも。納期は前倒しで','要件未確定。概算だけ','図面は後送。リードタイムだけ','詳細は現物合わせで。手配して','社内承認前ですが予約だけ','デザイン変更濃厚。金額影響だけ','型式は後で。まずは可否','先行手配でLT短縮を','社外秘で仕様出せません','顧客の意向で仕様白紙に戻るかも','セカンドソース化の検討だけ先に','前回踏襲で（前回はトラブル）','試作品で様子見しつつ量産見積','“現物合わせ”で見積を'];

    const priceTexts = ['今年予算ゼロ。品質は死守で','ネット最安あるよ？（謎ブログ）','前任者はもっと安かった','値引き＋支払120日で','指数連動やめて固定単価で','合見積10社（今日中）','単価30%ダウンのロードマップ','上長の一声で更に5%引き','初回赤字で将来回収して','支払サイト180日に延長','社長案件：とりあえず安く','為替は良い方向に振れる前提','KPIのため今月だけ5%引き','年間量未定だが量産価格で','支払は即日で（前払希望）'];

    const deliveryTexts = ['明日搬入。今日中回答で','試作を前倒し。LT半分で','台風でも搬入は予定通り','設備停止中。至急で手配','船便→エア便に切替で据置','税関トラブルだが納期厳守','他部門の遅れは調達で吸収','段取り未確定だが現場は動く','金曜17:50→明朝納入','月末棚卸でも搬入そのまま','港が混雑。だが納期は死守','保税でなんとか早められない？'];

    const shikakariTexts = ['仕掛かりどこまで？（承認者不明）','フォームが最新じゃないので差戻し','印の順番が違うのでやり直し','承認者が長期出張で停止中','関連部署の回覧を追加して再提出','PDFの余白が広いので修正','発注前に契約ドラフトも添付','仕掛かり番号を取り直し','原価科目が違うので差戻し','取引先名が全角半角不統一','番号発行システムがメンテ中','電子契約の承認フロー未整備','最終承認者が退職していた','契約ドラフトのフォントが違う'];

    const idleTexts = ['念のため依頼。急ぎじゃない（赤字）','状況共有だけ（返信不要）','過去の依頼を再掲（対応済）','取引なしベンダからの宣伝','CCに入ってるだけのスレ','誤送信でした。失礼しました','また後日相談の宣言','会議の議事録（後でOK）','上司のガス抜き（独り言）','週報（既読だけでOK）','FYI: 海外子会社の近況','メディア掲載の共有（対応不要）','「面白い記事」共有（無関係）','雑談スレ（アーカイブ推奨)'];

    return [
      ...make('spec', specTexts),
      ...make('price', priceTexts),
      ...make('delivery', deliveryTexts),
      ...make('shikakari', shikakariTexts),
      ...make('idle', idleTexts),
    ];
  })();

  function isValidItem(it){
    return !!it && typeof it.text==='string' && it.text.trim().length>0 && ALLOWED_TYPES.has(it.type);
  }
  function withWeights(it){
    const typeDefaults = {
      spec:{ ok:{hp:+1, eval:+4, score:+12}, ng:{hp:-6, eval:-3, score:-7}},
      price:{ ok:{hp: 0, eval:+4, score:+11}, ng:{hp:-6, eval:-3, score:-7}},
      delivery:{ ok:{hp: 0, eval:+4, score:+12}, ng:{hp:-8, eval:-3, score:-8}},
      shikakari:{ ok:{hp:+1, eval:+3, score:+10}, ng:{hp:-3, eval:-3, score:-6}},
      idle:{ ok:{hp:+2, eval:+1, score: +6}, ng:{hp:-1, eval:-1, score:-3}},
    }[it.type];
    const ok = Object.assign({}, typeDefaults.ok, it.ok||{});
    const ng = Object.assign({}, typeDefaults.ng, it.ng||{});
    return {type:it.type, text:it.text, ok, ng};
  }
  function buildPool(){
    const a = Array.isArray(userPool)? userPool.filter(isValidItem).map(withWeights) : [];
    const base = defaults.filter(isValidItem).map(withWeights);
    const merged = (a.length? a : base);
    return merged;
  }

  const POOL = buildPool();

  // ======== WebAudio
  let actx, master;
  function initAudio(){ if(actx) return; actx = new (window.AudioContext||window.webkitAudioContext)(); master = actx.createGain(); master.gain.value = 0.4; master.connect(actx.destination); }
  function beep(freq=660, dur=0.06, type='sine', t0){ if(muted || !actx) return; const now=t0||actx.currentTime; const o=actx.createOscillator(); const g=actx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master); g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.6,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+dur); o.start(now); o.stop(now+dur+0.01); }
  const SE={ spawn(){const t=actx?.currentTime||0; beep(740,0.05,'triangle',t); beep(880,0.05,'sine',t+0.05);}, ok(){const t=actx?.currentTime||0; beep(660,0.04,'square',t); beep(990,0.05,'sine',t+0.06);}, miss(){const t=actx?.currentTime||0; beep(220,0.06,'sawtooth',t);}, unread(){const t=actx?.currentTime||0; beep(520,0.02,'triangle',t);}, lvl(){const t=actx?.currentTime||0; beep(523.25,0.06,'sine',t); beep(659.25,0.06,'sine',t+0.07); beep(783.99,0.09,'sine',t+0.14);}, dead(){const t=actx?.currentTime||0; beep(110,0.3,'sine',t);} };

  function showToast(msg){ toast.textContent=msg; toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show'); }
  function updateHUD(){ hpBar.style.width=Math.max(0,Math.min(100,hp))+'%'; evalBar.style.width=Math.max(0,Math.min(100,evalv))+'%'; unreadEl.textContent=unread; scoreEl.textContent=score; timeLeftEl.textContent = fmtTime(Math.max(0, TOTAL_MS - elapsed)); }
  function fmtTime(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; }

  function spawnCard(){
    if(!POOL.length){ running=false; showToast('メッセージが未設定です（POOLが空）'); return; }
    const laneW = lanes.clientWidth;
    const isLandscape = matchMedia('(orientation: landscape)').matches;
    const col = isLandscape ? (Math.random()<0.5? 0.25:0.75) : 0.5;

    const idx = Math.floor(Math.random()*POOL.length);
    const item = POOL[idx];
    if(!item || !item.type){ return; }

    const card = document.createElement('div');
    card.className='card';
    card.style.top = '-140px';
    card.style.left = (laneW*col) + 'px';
    card.style.transform = 'translateX(-50%)';
    card.dataset.type = item.type;
    card.dataset.idx = String(idx);
    card.innerHTML = `
      <div class="meta"><span class="tag">#${labelFromType(item.type)}</span><span class="tag">至急</span></div>
      <div class="title">[依頼] ${headline(item.text)}</div>
      <div class="body">${item.text}</div>
    `;
    lanes.appendChild(card);
    makeDraggable(card);
    const speedBase = 60 + Math.random()*35;
    const speedUp = Math.min(1.6, 1 + elapsed/90000) * (bossActive? 1.35:1);
    cards.push({el:card, vy: speedBase*speedUp});
    unread++; SE.unread(); updateHUD();
    SE.spawn();
  }

  function headline(t){ return t.length>18 ? t.slice(0,18)+'…' : t; }
  function labelFromType(t){ return ({spec:'仕様未定', price:'価格無茶', delivery:'納期地獄', shikakari:'仕掛かり', idle:'放置で良し'})[t] || t; }

  // ====== タイルタップで仕分け
  const buckets = Array.from(document.querySelectorAll('.bucket'));
  buckets.forEach(b=>{ b.addEventListener('click', ()=>{ b.classList.add('tap'); setTimeout(()=>b.classList.remove('tap'),80); tryAssignByTap(b.dataset.type); }); });
  function getActiveCard(){ let best=null, bestTop=-Infinity; for(const c of cards){ if(!c.el.isConnected) continue; const t=parseFloat(c.el.style.top||'-140'); if(t>bestTop){bestTop=t; best=c;} } return best?.el || null; }
  function tryAssignByTap(assignType){ const card=getActiveCard(); if(!card){ showToast('対象なし'); return; } const correct=(assignType===card.dataset.type)||(assignType==='idle'&&card.dataset.type==='idle'); resolveCard(card, correct); }

  function resolveCard(card, correct){
    card.style.transition='transform .18s ease, opacity .18s';
    card.style.opacity=.0; card.style.transform='translateX(-50%) translateY(40px)';

    const item = POOL[Number(card.dataset.idx)] || {ok:{hp:0,eval:0,score:0}, ng:{hp:-6,eval:-3,score:-6}, type:'spec'};
    if(correct){
      hp   = clamp(hp   + (item.ok?.hp||0));
      evalv= clamp(evalv+ (item.ok?.eval||0));
      score= Math.max(0, score + (item.ok?.score||0));
      unread = Math.max(0, unread - 1);
      statOK++;
      SE.ok();
    } else {
      hp   = clamp(hp   + (item.ng?.hp||-8));
      evalv= clamp(evalv+ (item.ng?.eval||-3));
      score= Math.max(0, score + (item.ng?.score||-6));
      statNG++;
      SE.miss(); showToast('全方位からメンションが飛んできた…'); if(hp===0){ endGame(false); return; }
    }
    updateHUD(); setTimeout(()=>{ card.remove(); }, 180);
  }

  // ====== 長押しドラッグ→タイルドロップ
  function makeDraggable(card){
    let startX=0,startY=0,x=0,y=0,dragging=false,longPressed=false,pressTimer; const LONG=220;
    function beginPress(){ clearTimeout(pressTimer); pressTimer=setTimeout(()=>{ longPressed=true; dragging=true; ghost.style.opacity=.35; }, LONG); }
    function endPress(){ clearTimeout(pressTimer); }
    card.addEventListener('pointerdown', e=>{ card.setPointerCapture(e.pointerId); startX=e.clientX; startY=e.clientY; x=0; y=0; longPressed=false; dragging=false; beginPress(); }, {passive:true});
    card.addEventListener('pointermove', e=>{ if(!dragging) return; x=e.clientX-startX; y=e.clientY-startY; card.style.transform=`translateX(calc(-50% + ${x}px)) translateY(${y}px) rotate(${x*0.02}deg)`; card.style.boxShadow='0 10px 18px #00000026'; }, {passive:true});
    card.addEventListener('pointerup', e=>{ endPress(); card.releasePointerCapture(e.pointerId); if(!dragging){ return; } dragging=false; const rect=card.getBoundingClientRect(); const cx=rect.left+rect.width/2; const cy=rect.top+rect.height/2; let dropType=null; for(const b of buckets){ const br=b.getBoundingClientRect(); if(cx>br.left&&cx<br.right&&cy>br.top&&cy<br.bottom){ dropType=b.dataset.type; break; } } if(dropType){ resolveCard(card, dropType===card.dataset.type || (dropType==='idle' && card.dataset.type==='idle')); } else { card.style.transition='transform .18s ease'; card.style.transform='translateX(-50%) translateY(0)'; setTimeout(()=>{card.style.transition='';},180);} x=y=0; }, {passive:true});
    card.addEventListener('pointercancel', ()=>{ endPress(); dragging=false; });
  }

  function clamp(v){ return Math.max(0, Math.min(100, v)); }

  function endGame(victory){
    running=false;
    // 統計の締め
    rTime.textContent = fmtTime(elapsed);
    rScore.textContent= String(score);
    rEval.textContent = String(Math.round(evalv));
    rHP.textContent   = String(Math.round(hp));
    rOK.textContent   = String(statOK);
    rNG.textContent   = String(statNG);
    rDrop.textContent = String(statDrop);
    rBoss.textContent = bossSeen? '撃退…できてはいない':'遭遇前に終了';

    // 講評
    rComment.textContent = makeComment(victory, {score,evalv,hp,statOK,statNG,statDrop,bossSeen});
    document.getElementById('resultTitle').textContent = victory? '勤務評価：生還！' : '勤務評価：過労死寸前…';

    // 画面
    resultScreen.style.display='flex';
  }

  function makeComment(v, s){
    if(v && s.score>=400) return '伝説の調達士。伝票の神、倉庫の守護者。次の人事は「課長代理（実質代理の代理）」です。';
    if(v && s.statDrop===0) return '落下ゼロ。あなたの指先は承認フローそのもの。次回ボスもタジタジ。';
    if(!v && s.statDrop>10) return '仕掛かり案件の山、その名もエベレスト。ベースキャンプは総務部にあります。';
    if(!v && s.hp<=0) return '精神崩壊エンド。観葉植物だけが昇進しました。';
    if(s.bossSeen && v) return '鬼部長の怒号を華麗にスルー。これぞ真のサプライチェーン。';
    if(s.bossSeen && !v) return '鬼部長襲来で物流崩壊。次は耳栓と根回しを装備しましょう。';
    if(s.evalv>=80) return '社内評価うなぎ登り。次回から会議の椅子が回転式になります。';
    if(s.score<100) return '今日の成果：耐えた。以上。明日はもっと耐える。';
    return '在庫も心もギリギリ在庫回転。だが回っている、それが重要。';
  }

  // ====== ループ
  let last=0;
  function loop(ts){
    if(!running){ last=ts; requestAnimationFrame(loop); return; }
    const dt = ts-last; last=ts; elapsed += dt;

    // BOSS判定
    if(!bossActive && elapsed>=BOSS_MS){ bossActive=true; bossSeen=true; spawnInterval=Math.max(450, spawnInterval-500); showToast('👹 鬼部長が現れた！'); }

    // 経過時間でスポーン間隔を短縮（最大で約450msまで / ボス時さらに速い）
    if(elapsed - lastDiffTick > 8000){ // 8秒ごとに少しだけ増便
      lastDiffTick = elapsed;
      const dec = bossActive? 120:80;
      spawnInterval = Math.max(bossActive? 450:700, spawnInterval - dec);
      SE.lvl();
    }

    // 落下処理
    for(const c of cards){
      const el=c.el; if(!el.isConnected) continue;
      const top = parseFloat(el.style.top||'-140');
      const ny = top + (c.vy*dt/1000);
      el.style.top = ny + 'px';
      if(ny>lanes.clientHeight-20){ // 地面到達＝未処理
        const item = POOL[Number(el.dataset.idx)] || {ng:{hp:-6,eval:-2,score:-6}};
        el.remove();
        // 未処理はNG＋追加ペナルティ
        hp   = clamp(hp   + (item.ng?.hp||-6)    + DROP_PENALTY.hp);
        evalv= clamp(evalv+ (item.ng?.eval||-2)  + DROP_PENALTY.eval);
        score= Math.max(0, score + (item.ng?.score||-6) + DROP_PENALTY.score);
        statDrop++;
        unread++; SE.unread(); updateHUD(); if(hp===0){ endGame(false); return; }
      }
    }
    cards = cards.filter(c=>c.el.isConnected);

    // スポーン（ボス時は稀に2連発）
    spawnTimer += dt;
    if(spawnTimer>spawnInterval){
      spawnTimer=0; spawnCard();
      if(bossActive && Math.random()<0.45){ setTimeout(spawnCard, 220); }
    }

    // タイムアップ
    if(elapsed>=TOTAL_MS){ endGame(true); return; }

    updateHUD();
    requestAnimationFrame(loop);
  }

  // ====== 起動＆操作
  titleStart.addEventListener('click', startGame);
  retryBtn.addEventListener('click', ()=>{ resultScreen.style.display='none'; startGame(); });
  backTitleBtn.addEventListener('click', ()=>{ resultScreen.style.display='none'; titleScreen.style.display='flex'; });
  muteBtn.addEventListener('click', ()=>{ muted=!muted; muteBtn.textContent = muted? '🔈 Unmute':'🔇 Mute'; });

  function startGame(){
    initAudio();
    if(!POOL.length){ showToast('メッセージが読み込めませんでした'); return; }
    // 画面
    titleScreen.style.display='none';
    resultScreen.style.display='none';
    // 状態初期化
    running=true; hp=80; evalv=10; unread=0; score=0; spawnInterval=1900; elapsed=0; lastDiffTick=0; bossActive=false; bossSeen=false; statOK=0; statNG=0; statDrop=0;
    // 既存カード削除
    for(const c of cards){ if(c.el?.isConnected) c.el.remove(); } cards=[];
    updateHUD(); showToast('勤務開始：3分耐えろ。2:30で👹鬼部長！');
  }

  // ====== SelfTests（コンソール）
  function runSelfTests(){
    console.group('[調達クエスト] SelfTests');
    console.assert(Array.isArray(POOL) && POOL.length>=30, 'POOL should have >=30 items');
    console.assert(POOL.every(it=>ALLOWED_TYPES.has(it.type)), 'every item has valid type');
    console.assert(POOL.every(it=>typeof it.text==='string' && it.text.length>0), 'every item has text');
    console.assert(typeof DROP_PENALTY.hp==='number' && typeof DROP_PENALTY.eval==='number' && typeof DROP_PENALTY.score==='number', 'drop penalty numbers');
    console.assert(TOTAL_MS===180000 && BOSS_MS===150000, 'timers set to 3:00 and 2:30');
    console.groupEnd();
  }
  runSelfTests();

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
