<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>èª¿é”ã‚¯ã‚¨ã‚¹ãƒˆ â€” ç†ä¸å°½ä¾é ¼ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ï¼ˆiPadç‰ˆ MVPï¼‰</title>
<meta name="theme-color" content="#4a6b4a" />
<style>
  :root{
    /* æ˜­å’Œã‚ªãƒ•ã‚£ã‚¹æ„Ÿï¼ˆã‚»ãƒ”ã‚¢Ã—ç·‘ï¼‰ */
    --paper:#f4f1e3;           /* èƒŒæ™¯ï¼šé»„ã°ã‚“ã ç´™ */
    --ink:#1f2a1f;             /* ãƒ†ã‚­ã‚¹ãƒˆæ¿ƒã„ç›® */
    --faint-ink:#3f4a3f;       
    --steel:#3b6b77;           /* ã‚¹ãƒãƒ¼ãƒ«å®¶å…·é’ç·‘ */
    --green:#6b8e23;           /* ç·‘é›»è©±è‰² */
    --lcd:#cfe7c3;             /* é›»å“æ¶²æ™¶ */
    --line:#d9d2be;            /* ç´™ã®ç½«ç·š */
    --alert:#b65c39;           /* èµ¤èŒ¶ã‚¤ãƒ³ã‚¯ */
    --ok:#2e7d32;              /* OKç·‘ */
    --bad:#8b2e1a;
    --boss:#6b2333;            /* é¬¼éƒ¨é•·ã‚«ãƒ©ãƒ¼ */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: "Yuji Syuku","Hiragino Maru Gothic ProN","Hiragino Kaku Gothic ProN","Kosugi Maru","Yu Gothic", system-ui, -apple-system, "Apple Color Emoji", "Segoe UI Emoji", cursive;
    background: repeating-linear-gradient(0deg,var(--paper),var(--paper) 28px,#f0ecd9 29px) fixed;
    color:var(--ink);
    -webkit-user-select:none; user-select:none;
    touch-action: pan-x pan-y;
  }
  .app{max-width:1024px; margin:0 auto; min-height:100%; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 12px 12px; gap:12px}
  header{
    position: sticky; top:0; z-index:50; background:linear-gradient(#f6f3e6aa,#f6f3e600);
    backdrop-filter: blur(2px);
    padding-top: env(safe-area-inset-top);
  }
  .hud{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; align-items:center}
  .gauge{background:var(--lcd); border:2px solid var(--line); border-radius:10px; padding:6px 10px; box-shadow: inset 0 1px 0 #ffffff80, 0 1px 0 #0000000f}
  .gauge label{font-size:12px; letter-spacing:.05em; color:var(--faint-ink)}
  .bar{height:10px; background:#0001; border-radius:6px; overflow:hidden; margin-top:4px}
  .bar>i{display:block; height:100%; width:50%; background:linear-gradient(90deg,var(--green),#7aa842)}
  .counter{font-variant-numeric: tabular-nums; font-weight:700}

  .lanes{position:relative; flex:1; min-height:360px; border:2px dashed var(--line); border-radius:14px; background:linear-gradient(#f7f4e6,#f2eedf); overflow:hidden}
  .lane-divider{position:absolute; left:50%; top:0; bottom:0; width:2px; background: repeating-linear-gradient(180deg, #cabfa3, #cabfa3 8px, transparent 8px, transparent 16px)}
  .note{position:absolute; left:8px; right:8px; top:8px; display:flex; gap:8px; align-items:center}
  .stamp{font-size:12px; color:var(--alert); border:2px solid var(--alert); border-radius:6px; padding:2px 6px; transform: rotate(-5deg); box-shadow: 0 0 0 2px #0000, inset 0 0 0 2px #0000}

  .card{position:absolute; width:min(92%, 520px); left:50%; transform:translateX(-50%);
        background:#fffef5; border:2px solid #d2c9ac; border-radius:12px; padding:10px 12px; 
        box-shadow: 0 6px 12px #00000014; 
        font-size:18px; line-height:1.4; letter-spacing:.02em;
        touch-action:none}
  .card .meta{display:flex; gap:8px; align-items:center; color:#6b6b5a; font-size:12px}
  .tag{display:inline-block; border:1px dashed #a89d7d; padding:0 6px; border-radius:999px; font-size:11px; color:#70684d; background:#fff9d9}
  .title{margin:6px 0 2px; font-weight:700}
  .body{font-size:16px}
  .ghost{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); opacity:.35; pointer-events:none; font-size:22px; color:#2d3b2d; text-align:center}

  .buckets{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:12px}
  .bucket{background:linear-gradient(#e6efde,#d9e8cd); border:2px solid #a9c39a; border-radius:14px; min-height:92px; padding:10px; display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; text-align:center; transition: transform .08s}
  .bucket i{font-size:20px}
  .bucket b{font-size:14px}
  .bucket[data-type="spec"]{background:linear-gradient(#efe9d7,#e5dcc4)}
  .bucket[data-type="price"]{background:linear-gradient(#e1eddc,#d3e5cd)}
  .bucket[data-type="delivery"]{background:linear-gradient(#e0ecf0,#d1e2e8)}
  .bucket[data-type="shikakari"]{background:linear-gradient(#eee4e2,#e4d6d3)}
  .bucket[data-type="idle"]{background:linear-gradient(#f3f3ef,#e6e6de)}
  .bucket.tap{transform: scale(0.98)}

  footer{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:700; background:var(--green); color:#fff; box-shadow:0 4px 0 #4b6518; transform: translateY(0); transition:.1s}
  .btn:active{transform: translateY(2px); box-shadow:0 2px 0 #4b6518}
  .muted{background:#879e85; box-shadow:0 4px 0 #6d826b}

  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#000a; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; opacity:0; pointer-events:none}
  .toast.show{animation:pop 1.5s ease}
  @keyframes pop{ 0%{opacity:0; transform:translateX(-50%) translateY(10px)} 12%{opacity:1; transform:translateX(-50%) translateY(0)} 80%{opacity:1} 100%{opacity:0} }

  /* ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒªã‚¶ãƒ«ãƒˆç”»é¢ */
  .overlay{position:fixed; inset:0; background:linear-gradient(#f6f2e4ee,#f4f1e3ee); display:flex; align-items:center; justify-content:center; z-index:100}
  .panel{max-width:760px; width:min(92%,760px); text-align:center; padding:28px 20px; border:3px double #b9b096; border-radius:18px; background:#fffdf5ee; box-shadow:0 8px 24px #0000001a}
  .logo{font-family:'Yuji Syuku',serif; font-size:48px; letter-spacing:.18em; color:#2b392b; text-shadow:0 2px 0 #ffffffaa, 0 3px 6px #0000001a; animation:gloom 4s ease-in-out infinite}
  .subtitle{margin-top:4px; color:#4d5a4d; letter-spacing:.2em}
  .start{margin-top:18px}
  .results h2{margin:0 0 8px; font-size:28px}
  .results .stat{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin:12px 0}
  .results .stat div{background:#f6f3e6; border:1px solid #d8cfb4; border-radius:10px; padding:10px 8px}
  .results .comment{margin-top:12px; color:#2b2b2b}
  @keyframes gloom{0%,100%{transform:translateY(0)} 50%{transform:translateY(1px)}}

  /* æ¨ªå‘ãã§2ãƒ¬ãƒ¼ãƒ³ */
  @media (orientation: landscape){
    .lanes{min-height:420px}
    .lane-divider{display:block}
  }
  @media (orientation: portrait){
    .lane-divider{display:none}
  }
</style>
</head>
<body>
<div class="overlay" id="titleScreen">
  <div class="panel">
    <div class="logo">èª¿é”ã‚¯ã‚¨ã‚¹ãƒˆ</div>
    <div class="subtitle">â€” æ‚²å“€ã¨ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®ç†ä¸å°½ä¾é ¼ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ â€”</div>
    <div class="start"><button class="btn" id="titleStart">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>
  </div>
</div>

<div class="overlay" id="resultScreen" style="display:none">
  <div class="panel results">
    <h2 id="resultTitle">å‹¤å‹™è©•ä¾¡</h2>
    <div class="stat">
      <div>â±ï¸ æ™‚é–“<br><b id="rTime">00:00</b></div>
      <div>ğŸ·ï¸ ã‚¹ã‚³ã‚¢<br><b id="rScore">0</b></div>
      <div>ğŸ“ˆ è©•ä¾¡<br><b id="rEval">0</b></div>
      <div>ğŸ§  å¿ƒ<br><b id="rHP">0</b></div>
    </div>
    <div class="stat">
      <div>âœ… æ­£ç­”<br><b id="rOK">0</b></div>
      <div>âŒ ãƒŸã‚¹<br><b id="rNG">0</b></div>
      <div>ğŸ•³ï¸ è½ä¸‹
        <br><b id="rDrop">0</b></div>
      <div>ğŸ‘¹ é¬¼éƒ¨é•·
        <br><b id="rBoss">â€”</b></div>
    </div>
    <div class="comment" id="rComment">è¬›è©•ãŒå…¥ã‚Šã¾ã™</div>
    <div class="start" style="display:flex; gap:8px; justify-content:center">
      <button class="btn" id="retryBtn">ğŸ” ã‚‚ã†ä¸€åº¦</button>
      <button class="btn" id="backTitleBtn">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
  </div>
</div>

<div class="app">
  <header>
    <div class="hud">
      <div class="gauge" id="hpBox"><label>ğŸ§  å¿ƒã®HP</label><div class="bar"><i id="hpBar" style="width:80%"></i></div></div>
      <div class="gauge" id="unreadBox"><label>ğŸ”” æœªèª­(Teams)</label><div class="counter" id="unread">0</div></div>
      <div class="gauge" id="evalBox"><label>ğŸ“ˆ è©•ä¾¡</label><div class="bar"><i id="evalBar" style="width:10%"></i></div></div>
      <div class="gauge" id="scoreBox"><label>ğŸ·ï¸ ã‚¹ã‚³ã‚¢</label><div class="counter" id="score">0</div></div>
      <div class="gauge"><label>â³ æ®‹ã‚Š</label><div class="counter" id="timeLeft">03:00</div></div>
    </div>
  </header>

  <div class="lanes" id="lanes">
    <div class="note">
      <span class="stamp">è‡³æ€¥å¤šã‚</span>
      <span class="stamp" style="transform:rotate(8deg)">ä»•æ§˜æœªå®šæ³¨æ„</span>
    </div>
    <div class="lane-divider"></div>
    <div class="ghost" id="ghost">ã‚¿ã‚¤ãƒ«ã‚’<strong>ã‚¿ãƒƒãƒ—</strong>ã§ä»•åˆ†ã‘ / é•·æŠ¼ã—ã§<strong>ãƒ‰ãƒ©ãƒƒã‚°â†’ã‚¿ã‚¤ãƒ«</strong>ã§ã‚‚OK</div>
  </div>

  <div class="buckets">
    <div class="bucket" data-type="spec"><i>ğŸ§©</i><b>ä»•æ§˜æœªå®šç³»</b></div>
    <div class="bucket" data-type="price"><i>ğŸ’¸</i><b>ä¾¡æ ¼ç„¡èŒ¶æŒ¯ã‚Šç³»</b></div>
    <div class="bucket" data-type="delivery"><i>â±ï¸</i><b>ç´æœŸåœ°ç„ç³»</b></div>
    <div class="bucket" data-type="shikakari"><i>ğŸ—‚ï¸</i><b>ä»•æ›ã‹ã‚Šæ¡ˆä»¶åœ°ç„ç³»</b></div>
    <div class="bucket" data-type="idle"><i>ğŸ«¥</i><b>æ”¾ç½®ã§è‰¯ã—ç³»</b></div>
  </div>

  <footer>
    <button class="btn muted" id="muteBtn">ğŸ”‡ Mute</button>
  </footer>
</div>
<div class="toast" id="toast">Level Up!!</div>

<script>
(function(){
  const lanes = document.getElementById('lanes');
  const ghost = document.getElementById('ghost');
  const hpBar = document.getElementById('hpBar');
  const evalBar = document.getElementById('evalBar');
  const unreadEl = document.getElementById('unread');
  const scoreEl = document.getElementById('score');
  const timeLeftEl = document.getElementById('timeLeft');
  const muteBtn = document.getElementById('muteBtn');
  const toast = document.getElementById('toast');
  const titleScreen = document.getElementById('titleScreen');
  const titleStart = document.getElementById('titleStart');
  const resultScreen = document.getElementById('resultScreen');
  const rTime = document.getElementById('rTime');
  const rScore = document.getElementById('rScore');
  const rEval = document.getElementById('rEval');
  const rHP = document.getElementById('rHP');
  const rOK = document.getElementById('rOK');
  const rNG = document.getElementById('rNG');
  const rDrop = document.getElementById('rDrop');
  const rBoss = document.getElementById('rBoss');
  const rComment = document.getElementById('rComment');
  const retryBtn = document.getElementById('retryBtn');
  const backTitleBtn = document.getElementById('backTitleBtn');

  // ======= ã‚²ãƒ¼ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const TOTAL_MS = 180000; // 3åˆ†
  const BOSS_MS  = 150000; // 2:30
  const DROP_PENALTY = {hp:-4, eval:-3, score:-8}; // æœªå‡¦ç†è¿½åŠ ãƒšãƒŠãƒ«ãƒ†ã‚£

  // çŠ¶æ…‹
  let hp=80, evalv=10, unread=0, score=0, running=false, muted=false;
  let spawnTimer=0, spawnInterval=1900; // msï¼ˆæ™‚é–“ã§çŸ­ç¸®ï¼‰
  let cards=[];
  let elapsed=0, lastDiffTick=0; // çµŒéæ™‚é–“
  let bossActive=false; let bossSeen=false;
  let statOK=0, statNG=0, statDrop=0;

  // ===== ãƒ—ãƒ¼ãƒ«å®‰å…¨æ§‹ç¯‰
  const ALLOWED_TYPES = new Set(['spec','price','delivery','shikakari','idle']);
  const userPool = [];
  const defaults = (()=>{
    const byTypeWeight = {
      spec:     { ok:{hp:+1, eval:+4, score:+12}, ng:{hp:-6, eval:-3, score:-7} },
      price:    { ok:{hp: 0, eval:+4, score:+11}, ng:{hp:-6, eval:-3, score:-7} },
      delivery: { ok:{hp: 0, eval:+4, score:+12}, ng:{hp:-8, eval:-3, score:-8} },
      shikakari:{ ok:{hp:+1, eval:+3, score:+10}, ng:{hp:-3, eval:-3, score:-6} },
      idle:     { ok:{hp:+2, eval:+1, score: +6}, ng:{hp:-1, eval:-1, score:-3} },
    };
    const make = (type, texts)=>texts.map(t=>({type, text:t, ...byTypeWeight[type]}));

    const specTexts = ['ä»•æ§˜ã¾ã ã€‚ä¾¡æ ¼ã ã‘å‡ºã—ã¦','ä»•æ§˜å¤‰ã‚ã‚‹ã‹ã‚‚ã€‚ç´æœŸã¯å‰å€’ã—ã§','è¦ä»¶æœªç¢ºå®šã€‚æ¦‚ç®—ã ã‘','å›³é¢ã¯å¾Œé€ã€‚ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã ã‘','è©³ç´°ã¯ç¾ç‰©åˆã‚ã›ã§ã€‚æ‰‹é…ã—ã¦','ç¤¾å†…æ‰¿èªå‰ã§ã™ãŒäºˆç´„ã ã‘','ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´æ¿ƒåšã€‚é‡‘é¡å½±éŸ¿ã ã‘','å‹å¼ã¯å¾Œã§ã€‚ã¾ãšã¯å¯å¦','å…ˆè¡Œæ‰‹é…ã§LTçŸ­ç¸®ã‚’','ç¤¾å¤–ç§˜ã§ä»•æ§˜å‡ºã›ã¾ã›ã‚“','é¡§å®¢ã®æ„å‘ã§ä»•æ§˜ç™½ç´™ã«æˆ»ã‚‹ã‹ã‚‚','ã‚»ã‚«ãƒ³ãƒ‰ã‚½ãƒ¼ã‚¹åŒ–ã®æ¤œè¨ã ã‘å…ˆã«','å‰å›è¸è¥²ã§ï¼ˆå‰å›ã¯ãƒˆãƒ©ãƒ–ãƒ«ï¼‰','è©¦ä½œå“ã§æ§˜å­è¦‹ã—ã¤ã¤é‡ç”£è¦‹ç©','â€œç¾ç‰©åˆã‚ã›â€ã§è¦‹ç©ã‚’'];

    const priceTexts = ['ä»Šå¹´äºˆç®—ã‚¼ãƒ­ã€‚å“è³ªã¯æ­»å®ˆã§','ãƒãƒƒãƒˆæœ€å®‰ã‚ã‚‹ã‚ˆï¼Ÿï¼ˆè¬ãƒ–ãƒ­ã‚°ï¼‰','å‰ä»»è€…ã¯ã‚‚ã£ã¨å®‰ã‹ã£ãŸ','å€¤å¼•ãï¼‹æ”¯æ‰•120æ—¥ã§','æŒ‡æ•°é€£å‹•ã‚„ã‚ã¦å›ºå®šå˜ä¾¡ã§','åˆè¦‹ç©10ç¤¾ï¼ˆä»Šæ—¥ä¸­ï¼‰','å˜ä¾¡30%ãƒ€ã‚¦ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—','ä¸Šé•·ã®ä¸€å£°ã§æ›´ã«5%å¼•ã','åˆå›èµ¤å­—ã§å°†æ¥å›åã—ã¦','æ”¯æ‰•ã‚µã‚¤ãƒˆ180æ—¥ã«å»¶é•·','ç¤¾é•·æ¡ˆä»¶ï¼šã¨ã‚Šã‚ãˆãšå®‰ã','ç‚ºæ›¿ã¯è‰¯ã„æ–¹å‘ã«æŒ¯ã‚Œã‚‹å‰æ','KPIã®ãŸã‚ä»Šæœˆã ã‘5%å¼•ã','å¹´é–“é‡æœªå®šã ãŒé‡ç”£ä¾¡æ ¼ã§','æ”¯æ‰•ã¯å³æ—¥ã§ï¼ˆå‰æ‰•å¸Œæœ›ï¼‰'];

    const deliveryTexts = ['æ˜æ—¥æ¬å…¥ã€‚ä»Šæ—¥ä¸­å›ç­”ã§','è©¦ä½œã‚’å‰å€’ã—ã€‚LTåŠåˆ†ã§','å°é¢¨ã§ã‚‚æ¬å…¥ã¯äºˆå®šé€šã‚Š','è¨­å‚™åœæ­¢ä¸­ã€‚è‡³æ€¥ã§æ‰‹é…','èˆ¹ä¾¿â†’ã‚¨ã‚¢ä¾¿ã«åˆ‡æ›¿ã§æ®ç½®','ç¨é–¢ãƒˆãƒ©ãƒ–ãƒ«ã ãŒç´æœŸå³å®ˆ','ä»–éƒ¨é–€ã®é…ã‚Œã¯èª¿é”ã§å¸å','æ®µå–ã‚Šæœªç¢ºå®šã ãŒç¾å ´ã¯å‹•ã','é‡‘æ›œ17:50â†’æ˜æœç´å…¥','æœˆæœ«æ£šå¸ã§ã‚‚æ¬å…¥ãã®ã¾ã¾','æ¸¯ãŒæ··é›‘ã€‚ã ãŒç´æœŸã¯æ­»å®ˆ','ä¿ç¨ã§ãªã‚“ã¨ã‹æ—©ã‚ã‚‰ã‚Œãªã„ï¼Ÿ'];

    const shikakariTexts = ['ä»•æ›ã‹ã‚Šã©ã“ã¾ã§ï¼Ÿï¼ˆæ‰¿èªè€…ä¸æ˜ï¼‰','ãƒ•ã‚©ãƒ¼ãƒ ãŒæœ€æ–°ã˜ã‚ƒãªã„ã®ã§å·®æˆ»ã—','å°ã®é †ç•ªãŒé•ã†ã®ã§ã‚„ã‚Šç›´ã—','æ‰¿èªè€…ãŒé•·æœŸå‡ºå¼µã§åœæ­¢ä¸­','é–¢é€£éƒ¨ç½²ã®å›è¦§ã‚’è¿½åŠ ã—ã¦å†æå‡º','PDFã®ä½™ç™½ãŒåºƒã„ã®ã§ä¿®æ­£','ç™ºæ³¨å‰ã«å¥‘ç´„ãƒ‰ãƒ©ãƒ•ãƒˆã‚‚æ·»ä»˜','ä»•æ›ã‹ã‚Šç•ªå·ã‚’å–ã‚Šç›´ã—','åŸä¾¡ç§‘ç›®ãŒé•ã†ã®ã§å·®æˆ»ã—','å–å¼•å…ˆåãŒå…¨è§’åŠè§’ä¸çµ±ä¸€','ç•ªå·ç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ ãŒãƒ¡ãƒ³ãƒ†ä¸­','é›»å­å¥‘ç´„ã®æ‰¿èªãƒ•ãƒ­ãƒ¼æœªæ•´å‚™','æœ€çµ‚æ‰¿èªè€…ãŒé€€è·ã—ã¦ã„ãŸ','å¥‘ç´„ãƒ‰ãƒ©ãƒ•ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆãŒé•ã†'];

    const idleTexts = ['å¿µã®ãŸã‚ä¾é ¼ã€‚æ€¥ãã˜ã‚ƒãªã„ï¼ˆèµ¤å­—ï¼‰','çŠ¶æ³å…±æœ‰ã ã‘ï¼ˆè¿”ä¿¡ä¸è¦ï¼‰','éå»ã®ä¾é ¼ã‚’å†æ²ï¼ˆå¯¾å¿œæ¸ˆï¼‰','å–å¼•ãªã—ãƒ™ãƒ³ãƒ€ã‹ã‚‰ã®å®£ä¼','CCã«å…¥ã£ã¦ã‚‹ã ã‘ã®ã‚¹ãƒ¬','èª¤é€ä¿¡ã§ã—ãŸã€‚å¤±ç¤¼ã—ã¾ã—ãŸ','ã¾ãŸå¾Œæ—¥ç›¸è«‡ã®å®£è¨€','ä¼šè­°ã®è­°äº‹éŒ²ï¼ˆå¾Œã§OKï¼‰','ä¸Šå¸ã®ã‚¬ã‚¹æŠœãï¼ˆç‹¬ã‚Šè¨€ï¼‰','é€±å ±ï¼ˆæ—¢èª­ã ã‘ã§OKï¼‰','FYI: æµ·å¤–å­ä¼šç¤¾ã®è¿‘æ³','ãƒ¡ãƒ‡ã‚£ã‚¢æ²è¼‰ã®å…±æœ‰ï¼ˆå¯¾å¿œä¸è¦ï¼‰','ã€Œé¢ç™½ã„è¨˜äº‹ã€å…±æœ‰ï¼ˆç„¡é–¢ä¿‚ï¼‰','é›‘è«‡ã‚¹ãƒ¬ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¨å¥¨)'];

    return [
      ...make('spec', specTexts),
      ...make('price', priceTexts),
      ...make('delivery', deliveryTexts),
      ...make('shikakari', shikakariTexts),
      ...make('idle', idleTexts),
    ];
  })();

  function isValidItem(it){
    return !!it && typeof it.text==='string' && it.text.trim().length>0 && ALLOWED_TYPES.has(it.type);
  }
  function withWeights(it){
    const typeDefaults = {
      spec:{ ok:{hp:+1, eval:+4, score:+12}, ng:{hp:-6, eval:-3, score:-7}},
      price:{ ok:{hp: 0, eval:+4, score:+11}, ng:{hp:-6, eval:-3, score:-7}},
      delivery:{ ok:{hp: 0, eval:+4, score:+12}, ng:{hp:-8, eval:-3, score:-8}},
      shikakari:{ ok:{hp:+1, eval:+3, score:+10}, ng:{hp:-3, eval:-3, score:-6}},
      idle:{ ok:{hp:+2, eval:+1, score: +6}, ng:{hp:-1, eval:-1, score:-3}},
    }[it.type];
    const ok = Object.assign({}, typeDefaults.ok, it.ok||{});
    const ng = Object.assign({}, typeDefaults.ng, it.ng||{});
    return {type:it.type, text:it.text, ok, ng};
  }
  function buildPool(){
    const a = Array.isArray(userPool)? userPool.filter(isValidItem).map(withWeights) : [];
    const base = defaults.filter(isValidItem).map(withWeights);
    const merged = (a.length? a : base);
    return merged;
  }

  const POOL = buildPool();

  // ======== WebAudio
  let actx, master;
  function initAudio(){ if(actx) return; actx = new (window.AudioContext||window.webkitAudioContext)(); master = actx.createGain(); master.gain.value = 0.4; master.connect(actx.destination); }
  function beep(freq=660, dur=0.06, type='sine', t0){ if(muted || !actx) return; const now=t0||actx.currentTime; const o=actx.createOscillator(); const g=actx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master); g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.6,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+dur); o.start(now); o.stop(now+dur+0.01); }
  const SE={ spawn(){const t=actx?.currentTime||0; beep(740,0.05,'triangle',t); beep(880,0.05,'sine',t+0.05);}, ok(){const t=actx?.currentTime||0; beep(660,0.04,'square',t); beep(990,0.05,'sine',t+0.06);}, miss(){const t=actx?.currentTime||0; beep(220,0.06,'sawtooth',t);}, unread(){const t=actx?.currentTime||0; beep(520,0.02,'triangle',t);}, lvl(){const t=actx?.currentTime||0; beep(523.25,0.06,'sine',t); beep(659.25,0.06,'sine',t+0.07); beep(783.99,0.09,'sine',t+0.14);}, dead(){const t=actx?.currentTime||0; beep(110,0.3,'sine',t);} };

  function showToast(msg){ toast.textContent=msg; toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show'); }
  function updateHUD(){ hpBar.style.width=Math.max(0,Math.min(100,hp))+'%'; evalBar.style.width=Math.max(0,Math.min(100,evalv))+'%'; unreadEl.textContent=unread; scoreEl.textContent=score; timeLeftEl.textContent = fmtTime(Math.max(0, TOTAL_MS - elapsed)); }
  function fmtTime(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${String(m).padStart(2,'0')}:${ss}`; }

  function spawnCard(){
    if(!POOL.length){ running=false; showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæœªè¨­å®šã§ã™ï¼ˆPOOLãŒç©ºï¼‰'); return; }
    const laneW = lanes.clientWidth;
    const isLandscape = matchMedia('(orientation: landscape)').matches;
    const col = isLandscape ? (Math.random()<0.5? 0.25:0.75) : 0.5;

    const idx = Math.floor(Math.random()*POOL.length);
    const item = POOL[idx];
    if(!item || !item.type){ return; }

    const card = document.createElement('div');
    card.className='card';
    card.style.top = '-140px';
    card.style.left = (laneW*col) + 'px';
    card.style.transform = 'translateX(-50%)';
    card.dataset.type = item.type;
    card.dataset.idx = String(idx);
    card.innerHTML = `
      <div class="meta"><span class="tag">#${labelFromType(item.type)}</span><span class="tag">è‡³æ€¥</span></div>
      <div class="title">[ä¾é ¼] ${headline(item.text)}</div>
      <div class="body">${item.text}</div>
    `;
    lanes.appendChild(card);
    makeDraggable(card);
    const speedBase = 60 + Math.random()*35;
    const speedUp = Math.min(1.6, 1 + elapsed/90000) * (bossActive? 1.35:1);
    cards.push({el:card, vy: speedBase*speedUp});
    unread++; SE.unread(); updateHUD();
    SE.spawn();
  }

  function headline(t){ return t.length>18 ? t.slice(0,18)+'â€¦' : t; }
  function labelFromType(t){ return ({spec:'ä»•æ§˜æœªå®š', price:'ä¾¡æ ¼ç„¡èŒ¶', delivery:'ç´æœŸåœ°ç„', shikakari:'ä»•æ›ã‹ã‚Š', idle:'æ”¾ç½®ã§è‰¯ã—'})[t] || t; }

  // ====== ã‚¿ã‚¤ãƒ«ã‚¿ãƒƒãƒ—ã§ä»•åˆ†ã‘
  const buckets = Array.from(document.querySelectorAll('.bucket'));
  buckets.forEach(b=>{ b.addEventListener('click', ()=>{ b.classList.add('tap'); setTimeout(()=>b.classList.remove('tap'),80); tryAssignByTap(b.dataset.type); }); });
  function getActiveCard(){ let best=null, bestTop=-Infinity; for(const c of cards){ if(!c.el.isConnected) continue; const t=parseFloat(c.el.style.top||'-140'); if(t>bestTop){bestTop=t; best=c;} } return best?.el || null; }
  function tryAssignByTap(assignType){ const card=getActiveCard(); if(!card){ showToast('å¯¾è±¡ãªã—'); return; } const correct=(assignType===card.dataset.type)||(assignType==='idle'&&card.dataset.type==='idle'); resolveCard(card, correct); }

  function resolveCard(card, correct){
    card.style.transition='transform .18s ease, opacity .18s';
    card.style.opacity=.0; card.style.transform='translateX(-50%) translateY(40px)';

    const item = POOL[Number(card.dataset.idx)] || {ok:{hp:0,eval:0,score:0}, ng:{hp:-6,eval:-3,score:-6}, type:'spec'};
    if(correct){
      hp   = clamp(hp   + (item.ok?.hp||0));
      evalv= clamp(evalv+ (item.ok?.eval||0));
      score= Math.max(0, score + (item.ok?.score||0));
      unread = Math.max(0, unread - 1);
      statOK++;
      SE.ok();
    } else {
      hp   = clamp(hp   + (item.ng?.hp||-8));
      evalv= clamp(evalv+ (item.ng?.eval||-3));
      score= Math.max(0, score + (item.ng?.score||-6));
      statNG++;
      SE.miss(); showToast('å…¨æ–¹ä½ã‹ã‚‰ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒé£›ã‚“ã§ããŸâ€¦'); if(hp===0){ endGame(false); return; }
    }
    updateHUD(); setTimeout(()=>{ card.remove(); }, 180);
  }

  // ====== é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°â†’ã‚¿ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—
  function makeDraggable(card){
    let startX=0,startY=0,x=0,y=0,dragging=false,longPressed=false,pressTimer; const LONG=220;
    function beginPress(){ clearTimeout(pressTimer); pressTimer=setTimeout(()=>{ longPressed=true; dragging=true; ghost.style.opacity=.35; }, LONG); }
    function endPress(){ clearTimeout(pressTimer); }
    card.addEventListener('pointerdown', e=>{ card.setPointerCapture(e.pointerId); startX=e.clientX; startY=e.clientY; x=0; y=0; longPressed=false; dragging=false; beginPress(); }, {passive:true});
    card.addEventListener('pointermove', e=>{ if(!dragging) return; x=e.clientX-startX; y=e.clientY-startY; card.style.transform=`translateX(calc(-50% + ${x}px)) translateY(${y}px) rotate(${x*0.02}deg)`; card.style.boxShadow='0 10px 18px #00000026'; }, {passive:true});
    card.addEventListener('pointerup', e=>{ endPress(); card.releasePointerCapture(e.pointerId); if(!dragging){ return; } dragging=false; const rect=card.getBoundingClientRect(); const cx=rect.left+rect.width/2; const cy=rect.top+rect.height/2; let dropType=null; for(const b of buckets){ const br=b.getBoundingClientRect(); if(cx>br.left&&cx<br.right&&cy>br.top&&cy<br.bottom){ dropType=b.dataset.type; break; } } if(dropType){ resolveCard(card, dropType===card.dataset.type || (dropType==='idle' && card.dataset.type==='idle')); } else { card.style.transition='transform .18s ease'; card.style.transform='translateX(-50%) translateY(0)'; setTimeout(()=>{card.style.transition='';},180);} x=y=0; }, {passive:true});
    card.addEventListener('pointercancel', ()=>{ endPress(); dragging=false; });
  }

  function clamp(v){ return Math.max(0, Math.min(100, v)); }

  function endGame(victory){
    running=false;
    // çµ±è¨ˆã®ç· ã‚
    rTime.textContent = fmtTime(elapsed);
    rScore.textContent= String(score);
    rEval.textContent = String(Math.round(evalv));
    rHP.textContent   = String(Math.round(hp));
    rOK.textContent   = String(statOK);
    rNG.textContent   = String(statNG);
    rDrop.textContent = String(statDrop);
    rBoss.textContent = bossSeen? 'æ’ƒé€€â€¦ã§ãã¦ã¯ã„ãªã„':'é­é‡å‰ã«çµ‚äº†';

    // è¬›è©•
    rComment.textContent = makeComment(victory, {score,evalv,hp,statOK,statNG,statDrop,bossSeen});
    document.getElementById('resultTitle').textContent = victory? 'å‹¤å‹™è©•ä¾¡ï¼šç”Ÿé‚„ï¼' : 'å‹¤å‹™è©•ä¾¡ï¼šéåŠ´æ­»å¯¸å‰â€¦';

    // ç”»é¢
    resultScreen.style.display='flex';
  }

  function makeComment(v, s){
    if(v && s.score>=400) return 'ä¼èª¬ã®èª¿é”å£«ã€‚ä¼ç¥¨ã®ç¥ã€å€‰åº«ã®å®ˆè­·è€…ã€‚æ¬¡ã®äººäº‹ã¯ã€Œèª²é•·ä»£ç†ï¼ˆå®Ÿè³ªä»£ç†ã®ä»£ç†ï¼‰ã€ã§ã™ã€‚';
    if(v && s.statDrop===0) return 'è½ä¸‹ã‚¼ãƒ­ã€‚ã‚ãªãŸã®æŒ‡å…ˆã¯æ‰¿èªãƒ•ãƒ­ãƒ¼ãã®ã‚‚ã®ã€‚æ¬¡å›ãƒœã‚¹ã‚‚ã‚¿ã‚¸ã‚¿ã‚¸ã€‚';
    if(!v && s.statDrop>10) return 'ä»•æ›ã‹ã‚Šæ¡ˆä»¶ã®å±±ã€ãã®åã‚‚ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆã€‚ãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒ³ãƒ—ã¯ç·å‹™éƒ¨ã«ã‚ã‚Šã¾ã™ã€‚';
    if(!v && s.hp<=0) return 'ç²¾ç¥å´©å£Šã‚¨ãƒ³ãƒ‰ã€‚è¦³è‘‰æ¤ç‰©ã ã‘ãŒæ˜‡é€²ã—ã¾ã—ãŸã€‚';
    if(s.bossSeen && v) return 'é¬¼éƒ¨é•·ã®æ€’å·ã‚’è¯éº—ã«ã‚¹ãƒ«ãƒ¼ã€‚ã“ã‚ŒãçœŸã®ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ã€‚';
    if(s.bossSeen && !v) return 'é¬¼éƒ¨é•·è¥²æ¥ã§ç‰©æµå´©å£Šã€‚æ¬¡ã¯è€³æ “ã¨æ ¹å›ã—ã‚’è£…å‚™ã—ã¾ã—ã‚‡ã†ã€‚';
    if(s.evalv>=80) return 'ç¤¾å†…è©•ä¾¡ã†ãªãç™»ã‚Šã€‚æ¬¡å›ã‹ã‚‰ä¼šè­°ã®æ¤…å­ãŒå›è»¢å¼ã«ãªã‚Šã¾ã™ã€‚';
    if(s.score<100) return 'ä»Šæ—¥ã®æˆæœï¼šè€ãˆãŸã€‚ä»¥ä¸Šã€‚æ˜æ—¥ã¯ã‚‚ã£ã¨è€ãˆã‚‹ã€‚';
    return 'åœ¨åº«ã‚‚å¿ƒã‚‚ã‚®ãƒªã‚®ãƒªåœ¨åº«å›è»¢ã€‚ã ãŒå›ã£ã¦ã„ã‚‹ã€ãã‚ŒãŒé‡è¦ã€‚';
  }

  // ====== ãƒ«ãƒ¼ãƒ—
  let last=0;
  function loop(ts){
    if(!running){ last=ts; requestAnimationFrame(loop); return; }
    const dt = ts-last; last=ts; elapsed += dt;

    // BOSSåˆ¤å®š
    if(!bossActive && elapsed>=BOSS_MS){ bossActive=true; bossSeen=true; spawnInterval=Math.max(450, spawnInterval-500); showToast('ğŸ‘¹ é¬¼éƒ¨é•·ãŒç¾ã‚ŒãŸï¼'); }

    // çµŒéæ™‚é–“ã§ã‚¹ãƒãƒ¼ãƒ³é–“éš”ã‚’çŸ­ç¸®ï¼ˆæœ€å¤§ã§ç´„450msã¾ã§ / ãƒœã‚¹æ™‚ã•ã‚‰ã«é€Ÿã„ï¼‰
    if(elapsed - lastDiffTick > 8000){ // 8ç§’ã”ã¨ã«å°‘ã—ã ã‘å¢—ä¾¿
      lastDiffTick = elapsed;
      const dec = bossActive? 120:80;
      spawnInterval = Math.max(bossActive? 450:700, spawnInterval - dec);
      SE.lvl();
    }

    // è½ä¸‹å‡¦ç†
    for(const c of cards){
      const el=c.el; if(!el.isConnected) continue;
      const top = parseFloat(el.style.top||'-140');
      const ny = top + (c.vy*dt/1000);
      el.style.top = ny + 'px';
      if(ny>lanes.clientHeight-20){ // åœ°é¢åˆ°é”ï¼æœªå‡¦ç†
        const item = POOL[Number(el.dataset.idx)] || {ng:{hp:-6,eval:-2,score:-6}};
        el.remove();
        // æœªå‡¦ç†ã¯NGï¼‹è¿½åŠ ãƒšãƒŠãƒ«ãƒ†ã‚£
        hp   = clamp(hp   + (item.ng?.hp||-6)    + DROP_PENALTY.hp);
        evalv= clamp(evalv+ (item.ng?.eval||-2)  + DROP_PENALTY.eval);
        score= Math.max(0, score + (item.ng?.score||-6) + DROP_PENALTY.score);
        statDrop++;
        unread++; SE.unread(); updateHUD(); if(hp===0){ endGame(false); return; }
      }
    }
    cards = cards.filter(c=>c.el.isConnected);

    // ã‚¹ãƒãƒ¼ãƒ³ï¼ˆãƒœã‚¹æ™‚ã¯ç¨€ã«2é€£ç™ºï¼‰
    spawnTimer += dt;
    if(spawnTimer>spawnInterval){
      spawnTimer=0; spawnCard();
      if(bossActive && Math.random()<0.45){ setTimeout(spawnCard, 220); }
    }

    // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—
    if(elapsed>=TOTAL_MS){ endGame(true); return; }

    updateHUD();
    requestAnimationFrame(loop);
  }

  // ====== èµ·å‹•ï¼†æ“ä½œ
  titleStart.addEventListener('click', startGame);
  retryBtn.addEventListener('click', ()=>{ resultScreen.style.display='none'; startGame(); });
  backTitleBtn.addEventListener('click', ()=>{ resultScreen.style.display='none'; titleScreen.style.display='flex'; });
  muteBtn.addEventListener('click', ()=>{ muted=!muted; muteBtn.textContent = muted? 'ğŸ”ˆ Unmute':'ğŸ”‡ Mute'; });

  function startGame(){
    initAudio();
    if(!POOL.length){ showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ'); return; }
    // ç”»é¢
    titleScreen.style.display='none';
    resultScreen.style.display='none';
    // çŠ¶æ…‹åˆæœŸåŒ–
    running=true; hp=80; evalv=10; unread=0; score=0; spawnInterval=1900; elapsed=0; lastDiffTick=0; bossActive=false; bossSeen=false; statOK=0; statNG=0; statDrop=0;
    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰å‰Šé™¤
    for(const c of cards){ if(c.el?.isConnected) c.el.remove(); } cards=[];
    updateHUD(); showToast('å‹¤å‹™é–‹å§‹ï¼š3åˆ†è€ãˆã‚ã€‚2:30ã§ğŸ‘¹é¬¼éƒ¨é•·ï¼');
  }

  // ====== SelfTestsï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰
  function runSelfTests(){
    console.group('[èª¿é”ã‚¯ã‚¨ã‚¹ãƒˆ] SelfTests');
    console.assert(Array.isArray(POOL) && POOL.length>=30, 'POOL should have >=30 items');
    console.assert(POOL.every(it=>ALLOWED_TYPES.has(it.type)), 'every item has valid type');
    console.assert(POOL.every(it=>typeof it.text==='string' && it.text.length>0), 'every item has text');
    console.assert(typeof DROP_PENALTY.hp==='number' && typeof DROP_PENALTY.eval==='number' && typeof DROP_PENALTY.score==='number', 'drop penalty numbers');
    console.assert(TOTAL_MS===180000 && BOSS_MS===150000, 'timers set to 3:00 and 2:30');
    console.groupEnd();
  }
  runSelfTests();

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
