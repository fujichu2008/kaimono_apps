<!DOCTYPE html>
<html lang="ja">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>AppStudioMobile v2</title>

   <!-- (OFFLINE) External editor libraries removed: CodeMirror/CDN disabled -->

   <style>
       :root {
           --bg-color: #1e1e1e;
           --surface-color: #252526;
           --accent-color: #007acc;
           --text-color: #d4d4d4;
           --border-color: #3e3e42;
           --success-color: #4caf50;
           --danger-color: #f44336;
                                   --warning-color: #ff9800;
            --mode-full: #1976d2;
            --mode-auto: #e91e63;
            --mode-manual: #f57c00;
            --tab-height: 50px;
        }

       * {
           box-sizing: border-box;
           margin: 0;
           padding: 0;
           -webkit-tap-highlight-color: transparent;
       }

       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           background-color: var(--bg-color);
           color: var(--text-color);
           height: 100vh;
           display: flex;
           flex-direction: column;
           overflow: hidden;
       }

       /* --- Tabs (Top Navigation) --- */
       .tabs {
           display: flex;
           height: var(--tab-height);
           background-color: var(--surface-color);
           border-bottom: 1px solid var(--border-color);
           z-index: 100;
           box-shadow: 0 2px 5px rgba(0,0,0,0.2);
           flex-shrink: 0;
       }

       .tab-btn {
           flex: 1;
           background: none;
           border: none;
           color: #888;
           font-weight: 600;
           font-size: 14px;
           cursor: pointer;
           transition: color 0.2s, background 0.2s;
           border-bottom: 3px solid transparent;
       }

               .tab-btn.active {
            color: var(--text-color);
            border-bottom-color: var(--accent-color);
            background-color: rgba(255,255,255,0.05);
        }

        /* Functionality Mode Colors */
        .modal-tab-btn.type-full.active { color: var(--mode-full); border-bottom-color: var(--mode-full); }
        .modal-tab-btn.type-manual.active { color: var(--mode-manual); border-bottom-color: var(--mode-manual); }
        .modal-tab-btn.type-auto.active { color: var(--mode-auto); border-bottom-color: var(--mode-auto); }

        .btn-mode-full { background: var(--mode-full) !important; color: white !important; }
        .btn-mode-auto { background: var(--mode-auto) !important; color: white !important; }
        .btn-mode-manual { background: var(--mode-manual) !important; color: white !important; }

       /* --- Main Views --- */
       .view {
           display: none;
           flex: 1;
           min-height: 0;
           overflow: hidden;
           position: relative;
       }

       .view.active {
           display: flex;
           flex-direction: column;
       }

       /* --- Help Styles --- */
       .help-container {
           background: var(--bg-color);
           color: var(--text-color);
           padding: 20px;
           font-family: "Segoe UI", sans-serif;
       }
       .help-header {
           text-align: center;
           margin-bottom: 20px;
           border-bottom: 2px solid var(--accent-color);
           padding-bottom: 10px;
       }
       .help-header h1 {
           font-size: 24px;
           color: var(--accent-color);
           margin: 0;
       }
       .help-section {
           margin-bottom: 25px;
           background: var(--surface-color);
           border-radius: 8px;
           padding: 15px;
           box-shadow: 0 4px 6px rgba(0,0,0,0.3);
       }
       .help-section h2 {
           font-size: 18px;
           color: var(--success-color);
           margin-bottom: 10px;
           display: flex;
           align-items: center;
           gap: 8px;
       }
       .help-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
           gap: 10px;
       }
       .help-card {
           background: rgba(255,255,255,0.05);
           padding: 10px;
           border-radius: 6px;
           text-align: center;
           border: 1px solid var(--border-color);
       }
       .help-card-icon { font-size: 24px; margin-bottom: 5px; display: block; }
       .help-card-title { font-weight: bold; font-size: 13px; color: var(--accent-color); }
       .help-card-desc { font-size: 11px; color: #aaa; margin-top: 4px; line-height: 1.4; }

       .step-list { list-style: none; padding: 0; }
       .step-item {
           display: flex;
           gap: 10px;
           margin-bottom: 12px;
           align-items: flex-start;
       }
       .step-num {
           background: var(--accent-color);
           color: white;
           width: 24px;
           height: 24px;
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-weight: bold;
           font-size: 12px;
           flex-shrink: 0;
       }
       .step-text { font-size: 13px; line-height: 1.5; }

       /* --- Editor Styles (Plain textarea) --- */
       .editor-container {
           flex: 1;
           position: relative;
           display: flex;
           flex-direction: column;
           overflow: hidden;
           min-height: 0;
       }

               #code-editor {
            flex: 1;
            width: 100%;
            background-color: var(--bg-color);
            color: #d4d4d4;
            border: none;
            padding: 15px;
            padding-top: 35px;
            padding-left: 55px; /* è¡Œç•ªå·ã®åˆ†ã‚’ç©ºã‘ã‚‹ */
            font-family: "Menlo", "Consolas", "Monaco", monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            white-space: pre;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        #line-numbers {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 45px;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            color: #666;
            font-family: "Menlo", "Consolas", "Monaco", monospace;
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            padding: 15px 5px 15px 0;
            padding-top: 35px;
            overflow: hidden;
            z-index: 5;
            user-select: none;
            pointer-events: none;
        }

        /* Findbar openæ™‚ã®è¡Œç•ªå·ä½ç½®èª¿æ•´ */
        .editor-container.findbar-open #line-numbers {
            padding-top: 92px;
        }
        @media (max-width: 700px){
            .editor-container.findbar-open #line-numbers { padding-top: 104px; }
        }

                               #code-stats {
           position: absolute;
           top: 5px;
           right: 240px;
           font-size: 11px;
           color: #aaa;
           background: rgba(30, 30, 30, 0.85);
           padding: 4px 8px;
           border-radius: 4px;
           pointer-events: none;
           z-index: 20;
           border: 1px solid var(--border-color);
           backdrop-filter: blur(2px);
       }


       .copy-float-btn {
           position: absolute;
           top: 5px;
           right: 10px;
           background-color: rgba(255, 255, 255, 0.1);
           color: var(--text-color);
           border: 1px solid var(--border-color);
           border-radius: 4px;
           padding: 4px 8px;
           font-size: 11px;
           cursor: pointer;
           z-index: 10;
       }
       .copy-float-btn:active {
           background-color: var(--accent-color);
       }

                               /* --- Find button moved under Copy (floating) --- */
       .find-float-btn {
           position: absolute;
           top: 38px;
           right: 10px;
           background-color: rgba(255, 255, 255, 0.1);
           color: var(--text-color);
           border: 1px solid var(--border-color);
           border-radius: 4px;
           padding: 4px 8px;
           font-size: 11px;
           cursor: pointer;
           z-index: 10;
       }
       .find-float-btn:active {
           background-color: var(--accent-color);
       }


       /* --- Paste button moved next to Copy (floating) --- */
       .paste-float-btn {
           position: absolute;
           top: 5px;
           right: 78px;
           background-color: rgba(255, 255, 255, 0.1);
           color: var(--text-color);
           border: 1px solid var(--border-color);
           border-radius: 4px;
           padding: 4px 8px;
           font-size: 11px;
           cursor: pointer;
           z-index: 10;
       }
       .paste-float-btn:active {
           background-color: var(--accent-color);
       }



       /* --- Find / Replace Bar (Editor inline) --- */
       .findbar{
           position:absolute;
           top:5px; left:10px; right:160px;
           display:none;
           background:rgba(30,30,30,0.92);
           border:1px solid var(--border-color);
           border-radius:8px;
           padding:6px;
           z-index:15;
       }
       .editor-container.findbar-open .findbar{ display:flex; flex-direction:column; gap:4px; }
       .editor-container.findbar-open #code-editor{ padding-top:92px; }
       .find-row{ display:flex; gap:6px; align-items:center; }
       .find-row input{ flex:1; min-width:0; height:28px; padding:0 8px; background:rgba(0,0,0,0.35); border:1px solid #555; color:#ddd; border-radius:6px; font-size:12px; }
       .find-btn{ height:28px; padding:0 8px; border-radius:6px; border:1px solid #555; background:rgba(255,255,255,0.06); color:#ddd; cursor:pointer; font-size:12px; white-space:nowrap; }
       .find-btn.close{ border-color: var(--danger-color); color: var(--danger-color); background: transparent; font-weight:bold; }
       .find-count{ font-size:11px; color:#aaa; padding:0 6px; border:1px solid #444; border-radius:6px; height:28px; display:flex; align-items:center; background:rgba(0,0,0,0.25); }
       .find-opt{ font-size:11px; color:#bbb; display:flex; align-items:center; gap:4px; padding:0 6px; border:1px solid #444; border-radius:6px; height:28px; background:rgba(0,0,0,0.18); cursor:pointer; user-select:none; }
       .find-opt input{ width:auto; margin:0; }
       @media (max-width: 700px){ .findbar{ right:10px; } .editor-container.findbar-open #code-editor{ padding-top:104px; } }

       .toolbar {
           height: 50px;
           background-color: var(--surface-color);
           border-bottom: 1px solid var(--border-color);
           display: flex;
           align-items: center;
           padding: 0 10px;
           gap: 5px;
           flex-shrink: 0;
       }

       .file-bar {
           height: 45px;
           background-color: var(--bg-color);
           border-bottom: 1px solid var(--border-color);
           display: flex;
           align-items: center;
           padding: 0 10px;
           gap: 10px;
           flex-shrink: 0;
       }

       .app-name-display {
           flex: 1;
           color: #aaa;
           font-size: 12px;
           font-weight: bold;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
           padding-left: 5px;
       }

       .tool-btn {
           background-color: #333;
           color: var(--text-color);
           border: 1px solid var(--border-color);
           border-radius: 6px;
           padding: 6px 10px;
           font-size: 11px;
           cursor: pointer;
           display: flex;
           align-items: center;
           justify-content: center;
           min-width: 60px;
           height: 32px;
       }

       .tool-btn span {
           font-size: 11px;
           white-space: nowrap;
       }

       .spacer { flex: 1; }

       .tool-btn:active {
           background-color: #444;
           transform: scale(0.98);
       }

       .tool-btn.primary {
           background-color: var(--accent-color);
           border-color: var(--accent-color);
           color: white;
       }

       .tool-btn.danger {
           color: var(--danger-color);
           border-color: var(--danger-color);
           background: transparent;
       }

       .tool-btn.warning {
           color: var(--warning-color);
           border-color: var(--warning-color);
       }

       /* Tabs inside Modal */
       .modal-tabs {
           display: flex;
           margin-bottom: 15px;
           border-bottom: 1px solid var(--border-color);
       }
       .modal-tab-btn {
           flex: 1;
           padding: 10px;
           background: none;
           border: none;
           color: #888;
           cursor: pointer;
           border-bottom: 2px solid transparent;
       }
       .modal-tab-btn.active {
           color: var(--accent-color);
           border-bottom-color: var(--accent-color);
       }
       .tab-content { display: none; }
       .tab-content.active { display: block; }

       /* --- Run View Styles --- */
       #app-frame, #app-frame-full {
           flex: 1;
           width: 100%;
           border: none;
           background-color: white;
       }

       .run-controls {
           height: 50px;
           background-color: var(--surface-color);
           display: flex;
           align-items: center;
           justify-content: flex-end;
           padding: 0 15px;
           border-bottom: 1px solid var(--border-color);
           gap: 8px;
       }

       /* --- Library Styles --- */
       .library-list {
           flex: 1;
           overflow-y: auto;
           padding: 15px;
       }

       .lib-item {
           background-color: var(--surface-color);
           border: 1px solid var(--border-color);
           border-radius: 8px;
           padding: 12px;
           margin-bottom: 10px;
           display: flex;
           flex-direction: column;
           gap: 6px;
       }
       .lib-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           width: 100%;
       }
       .lib-title {
           font-size: 16px;
           font-weight: bold;
           color: var(--accent-color);
           flex: 1;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
           margin-right: 8px;
       }
       .lib-actions {
           display: flex;
           flex-shrink: 0;
           gap: 4px;
       }
       .lib-meta {
           font-size: 11px;
           color: #888;
           width: 100%;
       }
       .lib-history {
           margin-top: 4px;
           padding: 6px 8px;
           background: rgba(0, 122, 204, 0.1);
           border-radius: 4px;
           font-size: 11px;
           color: #aaa;
           /* è¤‡æ•°è¡Œè¡¨ç¤ºã«å¯¾å¿œ */
           white-space: pre-wrap;
           word-break: break-all;
           line-height: 1.4;
           max-height: 4.5em; /* 3è¡Œç¨‹åº¦ã¾ã§è¡¨ç¤º */
           overflow: hidden;
           display: -webkit-box;
           -webkit-line-clamp: 3;
           -webkit-box-orient: vertical;
           cursor: pointer;
           width: 100%;
           border: 1px solid transparent;
           transition: all 0.2s;
       }
       .lib-history:hover {
           background: rgba(0, 122, 204, 0.2);
           color: white;
           border-color: rgba(0, 122, 204, 0.4);
       }

       .lib-actions button {
           padding: 6px 10px;
           border-radius: 4px;
           border: none;
           cursor: pointer;
           font-size: 12px;
       }
       .btn-load { background-color: var(--accent-color); color: white; }
       .btn-del { background-color: var(--danger-color); border: 1px solid var(--danger-color); color: white; font-weight: bold; font-size: 16px; }

       /* --- Modal --- */
       .modal-overlay {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(0,0,0,0.7);
           z-index: 200;
           justify-content: center;
           align-items: center;
       }
       .modal {
           background: var(--surface-color);
           width: 90%;
           max-height: 85vh;
           border-radius: 12px;
           padding: 20px;
           border: 1px solid var(--border-color);
           box-shadow: 0 10px 25px rgba(0,0,0,0.5);
           overflow-y: auto;
       }
       .modal h2 { margin-bottom: 15px; font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 10px; }
       .modal h3 { margin: 15px 0 10px 0; font-size: 14px; color: var(--accent-color); }

              .modal input:not([type="checkbox"]), .modal textarea {
           width: 100%;
           padding: 10px;
           margin-bottom: 10px;
           background: var(--bg-color);
           border: 1px solid var(--border-color);
           color: white;
           border-radius: 4px;
           font-family: monospace;
           font-size: 12px;
       }
       .modal textarea {
           min-height: 80px;
           resize: vertical;
       }

       .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
       .modal-buttons button {
           flex: 1;
           padding: 10px;
           border-radius: 6px;
           border: none;
           font-weight: bold;
           font-size: 12px;
           cursor: pointer;
       }
       .btn-cancel { background: #444; color: white; }
       .btn-confirm { background: var(--accent-color); color: white; }
       .btn-action { background: #333; border: 1px solid #555; color: #ddd; }

       /* Notification */
       #notification {
           position: fixed;
           bottom: 80px;
           left: 50%;
           transform: translateX(-50%);
           background: rgba(40, 40, 40, 0.95);
           color: white;
           padding: 12px 24px;
           border-radius: 30px;
           font-size: 16px;
           font-weight: bold;
           box-shadow: 0 4px 12px rgba(0,0,0,0.4);
           opacity: 0;
           transition: opacity 0.3s;
           pointer-events: none;
           z-index: 300;
           white-space: nowrap;
       }

       .section-desc {
           font-size: 11px;
           color: #888;
           margin-bottom: 5px;
       }

       /* --- Split Layout (Editor Left / Viewer Right) --- */
       .split-container {
           flex: 1;
           display: flex;
           min-height: 0;
           overflow: hidden;
       }
       .pane {
           flex: 1;
           min-width: 0;
           display: flex;
           flex-direction: column;
           min-height: 0;
       }
       .editor-pane {
           background: var(--bg-color);
           border-right: 1px solid var(--border-color);
       }
       .viewer-pane {
           background: #fff;
       }
       body.editor-hidden .editor-pane {
           display: none;
       }
       body.editor-hidden .viewer-pane {
           flex: 1;
           width: 100%;
       }

       /* --- Project Sidebar (PC) --- */
       .editor-pane-inner {
           flex: 1;
           display: flex;
           min-height: 0;
       }
       .project-sidebar {
           width: 260px;
           background: rgba(0,0,0,0.12);
           border-right: 1px solid var(--border-color);
           display: flex;
           flex-direction: column;
           min-height: 0;
       }
       .project-sidebar.hidden {
           display: none;
       }
       .project-sidebar-header {
           display: flex;
           align-items: center;
           gap: 8px;
           padding: 10px;
           border-bottom: 1px solid var(--border-color);
           background: rgba(255,255,255,0.03);
       }
       .project-title {
           flex: 1;
           font-size: 11px;
           color: #aaa;
           font-weight: bold;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .project-btn {
           background: transparent;
           border: 1px solid #555;
           color: #ccc;
           border-radius: 6px;
           width: 28px;
           height: 28px;
           cursor: pointer;
       }
       .project-btn:active {
           transform: scale(0.98);
       }
       .project-list {
           flex: 1;
           overflow: auto;
           padding: 10px;
           display: flex;
           flex-direction: column;
           gap: 8px;
       }
       .project-tile {
           background: var(--surface-color);
           border: 1px solid var(--border-color);
           border-radius: 8px;
           padding: 10px;
           cursor: pointer;
       }
       .project-tile:hover {
           border-color: var(--accent-color);
       }
       .project-tile-title {
           font-size: 12px;
           color: var(--accent-color);
           font-weight: 700;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .project-tile-meta {
           margin-top: 4px;
           font-size: 10px;
           color: #888;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }

       /* --- Start Modal --- */
       .start-grid {
           display: grid;
           grid-template-columns: repeat(2, 1fr);
           gap: 12px;
           margin-top: 10px;
       }
       .start-card {
           background: rgba(255,255,255,0.04);
           border: 1px solid var(--border-color);
           border-radius: 10px;
           padding: 14px;
           cursor: pointer;
           text-align: left;
       }
       .start-card:hover {
           border-color: var(--accent-color);
           background: rgba(0,122,204,0.08);
       }
       .start-card h3 {
           margin: 0 0 6px 0;
           font-size: 14px;
           color: #fff;
       }
       .start-card p {
           margin: 0;
           font-size: 11px;
           color: #aaa;
           line-height: 1.5;
       }
       @media (max-width: 700px) {
           .start-grid { grid-template-columns: 1fr; }
           .project-sidebar { width: 220px; }
       }


       /* Scrollbar */
       ::-webkit-scrollbar {
           width: 12px;
           height: 12px;
           display: block;
           background: transparent;
       }
       ::-webkit-scrollbar-track {
           background: rgba(0,0,0,0.1);
       }
       ::-webkit-scrollbar-thumb {
           background-color: rgba(255,255,255,0.3);
           border-radius: 6px;
           border: 2px solid var(--bg-color);
       }
               ::-webkit-scrollbar-corner {
           background: transparent;
       }

       /* --- PC Optimization for Modals (AIæŒ‡ç¤º / ä¿®æ­£) --- */
       .prompt-grid, .fix-grid, .manual-grid {
           display: block;
       }
       .prompt-right, .fix-right {
           margin-top: 15px;
       }
       .side-note {
           font-size: 12px;
           color: #aaa;
           line-height: 1.6;
           background: rgba(255,255,255,0.04);
           border: 1px solid var(--border-color);
           border-radius: 8px;
           padding: 12px;
       }
       .side-note code {
           color: #ddd;
       }

       @media (min-width: 900px) {
           /* modal ìì²´ã‚’PCå¹…ã«æœ€é©åŒ– */
           .modal {
               width: 78%;
               max-width: 1100px;
               padding: 24px;
           }
           #prompt-modal .modal,
           #fix-modal .modal {
               max-width: 1200px;
           }

           /* AIæŒ‡ç¤º: å·¦(å…¥åŠ›) / å³(å‡ºåŠ›ãƒœã‚¿ãƒ³+èª¬æ˜) */
           .prompt-grid {
               display: grid;
               grid-template-columns: 1.35fr 1fr;
               gap: 18px;
               align-items: start;
           }
           .prompt-right {
               margin-top: 0;
           }
                       #ai-instruction {
               height: 260px !important;
           }


           /* ä¿®æ­£: å·¦(JSON/å…¥åŠ›) / å³(ãƒ’ãƒ³ãƒˆ) */
           .fix-grid {
               display: grid;
               grid-template-columns: 1.2fr 0.8fr;
               gap: 18px;
               align-items: start;
           }
           .fix-right {
               margin-top: 0;
               position: sticky;
               top: 10px;
           }
           #json-input {
               height: 380px !important;
           }

                       /* æ‰‹å‹•ä¿®æ­£: find/replace ã‚’ç¸¦ä¸¦ã³ */
           .manual-grid {
               display: flex;
               flex-direction: column;
               gap: 12px;
           }
           #manual-find,
           #manual-replace {
               height: 180px !important;
           }

       }
   </style>
</head>
<body>

       <!-- Tabs removed: PC/toolbar-centric UI -->

   <section id="view-editor" class="view active">
                       <div class="toolbar">
                        <div style="font-weight:bold; color:#ffffff; font-size:20px; margin-right:12px; user-select:none; letter-spacing:1px;">AppStudio</div>
            <button class="tool-btn" onclick="openStartModal()" title="é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ" style="border:none; background:transparent; color:white;">
                <span>ğŸš€ é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹</span>
            </button>
                       <button id="sidebar-toggle-btn" class="tool-btn" onclick="toggleProjectSidebar()" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ãƒ‰ãƒãƒ¼ è¡¨ç¤º/éè¡¨ç¤º" style="min-width: 90px; display:none;">
                <span>ğŸ“ ã‚µã‚¤ãƒ‰ãƒãƒ¼</span>
            </button>

           <!-- â˜… è¿½åŠ ï¼šå®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆAIæŒ‡ç¤ºã®å·¦ï¼‰ -->
                                  
                        <button class="tool-btn" onclick="runCode()" title="ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ" style="min-width: 80px; background-color: #2e7d32; border-color: #2e7d32; color: white;">
                <span>â–¶ å®Ÿè¡Œ</span>
            </button>
                        <button class="tool-btn" onclick="runInNewWindow()" title="åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Ÿè¡Œ">
                <span>â†— åˆ¥çª“</span>
            </button>

            <div style="width:1px; height:24px; background:#555; margin:0 2px;"></div>

                        <button class="tool-btn" onclick="openPromptModal()" style="background-color: #9c27b0; border-color: #9c27b0; color: white;">
                <span>ğŸ¤– AIæŒ‡ç¤º</span>
            </button>

                                                                                                                               <button class="tool-btn" onclick="openFixModal()" style="background-color: #cc7a00; border-color: #cc7a00; color: white;">
                <span>ğŸ› ï¸ ã‚¢ãƒ—ãƒªã‚’æ›´æ–°</span>
            </button>

            <div style="width:1px; height:24px; background:#555; margin:0 2px;"></div>

                                                <button class="tool-btn" onclick="openConsultModal()" style="background-color: #4caf50; border-color: #4caf50; color: white;">
                <span>ğŸ§ AIã«ç›¸è«‡</span>
            </button>

            <div style="width:1px; height:24px; background:#555; margin:0 2px;"></div>

                        <button class="tool-btn" onclick="openSaveModal()" style="background-color: #007acc; border-color: #007acc; color: white;">
                <span>ğŸ’¾ ä¿å­˜</span>
            </button>

           <div class="spacer"></div>
                       <button class="tool-btn" onclick="openHelpModal()" style="margin-right: 5px; border-color: #666;" title="ãƒ˜ãƒ«ãƒ—">
                <span>â“ ãƒ˜ãƒ«ãƒ—</span>
            </button>
            <button class="tool-btn" onclick="openSettingsModal()" style="margin-right: 5px; border-color: #666;" title="è¨­å®š">
               <span>âš™ï¸ è¨­å®š</span>
           </button>
       </div>

                               <div class="file-bar">
            <button class="tool-btn" onclick="toggleEditor()" id="toggle-editor-btn" style="height:32px; margin-right:5px; border-color:#555;">
                <span>â¬…ï¸ ã‚¨ãƒ‡ã‚£ã‚¿éš ã™</span>
            </button>
            <div id="app-name-display" class="app-name-display">(æ–°è¦ä½œæˆä¸­)</div>
            <button class="tool-btn" onclick="undo()" title="å…ƒã«æˆ»ã™" style="min-width: 32px; height:32px; padding:0 8px; margin-left:5px;">
                <span>â†©ï¸</span>
            </button>
            <button class="tool-btn" onclick="redo()" title="ã‚„ã‚Šç›´ã—" style="min-width: 32px; height:32px; padding:0 8px; margin-left:5px;">
                <span>â†ªï¸</span>
            </button>
        </div>

       <!-- Split: Left editor / Right viewer -->
               <div class="split-container" id="main-split">
           <div class="pane editor-pane" id="editor-pane">
               <div class="editor-pane-inner">
                                       <aside id="project-sidebar" class="project-sidebar hidden">
                       <div class="project-sidebar-header">
                           <div id="project-title" class="project-title">(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ)</div>
                           <!-- Ã— ã¯ã€Œã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹ã€(éè¡¨ç¤º) ã«å¤‰æ›´ã€‚â ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’é–‰ã˜ã‚‹ã€‚ -->
                           <button class="project-btn" onclick="toggleProjectSidebar(false)" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹">Ã—</button>
                           <button class="project-btn" onclick="closeProject()" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‰ã˜ã‚‹" style="border-color: var(--danger-color); color: var(--danger-color);">â</button>
                       </div>
                       <div id="project-list" class="project-list"></div>
                   </aside>


                                       <div class="editor-container">
                       <div id="findbar" class="findbar" aria-label="æ¤œç´¢ã¨ç½®æ›">
                           <div class="find-row">
                               <input id="find-input" type="text" placeholder="æ¤œç´¢" autocomplete="off" />
                               <button class="find-btn" onclick="findPrev()" title="å‰ã¸">â†‘</button>
                               <button class="find-btn" onclick="findNext()" title="æ¬¡ã¸">â†“</button>
                               <span id="find-count" class="find-count">0/0</span>
                               <label class="find-opt" title="å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥">
                                   <input id="find-case" type="checkbox" />Aa
                               </label>
                           </div>
                           <div class="find-row">
                               <input id="replace-input" type="text" placeholder="ç½®æ›" autocomplete="off" />
                               <button class="find-btn" onclick="replaceOne()" title="ç¾åœ¨ã®ä¸€è‡´ã‚’ç½®æ›">ç½®æ›</button>
                               <button class="find-btn" onclick="replaceAll()" title="ã™ã¹ã¦ç½®æ›">å…¨ç½®æ›</button>
                               <button class="find-btn close" onclick="toggleFindBar(false)" title="é–‰ã˜ã‚‹">âœ•</button>
                           </div>
                       </div>
                                                                                               <div id="code-stats">0è¡Œ / 0æ–‡å­—</div>
                                               <button class="paste-float-btn" onclick="pasteCode()">ğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆ</button>
                                               <button class="copy-float-btn" onclick="copyFullCode()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                        <button class="find-float-btn" onclick="openFindWindow()">ğŸ” æ¤œç´¢</button>

                        <div id="line-numbers"></div>
                        <textarea id="code-editor" placeholder="ã“ã“ã«HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." spellcheck="false"></textarea>

                   </div>
               </div>
           </div>


                       <div class="pane viewer-pane" id="viewer-pane">
                <iframe id="app-frame" sandbox="allow-scripts allow-forms allow-popups allow-modals allow-same-origin"></iframe>
            </div>
       </div>
   </section>

   <section id="view-run" class="view">
       <div class="run-controls">
           <button class="tool-btn" onclick="runInNewWindow()">
               <span>â†— åˆ¥çª“ã§å®Ÿè¡Œ</span>
           </button>
           <button class="tool-btn primary" onclick="reloadFrame()" style="margin-left: 10px;">
               <span>â†» ãƒªãƒ­ãƒ¼ãƒ‰</span>
           </button>
       </div>
       <iframe id="app-frame-full" sandbox="allow-scripts allow-forms allow-popups allow-modals allow-same-origin"></iframe>
   </section>

           <!-- Start Menu (Library removed) -->
   <div id="start-modal" class="modal-overlay">
       <div class="modal">
           <h2>é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹</h2>
           <p class="section-desc">PCåˆ©ç”¨å‰æã€‚ä½œæ¥­ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

           <h3>å˜ç™ºã‚¢ãƒ—ãƒª</h3>
           <div class="start-grid">
               <div class="start-card" onclick="startSingleNew()">
                   <h3>ğŸ†• å˜ç™ºHTMLã‚¢ãƒ—ãƒªã‚’æ–°è¦ä½œæˆ</h3>
                   <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãªã—ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã¾ã£ã•ã‚‰ã«æˆ»ã—ã¦ä½œã‚Šå§‹ã‚ã‚‹ã€‚</p>
               </div>
               <div class="start-card" onclick="startSingleOpen()">
                   <h3>ğŸ“‚ HTMLã‚¢ãƒ—ãƒªã‚’é–‹ã</h3>
                   <p>ãƒ­ãƒ¼ã‚«ãƒ«ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã€ã‚³ãƒ¼ãƒ‰æ¬„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ç·¨é›†ã€‚</p>
               </div>
           </div>

           <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3>
           <div class="start-grid">
               <div class="start-card" onclick="startProjectNew()">
                   <h3>ğŸ†• æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                   <p>è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ–°è¦ä½œæˆã€‚ä¿å­˜ã¯é †æ¬¡ãã®ãƒ•ã‚©ãƒ«ãƒ€ã¸ã€‚</p>
               </div>
               <div class="start-card" onclick="startProjectOpen()">
                   <h3>ğŸ“ æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã</h3>
                   <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã€‚å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«HTMLã‚’æ–°ã—ã„é †ã§è¡¨ç¤ºã—èª­è¾¼ã€‚</p>
               </div>
           </div>

           

           <div class="modal-buttons" style="margin-top:20px;">
               <button class="btn-cancel" onclick="closeModal('start-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>

   <input id="single-open-input" type="file" accept=".html,text/html" style="display:none;" />


   <div id="save-modal" class="modal-overlay">
       <div class="modal">
           <h2>ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
           <input type="text" id="filename-input" placeholder="ã‚¢ãƒ—ãƒªåã‚’å…¥åŠ› (ä¾‹: MyGame)">
                       <div class="modal-buttons">
               <button class="btn-confirm" id="save-main-btn" onclick="saveCurrent()">ä¿å­˜</button>
               <button class="btn-confirm" style="background: #4caf50;" onclick="downloadHTML()">HTML DL</button>
               <button class="btn-confirm" style="background: #333;" onclick="uploadToGitHub()">GitHub Repo</button>
           </div>
           <div class="modal-buttons" style="margin-top:10px;">
               <button class="btn-cancel" onclick="closeModal('save-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
           </div>
       </div>
   </div>

   <div id="consult-modal" class="modal-overlay">
       <div class="modal">
           <h2>AIç›¸è«‡ (ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ”¹å–„)</h2>
           <p class="section-desc">AIã«ç›¸è«‡ã—ãŸã„å†…å®¹ã‚’é¸æŠãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

           <div style="display: grid; grid-template-columns: 1fr; gap: 5px; margin-bottom: 15px;">
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="width: auto; margin: 0;"> ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
               </label>
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="ãƒã‚°ç‰¹å®š" style="width: auto; margin: 0;"> ãƒã‚°ç‰¹å®š
               </label>
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°" style="width: auto; margin: 0;"> ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
               </label>
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨ºæ–­" style="width: auto; margin: 0;"> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
               </label>
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„" style="width: auto; margin: 0;"> ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„
               </label>
               <label style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #444;">
                   <input type="checkbox" name="consult-cat" value="æ¡ç‚¹(100ç‚¹æº€ç‚¹)" style="width: auto; margin: 0;"> æ¡ç‚¹(100ç‚¹æº€ç‚¹)
               </label>
           </div>

           <textarea id="consult-text" placeholder="å…·ä½“çš„ãªç›¸è«‡å†…å®¹ (ä¾‹: ã€‡ã€‡ã®æ©Ÿèƒ½ãŒå‹•ã‹ãªã„ã€ã‚‚ã£ã¨ã‚³ãƒ¼ãƒ‰ã‚’åŠ¹ç‡åŒ–ã—ãŸã„ã€XXãªæ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„ç­‰)..." style="height:100px;"></textarea>

           <div class="modal-buttons">
               <button class="btn-confirm" onclick="copyConsultPrompt()">ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ & ã‚³ãƒ”ãƒ¼</button>
           </div>
           <div class="modal-buttons" style="margin-top:20px;">
               <button class="btn-cancel" onclick="closeModal('consult-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>

               <div id="prompt-modal" class="modal-overlay">
               <div class="modal">
           <h2>AIæŒ‡ç¤º (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ)</h2>

           <!-- Tabs moved: directly under title -->
                       
            <div class="modal-tabs" style="margin: 10px 0 15px 0;">
                <button class="modal-tab-btn type-full active" onclick="switchPromptTab('full')">â‘  ã¾ã‚‹ã”ã¨æ›´æ–°</button>
                <button class="modal-tab-btn type-manual" onclick="switchPromptTab('manual')">â‘¡ æ‰‹å‹•ä¿®æ­£</button>
                <button class="modal-tab-btn type-auto" onclick="switchPromptTab('auto')">â‘¢ ã‚ªãƒ¼ãƒˆä¿®æ­£</button>
            </div>

                                               <div id="prompt-tab-full" class="tab-content active">
                <p class="section-desc" style="color:var(--mode-full); font-weight:bold;">ãƒ¢ãƒ¼ãƒ‰: ã¾ã‚‹ã”ã¨æ›´æ–° (ä¿®æ­£å¾Œã®å®Œå…¨ãªãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›)</p>
            </div>
            <div id="prompt-tab-manual" class="tab-content">
                <p class="section-desc" style="color:var(--mode-manual); font-weight:bold;">ãƒ¢ãƒ¼ãƒ‰: æ‰‹å‹•ä¿®æ­£ (Before/Afterå½¢å¼)</p>
            </div>
            <div id="prompt-tab-auto" class="tab-content">
                <p class="section-desc" style="color:var(--mode-auto); font-weight:bold;">ãƒ¢ãƒ¼ãƒ‰: ã‚ªãƒ¼ãƒˆä¿®æ­£ (JSONå½¢å¼)</p>
            </div>

            <div class="side-note" style="margin-bottom:10px;">
                <div style="font-weight:bold; color:#ddd; margin-bottom:6px;">ä½¿ã„åˆ†ã‘</div>
                ãƒ»â‘  ã¾ã‚‹ã”ã¨æ›´æ–°: ãã®ã¾ã¾å‹•ãå®Œå…¨ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ãªå ´åˆ<br>
                ãƒ»â‘¡ æ‰‹å‹•ä¿®æ­£: Before/Afterã§éƒ¨åˆ†ä¿®æ­£ã—ãŸã„å ´åˆ<br>
                ãƒ»â‘¢ ã‚ªãƒ¼ãƒˆä¿®æ­£: JSONã§ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆç½®æ›ï¼ˆä¿®æ­£ãƒ„ãƒ¼ãƒ«å‘ã‘ï¼‰<br>
                                <div style="margin-top:8px; color:#999;">
                    â€» ç½®æ›å¯¾è±¡ã¯<code>ä¸€æ„ã«ç‰¹å®šã§ãã‚‹é•·ã•</code>ã§æŒ‡å®š
                </div>
            </div>

            
            <div style="margin-bottom: 12px;">
                <button type="button" onclick="toggleRecipes()" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:13px; display:flex; align-items:center; gap:5px; padding:0;">
                    <span id="recipe-toggle-icon" style="transition: transform 0.2s;">â–¶</span> ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢ã«å›°ã£ãŸã‚‰ï¼Ÿï¼ˆãŠè©¦ã—ãƒ¬ã‚·ãƒ”ï¼‰
                </button>
                <div id="recipe-container" style="display:none; margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; border:1px solid var(--border-color);">
                    <p class="section-desc" style="margin-bottom:8px;">ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨é«˜å“è³ªãªæŒ‡ç¤ºãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="tool-btn" onclick="applyRecipe('minutes')">ğŸ™ï¸ è‡ªå‹•è­°äº‹éŒ²</button>
                        <button class="tool-btn" onclick="applyRecipe('toeic')">ğŸ“š TOEICå˜èª</button>
                        <button class="tool-btn" onclick="applyRecipe('kanban')">ğŸ“‹ ã‚«ãƒ³ãƒãƒ³</button>
                        <button class="tool-btn" onclick="applyRecipe('md')">ğŸ“ Markdown</button>
                    </div>
                </div>
            </div>

            <div style="position: relative;">
                <textarea id="ai-instruction" placeholder="å…·ä½“çš„ãªæŒ‡ç¤ºã‚’å…¥åŠ› (ä¾‹: ãƒœã‚¿ãƒ³ã®è‰²ã‚’èµ¤ã«ã—ã¦...)" style="height:160px;"></textarea>
                <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 4px;">
                    <button id="mic-btn" onclick="toggleSpeechRecognition()" style="display:none; background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; border-radius: 4px; padding: 2px 6px; font-size: 14px; cursor: pointer; min-width: 28px; transition: all 0.2s;">ğŸ¤</button>
                    <button onclick="document.getElementById('ai-instruction').value = ''" style="background: rgba(0,0,0,0.6); color: #ccc; border: 1px solid #555; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">âœ•</button>
                </div>
            </div>

                        <div class="modal-buttons" style="margin-top:15px;">
                <button id="btn-copy-prompt" class="btn-action btn-mode-full" onclick="copyCurrentPrompt()" style="border: none;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ & ã‚³ãƒ”ãƒ¼</button>
                <button class="btn-cancel" onclick="closeModal('prompt-modal')">é–‰ã˜ã‚‹</button>
            </div>
       </div>
   </div>


               <div id="fix-modal" class="modal-overlay">
        <div class="modal">
            <h2>ä¿®æ­£ãƒ„ãƒ¼ãƒ«</h2>
            <div class="modal-tabs">
                <button class="modal-tab-btn type-full active" data-tab="full" onclick="switchFixTab('full')">â‘  ã¾ã‚‹ã”ã¨æ›´æ–°</button>
                <button class="modal-tab-btn type-manual" data-tab="manual" onclick="switchFixTab('manual')">â‘¡ æ‰‹å‹•ä¿®æ­£</button>
                <button class="modal-tab-btn type-auto" data-tab="auto" onclick="switchFixTab('auto')">â‘¢ ã‚ªãƒ¼ãƒˆ(JSON)</button>
            </div>

           <!-- â‘  Full Update -->
           <div id="tab-full" class="tab-content active">
               <p class="section-desc">AIãŒå‡ºåŠ›ã—ãŸã€Œå®Œæˆç‰ˆã®ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã€ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ã€ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆã¾ã™ã€‚</p>
               <div style="display:flex; gap:5px; margin-bottom:5px; justify-content:flex-end;">
                   <button class="btn-action" onclick="pasteToFullInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none;">ğŸ“‹ è²¼ä»˜</button>
                   <button class="btn-action" onclick="clearFullInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none; color: var(--danger-color); border-color: var(--danger-color);">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
               </div>
                               <textarea id="full-code-input" placeholder="ã“ã“ã«ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰(HTML)ã‚’è²¼ã‚Šä»˜ã‘" style="height:260px;"></textarea>
                <div class="modal-buttons">
                    <button class="btn-confirm btn-mode-full" onclick="applyFullUpdate()">ã“ã®å†…å®¹ã§ä¸¸ã”ã¨æ›´æ–°</button>
                </div>
               <div class="side-note" style="margin-top:10px;">
                   <div style="font-weight:bold; color:#ddd; margin-bottom:6px;">æ³¨æ„</div>
                   ãƒ»é©ç”¨ã™ã‚‹ã¨ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ãŒå…¨ã¦ç½®ãæ›ã‚ã‚Šã¾ã™ï¼ˆå…ƒã«æˆ»ã™ã¯Undoã§å¯èƒ½ãªç¯„å›²ï¼‰<br>
                   ãƒ»JSONã§ã¯ãªãã€å®Œæˆã‚³ãƒ¼ãƒ‰ãã®ã‚‚ã®ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ç”¨é€”
               </div>
           </div>

           <!-- â‘¢ Auto(JSON) -->
           <div id="tab-auto" class="tab-content">
                               <div class="fix-grid">
                   <div class="fix-left" style="grid-column: 1 / -1;">
                       <p class="section-desc">AIãŒç”Ÿæˆã—ãŸJSONã‚’è²¼ã‚Šä»˜ã‘ã¦é©ç”¨ã—ã¾ã™ã€‚ï¼ˆsearch/replace ã¾ãŸã¯ before/after ã«å¯¾å¿œï¼‰</p>

                       <div style="display: flex; gap: 5px; margin-bottom: 5px; justify-content: flex-end;">
                           <button class="btn-action" onclick="pasteToJsonInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none;">ğŸ“‹ è²¼ä»˜</button>
                           <button class="btn-action" onclick="clearJsonInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none; color: var(--danger-color); border-color: var(--danger-color);">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
                       </div>
                                               <textarea id="json-input" placeholder='[{"search":"...", "replace":"..."}]' style="height:120px;"></textarea>

                       <!-- Live preview: hit count / guidance -->
                       <div id="auto-preview" style="margin-top:8px; padding:10px; border-radius:8px; border:1px solid #444; background:rgba(0,0,0,0.25); color:#aaa; font-size:12px; line-height:1.5;">
                           JSONã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è‡´ä»¶æ•°ã‚’è¡¨ç¤º
                       </div>
                       <div id="auto-preview-actions" style="display:none; gap:8px; margin-top:8px; justify-content:flex-end;" class="modal-buttons">
                           <button class="btn-action" onclick="switchFixTab('full')" style="flex:none; width:auto;">â‘  ã¾ã‚‹ã”ã¨æ›´æ–°ã¸</button>
                           <button class="btn-action" onclick="switchFixTab('manual')" style="flex:none; width:auto;">â‘¡ æ‰‹å‹•ä¿®æ­£ã¸</button>
                       </div>

                                               <div class="modal-buttons">
                            <button class="btn-confirm btn-mode-auto" onclick="applyAutoFix()">JSONé©ç”¨</button>
                        </div>

                   </div>



               </div>
           </div>

           <!-- â‘¡ Manual -->
                       
                        <div id="tab-manual" class="tab-content">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                    <p class="section-desc" style="margin:0;">æ¤œç´¢ã—ã¦ç½®æ›ã—ã¾ã™ã€‚</p>
                    <button class="btn-action" onclick="clearManualInput()" style="padding: 2px 8px; font-size: 10px; width: auto; flex: none; color: var(--danger-color); border-color: var(--danger-color);">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="manual-grid">
                    <textarea id="manual-find" placeholder="æ¤œç´¢ (ä¿®æ­£å‰)" style="height:60px;"></textarea>
                    <div id="manual-match-status" style="display:none; font-size:12px; padding:8px; border-radius:4px; margin-bottom:5px;"></div>
                    <textarea id="manual-replace" placeholder="ç½®æ› (ä¿®æ­£å¾Œ)" style="height:60px;"></textarea>
                </div>
                <div style="margin-top:8px; display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.05); padding:6px; border-radius:4px;">
                    <input type="checkbox" id="manual-fuzzy" checked style="width:auto; margin:0;">
                    <label for="manual-fuzzy" style="font-size:11px; color:#ccc; user-select:none; cursor:pointer; flex:1;">
                        ã‚†ã‚‰ãè¨±å®¹ (æ”¹è¡Œ/ç©ºç™½/ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£/```ç­‰ã‚’ç„¡è¦–)
                    </label>
                </div>
                                <div class="modal-buttons">
                    <button class="btn-confirm btn-mode-manual" onclick="applyManualFix()">æ‰‹å‹•ç½®æ›</button>
                </div>
            </div>

           <div class="modal-buttons" style="margin-top:20px;">
               <button class="btn-cancel" onclick="closeModal('fix-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>


   <div id="history-modal" class="modal-overlay">
       <div class="modal">
           <h2>æ›´æ–°å±¥æ­´</h2>
           <div id="history-content" style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: #ddd; max-height: 60vh; overflow-y: auto;"></div>
           <div class="modal-buttons" style="margin-top:20px;">
               <button class="btn-cancel" onclick="closeModal('history-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>

       <!-- Help moved to modal (Tabs removed) -->
   <div id="help-modal" class="modal-overlay">
       <div class="modal">
           <h2>ãƒ˜ãƒ«ãƒ—</h2>
           <div class="help-container" style="max-width: 900px; margin: 0 auto; padding: 10px 0 0 0;">
                               <div class="help-header">
                    <h1>AppStudio</h1>
                    <p style="font-size: 12px; color: #888;">AIå…±å‰µå‹ãƒ»Webã‚¢ãƒ—ãƒªé–‹ç™ºç’°å¢ƒ</p>
                </div>

                                <div class="help-section">
                    <h2>AppStudioã£ã¦ä½•ï¼Ÿ</h2>
                    <h3 style="border:none; color:var(--text-color); font-size:15px; margin:10px 0;">â‘  äººé–“ã¨AIã®ã€Œæ©‹æ¸¡ã—ã€å½¹</h3>
                    <p style="font-size: 13px; line-height: 1.6;">
                        ã“ã®ã‚¢ãƒ—ãƒªè‡ªä½“ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è€ƒãˆã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                        ã€Œã‚ãªãŸã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€ã‚’ã€ŒAIã¸ã®æœ€é©ãªæŒ‡ç¤ºã€ã«ç¿»è¨³ã—ã€AIãŒä½œã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ã€Œå‹•ãã‚¢ãƒ—ãƒªã€ã«çµ„ã¿ç«‹ã¦ã‚‹å·¥å ´ã§ã™ã€‚
                    </p>
                    
                <div style="margin:20px 0; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; overflow-x:auto;">
                        <div style="display:flex; flex-direction:row; align-items:center; justify-content:space-between; gap:10px; font-size:12px; min-width:550px; text-align:center;">
                            <div style="flex:1;">
                                <div style="font-size:22px; margin-bottom:4px;">ğŸ§‘</div>
                                <div style="font-weight:bold;">äººé–“</div>
                                <div style="font-size:10px; color:#888;">ã€Œä½œã‚ŠãŸã„ï¼ã€</div>
                            </div>
                            <div style="color:var(--accent-color); font-size:18px;">â¡</div>
                            <div style="flex:1;">
                                <div style="font-size:22px; margin-bottom:4px;">ğŸ­</div>
                                <div style="font-weight:bold; color:var(--accent-color);">AppStudio</div>
                                <div style="font-size:10px; color:#888;">æŒ‡ç¤ºã¸å¤‰æ›</div>
                            </div>
                            <div style="color:var(--accent-color); font-size:18px;">â¡</div>
                            <div style="flex:1;">
                                <div style="font-size:22px; margin-bottom:4px;">ğŸ¤–</div>
                                <div style="font-weight:bold;">AI</div>
                                <div style="font-size:10px; color:#888;">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</div>
                            </div>
                            <div style="color:var(--accent-color); font-size:18px;">â¡</div>
                            <div style="flex:1;">
                                <div style="font-size:22px; margin-bottom:4px;">â–¶ï¸</div>
                                <div style="font-weight:bold; color:var(--success-color);">AppStudio</div>
                                <div style="font-size:10px; color:#888;">å®Ÿè¡Œãƒ»ç¢ºèª</div>
                            </div>
                            <div style="color:var(--accent-color); font-size:18px;">â¡</div>
                            <div style="flex:1;">
                                <div style="font-size:22px; margin-bottom:4px;">ğŸ”„</div>
                                <div style="font-weight:bold;">äººé–“</div>
                                <div style="font-size:10px; color:#888;">ä¿®æ­£æŒ‡ç¤º</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h2>ã‚³ãƒ¼ãƒ‰ä½œæˆãƒ»æ€è€ƒãƒ»ç›¸è«‡</h2>
                    
                    <h3 style="border:none; color:var(--text-color); font-size:15px; margin:15px 0 5px 0;">æœ€å¤§ã®æ­¦å™¨ï¼šè‡ªå‹•ä¿®æ­£ (Auto Patch)</h3>
                    <p style="font-size: 13px; line-height: 1.6;">
                        AppStudioã¯ã€ã‚¢ãƒ—ãƒªé–‹ç™ºã§æœ€ã‚‚é›£ã—ã„ã€Œä¿®æ­£ãƒ»æ”¹é€ ã€ã®å£ã‚’å–ã‚Šæ‰•ã„ã¾ã™ã€‚<br>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã‚’AIã«ä¼ã‚ã‚‹æŒ‡ç¤ºã«å¤‰æ›ã—ã€è¿”ã£ã¦ããŸè¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚’è‡ªå‹•ã§ä¸€æ‹¬é©ç”¨ã™ã‚‹ã“ã¨ã§ã€åˆå¿ƒè€…ã§ã‚‚ãƒ—ãƒ­å‘ã‘ãƒ„ãƒ¼ãƒ«ï¼ˆCursorãªã©ï¼‰åŒç­‰ã®é«˜åº¦ãªé–‹ç™ºä½“é¨“ã‚’å¯èƒ½ã«ã—ã¾ã—ãŸã€‚
                    </p>

                    <h3 style="border:none; color:var(--text-color); font-size:15px; margin:20px 0 5px 0;">AIã¸ã®ç›¸è«‡ã‚‚ã‚µãƒãƒ¼ãƒˆ</h3>
                    <p style="font-size: 13px; line-height: 1.6;">
                        ã€Œæ¬¡ã¯ä½•ã‚’ä½œã‚Œã°ã„ã„ï¼Ÿã€ã¨ã„ã£ãŸç›¸è«‡ã‚‚ã€AIãŒç­”ãˆã‚„ã™ã„å½¢ã«æ•´ãˆã¦è³ªå•ã§ãã¾ã™ã€‚<br>
                        ä¾‹ãˆã°ã€ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚’å®¢è¦³çš„ã«è©•ä¾¡ã—ã€100ç‚¹æº€ç‚¹ã§ç‚¹æ•°ã‚’ã¤ã‘ã€ã•ã‚‰ã«æ”¹å–„ææ¡ˆã‚’AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µãƒ³ãƒ—ãƒ«ä»˜ãã§ãŠé¡˜ã„ã™ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚‚ã€ã“ã®ã‚¢ãƒ—ãƒªãªã‚‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã™ã‚‹ã ã‘ã§å®Ÿç¾ã§ãã¾ã™ã€‚
                    </p>
                </div>

               <div class="help-section">
                   <h2>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨åˆ¶ç´„</h2>
                   <p style="font-size: 12px; color: #ccc; line-height: 1.6;">
                       ãƒ»<strong>å¤–éƒ¨é€šä¿¡ç¦æ­¢</strong>: CDN/å¤–éƒ¨API/fetchç­‰ã®å¤–éƒ¨é€šä¿¡ã¯ç¦æ­¢ã€‚<br>
                       ãƒ»<strong>å¤–éƒ¨é€ä¿¡ç¦æ­¢</strong>: å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®POST/GETç­‰ã¯ç¦æ­¢ã€‚<br>
                       ãƒ»<strong>ãƒ‡ãƒ¼ã‚¿ä¿å­˜</strong>: IndexedDB/localStorageç­‰ãƒ–ãƒ©ã‚¦ã‚¶å†…å®Œçµã€‚
                   </p>
               </div>
           </div>

           <div class="modal-buttons" style="margin-top:20px;">
               <button class="btn-cancel" onclick="closeModal('help-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>

       <div id="settings-modal" class="modal-overlay">
       <div class="modal">
           <h2>è¨­å®š</h2>

           <h3>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
           <div style="background:rgba(255,0,0,0.1); border:1px solid #500; padding:10px; border-radius:6px; margin-bottom:15px;">
               <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;">
                   <input type="checkbox" id="sec-no-send" onchange="updateAppSettings()">
                   <span>å¤–éƒ¨ã‚µã‚¤ãƒˆã¸ã®æƒ…å ±é€ä¿¡å³ç¦ (é€ä¿¡ãƒ–ãƒ­ãƒƒã‚¯)</span>
               </label>
               <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                   <input type="checkbox" id="sec-no-recv" onchange="updateAppSettings()">
                   <span>å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã®æƒ…å ±å–å¾—å³ç¦ (CDN/Fetchç­‰ãƒ–ãƒ­ãƒƒã‚¯)</span>
               </label>
               <div style="margin-top:8px; font-size:11px; color:#aaa; line-height:1.4;">
                   â€» ã“ã‚ŒãŒONã®å ´åˆã€AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã€Œå¤–éƒ¨é€šä¿¡å³ç¦ã€ã‚’çµ¶å¯¾éµå®ˆäº‹é …ã¨ã—ã¦è‡ªå‹•æŒ¿å…¥ã—ã¾ã™ã€‚
               </div>
           </div>

           <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å…ˆ</h3>
           <p class="section-desc">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ç”¨ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã—ã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ä¿å­˜ï¼‰ã€‚</p>

           <div class="side-note">
               <div id="project-root-name" style="font-weight:bold; color:#ddd; margin-bottom:8px;">æœªè¨­å®š</div>
               ãƒ»ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã€ï¼šã“ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰é¸æŠã‚’é–‹å§‹<br>
               ãƒ»ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã€ï¼šã“ã®ç›´ä¸‹ã«å…¥åŠ›åã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
           </div>

           <div class="modal-buttons" style="margin-top:12px;">
               <button class="btn-confirm" onclick="pickProjectRootFolder()">ğŸ“ è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
               <button class="btn-action" onclick="clearProjectRootFolder()">ğŸ§¹ è§£é™¤</button>
           </div>

           <div class="modal-buttons" style="margin-top:12px;">
               <button class="btn-cancel" onclick="closeModal('settings-modal')">é–‰ã˜ã‚‹</button>
           </div>
       </div>
   </div>

   <div id="notification">Message</div>

   <script>
       // --- State & Elements ---
       const textarea = document.getElementById('code-editor');

       // (OFFLINE) Plain textarea-based editor wrapper
       const editor = {
           getValue: () => textarea.value,
           setValue: (v) => { textarea.value = v; updateStats(); },
           lineCount: () => {
               const v = textarea.value;
               if (v.length === 0) return 0;
               return v.split('\n').length;
           },
           undo: () => { textarea.focus(); try { document.execCommand('undo'); } catch(e) {} },
           redo: () => { textarea.focus(); try { document.execCommand('redo'); } catch(e) {} },
           refresh: () => {}
       };

       const stats = document.getElementById('code-stats');
       const frame = document.getElementById('app-frame');
       const frameFull = document.getElementById('app-frame-full');
       const filenameInput = document.getElementById('filename-input');
       const appNameDisplay = document.getElementById('app-name-display');
               const projectSidebar = document.getElementById('project-sidebar');
       const projectList = document.getElementById('project-list');
       const projectTitle = document.getElementById('project-title');
               const notification = document.getElementById('notification');

       // --- Find/Replace Elements (NO external) ---
       const editorContainerEl = document.querySelector('.editor-container');
       const findBar = document.getElementById('findbar');
       const findInput = document.getElementById('find-input');
       const replaceInput = document.getElementById('replace-input');
       const findCountEl = document.getElementById('find-count');
       const findCaseEl = document.getElementById('find-case');

       let findPositions = [];
       let currentFindIndex = -1;
       let findDebounceTimer = null;

       let pendingAiInstruction = "";
       let currentAppName = "";

       // --- App Settings (Security) ---
       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ON
       let appSettings = { secNoSend: true, secNoRecv: true };
       try {
           const savedSettings = localStorage.getItem('appstudio_settings_json');
           if (savedSettings) appSettings = { ...appSettings, ...JSON.parse(savedSettings) };
       } catch (e) {}

       // --- Dev Mode State ---
               let devMode = "single"; // "single" | "project"
               let projectDirHandle = null;
       let projectFolderName = "";
       let currentProjectFileName = "";

       // --- Settings: Project root folder (IndexedDB, NO external) ---
       let projectRootHandle = null;
       let projectRootName = "";

       // --- Project AI Instruction History (localStorage / NO external) ---
       function getProjectHistoryKey() {
           // ãƒ•ã‚©ãƒ«ãƒ€åå˜ä½ã§å±¥æ­´ã‚’åˆ†é›¢ï¼ˆå¤–éƒ¨é€ä¿¡ãªã—ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ã¿ï¼‰
           return `appstudio_project_ai_history::${projectFolderName || "__no_project__"}`;
       }
       function loadProjectAiHistory() {
           try {
               const raw = localStorage.getItem(getProjectHistoryKey());
               const obj = raw ? JSON.parse(raw) : {};
               return (obj && typeof obj === 'object') ? obj : {};
           } catch (e) {
               return {};
           }
       }
       function saveProjectAiHistory(obj) {
           try {
               localStorage.setItem(getProjectHistoryKey(), JSON.stringify(obj || {}));
           } catch (e) {
               // å®¹é‡è¶…éç­‰ã¯é»™ã£ã¦ç„¡è¦–ï¼ˆä¿å­˜å‡¦ç†è‡ªä½“ã¯ç¶™ç¶šï¼‰
           }
       }
       function addAiHistoryForFile(fileName, instruction) {
           if (devMode !== 'project' || !projectFolderName) return;
           const instr = String(instruction || '').trim();
           if (!instr) return;

           const data = loadProjectAiHistory();
           if (!Array.isArray(data[fileName])) data[fileName] = [];
           data[fileName].push({ ts: new Date().toISOString(), instruction: instr });
           saveProjectAiHistory(data);
       }
       function getLatestAiInstructionSummary(fileName, maxLen = 60) {
           if (devMode !== 'project' || !projectFolderName) return '';
           const data = loadProjectAiHistory();
           const arr = Array.isArray(data[fileName]) ? data[fileName] : [];
           if (!arr.length) return '';
           const last = arr[arr.length - 1];
           const text = String((last && last.instruction) ? last.instruction : '').trim();
           if (!text) return '';
           return (text.length > maxLen) ? (text.slice(0, maxLen) + 'â€¦') : text;
       }
       function openHistoryForFile(fileName) {
           const contentEl = document.getElementById('history-content');
           const modalEl = document.getElementById('history-modal');
           if (!contentEl || !modalEl) return;

           const currentMemo = getProjectFileMemo(fileName);
           const data = loadProjectAiHistory();
           const arr = Array.isArray(data[fileName]) ? data[fileName] : [];

           let html = '';

           // ãƒ¡ãƒ¢ç·¨é›†ã‚¨ãƒªã‚¢
           html += '<div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">';
           html += '<h3 style="margin:0 0 10px 0; color:var(--accent-color);">' + escapeHtml(fileName) + ' ã®ãƒ¡ãƒ¢ & å±¥æ­´</h3>';
           html += '<div style="font-size:12px; color:#aaa; margin-bottom:5px;">ãƒ¡ãƒ¢ (è‡ªç”±ã«ç·¨é›†å¯èƒ½):</div>';
           html += '<textarea id="history-modal-memo" style="width:100%; height:80px; background:rgba(0,0,0,0.3); border:1px solid #555; color:#ddd; padding:8px; border-radius:4px; font-size:12px; resize:vertical; margin-bottom:5px;">' + escapeHtml(currentMemo) + '</textarea>';
           html += '<div style="text-align:right;">';
           html += '<button class="btn-confirm" onclick="saveMemoFromModal(\'' + escapeHtml(fileName) + '\')" style="padding:4px 12px; font-size:11px;">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>';
           html += '</div></div>';

           // å±¥æ­´ä¸€è¦§
           html += '<div style="font-size:12px; color:#aaa; margin-bottom:8px;">AIæŒ‡ç¤ºå±¥æ­´ (è‡ªå‹•è¨˜éŒ²):</div>';
           if (!arr.length) {
               html += '<div style="color:#666; font-size:12px; padding:10px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
           } else {
               html += '<div style="display:flex; flex-direction:column; gap:10px;">';
               for (let i = arr.length - 1; i >= 0; i--) {
                   const it = arr[i] || {};
                   const ts = it.ts ? new Date(it.ts).toLocaleString() : '(æ—¥æ™‚ä¸æ˜)';
                   const instr = String(it.instruction || '').trim();
                   html += '<div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; border:1px solid #333;">';
                   html += '<div style="font-size:10px; color:#888; margin-bottom:4px; border-bottom:1px solid #444; padding-bottom:2px;">' + escapeHtml(ts) + '</div>';
                   html += '<div style="font-size:12px; line-height:1.5; white-space:pre-wrap;">' + escapeHtml(instr || '(ç©º)') + '</div>';
                   html += '</div>';
               }
               html += '</div>';
           }

           contentEl.innerHTML = html;
           modalEl.style.display = 'flex';

           // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ä¿å­˜é–¢æ•°ã‚’windowã«å®šç¾©
           window.saveMemoFromModal = (fname) => {
               const ta = document.getElementById('history-modal-memo');
               if(ta){
                   setProjectFileMemo(fname, ta.value);
                   showToast('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                   // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°
                   refreshProjectList();
               }
           };
       }

       // --- Project Sidebar Memo (Hand-editable, localStorage only) ---
       function getProjectMemoKey() {
           return `appstudio_project_file_memo::${projectFolderName || "__no_project__"}`;
       }
       function loadProjectFileMemos() {
           try {
               const raw = localStorage.getItem(getProjectMemoKey());
               const obj = raw ? JSON.parse(raw) : {};
               return (obj && typeof obj === 'object') ? obj : {};
           } catch (e) {
               return {};
           }
       }
       function saveProjectFileMemos(obj) {
           try {
               localStorage.setItem(getProjectMemoKey(), JSON.stringify(obj || {}));
           } catch (e) {
               // å®¹é‡è¶…éç­‰ã¯é»™ã£ã¦ç„¡è¦–
           }
       }
       function getProjectFileMemo(fileName) {
           if (devMode !== 'project' || !projectFolderName) return '';
           const memos = loadProjectFileMemos();
           return String(memos[fileName] || '').trim();
       }
       function setProjectFileMemo(fileName, memoText) {
           if (devMode !== 'project' || !projectFolderName) return;
           const memos = loadProjectFileMemos();
           const v = String(memoText || '').trim();
           if (v) memos[fileName] = v;
           else delete memos[fileName];
           saveProjectFileMemos(memos);
       }
       function clipTextOneLine(s, maxLen = 80) {
           const t = String(s || '').replace(/\s+/g, ' ').trim();
           if (!t) return '';
           return (t.length > maxLen) ? (t.slice(0, maxLen) + 'â€¦') : t;
       }


               // --- Editor Logic ---
       textarea.addEventListener('input', updateStats);

               // Ctrl/Cmd+F: open find popup window
       textarea.addEventListener('keydown', (e) => {
           if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) {
               e.preventDefault();
               openFindWindow();
           }
       });


       function undo() { editor.undo(); }
       function redo() { editor.redo(); }

       // --- Find / Replace Logic (NO external / textarea-based) ---
       function toggleFindBar(force) {
           if (!editorContainerEl || !findBar) return;
           const open = (force !== undefined) ? !!force : !editorContainerEl.classList.contains('findbar-open');
           editorContainerEl.classList.toggle('findbar-open', open);
           if (open) {
               setTimeout(() => {
                   if (findInput) { findInput.focus(); findInput.select(); }
                   computeFindPositions();
               }, 0);
           } else {
               currentFindIndex = -1;
               renderFindCount();
               textarea.focus();
           }
       }

       function scheduleFindRecalc() {
           if (findDebounceTimer) clearTimeout(findDebounceTimer);
           findDebounceTimer = setTimeout(computeFindPositions, 120);
       }

       function getNeedle() {
           return findInput ? String(findInput.value || '') : '';
       }
       function isCaseSensitive() {
           return !!(findCaseEl && findCaseEl.checked);
       }

       function computeFindPositions() {
           const q = getNeedle();
           const text = editor.getValue();
           if (!q) {
               findPositions = [];
               currentFindIndex = -1;
               renderFindCount();
               return;
           }
           const cs = isCaseSensitive();
           const hay = cs ? text : text.toLowerCase();
           const needle = cs ? q : q.toLowerCase();

           const pos = [];
           let from = 0;
           const maxHits = 5000;
           while (from <= hay.length) {
               const idx = hay.indexOf(needle, from);
               if (idx === -1) break;
               pos.push(idx);
               from = idx + needle.length;
               if (pos.length >= maxHits) break;
           }
           findPositions = pos;

           const selStart = textarea.selectionStart || 0;
           const exact = findPositions.indexOf(selStart);
           if (exact !== -1) currentFindIndex = exact;
           else if (findPositions.length) {
               const nxt = findPositions.findIndex(p => p >= selStart);
               currentFindIndex = (nxt !== -1) ? nxt : 0;
           } else currentFindIndex = -1;

           renderFindCount();
       }

       function renderFindCount() {
           if (!findCountEl) return;
           const total = findPositions.length;
           if (!total) { findCountEl.textContent = '0/0'; return; }
           const cur = (currentFindIndex >= 0) ? (currentFindIndex + 1) : 0;
           findCountEl.textContent = cur + '/' + total;
       }


       // â˜… é¸æŠä½ç½®ã‚’å¿…ãšè¡¨ç¤ºé ˜åŸŸã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆChromeç³»ã®æŒ™å‹•å¯¾ç­–ï¼‰
       function scrollSelectionIntoView(selPos) {
           try {
               const v = textarea.value || '';
               const p = Math.max(0, Math.min(Number(selPos) || 0, v.length));

               // è¡Œç•ªå·ï¼ˆæ”¹è¡Œãƒ™ãƒ¼ã‚¹ï¼‰
               const before = v.slice(0, p);
               const lineIndex = (before.match(/\n/g) || []).length; // 0-based

               // è¡Œé«˜ã‚’CSSã‹ã‚‰å–å¾—ï¼ˆpxã«è§£æ±ºã§ããªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
               const cs = window.getComputedStyle(textarea);
               let lh = parseFloat(cs.lineHeight);
               if (!isFinite(lh) || lh <= 0) {
                   // font-size * 1.5 (ã‚ãªãŸã®CSS: line-height:1.5; font-size:14px)
                   const fs = parseFloat(cs.fontSize);
                   lh = (isFinite(fs) && fs > 0) ? fs * 1.5 : 21;
               }

               // ç”»é¢ä¸­å¤®å¯„ã›æ°—å‘³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
               const padTop = 2 * lh;
               const targetTop = Math.max(0, lineIndex * lh - padTop);
               textarea.scrollTop = targetTop;
           } catch (e) {
               // å¤±æ•—ã—ã¦ã‚‚é¸æŠã¯æˆç«‹ã—ã¦ã„ã‚‹ã®ã§ç„¡è¦–
           }
       }

        function selectAt(pos) {
            const q = getNeedle();
            if (!q) return;
            textarea.focus();
            textarea.setSelectionRange(pos, pos + q.length);
           scrollSelectionIntoView(pos);
            renderFindCount();
        }


       function findNext() {
           const q = getNeedle();
           if (!q) return showToast('æ¤œç´¢æ–‡å­—åˆ—ãŒç©ºã§ã™');
           computeFindPositions();
           if (!findPositions.length) return showToast('ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“');

           const selStart = textarea.selectionStart || 0;
           const exact = findPositions.indexOf(selStart);
           if (exact !== -1) currentFindIndex = exact;

           currentFindIndex = (currentFindIndex + 1) % findPositions.length;
           selectAt(findPositions[currentFindIndex]);
           return findPositions[currentFindIndex];
       }

       function findPrev() {
           const q = getNeedle();
           if (!q) return showToast('æ¤œç´¢æ–‡å­—åˆ—ãŒç©ºã§ã™');
           computeFindPositions();
           if (!findPositions.length) return showToast('ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“');

           const selStart = textarea.selectionStart || 0;
           const exact = findPositions.indexOf(selStart);
           if (exact !== -1) currentFindIndex = exact;

           currentFindIndex = (currentFindIndex - 1 + findPositions.length) % findPositions.length;
           selectAt(findPositions[currentFindIndex]);
           return findPositions[currentFindIndex];
       }

       function replaceOne() {
            const q = getNeedle();
            if (!q) return showToast('æ¤œç´¢æ–‡å­—åˆ—ãŒç©ºã§ã™');
            computeFindPositions();
            
            if (!findPositions.length) {
                // â˜… ã‚¹ãƒãƒ¼ãƒˆææ¡ˆ
                const suggestion = findSmartSuggestion(q);
                if (suggestion) {
                    alert(`ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“ãŒã€é¡ä¼¼ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚\n\nã‚‚ã—ã‹ã—ã¦ï¼š ${suggestion.startLine}è¡Œ ï½ ${suggestion.endLine}è¡Œ ã‹ã‚‚ï¼\nç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`);
                    return;
                }
                return showToast('ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“');
            }

            const selStart = textarea.selectionStart || 0;
            const exact = findPositions.indexOf(selStart);
            if (exact !== -1) currentFindIndex = exact;
            else selectAt(findPositions[currentFindIndex >= 0 ? currentFindIndex : 0]);

            const idx = textarea.selectionStart || 0;
            const end = textarea.selectionEnd || idx;
            const repl = replaceInput ? String(replaceInput.value || '') : '';

            const code = editor.getValue();
            const selected = code.slice(idx, end);
            const cs = isCaseSensitive();
            const ok = cs ? (selected === q) : (selected.toLowerCase() === q.toLowerCase());
            if (!ok) { findNext(); return replaceOne(); }

            const newCode = code.slice(0, idx) + repl + code.slice(end);
            editor.setValue(newCode);
            textarea.focus();
            textarea.setSelectionRange(idx, idx + repl.length);
            showToast('ç½®æ›ã—ã¾ã—ãŸ');
            computeFindPositions();
        }

        function replaceAll() {
            const q = getNeedle();
            if (!q) return showToast('æ¤œç´¢æ–‡å­—åˆ—ãŒç©ºã§ã™');
            computeFindPositions();
            const total = findPositions.length;
            
            if (!total) {
                // â˜… ã‚¹ãƒãƒ¼ãƒˆææ¡ˆ
                const suggestion = findSmartSuggestion(q);
                if (suggestion) {
                    alert(`ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“ãŒã€é¡ä¼¼ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚\n\nã‚‚ã—ã‹ã—ã¦ï¼š ${suggestion.startLine}è¡Œ ï½ ${suggestion.endLine}è¡Œ ã‹ã‚‚ï¼\nç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`);
                    return;
                }
                return showToast('ä¸€è‡´ãŒã‚ã‚Šã¾ã›ã‚“');
            }

            if (!confirm('"' + q + '" ã‚’ ' + total + 'ç®‡æ‰€ ç½®æ›ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const repl = replaceInput ? String(replaceInput.value || '') : '';
            const text = editor.getValue();

            let out = '';
            let count = 0;
            if (isCaseSensitive()) {
                out = text.split(q).join(repl);
                count = total;
            } else {
                const hay = text.toLowerCase();
                const needle = q.toLowerCase();
                let i = 0;
                while (i <= hay.length) {
                    const idx = hay.indexOf(needle, i);
                    if (idx === -1) break;
                    out += text.slice(i, idx) + repl;
                    i = idx + q.length;
                    count++;
                }
                out += text.slice(i);
            }

            editor.setValue(out);
            textarea.focus();
            showToast(count + 'ç®‡æ‰€ ç½®æ›ã—ã¾ã—ãŸ');
            computeFindPositions();
        }

               // --- Find/Replace Popup (separate window) ---
       // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰è¦ªç”»é¢ã®æ¤œç´¢ãƒ»ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®API
       window.__findPopupApi = {
           setFindText: (t) => {
               if (findInput) findInput.value = String(t || '');
               computeFindPositions();
               return window.__findPopupApi.getStatus();
           },
           setReplaceText: (t) => {
               if (replaceInput) replaceInput.value = String(t || '');
               return true;
           },
           setCaseSensitive: (v) => {
               if (findCaseEl) findCaseEl.checked = !!v;
               computeFindPositions();
               return window.__findPopupApi.getStatus();
           },
           getStatus: () => {
               const total = Array.isArray(findPositions) ? findPositions.length : 0;
               const cur = (total && currentFindIndex >= 0) ? (currentFindIndex + 1) : 0;
               return { cur, total };
           },
           next: () => { try { return findNext(); } catch(e) { return null; } },
           prev: () => { try { return findPrev(); } catch(e) { return null; } },
           replaceOne: () => { try { return replaceOne(); } catch(e) { return null; } },
           replaceAll: () => { try { return replaceAll(); } catch(e) { return null; } },
           focusEditor: () => { try { textarea && textarea.focus(); } catch(e) {} }
       };

       // æ¤œç´¢/ç½®æ›ã®è¨­å®šç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
               function openFindWindow() {
           const w = window.open('', 'appstudio_find_window', 'width=560,height=740,resizable=yes,scrollbars=yes');
           if (!w) { showToast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); return; }

           // NOTE: HTMLã‚’ <...> ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã¨ã€Œã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã€ã«ãªã‚‹ãŸã‚ã€å®ŸHTMLã‚’ç”Ÿæˆã™ã‚‹
           // NOTE: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—(backtick)ã®æ··å…¥ã«ã‚ˆã‚‹å´©å£Šã‚’é¿ã‘ã€é…åˆ—+joinã§æ§‹ç¯‰

            const html = [
                '&lt;!doctype html&gt;',
                '&lt;html lang="ja"&gt;',
                '&lt;head&gt;',
                '  &lt;meta charset="UTF-8"/&gt;',
                '  &lt;meta name="viewport" content="width=device-width,initial-scale=1"/&gt;',
                '  &lt;title&gt;æ¤œç´¢ / ç½®æ›&lt;/title&gt;',
                '  &lt;style&gt;',
                '    :root{--bg:#1e1e1e;--surface:#252526;--text:#d4d4d4;--border:#3e3e42;--accent:#007acc;--danger:#f44336;}',
                '    *{box-sizing:border-box}',
                '    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}',
                '    .wrap{padding:14px;display:flex;flex-direction:column;gap:10px;}',
                '    .card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;}',
                '    h1{font-size:14px;margin:0 0 8px 0;color:#bbb;font-weight:700;}',
                '    label{font-size:12px;color:#bbb;display:block;margin:0 0 6px 0;}',
                '    textarea{width:100%;min-height:180px;resize:vertical;background:#111;border:1px solid #555;color:#ddd;border-radius:8px;padding:10px;font-family:Menlo,Consolas,Monaco,monospace;font-size:12px;line-height:1.4;}',
                '    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}',
                '    .btn{border:1px solid #555;background:rgba(255,255,255,0.06);color:#ddd;border-radius:8px;padding:8px 10px;cursor:pointer;font-size:12px;font-weight:700;}',
                '    .btn.primary{border-color:var(--accent);background:var(--accent);color:#fff;}',
                '    .btn.danger{border-color:var(--danger);color:var(--danger);background:transparent;}',
                '    .pill{font-size:12px;color:#aaa;border:1px solid #444;border-radius:999px;padding:6px 10px;background:rgba(0,0,0,0.25);}',
                '    .opt{display:flex;align-items:center;gap:6px;font-size:12px;color:#ccc;user-select:none;}',
                '    .hint{font-size:11px;color:#888;margin-top:6px;line-height:1.5;}',
                '  &lt;/style&gt;',
                '&lt;/head&gt;',
                '&lt;body&gt;',
                '  &lt;div class="wrap"&gt;',
                '    &lt;div class="card"&gt;',
                '      &lt;h1&gt;æ¤œç´¢&lt;/h1&gt;',
                '      &lt;label for="q"&gt;æ¤œç´¢æ–‡å­—åˆ—ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘å¯ï¼‰&lt;/label&gt;',
                '      &lt;textarea id="q" placeholder="ã“ã“ã«æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›..."&gt;&lt;/textarea&gt;',
                '      &lt;div class="row" style="margin-top:8px;"&gt;',
                '        &lt;span class="pill" id="stat"&gt;è©²å½“: 0ä»¶&lt;/span&gt;',
                '        &lt;label class="opt" title="å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥"&gt;&lt;input id="cs" type="checkbox"/&gt;Aa&lt;/label&gt;',
                '        &lt;span class="hint" style="margin-left:auto;"&gt;Enter=æ¬¡ / Shift+Enter=å‰&lt;/span&gt;',
                '      &lt;/div&gt;',
                '    &lt;/div&gt;',
                '    &lt;div class="card"&gt;',
                '      &lt;h1&gt;ç½®æ›&lt;/h1&gt;',
                '      &lt;label for="r"&gt;ç½®æ›æ–‡å­—åˆ—ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘å¯ï¼‰&lt;/label&gt;',
                '      &lt;textarea id="r" placeholder="ã“ã“ã«ç½®æ›æ–‡å­—åˆ—ã‚’å…¥åŠ›..."&gt;&lt;/textarea&gt;',
                '      &lt;div class="row" style="margin-top:10px;"&gt;',
                '        &lt;button class="btn" id="prev"&gt;â†‘ å‰ã¸&lt;/button&gt;',
                '        &lt;button class="btn" id="next"&gt;â†“ æ¬¡ã¸&lt;/button&gt;',
                '        &lt;button class="btn" id="rep1"&gt;ç½®æ›ï¼ˆç¾åœ¨ï¼‰&lt;/button&gt;',
                '        &lt;button class="btn primary" id="repall"&gt;å…¨ç½®æ›&lt;/button&gt;',
                '        &lt;button class="btn danger" id="close" style="margin-left:auto;"&gt;é–‰ã˜ã‚‹&lt;/button&gt;',
                '      &lt;/div&gt;',
                '      &lt;div class="hint"&gt;',
                '        ãƒ»æ¤œç´¢æ¬„ã¸å…¥åŠ›ã—ãŸç¬é–“ã«è©²å½“ä»¶æ•°ã‚’æ›´æ–°&lt;br&gt;',
                '        ãƒ»ã€Œæ¬¡ã¸/å‰ã¸ã€ã§è¦ªç”»é¢ã®ã‚¨ãƒ‡ã‚£ã‚¿é¸æŠä½ç½®ãŒç§»å‹•&lt;br&gt;',
                '        ãƒ»ç½®æ›ã¯è¦ªç”»é¢ã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã§å®Ÿè¡Œï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç­‰ã‚‚è¦ªç”»é¢å´ï¼‰',
                '      &lt;/div&gt;',
                '    &lt;/div&gt;',
                '  &lt;/div&gt;',
                '  &lt;scr' + 'ipt&gt;',
                '  (function(){',
                '    const api = window.opener &amp;&amp; window.opener.__findPopupApi;',
                '    const q = document.getElementById("q");',
                '    const r = document.getElementById("r");',
                '    const cs = document.getElementById("cs");',
                '    const stat = document.getElementById("stat");',
                '    const render = function(){',
                '      if(!api){ stat.textContent = "è¦ªç”»é¢APIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return; }',
                '      const s = api.getStatus();',
                '      stat.textContent = "è©²å½“: " + s.total + "ä»¶" + (s.total ? ("ï¼ˆ" + s.cur + "/" + s.total + "ï¼‰") : "");',
                '    };',
                '    const sync = function(){',
                '      if(!api) return;',
                '      api.setCaseSensitive(!!cs.checked);',
                '      api.setFindText(q.value);',
                '      api.setReplaceText(r.value);',
                '      render();',
                '    };',
                '    q.addEventListener("input", sync);',
                '    r.addEventListener("input", function(){ if(api) api.setReplaceText(r.value); });',
                '    cs.addEventListener("change", sync);',
                '    document.getElementById("next").addEventListener("click", function(){ if(api){ api.setFindText(q.value); api.setCaseSensitive(!!cs.checked); api.next(); api.focusEditor(); render(); } });',
                '    document.getElementById("prev").addEventListener("click", function(){ if(api){ api.setFindText(q.value); api.setCaseSensitive(!!cs.checked); api.prev(); api.focusEditor(); render(); } });',
                '    document.getElementById("rep1").addEventListener("click", function(){ if(api){ api.setFindText(q.value); api.setReplaceText(r.value); api.setCaseSensitive(!!cs.checked); api.replaceOne(); api.focusEditor(); render(); } });',
                '    document.getElementById("repall").addEventListener("click", function(){ if(api){ api.setFindText(q.value); api.setReplaceText(r.value); api.setCaseSensitive(!!cs.checked); api.replaceAll(); api.focusEditor(); render(); } });',
                '    document.getElementById("close").addEventListener("click", function(){ window.close(); });',
                '    q.addEventListener("keydown", function(e){',
                '      if(e.key === "Enter" &amp;&amp; !e.ctrlKey &amp;&amp; !e.metaKey){',
                '        e.preventDefault();',
                '        if(api){ api.setFindText(q.value); api.setCaseSensitive(!!cs.checked); (e.shiftKey ? api.prev() : api.next()); api.focusEditor(); render(); }',
                '      }',
                '    });',
                '    sync();',
                '    setTimeout(function(){ q.focus(); q.select(); }, 0);',
                '  })();',
                '  &lt;/scr' + 'ipt&gt;',
                '&lt;/body&gt;',
                '&lt;/html&gt;'
            ].join('\n');

           // â˜… &lt; &gt; &amp; ã‚’å®Ÿä½“åŒ–ã—ã¦ã€Œå®ŸHTMLã€ã¨ã—ã¦è§£é‡ˆã•ã›ã‚‹
           const decodedHtml = html
               .replace(/&amp;/g, '&')
               .replace(/&lt;/g, '<')
               .replace(/&gt;/g, '>');

            try {
                w.document.open();

               w.document.write(decodedHtml);
                w.document.close();
                w.focus();
            } catch (e) {
                showToast('æ¤œç´¢ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ç”Ÿæˆã«å¤±æ•—');
            }

       }


       // findbar events
       if (findInput) {

           findInput.addEventListener('input', scheduleFindRecalc);
           findInput.addEventListener('keydown', (e) => {
               if (e.key === 'Escape') { e.preventDefault(); toggleFindBar(false); }
               else if (e.key === 'Enter') { e.preventDefault(); e.shiftKey ? findPrev() : findNext(); }
           });
       }
       if (replaceInput) {
           replaceInput.addEventListener('keydown', (e) => {
               if (e.key === 'Escape') { e.preventDefault(); toggleFindBar(false); }
               else if (e.key === 'Enter') { e.preventDefault(); replaceOne(); }
           });
       }
       if (findCaseEl) findCaseEl.addEventListener('change', computeFindPositions);

               // global ESC to close when open
       document.addEventListener('keydown', (e) => {
           if (e.key === 'Escape' && editorContainerEl && editorContainerEl.classList.contains('findbar-open')) {
               e.preventDefault();
               toggleFindBar(false);
           }
           if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) {
               e.preventDefault();
               openFindWindow();
           }
       });


       // --- Editor shim (CodeMirrorå‰Šé™¤æ™‚ã®äº’æ›) ---
       // editor ãŒæœªå®šç¾©ã§ã‚‚ textarea(#code-editor) ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
       if (!window.editor || typeof window.editor.getValue !== 'function') {
           window.editor = {
               getValue: () => {
                   const ta = document.getElementById('code-editor');
                   return ta ? String(ta.value || '') : '';
               },
               setValue: (v) => {
                   const ta = document.getElementById('code-editor');
                   if (ta) ta.value = String(v ?? '');
               },
               lineCount: () => {
                   const ta = document.getElementById('code-editor');
                   const t = ta ? String(ta.value || '') : '';
                   return t ? t.split('\n').length : 0;
               }
           };
       }

               function updateStats() {
            const text = editor.getValue();
            const lines = (typeof editor.lineCount === 'function') ? editor.lineCount() : (text ? text.split('\n').length : 0);
            const chars = text.length;
            const statsEl = document.getElementById('code-stats');
            if (statsEl) statsEl.textContent = lines + 'è¡Œ / ' + chars + 'æ–‡å­—';

            // è¡Œç•ªå·ã®æ›´æ–°
            const ln = document.getElementById('line-numbers');
            if (ln) {
                // è¡Œæ•°ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿DOMå†æ§‹ç¯‰
                if (ln.getAttribute('data-lines') != lines) {
                    let html = '';
                    for(let i=1; i<=lines; i++) html += `<div>${i}</div>`;
                    ln.innerHTML = html;
                    ln.setAttribute('data-lines', lines);
                }
            }
        }

       async function pasteCode() {
           try {
               const text = await navigator.clipboard.readText();
               if (!text) return showToast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™");
               if(editor.getValue().trim().length > 0) {
                   if(!confirm("ã€è­¦å‘Šã€‘\nã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å†…å®¹ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
               }
               editor.setValue(text);
               showToast("å…¨ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
           } catch (err) {
               showToast("è²¼ã‚Šä»˜ã‘å¤±æ•—: æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
           }
       }

       function clearCode() {
           if(confirm("ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n(ç·¨é›†ä¸­ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™)")) {
               editor.setValue("");
               currentAppName = "";
               appNameDisplay.textContent = "(æ–°è¦ä½œæˆä¸­)";
               currentAppHistory = [];
           }
       }

       function copyFullCode() {
           const code = editor.getValue();
           if(!code) {
               showToast("ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“");
               return;
           }
           navigator.clipboard.writeText(code).then(() => {
               showToast("å…¨ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
           }).catch(() => {
               showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
           });
       }

               // --- New: AI & Fix Logic ---
               function openStartModal() {
           const el = document.getElementById('start-modal');
           if (el) el.style.display = 'flex';
       }

               // --- Start menu actions ---
       function hideProjectSidebar(){
           if(projectSidebar) projectSidebar.classList.add('hidden');
       }
       function showProjectSidebar(){
           if(projectSidebar) projectSidebar.classList.remove('hidden');
           if(projectTitle) projectTitle.textContent = projectFolderName ? `ğŸ“ ${projectFolderName}` : "(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ)";
           // è¡¨ç¤ºã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¸€è¦§ã‚‚æ›´æ–°ï¼ˆéåŒæœŸãƒ»å¤±æ•—ã—ã¦ã‚‚è‡´å‘½å‚·ã«ã—ãªã„ï¼‰
           try { if (devMode === 'project' && projectDirHandle) refreshProjectList(); } catch(e) {}
       }
       function toggleProjectSidebar(force){
           // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠæ™‚ã¯æ¡ˆå†…ã®ã¿
           if (devMode !== 'project' || !projectDirHandle) {
               showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ');
               return;
           }
           const isHidden = projectSidebar ? projectSidebar.classList.contains('hidden') : true;
           const open = (force !== undefined) ? !!force : isHidden;
           if (open) showProjectSidebar();
           else hideProjectSidebar();
       }

       function setModeSingle() {
            devMode = "single";
            projectDirHandle = null;
            projectFolderName = "";
            currentProjectFileName = "";
            hideProjectSidebar();
            const btn = document.getElementById('sidebar-toggle-btn');
            if(btn) btn.style.display = 'none';
        }

       function startSingleNew() {
           setModeSingle();
           editor.setValue("");
           currentAppName = "";
           appNameDisplay.textContent = "(æ–°è¦ä½œæˆä¸­)";
           showToast("å˜ç™ºã‚¢ãƒ—ãƒª: æ–°è¦ä½œæˆ");
           closeModal('start-modal');
       }

       function startSingleOpen() {
           setModeSingle();
           const input = document.getElementById('single-open-input');
           if (!input) return;
           input.value = "";
           input.click();
       }

               async function startProjectNew() {
           if (!window.showDirectoryPicker) {
               alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«æœªå¯¾å¿œã§ã™ã€‚PCç‰ˆChrome/Edgeã§ãŠè©¦ã—ãã ã•ã„ã€‚");
               return;
           }
           const name = prompt("æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå(ãƒ•ã‚©ãƒ«ãƒ€å)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "MyProject");
           if (!name) return;

           try {
               // è¨­å®šã•ã‚ŒãŸè¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€‚ç„¡ã‘ã‚Œã°å¾“æ¥é€šã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸ã°ã›ã‚‹
               const parent = projectRootHandle || await window.showDirectoryPicker();

               // æ¨©é™è¦æ±‚ï¼ˆç’°å¢ƒå·®ã‚ã‚Šï¼‰
               if (parent && parent.requestPermission) {
                   const perm = await parent.requestPermission({ mode: 'readwrite' });
                   if (perm !== 'granted') {
                       showToast("ãƒ•ã‚©ãƒ«ãƒ€æ¨©é™ãŒå¿…è¦ã§ã™");
                       return;
                   }
               }

               // è¦ªãƒ•ã‚©ãƒ«ãƒ€ç›´ä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
               const dir = await parent.getDirectoryHandle(name, { create: true });

               devMode = "project";
                projectDirHandle = dir;
                projectFolderName = dir.name;
                currentProjectFileName = "";
                const btn = document.getElementById('sidebar-toggle-btn');
                if(btn) btn.style.display = 'flex';
                showProjectSidebar();
               await refreshProjectList();
               editor.setValue("");
               currentAppName = "";
               appNameDisplay.textContent = `(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectFolderName})`;
               closeModal('start-modal');
               showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ");
           } catch (e) {
               if (e && e.name !== 'AbortError') alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«å¤±æ•—: " + e.message);
           }
       }


               async function startProjectOpen() {
           if (!window.showDirectoryPicker) {
               alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«æœªå¯¾å¿œã§ã™ã€‚PCç‰ˆChrome/Edgeã§ãŠè©¦ã—ãã ã•ã„ã€‚");
               return;
           }
           try {
               // è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒè¨­å®šæ¸ˆã¿ãªã‚‰ã€ãã®å ´æ‰€ã‹ã‚‰é¸æŠã‚’é–‹å§‹ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°è‡ªä½“ã®è‡ªå‹•è¡¨ç¤ºã¯ä¸å¯ï¼‰
               const opts = projectRootHandle ? { startIn: projectRootHandle } : {};
               const dir = await window.showDirectoryPicker(opts);

                               devMode = "project";
                projectDirHandle = dir;
                projectFolderName = dir.name;
                currentProjectFileName = "";
                const btn = document.getElementById('sidebar-toggle-btn');
                if(btn) btn.style.display = 'flex';
                showProjectSidebar();
               await refreshProjectList();
               appNameDisplay.textContent = `(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectFolderName})`;
               closeModal('start-modal');
               showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã¾ã—ãŸ");
           } catch (e) {
               if (e && e.name !== 'AbortError') alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã‘ã¾ã›ã‚“: " + e.message);
           }
       }


       function closeProject(){
           setModeSingle();
           appNameDisplay.textContent = "(æ–°è¦ä½œæˆä¸­)";
           showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‰ã˜ã¾ã—ãŸ");
       }


       // file input handler (single open)
       (function(){
           const input = document.getElementById('single-open-input');
           if(!input) return;
           input.addEventListener('change', async (e) => {
               const file = e.target.files && e.target.files[0];
               if(!file) return;
               try {
                   const text = await file.text();
                   editor.setValue(text);

                   // â˜… ã“ã“ã§å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ ï¼ˆé¸æŠã—ãŸç¬é–“ã«å³å´ã¸åæ˜ ï¼‰
                   try { reloadFrame(); } catch(e) {}

                   currentAppName = (file.name || '').replace(/\.html?$/i, '');
                   appNameDisplay.textContent = file.name;
                   showToast("HTMLã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
                   closeModal('start-modal');
               } catch(err){
                   alert("ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err.message);
               }
           });
       })();



       function openHelpModal() {
           const el = document.getElementById('help-modal');
           if (el) el.style.display = 'flex';
       }

               function openConsultModal() {
           document.getElementById('consult-modal').style.display = 'flex';
       }

       function openSettingsModal() {
           const el = document.getElementById('settings-modal');
           if (el) {
               updateSettingsUI();
               el.style.display = 'flex';
           }
       }

       function updateSettingsUI() {
           // Project Root
           const el = document.getElementById('project-root-name');
           if (el) el.textContent = projectRootName ? (`é¸æŠä¸­: ${projectRootName}`) : 'æœªè¨­å®š';

           // Security Checkboxes
           const cbSend = document.getElementById('sec-no-send');
           const cbRecv = document.getElementById('sec-no-recv');
           if (cbSend) cbSend.checked = !!appSettings.secNoSend;
           if (cbRecv) cbRecv.checked = !!appSettings.secNoRecv;
       }

       function updateAppSettings() {
           const cbSend = document.getElementById('sec-no-send');
           const cbRecv = document.getElementById('sec-no-recv');
           if (cbSend) appSettings.secNoSend = cbSend.checked;
           if (cbRecv) appSettings.secNoRecv = cbRecv.checked;
           localStorage.setItem('appstudio_settings_json', JSON.stringify(appSettings));
       }

       const SETTINGS_DB = 'appstudio_settings_db';
       const SETTINGS_STORE = 'kv';
       const SETTINGS_KEY_ROOT = 'projectRootHandle';

       function openSettingsDb() {
           return new Promise((resolve, reject) => {
               const req = indexedDB.open(SETTINGS_DB, 1);
               req.onupgradeneeded = () => {
                   const db = req.result;
                   if (!db.objectStoreNames.contains(SETTINGS_STORE)) db.createObjectStore(SETTINGS_STORE);
               };
               req.onsuccess = () => resolve(req.result);
               req.onerror = () => reject(req.error);
           });
       }

       async function saveProjectRootToDb(handle) {
           const db = await openSettingsDb();
           return new Promise((resolve, reject) => {
               const tx = db.transaction(SETTINGS_STORE, 'readwrite');
               tx.objectStore(SETTINGS_STORE).put(handle, SETTINGS_KEY_ROOT);
               tx.oncomplete = () => { db.close(); resolve(); };
               tx.onerror = () => { const e = tx.error; db.close(); reject(e); };
           });
       }

       async function deleteProjectRootFromDb() {
           const db = await openSettingsDb();
           return new Promise((resolve, reject) => {
               const tx = db.transaction(SETTINGS_STORE, 'readwrite');
               tx.objectStore(SETTINGS_STORE).delete(SETTINGS_KEY_ROOT);
               tx.oncomplete = () => { db.close(); resolve(); };
               tx.onerror = () => { const e = tx.error; db.close(); reject(e); };
           });
       }

       async function loadProjectRootFromDb() {
           try {
               const db = await openSettingsDb();
               const handle = await new Promise((resolve, reject) => {
                   const tx = db.transaction(SETTINGS_STORE, 'readonly');
                   const req = tx.objectStore(SETTINGS_STORE).get(SETTINGS_KEY_ROOT);
                   req.onsuccess = () => resolve(req.result || null);
                   req.onerror = () => reject(req.error);
                   tx.oncomplete = () => db.close();
               });
               projectRootHandle = handle;
               projectRootName = handle ? (handle.name || '') : '';
           } catch (e) {
               projectRootHandle = null;
               projectRootName = '';
           }
       }

       async function pickProjectRootFolder() {
           if (!window.showDirectoryPicker) {
               alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«æœªå¯¾å¿œã§ã™ã€‚PCç‰ˆChrome/Edgeã§ãŠè©¦ã—ãã ã•ã„ã€‚");
               return;
           }
           try {
               const h = await window.showDirectoryPicker();
               if (h && h.requestPermission) {
                   const perm = await h.requestPermission({ mode: 'readwrite' });
                   if (perm !== 'granted') {
                       showToast('ãƒ•ã‚©ãƒ«ãƒ€æ¨©é™ãŒå¿…è¦ã§ã™');
                       return;
                   }
               }
               projectRootHandle = h;
               projectRootName = h ? (h.name || '') : '';
               await saveProjectRootToDb(h);
               updateSettingsUI();
               showToast('ä¿å­˜ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®šã—ã¾ã—ãŸ');
           } catch (e) {
               if (e && e.name !== 'AbortError') alert('ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã«å¤±æ•—: ' + e.message);
           }
       }

       async function clearProjectRootFolder() {
           projectRootHandle = null;
           projectRootName = '';
           try { await deleteProjectRootFromDb(); } catch (e) {}
           updateSettingsUI();
           showToast('ä¿å­˜ç”¨ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã‚’è§£é™¤ã—ã¾ã—ãŸ');
       }


       function copyConsultPrompt() {
           const categories = Array.from(document.querySelectorAll('input[name="consult-cat"]:checked')).map(cb => cb.value).join(', ');
           const details = document.getElementById('consult-text').value;
           const currentCode = editor.getValue();

           const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ç›¸è«‡ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åˆ†æãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚\n\n[ç›¸è«‡ã‚«ãƒ†ã‚´ãƒª]\n${categories || 'å…¨èˆ¬'}\n\n[è©³ç´°ãƒ»æ‚©ã¿]\n${details}\n\n[ä¾é ¼äº‹é …]\n1. ç¾çŠ¶ã®åˆ†æã¨å•é¡Œç‚¹ã®æŒ‡æ‘˜\n2. å…·ä½“çš„ãªæ”¹å–„æ¡ˆãƒ»è§£æ±ºç­–ã®æç¤º\n3. (ã‚‚ã—ã€Œæ¡ç‚¹ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆ) ã‚³ãƒ¼ãƒ‰å“è³ªã‚’100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—ã€æ¸›ç‚¹ç†ç”±ã¨æ”¹å–„ã§ä¼¸ã³ã‚‹ç‚¹æ•°ã‚’æç¤º\n4. **ãã®æ”¹å–„ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®ã€AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨˜è¿°ä¾‹**\n\n[å¯¾è±¡ã‚³ãƒ¼ãƒ‰]\n\`\`\`html\n${currentCode}\n\`\`\``;

           const textArea = document.createElement("textarea");
           textArea.value = prompt;
           textArea.style.position = "fixed";
           textArea.style.left = "-9999px";
           document.body.appendChild(textArea);
           textArea.select();
           try {
               document.execCommand('copy');
               showToast("ç›¸è«‡ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
               closeModal('consult-modal');
           } catch (e) {
               alert("ã‚³ãƒ”ãƒ¼å¤±æ•—");
           }
           document.body.removeChild(textArea);
       }

                      function openPromptModal() {
            document.getElementById('prompt-modal').style.display = 'flex';
            if (currentPromptMode) switchPromptTab(currentPromptMode);
        }
              function openFixModal() {
            document.getElementById('fix-modal').style.display = 'flex';
            // ç›´å‰ã®AIæŒ‡ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦ã‚¿ãƒ–ã‚’è‡ªå‹•é¸æŠ
            if (currentPromptMode) {
                let target = currentPromptMode;
                if (target === 'json') target = 'auto'; // è¡¨è¨˜ã‚†ã‚Œå¸å
                switchFixTab(target);
            }
        }

               function switchFixTab(tab) {
           const modal = document.getElementById('fix-modal');
           if (!modal) return;

           modal.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
           modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

           // data-tab based (robust)
           const btn = modal.querySelector(`.modal-tab-btn[data-tab="${tab}"]`);
           if (btn) btn.classList.add('active');

           const panel = modal.querySelector(`#tab-${tab}`);
           if (panel) panel.classList.add('active');
       }


                       let currentPromptMode = 'full';

        function toggleRecipes() {
            const c = document.getElementById('recipe-container');
            const icon = document.getElementById('recipe-toggle-icon');
            if (c.style.display === 'none') {
                c.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            } else {
                c.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function applyRecipe(type) {
            const ta = document.getElementById('ai-instruction');
            let text = "";
            if (type === 'minutes') {
                text = "ã€ã‚¢ãƒ—ãƒªåã€‘éŸ³å£°èªè­˜ä»˜ããƒ»è‡ªå‹•è­°äº‹éŒ²ã‚¢ãƒ—ãƒª\nã€æ©Ÿèƒ½è¦ä»¶ã€‘\n1. Web Speech APIã‚’ä½¿ç”¨ã—ã€ãƒã‚¤ã‚¯å…¥åŠ›ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ–‡å­—èµ·ã“ã—ã‚’è¡Œã†ã€‚\n2. ç™ºè¨€ã”ã¨ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹ã€‚\n3. ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§æ‰‹å‹•ä¿®æ­£ã‚‚å¯èƒ½ã«ã™ã‚‹ã€‚\n4. è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã¯localStorageã«ä¿å­˜ã—ã€æ¬¡å›èµ·å‹•æ™‚ã«å¾©å…ƒã™ã‚‹ã€‚\n5. ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«(CSVã¾ãŸã¯TXT)ã¨ã—ã¦ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã¤ã‘ã‚‹ã€‚\nã€UIãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\nãƒ»éŒ²éŸ³é–‹å§‹/åœæ­¢ãƒœã‚¿ãƒ³ã¯å¤§ããç›®ç«‹ãŸã›ã‚‹ã€‚\nãƒ»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åŸºèª¿ã§ã€æ–‡å­—ã¯è¦‹ã‚„ã™ãã€‚";
            } else if (type === 'toeic') {
                text = "ã€ã‚¢ãƒ—ãƒªåã€‘TOEICé »å‡ºå˜èªå¸³\nã€æ©Ÿèƒ½è¦ä»¶ã€‘\n1. TOEICé »å‡ºå˜èªï¼ˆè‹±å˜èªãƒ»æ—¥æœ¬èªè¨³ãƒ»ä¾‹æ–‡ï¼‰ã‚’50å€‹ç¨‹åº¦ãƒ—ãƒªã‚»ãƒƒãƒˆã§æŒã¤ã€‚\n2. ãƒ©ãƒ³ãƒ€ãƒ ã«å˜èªã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ã€‚\n3. ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Œã‚ãã‚Œã¦ã€ç­”ãˆï¼ˆæ—¥æœ¬èªï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚\n4. ã€Œè¦šãˆãŸã€ã€Œã¾ã ã€ãƒœã‚¿ãƒ³ã§ç¿’ç†Ÿåº¦ã‚’ç®¡ç†ï¼ˆlocalStorageä¿å­˜ï¼‰ã€‚\n5. é€²æ—ç‡ã‚’ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã§è¡¨ç¤ºã™ã‚‹ã€‚\nã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\nãƒ»ã‚«ãƒ¼ãƒ‰å‹ã®UIã€‚å­¦ç¿’æ„æ¬²ãŒã‚ããƒ¢ãƒ€ãƒ³ãªé…è‰²ã€‚";
            } else if (type === 'kanban') {
                text = "ã€ã‚¢ãƒ—ãƒªåã€‘ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ã‚«ãƒ³ãƒãƒ³ToDo\nã€æ©Ÿèƒ½è¦ä»¶ã€‘\n1. ã€ŒTODOã€ã€ŒDOINGã€ã€ŒDONEã€ã®3ã‚«ãƒ©ãƒ ã‚’è¡¨ç¤ºã€‚\n2. ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ç§»å‹•å¯èƒ½ã«ã™ã‚‹ã€‚\n3. æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ ã€å‰Šé™¤ã€å†…å®¹ç·¨é›†æ©Ÿèƒ½ã€‚\n4. ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦localStorageã«è‡ªå‹•ä¿å­˜ã€‚\nã€æŠ€è¡“åˆ¶ç´„ã€‘\nãƒ»å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ç”¨ã›ãšã€HTML5æ¨™æº–ã®Drag & Drop APIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚\nã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\nãƒ»Trelloé¢¨ã®ãƒœãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã€‚å„ã‚«ãƒ©ãƒ ã¯è¦‹åˆ†ã‘ã‚„ã™ã„è‰²åˆ†ã‘ã‚’ã™ã‚‹ã€‚";
            } else if (type === 'md') {
                text = "ã€ã‚¢ãƒ—ãƒªåã€‘ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ Markdownã‚¨ãƒ‡ã‚£ã‚¿\nã€æ©Ÿèƒ½è¦ä»¶ã€‘\n1. å·¦å´ã«å…¥åŠ›ã‚¨ãƒªã‚¢ã€å³å´ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®2ãƒšã‚¤ãƒ³æ§‹æˆã€‚\n2. å…¥åŠ›ã«åˆã‚ã›ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«HTMLå¤‰æ›ã—ã¦è¡¨ç¤ºã€‚\n3. å¯¾å¿œè¨˜æ³•: è¦‹å‡ºã—(#), ãƒªã‚¹ãƒˆ(-), å¤ªå­—(**), ãƒªãƒ³ã‚¯([]()), å¼•ç”¨(>)ã€‚\n4. å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä½¿ã‚ãšã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ­£è¦è¡¨ç¾ã§ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã€‚\n5. å…¥åŠ›å†…å®¹ã¯localStorageã«ä¿å­˜ã€‚\nã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\nãƒ»VSCodeã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«é©ã—ãŸé…è‰²ã€‚\nãƒ»ã‚¹ãƒãƒ›ã§ã‚‚è¦‹ã‚„ã™ã„ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã€‚";
            }
            ta.value = text;
        }

        function switchPromptTab(tab) {
            currentPromptMode = tab;
            const modal = document.getElementById('prompt-modal');
            if (!modal) return;

            modal.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
            modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const order = ['full', 'manual', 'auto'];
            const idx = order.indexOf(tab);
            const btns = modal.querySelectorAll('.modal-tab-btn');
            if (btns[idx]) btns[idx].classList.add('active');

                        const panel = modal.querySelector(`#prompt-tab-${tab}`);
            if (panel) panel.classList.add('active');

            // Update copy button color
            const copyBtn = document.getElementById('btn-copy-prompt');
            if (copyBtn) {
                copyBtn.classList.remove('btn-mode-full', 'btn-mode-manual', 'btn-mode-auto');
                copyBtn.classList.add('btn-mode-' + (tab === 'json' ? 'auto' : tab));
            }
        }

        function copyCurrentPrompt() {
            copyPrompt(currentPromptMode);
        }

       function copyPrompt(type) {
           let prompt = "";
           const currentCode = editor.getValue();
           const instructionInput = document.getElementById('ai-instruction');
           const instruction = instructionInput.value;

           // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„æ–‡è¨€ã®æ§‹ç¯‰
           let securityConstraint = "";
           if (appSettings.secNoSend || appSettings.secNoRecv) {
               securityConstraint += "\nã€çµ¶å¯¾å³å®ˆäº‹é …ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„ã€‘\n";
               if (appSettings.secNoSend) securityConstraint += "ãƒ»å¤–éƒ¨ã‚µã‚¤ãƒˆã¸ã®æƒ…å ±é€ä¿¡ï¼ˆPOST, WebSocket, Beaconç­‰ï¼‰ã¯å³ç¦ã§ã™ã€‚\n";
               if (appSettings.secNoRecv) securityConstraint += "ãƒ»å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰ã®æƒ…å ±å–å¾—ï¼ˆFetch, XHR, CDN, Google Fonts, å¤–éƒ¨ç”»åƒç­‰ï¼‰ã¯å³ç¦ã§ã™ã€‚\n";
               securityConstraint += "ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºãŒã“ã‚Œã‚‰ã«åã™ã‚‹å ´åˆã€è¦æ±‚ã«ã¯å¿œãˆã‚‰ã‚Œãªã„æ—¨ã‚’å›ç­”ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³CSS/JSã€data URIç­‰ï¼‰ã®ä»£æ›¿æ¡ˆã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚\n";
           }

           const instructionText = (instruction || securityConstraint)
               ? `\nå…·ä½“çš„ãªæŒ‡ç¤º:\n${instruction}${securityConstraint}\n`
               : "";

           if (type === 'full') {
               prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ã€ä¿®æ­£ãƒ»æ”¹å–„ã—ãŸå®Œå…¨ãªãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆã¾ã‚‹ã”ã¨æ›´æ–°ç”¨ï¼‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\n1. å†’é ­ã«ã€ä¿®æ­£ç®‡æ‰€ãƒ»åˆ¶ç´„æ¡ä»¶ãƒ»æ”¹å–„ææ¡ˆã‚’ç°¡æ½”ãªã‚³ãƒ¡ãƒ³ãƒˆã§è¨˜è¿°ã€‚\n2. ãã®å¾Œã€ä¿®æ­£æ¸ˆã¿ã®å®Œå…¨ãªãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã€‚\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
           } else if (type === 'manual') {
               prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\nä¿®æ­£å¯¾è±¡ã®ç®‡æ‰€ã«ã¤ã„ã¦ã€ä¿®æ­£å‰(Before)ã¨ä¿®æ­£å¾Œ(After)ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¯¾ã«ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\nä¿®æ­£å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ¤œç´¢ã—ã¦ç‰¹å®šã§ãã‚‹ã‚ˆã†ã«ã€çœç•¥ã›ãšæ­£ç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
           } else if (type === 'auto' || type === 'json') {
               prompt = `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚${instructionText}\n\nå‡ºåŠ›å½¢å¼:\n1. ã¾ãšã€ä¿®æ­£æ–¹é‡ãƒ»åˆ¶ç´„ãƒ»æ”¹å–„æ¡ˆã‚’ç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚\n2. æ¬¡ã«ã€ã‚³ãƒ¼ãƒ‰ç½®æ›ç”¨ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ **Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯(\`\`\`json ... \`\`\`)** ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nJSONå½¢å¼:\n[\n  {\"search\": \"ä¿®æ­£å‰ã®ç½®æ›å¯¾è±¡(ä¸€æ„ã«ç‰¹å®šã§ãã‚‹é•·ã•)\", \"replace\": \"ä¿®æ­£å¾Œ\"}\n]\n\nå¯¾è±¡ã‚³ãƒ¼ãƒ‰:\n\`\`\`html\n${currentCode}\n\`\`\``;
           }

           const onCopy = () => {
               showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
               if (instruction) pendingAiInstruction = instruction;
               instructionInput.value = "";
               closeModal('prompt-modal');
           };

           navigator.clipboard.writeText(prompt).then(onCopy).catch(() => {
               const textArea = document.createElement("textarea");
               textArea.value = prompt;
               textArea.style.position = "fixed";
               textArea.style.left = "-9999px";
               document.body.appendChild(textArea);
               textArea.select();
               try {
                   document.execCommand('copy');
                   onCopy();
               } catch (e) {
                   alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
               }
               document.body.removeChild(textArea);
           });
       }


               // --- Full Update helpers ---
       async function pasteToFullInput() {
           try {
               const text = await navigator.clipboard.readText();
               const el = document.getElementById('full-code-input');
               if (el) el.value = text;
               showToast("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
           } catch (err) {
               showToast("è²¼ã‚Šä»˜ã‘å¤±æ•—: æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
           }
       }

       function clearFullInput() {
           const el = document.getElementById('full-code-input');
           if (el) el.value = "";
       }

       function applyFullUpdate() {
           const el = document.getElementById('full-code-input');
           const text = el ? String(el.value || '') : '';
           if (!text.trim()) return showToast("ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™");

           // overwrite confirm only if editor currently has content
           if (editor.getValue().trim().length > 0) {
               if (!confirm("ã€ç¢ºèªã€‘\nã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã™ã¹ã¦ç½®ãæ›ãˆã¾ã™ã€‚\nã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
           }

           editor.setValue(text);
           showToast("ã‚³ãƒ¼ãƒ‰ã‚’ã¾ã‚‹ã”ã¨æ›´æ–°ã—ã¾ã—ãŸ");
           if (el) el.value = "";
           closeModal('fix-modal');
       }

       // --- Auto(JSON) helpers ---
               async function pasteToJsonInput() {
           try {
               const text = await navigator.clipboard.readText();
               document.getElementById('json-input').value = text;
               showToast("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
               // valueä»£å…¥ã§ã¯inputã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ãŸã‚ã€æ˜ç¤ºçš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
               try { updateAutoPreview(true); } catch(e) {}
           } catch (err) {
               showToast("è²¼ã‚Šä»˜ã‘å¤±æ•—: æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
           }
       }


               function clearJsonInput() {
           document.getElementById('json-input').value = "";
           try { updateAutoPreview(true); } catch(e) {}
       }

       // --- Auto(JSON) Live Preview: å…¥åŠ›ç›´å¾Œã«ä¸€è‡´ä»¶æ•°ã‚’è¡¨ç¤º ---
       let autoPreviewTimer = null;
       function setAutoPreviewUI(type, lines) {
           const box = document.getElementById('auto-preview');
           const actions = document.getElementById('auto-preview-actions');
           if (!box) return;

           const msg = Array.isArray(lines) ? lines.join('\n') : String(lines || '');
           box.textContent = msg;

           // type: ok | warn | error | idle
           const styles = {
               ok:   { borderColor: 'rgba(76,175,80,0.6)',  color:'#cfead1', background:'rgba(76,175,80,0.08)' },
               warn: { borderColor: 'rgba(255,152,0,0.6)',  color:'#ffe2b8', background:'rgba(255,152,0,0.08)' },
               error:{ borderColor: 'rgba(244,67,54,0.65)', color:'#ffd0cc', background:'rgba(244,67,54,0.08)' },
               idle: { borderColor: '#444',                 color:'#aaa',    background:'rgba(0,0,0,0.25)' }
           };
           const s = styles[type] || styles.idle;
           box.style.borderColor = s.borderColor;
           box.style.color = s.color;
           box.style.background = s.background;

           if (actions) {
               actions.style.display = (type === 'error') ? 'flex' : 'none';
           }
       }

       function updateAutoPreview(immediate) {
           if (autoPreviewTimer) clearTimeout(autoPreviewTimer);
           autoPreviewTimer = setTimeout(() => {
               const inputEl = document.getElementById('json-input');
               if (!inputEl) return;
               let jsonStr = String(inputEl.value || '');
               if (!jsonStr.trim()) {
                   setAutoPreviewUI('idle', 'JSONã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è‡´ä»¶æ•°ã‚’è¡¨ç¤º');
                   return;
               }

               // --- Helpers (applyAutoFixã¨æ•´åˆã™ã‚‹å‰å‡¦ç†) ---
               const stripCodeFences = (s) => {
                   s = String(s || '');
                   const firstOpen = s.indexOf('[');
                   const lastClose = s.lastIndexOf(']');
                   if (firstOpen !== -1 && lastClose !== -1 && lastClose > firstOpen) {
                       s = s.substring(firstOpen, lastClose + 1);
                   } else {
                       s = s.replace(/^\s*```[a-zA-Z]*\s*/i, '').replace(/\s*```\s*$/i, '');
                   }
                   return s;
               };
               const stripWrappingFenceLines = (s) => {
                   s = String(s || '').replace(/\r\n/g, '\n');
                   s = s.replace(/^\s*```[a-zA-Z0-9_-]*\s*\n/, '');
                   s = s.replace(/\n\s*```\s*$/, '');
                   return s;
               };
               const decodeHtmlEntities = (s) => {
                   s = String(s || '');
                   const decodeOnce = (x) => {
                       const ta = document.createElement('textarea');
                       ta.innerHTML = x;
                       return ta.value;
                   };
                   const a = decodeOnce(s);
                   const b = decodeOnce(a);
                   return (b !== a) ? b : a;
               };
               const buildNormalizedWithMap = (src) => {
                   src = String(src || '');
                   const normChars = [];
                   const map = [];
                   let i = 0;
                   let lastWasSpace = false;
                   while (i <= src.length - 1) {
                       const ch = src[i];
                       // ignore runs of 2+ backticks
                       if (ch === '`') {
                           let j = i;
                           while (j < src.length && src[j] === '`') j++;
                           const run = j - i;
                           if (run >= 2) { i = j; continue; }
                       }
                       if (ch === ' ' || ch === '\n' || ch === '\t' || ch === '\r' || ch === '\f' || ch === '\v') {
                           if (!lastWasSpace) {
                               normChars.push(' ');
                               map.push(i);
                               lastWasSpace = true;
                           }
                           i++;
                           continue;
                       }
                       normChars.push(ch);
                       map.push(i);
                       lastWasSpace = false;
                       i++;
                   }
                   return { normalized: normChars.join(''), map };
               };
               const normalizeNeedle = (s) => {
                   const built = buildNormalizedWithMap(s);
                   return String(built.normalized).trim();
               };
               const findAll = (hay, needle) => {
                   const out = [];
                   if (!needle) return out;
                   let from = 0;
                   const maxHits = 200;
                   while (from <= hay.length) {
                       const idx = hay.indexOf(needle, from);
                       if (idx === -1) break;
                       out.push(idx);
                       from = idx + Math.max(1, needle.length);
                       if (out.length >= maxHits) break;
                   }
                   return out;
               };

               // --- Parse JSON ---
               let fixes;
               try {
                   fixes = JSON.parse(stripCodeFences(jsonStr));
               } catch (e) {
                   setAutoPreviewUI('error', [
                       'JSONå½¢å¼ã‚¨ãƒ©ãƒ¼: ãƒ‘ãƒ¼ã‚¹ã§ãã¾ã›ã‚“',
                       'â†’ â‘¢ ã‚ªãƒ¼ãƒˆ(JSON)ã§ã¯ãªãã€â‘  ã¾ã‚‹ã”ã¨æ›´æ–° / â‘¡ æ‰‹å‹•ä¿®æ­£ ã‚’æ¤œè¨'
                   ]);
                   return;
               }
               if (!Array.isArray(fixes)) {
                   setAutoPreviewUI('error', [
                       'JSONã‚¨ãƒ©ãƒ¼: é…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™',
                       'ä¾‹: [{"search":"...","replace":"..."}]',
                       'â†’ â‘¢ ãŒé›£ã—ã„å ´åˆã¯ â‘  ã¾ã‚‹ã”ã¨æ›´æ–° / â‘¡ æ‰‹å‹•ä¿®æ­£'
                   ]);
                   return;
               }

               // --- Preview simulate sequentially (applyAutoFixã¨åŒç­‰ã«è¿‘ã„åˆ¤å®š) ---
               let code = editor.getValue().replace(/\r\n/g, '\n');
               const lines = [];
               let okAll = true;
               let hasZero = false;
               let hasMulti = false;

               for (let k = 0; k < fixes.length; k++) {
                   const fx = fixes[k] || {};
                   let searchText = (fx.search !== undefined) ? fx.search : fx.before;
                   let replaceText = (fx.replace !== undefined) ? fx.replace : fx.after;

                   searchText = decodeHtmlEntities(stripWrappingFenceLines(searchText));
                   replaceText = decodeHtmlEntities(stripWrappingFenceLines(replaceText));

                   if (!String(searchText || '').trim()) {
                       okAll = false;
                       hasZero = true;
                       lines.push('Fix#' + (k+1) + ': search/before ãŒç©º');
                       continue;
                   }

                   const builtHay = buildNormalizedWithMap(code);
                   const hayNorm = builtHay.normalized;
                   const map = builtHay.map;
                   const needleNorm = normalizeNeedle(searchText);

                   if (!needleNorm) {
                       okAll = false;
                       hasZero = true;
                       lines.push('Fix#' + (k+1) + ': æ­£è¦åŒ–å¾Œã®æ¤œç´¢æ–‡å­—åˆ—ãŒç©º');
                       continue;
                   }

                   const hits = findAll(hayNorm, needleNorm);
                   const hitCount = hits.length;

                   if (hitCount === 0) {
                       okAll = false;
                       hasZero = true;
                       lines.push('Fix#' + (k+1) + ': ä¸€è‡´0ä»¶ï¼ˆã‚ªãƒ¼ãƒˆä¸å¯ï¼‰');
                       continue;
                   }
                   if (hitCount !== 1) {
                       okAll = false;
                       hasMulti = true;
                       lines.push('Fix#' + (k+1) + ': ä¸€è‡´' + hitCount + 'ä»¶ï¼ˆèª¤ç½®æ›é˜²æ­¢ï¼‰');
                       continue;
                   }

                   // hitCount === 1: apply virtually to keep later checks closer to reality
                   lines.push('Fix#' + (k+1) + ': ä¸€è‡´1ä»¶');
                   const normStart = hits[0];
                   const normEnd = normStart + needleNorm.length - 1;
                   const origStart = map[normStart];
                   const origEnd = map[normEnd];
                   if (origStart === undefined || origEnd === undefined || origStart > origEnd) {
                       okAll = false;
                       hasMulti = true;
                       lines.push('Fix#' + (k+1) + ': ä½ç½®å¾©å…ƒå¤±æ•—ï¼ˆèª¤ç½®æ›é˜²æ­¢ï¼‰');
                       continue;
                   }
                   code = code.slice(0, origStart) + String(replaceText || '') + code.slice(origEnd + 1);
               }

               if (hasZero) {
                   setAutoPreviewUI('error', [
                       'åˆ¤å®š: ã‚ªãƒ¼ãƒˆé©ç”¨ä¸å¯ï¼ˆä¸€è‡´0ä»¶ã‚’æ¤œå‡ºï¼‰',
                       ...lines,
                       'å¯¾å‡¦: â‘  ã¾ã‚‹ã”ã¨æ›´æ–°ï¼ˆãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰è²¼ä»˜ï¼‰ or â‘¡ æ‰‹å‹•ä¿®æ­£ï¼ˆæ¤œç´¢/ç½®æ›ï¼‰ã¸'
                   ]);
                   return;
               }

               if (hasMulti) {
                   setAutoPreviewUI('warn', [
                       'åˆ¤å®š: æ³¨æ„ï¼ˆè¤‡æ•°ä¸€è‡´ or åˆ¤å®šä¸èƒ½ã‚ã‚Šï¼‰',
                       ...lines,
                       'â†’ èª¤ç½®æ›é˜²æ­¢ã®ãŸã‚ã€â‘¢å®Ÿè¡Œæ™‚ã«æ‰‹å‹•ä¿®æ­£ã¸èª˜å°ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š'
                   ]);
                   return;
               }

               if (okAll) {
                   setAutoPreviewUI('ok', [
                       'åˆ¤å®š: ã‚ªãƒ¼ãƒˆé©ç”¨OKï¼ˆå…¨FixãŒä¸€è‡´1ä»¶ï¼‰',
                       ...lines
                   ]);
               } else {
                   setAutoPreviewUI('warn', [
                       'åˆ¤å®š: ä¸€éƒ¨æ³¨æ„ï¼ˆå®Œå…¨ã«ã¯ä¿è¨¼ä¸å¯ï¼‰',
                       ...lines
                   ]);
               }

           }, immediate ? 0 : 120);
       }

       // json-input å…¥åŠ›ã§å³æ™‚åˆ¤å®š & Manualå…¥åŠ›åˆ¤å®š
        (function(){
            // --- 1. JSON Auto Preview ---
            const elJson = document.getElementById('json-input');
            if (elJson) {
                elJson.addEventListener('input', () => updateAutoPreview(false));
                updateAutoPreview(true);
            }

            // --- 2. Manual Find Preview (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯) ---
            const elFind = document.getElementById('manual-find');
            const elFuzzy = document.getElementById('manual-fuzzy');
            
            const updateManualStatus = () => {
                const statusEl = document.getElementById('manual-match-status');
                if (!statusEl || !elFind) return;
                
                const val = elFind.value;
                if (!val) {
                    statusEl.style.display = 'none';
                    return;
                }

                // æ¤œç´¢å®Ÿè¡Œ
                const isFuzzy = elFuzzy ? elFuzzy.checked : false;
                const code = editor.getValue().replace(/\r\n/g, '\n');
                let count = 0;

                if (isFuzzy) {
                    // Helperé–¢æ•°ã‚’åˆ©ç”¨ã—ã¦Fuzzyæ¤œç´¢
                    const needle = decodeHtmlEntities(stripWrappingFenceLines(val));
                    const needleNorm = normalizeNeedle(needle);
                    if (!needleNorm) {
                        count = 0; 
                    } else {
                        const builtHay = buildNormalizedWithMap(code);
                        const hits = findAll(builtHay.normalized, needleNorm);
                        count = hits.length;
                    }
                } else {
                    // Strictæ¤œç´¢
                    if (val) {
                        count = code.split(val).length - 1;
                    }
                }

                // çµæœè¡¨ç¤º
                statusEl.style.display = 'block';
                statusEl.style.border = '1px solid currentColor';

                if (count === 0) {
                    statusEl.textContent = 'âŒ ä¸€è‡´ãªã—: ã“ã®ã‚³ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ”ãƒ¼ç¯„å›²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    statusEl.style.color = '#ffaaaa';
                    statusEl.style.background = 'rgba(255,0,0,0.15)';
                    statusEl.style.borderColor = '#ff5555';
                } else if (count === 1) {
                    statusEl.textContent = 'âœ… ä¸€è‡´: 1ä»¶ (OK) - æ­£å¸¸ã«ç½®æ›å¯èƒ½ã§ã™ã€‚';
                    statusEl.style.color = '#aaffaa';
                    statusEl.style.background = 'rgba(0,255,0,0.15)';
                    statusEl.style.borderColor = '#55ff55';
                } else {
                    statusEl.textContent = `âš ï¸ è­¦å‘Š: ${count}ä»¶ã®ä¸€è‡´ - è¤‡æ•°ç®‡æ‰€ã‚ã‚Šã¾ã™ã€‚æ„å›³ã—ãªã„ç®‡æ‰€ã¾ã§å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
                    statusEl.style.color = '#ffffaa';
                    statusEl.style.background = 'rgba(255,255,0,0.15)';
                    statusEl.style.borderColor = '#ffff55';
                }
            };

            if (elFind) elFind.addEventListener('input', updateManualStatus);
            if (elFuzzy) elFuzzy.addEventListener('change', updateManualStatus);
        })();


                       // --- Shared Helpers for Fix Tools ---
        const stripCodeFences = (s) => {
            s = String(s || '');
            const firstOpen = s.indexOf('[');
            const lastClose = s.lastIndexOf(']');
            if (firstOpen !== -1 && lastClose !== -1 && lastClose > firstOpen) {
                s = s.substring(firstOpen, lastClose + 1);
            } else {
                s = s.replace(/^\s*```[a-zA-Z]*\s*/i, '').replace(/\s*```\s*$/i, '');
            }
            return s;
        };
        const stripWrappingFenceLines = (s) => {
            s = String(s || '').replace(/\r\n/g, '\n');
            s = s.replace(/^\s*```[a-zA-Z0-9_-]*\s*\n/, '');
            s = s.replace(/\n\s*```\s*$/, '');
            return s;
        };
        const decodeHtmlEntities = (s) => {
            s = String(s || '');
            const decodeOnce = (x) => {
                const ta = document.createElement('textarea');
                ta.innerHTML = x;
                return ta.value;
            };
            const a = decodeOnce(s);
            const b = decodeOnce(a);
            return (b !== a) ? b : a;
        };
        const buildNormalizedWithMap = (src) => {
            src = String(src || '');
            const normChars = [];
            const map = [];
            let i = 0;
            let lastWasSpace = false;
            while (i < src.length) {
                const ch = src[i];
                if (ch === '`') {
                    let j = i;
                    while (j < src.length && src[j] === '`') j++;
                    if (j - i >= 2) { i = j; continue; }
                }
                if (' \n\t\r\f\v'.includes(ch)) {
                    if (!lastWasSpace) {
                        normChars.push(' ');
                        map.push(i);
                        lastWasSpace = true;
                    }
                    i++;
                    continue;
                }
                normChars.push(ch);
                map.push(i);
                lastWasSpace = false;
                i++;
            }
            return { normalized: normChars.join(''), map };
        };
        const normalizeNeedle = (s) => {
            const built = buildNormalizedWithMap(s);
            return String(built.normalized).trim();
        };
        const findAll = (hay, needle) => {
            const out = [];
            if (!needle) return out;
            let from = 0;
            const maxHits = 200;
            while (from <= hay.length) {
                const idx = hay.indexOf(needle, from);
                if (idx === -1) break;
                out.push(idx);
                from = idx + Math.max(1, needle.length);
                if (out.length >= maxHits) break;
            }
            return out;
        };

        function applyAutoFix() {
            let jsonStr = document.getElementById('json-input').value;
            if (!jsonStr || !jsonStr.trim()) return showToast("JSONãŒç©ºã§ã™");

            const guideToManual = (searchText, replaceText, reason) => {
                const mf = document.getElementById('manual-find');
                const mr = document.getElementById('manual-replace');
                if (mf) mf.value = String(searchText || '');
                if (mr) mr.value = String(replaceText || '');
                try { switchFixTab('manual'); } catch(e) {}
                showToast(reason || 'æ‰‹å‹•ä¿®æ­£ã¸è»¢è¨˜ã—ã¾ã—ãŸ');
            };

            jsonStr = stripCodeFences(jsonStr);
            let fixes;
            try { fixes = JSON.parse(jsonStr); } catch (e) { alert("JSONã‚¨ãƒ©ãƒ¼: " + e.message); return; }
            if (!Array.isArray(fixes)) { alert('JSONã¯é…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'); return; }

            let code = editor.getValue().replace(/\r\n/g, '\n');
            let count = 0;

            for (let k = 0; k < fixes.length; k++) {
                const fx = fixes[k] || {};
                let searchText = (fx.search !== undefined) ? fx.search : fx.before;
                let replaceText = (fx.replace !== undefined) ? fx.replace : fx.after;

                searchText = decodeHtmlEntities(stripWrappingFenceLines(searchText));
                replaceText = decodeHtmlEntities(stripWrappingFenceLines(replaceText));

                if (!String(searchText || '').trim()) {
                    guideToManual(searchText, replaceText, `Fix#${k+1}: search/before ãŒç©ºã§ã™`);
                    return;
                }

                const builtHay = buildNormalizedWithMap(code);
                const needleNorm = normalizeNeedle(searchText);
                if (!needleNorm) {
                    guideToManual(searchText, replaceText, `Fix#${k+1}: æ­£è¦åŒ–å¾Œã®æ¤œç´¢æ–‡å­—åˆ—ãŒç©ºã§ã™`);
                    return;
                }

                const hits = findAll(builtHay.normalized, needleNorm);
                if (hits.length !== 1) {
                    guideToManual(searchText, replaceText, `Fix#${k+1}: ä¸€è‡´${hits.length}ä»¶ï¼ˆæ‰‹å‹•ä¿®æ­£ã¸ï¼‰`);
                    return;
                }

                const normStart = hits[0];
                const normEnd = normStart + needleNorm.length - 1;
                const origStart = builtHay.map[normStart];
                const origEnd = builtHay.map[normEnd];

                if (origStart === undefined || origEnd === undefined || origStart > origEnd) {
                    guideToManual(searchText, replaceText, `Fix#${k+1}: ä½ç½®å¾©å…ƒã«å¤±æ•—ï¼ˆæ‰‹å‹•ä¿®æ­£ã¸ï¼‰`);
                    return;
                }

                code = code.slice(0, origStart) + String(replaceText || '') + code.slice(origEnd + 1);
                count++;
            }

            editor.setValue(code);
            showToast(`${count}ç®‡æ‰€ã®ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸ\n(å½¢å¼ã‚†ã‚‰ãè‡ªå‹•è£œæ­£)`);
            document.getElementById('json-input').value = "";
            closeModal('fix-modal');
        }

                        function clearManualInput() {
            const mf = document.getElementById('manual-find');
            const mr = document.getElementById('manual-replace');
            if (mf) mf.value = "";
            if (mr) mr.value = "";
        }

        // â˜… New Helper: é¡ä¼¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¡Œç•ªå·ã§ææ¡ˆ
        function findSmartSuggestion(needle) {
            if (!needle) return null;
            const code = editor.getValue();
            // æ­£è¦åŒ–ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
            const hayObj = buildNormalizedWithMap(code);
            // needleã‚‚æ­£è¦åŒ–ï¼ˆFuzzyç”¨ãƒ­ã‚¸ãƒƒã‚¯æµç”¨ï¼‰
            const needleRaw = decodeHtmlEntities(stripWrappingFenceLines(needle));
            const ndlObj = buildNormalizedWithMap(needleRaw);
            
            const ndl = ndlObj.normalized;
            if (ndl.length < 10) return null; // çŸ­ã™ãã‚‹å ´åˆã¯åˆ¤å®šã—ãªã„

            // æŒ‡ç¤ºé€šã‚Šã€Œæœ€åˆã®2è¡Œã€æœ€å¾Œã®2è¡Œã€ç›¸å½“ã®ç‰¹å¾´é‡ã‚’æ¢ã™
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œæ­£è¦åŒ–å¾Œã®å…ˆé ­50æ–‡å­—ã€ã¨ã€Œæœ«å°¾50æ–‡å­—ã€ã‚’ä½¿ç”¨
            const checkLen = Math.min(Math.floor(ndl.length / 2), 50);
            
            const head = ndl.slice(0, checkLen);
            const tail = ndl.slice(-checkLen);
            
            // headã‚’æ¢ã™
            const headIdx = hayObj.normalized.indexOf(head);
            if (headIdx === -1) return null;
            
            // tailã‚’æ¢ã™ (headã‚ˆã‚Šå¾Œã‚ã«ã‚ã‚‹ã‹ï¼Ÿ)
            // å¤šå°‘å¤‰æ›´ã•ã‚Œã¦ã„ã¦ã‚‚ãƒ’ãƒƒãƒˆã—ã‚„ã™ã„ã‚ˆã†ã€æœ«å°¾ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œç´¢
            const tailIdx = hayObj.normalized.lastIndexOf(tail);
            
            // tailãŒè¦‹ã¤ã‹ã‚Šã€ã‹ã¤headã‚ˆã‚Šå¾Œã‚ãªã‚‰ã€Œå€™è£œã€ã¨ã¿ãªã™
            if (tailIdx !== -1 && tailIdx > headIdx) {
                 const startPos = hayObj.map[headIdx];
                 // tailã®æœ«å°¾ä½ç½®
                 const endPos = hayObj.map[tailIdx + tail.length - 1];
                 
                 // è¡Œç•ªå·è¨ˆç®—
                 const pre = code.slice(0, startPos);
                 const startLine = (pre.match(/\n/g) || []).length + 1;
                 
                 const body = code.slice(startPos, endPos);
                 const linesInBody = (body.match(/\n/g) || []).length;
                 const endLine = startLine + linesInBody;
                 
                 return { startLine, endLine };
            }
            return null;
        }

        function applyManualFix() {
            const findText = document.getElementById('manual-find').value;
            const replaceText = document.getElementById('manual-replace').value;
            const isFuzzy = document.getElementById('manual-fuzzy') ? document.getElementById('manual-fuzzy').checked : false;

            if (!findText) return showToast("æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            let code = editor.getValue().replace(/\r\n/g, '\n');
            let success = false;

            if (isFuzzy) {
                // Fuzzy search
                const needle = decodeHtmlEntities(stripWrappingFenceLines(findText));
                const cleanReplace = decodeHtmlEntities(stripWrappingFenceLines(replaceText));
                const needleNorm = normalizeNeedle(needle);

                if (!needleNorm) return showToast("æ¤œç´¢æ–‡å­—åˆ—ãŒç©º(æ­£è¦åŒ–å¾Œ)ã§ã™");

                const builtHay = buildNormalizedWithMap(code);
                const hits = findAll(builtHay.normalized, needleNorm);

                if (hits.length > 0) {
                    let newCode = code;
                    let replaceCount = 0;
                    for (let i = hits.length - 1; i >= 0; i--) {
                        const normStart = hits[i];
                        const normEnd = normStart + needleNorm.length - 1;
                        const origStart = builtHay.map[normStart];
                        const origEnd = builtHay.map[normEnd];
                        if (origStart !== undefined && origEnd !== undefined && origEnd >= origStart) {
                            newCode = newCode.slice(0, origStart) + cleanReplace + newCode.slice(origEnd + 1);
                            replaceCount++;
                        }
                    }
                    editor.setValue(newCode);
                    showToast(replaceCount + "ç®‡æ‰€ ç½®æ›ã—ã¾ã—ãŸ(Fuzzy)");
                    closeModal('fix-modal');
                    success = true;
                }
            } else {
                // Strict search
                if (code.includes(findText)) {
                    const newCode = code.split(findText).join(replaceText);
                    editor.setValue(newCode);
                    showToast("ç½®æ›ã—ã¾ã—ãŸ");
                    closeModal('fix-modal');
                    success = true;
                }
            }

            // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ã‚¹ãƒãƒ¼ãƒˆææ¡ˆ
            if (!success) {
                const suggestion = findSmartSuggestion(findText);
                if (suggestion) {
                    alert(`å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€é¡ä¼¼ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ï¼\n\nã‚‚ã—ã‹ã—ã¦ï¼š ${suggestion.startLine}è¡Œ ï½ ${suggestion.endLine}è¡Œ ã‹ã‚‚ï¼\n\nã‚¨ãƒ‡ã‚£ã‚¿ã§ãã®ä»˜è¿‘ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚`);
                } else {
                    showToast(isFuzzy ? "å¯¾è±¡æ–‡å­—åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ(Fuzzy)" : "å¯¾è±¡æ–‡å­—åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                }
            }
        }

               // --- Run Logic ---
       // Ensure preview iframes exist & are visible
       function ensurePreviewFrames() {
           let f = document.getElementById('app-frame');
           let ff = document.getElementById('app-frame-full');

           // If viewer pane exists, make sure it can host a flex child
           const viewerPane = document.getElementById('viewer-pane');
           if (viewerPane) {
               // viewer pane should be a flex column to allow iframe flex:1
               const cs = window.getComputedStyle(viewerPane);
               if (cs.display !== 'flex') viewerPane.style.display = 'flex';
               viewerPane.style.flexDirection = 'column';
               viewerPane.style.minHeight = '0';
           }

           // Create missing iframes
           if (!f) {
               f = document.createElement('iframe');
               f.id = 'app-frame';
               f.style.flex = '1';
               f.style.width = '100%';
               f.style.border = 'none';
               f.style.background = '#fff';
               // allow scripts for preview, keep it sandboxed
               f.setAttribute('sandbox', 'allow-scripts allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox');
               f.setAttribute('referrerpolicy', 'no-referrer');

               (viewerPane || document.body).appendChild(f);
           }

           if (!ff) {
               ff = document.createElement('iframe');
               ff.id = 'app-frame-full';
               ff.style.flex = '1';
               ff.style.width = '100%';
               ff.style.border = 'none';
               ff.style.background = '#fff';
               ff.style.display = 'none';
               ff.setAttribute('sandbox', 'allow-scripts allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox');
               ff.setAttribute('referrerpolicy', 'no-referrer');

               (viewerPane || document.body).appendChild(ff);
           }

           return { f, ff };
       }

       function runCode() {
           let code = editor.getValue();
           if(!code.trim()) {
               showToast("ã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™");
               return;
           }

           // Inject Security + Debug Script (OFFLINE / No external)
           const securityScript = (() => {
               const noSend = !!(appSettings && appSettings.secNoSend);
               const noRecv = !!(appSettings && appSettings.secNoRecv);
               if (!noSend && !noRecv) return '';

               return `
<script>
(function(){
 try {
   const deny = function(name){
     return function(){ throw new Error('Blocked by AppStudio Security: ' + name); };
   };

   // å¤–éƒ¨é€ä¿¡ã®ä»£è¡¨API
   if (${noSend}) {
     if (navigator && navigator.sendBeacon) navigator.sendBeacon = deny('sendBeacon');
     if (window.WebSocket) window.WebSocket = deny('WebSocket');
   }

   // å¤–éƒ¨å–å¾—/é€ä¿¡ã®ä»£è¡¨API
   if (${noRecv} || ${noSend}) {
     if (window.fetch) window.fetch = deny('fetch');
     if (window.XMLHttpRequest) {
       const X = window.XMLHttpRequest;
       window.XMLHttpRequest = function(){
         const x = new X();
         const open = x.open;
         x.open = function(method, url){
           const u = String(url || '');
           if (/^https?:\/\//i.test(u)) throw new Error('Blocked by AppStudio Security: XHR ' + u);
           return open.apply(this, arguments);
         };
         return x;
       };
     }
     if (window.EventSource) window.EventSource = deny('EventSource');
   }

   // å¤–éƒ¨script/link ã®è¿½åŠ ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆCDNå¯¾ç­–ï¼‰
   const guardUrlAttr = function(el, attr){
     const v = el.getAttribute(attr);
     if (!v) return;
     if (/^https?:\/\//i.test(v)) throw new Error('Blocked by AppStudio Security: ' + attr + ' ' + v);
   };

   const origAppend = Element.prototype.appendChild;
   Element.prototype.appendChild = function(child){
     if (child && child.tagName) {
       const tag = String(child.tagName).toLowerCase();
       if (tag === 'script') guardUrlAttr(child, 'src');
       if (tag === 'link') guardUrlAttr(child, 'href');
     }
     return origAppend.call(this, child);
   };
 } catch(e) {
   console && console.error && console.error(e);
 }
})();
<\/script>`;
           })();

           const debugScript = `
<script>
(function(){
 const send = (type, args) => {
   try {
     window.parent.postMessage({
       type: 'console',
       level: type,
       args: Array.from(args).map(a => String(a))
     }, '*');
   } catch(e) {}
 };
 const originalLog = console.log;
 const originalError = console.error;
 console.log = function(...args){ originalLog.apply(console, args); send('log', args); };
 console.error = function(...args){ originalError.apply(console, args); send('error', args); };
 window.onerror = function(msg, url, line){ send('error', [msg + " (Line: " + line + ")"]); };
})();
<\/script>`;

                       // Inject into <head> if present (robust: real tags / entity-escaped)
           // 1) é€šå¸¸ã® <head> ã«æŒ¿å…¥
           if (/<head[^>]*>/i.test(code)) {
               code = code.replace(/<head[^>]*>/i, (m) => m + securityScript + debugScript);
           }
           // 2) ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆ (<head>) ã«æŒ¿å…¥
           else if (/<head[^>]*>/i.test(code)) {
               code = code.replace(/<head[^>]*>/i, (m) => m + securityScript + debugScript);
           }
           // 3) head ãŒç„¡ã„å ´åˆã¯å…ˆé ­ã«ä»˜ä¸
           else {
               code = securityScript + debugScript + code;
           }

           // Split-view: update right viewer immediately
           const frames = ensurePreviewFrames();
           const f = frames && frames.f ? frames.f : document.getElementById('app-frame');
           const ff = frames && frames.ff ? frames.ff : document.getElementById('app-frame-full');

           // Force repaint: éåŒæœŸã‚»ãƒƒãƒˆã§ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºå®Ÿã«ãƒˆãƒªã‚¬ãƒ¼
           const update = (fr, c) => {
               if(!fr) return;
               fr.removeAttribute('srcdoc');
               setTimeout(() => fr.setAttribute('srcdoc', c), 0);
           };
           update(f, code);
           update(ff, code);

           showToast("å®Ÿè¡Œã—ã¾ã—ãŸ");
       }

                       function reloadFrame() {
           const code = editor.getValue();
           const frames = ensurePreviewFrames();
           const f = frames && frames.f ? frames.f : document.getElementById('app-frame');
           const ff = frames && frames.ff ? frames.ff : document.getElementById('app-frame-full');

           const update = (fr, c) => {
               if(!fr) return;
               fr.removeAttribute('srcdoc');
               setTimeout(() => fr.setAttribute('srcdoc', c), 0);
           };
           update(f, code);
           update(ff, code);
       }

       function runInNewWindow() {
           const code = editor.getValue();
           const win = window.open("", "_blank");
           if(win) {
               win.document.open();
               win.document.write(code);
               win.document.close();
           } else {
               showToast("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
           }
       }

       // --- Split toggle ---
       let isEditorHidden = false;
       function toggleEditor(force) {
           isEditorHidden = (force !== undefined) ? !!force : !isEditorHidden;
           document.body.classList.toggle('editor-hidden', isEditorHidden);

           const btn = document.getElementById('toggle-editor-btn');
           if (btn) {
               const span = btn.querySelector('span');
               if (span) span.textContent = isEditorHidden ? 'â¡ï¸ ã‚¨ãƒ‡ã‚£ã‚¿è¡¨ç¤º' : 'â¬…ï¸ ã‚¨ãƒ‡ã‚£ã‚¿ã‚’éš ã™';
           }
       }

       // --- Navigation Logic ---
       function switchTab(tabName) {
           document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
           const index = ['editor', 'run', 'library', 'help'].indexOf(tabName);
           if (document.querySelectorAll('.tab-btn')[index]) {
               document.querySelectorAll('.tab-btn')[index].classList.add('active');
           }

           document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
           document.getElementById(`view-${tabName}`).classList.add('active');

           if(tabName === 'library') {
               renderLibrary();
           }
                       if(tabName === 'run') {
               const code = editor.getValue();
               const ff = document.getElementById('app-frame-full');
               if (ff) ff.srcdoc = code;
           }
       }

               // --- Save / Export Logic ---
              function openSaveModal() {
            document.getElementById('save-modal').style.display = 'flex';

            // ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const mi = String(now.getMinutes()).padStart(2, '0');
            const ts = `${y}${m}${d}_${h}${mi}`;

            if (devMode === 'project' && projectFolderName) {
                // â‘  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå_yyyymmdd_hhmm
                filenameInput.value = `${projectFolderName}_${ts}`;
            } else if (currentAppName) {
                // â‘¡ å˜ä½“ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Šï¼‰: æ—¢å­˜å
                filenameInput.value = currentAppName;
            } else {
                // å˜ä½“ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°è¦ï¼‰: App_yyyymmdd_hhmm
                filenameInput.value = `App_${ts}`;
            }

           // button label by mode
           const btn = document.getElementById('save-main-btn');
           if (btn) {
               if (devMode === 'project') {
                   btn.textContent = projectDirHandle ? 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜(æ–°è¦ç‰ˆ)' : 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ';
                   btn.style.background = projectDirHandle ? 'var(--accent-color)' : '#555';
                   btn.disabled = !projectDirHandle;
                   btn.style.opacity = projectDirHandle ? '1' : '0.6';
                   btn.style.cursor = projectDirHandle ? 'pointer' : 'not-allowed';
               } else {
                   btn.textContent = 'ä¿å­˜(å˜ç™º)';
                   btn.style.background = 'var(--accent-color)';
                   btn.disabled = false;
                   btn.style.opacity = '1';
                   btn.style.cursor = 'pointer';
               }
           }
       }


       function closeModal(id) {
           document.getElementById(id).style.display = 'none';
       }

               // --- Project / Local FS Logic (NO IndexedDB library) ---
       async function saveCurrent() {
           const code = editor.getValue();
           if(!code.trim()) {
               showToast("ä¿å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“");
               closeModal('save-modal');
               return;
           }

           if (devMode !== 'project') {
               // å˜ç™ºãƒ¢ãƒ¼ãƒ‰: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
               downloadHTML();
               return;
           }

           if (!projectDirHandle) {
               showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ");
               return;
           }

           try {
               // Permission (Chromium)
               if (projectDirHandle.requestPermission) {
                   const perm = await projectDirHandle.requestPermission({ mode: 'readwrite' });
                   if (perm !== 'granted') {
                       showToast("ãƒ•ã‚©ãƒ«ãƒ€æ¨©é™ãŒå¿…è¦ã§ã™");
                       return;
                   }
               }

               const base = (filenameInput.value || currentAppName || 'app').replace(/[\\\\/:*?"<>|]/g,'_');
               const ts = (() => {
                   const d = new Date();
                   const y = d.getFullYear();
                   const m = String(d.getMonth()+1).padStart(2,'0');
                   const da = String(d.getDate()).padStart(2,'0');
                   const h = String(d.getHours()).padStart(2,'0');
                   const mi = String(d.getMinutes()).padStart(2,'0');
                   const s = String(d.getSeconds()).padStart(2,'0');
                   return `${y}${m}${da}_${h}${mi}${s}`;
               })();

                               const fileName = `${base}_${ts}.html`;

               // ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§AIæŒ‡ç¤ºã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«ç´ä»˜ã‘ã¦è¨˜éŒ²ï¼ˆæŒ‡å®š: ä¿å­˜ã§FIXï¼‰
               addAiHistoryForFile(fileName, pendingAiInstruction);
               pendingAiInstruction = "";

               const fileHandle = await projectDirHandle.getFileHandle(fileName, { create: true });
               const writable = await fileHandle.createWritable();
               await writable.write(code);
               await writable.close();


               currentProjectFileName = fileName;
               currentAppName = base;
               appNameDisplay.textContent = `${fileName} (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectFolderName})`;

               await refreshProjectList();
               showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸ");
               closeModal('save-modal');
           } catch (e) {
               alert("ä¿å­˜ã«å¤±æ•—: " + e.message);
           }
       }


               async function refreshProjectList() {
           if (!projectDirHandle || !projectList) return;

           // æ¨©é™ï¼ˆç’°å¢ƒå·®ãŒå¤§ãã„ã®ã§ requestPermission ã‚’å„ªå…ˆï¼‰
           try {
               if (projectDirHandle.requestPermission) {
                   const r = await projectDirHandle.requestPermission({ mode: 'read' });
                   if (r !== 'granted') {
                       showToast('ãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿å–ã‚Šæ¨©é™ãŒå¿…è¦ã§ã™');
                       return;
                   }
               } else if (projectDirHandle.queryPermission && projectDirHandle.requestPermission) {
                   const q = await projectDirHandle.queryPermission({ mode: 'read' });
                   if (q !== 'granted') {
                       const r2 = await projectDirHandle.requestPermission({ mode: 'read' });
                       if (r2 !== 'granted') {
                           showToast('ãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿å–ã‚Šæ¨©é™ãŒå¿…è¦ã§ã™');
                           return;
                       }
                   }
               }
           } catch (e) {
               // æ¨©é™APIæœªå¯¾å¿œ/ä¾‹å¤–ã¯ç„¡è¦–ã—ã¦ç¶™ç¶šï¼ˆåˆ—æŒ™å´ã§æ‹¾ãˆã‚‹ç’°å¢ƒã‚‚ã‚ã‚‹ï¼‰
           }

           projectList.innerHTML = '';
           if (projectTitle) projectTitle.textContent = projectFolderName ? `ğŸ“ ${projectFolderName}` : "(ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ)";

           const items = [];

           // kind ãŒç„¡ã„å®Ÿè£…ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«åˆ¤å®šã‚’å¼·åŒ–
           const addIfHtmlFile = async (name, handle) => {
               if (!handle) return;
               const fileName = String(name || handle.name || '');
               if (!/\.html?$/i.test(fileName)) return;

               // handle.kind ãŒç„¡ã„å ´åˆã¯ getFile() ã®æœ‰ç„¡ã§ file æ‰±ã„
               const kind = handle.kind || (typeof handle.getFile === 'function' ? 'file' : '');
               if (kind !== 'file') return;

               try {
                   const file = await handle.getFile();
                   items.push({ name: fileName, lastModified: file.lastModified, size: file.size });
               } catch (e) {
                   // 1ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘å¤±æ•—ã—ã¦ã‚‚å…¨ä½“ã¯ç¶™ç¶š
               }
           };

           // åˆ—æŒ™ï¼ˆentries ã‚’ç¬¬ä¸€å€™è£œã€‚å¤±æ•—ã—ãŸã‚‰ values / asyncIterator ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
           let enumerated = false;

           if (projectDirHandle.entries) {
               try {
                   for await (const pair of projectDirHandle.entries()) {
                       // pair ã¯é€šå¸¸ [name, handle]
                       if (Array.isArray(pair)) {
                           await addIfHtmlFile(pair[0], pair[1]);
                       } else {
                           // å¿µã®ãŸã‚
                           const h = pair;
                           await addIfHtmlFile(h && h.name ? h.name : '', h);
                       }
                   }
                   enumerated = true;
               } catch (e) {
                   // æ¬¡ã®æ‰‹æ®µã¸
               }
           }

           if (!enumerated && projectDirHandle.values) {
               try {
                   for await (const h of projectDirHandle.values()) {
                       await addIfHtmlFile(h && h.name ? h.name : '', h);
                   }
                   enumerated = true;
               } catch (e) {
                   // æ¬¡ã®æ‰‹æ®µã¸
               }
           }

           if (!enumerated && projectDirHandle[Symbol.asyncIterator]) {
               try {
                   for await (const entry of projectDirHandle) {
                       // ç’°å¢ƒã«ã‚ˆã‚Š [name, handle] / handle ãŒæ··åœ¨ã—å¾—ã‚‹
                       if (Array.isArray(entry)) {
                           await addIfHtmlFile(entry[0], entry[1]);
                       } else {
                           const h = entry;
                           await addIfHtmlFile(h && h.name ? h.name : '', h);
                       }
                   }
                   enumerated = true;
               } catch (e) {
                   // æœ€å¾Œã¾ã§å¤±æ•—
               }
           }

           if (!enumerated) {
               showToast('ã“ã®ç’°å¢ƒã§ã¯ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§å–å¾—ãŒæœªå¯¾å¿œã§ã™');
               return;
           }

           items.sort((a, b) => (b.lastModified || 0) - (a.lastModified || 0));

           if (items.length === 0) {
               const empty = document.createElement('div');
               empty.style.textAlign = 'center';
               empty.style.color = '#666';
               empty.style.marginTop = '30px';
               empty.textContent = 'HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“';
               projectList.appendChild(empty);
               return;
           }

           items.forEach(it => {
               const tile = document.createElement('div');
               tile.className = 'project-tile';

               const title = document.createElement('div');
               title.className = 'project-tile-title';
               title.textContent = it.name;

               const meta = document.createElement('div');
               meta.className = 'project-tile-meta';
               meta.textContent = `${new Date(it.lastModified).toLocaleString()} | ${it.size} bytes`;

                               tile.appendChild(title);
               tile.appendChild(meta);

               // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ¡ãƒ¢ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ‰‹å‹•ç·¨é›† / localStorageä¿å­˜ï¼‰
               const summary = getLatestAiInstructionSummary(it.name);
               const memo = getProjectFileMemo(it.name);

               const hist = document.createElement('div');
               hist.className = 'lib-history';

               // è¤‡æ•°è¡Œè¡¨ç¤ºå‘ã‘ã«æ•´å½¢ã›ãšãã®ã¾ã¾ã‚»ãƒƒãƒˆï¼ˆCSSã§åˆ¶é™ï¼‰
               const displayText = memo || summary || '';
               hist.textContent = displayText ? `ğŸ“ ${displayText}` : 'ğŸ“ (ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¢/å±¥æ­´)';
               hist.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¢ç·¨é›† & å±¥æ­´ç¢ºèª';

               // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ã¯å»ƒæ­¢ï¼‰
               hist.addEventListener('click', (ev) => {
                   ev.stopPropagation(); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³é˜»æ­¢
                   openHistoryForFile(it.name);
               });

               tile.appendChild(hist);

               tile.addEventListener('click', () => loadProjectFile(it.name));

               projectList.appendChild(tile);

           });
       }





       async function loadProjectFile(fileName) {
           if (!projectDirHandle) return;
           try {
               const handle = await projectDirHandle.getFileHandle(fileName);
               const file = await handle.getFile();
               const text = await file.text();
               editor.setValue(text);

               // â˜… ã“ã“ã§å³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠï¼èª­ã¿è¾¼ã¿ç›´å¾Œã«å³å´ã¸åæ˜ ï¼‰
               try { reloadFrame(); } catch(e) {}

               currentProjectFileName = fileName;
               currentAppName = fileName.replace(/\.html?$/i,'');
               filenameInput.value = currentAppName;
               appNameDisplay.textContent = `${fileName} (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectFolderName})`;
               showToast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
           } catch (e) {
               alert("èª­è¾¼ã«å¤±æ•—: " + e.message);
           }
       }



       function downloadHTML() {
           const name = filenameInput.value || "index";
           const code = editor.getValue();
           const blob = new Blob([code], { type: 'text/html' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `${name}.html`;
           document.body.appendChild(a);
           a.click();
           document.body.removeChild(a);
           URL.revokeObjectURL(url);
           closeModal('save-modal');
       }

       async function uploadToGitHub() {
           // [SECURITY] å¤–éƒ¨ã¸ã®æƒ…å ±ä¼é€ç¦æ­¢ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–
           showToast("å¤–éƒ¨é€šä¿¡ç¦æ­¢: GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ç„¡åŠ¹ã§ã™");
           alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„ã«ã‚ˆã‚Šã€å¤–éƒ¨é€ä¿¡ï¼ˆGitHub APIå«ã‚€ï¼‰ã¯ç„¡åŠ¹ã§ã™ã€‚å¿…è¦ãªã‚‰HTML DLã§ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
           return;
       }


       // --- Speech Recognition ---
       let recognition = null;
       let isRecording = false;

               function toggleSpeechRecognition() {
           // å¤–éƒ¨é€šä¿¡ãƒªã‚¹ã‚¯ã®ãŸã‚ç„¡åŠ¹åŒ–
           showToast("å¤–éƒ¨é€šä¿¡ãƒªã‚¹ã‚¯ã®ãŸã‚éŸ³å£°èªè­˜ã¯ç„¡åŠ¹ã§ã™");
           return;
       }

       // Add mic animation style
       const style = document.createElement('style');
       style.innerHTML = `@keyframes pulse-mic { 0% { background: rgba(255, 0, 0, 0.1); } 50% { background: rgba(255, 0, 0, 0.4); } 100% { background: rgba(255, 0, 0, 0.1); } }`;
       document.head.appendChild(style);

       // --- Utilities ---
       function showToast(msg) {
           notification.textContent = msg;
           notification.style.opacity = '1';
           setTimeout(() => {
               notification.style.opacity = '0';
           }, 2000);
       }

       function escapeHtml(text) {
           return String(text)
               .replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
       }

       // Listen for console messages from iframe
       window.addEventListener('message', (event) => {
           if (event.data && event.data.type === 'console') {
               const msg = `[${String(event.data.level).toUpperCase()}] ${event.data.args.join(' ')}`;
               showToast(msg);
           }
       });

                       // Initialize
        updateStats();
        
        // è¡Œç•ªå·ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ
        if (textarea) {
            textarea.addEventListener('scroll', () => {
                const ln = document.getElementById('line-numbers');
                if (ln) ln.scrollTop = textarea.scrollTop;
            });
        }

        // è¨­å®šï¼ˆè¦ªãƒ•ã‚©ãƒ«ãƒ€ï¼‰èª­è¾¼
       (async () => {
           try {
               await loadProjectRootFromDb();
               updateSettingsUI();
           } catch (e) {}
       })();
   </script>











<script id="lfs-meta" type="application/json">
{
  "appId": "1ab9695302b5fa805ebca5816ec2c732",
  "createdAt": "2026-01-22T14:15:09.711Z",
  "schema": 2,
  "title": "AppStudioMobile v2",
  "savedAt": "2026-01-22T23:22:54.547Z",
  "aiInstruction": "æ‰‹å‹•ä¿®æ­£æ™‚ã€ãŠã‚ˆã³ã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œæ¤œç´¢ãƒ»ç½®æ›ã€æ™‚ã«ã€ã´ã£ãŸã‚Šå½“ã¦ã¯ã¾ã‚‹æ¤œç´¢å¯¾è±¡ãŒãªã„å ´åˆ\nã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®ï¼’è¡Œã¨ã€æœ€å¾Œã®ï¼’è¡Œã‚’ã‚‚ã¨ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã€\nã€Œã‚‚ã—ã‹ã—ã¦ï¼šï¼Šï¼Šï¼Šï¼Šè¡Œï½ï¼Šï¼Šï¼Šï¼Šè¡Œã€€ã‹ã‚‚ï¼ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨è¡¨ç¤ºã—ã€ä¿®æ­£ã‚’ã‚¬ã‚¤ãƒ‰ã€‚\n\nã¾ãŸã€ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ã¯ã€æœ€åˆã«ã“ã®ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸå ´åˆã¯ã€éè¡¨ç¤ºã¨ã™ã‚‹ã€‚è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’è¨˜æ†¶ã—ã€æ¬¡å›é–‹ã„ãŸã¨ãåæ˜ ã™ã‚‹ã€‚\n\næ‰‹å‹•ä¿®æ­£æ™‚ã€ãŠã‚ˆã³ã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œæ¤œç´¢ãƒ»ç½®æ›ã€æ™‚ã«ã€ã´ã£ãŸã‚Šå½“ã¦ã¯ã¾ã‚‹æ¤œç´¢å¯¾è±¡ãŒãªã„å ´åˆ\n\nã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®ï¼’è¡Œã¨ã€æœ€å¾Œã®ï¼’è¡Œã‚’ã‚‚ã¨ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã€\n\nã€Œã‚‚ã—ã‹ã—ã¦ï¼šï¼Šï¼Šï¼Šï¼Šè¡Œï½ï¼Šï¼Šï¼Šï¼Šè¡Œã€€ã‹ã‚‚ï¼ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨è¡¨ç¤ºã—ã€ä¿®æ­£ã‚’ã‚¬ã‚¤ãƒ‰ã€‚\n\næ‰‹å‹•ä¿®æ­£æ™‚ã€ä¿®æ­£ç®‡æ‰€ã‚’ã‚³ãƒ”ãƒšã—ãŸæ®µéšã§ã‚³ãƒ¼ãƒ‰ã¨ã®æ•´åˆã‚’èª¿ã¹ã€ä¿®æ­£ç®‡æ‰€ãŒã¿ã¤ã‹ã£ãŸã‚‰ã€ãã®æ—¨è¡¨ç¤ºã€‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã‚‚è¡¨ç¤ºã€‚è¤‡æ•°ç®‡æ‰€ã‚ã‚‹å ´åˆã€è­¦å‘Šã‚’ã ã—ã¦ã€‚",
  "comment": "æ‰‹å‹•ä¿®æ­£æ™‚ã€ãŠã‚ˆã³ã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œæ¤œç´¢ãƒ»ç½®æ›ã€æ™‚ã«ã€ã´ã£ãŸã‚Šå½“ã¦ã¯ã¾ã‚‹æ¤œç´¢å¯¾è±¡ãŒãªã„å ´åˆ\nã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®ï¼’è¡Œã¨ã€æœ€å¾Œã®ï¼’è¡Œã‚’ã‚‚ã¨ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã€\nã€Œã‚‚ã—ã‹ã—ã¦ï¼šï¼Šï¼Šï¼Šï¼Šè¡Œï½ï¼Šï¼Šï¼Šï¼Šè¡Œã€€ã‹ã‚‚ï¼ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨è¡¨ç¤ºã—ã€ä¿®æ­£ã‚’ã‚¬ã‚¤ãƒ‰ã€‚\n\nã¾ãŸã€ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ã¯ã€æœ€åˆã«ã“ã®ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸå ´åˆã¯ã€éè¡¨ç¤ºã¨ã™ã‚‹ã€‚è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’è¨˜æ†¶ã—ã€æ¬¡å›é–‹ã„ãŸã¨ãåæ˜ ã™ã‚‹ã€‚\n\næ‰‹å‹•ä¿®æ­£æ™‚ã€ãŠã‚ˆã³ã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œæ¤œç´¢ãƒ»ç½®æ›ã€æ™‚ã«ã€ã´ã£ãŸã‚Šå½“ã¦ã¯ã¾ã‚‹æ¤œç´¢å¯¾è±¡ãŒãªã„å ´åˆ\n\nã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®ï¼’è¡Œã¨ã€æœ€å¾Œã®ï¼’è¡Œã‚’ã‚‚ã¨ã«ã€ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã€\n\nã€Œã‚‚ã—ã‹ã—ã¦ï¼šï¼Šï¼Šï¼Šï¼Šè¡Œï½ï¼Šï¼Šï¼Šï¼Šè¡Œã€€ã‹ã‚‚ï¼ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€ã¨è¡¨ç¤ºã—ã€ä¿®æ­£ã‚’ã‚¬ã‚¤ãƒ‰ã€‚\n\næ‰‹å‹•ä¿®æ­£æ™‚ã€ä¿®æ­£ç®‡æ‰€ã‚’ã‚³ãƒ”ãƒšã—ãŸæ®µéšã§ã‚³ãƒ¼ãƒ‰ã¨ã®æ•´åˆã‚’èª¿ã¹ã€ä¿®æ­£ç®‡æ‰€ãŒã¿ã¤ã‹ã£ãŸã‚‰ã€ãã®æ—¨è¡¨ç¤ºã€‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã‚‚è¡¨ç¤ºã€‚è¤‡æ•°ç®‡æ‰€ã‚ã‚‹å ´åˆã€è­¦å‘Šã‚’ã ã—ã¦ã€‚",
  "sourceMode": "project",
  "runId": "6a7a7833ed8a06d62f1e6bcfd43c893a"
}
</script>
</body>
</html>