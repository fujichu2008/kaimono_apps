
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no" />
<title>SpeakNoteï¼ˆè‹±èªä¾‹æ–‡ãƒ»å ´é¢å­¦ç¿’ï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --bg2:#0c1220;
    --card:#121826; --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --warn:#ffb020; --danger:#ff4d4f; --star:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:linear-gradient(var(--bg),var(--bg2));color:var(--ink);
    font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif
  }
/* ==== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹ã‚¿ãƒ–ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼†ã‚¿ãƒ–ã ã‘ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ç‰ˆï¼‰ ==== */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(12,15,20,.9);
  backdrop-filter:saturate(1.2) blur(10px);
  border-bottom:1px solid var(--line);
}

/* ä¸­èº«ã‚’ã‚»ãƒ³ã‚¿ãƒ¼å¯„ã›ï¼†ç¸¦ç©ã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
header .top-bar{
  max-width:880px;
  margin:0 auto;
  padding:10px 12px 8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«è¡Œï¼ˆå·¦ï¼šãƒ­ã‚´ï¼‹ã‚¿ã‚¤ãƒˆãƒ«ã€å³ï¼šã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ */
header .app-title-row{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:8px;
}

header .app-title-main{
  display:flex;
  align-items:center;
  gap:8px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«å³å´ã®å°ã•ãªã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ï¼ˆè¨­å®šï¼ä½¿ã„æ–¹ï¼‰ */
header .app-title-actions{
  display:flex;
  align-items:center;
  gap:6px;
}
header .icon-btn{
  appearance:none;
  border:none;
  padding:4px 8px;
  border-radius:999px;
  font-size:15px;
  background:rgba(19,27,46,.95);
  color:var(--muted);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:background-color .15s ease, transform .08s ease, box-shadow .15s ease;
}
header .icon-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 0 1px rgba(255,255,255,.06);
}


/* å·¦å´ã®ä¸¸ã„ãƒ­ã‚´ãƒ‰ãƒƒãƒˆ */
header .app-logo-dot{
  width:18px;
  height:18px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 20%, #ffffff, #7b5cff 40%, #2b4dff 80%);
  box-shadow:0 0 16px rgba(83,130,255,.7);
}

/* SpeakNote ã®ã‚¿ã‚¤ãƒˆãƒ« */
header h1{
  font-size:18px;
  margin:0;
  letter-spacing:.03em;
}

/* ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‹±èªï¼‰ */
header .app-subtitle{
  font-size:11px;
  color:var(--muted);
  white-space:nowrap;
}

/* ã‚¿ãƒ–ãƒãƒ¼ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰ */
header nav{
  display:flex;
  gap:6px;
  overflow-x:auto;
  padding:4px 0 2px;
}

header nav::-webkit-scrollbar{
  display:none; /* iPhoneã§ã‚‚é‚ªé­”ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æ¶ˆã™ */
}

/* pill å½¢çŠ¶ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ */
header nav button{
  flex:0 0 auto;
  appearance:none;
  border:none;
  outline:none;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  color:var(--muted);
  background:rgba(19,27,46,.95);
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  white-space:nowrap;
  transition:
    background-color .15s ease,
    color .15s ease,
    transform .08s ease,
    box-shadow .15s ease;
}

/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‹ç™½æ–‡å­— */
header nav button.active{
  background:linear-gradient(135deg,#4da3ff,#7b5cff);
  color:#ffffff;
  box-shadow:0 0 0 1px rgba(255,255,255,.08),
             0 10px 22px rgba(45,107,255,.45);
}

/* PCã§å°‘ã—ã ã‘æµ®ããƒ›ãƒãƒ¼åŠ¹æœï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã»ã¼æ°—ã«ãªã‚‰ãªã„ï¼‰ */
header nav button:hover{
  transform:translateY(-1px);
}



/* ==== ãƒ›ãƒ¼ãƒ ï¼ˆKPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ ==== */
.kpi-layout{
  display:flex;
  flex-direction:column;
  gap:14px;
  padding-top:8px;
}
.kpi-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(min-width:720px){
  .kpi-grid{
    grid-template-columns:repeat(4,1fr);
  }
}
.kpi-tile{
  position:relative;
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 10px 9px;
  background:linear-gradient(135deg,#111827,#0c1220);
  color:var(--ink);
  text-align:left;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  gap:4px;
  transition:
    border-color .15s ease,
    box-shadow .18s ease,
    transform .08s ease,
    background .25s ease;
}
.kpi-tile .kpi-label{
  font-size:12px;
  color:var(--muted);
}
.kpi-tile .kpi-value{
  display:flex;
  align-items:baseline;
  gap:4px;
  font-variant-numeric:tabular-nums;
}
.kpi-tile .kpi-value span:first-child{
  font-size:22px;
  font-weight:600;
}
.kpi-tile .kpi-unit{
  font-size:11px;
  color:var(--muted);
}
.kpi-tile .kpi-caption{
  font-size:11px;
  color:var(--muted);
}
.kpi-tile.active{
  border-color:rgba(77,163,255,.9);
  box-shadow:0 0 0 1px rgba(77,163,255,.4),
             0 10px 24px rgba(2,31,78,.8);
  background:radial-gradient(circle at 0% 0%,rgba(123,92,255,.3),transparent 55%),
             radial-gradient(circle at 100% 100%,rgba(77,163,255,.22),transparent 55%),
             linear-gradient(135deg,#131c34,#0b101f);
}
.kpi-tile.active .kpi-label{
  color:#c9d8ff;
}

/* ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ */
.kpi-graph-card{
  border:1px solid var(--line);
  border-radius:18px;
  padding:10px 12px 12px;
  background:radial-gradient(circle at 0 0,rgba(123,92,255,.15),transparent 45%),
             linear-gradient(145deg,#0c101b,#070b13);
}
.kpi-graph-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:6px;
}
.kpi-graph-title{
  font-size:13px;
  font-weight:600;
}
.kpi-range-switch{
  display:flex;
  gap:4px;
}
.kpi-range-switch button{
  appearance:none;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(13,19,34,.9);
  padding:3px 10px;
  font-size:11px;
  color:var(--muted);
  cursor:pointer;
}
.kpi-range-switch button.active{
  background:linear-gradient(135deg,#4da3ff,#7b5cff);
  color:#fff;
  border-color:transparent;
}
.kpi-graph-body{
  margin-top:4px;
  max-height:260px;
  overflow:auto;
  padding-top:2px;
}
.kpi-empty{
  font-size:12px;
  color:var(--muted);
  padding:6px 2px;
}

/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ« */
.kpi-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.kpi-table th,
.kpi-table td{
  padding:4px 6px;
  border-bottom:1px solid rgba(36,48,71,.9);
}
.kpi-table th{
  text-align:left;
  color:var(--muted);
  font-weight:500;
}
.kpi-table tr:last-child td{
  border-bottom:none;
}

/* ç°¡æ˜“ãƒãƒ¼ã‚°ãƒ©ãƒ• */
.kpi-bar-row{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:6px;
  align-items:center;
  margin-bottom:4px;
}
.kpi-bar-label{
  font-size:11px;
  color:var(--muted);
  min-width:40px;
}
.kpi-bar-track{
  position:relative;
  height:8px;
  border-radius:999px;
  background:rgba(12,18,32,.9);
  overflow:hidden;
}
.kpi-bar-fill{
  position:absolute;
  inset:0;
  border-radius:999px;
  background:linear-gradient(90deg,#4da3ff,#7b5cff);
}
.kpi-bar-value{
  font-size:11px;
  font-variant-numeric:tabular-nums;
}





  main{padding:12px 12px 56px}
  .wrap{max-width:880px;margin:0 auto}
  section{display:none}
  section.active{display:block}
  .row{display:grid;gap:10px}
  @media(min-width:640px){ .row.two{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
  input[type="text"], input[type="search"], textarea, select{
    width:100%;background:var(--card);border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:10px;font-size:16px;outline:none
  }
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .btn{
    appearance:none;border:1px solid var(--line);background:#10192b;color:var(--ink);
    padding:10px 12px;border-radius:12px;font-size:16px;cursor:pointer;user-select:none
  }
  .btn.pri{background:linear-gradient(180deg,#1b3b64,#10223b);border-color:#285082}
  .btn.ok{background:linear-gradient(180deg,#115a2b,#0f2e1b);border-color:#1d7a44}
  .btn.warn{background:linear-gradient(180deg,#5d430f,#2f230a);border-color:#7d5a14}
  .btn.danger{background:linear-gradient(180deg,#5a1313,#2b0f0f);border-color:#7a1d1d}
  .btn.mini{
    padding:4px 8px;
    font-size:11px;
    border-radius:999px;
  }
  .grid{display:grid;gap:10px}
  .filters{display:grid;gap:8px;margin-bottom:12px}
  @media(min-width:640px){ .filters{grid-template-columns:1fr 160px 1fr auto} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;cursor:pointer}
  .card:hover{outline:1px solid #2b4b7a}
  .card h3{margin:0 0 6px 0;font-size:16px}
  .meta{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
  .flag{padding:2px 6px;border-radius:6px;border:1px solid var(--line);font-size:12px}
  dialog{width:min(820px,92vw);border:1px solid var(--line);border-radius:16px;background:#0f1524;color:var(--ink);padding:14px}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .tiny{font-size:12px;color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
  .divider{height:1px;background:var(--line);margin:8px 0}
  footer{position:fixed;left:0;right:0;bottom:6px;text-align:center;font-size:11px;color:#8591a6;pointer-events:none}

  .speak-text{white-space:pre-wrap;line-height:1.9;max-height:36vh;overflow:auto;padding:6px 8px;border:1px dashed rgba(255,255,255,.08);border-radius:8px}
  .speak-text .w{padding:0 .03em;border-radius:.15em}
  .speak-text .w.hl{color:#ff4d4f;}
  .badge{font-variant-numeric:tabular-nums;background:#0e1525;border:1px solid var(--line);border-radius:8px;padding:6px 10px}

  #view-shadow .speak-text{max-height:52vh;padding:10px}
  #sh-scene{font-size:15px;color:#c2cad8;margin:2px 0 8px}

  .help-body{max-height:64vh;overflow:auto;padding:4px 2px}
  .lookup-body{max-height:50vh;overflow:auto;background:#0e1525;border:1px solid var(--line);
    border-radius:10px;padding:10px;margin:8px 0;font-size:14px;line-height:1.8}

  .recording{
    border-color:#ff4d4f !important;
    box-shadow:0 0 0 2px rgba(255,77,79,.18) inset !important;
    background:linear-gradient(180deg,#5a1313,#2b0f0f) !important;
  }
  .copy-label{
    cursor:pointer;
    text-decoration:underline dotted 1px rgba(255,255,255,.25);
  }
</style>
</head>
<body>
<header>
  <div class="top-bar">
    <div class="app-title-row">
      <div class="app-title-main">
        <div class="app-logo-dot"></div>
        <h1>SpeakNote</h1>
      </div>
      <!-- å³å´ï¼šè¨­å®šãƒ»ä½¿ã„æ–¹ã‚¢ã‚¤ã‚³ãƒ³ -->
      <div class="app-title-actions">
        <button id="nav-settings" class="icon-btn" title="è¨­å®š">âš™ï¸</button>
        <button id="nav-help" class="icon-btn" title="ä½¿ã„æ–¹">â”</button>
      </div>
    </div>
    <nav>
      <button id="nav-home" class="active">ğŸ  ãƒ›ãƒ¼ãƒ </button>
      <button id="nav-create">âœï¸ ç™»éŒ²</button>
      <button id="nav-list">ğŸ“š ä¸€è¦§</button>
      <button id="nav-shadow" class="ok">ğŸ§ ã‚·ãƒ£ãƒ‰ãƒ¼</button>
    </nav>
  </div>
</header>



<main class="wrap">


  <!-- è¿½åŠ ï¼šãƒ›ãƒ¼ãƒ ï¼ˆKPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ -->
  <section id="view-home" class="active">
    <div class="kpi-layout">
      <!-- KPIã‚¿ã‚¤ãƒ«ï¼ˆ2åˆ—x2è¡Œï¼‰ -->
      <div class="kpi-grid">
        <button class="kpi-tile active" data-metric="sentences">
          <div class="kpi-label">ç™»éŒ²ä¾‹æ–‡æ•°</div>
          <div class="kpi-value">
            <span id="kpi-today-sentences">0</span>
            <span class="kpi-unit">ä»¶</span>
          </div>
          <div class="kpi-caption">ä»Šæ—¥ç™»éŒ²ã—ãŸä¾‹æ–‡</div>
        </button>

        <button class="kpi-tile" data-metric="playCount">
          <div class="kpi-label">å†ç”Ÿå›æ•°</div>
          <div class="kpi-value">
            <span id="kpi-today-play-count">0</span>
            <span class="kpi-unit">å›</span>
          </div>
          <div class="kpi-caption">ä»Šæ—¥ã®å†ç”Ÿãƒˆãƒ©ã‚¤</div>
        </button>

        <button class="kpi-tile" data-metric="playTime">
          <div class="kpi-label">å†ç”Ÿæ™‚é–“</div>
          <div class="kpi-value">
            <span id="kpi-today-play-sec">0</span>
            <span class="kpi-unit">åˆ†</span>
          </div>
          <div class="kpi-caption">ä»Šæ—¥ã®éŸ³å£°ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ</div>
        </button>

        <button class="kpi-tile" data-metric="recTime">
          <div class="kpi-label">éŒ²éŸ³æ™‚é–“</div>
          <div class="kpi-value">
            <span id="kpi-today-rec-sec">0</span>
            <span class="kpi-unit">åˆ†</span>
          </div>
          <div class="kpi-caption">ä»Šæ—¥ã®è‡ªåˆ†ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ</div>
        </button>
      </div>

      <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="kpi-graph-card">
        <div class="kpi-graph-header">
          <div id="kpi-graph-title" class="kpi-graph-title">
            ç™»éŒ²ä¾‹æ–‡æ•°ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰
          </div>
          <div class="kpi-range-switch">
            <button data-range="7" class="active">7æ—¥</button>
            <button data-range="30">30æ—¥</button>
            <button data-range="120">120æ—¥</button>
          </div>
        </div>
        <div id="kpi-graph-body" class="kpi-graph-body">
          <!-- JSã§æç”» -->
        </div>
      </div>
    </div>
  </section>



  <section id="view-create">
    <div class="row">
      <div>
        <label>å…·ä½“çš„ãªå ´é¢ï¼ˆSceneï¼‰<span class="tiny">â€»å¿…é ˆ</span></label>
        <input id="scene" type="text" placeholder="ä¾‹ï¼šãƒ“ã‚ªãƒˆãƒ¼ãƒ—ä½œã‚Šã®è¶£å‘³ã‚’ç´¹ä»‹" />
      </div>
    </div>
    <div class="row two">
      <div>
        <!-- ãƒ©ãƒ™ãƒ«ã‚¿ãƒƒãƒ—ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘ -->
        <label id="lbl-en" class="copy-label" title="ã‚¿ãƒƒãƒ—ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘">
          è‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰
        </label>
        <textarea id="en" placeholder="ä¾‹ï¼šMy hobby is creating a biotope in my garden."></textarea>
        <div id="preview-en" class="speak-text tiny hidden" style="margin-top:6px;"></div>
      </div>
      <div>
        <!-- å’Œè¨³ãƒ©ãƒ™ãƒ«ï¼‹è‡ªå‹•å’Œè¨³ãƒœã‚¿ãƒ³ -->
        <label style="display:flex;justify-content:space-between;align-items:center">
          <span id="lbl-ja" class="copy-label" title="ã‚¿ãƒƒãƒ—ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘">
            å’Œè¨³ï¼ˆJapaneseï¼æ‰‹å…¥åŠ›ï¼‰
          </span>
          <button type="button" class="btn mini" id="btn-auto-ja" title="è‹±æ–‡ã‹ã‚‰è‡ªå‹•å’Œè¨³ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰">
            è‡ªå‹•å’Œè¨³
          </button>
        </label>
        <textarea id="ja" placeholder="ä¾‹ï¼šç§ã®è¶£å‘³ã¯åº­ã§ãƒ“ã‚ªãƒˆãƒ¼ãƒ—ã‚’ã¤ãã‚‹ã“ã¨ã§ã™ã€‚"></textarea>
      </div>
    </div>
    <div class="row two">
      <div>
        <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°å¯ï¼å®Ÿéš›ã®å ´é¢æƒ³èµ·ï¼‰</label>
        <select id="cats" multiple size="8">
          <option>è‡ªå·±ç´¹ä»‹</option>
          <option>ä¼‘æ—¥ãƒ»è¶£å‘³</option>
          <option>è³‡æ–™èª¬æ˜ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³</option>
          <option>æ”¹å–„ææ¡ˆãƒ»åŠ¹ç‡åŒ–</option>
          <option>æ„è¦‹</option>
          <option>å†™çœŸæå†™</option>
          <option>ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç·´ç¿’</option>
          <option>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç·´ç¿’</option>
        </select>
        <div class="tiny">â€» <span class="kbd">Ctrl</span>/<span class="kbd">âŒ˜</span> ã§è¤‡æ•°é¸æŠ</div>
      </div>
      <div>
        <label>ã‚¿ã‚°ï¼ˆcomma, separatedï¼‰</label>
        <input id="tags" type="text" placeholder="ä¾‹ï¼šèª¿é”, ç´æœŸ, å¤–æ³¨" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>ãƒ¡ãƒ¢ï¼ˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰</label>
        <input id="notes" type="text" placeholder="ä¾‹ï¼šã‚³ã‚¹ãƒˆå‰Šæ¸›ã®è«–æ‹ ã‚’å…¥ã‚Œã‚‹ã¨è‰¯ã„" />
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btn-preview">â–¶ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ</button>
      <button class="btn" id="btn-pause-preview">â¸ ä¸€æ™‚åœæ­¢/å†é–‹</button>
      <button class="btn pri" id="btn-save">ä¿å­˜</button>
      <button class="btn" id="btn-clear">ã‚¯ãƒªã‚¢</button>
    </div>
  </section>

  <section id="view-list">
    <div class="actions" style="justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆå ´é¢/ã‚¿ã‚°/ã‚«ãƒ†ã‚´ãƒªï¼‰" />
        <select id="f-cat"><option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option></select>
        <input id="f-tag" type="search" placeholder="ã‚¿ã‚°ã‚’å«ã‚€ï¼ˆä¾‹ï¼šç´æœŸï¼‰">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btn-export">Export</button>
        <label class="btn" for="file-import">Import</label>
        <input id="file-import" type="file" accept=".json" class="hidden">
      </div>
    </div>
    <div class="grid" id="cards"></div>
  </section>

  <!-- ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°è¨­å®šç”»é¢ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°é¸æŠï¼‹é–‹å§‹ãƒœã‚¿ãƒ³ï¼‰ -->
  <section id="view-shadow">
    <div class="tiny" style="margin-bottom:8px">
      å¯¾è±¡ã¨ã™ã‚‹ä¾‹æ–‡ã‚’ã‚«ãƒ†ã‚´ãƒªã‚„ã‚¿ã‚°ã§çµã‚Šè¾¼ã‚“ã§ã‹ã‚‰ã€ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã‚’é–‹å§‹ã§ãã¾ã™ã€‚<br>
      ä½•ã‚‚æŒ‡å®šã—ãªã„å ´åˆã¯ã€ç™»éŒ²æ¸ˆã¿ã®ã™ã¹ã¦ã®è‹±æ–‡ãŒå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚
    </div>
    <div class="row two">
      <div>
        <label>ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿</label>
        <select id="sh-cat">
          <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
          <option>è‡ªå·±ç´¹ä»‹</option>
          <option>ä¼‘æ—¥ãƒ»è¶£å‘³</option>
          <option>è³‡æ–™èª¬æ˜ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³</option>
          <option>æ”¹å–„ææ¡ˆãƒ»åŠ¹ç‡åŒ–</option>
          <option>æ„è¦‹</option>
          <option>å†™çœŸæå†™</option>
          <option>ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç·´ç¿’</option>
          <option>ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç·´ç¿’</option>
        </select>
      </div>
      <div>
        <label>ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿</label>
        <input id="sh-tag" type="text" placeholder="ä¾‹ï¼šself-intro, hobby ãªã©">
        <div class="tiny">â€» æœªæŒ‡å®šã®å ´åˆã¯ã€ã‚¿ã‚°ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ã¯è¡Œã„ã¾ã›ã‚“ã€‚</div>
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button class="btn ok" id="sh-start">â–¶ï¸ ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°é–‹å§‹</button>
    </div>
    <div class="tiny" id="sh-summary" style="margin-top:4px">ç¾åœ¨ï¼šå…¨ä»¶ã®è‹±æ–‡ãŒå¯¾è±¡ï¼ˆçµã‚Šè¾¼ã¿ãªã—ï¼‰</div>
  </section>
</main>

<!-- è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="dlg-detail">
  <h3 id="d-scene" style="margin:0 0 6px"></h3>
  <div class="meta" id="d-meta"></div>
  <div class="divider"></div>

  <div class="tiny">English</div>
  <div id="d-en" class="speak-text" style="margin-bottom:8px"></div>

  <!-- Japaneseï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŠ˜ã‚ŠãŸãŸã¿ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ ï¼‰ -->
  <div class="tiny" style="display:flex;align-items:center;gap:8px;margin-top:2px">
    <span>Japanese</span>
    <button type="button" class="btn mini" id="d-toggle-ja">å’Œè¨³ã‚’è¡¨ç¤º</button>
  </div>
  <div id="d-ja-wrap" class="speak-text hidden" style="margin-bottom:8px;max-height:36vh;overflow:auto;">
    <div id="d-ja" style="white-space:pre-wrap;"></div>
  </div>


  <div class="divider"></div>
  <!-- 1è¡Œç›®ï¼šå†ç”Ÿï¼‹é€Ÿåº¦ï¼ˆæ¨ªä¸€åˆ—ï¼‰ -->
  <div class="actions" id="row-play-rate">
    <button class="btn" id="d-toggle">â–¶ï¸ å†ç”Ÿ</button>
    <button class="btn" id="d-slower">âˆ’ é€Ÿåº¦</button>
    <span class="badge" id="d-rate-badge">1.0Ã—</span>
    <button class="btn" id="d-faster">ï¼‹ é€Ÿåº¦</button>
  </div>
  <!-- 2è¡Œç›®ï¼šREC / ç·¨é›† / å‰Šé™¤ / é–‰ã˜ã‚‹ï¼ˆå¸¸ã«åŒã˜è¡Œï¼‰ -->
  <div class="actions" id="row-edit-close" style="justify-content:flex-start">
    <button class="btn" id="d-rec-main">â— REC</button>
    <button class="btn" id="d-edit">ç·¨é›†</button>
    <button class="btn danger" id="d-del">ğŸ—‘ å‰Šé™¤</button>
    <button class="btn right" id="d-close">é–‰ã˜ã‚‹</button>
  </div>
  <!-- 3è¡Œç›®ï¼šRECä¸­ã®æ™‚é–“è¡¨ç¤ºï¼†RECå†ç”Ÿãƒœã‚¿ãƒ³ãªã©ï¼ˆå¿…è¦ãªã¨ãã ã‘è¡¨ç¤ºï¼‰ -->
  <div class="actions hidden" id="row-rec-extra" style="margin-top:4px;justify-content:flex-start">
    <span class="tiny" id="d-rec-timer" style="min-width:72px;display:inline-block"></span>
    <button class="btn hidden" id="d-rec-play">â–¶ï¸ RECå†ç”Ÿ</button>
    <button class="btn danger hidden" id="d-rec-delete">RECå‰Šé™¤</button>
  </div>

  <audio id="d-rec-audio" class="hidden"></audio>
</dialog>

<!-- ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°å†ç”Ÿãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆæœ¬æ–‡ã‚’åºƒãè¡¨ç¤ºï¼‰ -->
<dialog id="dlg-shadow">
  <div id="sh-scene" style="margin:0 0 6px;font-size:15px;"></div>

  <!-- è‹±æ–‡ï¼ˆã“ã‚Œã¾ã§é€šã‚Šï¼‰ -->
  <div id="sh-text" class="speak-text" style="margin-top:8px;max-height:60vh;"></div>

  <!-- å’Œè¨³ã®é–‹é–‰ãƒœã‚¿ãƒ³ -->
  <div class="actions tiny" style="margin-top:4px">
    <button type="button" class="btn mini" id="sh-toggle-ja">å’Œè¨³ã‚’è¡¨ç¤º</button>
  </div>

  <!-- å’Œè¨³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŠ˜ã‚ŠãŸãŸã¿ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ ï¼‰ -->
  <div id="sh-text-ja-wrap" class="speak-text hidden" style="max-height:30vh;overflow:auto;margin-top:2px;">
    <div id="sh-text-ja" style="white-space:pre-wrap;"></div>
  </div>

  <div class="actions" style="margin-top:8px">
    <!-- å‰ã¸ï¼å†ç”Ÿï¼æ¬¡ã¸ ã‚’æ¨ªä¸¦ã³ -->
    <button class="btn" id="sh-prev">â® å‰ã¸</button>
    <button class="btn ok" id="sh-toggle">â¸ åœæ­¢</button>
    <button class="btn" id="sh-next">æ¬¡ã¸ â­</button>

    <!-- é€Ÿåº¦èª¿æ•´ã¨çµ‚äº† -->
    <button class="btn" id="sh-slower">âˆ’ é€Ÿåº¦</button>
    <span class="badge" id="rate-badge">1.0Ã—</span>
    <button class="btn" id="sh-faster">ï¼‹ é€Ÿåº¦</button>
    <button class="btn right" id="sh-exit">çµ‚äº†</button>
  </div>
</dialog>



<!-- è¨­å®š -->
<dialog id="dlg-settings">
  <form method="dialog">
    <h3 style="margin:0 0 8px">éŸ³å£°ãƒ»å†ç”Ÿè¨­å®š</h3>
    <div class="row two">
      <div>
        <label>Voice</label>
        <select id="voice"></select>
        <div class="tiny">â€» iOSã¯â€œSamantha (en-US)â€ã€PCã¯â€œMicrosoft Eric Online (Natural) (en-US)â€ã‚’å„ªå…ˆã€‚Androidã¯æœªæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯ã€‚</div>
      </div>
      <div>
        <label>Language hint</label>
        <select id="lang">
          <option value="">Auto</option>
          <option value="en-US" selected>English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>
    <div class="row two">
      <div><label>Rate</label><input id="rate" type="range" min="0.5" max="2" step="0.1"></div>
      <div><label>Pitch</label><input id="pitch" type="range" min="0" max="2" step="0.1"></div>
    </div>
    <div class="row two">
      <div><label>Volume</label><input id="volume" type="range" min="0" max="1" step="0.1"></div>
      <div><label>Gapï¼ˆæ¬¡ãƒ‘ãƒ¼ãƒˆã¾ã§ã®é–“åˆã„ç§’ï¼‰</label><input id="gap" type="number" min="0" max="5" step="0.5"></div>
    </div>
    <div class="row two">
      <div><label>Repeatï¼ˆè‹±èªã®ç¹°ã‚Šè¿”ã—å›æ•°ï¼‰</label><input id="repeat" type="number" min="1" max="5" step="1"></div>
      <div>
        <label>èª­ã¿ä¸Šã’å¯¾è±¡</label>
        <select id="speak-target">
          <option value="en">è‹±èªã®ã¿</option>
          <option value="ja">å’Œè¨³ã®ã¿</option>
          <option value="both">è‹± â†’ é–“ â†’ å’Œ</option>
        </select>
      </div>
    </div>
    <div class="row">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="keep-awake" type="checkbox"> ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ä¸­ã«ç”»é¢ã‚’è‡ªå‹•ã‚¹ãƒªãƒ¼ãƒ—ã•ã›ãªã„ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã«æ³¨æ„ï¼‰
      </label>
    </div>
    <div class="actions">
      <button class="btn warn" id="reset-standard">æ¨™æº–è¨­å®š</button>
      <button class="btn ok" id="save-settings">ä¿å­˜</button>
      <button class="btn right" value="close">é–‰ã˜ã‚‹</button>
    </div>
    <!-- ä¸€ç•ªä¸‹ï¼šä¾‹æ–‡å…¨å‰Šé™¤ãƒªã‚»ãƒƒãƒˆ -->
    <div class="actions" style="margin-top:12px;border-top:1px solid var(--line);padding-top:8px;justify-content:flex-start">
      <button class="btn danger" id="reset-all-sentences">ï¾˜ï½¾ï½¯ï¾„ï¼ˆä¾‹æ–‡ã‚’ã™ã¹ã¦å‰Šé™¤ï¼‰</button>
    </div>
  </form>
</dialog>

<!-- ä½¿ã„æ–¹ï¼ˆå…¨æ–‡ï¼‰ -->
<dialog id="dlg-help" aria-labelledby="help-title">
  <h3 id="help-title" style="margin:0 0 8px">ä½¿ã„æ–¹ï¼ˆHow toï¼‰</h3>
  <div class="help-body" id="help-body">
    <h3>ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
    <p>SpeakNoteã¯ã€è‹±èªã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ã®ãŸã‚ã«ã€å ´é¢ï¼ˆSceneï¼‰ã‚’èµ·ç‚¹ã«ä¾‹æ–‡ã‚’ä½œæˆãƒ»ç®¡ç†ãƒ»å†ç”Ÿã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
    ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿æŒã•ã‚Œã€å¤–éƒ¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
    TOEICÂ® Speakingãªã©ã®å®Ÿè·µç·´ç¿’ã«æœ€é©ã§ã€ãƒãƒƒãƒˆæ¥ç¶šãªã—ã§ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚</p>

    <h3>åŸºæœ¬ã®æµã‚Œï¼ˆ0ã€œ4ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h3>
    <h4>0. ä¾‹æ–‡ç”Ÿæˆï¼ˆChatGPTãªã©ã®AIæ´»ç”¨ã‚‚OKï¼‰</h4>
    <p>ã¾ãšã¯ç·´ç¿’ã—ãŸã„è‹±æ–‡ã‚’æº–å‚™ã—ã¾ã™ã€‚<br>
    è‡ªåˆ†ã§æ—¥æœ¬èªã‹ã‚‰ä½œã£ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ChatGPTãªã©ã®ç”ŸæˆAIã§ä¸‹æ›¸ãã‚’ä½œã‚‹ã“ã¨ã‚‚åŠ¹ç‡çš„ãªæ‰‹æ®µã§ã™ã€‚</p>

    <div class="help-callout">
      <strong>ç”ŸæˆAIã‚’ä½¿ã†ä¾‹</strong>
      <ul>
        <li>ã€Œç§ã®è¶£å‘³ã¯ã€ã‚¬ãƒ¼ãƒ‡ãƒ‹ãƒ³ã‚°ã¨ãƒ“ã‚ªãƒˆãƒ¼ãƒ—ã¥ãã‚Šã§ã™ã€‚ã“ã®å‰æã§ã€1åˆ†ä»¥å†…ã§è©±ã™è‹±èªã®ã‚¹ãƒ”ãƒ¼ãƒä¾‹ã‚’ä½œã£ã¦ã€‚æ—¥æœ¬èªè¨³ã‚‚ä½µè¨˜ã—ã¦ã€‚ã€</li>
        <li>ã€Œç§ã¯è£½é€ æ¥­ã®èª¿é”æ‹…å½“ã§ã€ã€‡ã€‡ã®èª¿é”ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚ãƒãƒªã‚·ãƒ¼ã¯Ã—Ã—ã§ã™ã€‚ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€è‡ªåˆ†ã®è·å‹™ã‚’è‹±èªã§è‡ªç„¶ã«èª¬æ˜ã™ã‚‹1åˆ†é–“ã®ã‚¹ãƒ”ãƒ¼ãƒã‚’ä½œã£ã¦ã€‚æ—¥æœ¬èªè¨³ã‚‚ã¤ã‘ã¦ãã ã•ã„ã€‚ã€</li>
        <li>ã€Œç§ã¯ä¼‘æ—¥ã«ã€ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚’æ¥½ã—ã¿ã€ã‚µã‚¦ãƒŠã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹ã“ã¨ãŒè¶£å‘³ã§ã™ã€‚ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€45ç§’ä»¥å†…ã®è‹±èªã‚¹ãƒ”ãƒ¼ãƒã‚’æ—¥æœ¬èªè¨³ä»˜ãã§ä½œæˆã—ã¦ã€‚ã€</li>
        <li>ã€Œè‡ªå·±ç´¹ä»‹ãƒ»è¶£å‘³ãƒ»ä»•äº‹ãƒ»å®¶æ—ã‚’ãƒ†ãƒ¼ãƒã«ã€TOEIC Speakingç·´ç¿’ç”¨ã®ã‚¹ãƒ”ãƒ¼ãƒä¾‹ã‚’è‹±èªã¨æ—¥æœ¬èªã§ä½œæˆã—ã¦ã€‚ã€</li>
      </ul>
      <p>å¾—ã‚‰ã‚ŒãŸè‹±æ–‡ã¨å’Œè¨³ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã™ã‚Œã°ã€è‡ªå‹•ã§èª­ã¿ä¸Šã’ãƒ»ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ç·´ç¿’ãŒã§ãã¾ã™ã€‚</p>
    </div>

    <h4>1. ç™»éŒ²</h4>
    <ul>
      <li>å¿…é ˆé …ç›®ã¯ã€Œå ´é¢ã€ã¨ã€Œè‹±æ–‡ã€ã§ã™ã€‚</li>
      <li>ã€Œå ´é¢ï¼ˆSceneï¼‰ã€ã«ã¯ã€ã„ã¤ãƒ»ã©ã‚“ãªçŠ¶æ³ã§ä½¿ã†è‹±æ–‡ã‹ã‚’ç°¡æ½”ã«æ›¸ãã¾ã™ï¼ˆä¾‹ï¼šã€Œä¼šè­°ã§è‡ªå·±ç´¹ä»‹ã™ã‚‹ã¨ãã€ï¼‰ã€‚</li>
      <li>ã€Œè‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰ã€ã«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã€ã€Œä¿å­˜ã€ã€‚</li>
      <li>ã€Œâ–¶ï¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿã€ã§éŸ³å£°ç¢ºèªã§ãã¾ã™ã€‚<br>
          ãªãŠã€iOSã§ã¯ç™ºè©±ãŒã‚„ã‚„ãã“ã¡ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li>
    </ul>

    <h4>2. ä¸€è¦§</h4>
    <ul>
      <li>æ¤œç´¢ã‚„ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿å¯èƒ½ã€‚</li>
      <li>ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ç”»é¢ãŒé–‹ãã¾ã™ã€‚</li>
      <li>å³ä¸Šã®ã€ŒExportã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ã€ŒImportã€ã§ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚‚ã§ãã¾ã™ã€‚</li>
    </ul>

    <h4>3. è©³ç´°ï¼ˆå€‹åˆ¥ãƒˆãƒ”ãƒƒã‚¯ï¼‰</h4>
    <ul>
      <li>â–¶ï¸ å†ç”Ÿï¼åœæ­¢ï¼å†é–‹ ã¨é€Ÿåº¦å¤‰æ›´ï¼ˆâˆ’ï¼ï¼‹ï¼‰ãŒå¯èƒ½ã§ã™ã€‚</li>
      <li>ä¸‹æ®µ2è¡Œæ§‹æˆï¼š<br>
        ãƒ»2è¡Œç›®ï¼š<strong>RECï¼ç·¨é›†ï¼å‰Šé™¤ï¼é–‰ã˜ã‚‹</strong> ãŒå¸¸ã«æ¨ªä¸€åˆ—ã§ä¸¦ã³ã¾ã™ã€‚<br>
        ãƒ»3è¡Œç›®ï¼šéŒ²éŸ³ä¸­ã®<strong>ã‚¿ã‚¤ãƒãƒ¼</strong>ã¨ã€éŒ²éŸ³æ¸ˆã¿ã®ã¨ãã®<strong>RECå†ç”Ÿãƒœã‚¿ãƒ³</strong>ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå¿…è¦ãªã¨ãã ã‘è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
      <li>é–‰ã˜ã‚‹ã¨ãã¯ç™ºè©±ã‚’è‡ªå‹•åœæ­¢ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚è§£é™¤ã•ã‚Œã¾ã™ã€‚</li>
      <li>ç·¨é›†å¾Œã¯ã€Œæ›´æ–°ã—ã¾ã—ãŸã€ã¨è¡¨ç¤ºã•ã‚Œã€ä¸€è¦§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</li>
    </ul>

    <h4>4. ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</h4>
    <ul>
      <li>ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šç”»é¢ã‚’é–‹ãã¾ã™ã€‚</li>
      <li>ã‚«ãƒ†ã‚´ãƒªã¨ã‚¿ã‚°ã§å¯¾è±¡ã‚’çµã‚Šè¾¼ã¿ã€ã€Œâ–¶ï¸ ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°é–‹å§‹ã€ã§å°‚ç”¨ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã€è‡ªå‹•å†ç”ŸãŒå§‹ã¾ã‚Šã¾ã™ã€‚</li>
      <li>å°‚ç”¨ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§ã¯è‹±æ–‡ãŒåºƒãè¡¨ç¤ºã•ã‚Œã€å˜èªã”ã¨ã«èµ¤ããƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚</li>
      <li><strong>é€Ÿåº¦èª¿æ•´ï¼ˆâˆ’/ï¼‹ï¼‰</strong>ã¯ã€ãã®ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶šãé–“ã¯å„å›ã®ç™ºè©±ã«å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚</li>
      <li>ã€Œâ¸ åœæ­¢ã€ã§ä¸€æ™‚åœæ­¢ï¼å†é–‹ã€ã€Œçµ‚äº†ã€ã§ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦å†ç”Ÿã‚’å®Œå…¨åœæ­¢ã§ãã¾ã™ã€‚</li>
    </ul>

    <h3>å­¦ç¿’ã®ã‚³ãƒ„ï¼ˆTOEIC Speakingï¼‰</h3>
    <ul>
      <li>1æ–‡1å ´é¢ä¸»ç¾©ï¼š1ã¤ã®ã‚·ãƒ¼ãƒ³ã«1ã¤ã®è‹±æ–‡ã‚’ç™»éŒ²ã€‚çŠ¶æ³ã¨ã‚»ãƒƒãƒˆã§è¦šãˆã‚„ã™ã„ã€‚</li>
      <li>éŸ³èª­â†’ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°â†’ã‚¹ãƒ”ãƒ¼ãƒåŒ–ï¼š1ã¤ã®ç´ æã‚’3æ®µéšã§ç¹°ã‚Šè¿”ã™ã€‚</li>
      <li>ã€Œ1åˆ†ä»¥å†…ã€ã‚’æ„è­˜ï¼šTOEIC Speakingã§ã¯60ç§’ãŒç›®å®‰ã€‚</li>
      <li>ã‚¿ã‚°æ´»ç”¨ï¼šã€Œä¾é ¼ã€ã€Œèª¬æ˜ã€ã€Œææ¡ˆã€ã€ŒåŒæ„ã€ãªã©æ©Ÿèƒ½åˆ¥ã‚¿ã‚°ã‚’ä½¿ã†ã¨æ•´ç†ã—ã‚„ã™ã„ã€‚</li>
      <li>é€Ÿåº¦ç·´ç¿’ï¼šæœ€åˆã¯0.8Ã—ã€œ1.0Ã—ã€æ…£ã‚ŒãŸã‚‰1.2Ã—ã§æŒ‘æˆ¦ã€‚</li>
    </ul>

    <h3>ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h3>
    <ul>
      <li>Exportï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨JSONã¨ã—ã¦ä¿å­˜ï¼ˆä¾‹ï¼šspeaknote_backup_2025-11-03.jsonï¼‰ã€‚</li>
      <li>Importï¼šä»–ç«¯æœ«ãƒ»ä»–ãƒ–ãƒ©ã‚¦ã‚¶ã¸ç§»è¡Œå¯èƒ½ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã€Œæ—¢å­˜ã‚’å…¥ã‚Œæ›¿ãˆã€ã‹ã€Œè¿½åŠ ã€ã‹é¸æŠã§ãã¾ã™ã€‚</li>
      <li>å…¨å‰Šé™¤ï¼šè¨­å®šç”»é¢ã®èµ¤ã„ã€Œï¾˜ï½¾ï½¯ï¾„ã€ãƒœã‚¿ãƒ³ã§ã€ã™ã¹ã¦ã®ä¾‹æ–‡ã‚’å‰Šé™¤ã§ãã¾ã™ï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰ã€‚</li>
    </ul>

    <h3>ãƒˆãƒ©ãƒ–ãƒ«å¯¾å‡¦</h3>
    <ul>
      <li><strong>éŸ³ãŒå‡ºãªã„ï¼š</strong>è¨­å®šã§Voiceã‚’å†é¸æŠ â†’ ä¿å­˜ã€‚ç«¯æœ«ã®æ¶ˆéŸ³ã‚¹ã‚¤ãƒƒãƒã‚„éŸ³é‡è¨­å®šã‚’ç¢ºèªã€‚iPhoneã§ã¯æœ€åˆã«ãƒœã‚¿ãƒ³ã‚’ä¸€åº¦æŠ¼ã—ã¦éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ã€‚</li>
      <li><strong>å†ç”ŸãŒé€”ä¸­ã§æ­¢ã¾ã‚‹ï¼é£›ã¶ï¼š</strong>è‡ªå‹•å†è©¦è¡Œæ©Ÿèƒ½ãŒåƒãã®ã§ã€å†åº¦â–¶ï¸å†ç”Ÿã§å¾©å¸°ã—ã¾ã™ã€‚</li>
      <li><strong>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ï¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œãªã„ï¼š</strong>é•·æ–‡ã§ã¯é…å»¶ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚â¸â†’å†é–‹ã§å¾©å¸°ã€‚</li>
    </ul>
  </div>
  <div class="actions">
    <button class="btn right" id="help-close">é–‰ã˜ã‚‹</button>
  </div>
</dialog>

<!-- å˜èªãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
<dialog id="dlg-lookup" aria-labelledby="lk-title">
  <h3 id="lk-title" style="margin:0 0 6px">å˜èªæ¤œç´¢</h3>
  <div id="lk-body" class="lookup-body">å˜èªã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div class="actions">
    <a id="lk-google" class="btn" target="_blank" rel="noopener">Google</a>
    <a id="lk-cambridge" class="btn" target="_blank" rel="noopener">Cambridge</a>
    <a id="lk-longman" class="btn" target="_blank" rel="noopener">Longman</a>
    <button class="btn right" id="lk-close">é–‰ã˜ã‚‹</button>
  </div>
</dialog>

<footer>(C)Hisashi Fujinaka All Rights Reserved. All Code is generated by AI.</footer>

<script>
/* =========================
   åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================= */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>crypto.randomUUID();
const now = ()=>Date.now();
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
const UA = navigator.userAgent||'';
const isIOS = /iP(hone|od|ad)/.test(UA) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isAndroid = /Android/i.test(UA);

/* è¨±å¯ã•ã‚Œã‚‹ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼ˆãã‚Œä»¥å¤–ã¯è¡¨ç¤ºä¸Šã¯å»ƒæ­¢ï¼‰ */
const ALLOWED_CATEGORIES = [
  'è‡ªå·±ç´¹ä»‹',
  'ä¼‘æ—¥ãƒ»è¶£å‘³',
  'è³‡æ–™èª¬æ˜ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³',
  'æ”¹å–„ææ¡ˆãƒ»åŠ¹ç‡åŒ–',
  'æ„è¦‹',
  'å†™çœŸæå†™',
  'ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç·´ç¿’',
  'ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç·´ç¿’'
];



/* =========================
   KPI ãƒ­ã‚°ï¼ˆãƒ›ãƒ¼ãƒ ã‚¿ãƒ–ç”¨ï¼‰
   days: {
     'YYYY-MM-DD': { added, playCount, playMs, recMs }
   }
========================= */
const LS_KPI = 'speaknote_kpi_v1';
let kpiData = loadKpiData();

function loadKpiData(){
  try{
    const raw = JSON.parse(localStorage.getItem(LS_KPI) || '{}');
    return { days: raw.days || {} };
  }catch(e){
    return { days: {} };
  }
}
function saveKpiData(){
  try{
    localStorage.setItem(LS_KPI, JSON.stringify(kpiData));
  }catch(_){}
}
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = ('0'+(d.getMonth()+1)).slice(-2);
  const day = ('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}
function ensureKpiDay(key){
  if(!kpiData.days[key]){
    kpiData.days[key] = { added:0, playCount:0, playMs:0, recMs:0 };
  }
  return kpiData.days[key];
}
function trackKpiAdd(count){
  if(!count) return;
  const d = ensureKpiDay(todayKey());
  d.added += count;
  saveKpiData();
  updateHomeKpi();
}
function trackKpiPlay(ms){
  if(!(ms>0)) return;
  const d = ensureKpiDay(todayKey());
  d.playCount += 1;
  d.playMs += ms;
  saveKpiData();
  updateHomeKpi();
}
function trackKpiRec(ms){
  if(!(ms>0)) return;
  const d = ensureKpiDay(todayKey());
  d.recMs += ms;
  saveKpiData();
  updateHomeKpi();
}
function getTodayKpi(){
  const d = ensureKpiDay(todayKey());
  const playMinRaw = (d.playMs || 0) / 60000; // ms â†’ åˆ†
  const recMinRaw  = (d.recMs  || 0) / 60000; // ms â†’ åˆ†

  // å°æ•°ç¬¬1ä½ã§ä¸¸ã‚ï¼ˆä¾‹ï¼š1.23åˆ† â†’ 1.2åˆ†ï¼‰
  const playMin = Math.round(playMinRaw * 10) / 10;
  const recMin  = Math.round(recMinRaw  * 10) / 10;

  return {
    added:     d.added     || 0,
    playCount: d.playCount || 0,
    playMin,
    recMin

  };
}

function getLastNDays(n){
  const out = [];
  const base = new Date();
  for(let i=n-1;i>=0;i--){
    const d = new Date(base.getFullYear(), base.getMonth(), base.getDate()-i);
    const key = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}`;
    const day = kpiData.days[key] || {added:0, playCount:0, playMs:0, recMs:0};
    out.push({ date:key, ...day });
  }
  return out;
}
function formatDateLabel(key){
  const parts = key.split('-');
  if(parts.length!==3) return key;
  return `${parts[1]}/${parts[2]}`;
}

let kpiCurrentMetric = 'sentences';  // sentences / playCount / playTime / recTime
let kpiCurrentRange = 7;             // 7 / 30 / 120

function updateHomeKpi(){
  const el1 = $('#kpi-today-sentences');
  if(!el1) return; // ãƒ›ãƒ¼ãƒ ãŒã¾ã æç”»ã•ã‚Œã¦ã„ãªã„ã‚±ãƒ¼ã‚¹
  const t = getTodayKpi();
  $('#kpi-today-sentences').textContent   = t.added;
  $('#kpi-today-play-count').textContent  = t.playCount;
  $('#kpi-today-play-sec').textContent    = t.playMin.toFixed(1);
  $('#kpi-today-rec-sec').textContent     = t.recMin.toFixed(1);
  renderHomeGraph();
}

async function renderHomeGraph(){
  const body  = $('#kpi-graph-body');
  const title = $('#kpi-graph-title');
  if(!body || !title) return;
  body.innerHTML = '';

  // â‘  ç™»éŒ²ä¾‹æ–‡æ•°ï¼šä¾‹æ–‡ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è¡¨ï¼ˆç›´è¿‘Næ—¥ï¼‰
  if(kpiCurrentMetric === 'sentences'){
    if(!db){
      body.innerHTML = '<div class="kpi-empty">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
      title.textContent = 'ç™»éŒ²ä¾‹æ–‡æ•°ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰';
      return;
    }
    title.textContent = `ç™»éŒ²ä¾‹æ–‡æ•°ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ç›´è¿‘${kpiCurrentRange}æ—¥ï¼‰`;

    const rows = await getAll();
    const nowMs  = Date.now();
    const fromMs = nowMs - kpiCurrentRange * 86400000;
    const map = new Map(); // cat -> count

    for(const r of rows){
      const created = Number(r.createdAt || 0);
      if(!created || created < fromMs) continue;
      let cats = (r.categories || []).filter(c => ALLOWED_CATEGORIES.includes(c));
      if(cats.length === 0) cats = ['ï¼ˆæœªåˆ†é¡ï¼‰'];
      for(const c of cats){
        map.set(c, (map.get(c) || 0) + 1);
      }
    }

    if(map.size === 0){
      body.innerHTML = '<div class="kpi-empty">å¯¾è±¡æœŸé–“ã®ç™»éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    let html = '<table class="kpi-table"><thead><tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ç™»éŒ²æ•°</th></tr></thead><tbody>';
    for(const [cat,count] of Array.from(map.entries()).sort((a,b)=>b[1]-a[1])){
      html += `<tr><td>${escapeHTML(cat)}</td><td>${count}</td></tr>`;
    }
    html += '</tbody></table>';
    body.innerHTML = html;
    return;
  }

  // â‘¡ ãã®ä»–KPIï¼šæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆç›´è¿‘Næ—¥ï¼‰
  const days = getLastNDays(kpiCurrentRange);
  let selector, unit, label;

  if(kpiCurrentMetric === 'playCount'){
    selector = d => d.playCount || 0;
    unit = 'å›';
    label = 'å†ç”Ÿå›æ•°';
  }else if(kpiCurrentMetric === 'playTime'){
   // ms â†’ åˆ†ï¼ˆå°æ•°1æ¡ï¼‰
   selector = d => Math.round(((d.playMs || 0) / 60000) * 10) / 10;
   unit = 'åˆ†';
   label = 'å†ç”Ÿæ™‚é–“';
  }else{ // recTime
   selector = d => Math.round(((d.recMs || 0) / 60000) * 10) / 10;
   unit = 'åˆ†';
   label = 'éŒ²éŸ³æ™‚é–“';
  }

  title.textContent = `${label}ã®æ¨ç§»ï¼ˆç›´è¿‘${kpiCurrentRange}æ—¥ï¼‰`;
  const series = days.map(d => ({ label: formatDateLabel(d.date), value: selector(d) }));
  const max = Math.max(...series.map(s => s.value), 0);
  if(!max){
    body.innerHTML = '<div class="kpi-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }

  // ---- ã“ã“ã‹ã‚‰æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•SVGç”Ÿæˆ ----
  const width  = 360;
  const height = 160;
  const padL = 36;
  const padR = 8;
  const padT = 10;
  const padB = 22;
  const innerW = width  - padL - padR;
  const innerH = height - padT - padB;

  const minVal = 0;
  const range  = Math.max(1, max - minVal);

  const n = series.length;
  const stepX = n > 1 ? innerW / (n - 1) : 0;
  const points = series.map((s, i) => {
    const x = padL + (n === 1 ? innerW / 2 : i * stepX);
    const yNorm = (s.value - minVal) / range; // 0ã€œ1
    const y = padT + (1 - yNorm) * innerH;
    return `${x},${y}`;
  }).join(' ');

  // Yè»¸ç›®ç››ã‚Šï¼ˆ0, 1/3, 2/3, max ã®4æœ¬ï¼‰
 const ticks = [];
 const tickCount = 3;
 for(let i=0;i<=tickCount;i++){
   const v = max * (i / tickCount);
   const frac = 1 - (v / range); // ä¸ŠãŒmax, ä¸‹ãŒ0
   const y = padT + frac * innerH;

   let labelVal;
   if(unit === 'åˆ†'){
     // åˆ†ã®ã¨ãã¯å°æ•°1æ¡
     labelVal = (Math.round(v * 10) / 10).toFixed(1);
   }else{
     // å›æ•°ãªã©ã¯æ•´æ•°
     labelVal = String(Math.round(v));
   }
   ticks.push({ y, label: labelVal });
 }

  // Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆå¤šã„ã¨ãã¯é–“å¼•ãï¼‰
  const labelStep = Math.max(1, Math.ceil(n / 6));
  const xLabels = series.map((s, i) => {
    if(i % labelStep !== 0 && i !== n - 1) return null;
    const x = padL + (n === 1 ? innerW / 2 : i * stepX);
    return { x, text: s.label };
  }).filter(Boolean);

  const svg = `
    <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%;height:auto;">
      <!-- èƒŒæ™¯ -->
      <rect x="0" y="0" width="${width}" height="${height}" fill="none" />
      <!-- æ¨ªã‚°ãƒªãƒƒãƒ‰ & Yè»¸ãƒ©ãƒ™ãƒ« -->
      <g>
        ${ticks.map(t => `
          <line x1="${padL}" y1="${t.y}" x2="${width-padR}" y2="${t.y}"
                stroke="rgba(132,139,164,0.25)" stroke-width="0.5" />
          <text x="${padL-4}" y="${t.y+3}" text-anchor="end"
                fill="rgba(167,176,194,0.9)" font-size="9">
            ${t.label}${unit}
          </text>
        `).join('')}
      </g>
      <!-- æŠ˜ã‚Œç·š -->
      <polyline
        fill="none"
        stroke="#4da3ff"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        points="${points}"
      />
      <!-- å„ãƒã‚¤ãƒ³ãƒˆ -->
      <g>
        ${series.map((s, i) => {
          const x = padL + (n === 1 ? innerW / 2 : i * stepX);
          const yNorm = (s.value - minVal) / range;
          const y = padT + (1 - yNorm) * innerH;
          return `
            <circle cx="${x}" cy="${y}" r="3" fill="#7b5cff" />
          `;
        }).join('')}
      </g>
      <!-- Xè»¸ãƒ©ãƒ™ãƒ« -->
      <g>
        ${xLabels.map(l => `
          <text x="${l.x}" y="${height-4}" text-anchor="middle"
                fill="rgba(167,176,194,0.9)" font-size="9">
            ${escapeHTML(l.text)}
          </text>
        `).join('')}
      </g>
    </svg>
  `;

  body.innerHTML = svg;
}


function initHomeKpiEvents(){
  // ã‚¿ã‚¤ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ‡æ›¿
  $$('.kpi-tile').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const metric = btn.dataset.metric;
      if(!metric) return;
      kpiCurrentMetric = metric;
      $$('.kpi-tile').forEach(b => b.classList.toggle('active', b === btn));
      renderHomeGraph();
    });
  });
  // 7/30/120 æ—¥ãƒœã‚¿ãƒ³
  $$('.kpi-range-switch button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const range = Number(btn.dataset.range || '7') || 7;
      kpiCurrentRange = range;
      $$('.kpi-range-switch button').forEach(b => b.classList.toggle('active', b === btn));
      renderHomeGraph();
    });
  });
}





/* =========================
   Wake Lockï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
========================= */
const KeepAwake = (()=>{
  let wakeLock=null, enabled=false, videoEl=null, canvas=null, stream=null;
  async function requestWakeLock(){ if(!('wakeLock' in navigator)) throw new Error('no_wakelock'); wakeLock = await navigator.wakeLock.request('screen'); }
  function ensureVideoNode(){ if(videoEl) return; videoEl=document.createElement('video'); videoEl.muted=true; videoEl.loop=true; videoEl.playsInline=true; Object.assign(videoEl.style,{position:'fixed',width:'1px',height:'1px',left:'-9999px',top:'-9999px'}); document.body.appendChild(videoEl); }
  function ensureCanvasStream(){ if(canvas&&stream) return; canvas=document.createElement('canvas'); canvas.width=1; canvas.height=1; const ctx=canvas.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,1,1); stream=canvas.captureStream(1); }
  async function startVideoFallback(){ ensureVideoNode(); ensureCanvasStream(); try{ if(videoEl.srcObject!==stream) videoEl.srcObject=stream; await videoEl.play(); }catch(e){} }
  async function enable(){ if(enabled) return; enabled=true; try{ await requestWakeLock(); document.addEventListener('visibilitychange', reAcquire, false); }catch(e){ await startVideoFallback(); document.addEventListener('visibilitychange', ensureVideoResume, false); } }
  async function reAcquire(){ if(document.visibilityState==='visible' && enabled){ try{ if(wakeLock?.released) await requestWakeLock(); }catch(e){} } }
  async function ensureVideoResume(){ if(document.visibilityState==='visible' && enabled && videoEl && videoEl.paused){ try{ await videoEl.play(); }catch(e){} } }
  async function disable(){ enabled=false; document.removeEventListener('visibilitychange', reAcquire, false); document.removeEventListener('visibilitychange', ensureVideoResume, false); try{ await wakeLock?.release(); }catch(e){} wakeLock=null; if(videoEl){ try{ videoEl.pause(); }catch(e){} } }
  return { enable, disable };
})();

/* =========================
   è¨­å®š
========================= */
const LS_SETTINGS='speakscene_settings_v1';
const defaultSettings={ ttsLang:'en-US', voiceName:'', rate:1.0, pitch:1.0, volume:1.0, gapSec:1.0, repeat:1, speakTarget:'en', keepAwake:false };
let settings = loadSettings();
function loadSettings(){ try{ return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}')); }catch(e){ return {...defaultSettings}; } }
function saveSettings(){ localStorage.setItem(LS_SETTINGS, JSON.stringify(settings)); }

/* =========================
   IndexedDB
========================= */
const DB_NAME='speakscene_db', DB_VER=1, STORE='sentences';
let db;
openDB();
function openDB(){
  const req = indexedDB.open(DB_NAME, DB_VER);
  req.onupgradeneeded = e=>{
    const db = e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      const os = db.createObjectStore(STORE,{keyPath:'id'});
      os.createIndex('createdAt','createdAt'); os.createIndex('updatedAt','updatedAt');
      os.createIndex('english','english'); os.createIndex('playCount','playCount');
    }
  };
req.onsuccess = e=>{
  db = e.target.result;
  refreshList();
  fillCategoryFilter();
  updateHomeKpi(); // ãƒ›ãƒ¼ãƒ ã®ã‚°ãƒ©ãƒ•ï¼ˆç™»éŒ²ä¾‹æ–‡æ•°ï¼‰ã‚‚æ›´æ–°
};




  req.onerror = e=>{ console.error('DB open error', e); alert('DBåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'); };
}
function store(mode='readonly'){ return db.transaction([STORE], mode).objectStore(STORE); }
const addSentence = item => new Promise(res=> store('readwrite').add(item).onsuccess=()=>res());
const updateSentence = item => new Promise(res=> store('readwrite').put(item).onsuccess=()=>res());
const deleteSentence = id => new Promise(res=> store('readwrite').delete(id).onsuccess=()=>res());
const getAll = ()=> new Promise((res,rej)=>{ const r=store().getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=rej; });
const getOne = id => new Promise((res,rej)=>{ const r=store().get(id); r.onsuccess=()=>res(r.result||null); r.onerror=rej; });

async function clearAllSentences(){
  if(!db) return;
  return new Promise((resolve,reject)=>{
    try{
      const tx = db.transaction([STORE],'readwrite');
      const os = tx.objectStore(STORE);
      os.clear();
      tx.oncomplete = ()=>resolve();
      tx.onerror = e=>reject(e);
      tx.onabort  = e=>reject(e);
    }catch(e){ reject(e); }
  });
}

/* =========================
   ç”»é¢é·ç§»/ãƒŠãƒ“
========================= */
function stopAllPlayback(){
  try { speechSynthesis.cancel(); } catch(_) {}
}
const views = {
  home: $('#view-home'),
  create: $('#view-create'),
  list: $('#view-list'),
  shadow: $('#view-shadow')
};

function closeAllDialogs(){
  for(const id of ['#dlg-detail','#dlg-shadow','#dlg-settings','#dlg-help','#dlg-lookup']){
    try{
      const d=$(id);
      if(d?.open) d.close();
    }catch(_){}
  }
}
function show(view){
  stopAllPlayback();
  KeepAwake.disable();
  closeAllDialogs();

  // â˜… ç”»é¢åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ç™ºéŸ³è©•ä¾¡ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
  resetPronColors($('#d-en'));
  resetPronColors($('#sh-text'));

  Object.values(views).forEach(v=>v.classList.remove('active'));
  views[view].classList.add('active');
}

$('#nav-home').onclick = () => {
  setActiveNav('nav-home');
  show('home');
  updateHomeKpi();
};



$('#nav-create').onclick = () => { setActiveNav('nav-create'); show('create'); };
$('#nav-list').onclick   = () => { setActiveNav('nav-list');   show('list'); refreshList(); };
$('#nav-settings').onclick = () => { stopAllPlayback(); setActiveNav(); $('#dlg-settings').showModal(); openSettingsFields(); };
$('#nav-help').onclick = () => { stopAllPlayback(); $('#dlg-help').showModal(); };
$('#help-close')?.addEventListener('click', ()=>{ stopAllPlayback(); $('#dlg-help').close(); });
$('#nav-shadow').onclick = () => { setActiveNav('nav-shadow'); prepareShadow(); show('shadow'); };
function setActiveNav(id){ $$('nav button').forEach(b=>b.classList.remove('active')); if(id) $('#'+id).classList.add('active'); }

/* =========================
   ç™»éŒ²ç”»é¢
========================= */
function defaultSaveHandler(){
  $('#btn-save').onclick = async ()=>{
    const scene = $('#scene').value.trim();
    const english = $('#en').value.trim();
    if(!scene){ alert('ã€Œå ´é¢ã€ã¯å¿…é ˆã§ã™'); return; }
    if(!english && !$('#ja').value.trim()){
      if(!confirm('è‹±æ–‡ã¨å’Œè¨³ãŒæœªå…¥åŠ›ã§ã™ã€‚ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
    }
const item = collectFormToItem();
item.id = uid(); item.createdAt = now(); item.updatedAt = now();
item.favorite=false; item.playCount=0;
await addSentence(item);
trackKpiAdd(1); // â˜… ä»Šæ—¥ã®ç™»éŒ²æ•°ã«+1

clearForm(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
fillCategoryFilter(); refreshList();
setActiveNav('nav-list'); show('list');

  };
}
function collectFormToItem(base={}){
  const scene = $('#scene').value.trim();
  const english = $('#en').value.trim();
  const japanese = $('#ja').value.trim();
  const categories = Array.from($('#cats').selectedOptions).map(o=>o.value);
  const tags = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const notes = $('#notes').value.trim();
  return Object.assign(base, { scene, english, japanese, categories, tags, notes });
}
function clearForm(){ ['scene','en','ja','tags','notes'].forEach(id=>$('#'+id).value=''); Array.from($('#cats').options).forEach(o=>o.selected=false); const pv=$('#preview-en'); pv.classList.add('hidden'); pv.innerHTML=''; }
$('#btn-clear').onclick = ()=> clearForm();
defaultSaveHandler();

/* --- ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘ï¼ˆãƒ©ãƒ™ãƒ«ã‚¿ãƒƒãƒ—ï¼‰ --- */
async function pasteClipboardTo(targetId){
  if(!navigator.clipboard || !navigator.clipboard.readText){
    alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }
  try{
    const txt = await navigator.clipboard.readText();
    if(!txt){
      alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }
    const el = $('#'+targetId);
    if(!el) return;
    el.value = txt;
    el.focus();
  }catch(e){
    console.error(e);
    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
}
$('#lbl-en')?.addEventListener('click', ()=> pasteClipboardTo('en'));
$('#lbl-ja')?.addEventListener('click', ()=> pasteClipboardTo('ja'));

/* =========================
   ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ»ãƒˆãƒ¼ã‚¯ãƒ³
========================= */
function tokenizeWords(text){ const tokens=[]; if(!text) return tokens; const re=/\S+/g; let m; while((m=re.exec(text))!==null){ tokens.push({text:m[0], start:m.index, end:m.index+m[0].length}); } return tokens; }
function renderSpeakText(container, text){
  container.innerHTML = ''; container.classList.add('speak-text');
  const tokens = tokenizeWords(text);
  if(tokens.length===0){ container.textContent = text||''; container._tokens=[]; return; }
  let html='', cursor=0;
  for(const t of tokens){
    if(cursor<t.start) html += escapeHTML(text.slice(cursor, t.start));
    html += `<span class="w" data-start="${t.start}" data-end="${t.end}">${escapeHTML(t.text)}</span><wbr>`;
    cursor=t.end;
  }
  if(cursor<text.length) html += escapeHTML(text.slice(cursor));
  container.innerHTML = html; container._tokens = tokens; container._lastKey=null;
}
function clearHighlight(container){ container?.querySelectorAll('.w.hl').forEach(el=>el.classList.remove('hl')); }
let _scrollLock=false;
function scrollIntoViewIfNeeded(el, container){
  if(!el||!container||_scrollLock) return;
  _scrollLock=true;
  requestAnimationFrame(()=>{
    try{
      const cRect=container.getBoundingClientRect(); const eRect=el.getBoundingClientRect(); const pad=8;
      if(eRect.top<cRect.top+pad || eRect.bottom>cRect.bottom-pad){ el.scrollIntoView({block:'center', inline:'nearest', behavior:'smooth'}); }
    }finally{ setTimeout(()=>{ _scrollLock=false; },60); }
  });
}
function highlightToken(container, token){
  const key=token.start+'-'+token.end; if(container._lastKey===key) return;
  container._lastKey=key;
  clearHighlight(container);
  const el=container.querySelector(`span.w[data-start="${token.start}"][data-end="${token.end}"]`);
  if(el){ el.classList.add('hl'); scrollIntoViewIfNeeded(el, container); }
}
function highlightAtCharIndex(container, charIndex){
  if(!container||!container._tokens) return; const tokens=container._tokens; if(tokens.length===0) return;
  let idx=-1; for(let i=0;i<tokens.length;i++){ const t=tokens[i]; if(charIndex>=t.start && charIndex<t.end){ idx=i; break; } if(charIndex<t.start){ idx=i-1; break; } }
  if(idx<0) idx=0; highlightToken(container, tokens[idx]);
}
/* =========================
   ç™ºéŸ³è©•ä¾¡ï¼ˆéŒ²éŸ³çµæœ â†’ å˜èªè‰²ï¼‰
========================= */

// å˜èªè‰²ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆstyle.color ã‚’å…ƒã«æˆ»ã™ï¼‰
function resetPronColors(container){
  if(!container) return;
  container.querySelectorAll('.speak-text .w, .w').forEach(span=>{
    span.style.color = ''; // CSS ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
  });
}

// ãƒ¬ãƒ™ãƒ«é…åˆ—ã‚’ã‚‚ã¨ã«è‰²ã‚’å½“ã¦ã‚‹
// level: 0=ç™½, 1=é»„, 2=èµ¤
function applyPronColors(container, levels){
  if(!container) return;
  const spans = Array.from(container.querySelectorAll('.w'));
  spans.forEach((span, i)=>{
    const level = levels[i] || 0;
    if(level === 2){
      span.style.color = '#ff4d4f';   // æ˜ç­ï¼ˆèµ¤ï¼‰
    }else if(level === 1){
      span.style.color = '#ffb020';   // ãªã‚“ã¨ã‹èãå–ã‚Œã‚‹ï¼ˆé»„ï¼‰
    }else{
      span.style.color = '';          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç™½ï¼‰
    }
  });
}

// éŒ²éŸ³ Blob ã‹ã‚‰å˜èªã”ã¨ã®éŸ³é‡ã‚’ã–ã£ãã‚Šè©•ä¾¡
async function evalPronFromBlob(container, blob){
  try{
    if(!container || !container._tokens || !container._tokens.length) return;
    if(!blob) return;

    // AudioContext ã‚’ç¢ºä¿
    if(!audioCtx){
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return; // éå¯¾å¿œç’°å¢ƒ
      audioCtx = new AC();
    }

    const buf = await blob.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(buf);
    const chData = audioBuffer.getChannelData(0);
    if(!chData) return;

    const tokens = container._tokens;
    const n = tokens.length;
    if(n === 0) return;

    const totalSamples = chData.length;
    const samplesPerToken = Math.max(1, Math.floor(totalSamples / n));
    const levels = new Array(n).fill(0);

    // ã—ãã„å€¤ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦å¾®èª¿æ•´ã™ã‚‹ãªã‚‰ã“ã“ï¼‰
    const TH_RED    = 0.08; // ã“ã‚Œä»¥ä¸Šãªã‚‰ã€Œæ˜ç­ï¼ˆèµ¤ï¼‰ã€
    const TH_YELLOW = 0.03; // ã“ã‚Œä»¥ä¸Šãªã‚‰ã€Œé»„ã€

    for(let i=0;i<n;i++){
      const start = i * samplesPerToken;
      const end   = (i === n-1) ? totalSamples : (i+1)*samplesPerToken;
      let sum = 0, count = 0;
      for(let j=start;j<end && j<totalSamples;j++){
        const v = chData[j];
        sum += v*v;
        count++;
      }
      if(!count) continue;
      const rms = Math.sqrt(sum / count); // ãã®åŒºé–“ã®éŸ³é‡

      if(rms >= TH_RED){
        levels[i] = 2;
      }else if(rms >= TH_YELLOW){
        levels[i] = 1;
      }else{
        levels[i] = 0;
      }
    }

    applyPronColors(container, levels);
  }catch(e){
    console.warn('evalPronFromBlob error', e);
  }
}

/* =========================
   TTS å˜ä¸€ã‚¨ãƒ³ã‚¸ãƒ³ + ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é©å¿œ
========================= */
let voices=[]; let ttsWarmed=false; let audioCtx=null;


// iOSã§ã€Œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—ã—ãŸç¬é–“ã«ã€
// 1å›ã ã‘åŒæœŸçš„ã«ã”ãå°ã•ã„ç„¡éŸ³ã®ç™ºè©±ã‚’è¡Œã„ã€éŸ³å£°å‡ºåŠ›ã‚’è§£éŒ ã™ã‚‹
let iosShadowPrimed = false;
function forceIOSShadowClickWarmup(){
  if (!isIOS || iosShadowPrimed) return;
  iosShadowPrimed = true;
  try{
    // å¯èƒ½ãªã‚‰æœ€æ–°ã®voiceä¸€è¦§ã‚’å–å¾—
    const list = speechSynthesis.getVoices();
    if (list && list.length) {
      voices = list;
    }
    const v = pickVoice();
    const u = new SpeechSynthesisUtterance(' ');
    if (v) u.voice = v;
    u.lang = v?.lang || settings.ttsLang || 'en-US';
    u.rate = 1.0;
    u.volume = 0.001; // ã»ã¼ç„¡éŸ³

    // ã„ã£ãŸã‚“ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‹ã‚‰ã”ãçŸ­ã„ç™ºè©± â†’ ã™ãã‚­ãƒ£ãƒ³ã‚»ãƒ«
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
    setTimeout(()=>{ 
      try{ speechSynthesis.cancel(); }catch(_){}
    }, 300);
  }catch(e){
    console.warn('forceIOSShadowClickWarmup error', e);
  }
}


speechSynthesis.onvoiceschanged = ()=> loadVoices();
function findAndroidEnglishVoices(list){
  const enCandidates = (list||[]).filter(v=>/^en(-|_)?/i.test(v.lang||'') || /English/i.test(v.name||''));
  const google = enCandidates.filter(v=>/Google/i.test(v.name||''));
  return google.length ? google : enCandidates;
}
async function loadVoices(){
  voices = speechSynthesis.getVoices() || [];
  if (!voices.length) {
    for (let i=0; i<10 && (!voices || voices.length===0); i++){
      await new Promise(r=>setTimeout(r,100));
      voices = speechSynthesis.getVoices() || [];
    }
  }
  if(!settings.voiceName){
    if(isIOS){
      const samantha = voices.find(v=>/Samantha/i.test(v.name) && /^en-US/i.test(v.lang));
      if(samantha){ settings.voiceName=samantha.name; settings.ttsLang='en-US'; }
    }else if(isAndroid){
      const picks = findAndroidEnglishVoices(voices);
      if(picks.length){ settings.voiceName = ''; settings.ttsLang = picks[0].lang || 'en-US'; }
      else{ settings.voiceName=''; settings.ttsLang='en-US'; }
    }else{
      const pref=[/Microsoft\s+Eric\s+Online.*Natural/i,/Microsoft\s+Aria\s+Online.*Natural/i,/Microsoft\s+Guy\s+Online.*Natural/i,/Microsoft\s+Jenny\s+Online.*Natural/i];
      let picked=null; for(const re of pref){ picked=voices.find(v=>re.test(v.name) && /^en-US/i.test(v.lang)); if(picked) break; }
      if(!picked){ picked=voices.find(v=>/^en-US/i.test(v.lang)) || voices.find(v=>v.default) || voices[0]; }
      if(picked){ settings.voiceName=picked.name; settings.ttsLang=picked.lang||'en-US'; }
    }
    saveSettings();
  }
  renderVoiceList();
}
function renderVoiceList(){
  const sel=$('#voice'); if(!sel) return;
  const prev=settings.voiceName||''; sel.innerHTML='';
  const list=(voices||[]).slice().sort((a,b)=>(a.lang||'').localeCompare(b.lang||'')||(a.name||'').localeCompare(b.name||'')); 
  for(const v of list){ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})${v.default?' â˜…':''}`; sel.appendChild(opt); }
  sel.value = list.some(v=>v.name===prev) ? prev : (list[0]?.name || '');
}
function pickVoice(){
  if(!voices || voices.length===0) voices = speechSynthesis.getVoices() || [];
  if(settings.voiceName){ const byName = voices.find(v=>v.name===settings.voiceName); if(byName) return byName; }
  if(isIOS){ const s=voices.find(v=>/Samantha/i.test(v.name) && /^en-US/i.test(v.lang)); if(s) return s; }
  const e=voices.find(v=>/Microsoft\s+Eric\s+Online.*Natural/i.test(v.name) && /^en-US/i.test(v.lang));
  if(e) return e;
  if(settings.ttsLang){ const byLang = voices.find(v=>v.lang && v.lang.startsWith(settings.ttsLang)); if(byLang) return byLang; }
  return voices.find(v=>v.default) || voices[0] || null;
}

// â˜…è¿½åŠ ï¼šiOSç”¨ ä¼šè©±ãƒ­ãƒ¼ãƒ«ã”ã¨ã®å£°é¸æŠ
function pickRoleVoice(role){
  // iOSä»¥å¤–ã§ã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ¨™æº–ã® pickVoice ã‚’ä½¿ã†ï¼‰
  if (!isIOS || !role) return null;
  if (!voices || !voices.length) {
    voices = speechSynthesis.getVoices() || [];
  }

  if (role === 'W') {
    // å¥³æ€§ï¼šSamantha(en-US)
    const s = voices.find(v => /Samantha/i.test(v.name) && /^en-US/i.test(v.lang || ''));
    return s || null;
  }
  if (role === 'M') {
    // ç”·æ€§ï¼šDaniel(en-GB)
    const d = voices.find(v => /Daniel/i.test(v.name) && /^en-GB/i.test(v.lang || ''));
    return d || null;
  }
  return null;
}


async function ensureTtsUnlocked(){
  if(ttsWarmed) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    gain.gain.value = 0.0001; osc.connect(gain).connect(audioCtx.destination); osc.start();
    setTimeout(()=>{ try{osc.stop();osc.disconnect();gain.disconnect();}catch(_){ } }, 12);
  }catch(_){}
  try {
    try{ speechSynthesis.cancel(); }catch(e){}
    const v = pickVoice();
    const warm = new SpeechSynthesisUtterance('okay');
    if (v) warm.voice = v;
    warm.lang = v?.lang || settings.ttsLang || 'en-US';
    warm.rate = 1.0; warm.pitch = 1.0; warm.volume = 0.01;
    await new Promise(res=>{
      let done=false; const finish=()=>{ if(!done){ done=true; res(); } };
      warm.onend = finish; warm.onerror = finish;
      setTimeout(()=>{ try{ speechSynthesis.speak(warm); }catch(_){ finish(); } }, 80);
      setTimeout(finish, 1200);
    });
  } finally { ttsWarmed = true; }
}

/* ---- å˜ä¸€TTSã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆé€”ä¸­å†é–‹ã«å¯¾å¿œï¼‰ ---- */
class SpeakEngine {
  constructor(){
    this.state='idle';
    this.session=0;
    this._lastBoundary=0;
    this._ev={};
  }
  getLastBoundary(){ return this._lastBoundary || 0; }
async play(script, {targetEl, rate, startCharIndex=0}={}){
  if(this.state==='playing'){ await this.stop(); }
  this.session++; const my=this.session;
  this.state='playing'; this._emit('state','playing');
  await ensureTtsUnlocked(); await loadVoices();
  const self = this;

  // â˜…å¤‰æ›´ï¼švoiceOverrideï¼ˆå½¹å‰²åˆ¥ã®å£°æŒ‡å®šï¼‰ã¨ baseOffset ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«
  const speakOne = (text,langHint, {baseOffset=0, voiceOverride=null} = {})=>{
    return new Promise(resolve=>{
      if(my!==self.session) return resolve();
      if(!text){ return resolve(); }

      const u = new SpeechSynthesisUtterance(text);

      // ã“ã“ã§å£°ã‚’æ±ºå®šï¼šå„ªå…ˆã¯ voiceOverride â†’ é€šå¸¸ã® pickVoice()
      const v = voiceOverride || pickVoice();
      if(v) u.voice = v;

      u.lang = v?.lang || langHint || settings.ttsLang || (/[a-zA-Z]/.test(text)?'en-US':'ja-JP');
      u.rate = rate ?? settings.rate;
      u.pitch = settings.pitch;
      u.volume = settings.volume;

      let fbTimer=null, usedBoundary=false;
      if(targetEl && /[A-Za-z]/.test(text)){
        u.onboundary=(e)=>{
          if(typeof e.charIndex==='number'){
            usedBoundary=true;
            const abs = baseOffset + e.charIndex;
            self._lastBoundary = abs;
            highlightAtCharIndex(targetEl, abs);
            self._emit('boundary', abs);
          }
        };
        const tokens = tokenizeWords(text);
        if(tokens.length>0){
          let idx=0; const wpm=170*(u.rate||1.0); const msPerWord=Math.max(120, Math.round(60000/wpm));
          fbTimer=setInterval(()=>{
            if(usedBoundary){clearInterval(fbTimer);return;}
            if(idx>=tokens.length){clearInterval(fbTimer);return;}
            const t=tokens[Math.min(idx++, tokens.length-1)];
            const abs = baseOffset + t.start;
            self._lastBoundary = abs;
            highlightAtCharIndex(targetEl, abs);
            self._emit('boundary', abs);
          }, msPerWord);
        }
      }
      const cleanup=()=>{ if(fbTimer) clearInterval(fbTimer); if(targetEl) clearHighlight(targetEl); };

      u.onend = ()=>{ cleanup(); resolve(); };
      u.onerror=()=>{ cleanup(); resolve(); };

      try { speechSynthesis.cancel(); } catch(e){}

      const delay = isIOS ? 0 : 40;

      if (delay === 0) {
        try {
          if (my === self.session) {
            speechSynthesis.speak(u);
          } else {
            resolve();
          }
        } catch(e) {
          setTimeout(()=>resolve(), 120);
        }
      } else {
        setTimeout(()=>{
          try {
            if (my === self.session) {
              speechSynthesis.speak(u);
            } else {
              resolve();
            }
          } catch(e) {
            setTimeout(()=>resolve(), 120);
          }
        }, delay);
      }
    });
  };



  // â˜…è¿½åŠ ï¼šé€”ä¸­ã‹ã‚‰å†é–‹ã™ã‚‹æ™‚ã®ã‚¹ãƒ©ã‚¤ã‚¹ï¼ˆæ—¢å­˜é–¢æ•°ã‚’ãã®ã¾ã¾æ®‹ã™ï¼‰
  function sliceFromChar(text, charIndex){
    if(!text) return {slice:text, base:0};
    const toks = tokenizeWords(text);
    if(toks.length===0) return {slice:text, base:0};
    let base=0;
    for(let i=0;i<toks.length;i++){
      const t=toks[i];
      if(charIndex <= t.end){ base=t.start; break; }
    }
    return {slice: text.slice(base), base};
  }

  // â˜…è¿½åŠ ï¼šW:/M: ã‚’å«ã‚€è¡Œã”ã¨ã®ä¼šè©±ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½œã‚‹
  //  - displayStart / displayEnd ã¯ã€Œå…ƒã®è‹±æ–‡ã€ä¸­ã®ä½ç½®
  //  - displayBase ã¯ã€ŒW:/M: (ï¼‹ã‚¹ãƒšãƒ¼ã‚¹) ã‚’é™¤ã„ãŸå…ˆé ­ä½ç½®ã€
  //  - spokenText ã¯å®Ÿéš›ã«èª­ã¿ä¸Šã’ã‚‹æ–‡å­—åˆ—ï¼ˆW:/M: ã‚’ã‚«ãƒƒãƒˆæ¸ˆã¿ï¼‰
  function buildRoleSegments(enText){
    const segments = [];
    if(!enText) return segments;

    const len = enText.length;
    let pos = 0;
    while(pos < len){
      const nl = enText.indexOf('\n', pos);
      const lineEnd = (nl === -1) ? len : nl;
      const line = enText.slice(pos, lineEnd);

      const displayStart = pos;
      const displayEnd   = lineEnd;

      let role = null;
      let prefixLen = 0;

      if(line.startsWith('W:')){
        role = 'W';
        prefixLen = 2 + (line.charAt(2)===' ' ? 1 : 0);
      }else if(line.startsWith('M:')){
        role = 'M';
        prefixLen = 2 + (line.charAt(2)===' ' ? 1 : 0);
      }

      if(prefixLen > line.length) prefixLen = line.length;

      const spokenText  = line.slice(prefixLen);      // â˜… W:/M: ã¯ã“ã“ã§å‰Šé™¤
      const displayBase = displayStart + prefixLen;   // â˜… ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®åŸºæº–ä½ç½®

      segments.push({
        role,          // 'W' | 'M' | null
        spokenText,    // å®Ÿéš›ã«èª­ã¿ä¸Šã’ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
        displayStart,  // å…ƒãƒ†ã‚­ã‚¹ãƒˆä¸­ã®è¡Œã®é–‹å§‹ä½ç½®
        displayEnd,    // å…ƒãƒ†ã‚­ã‚¹ãƒˆä¸­ã®è¡Œã®çµ‚äº†ä½ç½®ï¼ˆæ”¹è¡Œå«ã¾ãšï¼‰
        displayBase    // W:/M: ã‚’é™¤ã„ãŸå…ˆé ­ä½ç½®
      });

      if(nl === -1) break;
      pos = nl + 1; // æ”¹è¡Œã®æ¬¡ã‹ã‚‰æ¬¡è¡Œ
    }
    return segments;
  }





    function sliceFromChar(text, charIndex){
      if(!text) return {slice:text, base:0};
      const toks = tokenizeWords(text);
      if(toks.length===0) return {slice:text, base:0};
      let base=0;
      for(let i=0;i<toks.length;i++){
        const t=toks[i];
        if(charIndex <= t.end){ base=t.start; break; }
      }
      return {slice: text.slice(base), base};
    }

    const doFlow = async ()=>{
      const en = (script.en || '').trim();
      const ja = (script.ja || '').trim();
      const rep = Math.max(1, parseInt(script.repeat || 1, 10));
      const gap = Math.max(0, Number(script.gapSec || 0)) * 1000;

      // â˜… iOS ã‹ã¤ã€è¡Œé ­ã« W: / M: ã‚’å«ã‚€è‹±æ–‡ãªã‚‰ã€Œä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      const hasRoleMarkers = /(^|\n)[WM]:/.test(en);
      const useRoleVoices  = isIOS && hasRoleMarkers;
      const roleSegments   = useRoleVoices ? buildRoleSegments(en) : null;

      if(script.order === 'en'){
        // è‹±èªã®ã¿å†ç”Ÿ
        if(targetEl){
          renderSpeakText(targetEl, en);
          targetEl.scrollTop = 0;
        }
        const startAt = Number(startCharIndex || script.startCharIndex || 0);

        if(useRoleVoices && roleSegments && roleSegments.length){
          // â˜… iOSé™å®šï¼šW:/M: è¡Œã”ã¨ã«å£°ã‚’åˆ‡ã‚Šæ›¿ãˆã€W:/M: ã¯èª­ã¾ãªã„
          const startIndex = Math.max(0, startAt);

          // å†é–‹ä½ç½®ã«å¯¾å¿œã™ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
          let startSeg = 0;
          for(let i=0;i<roleSegments.length;i++){
            if(roleSegments[i].displayEnd <= startIndex){
              startSeg = i + 1;
            }else{
              break;
            }
          }

          for(let r=0;r<rep;r++){
            if(my!==self.session) return;
            for(let i=0;i<roleSegments.length;i++){
              const seg = roleSegments[i];

              // æœ€åˆã®ãƒ«ãƒ¼ãƒ—ï¼†å†é–‹ä½ç½®ãŒã“ã®è¡Œã®é€”ä¸­ãªã‚‰ã€ãã®ä½ç½®ã‹ã‚‰é–‹å§‹
              let localStart = 0;
              if(r === 0 && i === startSeg && startIndex > seg.displayBase){
                localStart = Math.max(0, startIndex - seg.displayBase);
              }

              const textForThis = localStart ? seg.spokenText.slice(localStart) : seg.spokenText;
              if(textForThis.trim()){
                const voiceOverride = pickRoleVoice(seg.role); // W â†’ Samantha, M â†’ Danielï¼ˆiOSã®ã¿ï¼‰

                await speakOne(textForThis, 'en-US', {
                  baseOffset: seg.displayBase + localStart,  // ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯å…ƒãƒ†ã‚­ã‚¹ãƒˆåŸºæº–
                  voiceOverride
                });
                if(my!==self.session) return;
              }

              // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé–“ï¼ãƒªãƒ”ãƒ¼ãƒˆé–“ã®é–“åˆã„
              if(gap && (i < roleSegments.length - 1 || r < rep - 1)){
                await sleep(gap);
                if(my!==self.session) return;
              }
            }
          }

        }else{
          // â˜…å¾“æ¥é€šã‚Šï¼š1ã¤ã®å£°ã§å…¨æ–‡å†ç”Ÿï¼ˆWindows/Android ã‚‚ã“ã¡ã‚‰ï¼‰
          const {slice, base} = startAt > 0 ? sliceFromChar(en, startAt) : {slice: en, base: 0};
          for(let i=0;i<rep;i++){
            if(my!==self.session) return;
            await speakOne(i===0 ? slice : en, 'en-US', { baseOffset: i===0 ? base : 0 });
            if(i<rep-1 && gap){ await sleep(gap); }
          }
        }

      }else if(script.order === 'ja'){
        // æ—¥æœ¬èªã®ã¿
        await speakOne(ja, 'ja-JP');

      }else{
        // both: è‹± â†’ é–“ â†’ å’Œ
        if(targetEl){
          renderSpeakText(targetEl, en);
          targetEl.scrollTop = 0;
        }
        const startAt = Number(startCharIndex || script.startCharIndex || 0);

        if(useRoleVoices && roleSegments && roleSegments.length){
          // â˜… iOSé™å®šï¼šä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã§è‹±èª â†’ ãã®ã‚ã¨å’Œè¨³
          const startIndex = Math.max(0, startAt);

          let startSeg = 0;
          for(let i=0;i<roleSegments.length;i++){
            if(roleSegments[i].displayEnd <= startIndex){
              startSeg = i + 1;
            }else{
              break;
            }
          }

          for(let r=0;r<rep;r++){
            if(my!==self.session) return;
            for(let i=0;i<roleSegments.length;i++){
              const seg = roleSegments[i];

              let localStart = 0;
              if(r === 0 && i === startSeg && startIndex > seg.displayBase){
                localStart = Math.max(0, startIndex - seg.displayBase);
              }

              const textForThis = localStart ? seg.spokenText.slice(localStart) : seg.spokenText;
              if(textForThis.trim()){
                const voiceOverride = pickRoleVoice(seg.role);

                await speakOne(textForThis, 'en-US', {
                  baseOffset: seg.displayBase + localStart,
                  voiceOverride
                });
                if(my!==self.session) return;
              }

              if(gap && (i < roleSegments.length - 1 || r < rep - 1)){
                await sleep(gap);
                if(my!==self.session) return;
              }
            }
          }

          if(ja){
            await speakOne(ja, 'ja-JP');
          }

        }else{
          // å¾“æ¥é€šã‚Šï¼šè‹±èªã¯å˜ä¸€ã®å£°ã§ã€ãã®å¾Œã«å’Œè¨³
          const {slice, base} = startAt > 0 ? sliceFromChar(en, startAt) : {slice: en, base: 0};
          for(let i=0;i<rep;i++){
            if(my!==self.session) return;
            await speakOne(i===0 ? slice : en, 'en-US', { baseOffset: i===0 ? base : 0 });
            if(gap){ await sleep(gap); }
          }
          if(ja){ await speakOne(ja, 'ja-JP'); }
        }
      }
    };


const t0 = performance.now();
await doFlow();
let dur = performance.now() - t0;

if(my===self.session && dur < 150 && !speechSynthesis.speaking){
  // ã”ãçŸ­æ™‚é–“ã§çµ‚ã‚ã£ãŸï¼èµ·çˆ†ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ â†’ ã‚‚ã†ä¸€åº¦ã ã‘è©¦ã™
  await ensureTtsUnlocked(); await loadVoices(); await sleep(120);
  if(my===self.session){
    await doFlow();
    dur = performance.now() - t0; // 2å›ç›®ã‚‚å«ã‚ãŸå®Ÿæ™‚é–“
  }
}

if(my===self.session){
  this.state='idle';
  this._emit('state','idle');
  this._emit('ended', { durationMs: dur });

  // â˜… KPIï¼šå†ç”Ÿæ™‚é–“ã‚’è¨˜éŒ²ï¼ˆ0.2ç§’æœªæº€ã¯ãƒã‚¤ã‚ºã¨ã—ã¦ç„¡è¦–ï¼‰
  if(dur > 200){
    trackKpiPlay(dur);
  }
}
  }    // â† ã“ã®ã‚«ãƒƒã‚³ãŒæŠœã‘ã¦ã„ãŸ
  pause(){ try{ if(this.state==='playing'){ speechSynthesis.pause(); this.state='paused'; this._emit('state','paused'); } }catch(_){} }
  resume(){ try{ if(this.state==='paused'){ speechSynthesis.resume(); this.state='playing'; this._emit('state','playing'); } }catch(_){} }
  async stop(){ try{ this.session++; speechSynthesis.cancel(); this.state='idle'; this._emit('state','idle'); }catch(_){} }
  on(ev,fn){ (this._ev||(this._ev={}))[ev]=(this._ev[ev]||[]); this._ev[ev].push(fn); }
  _emit(ev,...a){ (this._ev?.[ev]||[]).forEach(f=>{ try{ f(...a);}catch(_){}}); }
}
const speakEngine = new SpeakEngine();

/* =========================
   iOSåˆå›ã‚¿ãƒƒãƒ—ã§å¿…ãšã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
========================= */
let firstUserGestureDone = false;
function oneTimeWarmup(){
  if(firstUserGestureDone) return;
  firstUserGestureDone = true;
  ensureTtsUnlocked();
  loadVoices();
}
window.addEventListener('pointerdown', oneTimeWarmup, {once:true, passive:true});
window.addEventListener('touchend', oneTimeWarmup, {once:true, passive:true});

/* =========================
   ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç™»éŒ²ç”»é¢ï¼‰
========================= */
$('#btn-preview').onclick = async ()=>{
  const en = $('#en').value.trim() || '';
  const ja = $('#ja').value.trim();
  if(!en && !ja){ alert('è‹±èªä¾‹æ–‡ã‹å’Œè¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const cont = $('#preview-en');
  renderSpeakText(cont, en); cont.classList.remove('hidden'); cont.scrollTop = 0;
  await speakEngine.play({ en, ja, order: settings.speakTarget||'en', repeat: settings.repeat, gapSec: settings.gapSec }, { targetEl: cont });
};
$('#btn-pause-preview').onclick = ()=>{
  if(speakEngine.state==='playing') speakEngine.pause();
  else if(speakEngine.state==='paused') speakEngine.resume();
};

/* =========================
   ä¸€è¦§ã¨ã‚«ãƒ¼ãƒ‰
========================= */
const fCat=$('#f-cat'), fTag=$('#f-tag'), q=$('#q');
[fCat,fTag,q].forEach(el=> el.oninput = ()=>refreshList());
async function fillCategoryFilter(){
  const rows = await getAll();
  const cats = new Set();
  rows.forEach(r=>(r.categories||[]).forEach(c=>{
    if(ALLOWED_CATEGORIES.includes(c)) cats.add(c);
  }));
  fCat.innerHTML = `<option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option>` +
    Array.from(cats).sort().map(c=>`<option>${escapeHTML(c)}</option>`).join('');
}
async function refreshList(){
  if(!db) return;
  const rows = await getAll();
  const kw = q.value.trim().toLowerCase();
  const cat = fCat.value;
  const tagkw = fTag.value.trim().toLowerCase();
  let list = rows.filter(r=>{
    const rCats = (r.categories||[]).filter(c=>ALLOWED_CATEGORIES.includes(c));
    if(cat && !rCats.includes(cat)) return false;
    if(tagkw && !(r.tags||[]).some(t=>t.toLowerCase().includes(tagkw))) return false;
    if(kw){
      const hay = [r.scene,(r.tags||[]).join(' '),rCats.join(' ')].join(' ').toLowerCase();
      if(!hay.includes(kw)) return false;
    }
    return true;
  }).sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
  renderCards(list);
}
function renderCards(list){
  const root=$('#cards'); root.innerHTML='';
  if(list.length===0){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = '<div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®<strong>ç™»éŒ²</strong>ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    root.appendChild(div); return;
  }
  for(const r of list){
    const card=document.createElement('div'); card.className='card';
    const catsArr = (r.categories||[]).filter(c=>ALLOWED_CATEGORIES.includes(c));
    const cats=(catsArr).map(c=>`<span class="chip">${escapeHTML(c)}</span>`).join(' ');
    const tags=(r.tags||[]).map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join(' ');
    card.innerHTML = `<h3>${escapeHTML(r.scene || '(å ´é¢æœªè¨­å®š)')}</h3><div class="chips">${cats}</div><div class="chips" style="margin-top:4px">${tags}</div>`;
    card.onclick = ()=> openDetail(r.id);
    root.appendChild(card);
  }
}

/* =========================
   éŒ²éŸ³ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå˜ä¸€ã‚½ãƒ¼ã‚¹ï¼‰
========================= */
class RecEngine {
  constructor(){ this.reset(); }
  reset(){ this.mediaRecorder=null; this.stream=null; this.chunks=[]; this.url=null; this.startedAt=0; this.timerId=null; this.mime=''; this.state='idle'; }
  pickAudioMime(){
    try{
      if (window.MediaRecorder && typeof MediaRecorder.isTypeSupported === 'function'){
        if (MediaRecorder.isTypeSupported('audio/webm')) return 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/mp4'))  return 'audio/mp4';
        if (MediaRecorder.isTypeSupported('audio/ogg'))  return 'audio/ogg';
      }
    }catch(_){}
    return '';
  }
  async start(){
    if(this.state==='recording') return;
    let stream=null;
    try{ stream = await navigator.mediaDevices.getUserMedia({ audio:true }); }
    catch(e){ throw new Error('mic_denied'); }
    const mime = this.pickAudioMime();
    const mr = new MediaRecorder(stream, mime ? {mimeType:mime} : undefined);
    this.mediaRecorder = mr; this.stream=stream; this.chunks=[]; this.mime=mime; this.startedAt=performance.now(); this.state='recording';
    const slice = isIOS ? 1000 : 250;
    mr.ondataavailable = (ev)=>{ if(ev?.data && ev.data.size>0) this.chunks.push(ev.data); };
    return new Promise((resolve)=>{
      mr.onstart = ()=>{ this._tickStart(); resolve(); };
      try{ mr.start(slice); }catch(e){ this.state='idle'; throw e; }
    });
  }
  async stop(){
    if(this.state!=='recording') return null;
    this.state='stopping';
    const mr=this.mediaRecorder;
    return new Promise((resolve)=>{
      const done = async ()=>{
        this._tickStop();
        try{ this.stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
        this.stream=null; this.mediaRecorder=null;
        let blob = null;
        try{
          const type = this.mime || (mr?.mimeType || 'audio/webm');
          blob = new Blob(this.chunks, { type });
        }catch(_){}
        this.chunks=[];
        const finalize = ()=>{
          if(blob && blob.size>0){
            if(this.url){ try{ URL.revokeObjectURL(this.url); }catch(_){ } }
            this.url = URL.createObjectURL(blob);
            this.state='ready';
            resolve({blob, url:this.url, durationMs: Math.max(0, performance.now()-this.startedAt)});
          }else{
            this.state='idle';
            resolve(null);
          }
        };
        if(isIOS){ setTimeout(finalize, 300); } else { finalize(); }
      };
      try{
        mr.onstop = done;
        mr.stop();
      }catch(_){ done(); }
    });
  }
  dispose(){
    try{ this._tickStop(); }catch(_){}
    try{ this.mediaRecorder?.stop(); }catch(_){}
    try{ this.stream?.getTracks().forEach(t=>t.stop()); }catch(_){}
    try{ if(this.url){ URL.revokeObjectURL(this.url); } }catch(_){}
    this.reset();
  }
  _tickStart(){ const t=$('#d-rec-timer'); if(!t) return; t.textContent='0:00'; this.timerId=setInterval(()=>{ const s=Math.floor((performance.now()-this.startedAt)/1000); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); t.textContent=`${m}:${ss}`; }, 250); const row=$('#row-rec-extra'); if(row) row.classList.remove('hidden'); }
  _tickStop(){ if(this.timerId){ clearInterval(this.timerId); this.timerId=null; } }
}
const recEngine = new RecEngine();

/* =========================
   è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆé€”ä¸­é€Ÿåº¦å¤‰æ›´ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ï¼‰
========================= */
let currentDetailId=null;

function setPlayToggleLabel(btn, state){
  if(!btn) return;
  if(state==='playing'){ btn.textContent='â¸ åœæ­¢'; btn.classList.add('ok'); }
  else if(state==='paused'){ btn.textContent='â–¶ï¸ å†é–‹'; btn.classList.remove('ok'); }
  else { btn.textContent='â–¶ï¸ å†ç”Ÿ'; btn.classList.remove('ok'); }
}
function setRecButtonMode(mode){
  const b=$('#d-rec-main'); if(!b) return;
  const rowExtra = $('#row-rec-extra');
  const timerEl = $('#d-rec-timer');
  const playBtn = $('#d-rec-play');
  const delBtn = $('#d-rec-delete');

  if(mode==='recording'){
    b.textContent='â–  STOP';
    b.classList.add('recording');
    if(rowExtra) rowExtra.classList.remove('hidden');
    if(timerEl) timerEl.textContent='0:00';
    if(playBtn) playBtn.classList.add('hidden');
    if(delBtn) delBtn.classList.add('hidden');
  }else if(mode==='ready'){
    b.textContent='â— REC';
    b.classList.remove('recording');
    if(rowExtra) rowExtra.classList.remove('hidden');
    if(playBtn) playBtn.classList.remove('hidden');
    if(delBtn) delBtn.classList.remove('hidden');
  }else{ // idle
    b.textContent='â— REC';
    b.classList.remove('recording');
    if(rowExtra) rowExtra.classList.add('hidden');
    if(timerEl) timerEl.textContent='';
    if(playBtn) playBtn.classList.add('hidden');
    if(delBtn) delBtn.classList.add('hidden');
  }
}

async function openDetail(id){
  const row=await getOne(id); if(!row) return;
  currentDetailId=id;

  // iOS ç„¡éŸ³å¯¾ç­–ï¼šè©³ç´°è¡¨ç¤ºã¨åŒæ™‚ã«ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
  try { await ensureTtsUnlocked(); await loadVoices(); } catch(_){}

  $('#d-scene').textContent=row.scene||'(å ´é¢æœªè¨­å®š)';
  const meta=[];
  const catsArr = (row.categories||[]).filter(c=>ALLOWED_CATEGORIES.includes(c));
  if(catsArr.length) meta.push(...catsArr.map(c=>`<span class="flag">${escapeHTML(c)}</span>`));
  meta.push(`<span class="flag">å†ç”Ÿ ${row.playCount||0}</span>`);
  $('#d-meta').innerHTML=meta.join(' ');

  // è‹±æ–‡ï¼šã“ã‚Œã¾ã§é€šã‚Šãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãæ 
  const dEn = $('#d-en');
  renderSpeakText(dEn, row.english||''); 
  dEn.scrollTop = 0;

  // â˜… ç™ºéŸ³è©•ä¾¡ã®è‰²ã‚‚ãƒªã‚»ãƒƒãƒˆ
  resetPronColors(dEn);


  // å’Œæ–‡ï¼šæŠ˜ã‚ŠãŸãŸã¿ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ 
  const jaWrap = $('#d-ja-wrap');
  const jaBody = $('#d-ja');
  const jaBtn  = $('#d-toggle-ja');
  const jaText = (row.japanese || '').trim();

  if(jaBody){
    jaBody.textContent = jaText;
  }
  if(jaWrap && jaBtn){
    if(jaText){
      // å’Œè¨³ãŒã‚ã‚‹å ´åˆï¼šãƒœã‚¿ãƒ³æœ‰åŠ¹ï¼‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º
      jaWrap.classList.add('hidden');
      jaBtn.disabled = false;
      jaBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
    }else{
      // å’Œè¨³ãŒãªã„å ´åˆï¼šæ ã¯éš ã—ãŸã¾ã¾ã€ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹
      jaWrap.classList.add('hidden');
      jaBtn.disabled = true;
      jaBtn.textContent = 'å’Œè¨³ãªã—';
    }
    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
    jaBtn.onclick = ()=>{
      if(jaBtn.disabled) return;
      const hidden = jaWrap.classList.toggle('hidden');
      jaBtn.textContent = hidden ? 'å’Œè¨³ã‚’è¡¨ç¤º' : 'å’Œè¨³ã‚’éš ã™';
    };
  }

  $('#dlg-detail').showModal();


  setPlayToggleLabel($('#d-toggle'),'idle');
  setRecButtonMode('idle');
  try{ $('#d-rec-audio').pause(); }catch(_){}
  $('#d-rec-audio').src=''; recEngine.dispose();

  let detailRate = settings.rate || 1.0;
  const rateBadge = $('#d-rate-badge');
  if(rateBadge){
    rateBadge.textContent = (Math.round(detailRate*10)/10).toFixed(1)+'Ã—';
  }

  async function playFrom(startCharIndex=0){
    const targetEl = $('#d-en');
    renderSpeakText(targetEl, row.english||''); targetEl.scrollTop=0;
    await speakEngine.play(
      {
        en: row.english||'',
        ja: row.japanese||'',
        order: settings.speakTarget||'en',
        repeat: settings.repeat,
        gapSec: settings.gapSec,
        startCharIndex
      },
      { targetEl }
    );
  }

  $('#d-toggle').onclick = async ()=>{
    const dEn = $('#d-en');

    // â˜… é€šå¸¸å†ç”Ÿã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetPronColors(dEn);

    oneTimeWarmup();
    await ensureTtsUnlocked(); await loadVoices();


    const btn = $('#d-toggle');
    if(speakEngine.state==='idle'){
      setPlayToggleLabel(btn,'playing');
      await playFrom(0);
      if(speakEngine.state!=='paused'){ setPlayToggleLabel(btn,'idle'); }
      const fresh = await getOne(currentDetailId);
      if(fresh){
        fresh.playCount=(fresh.playCount||0)+1; fresh.updatedAt=now(); await updateSentence(fresh);
        const m=[];
        const freshCats = (fresh.categories||[]).filter(c=>ALLOWED_CATEGORIES.includes(c));
        if(freshCats.length) m.push(...freshCats.map(c=>`<span class="flag">${escapeHTML(c)}</span>`));
        m.push(`<span class="flag">å†ç”Ÿ ${fresh.playCount}</span>`); $('#d-meta').innerHTML=m.join(' ');
      }
    }else if(speakEngine.state==='playing'){
      speakEngine.pause(); setPlayToggleLabel(btn,'paused');
    }else{
      speakEngine.resume(); setPlayToggleLabel(btn,'playing');
    }
  };

  $('#d-slower').onclick = async ()=>{
    detailRate = Math.max(0.5, Math.round((detailRate-0.1)*10)/10);
    settings.rate = detailRate;
    saveSettings();
    if(rateBadge){
      rateBadge.textContent = (Math.round(detailRate*10)/10).toFixed(1)+'Ã—';
    }
    if(speakEngine.state==='playing' || speakEngine.state==='paused'){
      const resumeAt = Math.max(0, speakEngine.getLastBoundary());
      await speakEngine.stop();
      setPlayToggleLabel($('#d-toggle'),'playing');
      await playFrom(resumeAt);
      if(speakEngine.state!=='paused'){ setPlayToggleLabel($('#d-toggle'),'idle'); }
    }
  };
  $('#d-faster').onclick = async ()=>{
    detailRate = Math.min(2.0, Math.round((detailRate+0.1)*10)/10);
    settings.rate = detailRate;
    saveSettings();
    if(rateBadge){
      rateBadge.textContent = (Math.round(detailRate*10)/10).toFixed(1)+'Ã—';
    }
    if(speakEngine.state==='playing' || speakEngine.state==='paused'){
      const resumeAt = Math.max(0, speakEngine.getLastBoundary());
      await speakEngine.stop();
      setPlayToggleLabel($('#d-toggle'),'playing');
      await playFrom(resumeAt);
      if(speakEngine.state!=='paused'){ setPlayToggleLabel($('#d-toggle'),'idle'); }
    }
  };

  const recBtn = $('#d-rec-main');
  const recPlayBtn = $('#d-rec-play');
  const recDeleteBtn = $('#d-rec-delete');
  let longPressTimer=null, longPressed=false;

  function bindRecHandlers(){
    recBtn.onpointerdown = ()=>{ longPressed=false; longPressTimer=setTimeout(()=>{ longPressed=true; handleRecLongPress(); }, 700); };
    recBtn.onpointerup = ()=>{ if(longPressTimer) clearTimeout(longPressTimer); if(!longPressed){ handleRecShortPress(); } };
    recBtn.onpointerleave = ()=>{ if(longPressTimer) clearTimeout(longPressTimer); };
    recBtn.oncontextmenu = (e)=>{ e.preventDefault(); };
  }

  async function handleRecShortPress(){
    const dEn = $('#d-en');

    if(recEngine.state==='idle'){
      try{
        // â˜… æ–°ã—ã„éŒ²éŸ³ã‚’å§‹ã‚ã‚‹å‰ã«ç™ºéŸ³è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
        resetPronColors(dEn);

        stopAllPlayback();
        speakEngine.stop?.();
        await recEngine.start();
        setRecButtonMode('recording');
      }catch(e){
        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
        setRecButtonMode('idle');
      }

    }else if(recEngine.state==='recording' || recEngine.state==='stopping'){
      const result = await recEngine.stop();
      if(!result || !result.blob || result.blob.size===0){
        alert('éŒ²éŸ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setRecButtonMode('idle');
      }else{
        $('#d-rec-audio').src = result.url;
        setRecButtonMode('ready');

        // â˜… KPIï¼šéŒ²éŸ³æ™‚é–“ï¼ˆmsï¼‰ã‚’è¨˜éŒ²
        if(result.durationMs){
          trackKpiRec(result.durationMs);
        }

        // â˜… éŒ²éŸ³çµ‚äº†æ™‚ã«ã€éŒ²éŸ³çµæœã‹ã‚‰ç™ºéŸ³è©•ä¾¡ â†’ å˜èªè‰²ã¸åæ˜ 
        if(result.blob){
          await evalPronFromBlob(dEn, result.blob);
        }
      }

    }else if(recEngine.state==='ready'){
      // å†ç”Ÿã¯å°‚ç”¨ãƒœã‚¿ãƒ³ã«ä»»ã›ã‚‹
    }else{
      setRecButtonMode('idle');
      recEngine.dispose();
    }
  }


  function handleRecLongPress(){
    if(recEngine.state==='ready' || recEngine.url){
      recEngine.dispose();
      $('#d-rec-audio').src='';
      setRecButtonMode('idle');
    }
  }

  bindRecHandlers();

  if(recPlayBtn){
    recPlayBtn.onclick = async ()=>{
      stopAllPlayback();
      try{
        const a=$('#d-rec-audio');
        if(!a.src){ alert('éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        a.currentTime=0;
        await a.play();
      }catch(_){ alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };
  }

  if(recDeleteBtn){
    recDeleteBtn.onclick = ()=>{
      handleRecLongPress();
    };
  }

  $('#d-edit').onclick = ()=>{
    speakEngine.stop(); stopAllPlayback();
    $('#dlg-detail').close();
    setActiveNav('nav-create'); show('create');
    getOne(id).then(row=>{
      if(!row) return;
      $('#scene').value=row.scene||''; $('#en').value=row.english||''; $('#ja').value=row.japanese||''; 
      Array.from($('#cats').options).forEach(o=>o.selected=(row.categories||[]).includes(o.value));
      $('#tags').value=(row.tags||[]).join(', '); $('#notes').value=row.notes||'';
      $('#btn-save').onclick = async ()=>{
        const scene=$('#scene').value.trim(); if(!scene){ alert('ã€Œå ´é¢ã€ã¯å¿…é ˆã§ã™'); return; }
        collectFormToItem(row); row.updatedAt=now(); await updateSentence(row);
        alert('æ›´æ–°ã—ã¾ã—ãŸ'); defaultSaveHandler(); clearForm(); setActiveNav('nav-list'); show('list'); refreshList(); fillCategoryFilter();
      };
    });
  };
  $('#d-del').onclick = async ()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ speakEngine.stop(); stopAllPlayback(); recEngine.dispose(); await deleteSentence(id); $('#dlg-detail').close(); refreshList(); fillCategoryFilter(); } };
  $('#d-close').onclick = ()=>{
    speakEngine.stop();
    stopAllPlayback();
    recEngine.dispose();
    resetPronColors($('#d-en'));   // â˜… ã“ã“ã§ãƒªã‚»ãƒƒãƒˆ
    $('#dlg-detail').close();
  };

}
$('#dlg-detail').addEventListener('close', ()=>{
  speakEngine.stop();
  stopAllPlayback();
  clearHighlight($('#d-en'));
  resetPronColors($('#d-en'));   // â˜… ç™ºéŸ³è‰²ã‚‚ãƒªã‚»ãƒƒãƒˆ

  try{
    const a=$('#d-rec-audio');
    if(a){ a.pause(); a.src=''; }
  }catch(_){}

  recEngine.dispose();
  setPlayToggleLabel($('#d-toggle'),'idle');
  setRecButtonMode('idle');
});

/* =========================
   Export/Importï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ï¼šå…¥ã‚Œæ›¿ãˆorè¿½åŠ ï¼‰
========================= */
$('#btn-export').onclick = async ()=>{
  const data = await getAll();
  const safe = data.map(({recBlob,recType,recDurationMs,recExpiresAt,recUpdatedAt, ...rest})=>rest);
  const blob = new Blob([JSON.stringify({sentences:safe},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `speaknote_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
};

$('#file-import').onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  try{
    const json = JSON.parse(text);
    if(!json.sentences || Array.isArray(json.sentences)===false) throw new Error('format');

    const replace = confirm(
      'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã§ã€æ—¢å­˜ã®ä¾‹æ–‡ã‚’ã™ã¹ã¦å…¥ã‚Œæ›¿ãˆã¾ã™ã‹ï¼Ÿ\n\n' +
      'OKï¼šæ—¢å­˜ã®ä¾‹æ–‡ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå…¥ã‚Œæ›¿ãˆï¼‰\n' +
      'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šæ—¢å­˜ã®ä¾‹æ–‡ã«è¿½åŠ ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ'
    );
    if(replace){
      await clearAllSentences();
    }

let addedCount = 0;
for(const r of json.sentences){
  const item = {
    id: uid(), english: r.english||'', japanese: r.japanese||'', scene: r.scene||'',
    categories: Array.isArray(r.categories)? r.categories:[], tags: Array.isArray(r.tags)? r.tags:[],
    notes: r.notes||'', favorite: !!r.favorite, playCount: Number(r.playCount||0),
    createdAt: now(), updatedAt: now()
  };
  await addSentence(item);
  addedCount++;
}
if(addedCount > 0){
  trackKpiAdd(addedCount); // â˜… ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸä»¶æ•°ã‚’ã¾ã¨ã‚ã¦åŠ ç®—
}
alert(replace ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå…¥ã‚Œæ›¿ãˆï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚' : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¿½åŠ ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');

    fillCategoryFilter(); refreshList();
  }catch(err){
    console.error(err);
    alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™');
  }finally{
    e.target.value='';
  }
};

/* =========================
   è¨­å®šUI
========================= */
async function openSettingsFields(){ await loadVoices(); renderVoiceList(); fillSettingsFields(); $('#lang').onchange = ()=>{ settings.ttsLang=$('#lang').value||settings.ttsLang; saveSettings(); loadVoices(); renderVoiceList(); }; }
function fillSettingsFields(){
  $('#lang').value = settings.ttsLang||''; $('#rate').value = settings.rate; $('#pitch').value = settings.pitch;
  $('#volume').value = settings.volume; $('#gap').value = settings.gapSec; $('#repeat').value = settings.repeat; $('#speak-target').value = settings.speakTarget;
  $('#keep-awake').checked = !!settings.keepAwake;
}
$('#reset-standard').onclick = (ev)=>{ ev.preventDefault(); settings = { ...defaultSettings, voiceName: '' }; saveSettings(); loadVoices(); fillSettingsFields(); alert('æ¨™æº–è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸï¼ˆéŸ³å£°ã¯OSæ¨å¥¨ã«è‡ªå‹•è¨­å®šï¼‰ã€‚'); };
$('#save-settings').onclick = (ev)=>{
  ev.preventDefault();
  settings.ttsLang=$('#lang').value; settings.voiceName=$('#voice').value || settings.voiceName || '';
  settings.rate=Number($('#rate').value)||1.0; settings.pitch=Number($('#pitch').value)||1.0; settings.volume=Number($('#volume').value)||1.0;
  settings.gapSec=Number($('#gap').value)||0; settings.repeat=Math.max(1, parseInt($('#repeat').value||'1',10)); settings.speakTarget=$('#speak-target').value||'en';
  settings.keepAwake = !!$('#keep-awake').checked;
  const chosen=voices.find(v=>v.name===settings.voiceName); if(chosen&&chosen.lang&&chosen.lang!==settings.ttsLang){ settings.ttsLang=chosen.lang; }
  saveSettings(); renderVoiceList(); $('#dlg-settings').close(); alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
};
$('#reset-all-sentences').onclick = async (ev)=>{
  ev.preventDefault();
  if(!confirm('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¾‹æ–‡ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€»ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  try{
    await clearAllSentences();
    alert('ã™ã¹ã¦ã®ä¾‹æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    refreshList(); fillCategoryFilter();
  }catch(e){
    console.error(e);
    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
};

/* =========================
   ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°æŒ‡å®šï¼‹å°‚ç”¨ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ï¼‰
========================= */
const sh = {
  list: [], index: 0, rate: 1.0, container: null,
  opened:false, auto:false,
  _lastAbs:0, _boundHook:false, _endedHook:false,
  all:[]
};

async function prepareShadow(){
  const rows = await getAll();
  const pool = rows.filter(r=> (r.english||'').trim().length>0 );
  if(pool.length===0){
    alert('è‹±èªä¾‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
    setActiveNav('nav-create'); show('create');
    return;
  }
  sh.all = pool.slice();
  sh.list = [];
  sh.index = 0;
  sh.rate = settings.rate || 1.0;
  sh.container = $('#sh-text');
  const badge = $('#rate-badge');
  if(badge){
    badge.textContent = (Math.round(sh.rate*10)/10).toFixed(1)+'Ã—';
  }

  const catSel = $('#sh-cat');
  const tagInput = $('#sh-tag');
  if(catSel) catSel.value='';
  if(tagInput) tagInput.value='';
  const summary = $('#sh-summary');
  if(summary){
    summary.textContent = `ç¾åœ¨ï¼š${pool.length}ä»¶ã®è‹±æ–‡ãŒå¯¾è±¡ï¼ˆçµã‚Šè¾¼ã¿ãªã—ï¼‰`;
  }

  sh.opened = false;
  sh.auto = false;
  setPlayToggleLabel($('#sh-toggle'),'idle');

  if(!sh._boundHook){
    speakEngine.on('boundary', (abs)=>{ sh._lastAbs = abs||0; });
    sh._boundHook = true;
  }
  if(!sh._endedHook){
    speakEngine.on('ended', ()=>{
      if(!sh.opened || !sh.auto) return;
      sh.index = (sh.index + 1) % sh.list.length;
      setTimeout(()=>{
        if(!sh.opened || !sh.auto) return;
        setPlayToggleLabel($('#sh-toggle'),'playing');
        playCurrentShadow();
      }, 1000);
    });
    sh._endedHook = true;
  }
}

async function playCurrentShadow({ startCharIndex=0 } = {}){
  const row = sh.list[sh.index];
  const text=(row.english||'').trim();
  $('#sh-scene').innerHTML = 'ğŸ”Š <strong>' + escapeHTML(row.scene || '(æœªè¨­å®š)') + '</strong>';

  // è‹±æ–‡ï¼šã“ã‚Œã¾ã§é€šã‚Š
  renderSpeakText(sh.container, text);
  sh.container.scrollTop=0;

  // å’Œè¨³ï¼šæŠ˜ã‚ŠãŸãŸã¿ï¼‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ ã«ã‚»ãƒƒãƒˆ
  const jaWrap = $('#sh-text-ja-wrap');
  const jaBody = $('#sh-text-ja');
  const jaBtn  = $('#sh-toggle-ja');
  const jaText = (row.japanese || '').trim();

  if(jaBody){
    jaBody.textContent = jaText;
  }
  if(jaWrap && jaBtn){
    if(jaText){
      // å’Œè¨³ã‚ã‚Šï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŠ˜ã‚ŠãŸãŸã¿ï¼ãƒœã‚¿ãƒ³æœ‰åŠ¹
      jaWrap.classList.add('hidden');
      jaBtn.disabled = false;
      jaBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
    }else{
      // å’Œè¨³ãªã—ï¼šæ éè¡¨ç¤ºã®ã¾ã¾ï¼ãƒœã‚¿ãƒ³ç„¡åŠ¹
      jaWrap.classList.add('hidden');
      jaBtn.disabled = true;
      jaBtn.textContent = 'å’Œè¨³ãªã—';
    }
  }

  if (settings.keepAwake) {
    try{ await KeepAwake.enable(); }catch(e){}
  }
  await speakEngine.play(
    { en: row.english||'', ja: row.japanese||'', order: settings.speakTarget||'en', repeat: settings.repeat, gapSec: settings.gapSec, startCharIndex },
    { targetEl: sh.container, rate: sh.rate }
  );
}


/* ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°é©ç”¨ï¼‰ */
$('#sh-start').onclick = async ()=>{
  oneTimeWarmup();
  // â˜… iOSã§ã¯ã“ã“ã§åŒæœŸçš„ã«ä¸€åº¦ã ã‘ã€Œç„¡éŸ³ç™ºè©±ã€ã‚’æ‰“ã¤
  forceIOSShadowClickWarmup();

  await ensureTtsUnlocked();
  await loadVoices();

  const all = await getAll();
  let pool = all.filter(r=> (r.english||'').trim().length>0 );
  const catSel = $('#sh-cat');
  const tagInput = $('#sh-tag');
  const cat = catSel ? catSel.value : '';
  const tagkw = tagInput ? tagInput.value.trim().toLowerCase() : '';

  if(cat){
    pool = pool.filter(r => (r.categories||[]).includes(cat));
  }
  if(tagkw){
    pool = pool.filter(r => (r.tags||[]).some(t => (t||'').toLowerCase().includes(tagkw)));
  }
  if(pool.length===0){
    alert('æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }

  sh.list = pool.sort(()=>Math.random()-0.5);
  sh.index = 0;
  sh.rate = settings.rate || 1.0;
  sh.container = $('#sh-text');
  const badge = $('#rate-badge');
  if(badge){
    badge.textContent = (Math.round(sh.rate*10)/10).toFixed(1)+'Ã—';
  }
  const summary = $('#sh-summary');
  if(summary){
    const parts=[];
    parts.push(`å¯¾è±¡ï¼š${pool.length}ä»¶`);
    parts.push(cat ? `ã‚«ãƒ†ã‚´ãƒª=${cat}` : 'ã‚«ãƒ†ã‚´ãƒª=ã™ã¹ã¦');
    parts.push(tagkw ? `ã‚¿ã‚°ã«ã€Œ${tagkw}ã€ã‚’å«ã‚€` : 'ã‚¿ã‚°=ã™ã¹ã¦');
    summary.textContent = parts.join(' ï¼ ');
  }

  sh.opened = true;

  const dlg = $('#dlg-shadow');
  if (dlg && !dlg.open) {
    dlg.showModal();
  }

  if (isIOS) {
    // â˜… iOS ã§ã¯æœ€åˆã®è‡ªå‹•å†ç”Ÿã‚’ã‚„ã‚ã¦ã€
    //    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œâ–¶ï¸ å†ç”Ÿã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«åˆå›å†ç”Ÿã™ã‚‹
    sh.auto = true; // é€£ç¶šå†ç”Ÿãƒ•ãƒ©ã‚°ã¯ONã®ã¾ã¾
    setPlayToggleLabel($('#sh-toggle'), 'idle'); // â–¶ï¸ å†ç”Ÿ è¡¨ç¤ºã«ã—ã¦ãŠã
  } else {
    // â˜… PC / Android ã¯å¾“æ¥é€šã‚Šã€Œé–‹å§‹ãƒœã‚¿ãƒ³ã¨åŒæ™‚ã«è‡ªå‹•å†ç”Ÿã€
    sh.auto = true;
    setPlayToggleLabel($('#sh-toggle'),'playing');
    await playCurrentShadow();
  }
};

/* å°‚ç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã®ãƒœã‚¿ãƒ³ */
$('#sh-toggle').onclick = async ()=>{
  const btn = $('#sh-toggle');
  oneTimeWarmup();
  // â˜… ã“ã“ã§ã‚‚ã€ã¾ã ãªã‚‰ä¸€åº¦ã ã‘ç„¡éŸ³ç™ºè©±ã§è§£éŒ 
  forceIOSShadowClickWarmup();

  await ensureTtsUnlocked();
  await loadVoices();

  if(speakEngine.state==='idle'){
    sh.auto = true;
    setPlayToggleLabel(btn,'playing');
    await playCurrentShadow();
  }else if(speakEngine.state==='playing'){
    sh.auto = false;
    speakEngine.pause(); setPlayToggleLabel(btn,'paused');
  }else{
    sh.auto = true;
    speakEngine.resume(); setPlayToggleLabel(btn,'playing');
  }
};
$('#sh-slower').onclick = ()=>{
  sh.rate = Math.max(0.5, Math.round((sh.rate-0.1)*10)/10);
  $('#rate-badge').textContent=(Math.round(sh.rate*10)/10).toFixed(1)+'Ã—';
  if(speakEngine.state==='playing' || speakEngine.state==='paused'){
    const resumeAt = Math.max(0, speakEngine.getLastBoundary());
    speakEngine.stop();
    sh.auto = true;
    setPlayToggleLabel($('#sh-toggle'),'playing');
    playCurrentShadow({ startCharIndex: resumeAt });
  }
};
// ã€Œå‰ã¸ã€ãƒœã‚¿ãƒ³
$('#sh-prev').onclick = async ()=>{
  if(!sh.list || sh.list.length === 0) return;

  // è‡ªå‹•é€²è¡Œã¯ã‚ªãƒ³ã«ã—ã¦ãŠãï¼ˆå‰ã®æ–‡ã‹ã‚‰ã‚‚é€£ç¶šå†ç”Ÿï¼‰
  sh.auto = true;

  // ä»Šã®å†ç”Ÿã‚’æ­¢ã‚ã¦ã‹ã‚‰ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’1ã¤æˆ»ã™
  await speakEngine.stop();
  sh.index = (sh.index - 1 + sh.list.length) % sh.list.length;

  // å…ˆé ­ã‹ã‚‰å†ç”Ÿ
  setPlayToggleLabel($('#sh-toggle'),'playing');
  await playCurrentShadow({ startCharIndex: 0 });
};

// ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³
$('#sh-next').onclick = async ()=>{
  if(!sh.list || sh.list.length === 0) return;

  sh.auto = true;

  // ä»Šã®å†ç”Ÿã‚’æ­¢ã‚ã¦ã‹ã‚‰ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’1ã¤é€²ã‚ã‚‹
  await speakEngine.stop();
  sh.index = (sh.index + 1) % sh.list.length;

  // å…ˆé ­ã‹ã‚‰å†ç”Ÿ
  setPlayToggleLabel($('#sh-toggle'),'playing');
  await playCurrentShadow({ startCharIndex: 0 });
};

// å’Œè¨³è¡¨ç¤ºã®é–‹é–‰ãƒœã‚¿ãƒ³
$('#sh-toggle-ja').onclick = ()=> {
  const wrap = $('#sh-text-ja-wrap');
  const btn  = $('#sh-toggle-ja');
  if(!wrap || !btn || btn.disabled) return;
  const hidden = wrap.classList.toggle('hidden');
  btn.textContent = hidden ? 'å’Œè¨³ã‚’è¡¨ç¤º' : 'å’Œè¨³ã‚’éš ã™';
};


$('#sh-faster').onclick = ()=>{
  sh.rate = Math.min(2.0, Math.round((sh.rate+0.1)*10)/10);
  $('#rate-badge').textContent=(Math.round(sh.rate*10)/10).toFixed(1)+'Ã—';
  if(speakEngine.state==='playing' || speakEngine.state==='paused'){
    const resumeAt = Math.max(0, speakEngine.getLastBoundary());
    speakEngine.stop();
    sh.auto = true;
    setPlayToggleLabel($('#sh-toggle'),'playing');
    playCurrentShadow({ startCharIndex: resumeAt });
  }
};

function exitShadowDialog(){
  sh.opened=false;
  sh.auto=false;
  speakEngine.stop(); stopAllPlayback(); KeepAwake.disable();
  clearHighlight($('#sh-text'));
  setPlayToggleLabel($('#sh-toggle'),'idle');
  const dlg = $('#dlg-shadow');
  if(dlg && dlg.open){ dlg.close(); }
}
$('#sh-exit').onclick = ()=> exitShadowDialog();
$('#dlg-shadow').addEventListener('close', ()=> exitShadowDialog());

/* =========================
   ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ—¥æœ¬èªãŸã£ã·ã‚Šï¼‰
========================= */
function sanitizeWord(s){ return (s||'').replace(/^[^\w'-]+|[^\w'-]+$/g,'').replace(/â€™/g,"'"); }
function setLookupLinks(word){
  const q = encodeURIComponent(word);
  $('#lk-google').href   = `https://www.google.com/search?q=${q}+æ„å‘³`;
  $('#lk-cambridge').href= `https://dictionary.cambridge.org/dictionary/english/${q}`;
  $('#lk-longman').href  = `https://www.ldoceonline.com/dictionary/${q}`;
}
async function translateJa(text){
  if(!text) return '';
  try{
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ja`;
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('bad');
    const json = await res.json();
    return (json?.responseData?.translatedText || '').replace(/\s+/g,' ').trim();
  }catch(e){ return ''; }
}
async function translateBulkToJa(lines){
  const chunks=[]; const size=5;
  for(let i=0;i<lines.length;i+=size){ chunks.push(lines.slice(i,i+size)); }
  const out=[];
  for(const ch of chunks){
    for(const s of ch){ out.push(await translateJa(s)); }
  }
  return out;
}
async function fetchEnDict(word){
  try{
    const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('bad');
    const json = await res.json();
    const head = Array.isArray(json) ? json[0] : null;
    const phon = head?.phonetic || '';
    const meanings = head?.meanings || [];
    const defs=[];
    for(const m of meanings){
      const pos = m.partOfSpeech||'';
      for(const d of (m.definitions||[])){
        if(d?.definition){ defs.push({ pos, def: d.definition, ex: d.example || '' }); }
      }
    }
    return { phonetic: phon, defs };
  }catch(e){ return { phonetic:'', defs:[] }; }
}
async function fetchJaWiktionarySnippet(word){
  try{
    const api = `https://ja.wiktionary.org/w/api.php?action=query&prop=extracts&exintro=1&explaintext=1&format=json&origin=*&titles=${encodeURIComponent(word)}`;
    const res = await fetch(api, {mode:'cors'});
    if(!res.ok) throw new Error('bad');
    const json = await res.json();
    const pages = json?.query?.pages||{};
    const first = Object.values(pages)[0];
    const ex = (first?.extract||'').trim();
    if(!ex) return '';
    return ex.length>360 ? ex.slice(0,340)+'â€¦' : ex;
  }catch(e){ return ''; }
}
function renderLookupContentRich({word, jaSummary, enDefs, jaDefs, jaExamples, phonetic, jaWiki}){
  const body = $('#lk-body');
  const safeWord = escapeHTML(word);
  const hasDefs = enDefs.length>0;
  const head = `
    <div style="font-size:16px;margin-bottom:6px">
      <strong style="font-size:18px">${safeWord}</strong>
      ${phonetic ? `<span class="tiny" style="margin-left:8px">/${escapeHTML(phonetic)}/</span>` : ''}
    </div>`;
  const summary = `
    <div style="font-size:15px;line-height:1.9;margin:6px 0">
      <strong>æ—¥æœ¬èªã¾ã¨ã‚ï¼š</strong>
      ${jaSummary ? escapeHTML(jaSummary) : 'ï¼ˆæ—¥æœ¬èªã‚µãƒãƒªãƒ¼ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰'}
      ${jaWiki ? `<div class="tiny" style="opacity:.9;margin-top:6px"><strong>Wiktionaryè£œè¶³ï¼š</strong>${escapeHTML(jaWiki)}</div>` : ''}
    </div>`;
  const defsJa = hasDefs
    ? `<div style="margin-top:8px">
         <div class="tiny" style="margin-bottom:4px"><strong>ä¸»ãªå®šç¾©ï¼ˆæ—¥æœ¬èªï¼‰</strong></div>
         <ol style="margin:0 0 6px 20px; line-height:1.85">
           ${jaDefs.map(d=>`<li>${escapeHTML(d||'(è¨³ãªã—)')}</li>`).join('')}
         </ol>
       </div>` : `<div class="tiny" style="margin-top:6px">å®šç¾©ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>`;
  const exJa = jaExamples.length
    ? `<div style="margin-top:10px">
         <div class="tiny" style="margin-bottom:4px"><strong>ä¾‹æ–‡ï¼ˆæ—¥æœ¬èªè¨³ä»˜ãï¼‰</strong></div>
         <ul style="margin:0 0 6px 18px; line-height:1.85">
           ${jaExamples.map(item=>`<li>${escapeHTML(item.ja)} <span class="tiny" style="opacity:.8">ï¼ˆåŸæ–‡ï¼š${escapeHTML(item.en)}ï¼‰</span></li>`).join('')}
         </ul>
       </div>` : '';
  const defsEn = hasDefs
    ? `<details style="margin-top:8px">
         <summary class="tiny">è‹±è‹±ã®åŸæ–‡ã‚’è¡¨ç¤º</summary>
         <ol style="margin:6px 0 6px 20px; line-height:1.8">
           ${enDefs.map(d=>`<li>${escapeHTML(d.pos ? `[${d.pos}] ` : '')}${escapeHTML(d.def)}</li>`).join('')}
         </ol>
       </details>` : '';
  body.innerHTML = head + summary + defsJa + exJa + defsEn;
}
async function openLookup(word){
  if(!word) return;
  setLookupLinks(word);
  $('#lk-body').innerHTML = 'å˜èªã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  $('#dlg-lookup').showModal();
  try{
    const dict = await fetchEnDict(word);
    const jaSummary = await translateJa(word + ': ' + (dict.defs[0]?.def || ''));
    const topDefs = dict.defs.slice(0, 12);
    const enDefLines = topDefs.map(d => (d.pos?`[${d.pos}] `:'') + d.def);
    const jaDefs = await translateBulkToJa(enDefLines);
    const exPairs = []; for(const d of topDefs){ if(d.ex) exPairs.push(d.ex); if(exPairs.length>=5) break; }
    const jaExList = await translateBulkToJa(exPairs);
    const jaExamples = exPairs.map((en, i)=>({ en, ja: jaExList[i]||'' }));
    const jaWiki = await fetchJaWiktionarySnippet(word);
    renderLookupContentRich({ word, jaSummary, enDefs: topDefs, jaDefs, jaExamples, phonetic: dict.phonetic, jaWiki });
  }catch(e){
    const ja = await translateJa(word);
    $('#lk-body').innerHTML =
      `<div style="font-size:16px;margin-bottom:6px"><strong>${escapeHTML(word)}</strong></div>
       <div class="tiny" style="margin-top:6px">è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
       <div style="margin-top:8px"><strong>æ—¥æœ¬èªï¼š</strong>${escapeHTML(ja||'')}</div>`;
  }
}
$('#lk-close').onclick = ()=> $('#dlg-lookup').close();
document.addEventListener('click', (e)=>{
  const wEl = e.target.closest('.speak-text .w');
  if(!wEl) return;
  const word = sanitizeWord(wEl.textContent);
  if(!word) return;
  openLookup(word.toLowerCase());
});

/* =========================
   ã€Œè‡ªå‹•å’Œè¨³ã€ãƒœã‚¿ãƒ³ï¼ˆç™»éŒ²ç”»é¢ï¼‰
========================= */
const autoBtn = $('#btn-auto-ja');
if(autoBtn){
  autoBtn.addEventListener('click', async (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    const enText = $('#en').value.trim();
    if(!enText){
      alert('å…ˆã«ã€Œè‹±èªä¾‹æ–‡ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    const jaField = $('#ja');
    if(jaField.value.trim()){
      const ok = confirm('ã™ã§ã«å’Œè¨³ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚è‡ªå‹•å’Œè¨³ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ');
      if(!ok) return;
    }
    const oldLabel = autoBtn.textContent;
    try{
      autoBtn.disabled = true;
      autoBtn.textContent = 'ç¿»è¨³ä¸­â€¦';
      const ja = await translateJa(enText);
      if(!ja){
        alert('è‡ªå‹•å’Œè¨³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      }else{
        jaField.value = ja;
      }
    }catch(e){
      console.error(e);
      alert('è‡ªå‹•å’Œè¨³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }finally{
      autoBtn.disabled = false;
      autoBtn.textContent = oldLabel;
    }
  });
}

initHomeKpiEvents();
updateHomeKpi();



/* =========================
   ãƒ–ãƒ¼ãƒˆ
========================= */
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') loadVoices(); });
window.addEventListener('pageshow', ()=> loadVoices());
</script>
</body>
</html>
