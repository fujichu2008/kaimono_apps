<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>買い物リスト（一体型）</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f0f6ff; --card:#ffffff; --line:#d6e4ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --pill:#eaf2ff; --ok:#18a558; --warn:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system,"Segoe UI",Roboto,Arial}

/* Header & Tabs */
header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 0%,#f6f9ff 100%);
  border-bottom:1px solid var(--line);padding:8px 16px;z-index:10}
.brand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.brand h1{font-size:20px;margin:0;color:#0b2256}

/* tabs */
.tabbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{position:relative;border:1px solid var(--line);background:#fff;color:#0f172a;
  padding:8px 12px;border-radius:10px 10px 0 0;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tabrow{display:flex;align-items:center;gap:8px;margin-top:-1px;border-bottom:1px solid var(--line);}

/* controls row (list-only) */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 0}
.controls.hidden{display:none}
.controls .spacer{flex:1}

select,input,button,textarea{font:inherit}
button{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.ghost{background:#fff;color:var(--accent)}
button.line{background:#fff;border-color:var(--line);color:#0f172a}
button.warn{background:var(--warn);border-color:var(--warn)}
button.ok{background:var(--ok);border-color:var(--ok)}
button.flat{border:none;background:transparent;color:var(--accent);padding:4px 8px}

/* pages */
.page{display:none;padding:16px}
.page.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{background:var(--pill);color:var(--accent-2);padding:4px 8px;border-radius:999px;font-size:12px}
input[type=text], input[type=search], select, textarea{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:0
}
ul{list-style:none;margin:0;padding:0}

/* list items */
.item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);
  border-radius:12px;padding:10px 12px;margin-bottom:8px;touch-action:pan-y}
.item .name{flex:1;min-width:0}
.item .qty{font-size:18px; font-weight:600; color:#111827}
.item.skip{background:repeating-linear-gradient(135deg,#f3f7ff 0 6px,#e6eeff 6px 12px);text-decoration:line-through}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#eef3ff;border:1px solid #dbe6ff;border-radius:6px;padding:2px 6px;font-size:12px}

/* 分類プルダウン（小さめ） */
.item .cat-edit{
  font-size:12px;
  padding:2px 6px;
  margin-top:2px;
  border-radius:8px;
  height:26px; /* iOSのタップ狙い最小高 */
  line-height:1.2;
}

/* album */
.album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.photo-card{position:relative;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.photo-card img{width:100%;aspect-ratio:4/3;object-fit:cover;display:block;background:#eef3ff}
.photo-meta{padding:8px 10px;border-top:1px solid var(--line);display:grid;gap:4px}
.small{font-size:12px;color:var(--muted)}
.tag{display:inline-block;background:var(--pill);color:var(--accent-2);border-radius:999px;padding:2px 8px;font-size:12px}
.photo-del{ position:absolute; top:8px; right:8px; background:#fff; color:var(--warn); border:1px solid var(--warn);
  border-radius:999px; padding:4px 8px; font-size:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.08); }

/* modal (above header) */
.modal{position:fixed;inset:0;background:rgba(11,16,40,.5);display:none;align-items:center;justify-content:center;padding:16px; z-index:1001;}
.modal.open{display:flex}
.sheet{background:#fff;border-radius:16px;border:1px solid var(--line);max-width:720px;width:100%;max-height:90vh;overflow:auto}
.sheet .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.sheet .body{padding:12px 14px}
.sheet .foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

@media (max-width:480px){
  .grid.cols-2{grid-template-columns:1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>買い物リスト</h1>
  </div>

  <!-- タブ -->
  <div class="tabbar tabrow">
    <button class="tab active" data-tab="list">買い物リスト</button>
    <button class="tab" data-tab="market">スーパー登録</button>
    <button class="tab" data-tab="album">アルバム</button>
  </div>

  <!-- 買い物リスト用の上部コントロール（リストタブ時のみ表示） -->
  <div class="controls" id="controlsRow">
    <select id="superSelect"></select>
    <button class="line" id="btnSort">売場順</button>
    <button class="line" id="btnUnsort">解除</button>
    <span class="spacer"></span>
    <button id="btnExport" class="ghost">QRで共有</button>
    <button id="btnImport" class="ghost">QR取り込み</button>
  </div>
</header>

<main>
  <!-- 買い物リスト -->
  <section id="page-list" class="page active">
    <div class="card">
      <div class="grid cols-3">
        <input id="inpName" type="text" placeholder="品名（例：牛乳）">
        <select id="selQty">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
        <button id="btnAdd">追加</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="search" type="search" placeholder="検索…（未購入のみは右のチェック）" style="flex:1">
        <label class="small"><input type="checkbox" id="onlyActive"> 未購入のみ</label>
        <button class="line" id="btnClearActive">未購入クリア</button>
        <button class="warn" id="btnClearAll">全クリア</button>
      </div>
      <ul id="list" style="margin-top:10px"></ul>
    </div>
  </section>

  <!-- スーパー登録 -->
  <section id="page-market" class="page">
    <div class="card">
      <h3 style="margin:0 0 8px">スーパー登録</h3>
      <div class="row">
        <input id="superName" type="text" placeholder="スーパー名" style="flex:1">
        <button id="btnAddSuper">追加</button>
      </div>
      <div class="row small" style="margin-top:6px;color:var(--muted)">
        左の一覧から選択 → 右で売場順（入口→奥）を構成。上下ボタンで並び替え、削除で除外。<br>
        ※右のリストに追加済みの分類はプルダウンに出ません（削除すると復活します）
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>スーパー一覧</strong>
            <button class="flat" id="btnDeleteSuper">選択削除</button>
          </div>
          <select id="superList" size="8" style="width:100%"></select>
        </div>
        <div class="card">
          <strong>売場順（入口→奥）</strong>
          <div class="row" style="margin:6px 0">
            <select id="catPick" style="flex:1"></select>
            <button id="btnShelfAdd">追加</button>
            <span class="small" style="margin-left:auto">※重複不可（追加済みは選択肢に出ません）</span>
          </div>
          <ul id="shelfOrder"></ul>
          <div class="row" style="justify-content:flex-end">
            <button class="ok" id="btnSaveShelf">保存</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- アルバム -->
  <section id="page-album" class="page">
    <div class="card">
      <div class="grid cols-3">
        <select id="albumCat">
          <option value="">分類で絞り込み</option>
        </select>
        <input id="albumText" type="search" placeholder="品名メモで絞り込み">
        <div class="row" style="justify-content:flex-end">
          <input id="albumSuperOnly" type="checkbox"><label for="albumSuperOnly" class="small">選択スーパーのみ</label>
        </div>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end;gap:8px">
        <button class="warn" id="btnAlbumDeleteAll">アルバム一括削除</button>
      </div>
      <div class="album-grid" id="albumGrid" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<!-- Export Modal -->
<div id="modalExport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRコードで共有</strong>
      <button class="flat" onclick="closeExport()">閉じる</button>
    </div>
    <div class="body">
      <div class="row small"><span class="pill">現在のリストを共有</span> 相手はカメラで読み取るか「QR取り込み」で画像から読めます。</div>
      <div class="card" style="margin-top:8px;display:flex;justify-content:center"><div id="qrcode"></div></div>
      <div id="qrError" class="small" style="color:#b91c1c;margin-top:6px;display:none"></div>
      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="compact"> 圧縮共有（品名・数量・分類のみ）</label>
        <span class="small" style="margin-left:auto;color:var(--muted)">長大リストは圧縮推奨</span>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="downloadQR()">画像保存</button>
      <button class="ok" onclick="closeExport()">OK</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="modalImport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QR取り込み</strong>
      <button class="flat" onclick="closeImport()">閉じる</button>
    </div>
    <div class="body">
      <!-- ★ 上部に並べた2ボタン -->
      <div class="row" style="gap:8px; margin-bottom:8px;">
        <button class="line" id="btnLiveScanTop">カメラでスキャン</button>
        <button class="line" id="btnPick">ファイルを選択</button>
        <!-- hidden file input: アルバムから選べるように capture属性は付けない -->
        <input id="qrPick" type="file" accept="image/*" style="display:none">
      </div>

      <div class="small" style="margin-top:0;color:var(--muted)">※「ファイルを選択」でスマホ内の画像アルバムから選べます。</div>
      <div class="card" style="margin-top:8px">
        <strong>読み取った品目</strong>
        <ul id="qrListPreview" style="margin-top:6px"></ul>
      </div>
    </div>
    <!-- ★ 左寄せのフッターボタン＆文言変更 -->
    <div class="foot" style="justify-content:flex-start">
      <button class="line" onclick="applyImport('merge')">現在のリストに追加</button>
      <button class="ok" onclick="applyImport('replace')">リストをこれに入れ替え</button>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="modalPhoto" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>写真</strong>
      <button class="flat" onclick="closePhoto()">閉じる</button>
    </div>
    <div class="body">
      <img id="photoLarge" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <div class="small">分類</div>
          <div id="photoCat" class="pill"></div>
        </div>
        <div>
          <div class="small">スーパー</div>
          <div id="photoSuper" class="pill"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="photoNote" rows="3" style="flex:1" placeholder="メモ（価格・規格など）"></textarea>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="deletePhoto()">削除</button>
      <button class="ok" onclick="savePhotoNote()">更新</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/* ========= 定数・分類 ========= */
const CATEGORY_NAMES = [
 '野菜・果物','精肉','鮮魚・刺身','惣菜・弁当','パン','乳製品','冷凍食品',
 '豆腐・納豆・漬物','乾物','調味料・油・だし','菓子・スナック','飲料','酒類',
 '缶詰・レトルト・インスタント麺','日用品・雑貨','卵','米','生麺','その他'
];
const CAT_RULES = [
  {cat:'野菜・果物',keys:[
    'トマト','レタス','きゅうり','にんじん','人参','玉ねぎ','玉葱','じゃが','じゃがいも','馬鈴薯',
    '白菜','ほうれん草','ほうれんそう','小松菜','水菜','バナナ','りんご','林檎','みかん','いちご','ぶどう','葡萄',
    'キャベツ','きゃべつ','ネギ','ねぎ','長ねぎ','長ネギ','大根','かぶ','蕪','ブロッコリー','カリフラワー',
    'ピーマン','パプリカ','なす','茄子','しいたけ','椎茸','しめじ','えのき','榎','まいたけ','舞茸','エリンギ',
    'きのこ','もやし','さつまいも','さといも','里芋','長芋','山芋','れんこん','蓮根','ごぼう','牛蒡',
    'きぬさや','スナップえんどう','枝豆','オクラ','トウモロコシ','とうもろこし','コーン','キュウリ'
  ]},
  {cat:'精肉',keys:[
    '牛肉','豚肉','鶏肉','挽き肉','ひき肉','合い挽き','合挽き','ミンチ',
    'ささみ','ササミ','むね','ムネ','もも','モモ','バラ','ベーコン','ハム','ソーセージ',
    'ラム','マトン','レバー','砂肝','胸肉','モモ肉','肩ロース','ロース','ヒレ','サーロイン'
  ]},
  {cat:'鮮魚・刺身',keys:[
    '刺身','鮭','サーモン','サバ','鯖','アジ','鯵','イワシ','鰯','タコ','蛸','イカ','烏賊','エビ','海老',
    'しらす','ホッケ','鰤','ブリ','マグロ','鮪','カツオ','鰹','タイ','鯛','切り身','切身','開き'
  ]},
  {cat:'惣菜・弁当',keys:[
    '弁当','総菜','惣菜','唐揚げ','からあげ','コロッケ','天ぷら','サラダ','寿司','おにぎり','サンドイッチ',
    'オードブル','煮物','炒め物','惣菜パン','グラタン','ドリア'
  ]},
  {cat:'パン',keys:['パン','食パン','バゲット','ロール','クロワッサン','フランスパン','ベーグル','バターロール']},
  {cat:'乳製品',keys:['牛乳','ミルク','ヨーグルト','チーズ','バター','生クリーム','クリームチーズ','カッテージ','モッツァレラ','スキムミルク']},
  {cat:'冷凍食品',keys:['冷凍','冷食','冷凍餃子','餃子(冷凍)','チャーハン(冷凍)','ピザ(冷凍)','冷凍うどん','冷凍パスタ','冷凍野菜','アイス']},
  {cat:'豆腐・納豆・漬物',keys:['豆腐','絹','木綿','納豆','厚揚げ','油揚げ','高野豆腐','漬物','キムチ','糠漬け','ぬか漬け','浅漬け','ピクルス']},
  {cat:'乾物',keys:['海苔','のり','鰹節','かつおぶし','煮干し','干し','春雨','切り干し','干し椎茸','高野豆腐','乾燥わかめ','乾燥']},
  {cat:'調味料・油・だし',keys:[
    '塩','砂糖','味噌','みそ','醤油','しょうゆ','酢','みりん','料理酒','酒','胡椒','コショウ','こしょう',
    'だし','白だし','顆粒だし','コンソメ','ブイヨン','ごま油','サラダ油','オリーブオイル','菜種油',
    'ソース','ケチャップ','マヨネーズ','マスタード','ラー油','豆板醤','甜麺醤','味覇','創味シャンタン','スパイス','ハーブ'
  ]},
  {cat:'菓子・スナック',keys:['お菓子','菓子','スナック','ポテチ','ポテトチップス','クッキー','チョコ','チョコレート','キャンディ','ガム','グミ','せんべい','ビスケット','ラスク']},
  {cat:'飲料',keys:['水','ミネラルウォーター','お茶','緑茶','麦茶','紅茶','コーヒー','ジュース','炭酸','スポーツドリンク','牛乳飲料','ココア']},
  {cat:'酒類',keys:['ビール','発泡酒','チューハイ','酎ハイ','ワイン','日本酒','焼酎','ウイスキー','ハイボール','梅酒','リキュール']},

  {cat:'缶詰・レトルト・インスタント麺',keys:[
    '缶詰','ツナ','コーン缶','トマト缶','レトルト','レトルトカレー','レトルトパスタ',
    'インスタント','カップ麺','袋麺','即席麺','即席',
    'チキンラーメン','うまかっちゃん','サッポロ一番','サッポロいちばん','サッポロ1番',
    '塩らーめん','みそラーメン','醤油ラーメン',
    'カップヌードル','カップヌードルシーフード','シーフードヌードル','カップヌードルカレー','チリトマトヌードル','欧風チーズカレー',
    '日清麺職人','麺職人','日清ラ王','ラ王','ラ王豚骨','ラ王味噌','ラ王醤油','ラ王塩',
    '日清焼そばUFO','UFO','U.F.O','日清焼そば','日清焼きそば',
    'ペヤング','ペヤングソースやきそば','獄激辛','超大盛',
    '一平ちゃん','一平ちゃん夜店の焼そば','マヨビーム',
    '明星チャルメラ','チャルメラ','明星一平ちゃん','明星中華三昧',
    '出前一丁','ごまラー油',
    'マルちゃん正麺','正麺','マルちゃん昔ながらの中華そば','マルちゃん赤いきつね','赤いきつね','緑のたぬき','ごつ盛り','バリうま',
    'やきそば弁当','焼そば弁当',
    'ニュータッチ','凄麺','凄麺横浜家系','凄麺札幌味噌','凄麺仙台辛味噌','凄麺青森煮干',
    '金ちゃんラーメン','徳島製粉',
    '辛ラーメン','辛ラミョン','ノグリ','ノグリラーメン','三養ラーメン','ブルダック','プルダック',
    '一蘭カップ','一風堂カップ','天下一品カップ','家系カップ',
    '日清どん兵衛','どん兵衛きつねうどん','どん兵衛天ぷらそば','どん兵衛肉うどん',
    'マルタイラーメン','棒ラーメン','うまかっちゃんとんこつ','うまかっちゃん濃厚新味',
    'エースコック','ワンタンメン','スーパーカップ','スーパーカップMAX','スーパーカップ大盛り',
    '日清カレーメシ','ハヤシメシ','ウマーメシ',
    'ボンカレー','ククレカレー','銀座カリー','LEE','咖喱屋カレー',
    '大盛りいか焼そば','日清のどん兵衛焼うどん','日清太麺焼そば',
    'ラーメン横綱カップ','蒙古タンメン中本','北極ラーメン','とみ田つけ麺','六厘舎つけ麺'
  ]},

  {cat:'日用品・雑貨',keys:[
    'ティッシュ','ボックスティッシュ','トイレット','トイレットペーパー','キッチンペーパー','洗剤','柔軟剤','食洗機用','スポンジ',
    '歯磨き','歯みがき粉','歯ブラシ','シャンプー','コンディショナー','ボディソープ','石鹸','せっけん','ラップ','アルミホイル',
    'クッキングシート','電池','乾電池','ゴミ袋','ポリ袋','マスク','ウェットティッシュ','除菌','漂白剤','カビ取り','消臭剤'
  ]},
  {cat:'卵',keys:['卵','たまご','玉子']},
  {cat:'米',keys:['米','こめ','白米','玄米','無洗米']},
  {cat:'生麺',keys:['生麺','生パスタ','生うどん','生そば','生ラーメン']},
];

let USER_DICT = loadJSON('shopping_userdict_v1', {}); // 手動学習: 正規化名→カテゴリ
function normalize(s){ if(!s) return ''; let t=s.normalize('NFKC');
  t=t.replace(/[\uff61-\uff9f]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60)).toLowerCase();
  return t.replace(/\s+/g,' ').trim();
}
function guessCategory(name){
  const n=normalize(name);
  if(USER_DICT[n]) return USER_DICT[n]; // 最優先
  for(const r of CAT_RULES){ if(r.keys.some(k=>n.includes(normalize(k)))) return r.cat; }
  for(const c of CATEGORY_NAMES){ if(n.includes(normalize(c))) return c; }
  return 'その他';
}

/* ========= ストレージ ========= */
const LS_ITEMS='shopping_items_v1';
const LS_SUPERS='shopping_supers_v1';
const LS_USERDICT='shopping_userdict_v1';
let items = loadJSON(LS_ITEMS, []);
let supers = loadJSON(LS_SUPERS, []);
function save(){ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }
function saveSupers(){ localStorage.setItem(LS_SUPERS, JSON.stringify(supers)); }
function saveUserDict(){ localStorage.setItem(LS_USERDICT, JSON.stringify(USER_DICT)); }
function loadJSON(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; }}

/* ========= IndexedDB（アルバム） ========= */
const DB_NAME='ShoppingAlbumDB'; const DB_STORE='photos';
let db=null;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>{ const d=e.target.result; d.createObjectStore(DB_STORE,{keyPath:'id'}); };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
async function dbAdd(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).add(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbPut(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbGetAll(){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readonly'); const req=tx.objectStore(DB_STORE).getAll();
  req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });}
async function dbDelete(id){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).delete(id);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbDeleteBulk(filterFn){ await openDBIf(); const list=await dbGetAll(); const targets=list.filter(filterFn);
  for(const p of targets){ await dbDelete(p.id); } return targets.length; }
async function openDBIf(){ if(db) return; await openDB(); }

/* ========= タブ & コントロール表示制御 ========= */
const pages={ list:document.getElementById('page-list'), market:document.getElementById('page-market'), album:document.getElementById('page-album') };
const tabButtons=[...document.querySelectorAll('.tabbar .tab')];
const controlsRow=document.getElementById('controlsRow');

function activateTab(name){
  tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
  Object.entries(pages).forEach(([k,el])=> el.classList.toggle('active', k===name));
  controlsRow.classList.toggle('hidden', name!=='list'); // リスト時のみ表示
}
tabButtons.forEach(b=> b.onclick=()=>{ activateTab(b.dataset.tab); if(b.dataset.tab==='album') renderAlbum(); if(b.dataset.tab==='market') refreshSuperList(); });

/* ========= スーパー選択・売場順 ========= */
const selSuper=document.getElementById('superSelect');
function refreshSuperSelect(){
  const cur=selSuper.value; selSuper.innerHTML='';
  const opt0=new Option('スーパー選択',''); opt0.disabled=false; selSuper.add(opt0);
  supers.forEach(s=> selSuper.add(new Option(s.name,s.id)) );
  selSuper.value = supers.some(s=>s.id===cur)?cur:''; // 既存選択維持
}
function shelfOrderOf(id){ const s=supers.find(x=>x.id===id); return s?.shelfOrder || []; }
document.getElementById('btnSort').onclick=()=>{ const so=shelfOrderOf(selSuper.value);
  currentViewSorted = sortByShelf(items, so);
  renderList(currentViewSorted);
};
document.getElementById('btnUnsort').onclick=()=>{ currentViewSorted=null; renderList(); };
function sortByShelf(arr, orderArr){
  const order=Object.fromEntries(orderArr.map((c,i)=>[c,i+1])); // 未知は0→先頭
  const rank=cat=> (cat in order)?order[cat]:0;
  const a=[...arr]; a.sort((x,y)=> rank(x.category)-rank(y.category)); return a;
}

/* ========= リスト：追加/表示/操作（分類は小型プルダウンのみ、変更で学習） ========= */
const ul=document.getElementById('list');
const inpName=document.getElementById('inpName'); const selQty=document.getElementById('selQty');
const onlyActive=document.getElementById('onlyActive'); const search=document.getElementById('search');
document.getElementById('btnAdd').onclick=()=>{
  const name=inpName.value.trim(); if(!name) return;
  const qty=Number(selQty.value||1);
  items.push({id:crypto.randomUUID(),name,qty,category:guessCategory(name),checked:false,skip:false,createdAt:Date.now()});
  save(); inpName.value=''; renderList();
};
document.getElementById('btnClearActive').onclick=()=>{ items=items.filter(x=>x.checked||x.skip); save(); renderList(); };
document.getElementById('btnClearAll').onclick=()=>{ if(confirm('全アイテムを削除しますか？')){ items=[]; save(); renderList(); } };
search.oninput=()=>renderList(); onlyActive.onchange=()=>renderList();

let currentViewSorted=null;
function renderList(view){
  const src = view || items;
  const q=normalize(search.value);
  ul.innerHTML='';
  src.filter(it=>{
    if(onlyActive.checked && (it.checked||it.skip)) return false;
    if(q && !normalize(it.name).includes(q)) return false;
    return true;
  }).forEach(it=>{
    const li=document.createElement('li'); li.className='item'+(it.skip?' skip':'');
    // 分類プルダウン（小型）
    const catSel=document.createElement('select'); 
    catSel.className='cat-edit';
    catSel.title='分類を変更すると次回以降この品名は同じ分類に自動分類されます';
    CATEGORY_NAMES.forEach(c=>{
      catSel.add(new Option(c,c,c===it.category,c===it.category));
    });
    catSel.onchange=()=>{
      it.category=catSel.value;
      USER_DICT[normalize(it.name)]=catSel.value; // 学習（優先判定）
      saveUserDict();
      save();
      // 並べ替え状態を維持したまま再描画
      if(currentViewSorted){
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      }else{
        renderList(view);
      }
    };

    li.innerHTML=`
      <input type="checkbox" ${it.checked?'checked':''} aria-label="チェック">
      <div class="name"><div>${escapeHtml(it.name)}</div></div>
      <div class="qty">×${it.qty}</div>
      <button class="flat cam" title="撮影">📷</button>
    `;
    li.querySelector('input').onchange=(e)=>{ it.checked=e.target.checked; save(); };
    // 左スワイプ skip
    let sx=0, sy=0; li.addEventListener('touchstart',e=>{ sx=e.touches[0].clientX; sy=e.touches[0].clientY;},{passive:true});
    li.addEventListener('touchend',e=>{
      const dx=e.changedTouches[0].clientX-sx, dy=e.changedTouches[0].clientY-sy;
      if(Math.abs(dx)>40 && Math.abs(dy)<30 && dx<0){ it.skip=!it.skip; save(); renderList(view); }
    },{passive:true});
    // カメラ
    li.querySelector('.cam').onclick=()=>startCaptureForItem(it);

    // 分類プルダウンを .name に追加（ラベルは表示しない）
    li.querySelector('.name').appendChild(catSel);

    ul.appendChild(li);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
renderList();

/* ========= カメラからアルバム追加 ========= */
const hiddenPicker=document.createElement('input'); hiddenPicker.type='file'; hiddenPicker.accept='image/*'; hiddenPicker.capture='environment'; hiddenPicker.style.display='none'; document.body.appendChild(hiddenPicker);
let captureContext=null;
function startCaptureForItem(item){
  captureContext={item, supermarketId: selSuper.value || ''};
  hiddenPicker.value=''; hiddenPicker.click();
}
hiddenPicker.onchange=async (e)=>{
  const f=e.target.files[0]; if(!f||!captureContext) return;
  const img=await fileToImage(f);
  const resized=await shrinkAndOrient(img,1280);
  const photo={ id:crypto.randomUUID(), dataUrl:resized, category:captureContext.item.category,
    name:captureContext.item.name, supermarketId:captureContext.supermarketId, takenAt:Date.now(), note:'' };
  await dbAdd(photo); renderAlbum(); showToast('アルバムに保存しました');
};
function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{URL.revokeObjectURL(url); res(img)}; img.onerror=rej; img.src=url; });}
async function shrinkAndOrient(img, maxSide){
  const r= Math.min(1, maxSide/Math.max(img.width,img.height));
  const w=Math.round(img.width*r), h=Math.round(img.height*r);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return cvs.toDataURL('image/jpeg',0.85);
}

/* ========= アルバム ========= */
const albumCat=document.getElementById('albumCat'); const albumText=document.getElementById('albumText'); const albumSuperOnly=document.getElementById('albumSuperOnly');
CATEGORY_NAMES.forEach(c=> albumCat.add(new Option(c,c)) );
albumCat.onchange=renderAlbum; albumText.oninput=renderAlbum; albumSuperOnly.onchange=renderAlbum;

const albumGrid=document.getElementById('albumGrid'); let albumCache=[];
async function renderAlbum(){
  albumGrid.innerHTML='';
  albumCache = await dbGetAll();
  const cat=albumCat.value; const q=normalize(albumText.value); const superId=albumSuperOnly.checked?selSuper.value:'';
  albumCache.filter(p=>{
    if(cat && p.category!==cat) return false;
    if(superId && p.supermarketId!==superId) return false;
    if(q && !(normalize(p.name).includes(q) || normalize(p.note||'').includes(q))) return false;
    return true;
  }).sort((a,b)=>b.takenAt-a.takenAt)
  .forEach(p=>{
    const card=document.createElement('div'); card.className='photo-card'; card.tabIndex=0;
    card.innerHTML=`
      <button class="photo-del" title="削除">削除</button>
      <img src="${p.dataUrl}" alt="">
      <div class="photo-meta">
        <div><span class="tag">${escapeHtml(p.category)}</span> <span class="small">${escapeHtml(p.name)}</span></div>
        <div class="small">スーパー：${escapeHtml(superNameOf(p.supermarketId)||'—')}</div>
        <div class="small">${fmtDate(p.takenAt)}</div>
      </div>`;
    card.querySelector('img').onclick=()=>openPhoto(p);
    card.querySelector('.photo-del').onclick=async (ev)=>{
      ev.stopPropagation();
      if(!confirm('この写真を削除しますか？')) return;
      await dbDelete(p.id);
      showToast('削除しました');
      renderAlbum();
    };
    albumGrid.appendChild(card);
  });
}
function fmtDate(t){ const d=new Date(t); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function superNameOf(id){ return supers.find(s=>s.id===id)?.name || ''; }
const modalPhoto=document.getElementById('modalPhoto');
let currentPhoto=null;
function openPhoto(p){ currentPhoto=p; document.getElementById('photoLarge').src=p.dataUrl;
  document.getElementById('photoCat').textContent=p.category; document.getElementById('photoSuper').textContent=superNameOf(p.supermarketId)||'—';
  document.getElementById('photoNote').value=p.note||''; modalPhoto.classList.add('open'); }
function closePhoto(){ modalPhoto.classList.remove('open'); currentPhoto=null; }
async function savePhotoNote(){ if(!currentPhoto) return; currentPhoto.note=document.getElementById('photoNote').value; await dbPut(currentPhoto); showToast('メモを更新しました'); closePhoto(); renderAlbum(); }
async function deletePhoto(){ if(!currentPhoto) return; if(!confirm('この写真を削除しますか？')) return; await dbDelete(currentPhoto.id); closePhoto(); renderAlbum(); showToast('削除しました'); }

/* 一括削除 */
document.getElementById('btnAlbumDeleteAll').onclick=async ()=>{
  if(!confirm('アルバム内のすべての写真を削除しますか？')) return;
  const n = await dbDeleteBulk(()=>true);
  showToast(`削除：${n}件`); renderAlbum();
};

/* ========= スーパー登録画面（売場順：選択済みを除外） ========= */
const superName=document.getElementById('superName'); const btnAddSuper=document.getElementById('btnAddSuper');
const superList=document.getElementById('superList'); const catPick=document.getElementById('catPick'); const shelfOrderUL=document.getElementById('shelfOrder');
const btnShelfAdd=document.getElementById('btnShelfAdd'); const btnSaveShelf=document.getElementById('btnSaveShelf'); const btnDeleteSuper=document.getElementById('btnDeleteSuper');

btnAddSuper.onclick=()=>{ const name=superName.value.trim(); if(!name) return; supers.push({id:crypto.randomUUID(),name,shelfOrder:[],updatedAt:Date.now()}); superName.value=''; saveSupers(); refreshSuperList(); refreshSuperSelect(); showToast('追加しました'); };
btnDeleteSuper.onclick=()=>{ const id=superList.value; if(!id) return; if(!confirm('選択スーパーを削除しますか？')) return;
  supers=supers.filter(s=>s.id!==id); saveSupers(); refreshSuperList(); refreshSuperSelect(); };

function refreshSuperList(){
  superList.innerHTML=''; supers.forEach(s=> superList.add(new Option(s.name,s.id)) );
  renderShelfOrder(superList.value);
}
superList.onchange=()=>renderShelfOrder(superList.value);

function refreshCatPickOptions(used){
  catPick.innerHTML='';
  const remaining = CATEGORY_NAMES.filter(c=> !used.includes(c));
  remaining.forEach(c=> catPick.add(new Option(c,c)));
  if(!remaining.length) catPick.add(new Option('（全て追加済み）',''));
}
function renderShelfOrder(id){
  shelfOrderUL.innerHTML='';
  const so = shelfOrderOf(id);
  refreshCatPickOptions(so); // 使用済みを選択肢から除外

  so.forEach((c,idx)=>{
    const li=document.createElement('li'); li.className='item'; li.innerHTML=`
      <div class="name">${escapeHtml(c)}</div>
      <div class="row">
        <button class="line up">↑</button>
        <button class="line dn">↓</button>
        <button class="line rm">削除</button>
      </div>`;
    li.querySelector('.up').onclick=()=>{ if(idx>0){ [so[idx-1],so[idx]]=[so[idx],so[idx-1]]; renderShelfOrder(id);} };
    li.querySelector('.dn').onclick=()=>{ if(idx<so.length-1){ [so[idx+1],so[idx]]=[so[idx],so[idx+1]]; renderShelfOrder(id);} };
    li.querySelector('.rm').onclick=()=>{ so.splice(idx,1); renderShelfOrder(id); }; // 削除で候補復活
    shelfOrderUL.appendChild(li);
  });
}
btnShelfAdd.onclick=()=>{ const id=superList.value; if(!id) return; const c=catPick.value; if(!c) return;
  const s=supers.find(x=>x.id===id); if(!s.shelfOrder.includes(c)) s.shelfOrder.push(c); renderShelfOrder(id); };
btnSaveShelf.onclick=()=>{ const id=superList.value; if(!id) return; const s=supers.find(x=>x.id===id); s.updatedAt=Date.now(); saveSupers(); refreshSuperSelect(); showToast('売場順を保存しました'); };

/* ========= QR共有（qrcode-generator） ========= */
const modalExport=document.getElementById('modalExport'); const modalImport=document.getElementById('modalImport');
document.getElementById('btnExport').onclick=()=>openExport(); document.getElementById('btnImport').onclick=()=>openImport();
const compact=document.getElementById('compact');

function makePayload(isCompact){
  const data={type:'shopping-list',v:1,exportedAt:Date.now(),
    items: isCompact? items.map(({name,qty,category})=>({name,qty,category})) : items
  };
  return JSON.stringify(data);
}
function payloadBytes(str){ return new Blob([str]).size; }
function validatePayloadSize(str){
  const bytes = payloadBytes(str);
  if (bytes > 2950) { showToast(`サイズ大（${bytes}B）。分割QRや圧縮を推奨`); }
}
function renderQRCodeInto(box, text){
  if (window.qrcode && qrcode.stringToBytesFuncs) qrcode.stringToBytes = qrcode.stringToBytesFuncs['UTF-8'];
  const qr = qrcode(0, 'M'); qr.addData(text); qr.make();
  const size = 256, cell = Math.floor(size / qr.getModuleCount()), margin = Math.floor((size - cell * qr.getModuleCount()) / 2);
  const cvs = document.createElement('canvas'); cvs.width = cvs.height = size; const ctx = cvs.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size); ctx.fillStyle = '#000';
  for(let r=0;r<qr.getModuleCount();r++){ for(let c=0;c<qr.getModuleCount();c++){ if(qr.isDark(r,c)){ ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell); } } }
  box.innerHTML = ''; box.appendChild(cvs);
}
function openExport(){
  modalExport.classList.add('open');
  const box=document.getElementById('qrcode'); const err=document.getElementById('qrError');
  err.style.display='none'; box.innerHTML='';
  try{ const payload = makePayload(compact.checked); validatePayloadSize(payload); renderQRCodeInto(box, payload); }
  catch(e){ console.error(e); err.textContent = 'QR生成に失敗しました：' + (e?.message||e); err.style.display='block'; }
}
function closeExport(){ modalExport.classList.remove('open'); }
function downloadQR(){
  const box=document.getElementById('qrcode'); const cvs=box.querySelector('canvas');
  if(!cvs) return alert('QRが見つかりません'); const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='shopping_qr.png'; a.click();
}

/* ========= QR取り込み：UI/動作 ========= */
function openImport(){
  modalImport.classList.add('open');
  document.getElementById('qrPick').value='';
  setListPreview([]); importData=null;
}
function closeImport(){ modalImport.classList.remove('open'); }

// 上部ボタンの配線
document.getElementById('btnPick').addEventListener('click', ()=>{
  document.getElementById('qrPick').click(); // アルバムから選択できる
});
document.getElementById('qrPick').onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=await fileToImage(f); const {data,w,h}=await imageToRGBA(img);
  const code = jsQR(data, w, h);
  if(!code){ alert('QRコードが見つかりません'); return; }
  try{
    const obj=JSON.parse(code.data);
    if(obj.type!=='shopping-list') throw 0;
    importData=obj;
    setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
  }catch{ alert('形式が正しくありません'); }
};

// プレビューは「品名 × 数量」だけ
function setListPreview(arr){
  const ul = document.getElementById('qrListPreview');
  ul.innerHTML = '';
  if(!arr || !arr.length){ const li=document.createElement('li'); li.className='small'; li.textContent='読み取り結果はここに表示されます。'; ul.appendChild(li); return; }
  arr.forEach(it=>{ const li=document.createElement('li'); li.textContent = `${(it.name||'').toString()} × ${Number(it.qty||1)}`; ul.appendChild(li); });
}

let importData=null;

// 画像→RGBA
async function imageToRGBA(img){
  const maxSide = 1024, scale = Math.min(1, maxSide/Math.max(img.width,img.height));
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(img,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h); return {data:id.data, w, h};
}
function applyImport(mode){
  if(!importData){ alert('先にQRを読み込んでください'); return; }
  const incoming=(importData.items||[]).map(normalizeIncoming);
  if(mode==='replace'){ items=incoming; }
  else{
    const keyOf=it=>`${it.name}__${it.category||''}__${it.qty||1}`.toLowerCase();
    const map=new Map(items.map(it=>[keyOf(it),it])); for(const it of incoming){ if(!map.has(keyOf(it))) map.set(keyOf(it),it); }
    items=Array.from(map.values());
  }
  save(); renderList(); closeImport();
}
function normalizeIncoming(it){ return { id:crypto.randomUUID(), name:it.name||'', qty:Number(it.qty||1),
  category: it.category || guessCategory(it.name||''), checked:false, skip:false, createdAt:Date.now() }; }

/* ライブスキャン（カメラ） */
let stream=null, scanRAF=null;
const liveCanvas=document.createElement('canvas'); const liveCtx=liveCanvas.getContext('2d');
const liveVideo=document.createElement('video'); liveVideo.setAttribute('playsinline','');
document.getElementById('btnLiveScanTop').addEventListener('click', async ()=>{
  try{ stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); }
  catch(e){ showToast('カメラが使用できません'); return; }
  const body=document.querySelector('#modalImport .body');
  const wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='8px'; wrap.style.display='flex'; wrap.style.justifyContent='center';
  wrap.appendChild(liveVideo); body.appendChild(wrap);
  liveVideo.srcObject=stream; await liveVideo.play();

  const scan=()=>{
    if(!liveVideo.videoWidth){ scanRAF=requestAnimationFrame(scan); return; }
    const w=liveVideo.videoWidth, h=liveVideo.videoHeight;
    const scale=Math.min(1, 640/Math.max(w,h));
    liveCanvas.width=Math.round(w*scale); liveCanvas.height=Math.round(h*scale);
    liveCtx.drawImage(liveVideo,0,0,liveCanvas.width,liveCanvas.height);
    const id=liveCtx.getImageData(0,0,liveCanvas.width,liveCanvas.height);
    const code=jsQR(id.data, liveCanvas.width, liveCanvas.height);
    if(code && code.data){
      cancelAnimationFrame(scanRAF); scanRAF=null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      liveVideo.srcObject=null; wrap.remove();
      try{
        const obj=JSON.parse(code.data);
        if(obj.type!=='shopping-list') throw 0;
        importData=obj;
        setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
        showToast('QRを検出しました');
      }catch{ showToast('形式が正しくありません'); }
      return;
    }
    scanRAF=requestAnimationFrame(scan);
  };
  scan();
});
const _origCloseImport = closeImport;
closeImport = function(){
  if(scanRAF){ cancelAnimationFrame(scanRAF); scanRAF=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  const body=document.querySelector('#modalImport .body');
  [...body.querySelectorAll('video')].forEach(v=>v.remove());
  _origCloseImport();
};

/* ========= 初期化 ========= */
function init(){
  activateTab('list'); // 初期タブ
  refreshSuperSelect(); refreshSuperList(); renderList(); renderAlbum();
  window.addEventListener('load', ()=>{
    if(!window.qrcode){ console.error('qrcode-generator 読み込み失敗'); showToast('QR生成ライブラリの読み込みに失敗'); }
    if(!window.jsQR){ console.error('jsQR 読み込み失敗'); showToast('QR読み取りライブラリの読み込みに失敗'); }
  });
}
init();

/* ========= 小物 ========= */
function showToast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2256;color:#fff;padding:8px 12px;border-radius:999px;opacity:0.95;z-index:9999';
  document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600);
}
function escape(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body>
</html>


