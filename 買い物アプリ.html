<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ãƒ‡ã‚¸ã‚¿ãƒ«è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f0f6ff; --card:#ffffff; --line:#d6e4ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --pill:#eaf2ff; --ok:#18a558; --warn:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system,"Segoe UI",Roboto,Arial}

/* Header & Tabs */
header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 0%,#f6f9ff 100%);
  border-bottom:1px solid var(--line);padding:8px 16px;z-index:10}
.brand{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand-left{display:flex;gap:12px;align-items:center}
.brand h1{font-size:20px;margin:0;color:#0b2256}
.brand-actions{display:flex;gap:6px;align-items:center}
button.btn-sm{padding:4px 8px;border-radius:8px;font-size:12px;border:1px solid var(--accent);background:var(--accent);color:#fff}
button.btn-sm.line{background:#fff;color:var(--accent)}

/* tabs */
.tabbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{position:relative;border:1px solid var(--line);background:#fff;color:#0f172a;
  padding:8px 12px;border-radius:10px 10px 0 0;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tabrow{display:flex;align-items:center;gap:8px;margin-top:-1px;border-bottom:1px solid var(--line);}

/* controls row (list-only) */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 0}
.controls.hidden{display:none}
.controls .spacer{flex:1}

select,input,button,textarea{font:inherit}
button{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.ghost{background:#fff;color:var(--accent)}
button.line{background:#fff;border-color:var(--line);color:#0f172a}
button.warn{background:var(--warn);border-color:var(--warn)}
button.ok{background:var(--ok);border-color:var(--ok)}
button.flat{border:none;background:transparent;color:var(--accent);padding:4px 8px}

/* pages */
.page{display:none;padding:16px}
.page.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{background:var(--pill);color:var(--accent-2);padding:4px 8px;border-radius:999px;font-size:12px}
input[type=text], input[type=search], select, textarea{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:0
}
ul{list-style:none;margin:0;padding:0}

/* list items */
.item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);
  border-radius:12px;padding:10px 12px;margin-bottom:8px;touch-action:pan-y}
.item .name{flex:1;min-width:0}
.item .qty{font-size:18px; font-weight:600; color:#111827}
.item.skip{background:repeating-linear-gradient(135deg,#f3f7ff 0 6px,#e6eeff 6px 12px);text-decoration:line-through}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#eef3ff;border:1px solid #dbe6ff;border-radius:6px;padding:2px 6px;font-size:12px}

/* ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆè–„ã„é’ï¼‰ */
.item.checked{
  background:#eaf2ff;
  border-color:#d6e4ff;
  opacity:1; /* èª­ã¿ã‚„ã™ã•ç¶­æŒ */
}



/* åˆ†é¡ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå°ã•ã‚ï¼‰ */
.item .cat-edit{
  font-size:12px;
  padding:2px 6px;
  margin-top:2px;
  border-radius:8px;
  height:26px;
  line-height:1.2;
}

/* â˜…è¿½è¨˜ï¼šãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³å‹•ç”»ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®‰å®šåŒ– */
#modalImport video{
  max-width: 100%;
  height: auto;
  display: block;
}

/* album */
.album-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:680px){
  .album-grid{ grid-template-columns:1fr 1fr; }
}
.photo-card{
  position:relative;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:row;
  align-items:stretch;
}

/* å·¦å´ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆã‚„ã‚„å°ã•ã‚ï¼‰ */
.photo-card .thumb-wrap{
  flex:0 0 140px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#eef3ff;
}
.photo-card img.thumb{
  width:100%;
  height:100%;
  max-height:120px;
  object-fit:cover;
  display:block;
}

/* å³å´ãƒ¡ã‚¿æƒ…å ± */
.photo-meta{
  flex:1;
  padding:10px 12px;
  border-left:1px solid var(--line);
  display:grid;
  gap:6px;
}
.photo-meta .row-top{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.photo-meta .name{
  font-weight:600;
}
.photo-meta .sub{
  font-size:12px;
  color:var(--muted);
}

/* å³ä¸Šã®å‰Šé™¤ãƒœã‚¿ãƒ³ã¯æ®ãˆç½®ã */
.photo-del{
  position:absolute;
  top:8px;
  right:8px;
  background:#fff;
  color:var(--warn);
  border:1px solid var(--warn);
  border-radius:999px;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

/* modal (above header) */
.modal{position:fixed;inset:0;background:rgba(11,16,40,.5);display:none;align-items:center;justify-content:center;padding:16px; z-index:1001;}
.modal.open{display:flex}
.sheet{background:#fff;border-radius:16px;border:1px solid var(--line);max-width:720px;width:100%;max-height:90vh;overflow:auto}
.sheet .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.sheet .body{padding:12px 14px}
.sheet .foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

@media (max-width:480px){
  .grid.cols-2{grid-template-columns:1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr}

/* ã‚¹ãƒãƒ›å¹…ï¼šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œã‚’1è¡Œã«åã‚ã‚‹æœ€é©åŒ– */
.controls{
  flex-wrap: nowrap;        /* æ”¹è¡Œã•ã›ãªã„ */
  gap: 6px;                 /* ä½™ç™½ã‚’å°‘ã—åœ§ç¸® */
}
#superSelect{
  flex: 1 1 auto;           /* ã“ã“ã‚’ä¼¸ç¸®å½¹ã« */
  min-width: 0;             /* ã¯ã¿å‡ºã—æŠ‘æ­¢ */
}
.controls button,
.controls select{
  font-size: 14px;          /* å°‘ã—ã ã‘ç¸®å° */
}
.controls button{
  padding: 6px 8px;         /* ãƒœã‚¿ãƒ³ã®å·¦å³ä½™ç™½ã‚’åœ§ç¸® */
  border-radius: 8px;
}
#btnRecipe{
  white-space: nowrap;      /* ãƒœã‚¿ãƒ³å†…æ”¹è¡Œã‚’ç¦æ­¢ */
  letter-spacing: 0;        /* åŠè§’ã‚«ãƒŠã®è©°ã‚ */
}


  /* â˜…è¿½åŠ ï¼šã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¹ãƒãƒ›ç”¨ã«èª¿æ•´ */
  #modalCapture input,
  #modalCapture select {
    font-size:14px;
  }


}


#modalRecipe select{ min-height: 260px; }
#recipeIngredients li{ display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--line); }
#recipeIngredients li:last-child{ border-bottom:none; }
#recipeIngredients .ing-name{ flex:1; }
#recipeIngredients .ing-qty{ color:var(--muted); font-size:12px; }


/* èŠ±å¹é›ªã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆå…¨ç”»é¢ãƒ»ã‚¿ãƒƒãƒ—ç„¡è¦–ï¼‰ */
#confettiCanvas{
  position:fixed; inset:0;
  width:100%; height:100%;
  pointer-events:none;               /* æ“ä½œã‚’é‚ªé­”ã—ãªã„ */
  z-index:10000;                     /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šå‰ã«å‡ºã™å ´åˆã¯ 1001ã€œ ã‚’æ§˜å­è¦‹ã§èª¿æ•´ */
  display:none;                      /* é€šå¸¸ã¯éè¡¨ç¤ºã€‚ç™ºç«æ™‚ã®ã¿è¡¨ç¤º */
}


/* ã‚µãƒ ãƒç”»åƒã®ã¯ã¿å‡ºã—ä¿é™º */
#modalPhoto img, .photo-card img{ max-width:100%; height:auto; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-left">
      <h1>ãƒ‡ã‚¸ã‚¿ãƒ«è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h1>
    </div>
    <!-- ã‚¿ã‚¤ãƒˆãƒ«è¡Œ å³å´ã«å°å‹ãƒœã‚¿ãƒ³ -->
    <div class="brand-actions">
      <button id="btnExport" class="btn-sm line">QRã§å…±æœ‰</button>
      <button id="btnImport" class="btn-sm line">QRå–ã‚Šè¾¼ã¿</button>
    </div>
  </div>

  <!-- ã‚¿ãƒ– -->
  <div class="tabbar tabrow">
    <button class="tab active" data-tab="list">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="market">ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ²</button>
    <button class="tab" data-tab="album">ã‚¢ãƒ«ãƒãƒ </button>
  </div>

  <!-- è²·ã„ç‰©ãƒªã‚¹ãƒˆç”¨ã®ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒªã‚¹ãƒˆã‚¿ãƒ–æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div class="controls" id="controlsRow">
    <select id="superSelect"></select>
    <button class="line" id="btnSort">å£²å ´é †</button>
    <button class="line" id="btnUnsort">è§£é™¤</button>

<!-- â˜…è¿½åŠ ï¼šãƒ¬ã‚·ãƒ”ãƒœã‚¿ãƒ³ -->
<button class="line" id="btnRecipe" title="ãƒ¬ã‚·ãƒ”" aria-label="ãƒ¬ã‚·ãƒ”">ï¾šï½¼ï¾‹ï¾Ÿ</button>

<button class="line" id="btnQuickCam" title="å†™çœŸæ’®å½±" aria-label="å†™çœŸæ’®å½±">ğŸ“·</button>
    <span class="spacer"></span>
    <!-- â€» QRãƒœã‚¿ãƒ³ã¯ brand-actions ã«ç§»å‹•æ¸ˆã¿ -->
  </div>
</header>

<main>
  <!-- è²·ã„ç‰©ãƒªã‚¹ãƒˆ -->
  <section id="page-list" class="page active">
    <div class="card">
      <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼šå“åãƒ»å€‹æ•°ï¼ˆç‹­å¹…ï¼‰ãƒ»è¿½åŠ  ãŒä¸€åˆ— -->
      <div class="row">
        <input id="inpName" type="text" placeholder="å“åï¼ˆä¾‹ï¼šç‰›ä¹³ï¼‰" style="flex:1;min-width:160px">
        <select id="selQty" style="width:68px">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
        <button id="btnAdd">è¿½åŠ </button>
      </div>

      <!-- 2è¡Œç›®ï¼šå·¦å¯„ã›ã§ æœªè³¼å…¥ã®ã¿ ï¼‹ ã‚¯ãƒªã‚¢ï¼ˆå…¨ã‚¯ãƒªã‚¢ï¼‰ -->
      <div class="row" style="margin-top:8px;justify-content:flex-start">
        <label class="small"><input type="checkbox" id="onlyActive"> æœªè³¼å…¥ã®ã¿</label>
        <button class="warn" id="btnClearAll">ã‚¯ãƒªã‚¢</button>
      </div>

      <!-- ãƒªã‚¹ãƒˆ -->
      <ul id="list" style="margin-top:10px"></ul>
    </div>
  </section>

  <!-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ² -->
  <section id="page-market" class="page">
    <div class="card">
      <h3 style="margin:0 0 8px">ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ²</h3>
      <div class="row">
        <input id="superName" type="text" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼å" style="flex:1">
        <button id="btnAddSuper">è¿½åŠ </button>
      </div>
<div class="row small" style="margin-top:6px;color:var(--muted)">
  å£²å ´é †ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ã‚’ä½¿ã†ãŸã‚ã®ã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã®å£²å ´é †ç™»éŒ²ç”»é¢ã§ã™ã€‚<br>
  æ–°è¦ã‚¹ãƒ¼ãƒ‘ãƒ¼åã‚’ç™»éŒ²â†’ã‚¹ãƒ¼ãƒ‘ãƒ¼ä¸€è¦§ã§é¸æŠâ†’å…¥å£ã‹ã‚‰å¥¥ã¾ã§ã®å£²å ´é †ã‚’å…¥åŠ›ã€‚<br>
  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã‚ˆãã‚ã‚‹å£²ã‚Šå ´é †ã‚’è‡ªå‹•ã§ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§ä¸¦ã³å¤‰ãˆã¦ãã ã•ã„ã€‚
</div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>ã‚¹ãƒ¼ãƒ‘ãƒ¼ä¸€è¦§</strong>
            <button class="flat" id="btnDeleteSuper">é¸æŠå‰Šé™¤</button>
          </div>
          <select id="superList" size="8" style="width:100%"></select>
        </div>
        <div class="card">
          <strong>å£²å ´é †ï¼ˆå…¥å£â†’å¥¥ï¼‰</strong>
          <div class="row" style="margin:6px 0">
            <select id="catPick" style="flex:1"></select>
            <button id="btnShelfAdd">è¿½åŠ </button>
            <span class="small" style="margin-left:auto">â€»é‡è¤‡ä¸å¯ï¼ˆè¿½åŠ æ¸ˆã¿ã¯é¸æŠè‚¢ã«å‡ºã¾ã›ã‚“ï¼‰</span>
          </div>
          <ul id="shelfOrder"></ul>
          <div class="row" style="justify-content:flex-end">
            <button class="ok" id="btnSaveShelf">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ã‚¢ãƒ«ãƒãƒ  -->
  <section id="page-album" class="page">
    <div class="card">
      <div class="grid cols-3">
        <select id="albumCat">
          <option value="">åˆ†é¡ã§çµã‚Šè¾¼ã¿</option>
        </select>
        <input id="albumText" type="search" placeholder="å“åãƒ¡ãƒ¢ã§çµã‚Šè¾¼ã¿">
        <div class="row" style="justify-content:flex-end">
          <input id="albumSuperOnly" type="checkbox"><label for="albumSuperOnly" class="small">é¸æŠã‚¹ãƒ¼ãƒ‘ãƒ¼ã®ã¿</label>
        </div>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end;gap:8px">
        <button class="warn" id="btnAlbumDeleteAll">ã‚¢ãƒ«ãƒãƒ ä¸€æ‹¬å‰Šé™¤</button>
      </div>
      <div class="album-grid" id="albumGrid" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<!-- Export Modal -->
<div id="modalExport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰</strong>
      <button class="flat" onclick="closeExport()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <div class="row small"><span class="pill">ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚’å…±æœ‰</span> ç›¸æ‰‹ã¯ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚‹ã‹ã€ŒQRå–ã‚Šè¾¼ã¿ã€ã§ç”»åƒã‹ã‚‰èª­ã‚ã¾ã™ã€‚</div>
<div class="card" style="margin-top:8px;display:flex;justify-content:center">
  <div id="qrcode"></div>
</div>

<!-- â˜…ã“ã“ã«è¿½åŠ ã™ã‚‹ -->
<div id="qrCaption" class="small" style="text-align:center;margin-top:6px;color:var(--muted)"></div>

<div id="qrError" class="small" style="color:#b91c1c;margin-top:6px;display:none"></div>

      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="compact"> åœ§ç¸®å…±æœ‰ï¼ˆå“åãƒ»æ•°é‡ãƒ»åˆ†é¡ã®ã¿ï¼‰</label>
        <span class="small" style="margin-left:auto;color:var(--muted)">é•·å¤§ãƒªã‚¹ãƒˆã¯åœ§ç¸®æ¨å¥¨</span>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="saveQRToPhotos()">ç”»åƒä¿å­˜</button>

      <button class="ok" onclick="closeExport()">OK</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="modalImport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRå–ã‚Šè¾¼ã¿</strong>
      <button class="flat" onclick="closeImport()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <!-- ä¸Šéƒ¨2ãƒœã‚¿ãƒ³ -->
      <div class="row" style="gap:8px; margin-bottom:8px;">
        <button class="line" id="btnLiveScanTop">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button class="line" id="btnPick">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <input id="qrPick" type="file" accept="image/*" style="display:none">
      </div>

      <div class="small" style="margin-top:0;color:var(--muted)">â€»ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã§ã‚¹ãƒãƒ›å†…ã®ç”»åƒã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã¹ã¾ã™ã€‚</div>
      <div class="card" style="margin-top:8px">
        <strong>èª­ã¿å–ã£ãŸå“ç›®</strong>
        <ul id="qrListPreview" style="margin-top:6px"></ul>
      </div>
    </div>
    <div class="foot" style="justify-content:flex-start">
      <button class="line" onclick="applyImport('merge')">ç¾åœ¨ã®ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
      <button class="ok" onclick="applyImport('replace')">ãƒªã‚¹ãƒˆã‚’ã“ã‚Œã«å…¥ã‚Œæ›¿ãˆ</button>
    </div>
  </div>
</div>

<!-- Capture Modal (æ–°è¦æ’®å½±â†’åå‰/åˆ†é¡/ãƒ¡ãƒ¢ã‚’å…¥åŠ›) -->
<div id="modalCapture" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>å†™çœŸã®è¿½åŠ </strong>
      <button class="flat" id="btnCapCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="body">
      <img id="capPreview" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <div class="small">å“å</div>
          <input id="capName" type="text" placeholder="ä¾‹ï¼šç‰›ä¹³">
        </div>
        <div>
          <div class="small">åˆ†é¡</div>
          <select id="capCategory"></select>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <div class="small">ã‚¹ãƒ¼ãƒ‘ãƒ¼</div>
          <div id="capSuper" class="pill"></div>
        </div>
        <div>
          <div class="small">ãƒ¡ãƒ¢</div>
          <input id="capNote" type="text" placeholder="ä¾¡æ ¼ãƒ»è¦æ ¼ãªã©">
        </div>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">
        â€» å“åå…¥åŠ›ã«å¿œã˜ã¦è‡ªå‹•åˆ†é¡ã•ã‚Œã¾ã™ï¼ˆæ‰‹å‹•ã§å¤‰æ›´ã‚‚å¯èƒ½ï¼‰
      </div>
    </div>
    <div class="foot">
      <button class="ok" id="btnCapSave">ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜</button>
    </div>
  </div>
</div>


<!-- Photo Modal -->
<div id="modalPhoto" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>å†™çœŸ</strong>
      <button class="flat" onclick="closePhoto()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <img id="photoLarge" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <div class="small">åˆ†é¡</div>
          <div id="photoCat" class="pill"></div>
        </div>
        <div>
          <div class="small">ã‚¹ãƒ¼ãƒ‘ãƒ¼</div>
          <div id="photoSuper" class="pill"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="photoNote" rows="3" style="flex:1" placeholder="ãƒ¡ãƒ¢ï¼ˆä¾¡æ ¼ãƒ»è¦æ ¼ãªã©ï¼‰"></textarea>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="deletePhoto()">å‰Šé™¤</button>
      <button class="ok" onclick="savePhotoNote()">æ›´æ–°</button>
    </div>
  </div>
</div>

<!-- Recipe Modal -->
<div id="modalRecipe" class="modal" aria-hidden="true">
  <div class="sheet" style="max-width:720px">
    <div class="head">
      <strong>ãƒ¬ã‚·ãƒ”ã‹ã‚‰ææ–™ã‚’é¸ã¶</strong>
      <button class="flat" onclick="closeRecipe()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <div class="grid cols-2">
        <div class="card">
          <div class="small" style="margin-bottom:6px">æ–™ç†åˆ†é¡</div>
          <select id="recipeCat" size="10" style="width:100%"></select>
        </div>
        <div class="card">
          <div class="small" style="margin-bottom:6px">æ–™ç†</div>
          <select id="recipeDish" size="10" style="width:100%"></select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:baseline">
          <strong>ææ–™</strong>
          <button class="flat" id="btnRecipeToggleAll">å…¨é¸æŠ/è§£é™¤</button>
        </div>
        <ul id="recipeIngredients" style="margin-top:6px"></ul>
        <div class="small" style="color:var(--muted);margin-top:6px">
          â€» å®¶åº­ã«å¸¸å‚™ã•ã‚ŒãŒã¡ãª <span class="pill">é†¤æ²¹ãƒ»ç ‚ç³–ãƒ»ã¿ã‚Šã‚“ãƒ»å‘³å™Œãƒ»æ–™ç†é…’ãƒ»ã‚µãƒ©ãƒ€æ²¹</span> ã¯é™¤å¤–æ¸ˆã¿
        </div>
      </div>
    </div>
    <div class="foot" style="justify-content:flex-end">
      <button class="ok" id="btnAddSelectedIngredients">è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>
  </div>
</div>




<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<!-- ç”»é¢ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ç”»åƒåŒ–ã™ã‚‹ãŸã‚ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ========= å®šæ•°ãƒ»åˆ†é¡ ========= */
const CATEGORY_NAMES = [
  'é‡èœãƒ»æœç‰©','ç²¾è‚‰','é®®é­šãƒ»åˆºèº«','æƒ£èœãƒ»å¼å½“','ãƒ‘ãƒ³','ä¹³è£½å“','å†·å‡é£Ÿå“',
  'è±†è…ãƒ»ç´è±†ãƒ»æ¼¬ç‰©','ä¹¾ç‰©','èª¿å‘³æ–™ãƒ»æ²¹ãƒ»ã ã—','è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯','é£²æ–™','é…’é¡',
  'ç¼¶è©°','ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚«ãƒ¬ãƒ¼','ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéººãƒ»ä¹¾éºº','ãƒ‘ã‚¹ã‚¿','ç²‰ã‚‚ã®',
  'æ—¥ç”¨å“ãƒ»é›‘è²¨','åµ','ç±³','ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©','ãã®ä»–'
];


const CAT_RULES = [
  {cat:'é‡èœãƒ»æœç‰©',keys:[
    'ãƒˆãƒãƒˆ','ãƒ¬ã‚¿ã‚¹','ãã‚…ã†ã‚Š','ã«ã‚“ã˜ã‚“','äººå‚','ç‰ã­ã','ç‰è‘±','ã˜ã‚ƒãŒ','ã˜ã‚ƒãŒã„ã‚‚','é¦¬éˆ´è–¯',
    'ç™½èœ','ã»ã†ã‚Œã‚“è‰','ã»ã†ã‚Œã‚“ãã†','å°æ¾èœ','æ°´èœ','ãƒãƒŠãƒŠ','ã‚Šã‚“ã”','æ—æª','ã¿ã‹ã‚“','ã„ã¡ã”','ã¶ã©ã†','è‘¡è„',
    'ã‚­ãƒ£ãƒ™ãƒ„','ãã‚ƒã¹ã¤','ãƒã‚®','ã­ã','é•·ã­ã','é•·ãƒã‚®','å¤§æ ¹','ã‹ã¶','è•ª','ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼','ã‚«ãƒªãƒ•ãƒ©ãƒ¯ãƒ¼',
    'ãƒ”ãƒ¼ãƒãƒ³','ãƒ‘ãƒ—ãƒªã‚«','ãªã™','èŒ„å­','ã—ã„ãŸã‘','æ¤èŒ¸','ã—ã‚ã˜','ãˆã®ã','æ¦','ã¾ã„ãŸã‘','èˆèŒ¸','ã‚¨ãƒªãƒ³ã‚®',
    'ãã®ã“','ã‚‚ã‚„ã—','ã•ã¤ã¾ã„ã‚‚','ã•ã¨ã„ã‚‚','é‡ŒèŠ‹','é•·èŠ‹','å±±èŠ‹','ã‚Œã‚“ã“ã‚“','è“®æ ¹','ã”ã¼ã†','ç‰›è’¡',
    'ãã¬ã•ã‚„','ã‚¹ãƒŠãƒƒãƒ—ãˆã‚“ã©ã†','æè±†','ã‚ªã‚¯ãƒ©','ãƒˆã‚¦ãƒ¢ãƒ­ã‚³ã‚·','ã¨ã†ã‚‚ã‚ã“ã—','ã‚³ãƒ¼ãƒ³','ã‚­ãƒ¥ã‚¦ãƒª'
  ]},
  {cat:'ç²¾è‚‰',keys:[
    'ç‰›è‚‰','è±šè‚‰','é¶è‚‰','æŒ½ãè‚‰','ã²ãè‚‰','åˆã„æŒ½ã','åˆæŒ½ã','ãƒŸãƒ³ãƒ',
    'ã•ã•ã¿','ã‚µã‚µãƒŸ','ã‚€ã­','ãƒ ãƒ','ã‚‚ã‚‚','ãƒ¢ãƒ¢','ãƒãƒ©','ãƒ™ãƒ¼ã‚³ãƒ³','ãƒãƒ ','ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸',
    'ãƒ©ãƒ ','ãƒãƒˆãƒ³','ãƒ¬ãƒãƒ¼','ç ‚è‚','èƒ¸è‚‰','ãƒ¢ãƒ¢è‚‰','è‚©ãƒ­ãƒ¼ã‚¹','ãƒ­ãƒ¼ã‚¹','ãƒ’ãƒ¬','ã‚µãƒ¼ãƒ­ã‚¤ãƒ³'
  ]},
  {cat:'é®®é­šãƒ»åˆºèº«',keys:[
    'åˆºèº«','é®­','ã‚µãƒ¼ãƒ¢ãƒ³','ã‚µãƒ','é¯–','ã‚¢ã‚¸','é¯µ','ã‚¤ãƒ¯ã‚·','é°¯','ã‚¿ã‚³','è›¸','ã‚¤ã‚«','çƒè³Š','ã‚¨ãƒ“','æµ·è€',
    'ã—ã‚‰ã™','ãƒ›ãƒƒã‚±','é°¤','ãƒ–ãƒª','ãƒã‚°ãƒ­','é®ª','ã‚«ãƒ„ã‚ª','é°¹','ã‚¿ã‚¤','é¯›','åˆ‡ã‚Šèº«','åˆ‡èº«','é–‹ã'
  ]},
  {cat:'æƒ£èœãƒ»å¼å½“',keys:[
    'å¼å½“','ç·èœ','æƒ£èœ','å”æšã’','ã‹ã‚‰ã‚ã’','ã‚³ãƒ­ãƒƒã‚±','å¤©ã·ã‚‰','ã‚µãƒ©ãƒ€','å¯¿å¸','ãŠã«ãã‚Š','ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',
    'ã‚ªãƒ¼ãƒ‰ãƒ–ãƒ«','ç…®ç‰©','ç‚’ã‚ç‰©','æƒ£èœãƒ‘ãƒ³','ã‚°ãƒ©ã‚¿ãƒ³','ãƒ‰ãƒªã‚¢'
  ]},
  {cat:'ãƒ‘ãƒ³',keys:['ãƒ‘ãƒ³','é£Ÿãƒ‘ãƒ³','ãƒã‚²ãƒƒãƒˆ','ãƒ­ãƒ¼ãƒ«','ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³','ãƒ•ãƒ©ãƒ³ã‚¹ãƒ‘ãƒ³','ãƒ™ãƒ¼ã‚°ãƒ«','ãƒã‚¿ãƒ¼ãƒ­ãƒ¼ãƒ«']},
  {cat:'ä¹³è£½å“',keys:['ç‰›ä¹³','ãƒŸãƒ«ã‚¯','ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ','ãƒãƒ¼ã‚º','ãƒã‚¿ãƒ¼','ç”Ÿã‚¯ãƒªãƒ¼ãƒ ','ã‚¯ãƒªãƒ¼ãƒ ãƒãƒ¼ã‚º','ã‚«ãƒƒãƒ†ãƒ¼ã‚¸','ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ©','ã‚¹ã‚­ãƒ ãƒŸãƒ«ã‚¯']},
  {cat:'å†·å‡é£Ÿå“',keys:['å†·å‡','å†·é£Ÿ','å†·å‡é¤ƒå­','é¤ƒå­(å†·å‡)','ãƒãƒ£ãƒ¼ãƒãƒ³(å†·å‡)','ãƒ”ã‚¶(å†·å‡)','å†·å‡ã†ã©ã‚“','å†·å‡ãƒ‘ã‚¹ã‚¿','å†·å‡é‡èœ','ã‚¢ã‚¤ã‚¹']},
  {cat:'è±†è…ãƒ»ç´è±†ãƒ»æ¼¬ç‰©',keys:['è±†è…','çµ¹','æœ¨ç¶¿','ç´è±†','åšæšã’','æ²¹æšã’','é«˜é‡è±†è…','æ¼¬ç‰©','ã‚­ãƒ ãƒ','ç³ æ¼¬ã‘','ã¬ã‹æ¼¬ã‘','æµ…æ¼¬ã‘','ãƒ”ã‚¯ãƒ«ã‚¹']},
  {cat:'ä¹¾ç‰©',keys:['æµ·è‹”','ã®ã‚Š','é°¹ç¯€','ã‹ã¤ãŠã¶ã—','ç…®å¹²ã—','å¹²ã—','æ˜¥é›¨','åˆ‡ã‚Šå¹²ã—','å¹²ã—æ¤èŒ¸','é«˜é‡è±†è…','ä¹¾ç‡¥ã‚ã‹ã‚','ä¹¾ç‡¥']},
  {cat:'èª¿å‘³æ–™ãƒ»æ²¹ãƒ»ã ã—',keys:[
    'å¡©','ç ‚ç³–','å‘³å™Œ','ã¿ã','é†¤æ²¹','ã—ã‚‡ã†ã‚†','é…¢','ã¿ã‚Šã‚“','æ–™ç†é…’','é…’','èƒ¡æ¤’','ã‚³ã‚·ãƒ§ã‚¦','ã“ã—ã‚‡ã†',
    'ã ã—','ç™½ã ã—','é¡†ç²’ã ã—','ã‚³ãƒ³ã‚½ãƒ¡','ãƒ–ã‚¤ãƒ¨ãƒ³','ã”ã¾æ²¹','ã‚µãƒ©ãƒ€æ²¹','ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«','èœç¨®æ²¹',
    'ã‚½ãƒ¼ã‚¹','ã‚±ãƒãƒ£ãƒƒãƒ—','ãƒãƒ¨ãƒãƒ¼ã‚º','ãƒã‚¹ã‚¿ãƒ¼ãƒ‰','ãƒ©ãƒ¼æ²¹','è±†æ¿é†¤','ç”œéººé†¤','å‘³è¦‡','å‰µå‘³ã‚·ãƒ£ãƒ³ã‚¿ãƒ³','ã‚¹ãƒ‘ã‚¤ã‚¹','ãƒãƒ¼ãƒ–'
  ]},
  {cat:'è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯',keys:['ãŠè“å­','è“å­','ã‚¹ãƒŠãƒƒã‚¯','ãƒãƒ†ãƒ','ãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹','ã‚¯ãƒƒã‚­ãƒ¼','ãƒãƒ§ã‚³','ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ','ã‚­ãƒ£ãƒ³ãƒ‡ã‚£','ã‚¬ãƒ ','ã‚°ãƒŸ','ã›ã‚“ã¹ã„','ãƒ“ã‚¹ã‚±ãƒƒãƒˆ','ãƒ©ã‚¹ã‚¯']},
  {cat:'é£²æ–™',keys:['æ°´','ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼','ãŠèŒ¶','ç·‘èŒ¶','éº¦èŒ¶','ç´…èŒ¶','ã‚³ãƒ¼ãƒ’ãƒ¼','ã‚¸ãƒ¥ãƒ¼ã‚¹','ç‚­é…¸','ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯','ç‰›ä¹³é£²æ–™','ã‚³ã‚³ã‚¢']},
  {cat:'é…’é¡',keys:['ãƒ“ãƒ¼ãƒ«','ç™ºæ³¡é…’','ãƒãƒ¥ãƒ¼ãƒã‚¤','é…ãƒã‚¤','ãƒ¯ã‚¤ãƒ³','æ—¥æœ¬é…’','ç„¼é…','ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼','ãƒã‚¤ãƒœãƒ¼ãƒ«','æ¢…é…’','ãƒªã‚­ãƒ¥ãƒ¼ãƒ«']},
// ç¼¶è©°
{cat:'ç¼¶è©°',keys:[
  'ç¼¶è©°','ãƒ„ãƒŠ','ã‚³ãƒ¼ãƒ³ç¼¶','ãƒˆãƒãƒˆç¼¶','ã‚µãƒç¼¶','ã„ã‚ã—ç¼¶','ã‚ªã‚¤ãƒ«ã‚µãƒ¼ãƒ‡ã‚£ãƒ³','ãƒŸãƒ¼ãƒˆã‚½ãƒ¼ã‚¹ç¼¶','ã‚³ãƒ¼ãƒ³ã‚¯ãƒªãƒ¼ãƒ ç¼¶','ã•ã°ç¼¶'
]},

// ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚«ãƒ¬ãƒ¼ï¼ˆâ€»ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¹ã‚¿/ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼ã‚‚ã“ã“ã¸ï¼‰
{cat:'ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚«ãƒ¬ãƒ¼',keys:[
  'ãƒ¬ãƒˆãƒ«ãƒˆ','ãƒ¬ãƒˆãƒ«ãƒˆã‚«ãƒ¬ãƒ¼','ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¹ã‚¿','ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼',
  'ãƒœãƒ³ã‚«ãƒ¬ãƒ¼','ã‚¯ã‚¯ãƒ¬ã‚«ãƒ¬ãƒ¼','éŠ€åº§ã‚«ãƒªãƒ¼','LEE','å’–å–±å±‹ã‚«ãƒ¬ãƒ¼',
  'æ—¥æ¸…ã‚«ãƒ¬ãƒ¼ãƒ¡ã‚·','ãƒãƒ¤ã‚·ãƒ¡ã‚·','ã‚¦ãƒãƒ¼ãƒ¡ã‚·'
]},

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéººãƒ»ä¹¾éººï¼ˆâ€» ãã†ã‚ã‚“/ç´ éºº ã‚‚ã“ã“ï¼‰
{cat:'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéººãƒ»ä¹¾éºº',keys:[
  'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆ','ã‚«ãƒƒãƒ—éºº','è¢‹éºº','å³å¸­éºº','å³å¸­',
  'ã‚«ãƒƒãƒ—ãƒŒãƒ¼ãƒ‰ãƒ«','ã‚«ãƒƒãƒ—ãƒŒãƒ¼ãƒ‰ãƒ«ã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰','ã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰ãƒŒãƒ¼ãƒ‰ãƒ«','ã‚«ãƒƒãƒ—ãƒŒãƒ¼ãƒ‰ãƒ«ã‚«ãƒ¬ãƒ¼','ãƒãƒªãƒˆãƒãƒˆãƒŒãƒ¼ãƒ‰ãƒ«','æ¬§é¢¨ãƒãƒ¼ã‚ºã‚«ãƒ¬ãƒ¼',
  'æ—¥æ¸…éººè·äºº','éººè·äºº','æ—¥æ¸…ãƒ©ç‹','ãƒ©ç‹','ãƒ©ç‹è±šéª¨','ãƒ©ç‹å‘³å™Œ','ãƒ©ç‹é†¤æ²¹','ãƒ©ç‹å¡©','ãƒã‚­ãƒ³ãƒ©ãƒ¼ãƒ¡ãƒ³',
  'æ—¥æ¸…ç„¼ãã°UFO','UFO','U.F.O','æ—¥æ¸…ç„¼ãã°','æ—¥æ¸…ç„¼ããã°',
  'ãƒšãƒ¤ãƒ³ã‚°','ãƒšãƒ¤ãƒ³ã‚°ã‚½ãƒ¼ã‚¹ã‚„ããã°','ç„æ¿€è¾›','è¶…å¤§ç››',
  'ä¸€å¹³ã¡ã‚ƒã‚“','ä¸€å¹³ã¡ã‚ƒã‚“å¤œåº—ã®ç„¼ãã°','ãƒãƒ¨ãƒ“ãƒ¼ãƒ ',
  'æ˜æ˜Ÿãƒãƒ£ãƒ«ãƒ¡ãƒ©','ãƒãƒ£ãƒ«ãƒ¡ãƒ©','æ˜æ˜Ÿä¸€å¹³ã¡ã‚ƒã‚“','æ˜æ˜Ÿä¸­è¯ä¸‰æ˜§',
  'å‡ºå‰ä¸€ä¸','ã”ã¾ãƒ©ãƒ¼æ²¹',
  'ãƒãƒ«ã¡ã‚ƒã‚“æ­£éºº','æ­£éºº','ãƒãƒ«ã¡ã‚ƒã‚“æ˜”ãªãŒã‚‰ã®ä¸­è¯ãã°','ãƒãƒ«ã¡ã‚ƒã‚“èµ¤ã„ãã¤ã­','èµ¤ã„ãã¤ã­','ç·‘ã®ãŸã¬ã','ã”ã¤ç››ã‚Š','ãƒãƒªã†ã¾',
  'ã‚„ããã°å¼å½“','ç„¼ãã°å¼å½“',
  'ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒƒãƒ','å‡„éºº','å‡„éººæ¨ªæµœå®¶ç³»','å‡„éººæœ­å¹Œå‘³å™Œ','å‡„éººä»™å°è¾›å‘³å™Œ','å‡„éººé’æ£®ç…®å¹²',
  'é‡‘ã¡ã‚ƒã‚“ãƒ©ãƒ¼ãƒ¡ãƒ³','å¾³å³¶è£½ç²‰',
  'è¾›ãƒ©ãƒ¼ãƒ¡ãƒ³','è¾›ãƒ©ãƒŸãƒ§ãƒ³','ãƒã‚°ãƒª','ãƒã‚°ãƒªãƒ©ãƒ¼ãƒ¡ãƒ³','ä¸‰é¤Šãƒ©ãƒ¼ãƒ¡ãƒ³','ãƒ–ãƒ«ãƒ€ãƒƒã‚¯','ãƒ—ãƒ«ãƒ€ãƒƒã‚¯',
  'ä¸€è˜­ã‚«ãƒƒãƒ—','ä¸€é¢¨å ‚ã‚«ãƒƒãƒ—','å¤©ä¸‹ä¸€å“ã‚«ãƒƒãƒ—','å®¶ç³»ã‚«ãƒƒãƒ—',
  'æ—¥æ¸…ã©ã‚“å…µè¡›','ã©ã‚“å…µè¡›ãã¤ã­ã†ã©ã‚“','ã©ã‚“å…µè¡›å¤©ã·ã‚‰ãã°','ã©ã‚“å…µè¡›è‚‰ã†ã©ã‚“',
  'ãƒãƒ«ã‚¿ã‚¤ãƒ©ãƒ¼ãƒ¡ãƒ³','æ£’ãƒ©ãƒ¼ãƒ¡ãƒ³',
  'å¤§ç››ã‚Šã„ã‹ç„¼ãã°','æ—¥æ¸…ã®ã©ã‚“å…µè¡›ç„¼ã†ã©ã‚“','æ—¥æ¸…å¤ªéººç„¼ãã°',
  'ãƒ©ãƒ¼ãƒ¡ãƒ³æ¨ªç¶±ã‚«ãƒƒãƒ—','è’™å¤ã‚¿ãƒ³ãƒ¡ãƒ³ä¸­æœ¬','åŒ—æ¥µãƒ©ãƒ¼ãƒ¡ãƒ³','ã¨ã¿ç”°ã¤ã‘éºº','å…­å˜èˆã¤ã‘éºº',
  'ãã†ã‚ã‚“','ç´ éºº'
]},

// ãƒ‘ã‚¹ã‚¿ï¼ˆä¹¾éººã®ã€Œãƒ‘ã‚¹ã‚¿ã€ä¸€èˆ¬ã¯ã“ã“ã€‚ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¹ã‚¿ã¯â†‘ã«å¯„ã›ã¦ã‚ã‚‹ï¼‰
{cat:'ãƒ‘ã‚¹ã‚¿',keys:[
  'ãƒ‘ã‚¹ã‚¿','ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£','ã‚¹ãƒ‘ã‚²ãƒ†ã‚£'
]},

  {cat:'æ—¥ç”¨å“ãƒ»é›‘è²¨',keys:[
    'ãƒ†ã‚£ãƒƒã‚·ãƒ¥','ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚£ãƒƒã‚·ãƒ¥','ãƒˆã‚¤ãƒ¬ãƒƒãƒˆ','ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼','ã‚­ãƒƒãƒãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼','æ´—å‰¤','æŸ”è»Ÿå‰¤','é£Ÿæ´—æ©Ÿç”¨','ã‚¹ãƒãƒ³ã‚¸',
    'æ­¯ç£¨ã','æ­¯ã¿ãŒãç²‰','æ­¯ãƒ–ãƒ©ã‚·','ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼','ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒŠãƒ¼','ãƒœãƒ‡ã‚£ã‚½ãƒ¼ãƒ—','çŸ³é¹¸','ã›ã£ã‘ã‚“','ãƒ©ãƒƒãƒ—','ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«',
    'ã‚¯ãƒƒã‚­ãƒ³ã‚°ã‚·ãƒ¼ãƒˆ','é›»æ± ','ä¹¾é›»æ± ','ã‚´ãƒŸè¢‹','ãƒãƒªè¢‹','ãƒã‚¹ã‚¯','ã‚¦ã‚§ãƒƒãƒˆãƒ†ã‚£ãƒƒã‚·ãƒ¥','é™¤èŒ','æ¼‚ç™½å‰¤','ã‚«ãƒ“å–ã‚Š','æ¶ˆè‡­å‰¤'
  ]},
  {cat:'åµ',keys:['åµ','ãŸã¾ã”','ç‰å­']},
  {cat:'ç±³',keys:['ç±³','ã“ã‚','ç™½ç±³','ç„ç±³','ç„¡æ´—ç±³']},
 // ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©ï¼ˆãƒãƒ«ãƒ‰éººï¼‹ç·´ã‚Šç‰©ç³»ï¼‰
{cat:'ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©', keys:[
  'ãƒãƒ«ãƒˆ','ãƒãƒ«ãƒ‰','ãƒãƒ«ãƒ‰éºº','ç”Ÿéºº','ç”Ÿã†ã©ã‚“','ç”Ÿãã°','ç”Ÿãƒ©ãƒ¼ãƒ¡ãƒ³','å†·è”µéºº','ãƒ¬ãƒ³ã‚¸éºº',
  'é¤ƒå­','ãã‚‡ã†ã–','ç”Ÿé¤ƒå­','ãƒãƒ«ãƒ‰é¤ƒå­','ã—ã‚…ã†ã¾ã„','ç„¼å£²','ãƒ¯ãƒ³ã‚¿ãƒ³',
  'ã‹ã¾ã¼ã“','ã¡ãã‚','ã¯ã‚“ãºã‚“','ã¤ã¿ã‚Œ','ã•ã¤ã¾æšã’','ç¬¹ã‹ã¾',
  'ã¡ã‚ƒã‚“ã½ã‚“','ãƒ©ãƒ¼ãƒ¡ãƒ³(ãƒãƒ«ãƒ‰)','ã†ã©ã‚“(ãƒãƒ«ãƒ‰)','ãã°(ãƒãƒ«ãƒ‰)'
]},

// ç²‰ã‚‚ã®ï¼ˆè£½è“ãƒ»è£½ãƒ‘ãƒ³ãƒ»å®¶åº­ç²‰é¡ï¼‰
{cat:'ç²‰ã‚‚ã®', keys:[
  'å°éº¦ç²‰','è–„åŠ›ç²‰','å¼·åŠ›ç²‰','ä¸­åŠ›ç²‰','ç™½ç‰ç²‰','ä¸Šæ–°ç²‰','ç±³ç²‰','ç‰‡æ —ç²‰',
  'ãƒ›ãƒƒãƒˆã‚±ãƒ¼ã‚­ãƒŸãƒƒã‚¯ã‚¹','ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­ãƒŸãƒƒã‚¯ã‚¹',
  'ãŠå¥½ã¿ç„¼ãç²‰','ãŸã“ç„¼ãç²‰','å¤©ã·ã‚‰ç²‰','å”æšã’ç²‰','ã‹ã‚‰æšã’ç²‰',
  'ãƒ‘ãƒ³ç²‰'
]},

];

let USER_DICT = loadJSON('shopping_userdict_v1', {}); // æ‰‹å‹•å­¦ç¿’: æ­£è¦åŒ–åâ†’ã‚«ãƒ†ã‚´ãƒª
function normalize(s){ if(!s) return ''; let t=s.normalize('NFKC');
  t=t.replace(/[\uff61-\uff9f]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60)).toLowerCase();
  return t.replace(/\s+/g,' ').trim();
}
function guessCategory(name){
  const n=normalize(name);
  if(USER_DICT[n]) return USER_DICT[n]; // æœ€å„ªå…ˆ
  for(const r of CAT_RULES){ if(r.keys.some(k=>n.includes(normalize(k)))) return r.cat; }
  for(const c of CATEGORY_NAMES){ if(n.includes(normalize(c))) return c; }
  return 'ãã®ä»–';
}

/* ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ========= */
const LS_ITEMS='shopping_items_v1';
const LS_SUPERS='shopping_supers_v1';
const LS_USERDICT='shopping_userdict_v1';
let items = loadJSON(LS_ITEMS, []);
let supers = loadJSON(LS_SUPERS, []);

// === ä¸€åº¦ãã‚Šã®ç§»è¡Œï¼šæ—§ã‚«ãƒ†ã‚´ãƒªåã‚’æ–°ãƒ«ãƒ¼ãƒ«ã§å†åˆ†é¡ ===
(function migrateOldCategory(){
  const OLD = 'ç¼¶è©°ãƒ»ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéºº';
  let changed = 0;

  // items ã®å†åˆ†é¡
  items.forEach(it=>{
    if(it.category === OLD){
      it.category = guessCategory(it.name); // åå‰ã‹ã‚‰å†æ¨å®šï¼ˆæ–°CAT_RULESã§æŒ¯ã‚Šåˆ†ã‘ï¼‰
      changed++;
    }
  });

  // USER_DICTï¼ˆå­¦ç¿’è¾æ›¸ï¼‰ã®å†åˆ†é¡
  for(const [k,v] of Object.entries(USER_DICT)){
    if(v === OLD){
      USER_DICT[k] = guessCategory(k);
      changed++;
    }
  }

  if(changed){
    try{ save(); }catch(e){}
    try{ saveUserDict(); }catch(e){}
    console.log('migrated old category ->', changed);
  }
})();

// === ä¸€åº¦ãã‚Šã®ç§»è¡Œï¼šæ—§ã€Œç”Ÿéººã€â†’ æ–°ã€Œãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©ã€ ===
(function migrateSeimenToChilled(){
  const OLD = 'ç”Ÿéºº';
  const NEW = 'ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©';
  let changed = 0;

  items.forEach(it=>{
    if(it.category === OLD){
      it.category = NEW;
      changed++;
    }
  });

  for(const [k,v] of Object.entries(USER_DICT)){
    if(v === OLD){
      USER_DICT[k] = NEW;
      changed++;
    }
  }

  if(changed){
    try{ save(); }catch(e){}
    try{ saveUserDict(); }catch(e){}
    console.log('migrated ç”Ÿéºº -> ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰© :', changed);
  }
})();


function save(){ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }
function saveSupers(){ localStorage.setItem(LS_SUPERS, JSON.stringify(supers)); }
function saveUserDict(){ localStorage.setItem(LS_USERDICT, JSON.stringify(USER_DICT)); }
function loadJSON(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; }}

/* ========= IndexedDBï¼ˆã‚¢ãƒ«ãƒãƒ ï¼‰ ========= */
const DB_NAME='ShoppingAlbumDB'; const DB_STORE='photos';
let db=null;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>{ const d=e.target.result; d.createObjectStore(DB_STORE,{keyPath:'id'}); };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
async function dbAdd(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).add(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbPut(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbGetAll(){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readonly'); const req=tx.objectStore(DB_STORE).getAll();
  req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });}
async function dbDelete(id){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).delete(id);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbDeleteBulk(filterFn){ await openDBIf(); const list=await dbGetAll(); const targets=list.filter(filterFn);
  for(const p of targets){ await dbDelete(p.id); } return targets.length; }
async function openDBIf(){ if(db) return; await openDB(); }

/* ========= ã‚¿ãƒ– & ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºåˆ¶å¾¡ ========= */
const pages={ list:document.getElementById('page-list'), market:document.getElementById('page-market'), album:document.getElementById('page-album') };
const tabButtons=[...document.querySelectorAll('.tabbar .tab')];
const controlsRow=document.getElementById('controlsRow');

function activateTab(name){
  tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
  Object.entries(pages).forEach(([k,el])=> el.classList.toggle('active', k===name));
  controlsRow.classList.toggle('hidden', name!=='list'); // ãƒªã‚¹ãƒˆæ™‚ã®ã¿è¡¨ç¤º
}
tabButtons.forEach(b=> b.onclick=()=>{ activateTab(b.dataset.tab); if(b.dataset.tab==='album') renderAlbum(); if(b.dataset.tab==='market') refreshSuperList(); });

/* ========= ã‚¹ãƒ¼ãƒ‘ãƒ¼é¸æŠãƒ»å£²å ´é † ========= */

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå£²å ´é †ï¼ˆæœªé¸æŠ/æ–°è¦ã‚¹ãƒ¼ãƒ‘ãƒ¼æ™‚ã«é©ç”¨ï¼‰
const DEFAULT_SHELF_ORDER = [
  'é‡èœãƒ»æœç‰©',
  'è±†è…ãƒ»ç´è±†ãƒ»æ¼¬ç‰©',
  'ãƒãƒ«ãƒˆé£Ÿå“ãƒ»ç”Ÿéººãƒ»ç·´ã‚Šç‰©', // â† æ—§ã€Œç”Ÿéººã€ã‚’åŒ…å«
  'åµ',
  'é®®é­šãƒ»åˆºèº«',
  'ä¹¾ç‰©',
  'èª¿å‘³æ–™ãƒ»æ²¹ãƒ»ã ã—',
  'ãƒ‘ã‚¹ã‚¿',
  'ç²‰ã‚‚ã®',                 // æ–°è¦
  'ç¼¶è©°',
  'ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚«ãƒ¬ãƒ¼',
  'ç²¾è‚‰',
  'è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯',
  'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéººãƒ»ä¹¾éºº',
  'ä¹³è£½å“',
  'é£²æ–™',
  'å†·å‡é£Ÿå“',
  'æƒ£èœãƒ»å¼å½“',
  'ãƒ‘ãƒ³',
  'é…’é¡',                   // ã€Œç¨®é¡ã€ã¯ã€Œé…’é¡ã€ã¨è§£é‡ˆ
  'æ—¥ç”¨å“ãƒ»é›‘è²¨',
  'ç±³',
  'ãã®ä»–'
];



const selSuper=document.getElementById('superSelect');
function refreshSuperSelect(){
  const cur=selSuper.value; selSuper.innerHTML='';
  const opt0=new Option('ã‚¹ãƒ¼ãƒ‘ãƒ¼é¸æŠ',''); opt0.disabled=false; selSuper.add(opt0);
  supers.forEach(s=> selSuper.add(new Option(s.name,s.id)) );
  selSuper.value = supers.some(s=>s.id===cur)?cur:''; // æ—¢å­˜é¸æŠç¶­æŒ
}
function shelfOrderOf(id){ const s=supers.find(x=>x.id===id); return s?.shelfOrder || []; }
document.getElementById('btnSort').onclick = () => {
  // ã“ã“ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã›ãšã€ãã®ã¾ã¾ç¾åœ¨ã®å£²å ´é †ã‚’æ¸¡ã™
  const so = shelfOrderOf(selSuper.value);
  currentViewSorted = sortByShelf(items, so);
  renderList(currentViewSorted);
};


document.getElementById('btnUnsort').onclick=()=>{ currentViewSorted=null; renderList(); };
function sortByShelf(arr, orderArr){
  // åŸºæº–é †ï¼šä¿å­˜ã•ã‚Œã¦ã„ã‚‹å£²å ´é † or æ—¢å®š
  let base = (orderArr && orderArr.length) ? [...orderArr] : [...DEFAULT_SHELF_ORDER];

  // ã€Œãã®ä»–ã€ã¯ã„ã£ãŸã‚“é™¤å¤–ã—ã¦æœ€å¾Œã«å›ºå®š
  base = base.filter(c => c !== 'ãã®ä»–');

  // å£²å ´é †ã«ç„¡ã„â€œæ–°ã—ã„åˆ†é¡â€ã‚’æœ«å°¾ã«è£œå®Œï¼ˆä¾‹ï¼šå¾Œã‹ã‚‰è¿½åŠ ã—ãŸã‚«ãƒ†ã‚´ãƒªï¼‰
  CATEGORY_NAMES.forEach(c => {
    if (c !== 'ãã®ä»–' && !base.includes(c)) base.push(c);
  });

  // ã€Œãã®ä»–ã€ã‚’æœ€çµ‚ä½ç½®ã«å›ºå®š
  base.push('ãã®ä»–');

  // ãƒ©ãƒ³ã‚¯è¡¨ï¼ˆå°ã•ã„ã»ã©å‰ï¼‰
  const rank = Object.fromEntries(base.map((c, i) => [c, i]));

  const a = [...arr];
  a.sort((x, y) => {
    const rx = (rank[x.category] ?? 1e9);
    const ry = (rank[y.category] ?? 1e9);
    if (rx !== ry) return rx - ry;
    // åŒãƒ©ãƒ³ã‚¯æ™‚ã¯ä½œæˆæ™‚åˆ»â†’åå‰ã§å®‰å®šåŒ–
    const cx = x.createdAt || 0, cy = y.createdAt || 0;
    if (cx !== cy) return cx - cy;
    return (x.name || '').localeCompare(y.name || '');
  });
  return a;
}


/* ========= ãƒªã‚¹ãƒˆï¼šè¿½åŠ /è¡¨ç¤º/æ“ä½œï¼ˆåˆ†é¡ã¯å°å‹ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã¿ã€å¤‰æ›´ã§å­¦ç¿’ï¼‰ ========= */
const ul=document.getElementById('list');
const inpName=document.getElementById('inpName'); const selQty=document.getElementById('selQty');
const onlyActive=document.getElementById('onlyActive');
document.getElementById('btnAdd').onclick=()=>{
  const name=inpName.value.trim(); if(!name) return;
  const qty=Number(selQty.value||1);
  items.push({id:crypto.randomUUID(),name,qty,category:guessCategory(name),checked:false,skip:false,createdAt:Date.now()});
  save(); inpName.value=''; renderList();
};
document.getElementById('btnClearAll').onclick=()=>{ if(confirm('å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ items=[]; save(); renderList(); } };
onlyActive.onchange=()=>renderList();

let currentViewSorted=null;
function renderList(view){
  const src = view || items;
  ul.innerHTML = '';

  src.filter(it=>{
    if(onlyActive.checked && (it.checked || it.skip)) return false;
    return true;
  }).forEach(it=>{
    // âœ… ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã§è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆ.item.checkedï¼‰
    const li = document.createElement('li');
    li.className = 'item' + (it.checked ? ' checked' : '');

    // æœ¬ä½“ï¼ˆãƒã‚§ãƒƒã‚¯ãƒ»åå‰ãƒ»æ•°é‡ãƒ»ã‚«ãƒ¡ãƒ©ï¼‰
    li.innerHTML = `
      <input type="checkbox" ${it.checked ? 'checked' : ''} aria-label="ãƒã‚§ãƒƒã‚¯">
      <div class="name"><div>${escapeHtml(it.name)}</div></div>
      <div class="qty">Ã—${it.qty}</div>
      <button class="flat cam" title="æ’®å½±">ğŸ“·</button>
    `;

    // âœ… ãƒã‚§ãƒƒã‚¯ã§ä¿å­˜ï¼†å†æç”»ï¼ˆè‰²ã‚‚æ›´æ–°ï¼‰
    li.querySelector('input').onchange = (e) => {
      it.checked = e.target.checked;
      save();

      // ä¸¦ã¹æ›¿ãˆä¸­ãªã‚‰ç¶­æŒã—ã¦å†æç”»
      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
    };

    // âœ… å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰
    let sx = 0, sy = 0;
    li.addEventListener('touchstart', e => {
      sx = e.touches[0].clientX;
      sy = e.touches[0].clientY;
    }, {passive:true});
    li.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - sx;
      const dy = e.changedTouches[0].clientY - sy;
      if (Math.abs(dx) > 40 && Math.abs(dy) < 30 && dx < 0) {
        if (confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          items = items.filter(x => x.id !== it.id);
          save();
          if (currentViewSorted) {
            currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
            renderList(currentViewSorted);
          } else {
            renderList(view);
          }
        }
      }
    }, {passive:true});

    // ğŸ“· ã‚«ãƒ¡ãƒ©ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒï¼‰
    li.querySelector('.cam').onclick = () => startCaptureForItem(it);

    // ğŸ”½ åˆ†é¡ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆï¼ˆå°å‹ï¼‰
    const catSel = document.createElement('select');
    catSel.className = 'cat-edit';
    catSel.title = 'åˆ†é¡ã‚’å¤‰æ›´ã™ã‚‹ã¨æ¬¡å›ä»¥é™ã“ã®å“åã¯åŒã˜åˆ†é¡ã«è‡ªå‹•åˆ†é¡ã•ã‚Œã¾ã™';
    CATEGORY_NAMES.forEach(c=>{
      catSel.add(new Option(c, c, c === it.category, c === it.category));
    });
    catSel.onchange = () => {
      it.category = catSel.value;
      USER_DICT[normalize(it.name)] = catSel.value;
      saveUserDict();
      save();

      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
    };

    // ğŸ–Šï¸ å“ç›®åã‚¿ãƒƒãƒ—ã§ç·¨é›†â†’åˆ†é¡ã‚‚å†åˆ¤å®š
    const nameEl = li.querySelector('.name > div');
    nameEl.style.cursor = 'text';
    nameEl.title = 'ã‚¿ãƒƒãƒ—ã—ã¦å“åã‚’ç·¨é›†';
    nameEl.onclick = () => {
      const newName = prompt('å“åã‚’ä¿®æ­£', it.name);
      if (newName == null) return;               // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      const trimmed = newName.trim();
      if (!trimmed || trimmed === it.name) return;

      it.name = trimmed;
      it.category = guessCategory(trimmed);      // â† å†åˆ¤å®š
      USER_DICT[normalize(trimmed)] = it.category;
      saveUserDict();
      save();

      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
      showToast('åç§°ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆåˆ†é¡ã‚‚å†åˆ¤å®šï¼‰');
    };

    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åå‰ã®ä¸‹ã«å·®ã—è¾¼ã‚€
    li.querySelector('.name').appendChild(catSel);

    ul.appendChild(li);
  });

  // âœ… ã“ã“ã§å…¨ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆåˆ¤å®šã‚’å‘¼ã³å‡ºã™
  setTimeout(celebrateIfCompleted, 0);
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
renderList();

/* ========= ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã‚¢ãƒ«ãƒãƒ è¿½åŠ  ========= */
const hiddenPicker=document.createElement('input'); hiddenPicker.type='file'; hiddenPicker.accept='image/*'; hiddenPicker.capture='environment'; hiddenPicker.style.display='none'; document.body.appendChild(hiddenPicker);
let captureContext=null;

// æ–°è¦æ’®å½±ã®ä¸‹æ›¸ã
let currentCaptureDraft = null;

// å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«å‚ç…§
const modalCapture  = document.getElementById('modalCapture');
const capPreview    = document.getElementById('capPreview');
const capName       = document.getElementById('capName');
const capCategory   = document.getElementById('capCategory');
const capNote       = document.getElementById('capNote');
const capSuper      = document.getElementById('capSuper');
const btnCapSave    = document.getElementById('btnCapSave');
const btnCapCancel  = document.getElementById('btnCapCancel');

// åˆ†é¡ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
function fillCapCategory(selectEl, selected){
  selectEl.innerHTML = '';
  CATEGORY_NAMES.forEach(c => selectEl.add(new Option(c, c, c===selected, c===selected)));
}

// å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openCaptureModal(draft){
  currentCaptureDraft = draft; // { dataUrl, supermarketId, name?, category?, note? }
  capPreview.src = draft.dataUrl;
  capName.value  = draft.name || '';
  fillCapCategory(capCategory, draft.category || (draft.name ? guessCategory(draft.name) : 'ãã®ä»–'));
  capNote.value  = draft.note || '';
  capSuper.textContent = superNameOf(draft.supermarketId) || 'â€”';
  modalCapture.classList.add('open');
}

// é–‰ã˜ã‚‹/ã‚¯ãƒªã‚¢
function closeCaptureModal(){
  modalCapture.classList.remove('open');
  currentCaptureDraft = null;
  capPreview.src = '';
  capName.value = '';
  capNote.value = '';
}

// å“åå…¥åŠ›ã«å¿œã˜ã¦è‡ªå‹•åˆ†é¡ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ†é¡ã‚’æ‰‹ã§è§¦ã£ãŸã‚‰ä¸Šæ›¸ãã—ãªã„ï¼‰
let capCatTouched = false;
capCategory.onchange = () => { capCatTouched = true; };
capName.addEventListener('input', () => {
  if (!capCatTouched){
    const g = guessCategory(capName.value.trim());
    fillCapCategory(capCategory, g);
  }
});
btnCapCancel.onclick = () => closeCaptureModal();

// ä¿å­˜ â†’ IndexedDB
btnCapSave.onclick = async () => {
  if(!currentCaptureDraft) return;
  const name = capName.value.trim();
  if(!name){ alert('å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const category = capCategory.value || guessCategory(name);
  const note = capNote.value.trim();

  // å­¦ç¿’è¾æ›¸ã«åæ˜ ï¼ˆæ¬¡å›ä»¥é™ã®è‡ªå‹•åˆ†é¡ã«æ´»ãã‚‹ï¼‰
  USER_DICT[normalize(name)] = category;
  saveUserDict();

  const photo = {
    id: crypto.randomUUID(),
    dataUrl: currentCaptureDraft.dataUrl,
    category,
    name,
    supermarketId: currentCaptureDraft.supermarketId || '',
    takenAt: Date.now(),
    note
  };
  await dbAdd(photo);
  closeCaptureModal();
  showToast('ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã¾ã—ãŸ');
  renderAlbum();
  capCatTouched = false;
};



function startCaptureForItem(item){
  captureContext={item, supermarketId: selSuper.value || ''};
  hiddenPicker.value=''; hiddenPicker.click();
}
hiddenPicker.onchange = async (e) => {
  const f = e.target.files[0];
  if (!f || !captureContext) return;

  const img = await fileToImage(f);
  const resized = await shrinkAndOrient(img, 1280);

  // ğŸ“·ãƒœã‚¿ãƒ³ã‹ã‚‰ã®ã€Œãƒ•ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€
  if (captureContext.mode === 'free') {
    openCaptureModal({
      dataUrl: resized,
      supermarketId: captureContext.supermarketId || '',
      name: '',
      category: 'ãã®ä»–',
      note: ''
    });
    captureContext = null; // ãƒªã‚»ãƒƒãƒˆ
    return;
  }

  // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã«ç´ä»˜ã‘ï¼ˆå¾“æ¥ã®å‹•ä½œï¼‰
  if (captureContext.item) {
    const photo = {
      id: crypto.randomUUID(),
      dataUrl: resized,
      category: captureContext.item.category,
      name: captureContext.item.name,
      supermarketId: captureContext.supermarketId || '',
      takenAt: Date.now(),
      note: ''
    };
    await dbAdd(photo);
    renderAlbum();
    showToast('ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã¾ã—ãŸ');
    captureContext = null;
  }
};

function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{URL.revokeObjectURL(url); res(img)}; img.onerror=rej; img.src=url; });}
async function shrinkAndOrient(img, maxSide){
  const r= Math.min(1, maxSide/Math.max(img.width,img.height));
  const w=Math.round(img.width*r), h=Math.round(img.height*r);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return cvs.toDataURL('image/jpeg',0.85);
}

/* ========= ã‚¢ãƒ«ãƒãƒ  ========= */
const albumCat=document.getElementById('albumCat'); const albumText=document.getElementById('albumText'); const albumSuperOnly=document.getElementById('albumSuperOnly');
CATEGORY_NAMES.forEach(c=> albumCat.add(new Option(c,c)) );
albumCat.onchange=renderAlbum; albumText.oninput=renderAlbum; albumSuperOnly.onchange=renderAlbum;

const albumGrid=document.getElementById('albumGrid'); let albumCache=[];
async function renderAlbum(){
  albumGrid.innerHTML='';
  albumCache = await dbGetAll();
  const cat=albumCat.value; const q=normalize(albumText.value); const superId=albumSuperOnly.checked?selSuper.value:'';
  albumCache.filter(p=>{
    if(cat && p.category!==cat) return false;
    if(superId && p.supermarketId!==superId) return false;
    if(q && !(normalize(p.name).includes(q) || normalize(p.note||'').includes(q))) return false;
    return true;
  }).sort((a,b)=>b.takenAt-a.takenAt)
  .forEach(p=>{
    const card = document.createElement('div');
    card.className = 'photo-card';
    card.tabIndex = 0;

    const superNameTxt = superNameOf(p.supermarketId) || 'â€”';

    card.innerHTML = `
      <button class="photo-del" title="å‰Šé™¤">å‰Šé™¤</button>
      <div class="thumb-wrap">
        <img class="thumb" src="${p.dataUrl}" alt="">
      </div>
      <div class="photo-meta">
        <div class="row-top">
          <span class="tag">${escapeHtml(p.category)}</span>
          <span class="name">${escapeHtml(p.name)}</span>
        </div>
        <div class="sub">ã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼š${escapeHtml(superNameTxt)}</div>
        <div class="sub">${fmtDate(p.takenAt)}</div>
      </div>
    `;

    card.querySelector('img.thumb').onclick = (ev) => {
      ev.stopPropagation();
      openPhoto(p);
    };

    card.querySelector('.photo-del').onclick = async (ev) => {
      ev.stopPropagation();
      if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await dbDelete(p.id);
      showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
      renderAlbum();
    };

    albumGrid.appendChild(card);
  });

}
function fmtDate(t){ const d=new Date(t); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function superNameOf(id){ return supers.find(s=>s.id===id)?.name || ''; }
const modalPhoto=document.getElementById('modalPhoto');
let currentPhoto=null;
function openPhoto(p){ currentPhoto=p; document.getElementById('photoLarge').src=p.dataUrl;
  document.getElementById('photoCat').textContent=p.category; document.getElementById('photoSuper').textContent=superNameOf(p.supermarketId)||'â€”';
  document.getElementById('photoNote').value=p.note||''; modalPhoto.classList.add('open'); }
function closePhoto(){ modalPhoto.classList.remove('open'); currentPhoto=null; }
async function savePhotoNote(){ if(!currentPhoto) return; currentPhoto.note=document.getElementById('photoNote').value; await dbPut(currentPhoto); showToast('ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); closePhoto(); renderAlbum(); }
async function deletePhoto(){ if(!currentPhoto) return; if(!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; await dbDelete(currentPhoto.id); closePhoto(); renderAlbum(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ'); }

/* ä¸€æ‹¬å‰Šé™¤ */
document.getElementById('btnAlbumDeleteAll').onclick=async ()=>{
  if(!confirm('ã‚¢ãƒ«ãƒãƒ å†…ã®ã™ã¹ã¦ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const n = await dbDeleteBulk(()=>true);
  showToast(`å‰Šé™¤ï¼š${n}ä»¶`); renderAlbum();
};

/* ========= ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ²ç”»é¢ï¼ˆå£²å ´é †ï¼šé¸æŠæ¸ˆã¿ã‚’é™¤å¤–ï¼‰ ========= */
const superName=document.getElementById('superName'); const btnAddSuper=document.getElementById('btnAddSuper');
const superList=document.getElementById('superList'); const catPick=document.getElementById('catPick'); const shelfOrderUL=document.getElementById('shelfOrder');
const btnShelfAdd=document.getElementById('btnShelfAdd'); const btnSaveShelf=document.getElementById('btnSaveShelf'); const btnDeleteSuper=document.getElementById('btnDeleteSuper');

btnAddSuper.onclick = () => {
  const name = superName.value.trim(); if(!name) return;
  supers.push({
    id: crypto.randomUUID(),
    name,
    shelfOrder: [...DEFAULT_SHELF_ORDER],  // ã“ã“ã§æ—¢å®šã‚’é©ç”¨
    updatedAt: Date.now()
  });
  superName.value='';
  saveSupers(); refreshSuperList(); refreshSuperSelect();
  showToast('è¿½åŠ ã—ã¾ã—ãŸï¼ˆå£²å ´é †ã¯æ—¢å®šã§ç™»éŒ²ï¼‰');
};

btnDeleteSuper.onclick=()=>{ const id=superList.value; if(!id) return; if(!confirm('é¸æŠã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  supers=supers.filter(s=>s.id!==id); saveSupers(); refreshSuperList(); refreshSuperSelect(); };

function refreshSuperList(){
  superList.innerHTML=''; supers.forEach(s=> superList.add(new Option(s.name,s.id)) );
  renderShelfOrder(superList.value);
}
superList.onchange=()=>renderShelfOrder(superList.value);

function refreshCatPickOptions(used){
  catPick.innerHTML='';
  const remaining = CATEGORY_NAMES.filter(c=> !used.includes(c));
  remaining.forEach(c=> catPick.add(new Option(c,c)));
  if(!remaining.length) catPick.add(new Option('ï¼ˆå…¨ã¦è¿½åŠ æ¸ˆã¿ï¼‰',''));
}
function renderShelfOrder(id){
  shelfOrderUL.innerHTML='';
  const soSource = shelfOrderOf(id);
  const so = (soSource && soSource.length) ? soSource : [...DEFAULT_SHELF_ORDER]; // è¿½åŠ 
  refreshCatPickOptions(so); // ä½¿ç”¨æ¸ˆã¿ã‚’é¸æŠè‚¢ã‹ã‚‰é™¤å¤–

  so.forEach((c,idx)=>{
    const li=document.createElement('li'); li.className='item'; li.innerHTML=`
      <div class="name">${escapeHtml(c)}</div>
      <div class="row">
        <button class="line up">â†‘</button>
        <button class="line dn">â†“</button>
        <button class="line rm">å‰Šé™¤</button>
      </div>`;
    li.querySelector('.up').onclick=()=>{ if(idx>0){ [so[idx-1],so[idx]]=[so[idx],so[idx-1]]; renderShelfOrder(id);} };
    li.querySelector('.dn').onclick=()=>{ if(idx<so.length-1){ [so[idx+1],so[idx]]=[so[idx],so[idx+1]]; renderShelfOrder(id);} };
    li.querySelector('.rm').onclick=()=>{ so.splice(idx,1); renderShelfOrder(id); }; // å‰Šé™¤ã§å€™è£œå¾©æ´»
    shelfOrderUL.appendChild(li);
  });
}
btnShelfAdd.onclick=()=>{ const id=superList.value; if(!id) return; const c=catPick.value; if(!c) return;
  const s=supers.find(x=>x.id===id); if(!s.shelfOrder.includes(c)) s.shelfOrder.push(c); renderShelfOrder(id); };
btnSaveShelf.onclick=()=>{ const id=superList.value; if(!id) return; const s=supers.find(x=>x.id===id); s.updatedAt=Date.now(); saveSupers(); refreshSuperSelect(); showToast('å£²å ´é †ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); };

/* ========= QRå…±æœ‰ï¼ˆqrcode-generatorï¼‰ ========= */
const modalExport=document.getElementById('modalExport'); const modalImport=document.getElementById('modalImport');
document.getElementById('btnExport').onclick=()=>openExport(); document.getElementById('btnImport').onclick=()=>openImport();
const compact=document.getElementById('compact');

function makePayload(isCompact){
  const data={type:'shopping-list',v:1,exportedAt:Date.now(),
    items: isCompact? items.map(({name,qty,category})=>({name,qty,category})) : items
  };
  return JSON.stringify(data);
}
function payloadBytes(str){ return new Blob([str]).size; }
function validatePayloadSize(str){
  const bytes = payloadBytes(str);
  if (bytes > 2950) { showToast(`ã‚µã‚¤ã‚ºå¤§ï¼ˆ${bytes}Bï¼‰ã€‚åˆ†å‰²QRã‚„åœ§ç¸®ã‚’æ¨å¥¨`); }
}
function renderQRCodeInto(box, text){
  // UTF-8 å¯¾å¿œ
  if (window.qrcode && qrcode.stringToBytesFuncs) {
    qrcode.stringToBytes = qrcode.stringToBytesFuncs['UTF-8'];
  }
  const qr = qrcode(0, 'M');
  qr.addData(text);
  qr.make();

  // ã‚­ãƒ£ãƒ³ãƒã‚¹å¯¸æ³•ï¼šQRæœ¬ä½“ + ä¸‹ã«ãƒ©ãƒ™ãƒ«é ˜åŸŸï¼ˆç´„48pxï¼‰
  const qrSize = 256;
  const labelH = 48;
  const size = qrSize + labelH;
  const cell = Math.floor(qrSize / qr.getModuleCount());
  const margin = Math.floor((qrSize - cell * qr.getModuleCount()) / 2);

  const cvs = document.createElement('canvas');
  cvs.width = cvs.height = size;
  const ctx = cvs.getContext('2d');

  // èƒŒæ™¯
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, size, size);

  // QRæœ¬ä½“
  ctx.fillStyle = '#000';
  for(let r=0; r<qr.getModuleCount(); r++){
    for(let c=0; c<qr.getModuleCount(); c++){
      if(qr.isDark(r,c)){
        ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
  }

  // ç”Ÿæˆæ—¥æ™‚ï¼ˆQRä¸‹ã«ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã—ã¦æç”»ï¼‰
  const now = new Date();
  const label = `ç”Ÿæˆ: ${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  ctx.fillStyle = '#111';
  ctx.font = '14px system-ui, -apple-system, "Segoe UI", Roboto, Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(label, size/2, qrSize + (labelH/2));

  // ç½®æ›
  box.innerHTML = '';
  box.appendChild(cvs);

  // ç”»é¢ä¸Šã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã«ã‚‚è¡¨ç¤ºï¼ˆUIç”¨ï¼‰
  const cap = document.getElementById('qrCaption');
  if (cap) cap.textContent = label;
}

function openExport(){
  modalExport.classList.add('open');
  const box = document.getElementById('qrcode');
  const err = document.getElementById('qrError');
  err.style.display='none';
  box.innerHTML='';

  try{
    const payload = makePayload(compact.checked);
    validatePayloadSize(payload);
    // â† æ—¥æ™‚ä»˜ãã§QRã‚’å†æç”»ï¼ˆé–¢æ•°å†…ã§UIã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¨ç”»åƒãƒ©ãƒ™ãƒ«ã®ä¸¡æ–¹ã‚’æ›´æ–°ï¼‰
    renderQRCodeInto(box, payload);
  }catch(e){
    console.error(e);
    err.textContent = 'QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (e?.message||e);
    err.style.display='block';
  }
}

// â˜…QRã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã¿ã‚’ç”»åƒåŒ–ã—ã¦ä¿å­˜ï¼ˆå…±æœ‰ã‚·ãƒ¼ãƒˆâ†’å†™çœŸä¿å­˜ï¼éå¯¾å¿œã¯DLï¼‰
async function saveQRToPhotos(){
  const cvs = document.querySelector('#qrcode canvas');
  if(!cvs){ alert('QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  // BlobåŒ–
  const blob = await new Promise(res => cvs.toBlob(res, 'image/png', 1.0));
  if(!blob){ alert('ç”»åƒã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  const file = new File([blob], 'shopping_qr.png', { type: 'image/png' });

  // Web Share API Level 2ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã®å…±æœ‰ã‚·ãƒ¼ãƒˆ â†’ å†™çœŸã«ä¿å­˜ï¼‰
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try{
      await navigator.share({
        files: [file],
        title: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ QR',
        text: 'QRã‚³ãƒ¼ãƒ‰ï¼ˆç”Ÿæˆæ—¥æ™‚ä»˜ãï¼‰'
      });
      showToast('å…±æœ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸï¼ˆå†™çœŸã«ä¿å­˜ã§ãã¾ã™ï¼‰');
      return;
    }catch(e){
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ã¯æ¡ã‚Šã¤ã¶ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¸
      console.warn(e);
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆPC/éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'shopping_qr.png';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showToast('ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}



function closeExport(){ modalExport.classList.remove('open'); }
function downloadQR(){
  const box=document.getElementById('qrcode'); const cvs=box.querySelector('canvas');
  if(!cvs) return alert('QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='shopping_qr.png'; a.click();
}

// â˜…ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆè¡¨ç¤ºä¸­ã®ç¯„å›²ã®ã¿ï¼‰ã‚’ç”»åƒåŒ– â†’ å…±æœ‰/ä¿å­˜
async function captureScreenToPhotos(){
  try{
    const scale = 2; // è§£åƒåº¦ã‚¢ãƒƒãƒ—
    const vx = Math.floor(window.scrollX);
    const vy = Math.floor(window.scrollY);
    const vw = Math.floor(window.innerWidth);
    const vh = Math.floor(window.innerHeight);

    // html2canvas ã® x,y,width,height ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’å³å¯†ãƒˆãƒªãƒŸãƒ³ã‚°
    const canvas = await html2canvas(document.documentElement, {
      scale,
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çŠ¶æ…‹
      windowWidth:  document.documentElement.scrollWidth, // ãƒšãƒ¼ã‚¸å…¨ä½“å¹…
      windowHeight: document.documentElement.scrollHeight, // ãƒšãƒ¼ã‚¸å…¨ä½“é«˜
      scrollX: vx,
      scrollY: vy,
      // â†ã“ã“ã§åˆ‡ã‚Šå‡ºã—ç¯„å›²ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«é™å®š
      x: vx,
      y: vy,
      width:  vw,
      height: vh,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    // PNG Blob ä½œæˆ
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1.0));
    if(!blob){ alert('ç”»åƒã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    const file = new File([blob], 'shopping_screenshot.png', { type: 'image/png' });

    // Web Share API (iOS/Android) â†’ å†™çœŸã«ä¿å­˜ ã¸èª˜å°
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ',
        text: 'ç”»é¢ã«è¦‹ãˆã¦ã„ã‚‹ç¯„å›²ã®ã¿'
      });
      showToast('å…±æœ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸï¼ˆå†™çœŸã«ä¿å­˜ã§ãã¾ã™ï¼‰');
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'shopping_screenshot.png';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showToast('ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  }catch(e){
    console.error(e);
    alert('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/* ========= QRå–ã‚Šè¾¼ã¿ï¼šUI/å‹•ä½œ ========= */
function openImport(){
  modalImport.classList.add('open');
  document.getElementById('qrPick').value='';
  setListPreview([]); importData=null;
}
function closeImport(){ modalImport.classList.remove('open'); }
document.getElementById('btnPick').addEventListener('click', ()=>{
  document.getElementById('qrPick').click();
});
document.getElementById('qrPick').onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=await fileToImage(f); const {data,w,h}=await imageToRGBA(img);
  const code = jsQR(data, w, h);
  if(!code){ alert('QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  try{
    const obj=JSON.parse(code.data);
    if(obj.type!=='shopping-list') throw 0;
    importData=obj;
    setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
  }catch{ alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
};
function setListPreview(arr){
  const ul = document.getElementById('qrListPreview');
  ul.innerHTML = '';
  if(!arr || !arr.length){ const li=document.createElement('li'); li.className='small'; li.textContent='èª­ã¿å–ã‚Šçµæœã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'; ul.appendChild(li); return; }
  arr.forEach(it=>{ const li=document.createElement('li'); li.textContent = `${(it.name||'').toString()} Ã— ${Number(it.qty||1)}`; ul.appendChild(li); });
}
let importData=null;
async function imageToRGBA(img){
  const maxSide = 1024, scale = Math.min(1, maxSide/Math.max(img.width,img.height));
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(img,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h); return {data:id.data, w, h};
}
function applyImport(mode){
  if(!importData){ alert('å…ˆã«QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  const incoming=(importData.items||[]).map(normalizeIncoming);
  if(mode==='replace'){ items=incoming; }
  else{
    const keyOf=it=>`${it.name}__${it.category||''}__${it.qty||1}`.toLowerCase();
    const map=new Map(items.map(it=>[keyOf(it),it])); for(const it of incoming){ if(!map.has(keyOf(it))) map.set(keyOf(it),it); }
    items=Array.from(map.values());
  }
  save(); renderList(); closeImport();
}
function normalizeIncoming(it){ return { id:crypto.randomUUID(), name:it.name||'', qty:Number(it.qty||1),
  category: it.category || guessCategory(it.name||''), checked:false, skip:false, createdAt:Date.now() }; }

/* HTTPS/ãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèª */
function verifySecureContext(){
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if(!isSecure){
    showToast('ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã«ã¯HTTPSã¾ãŸã¯localhostãŒå¿…è¦ã§ã™');
    return false;
  }
  return true;
}

/* ãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ */
let stream = null, scanRAF = null;
const liveCanvas = document.createElement('canvas');
const liveCtx = liveCanvas.getContext('2d', { willReadFrequently: true });
const liveVideo = document.createElement('video');
let scanning = false;

document.getElementById('btnLiveScanTop').addEventListener('click', async ()=>{
  if (scanning) return;
  if (!verifySecureContext()) return;

  scanning = true;

  try{
    liveVideo.setAttribute('playsinline','');
    liveVideo.setAttribute('autoplay','');
    liveVideo.muted = true;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } , width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
  }catch(e){
    console.error(e);
    showToast('ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆæ¨©é™/HTTPSã‚’ç¢ºèªï¼‰');
    scanning = false;
    return;
  }

  const body = document.querySelector('#modalImport .body');
  const wrap = document.createElement('div');
  wrap.className = 'card';
  wrap.style.cssText = 'margin-top:8px;display:flex;justify-content:center;align-items:center;padding:8px;';
  liveVideo.style.maxWidth = '100%';
  liveVideo.style.width = '100%';
  liveVideo.style.height = 'auto';
  wrap.appendChild(liveVideo);
  body.appendChild(wrap);

  liveVideo.srcObject = stream;
  try { await liveVideo.play(); } catch(e){ console.warn(e); }

  const scan = ()=>{
    if(!liveVideo.videoWidth){
      scanRAF = requestAnimationFrame(scan);
      return;
    }
    const vw = liveVideo.videoWidth, vh = liveVideo.videoHeight;
    const scale = Math.min(1, 1024 / Math.max(vw, vh));
    liveCanvas.width  = Math.round(vw * scale);
    liveCanvas.height = Math.round(vh * scale);

    const ctx = liveCtx;
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(liveVideo, 0, 0, liveCanvas.width, liveCanvas.height);

    const id = ctx.getImageData(0, 0, liveCanvas.width, liveCanvas.height);
    const code = jsQR(id.data, liveCanvas.width, liveCanvas.height, { inversionAttempts: 'attemptBoth' });

    if(code && code.data){
      if (scanRAF){ cancelAnimationFrame(scanRAF); scanRAF = null; }
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      liveVideo.srcObject = null;
      wrap.remove();
      scanning = false;

      try{
        const obj = JSON.parse(code.data);
        if(obj.type !== 'shopping-list') throw 0;
        importData = obj;
        setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
        showToast('QRã‚’æ¤œå‡ºã—ã¾ã—ãŸ');
      }catch{
        showToast('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      }
      return;
    }
    scanRAF = requestAnimationFrame(scan);
  };
  scan();
});

const _origCloseImport = closeImport;
closeImport = function(){
  if (scanRAF){ cancelAnimationFrame(scanRAF); scanRAF = null; }
  if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  scanning = false;

  const body = document.querySelector('#modalImport .body');
  [...body.querySelectorAll('video')].forEach(v=> v.parentElement?.remove());
  _origCloseImport();
};


/* ========= ãƒ¬ã‚·ãƒ”æ©Ÿèƒ½ ========= */

// å¸¸å‚™èª¿å‘³æ–™ï¼ˆé™¤å¤–å¯¾è±¡ï¼‰
const PANTRY_SET = new Set(['é†¤æ²¹','ã—ã‚‡ã†ã‚†','ç ‚ç³–','ã¿ã‚Šã‚“','å‘³å™Œ','æ–™ç†é…’','ã‚µãƒ©ãƒ€æ²¹']);

// ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ï¼š{ ã‚«ãƒ†ã‚´ãƒª: { æ–™ç†å: [ {name, qty?}, ... ] } }
// â€» åˆ†é‡ã¯ç›®å®‰ã€‚å¿…è¦ã«å¿œã˜ã¦å¾Œã§èª¿æ•´å¯èƒ½ã€‚
// â€» å¸¸å‚™èª¿å‘³æ–™ã¯æœ€åˆã‹ã‚‰å«ã‚ãªã„è¨­è¨ˆã«ã—ã¦ã„ã¾ã™ã€‚
const RECIPES = {
  'ã”é£¯ã‚‚ã®ãƒ»éºº': {
    'ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹':        [{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã˜ã‚ƒãŒã„ã‚‚'},{name:'ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼'},{name:'è±šã“ã¾åˆ‡ã‚Œ'},{name:'ã”é£¯'}],
    'ã‚ªãƒ ãƒ©ã‚¤ã‚¹':          [{name:'åµ'},{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ç‰ã­ã'},{name:'ã”é£¯'},{name:'ã‚±ãƒãƒ£ãƒƒãƒ—'}],
    'ç‰›ä¸¼':                [{name:'ç‰›ã“ã¾è‚‰'},{name:'ç‰ã­ã'},{name:'ã‚ã‚“ã¤ã‚†'},{name:'ã”é£¯'}],
    'è¦ªå­ä¸¼':              [{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ç‰ã­ã'},{name:'åµ'},{name:'ã‚ã‚“ã¤ã‚†'},{name:'ã”é£¯'}],
    'ã‚«ãƒ„ä¸¼':              [{name:'è±šãƒ­ãƒ¼ã‚¹ï¼ˆã¨ã‚“ã‹ã¤ç”¨ï¼‰'},{name:'åµ'},{name:'ç‰ã­ã'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'å°éº¦ç²‰'},{name:'ã‚ã‚“ã¤ã‚†'},{name:'ã”é£¯'}],
    'å¤©ä¸¼':                [{name:'æµ·è€'},{name:'ã„ã‹'},{name:'ã•ã¤ã¾ã„ã‚‚'},{name:'ãªã™'},{name:'å¤©ã·ã‚‰ç²‰'},{name:'ã‚ã‚“ã¤ã‚†'},{name:'ã”é£¯'}],
    'ä¸­è¯ä¸¼':              [{name:'è±šã“ã¾è‚‰'},{name:'ç™½èœ'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã—ã„ãŸã‘'},{name:'ã†ãšã‚‰åµ(èŒ¹ã§)'},{name:'ä¸­è¯ã‚¹ãƒ¼ãƒ—ã®ç´ '},{name:'ç‰‡æ —ç²‰'},{name:'ã”é£¯'}],
    'ã¡ã‚‰ã—å¯¿å¸':          [{name:'å¯¿å¸é…¢'},{name:'éŒ¦ç³¸åµç”¨ã®åµ'},{name:'ãã‚…ã†ã‚Š'},{name:'åˆºèº«ç››ã‚Šåˆã‚ã›'},{name:'æµ·è‹”'},{name:'ã”é£¯'}],
    'æ‰‹å·»ãå¯¿å¸':          [{name:'åˆºèº«ç››ã‚Šåˆã‚ã›'},{name:'ãã‚…ã†ã‚Š'},{name:'å¤§è‘‰'},{name:'å¯¿å¸é…¢'},{name:'ç„¼ã®ã‚Š'},{name:'ã”é£¯'}],
    'ãŠèŒ¶æ¼¬ã‘':            [{name:'ãŠèŒ¶æ¼¬ã‘ã®ç´ '},{name:'æ¢…å¹²ã—'},{name:'ç„¼ã®ã‚Š'},{name:'ã”é£¯'}],
    'ã„ãªã‚Šå¯¿å¸':          [{name:'å‘³ä»˜ã‘ã„ãªã‚Šæšã’'},{name:'å¯¿å¸é…¢'},{name:'ç™½ã”ã¾'},{name:'ã”é£¯'}],
    'ç„¼ããã°':            [{name:'ç„¼ããã°éºº'},{name:'è±šã“ã¾è‚‰'},{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'ã‚‚ã‚„ã—'},{name:'ç„¼ããã°ã‚½ãƒ¼ã‚¹'}],
    'è‚‰ã†ã©ã‚“':            [{name:'ã†ã©ã‚“'},{name:'ç‰›ã“ã¾è‚‰'},{name:'é•·ã­ã'},{name:'ã‚ã‚“ã¤ã‚†'}],
  },

  'é­šæ–™ç†': {
    'ç„¼ãé®­':              [{name:'ç”Ÿé®­åˆ‡ã‚Šèº«'}],
    'ã‚µãƒã®å‘³å™Œç…®':        [{name:'ã‚µãƒåˆ‡ã‚Šèº«'},{name:'ã—ã‚‡ã†ãŒ'}], // å‘³å™Œã¯å¸¸å‚™æ‰±ã„ã§é™¤å¤–
    'ã‚µãƒ³ãƒã®å¡©ç„¼ã':      [{name:'ç”Ÿã•ã‚“ã¾'},{name:'å¤§æ ¹'}],
    'ç…®é­šï¼ˆã‚«ãƒ¬ã‚¤ãªã©ï¼‰':  [{name:'ã‚«ãƒ¬ã‚¤åˆ‡ã‚Šèº«'},{name:'ã—ã‚‡ã†ãŒ'}],
    'ãƒ–ãƒªã®ç…§ã‚Šç„¼ã':      [{name:'ãƒ–ãƒªåˆ‡ã‚Šèº«'}],
    'ã‚¢ã‚¸ã®å—è›®æ¼¬ã‘':      [{name:'ã‚¢ã‚¸'},{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ãƒ”ãƒ¼ãƒãƒ³'},{name:'å—è›®æ¼¬ã‘ã®ç´ '}],
    'ã‚¤ãƒ¯ã‚·ã®æ¢…ç…®':        [{name:'ã„ã‚ã—'},{name:'æ¢…å¹²ã—'},{name:'ã—ã‚‡ã†ãŒ'}],
    'é®­ã®ãƒ ãƒ‹ã‚¨ãƒ«':        [{name:'ç”Ÿé®­åˆ‡ã‚Šèº«'},{name:'å°éº¦ç²‰'},{name:'ãƒã‚¿ãƒ¼'}],
    'ãƒ›ãƒƒã‚±ã®é–‹ã':        [{name:'ãƒ›ãƒƒã‚±é–‹ã'}],
    'é¯–ã®å¡©ç„¼ã':          [{name:'ã‚µãƒåˆ‡ã‚Šèº«'}],
  },

  'è‚‰æ–™ç†': {
    'è±šã®ç”Ÿå§œç„¼ã':        [{name:'è±šãƒ­ãƒ¼ã‚¹è–„åˆ‡ã‚Š'},{name:'ã—ã‚‡ã†ãŒ'},{name:'ç‰ã­ã'}],
    'é¶ã®å”æšã’':          [{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ã«ã‚“ã«ã'},{name:'ã—ã‚‡ã†ãŒ'},{name:'ç‰‡æ —ç²‰'}],
    'é¶ã®ç…§ã‚Šç„¼ã':        [{name:'é¶ã‚‚ã‚‚è‚‰'}],
    'é¶è‚‰ã¨é‡èœã®ç‚’ã‚ç‰©':  [{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ãƒ”ãƒ¼ãƒãƒ³'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ç‰ã­ã'}],
    'ãƒãƒ³ãƒãƒ¼ã‚°':          [{name:'åˆã„æŒ½ãè‚‰'},{name:'ç‰ã­ã'},{name:'åµ'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'ç‰›ä¹³'}],
    'è‚‰ã˜ã‚ƒãŒ':            [{name:'ç‰›ã“ã¾è‚‰'},{name:'ã˜ã‚ƒãŒã„ã‚‚'},{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'}],
    'è±šã‚«ãƒ„':              [{name:'è±šãƒ­ãƒ¼ã‚¹ï¼ˆã¨ã‚“ã‹ã¤ç”¨ï¼‰'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'å°éº¦ç²‰'},{name:'åµ'}],
    'ãƒã‚­ãƒ³ã‚«ãƒ„':          [{name:'é¶ã‚€ã­è‚‰'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'å°éº¦ç²‰'},{name:'åµ'}],
    'ãƒ¡ãƒ³ãƒã‚«ãƒ„':          [{name:'åˆã„æŒ½ãè‚‰'},{name:'ç‰ã­ã'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'å°éº¦ç²‰'},{name:'åµ'}],
    'ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„':      [{name:'åˆã„æŒ½ãè‚‰'},{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'ç‰ã­ã'},{name:'ãƒ‘ãƒ³ç²‰'},{name:'åµ'},{name:'ã‚³ãƒ³ã‚½ãƒ¡'}],
    'ç„¼ãé³¥ï¼ˆå®¶åº­ç”¨ã‚°ãƒªãƒ«ï¼‰':[ {name:'é¶ã‚‚ã‚‚è‚‰'},{name:'é•·ã­ã'},{name:'ç«¹ä¸²'} ],
    'è±šè‚‰ã®è§’ç…®':          [{name:'è±šãƒãƒ©ãƒ–ãƒ­ãƒƒã‚¯'},{name:'ã—ã‚‡ã†ãŒ'},{name:'é•·ã­ãï¼ˆé’ã„éƒ¨åˆ†ï¼‰'},{name:'ã‚†ã§åµ'}],
    'ç‰›è‚‰ã®ã—ãã‚Œç…®':      [{name:'ç‰›ã“ã¾è‚‰'},{name:'ã—ã‚‡ã†ãŒ'}],
    'è‚‰é‡èœç‚’ã‚':          [{name:'è±šã“ã¾è‚‰'},{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã‚‚ã‚„ã—'}],
    'é¶ãã¼ã‚':            [{name:'é¶ã²ãè‚‰'},{name:'ã—ã‚‡ã†ãŒ'},{name:'åµ'}],
  },

  'åµæ–™ç†': {
    'åµç„¼ã':              [{name:'åµ'}],
    'ã ã—å·»ãåµ':          [{name:'åµ'},{name:'ç™½ã ã—'}],
    'ç›®ç‰ç„¼ã':            [{name:'åµ'}],
    'ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ã‚¨ãƒƒã‚°':  [{name:'åµ'},{name:'ç‰›ä¹³'},{name:'ãƒã‚¿ãƒ¼'}],
    'èŒ¶ç¢—è’¸ã—':            [{name:'åµ'},{name:'ç™½ã ã—'},{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ã—ã„ãŸã‘'}],
    'ã‚ªãƒ ãƒ¬ãƒ„ï¼ˆæ´‹é¢¨ï¼‰':    [{name:'åµ'},{name:'ãƒãƒ '},{name:'ç‰ã­ã'},{name:'ãƒãƒ¼ã‚º'}],
    'è¦ªå­ç…®':              [{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'åµ'},{name:'ç‰ã­ã'},{name:'ã‚ã‚“ã¤ã‚†'}],
    'åŠç†Ÿç…®åµ':            [{name:'åµ'}],
  },

  'é‡èœãƒ»è±†è…æ–™ç†': {
    'é‡èœç‚’ã‚':            [{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã‚‚ã‚„ã—'},{name:'ãƒ”ãƒ¼ãƒãƒ³'}],
    'ãã‚“ã´ã‚‰ã”ã¼ã†':      [{name:'ã”ã¼ã†'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ç™½ã”ã¾'}],
    'ã²ã˜ãã®ç…®ç‰©':        [{name:'ä¹¾ç‡¥ã²ã˜ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'æ²¹æšã’'}],
    'åˆ‡ã‚Šå¹²ã—å¤§æ ¹ã®ç…®ç‰©':  [{name:'åˆ‡ã‚Šå¹²ã—å¤§æ ¹'},{name:'ã«ã‚“ã˜ã‚“'},{name:'æ²¹æšã’'}],
    'ç­‘å‰ç…®':              [{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ã”ã¼ã†'},{name:'ã‚Œã‚“ã“ã‚“'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã—ã„ãŸã‘'},{name:'ã“ã‚“ã«ã‚ƒã'}],
    'ç…®ã—ã‚':              [{name:'ã‚Œã‚“ã“ã‚“'},{name:'ã”ã¼ã†'},{name:'ã«ã‚“ã˜ã‚“'},{name:'é‡Œã„ã‚‚'},{name:'ã“ã‚“ã«ã‚ƒã'},{name:'ã—ã„ãŸã‘'}],
    'ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€':        [{name:'ã˜ã‚ƒãŒã„ã‚‚'},{name:'ãã‚…ã†ã‚Š'},{name:'ç‰ã­ã'},{name:'ãƒãƒ '},{name:'ãƒãƒ¨ãƒãƒ¼ã‚º'}],
    'ãƒã‚«ãƒ­ãƒ‹ã‚µãƒ©ãƒ€':      [{name:'ãƒã‚«ãƒ­ãƒ‹'},{name:'ãã‚…ã†ã‚Š'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ãƒãƒ '},{name:'ãƒãƒ¨ãƒãƒ¼ã‚º'}],
    'å†·ã‚„ã‚„ã£ã“':          [{name:'çµ¹ã”ã—è±†è…'},{name:'ã­ã'}],
    'æ¹¯è±†è…':              [{name:'çµ¹ã”ã—è±†è…'},{name:'æ˜†å¸ƒ'}],
    'æšã’å‡ºã—è±†è…':        [{name:'æœ¨ç¶¿è±†è…'},{name:'ç‰‡æ —ç²‰'},{name:'å¤§æ ¹'}],
    'éº»å©†è±†è…ï¼ˆã‚¯ãƒƒã‚¯ãƒ‰ã‚¥ãƒ¼ï¼‰':[ {name:'éº»å©†è±†è…ã®ç´ '},{name:'æœ¨ç¶¿è±†è…'} ],
    'é‡èœã®å¤©ã·ã‚‰':        [{name:'å¤©ã·ã‚‰ç²‰'},{name:'ãªã™'},{name:'ã•ã¤ã¾ã„ã‚‚'},{name:'ãƒ”ãƒ¼ãƒãƒ³'},{name:'ã—ã'}],
    'ã‚´ãƒ¼ãƒ¤ãƒãƒ£ãƒ³ãƒ—ãƒ«ãƒ¼':  [{name:'ã‚´ãƒ¼ãƒ¤'},{name:'æœ¨ç¶¿è±†è…'},{name:'åµ'},{name:'è±šã“ã¾è‚‰'}],
    'ãƒŠã‚¹ã®å‘³å™Œç‚’ã‚':      [{name:'ãªã™'},{name:'è±šã“ã¾è‚‰'}], // å‘³å™Œã¯é™¤å¤–
    'ã»ã†ã‚Œã‚“è‰ã®ãŠã²ãŸã—':[ {name:'ã»ã†ã‚Œã‚“è‰'},{name:'ã‹ã¤ãŠã¶ã—'} ],
  },

  'æ±ç‰©': {
    'è±šæ±':                [{name:'è±šã“ã¾è‚‰'},{name:'é‡Œã„ã‚‚'},{name:'ã«ã‚“ã˜ã‚“'},{name:'å¤§æ ¹'},{name:'ã”ã¼ã†'},{name:'é•·ã­ã'}], // å‘³å™Œã¯é™¤å¤–
    'ã‘ã‚“ã¡ã‚“æ±':          [{name:'å¤§æ ¹'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã”ã¼ã†'},{name:'é‡Œã„ã‚‚'},{name:'ã“ã‚“ã«ã‚ƒã'},{name:'é•·ã­ã'}],
    'ãŠå¸ã„ç‰©':            [{name:'ä¸‰ã¤è‘‰'},{name:'æ˜†å¸ƒ'},{name:'ã‹ã¾ã¼ã“'}],
    'ã‚³ãƒ¼ãƒ³ã‚¹ãƒ¼ãƒ—':        [{name:'ã‚³ãƒ¼ãƒ³ã‚¯ãƒªãƒ¼ãƒ ç¼¶'},{name:'ç‰›ä¹³'},{name:'ã‚³ãƒ³ã‚½ãƒ¡'}],
    'ãƒã‚¿ãƒ¼ã‚¸ãƒ¥':          [{name:'ã˜ã‚ƒãŒã„ã‚‚'},{name:'ç‰ã­ã'},{name:'ç‰›ä¹³'},{name:'ã‚³ãƒ³ã‚½ãƒ¡'}],
    'ãƒŸãƒã‚¹ãƒˆãƒ­ãƒ¼ãƒ':      [{name:'ãƒ™ãƒ¼ã‚³ãƒ³'},{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã‚»ãƒ­ãƒª'},{name:'ãƒˆãƒãƒˆç¼¶'},{name:'ã‚³ãƒ³ã‚½ãƒ¡'}],
    'ä¸­è¯ã‚¹ãƒ¼ãƒ—ï¼ˆåµå…¥ã‚Šï¼‰':[ {name:'ä¸­è¯ã‚¹ãƒ¼ãƒ—ã®ç´ '},{name:'åµ'},{name:'é•·ã­ã'} ],
  },

  'æ´‹é¢¨æ–™ç†': {
    'ã‚°ãƒ©ã‚¿ãƒ³':            [{name:'ãƒã‚«ãƒ­ãƒ‹'},{name:'ç‰ã­ã'},{name:'ã—ã‚ã˜'},{name:'ãƒ™ãƒ¼ã‚³ãƒ³'},{name:'ãƒ›ãƒ¯ã‚¤ãƒˆã‚½ãƒ¼ã‚¹ç¼¶'},{name:'ãƒ”ã‚¶ç”¨ãƒãƒ¼ã‚º'}],
    'ãƒ‰ãƒªã‚¢':              [{name:'ã”é£¯'},{name:'ãƒ›ãƒ¯ã‚¤ãƒˆã‚½ãƒ¼ã‚¹ç¼¶'},{name:'ãƒ”ã‚¶ç”¨ãƒãƒ¼ã‚º'},{name:'ãƒ™ãƒ¼ã‚³ãƒ³'},{name:'ç‰ã­ã'}],
    'ãƒ“ãƒ¼ãƒ•ã‚·ãƒãƒ¥ãƒ¼':      [{name:'ã‚·ãƒãƒ¥ãƒ¼ãƒ«ãƒ¼'},{name:'ç‰›è§’åˆ‡ã‚Šè‚‰'},{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã˜ã‚ƒãŒã„ã‚‚'}],
    'ã‚¯ãƒªãƒ¼ãƒ ã‚·ãƒãƒ¥ãƒ¼':    [{name:'ã‚·ãƒãƒ¥ãƒ¼ãƒ«ãƒ¼'},{name:'é¶ã‚‚ã‚‚è‚‰'},{name:'ç‰ã­ã'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã˜ã‚ƒãŒã„ã‚‚'},{name:'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼'}],
    'ãƒ­ãƒ¼ã‚¹ãƒˆãƒã‚­ãƒ³':      [{name:'é¶ã‚‚ã‚‚è‚‰ï¼ˆéª¨ä»˜ãï¼‰'},{name:'ã«ã‚“ã«ã'},{name:'ãƒ­ãƒ¼ã‚ºãƒãƒªãƒ¼'}],
    'ã‚¹ãƒ†ãƒ¼ã‚­':            [{name:'ç‰›ã‚¹ãƒ†ãƒ¼ã‚­ç”¨è‚‰'},{name:'ã«ã‚“ã«ã'},{name:'ãƒã‚¿ãƒ¼'}],
    'ãƒ”ã‚¶ï¼ˆæ‰‹ä½œã‚Šï¼‰':      [{name:'å¼·åŠ›ç²‰'},{name:'ãƒ‰ãƒ©ã‚¤ã‚¤ãƒ¼ã‚¹ãƒˆ'},{name:'ãƒˆãƒãƒˆã‚½ãƒ¼ã‚¹'},{name:'ãƒ”ã‚¶ç”¨ãƒãƒ¼ã‚º'},{name:'ãƒ™ãƒ¼ã‚³ãƒ³'},{name:'ãƒ”ãƒ¼ãƒãƒ³'}],
    'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ':        [{name:'é£Ÿãƒ‘ãƒ³'},{name:'ãƒãƒ '},{name:'ãƒ¬ã‚¿ã‚¹'},{name:'ãã‚…ã†ã‚Š'},{name:'åµ'},{name:'ãƒãƒ¨ãƒãƒ¼ã‚º'}],
    'ãƒŸãƒ¼ãƒˆã‚½ãƒ¼ã‚¹ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£':[ {name:'ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£'},{name:'åˆã„æŒ½ãè‚‰'},{name:'ç‰ã­ã'},{name:'ãƒˆãƒãƒˆç¼¶'},{name:'ã«ã‚“ã«ã'},{name:'ã‚³ãƒ³ã‚½ãƒ¡'} ],
    'ãƒŠãƒãƒªã‚¿ãƒ³':          [{name:'ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£'},{name:'ç‰ã­ã'},{name:'ãƒ”ãƒ¼ãƒãƒ³'},{name:'ã‚¦ã‚¤ãƒ³ãƒŠãƒ¼'},{name:'ã‚±ãƒãƒ£ãƒƒãƒ—'}],
    'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ':      [{name:'ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£'},{name:'ã«ã‚“ã«ã'},{name:'å”è¾›å­'},{name:'ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«'}],
    'ã‚«ãƒ«ãƒœãƒŠãƒ¼ãƒ©':        [{name:'ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£'},{name:'ãƒ™ãƒ¼ã‚³ãƒ³'},{name:'åµ'},{name:'ç²‰ãƒãƒ¼ã‚º'},{name:'é»’ã“ã—ã‚‡ã†'}],
  },

  'ãã®ä»–å®šç•ª': {
    'é¤ƒå­':                [{name:'é¤ƒå­ã®çš®'},{name:'è±šã²ãè‚‰'},{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'ã«ã‚‰'},{name:'ã«ã‚“ã«ã'},{name:'ã—ã‚‡ã†ãŒ'}],
    'æ˜¥å·»ã':              [{name:'æ˜¥å·»ãã®çš®'},{name:'è±šã“ã¾è‚‰'},{name:'ãŸã‘ã®ã“æ°´ç…®'},{name:'ã«ã‚“ã˜ã‚“'},{name:'ã—ã„ãŸã‘'},{name:'æ˜¥é›¨'}],
    'ãŠå¥½ã¿ç„¼ã':          [{name:'ãŠå¥½ã¿ç„¼ãç²‰'},{name:'åµ'},{name:'ã‚­ãƒ£ãƒ™ãƒ„'},{name:'è±šãƒãƒ©è–„åˆ‡ã‚Š'}],
    'ãŸã“ç„¼ã':            [{name:'ãŸã“ç„¼ãç²‰'},{name:'èŒ¹ã§ã ã“'},{name:'é’ã­ã'},{name:'å¤©ã‹ã™'},{name:'ç´…ã—ã‚‡ã†ãŒ'}],
    'ãŠã§ã‚“':              [{name:'ãŠã§ã‚“ã®ç´ '},{name:'å¤§æ ¹'},{name:'åµ'},{name:'ã“ã‚“ã«ã‚ƒã'},{name:'ã¡ãã‚'},{name:'ã•ã¤ã¾æšã’'}],
  }
};

/* === è¿½åŠ ï¼šãƒ¬ã‚·ãƒ”æ‹¡å¼µï¼ˆRECIPES ã®ç›´å¾Œã«è²¼ã‚Šä»˜ã‘ï¼‰ === */

// åµæ–™ç†ï¼šã‚¿ã‚¤é¢¨ç‰å­ç„¼ã
RECIPES['åµæ–™ç†']['ã‚¿ã‚¤é¢¨ç‰å­ç„¼ã'] = [
  {name:'åµ'},
  {name:'ãƒŠãƒ³ãƒ—ãƒ©ãƒ¼'},
  {name:'é’ã­ã'},
  {name:'ãƒ‘ã‚¯ãƒãƒ¼'},
  {name:'èµ¤ç‰ã­ã'},
  {name:'ãƒ©ã‚¤ãƒ '}
];

// æ´‹é¢¨æ–™ç†ï¼šã‚¿ãƒ³ãƒ‰ãƒªãƒ¼ãƒã‚­ãƒ³
RECIPES['æ´‹é¢¨æ–™ç†']['ã‚¿ãƒ³ãƒ‰ãƒªãƒ¼ãƒã‚­ãƒ³'] = [
  {name:'é¶ã‚‚ã‚‚è‚‰'},
  {name:'ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ'},
  {name:'ã‚«ãƒ¬ãƒ¼ç²‰'},
  {name:'ã«ã‚“ã«ã'},
  {name:'ã—ã‚‡ã†ãŒ'},
  {name:'ãƒ¬ãƒ¢ãƒ³'}
];

// è‚‰æ–™ç†ï¼šãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼
RECIPES['è‚‰æ–™ç†']['ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼'] = [
  {name:'è±šãƒãƒ©ãƒ–ãƒ­ãƒƒã‚¯'},
  {name:'ã—ã‚‡ã†ãŒ'},
  {name:'é•·ã­ãï¼ˆé’ã„éƒ¨åˆ†ï¼‰'}
];

// â˜…æ–°ã‚«ãƒ†ã‚´ãƒªï¼šé‹
RECIPES['é‹'] = {
  'ã™ãç„¼ã': [
    {name:'ç‰›è–„åˆ‡ã‚Šè‚‰'},
    {name:'ç™½èœ'},
    {name:'é•·ã­ã'},
    {name:'æ˜¥èŠ'},
    {name:'æœ¨ç¶¿è±†è…'},
    {name:'ã—ã‚‰ãŸã'},
    {name:'ãˆã®ã'},
    {name:'ã™ãç„¼ãã®å‰²ã‚Šä¸‹'}
  ],
  'ã‚‚ã¤é‹': [
    {name:'ç‰›ã‚‚ã¤ï¼ˆä¸‹å‡¦ç†æ¸ˆã¿ï¼‰'},
    {name:'ã‚­ãƒ£ãƒ™ãƒ„'},
    {name:'ã«ã‚‰'},
    {name:'ã«ã‚“ã«ã'},
    {name:'é·¹ã®çˆª'},
    {name:'é‹ã¤ã‚†ï¼ˆã‚‚ã¤é‹ç”¨ï¼‰'}
  ],
  'æ°´ç‚Šã': [
    {name:'é¶ã‚‚ã‚‚è‚‰'},
    {name:'ç™½èœ'},
    {name:'é•·ã­ã'},
    {name:'æœ¨ç¶¿è±†è…'},
    {name:'ã—ã‚ã˜'},
    {name:'æ˜†å¸ƒ'}
  ],
  'ã—ã‚ƒã¶ã—ã‚ƒã¶': [
    {name:'ç‰›ã—ã‚ƒã¶ç”¨è‚‰'},
    {name:'ç™½èœ'},
    {name:'é•·ã­ã'},
    {name:'æ˜¥èŠ'},
    {name:'æœ¨ç¶¿è±†è…'},
    {name:'ã—ã‚‰ãŸã'},
    {name:'æ˜†å¸ƒ'}
  ],
  'æµ·é®®é‹': [
    {name:'ãŸã‚‰åˆ‡ã‚Šèº«'},
    {name:'ãˆã³'},
    {name:'ã»ãŸã¦'},
    {name:'ç™½èœ'},
    {name:'é•·ã­ã'},
    {name:'æœ¨ç¶¿è±†è…'},
    {name:'ã—ã‚ã˜'},
    {name:'é‹ã¤ã‚†ï¼ˆå¯„ã›é‹ç”¨ï¼‰'}
  ]
};


// æ´‹é¢¨æ–™ç†ï¼šã‚¢ã‚¯ã‚¢ãƒ‘ãƒƒãƒ„ã‚¡
RECIPES['æ´‹é¢¨æ–™ç†']['ã‚¢ã‚¯ã‚¢ãƒ‘ãƒƒãƒ„ã‚¡'] = [
  {name:'ç™½èº«é­šï¼ˆé¯›ãªã©ï¼‰åˆ‡ã‚Šèº«'},
  {name:'ã‚ã•ã‚Š'},
  {name:'ãƒ—ãƒãƒˆãƒãƒˆ'},
  {name:'ãƒ–ãƒ©ãƒƒã‚¯ã‚ªãƒªãƒ¼ãƒ–'},
  {name:'ã«ã‚“ã«ã'},
  {name:'ç™½ãƒ¯ã‚¤ãƒ³'},
  {name:'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ‘ã‚»ãƒª'}
];



// ãƒ¢ãƒ¼ãƒ€ãƒ«å‚ç…§
const modalRecipe = document.getElementById('modalRecipe');
const recipeCat = document.getElementById('recipeCat');
const recipeDish = document.getElementById('recipeDish');
const recipeIngredients = document.getElementById('recipeIngredients');

// ãƒ¬ã‚·ãƒ”ãƒœã‚¿ãƒ³é–‹ã
document.getElementById('btnRecipe').onclick = openRecipe;

// ğŸ“·ã‚¯ã‚¤ãƒƒã‚¯æ’®å½±ï¼ˆãƒ¬ã‚·ãƒ”æ¨ªã®ãƒœã‚¿ãƒ³ï¼‰
document.getElementById('btnQuickCam').onclick = () => {
  // ç¾åœ¨é¸æŠä¸­ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼IDã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«
  captureContext = { mode: 'free', supermarketId: selSuper.value || '' };
  hiddenPicker.value = '';
  hiddenPicker.click(); // ç«¯æœ«ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆç’°å¢ƒã‚«ãƒ¡ãƒ©ï¼‰
};


function openRecipe(){
  // åˆ†é¡ãƒªã‚¹ãƒˆä½œæˆ
  recipeCat.innerHTML = '';
  Object.keys(RECIPES).forEach(cat => {
    const opt = new Option(cat, cat);
    recipeCat.add(opt);
  });
  // å…ˆé ­ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
  if (recipeCat.options.length) recipeCat.selectedIndex = 0;
  // æ–™ç†ãƒªã‚¹ãƒˆæç”»
  renderRecipeDishes();
  // å…ˆé ­æ–™ç†ã®ææ–™æç”»
  renderRecipeIngredients();
  modalRecipe.classList.add('open');
}
function closeRecipe(){ modalRecipe.classList.remove('open'); }

// ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ã§æ–™ç†ä¸€è¦§ã‚’æ›´æ–°
recipeCat.onchange = renderRecipeDishes;
function renderRecipeDishes(){
  const cat = recipeCat.value;
  recipeDish.innerHTML = '';
  if(!cat) return;
  Object.keys(RECIPES[cat]).forEach(name=>{
    recipeDish.add(new Option(name, name));
  });
  if (recipeDish.options.length) recipeDish.selectedIndex = 0;
  renderRecipeIngredients();
}

// æ–™ç†å¤‰æ›´ã§ææ–™æ›´æ–°
recipeDish.onchange = renderRecipeIngredients;

function renderRecipeIngredients(){
  const cat = recipeCat.value;
  const dish = recipeDish.value;
  recipeIngredients.innerHTML = '';
  if(!cat || !dish) return;

  // å¸¸å‚™èª¿å‘³æ–™é™¤å¤–
  const base = (RECIPES[cat][dish] || []).filter(it => !PANTRY_SET.has(it.name));

  for(const ing of base){
    const li = document.createElement('li');
    const id = crypto.randomUUID();
    li.innerHTML = `
      <input type="checkbox" id="${id}" checked>
      <label class="ing-name" for="${id}">${escapeHtml(ing.name)}</label>
      ${ing.qty ? `<span class="ing-qty">Ã— ${escapeHtml(String(ing.qty))}</span>` : ''}
    `;
    recipeIngredients.appendChild(li);
  }
}

// å…¨é¸æŠ/è§£é™¤
document.getElementById('btnRecipeToggleAll').onclick = ()=>{
  const boxes = recipeIngredients.querySelectorAll('input[type="checkbox"]');
  const allChecked = Array.from(boxes).every(b=>b.checked);
  boxes.forEach(b=> b.checked = !allChecked);
};

// é¸æŠææ–™ã‚’è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆé‡è¤‡ã¯è¿½åŠ ã—ãªã„ï¼‰
document.getElementById('btnAddSelectedIngredients').onclick = ()=>{
  const sel = Array.from(recipeIngredients.querySelectorAll('input[type="checkbox"]:checked'));
  if(!sel.length){ showToast('ææ–™ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

  const names = sel.map(b => b.nextElementSibling.textContent.trim()).filter(Boolean);

  // æ—¢å­˜ãƒã‚§ãƒƒã‚¯ç”¨ï¼ˆå“åï¼‹ã‚«ãƒ†ã‚´ãƒªã§è¿‘ä¼¼é‡è¤‡å›é¿ã ãŒã€ã¾ãšã¯å“åãƒ™ãƒ¼ã‚¹ï¼‰
  const existing = new Set(items.map(it => normalize(it.name)));

  let added = 0;
  for(const name of names){
    const n = normalize(name);
    if(existing.has(n)) continue; // ã™ã§ã«ã‚ã‚‹
    const cat = guessCategory(name);
    items.push({
      id: crypto.randomUUID(),
      name,
      qty: 1,
      category: cat,
      checked: false,
      skip: false,
      createdAt: Date.now()
    });
    existing.add(n);
    added++;
  }

  if(added>0){ save(); renderList(); showToast(`è¿½åŠ ï¼š${added}ä»¶`); }
  else{ showToast('ã™ã§ã«å…¨ã¦ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã™'); }
  closeRecipe();
};


/* ========= ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç¥ç¦ï¼šèŠ±å¹é›ª ========= */
let _confettiRunning = false;
let _confettiStopTimer = null;

/** ï¼ˆå¿…è¦ãªã‚‰ï¼‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”¨æ„ã—ã¦è¿”ã™ */
function ensureConfettiCanvas(){
  let cvs = document.getElementById('confettiCanvas');
  if(!cvs){
    cvs = document.createElement('canvas');
    cvs.id = 'confettiCanvas';
    document.body.appendChild(cvs);
  }
  // ã‚µã‚¤ã‚ºã‚’æ¯å›åˆã‚ã›ã‚‹ï¼ˆå›è»¢æ™‚/ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ç¸®ã¿å¯¾ç­–ï¼‰
  cvs.width  = window.innerWidth  * (window.devicePixelRatio || 1);
  cvs.height = window.innerHeight * (window.devicePixelRatio || 1);
  return cvs;
}

/** èŠ±å¹é›ªæœ¬ä½“ï¼ˆç°¡æ˜“ãƒ»ä¾å­˜ãªã—ï¼‰ */
function startConfetti(durationMs = 5000){
  if(_confettiRunning) return;
  const cvs = ensureConfettiCanvas();
  const ctx = cvs.getContext('2d');

  const dpr = window.devicePixelRatio || 1;
  const W = cvs.width, H = cvs.height;

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
  const N = Math.min(220, Math.max(120, Math.floor((W/dpr) * 0.25))); // ç”»é¢å¹…ã«å¿œã˜ã¦
  const colors = ['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6','#F59E0B','#10B981','#3B82F6'];
  const parts = Array.from({length:N}, (_,i)=>({
    x: Math.random()*W,
    y: -Math.random()*H*0.5,
    w: 6 + Math.random()*8,
    h: 10 + Math.random()*12,
    vy: 1.5 + Math.random()*2.5,
    vx: -1 + Math.random()*2,
    rot: Math.random()*Math.PI*2,
    vr: (-0.15 + Math.random()*0.3),
    color: colors[i % colors.length],
    tilt: Math.random()*Math.PI*2,
    vt: 0.05 + Math.random()*0.05
  }));

  cvs.style.display = 'block';
  _confettiRunning = true;

  const t0 = performance.now();
  cancelAnimationFrame(startConfetti._rafId);

  function frame(t){
    const elapsed = t - t0;
    ctx.clearRect(0,0,W,H);

    for(const p of parts){
      // ãµã‚ãµã‚æ¨ªæºã‚Œ
      p.tilt += p.vt;
      p.x += p.vx + Math.sin(p.tilt)*0.6;
      p.y += p.vy;
      p.rot += p.vr;

      // æç”»
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();

      // ç”»é¢ä¸‹ã«è½ã¡åˆ‡ã£ãŸã‚‰ä¸Šã«æˆ»ã™ï¼ˆé€£ç¶šæ„Ÿï¼‰
      if(p.y - p.h > H){
        p.y = -20;
        p.x = Math.random()*W;
      }
    }

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
    if(elapsed < durationMs){
      startConfetti._rafId = requestAnimationFrame(frame);
    }else{
      // ãªã ã‚‰ã‹ã«æ¶ˆã™
      const fade = Math.min(1, (elapsed - durationMs)/600);
      ctx.fillStyle = `rgba(255,255,255,${fade})`;
      ctx.fillRect(0,0,W,H);
      if(fade < 1){
        startConfetti._rafId = requestAnimationFrame(frame);
      }else{
        stopConfetti();
      }
    }
  }
  startConfetti._rafId = requestAnimationFrame(frame);

  // å›è»¢/ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
  const onResize = ()=> {
    const scrolled = window.scrollY; // iOSã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­–ã§å†è¨ˆç®—
    const cvs2 = ensureConfettiCanvas();
    cvs2.style.top = '0px';
    // å†è¨ˆç®—ã—ãŸã®ã§W/Hã‚‚æ›´æ–°ã—ã¦OK
  };
  window.addEventListener('resize', onResize, { passive:true });

  _confettiStopTimer = setTimeout(()=>{ /* è‡ªå‹•ã‚¹ãƒˆãƒƒãƒ—ã®äºˆå‚™ */ stopConfetti(); }, durationMs + 2000);

  function stopConfetti(){
    if(!_confettiRunning) return;
    _confettiRunning = false;
    cancelAnimationFrame(startConfetti._rafId);
    clearTimeout(_confettiStopTimer);
    window.removeEventListener('resize', onResize);
    cvs.style.display = 'none';
  }
  // å¤–ã‹ã‚‰ã‚‚æ­¢ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãƒãƒ³ãƒ‰ãƒ«å…¬é–‹
  startConfetti.stop = stopConfetti;
}

/** å…¨ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆåˆ¤å®šï¼ˆskipã¯é™¤å¤–ã€‚æœªskipãŒå…¨ã¦checkedãªã‚‰ç¥ç¦ï¼‰ */
function celebrateIfCompleted(){
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆskipã§ãªã„ï¼‰é …ç›®ãŒå¯¾è±¡
  const active = items.filter(it => !it.skip);
  if(active.length === 0) return;                     // ç©ºãƒªã‚¹ãƒˆã§ã¯ç¥ç¦ã—ãªã„
  const allDone = active.every(it => it.checked === true);
  if(allDone){
    // é€£ç™ºé˜²æ­¢ï¼šã™ã§ã«èµ°ã£ã¦ãªã‘ã‚Œã°
    if(!_confettiRunning){
      startConfetti(5200);
      showToast('ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ãŠã¤ã‹ã‚Œã•ã¾ğŸ‰');
    }
  }
}


/* ========= åˆæœŸåŒ– ========= */
function init(){
  activateTab('list'); // åˆæœŸã‚¿ãƒ–
  refreshSuperSelect(); refreshSuperList(); renderList(); renderAlbum();
  window.addEventListener('load', ()=>{
    if(!window.qrcode){ console.error('qrcode-generator èª­ã¿è¾¼ã¿å¤±æ•—'); showToast('QRç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'); }
    if(!window.jsQR){ console.error('jsQR èª­ã¿è¾¼ã¿å¤±æ•—'); showToast('QRèª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'); }
  });
}
init();

/* ========= å°ç‰© ========= */
function showToast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2256;color:#fff;padding:8px 12px;border-radius:999px;opacity:0.95;z-index:9999';
  document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600);
}
function escape(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body>
</html>



