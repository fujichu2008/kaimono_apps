<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>デジタル買い物リスト</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f0f6ff; --card:#ffffff; --line:#d6e4ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --pill:#eaf2ff; --ok:#18a558; --warn:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system,"Segoe UI",Roboto,Arial}

/* Header & Tabs */
header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 0%,#f6f9ff 100%);
  border-bottom:1px solid var(--line);padding:8px 16px;z-index:10}
.brand{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand-left{display:flex;gap:12px;align-items:center}
.brand h1{font-size:20px;margin:0;color:#0b2256}
.brand-actions{display:flex;gap:6px;align-items:center}
button.btn-sm{padding:4px 8px;border-radius:8px;font-size:12px;border:1px solid var(--accent);background:var(--accent);color:#fff}
button.btn-sm.line{background:#fff;color:var(--accent)}

/* tabs */
.tabbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{position:relative;border:1px solid var(--line);background:#fff;color:#0f172a;
  padding:8px 12px;border-radius:10px 10px 0 0;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tabrow{display:flex;align-items:center;gap:8px;margin-top:-1px;border-bottom:1px solid var(--line);}

/* controls row (list-only) */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 0}
.controls.hidden{display:none}
.controls .spacer{flex:1}

select,input,button,textarea{font:inherit}
button{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.ghost{background:#fff;color:var(--accent)}
button.line{background:#fff;border-color:var(--line);color:#0f172a}
button.warn{background:var(--warn);border-color:var(--warn)}
button.ok{background:var(--ok);border-color:var(--ok)}
button.flat{border:none;background:transparent;color:var(--accent);padding:4px 8px}

/* pages */
.page{display:none;padding:16px}
.page.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{background:var(--pill);color:var(--accent-2);padding:4px 8px;border-radius:999px;font-size:12px}
input[type=text], input[type=search], select, textarea{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:0
}
ul{list-style:none;margin:0;padding:0}

/* list items */
.item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);
  border-radius:12px;padding:10px 12px;margin-bottom:8px;touch-action:pan-y}
.item .name{flex:1;min-width:0}
.item .qty{font-size:18px; font-weight:600; color:#111827}
.item.skip{background:repeating-linear-gradient(135deg,#f3f7ff 0 6px,#e6eeff 6px 12px);text-decoration:line-through}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#eef3ff;border:1px solid #dbe6ff;border-radius:6px;padding:2px 6px;font-size:12px}

/* チェック済みカード表示（薄い青） */
.item.checked{
  background:#eaf2ff;
  border-color:#d6e4ff;
  opacity:1; /* 読みやすさ維持 */
}



/* 分類プルダウン（小さめ） */
.item .cat-edit{
  font-size:12px;
  padding:2px 6px;
  margin-top:2px;
  border-radius:8px;
  height:26px;
  line-height:1.2;
}

/* ★追記：ライブスキャン動画のレイアウト安定化 */
#modalImport video{
  max-width: 100%;
  height: auto;
  display: block;
}

/* album */
.album-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:680px){
  .album-grid{ grid-template-columns:1fr 1fr; }
}
.photo-card{
  position:relative;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:row;
  align-items:stretch;
}

/* 左側サムネイル（やや小さめ） */
.photo-card .thumb-wrap{
  flex:0 0 140px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#eef3ff;
}
.photo-card img.thumb{
  width:100%;
  height:100%;
  max-height:120px;
  object-fit:cover;
  display:block;
}

/* 右側メタ情報 */
.photo-meta{
  flex:1;
  padding:10px 12px;
  border-left:1px solid var(--line);
  display:grid;
  gap:6px;
}
.photo-meta .row-top{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.photo-meta .name{
  font-weight:600;
}
.photo-meta .sub{
  font-size:12px;
  color:var(--muted);
}

/* 右上の削除ボタンは据え置き */
.photo-del{
  position:absolute;
  top:8px;
  right:8px;
  background:#fff;
  color:var(--warn);
  border:1px solid var(--warn);
  border-radius:999px;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

/* modal (above header) */
.modal{position:fixed;inset:0;background:rgba(11,16,40,.5);display:none;align-items:center;justify-content:center;padding:16px; z-index:1001;}
.modal.open{display:flex}
.sheet{background:#fff;border-radius:16px;border:1px solid var(--line);max-width:720px;width:100%;max-height:90vh;overflow:auto}
.sheet .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.sheet .body{padding:12px 14px}
.sheet .foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

@media (max-width:480px){
  .grid.cols-2{grid-template-columns:1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr}

/* スマホ幅：コントロール行を1行に収める最適化 */
.controls{
  flex-wrap: nowrap;        /* 改行させない */
  gap: 6px;                 /* 余白を少し圧縮 */
}
#superSelect{
  flex: 1 1 auto;           /* ここを伸縮役に */
  min-width: 0;             /* はみ出し抑止 */
}
.controls button,
.controls select{
  font-size: 14px;          /* 少しだけ縮小 */
}
.controls button{
  padding: 6px 8px;         /* ボタンの左右余白を圧縮 */
  border-radius: 8px;
}
#btnRecipe{
  white-space: nowrap;      /* ボタン内改行を禁止 */
  letter-spacing: 0;        /* 半角カナの詰め */
}


  /* ★追加：キャプチャモーダルのフォームをスマホ用に調整 */
  #modalCapture input,
  #modalCapture select {
    font-size:14px;
  }


}


#modalRecipe select{ min-height: 260px; }
#recipeIngredients li{ display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--line); }
#recipeIngredients li:last-child{ border-bottom:none; }
#recipeIngredients .ing-name{ flex:1; }
#recipeIngredients .ing-qty{ color:var(--muted); font-size:12px; }


/* 花吹雪キャンバス（全画面・タップ無視） */
#confettiCanvas{
  position:fixed; inset:0;
  width:100%; height:100%;
  pointer-events:none;               /* 操作を邪魔しない */
  z-index:10000;                     /* モーダルより前に出す場合は 1001〜 を様子見で調整 */
  display:none;                      /* 通常は非表示。発火時のみ表示 */
}


/* サムネ画像のはみ出し保険 */
#modalPhoto img, .photo-card img{ max-width:100%; height:auto; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-left">
      <h1>デジタル買い物リスト</h1>
    </div>
    <!-- タイトル行 右側に小型ボタン -->
    <div class="brand-actions">
      <button id="btnExport" class="btn-sm line">QRで共有</button>
      <button id="btnImport" class="btn-sm line">QR取り込み</button>
    </div>
  </div>

  <!-- タブ -->
  <div class="tabbar tabrow">
    <button class="tab active" data-tab="list">買い物リスト</button>
    <button class="tab" data-tab="market">スーパー登録</button>
    <button class="tab" data-tab="album">アルバム</button>
  </div>

  <!-- 買い物リスト用の上部コントロール（リストタブ時のみ表示） -->
  <div class="controls" id="controlsRow">
    <select id="superSelect"></select>
    <button class="line" id="btnSort">売場順</button>
    <button class="line" id="btnUnsort">解除</button>

<!-- ★追加：レシピボタン -->
<button class="line" id="btnRecipe" title="レシピ" aria-label="レシピ">ﾚｼﾋﾟ</button>

<button class="line" id="btnQuickCam" title="写真撮影" aria-label="写真撮影">📷</button>
    <span class="spacer"></span>
    <!-- ※ QRボタンは brand-actions に移動済み -->
  </div>
</header>

<main>
  <!-- 買い物リスト -->
  <section id="page-list" class="page active">
    <div class="card">
      <!-- 入力エリア：品名・個数（狭幅）・追加 が一列 -->
      <div class="row">
        <input id="inpName" type="text" placeholder="品名（例：牛乳）" style="flex:1;min-width:160px">
        <select id="selQty" style="width:68px">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
        <button id="btnAdd">追加</button>
      </div>

      <!-- 2行目：左寄せで 未購入のみ ＋ クリア（全クリア） -->
      <div class="row" style="margin-top:8px;justify-content:flex-start">
        <label class="small"><input type="checkbox" id="onlyActive"> 未購入のみ</label>
        <button class="warn" id="btnClearAll">クリア</button>
      </div>

      <!-- リスト -->
      <ul id="list" style="margin-top:10px"></ul>
    </div>
  </section>

  <!-- スーパー登録 -->
  <section id="page-market" class="page">
    <div class="card">
      <h3 style="margin:0 0 8px">スーパー登録</h3>
      <div class="row">
        <input id="superName" type="text" placeholder="スーパー名" style="flex:1">
        <button id="btnAddSuper">追加</button>
      </div>
<div class="row small" style="margin-top:6px;color:var(--muted)">
  売場順並び替え機能を使うための、スーパーの売場順登録画面です。<br>
  新規スーパー名を登録→スーパー一覧で選択→入口から奥までの売場順を入力。<br>
  デフォルトでは、よくある売り場順を自動でセットします。上下ボタンで並び変えてください。
</div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>スーパー一覧</strong>
            <button class="flat" id="btnDeleteSuper">選択削除</button>
          </div>
          <select id="superList" size="8" style="width:100%"></select>
        </div>
        <div class="card">
          <strong>売場順（入口→奥）</strong>
          <div class="row" style="margin:6px 0">
            <select id="catPick" style="flex:1"></select>
            <button id="btnShelfAdd">追加</button>
            <span class="small" style="margin-left:auto">※重複不可（追加済みは選択肢に出ません）</span>
          </div>
          <ul id="shelfOrder"></ul>
          <div class="row" style="justify-content:flex-end">
            <button class="ok" id="btnSaveShelf">保存</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- アルバム -->
  <section id="page-album" class="page">
    <div class="card">
      <div class="grid cols-3">
        <select id="albumCat">
          <option value="">分類で絞り込み</option>
        </select>
        <input id="albumText" type="search" placeholder="品名メモで絞り込み">
        <div class="row" style="justify-content:flex-end">
          <input id="albumSuperOnly" type="checkbox"><label for="albumSuperOnly" class="small">選択スーパーのみ</label>
        </div>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end;gap:8px">
        <button class="warn" id="btnAlbumDeleteAll">アルバム一括削除</button>
      </div>
      <div class="album-grid" id="albumGrid" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<!-- Export Modal -->
<div id="modalExport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRコードで共有</strong>
      <button class="flat" onclick="closeExport()">閉じる</button>
    </div>
    <div class="body">
      <div class="row small"><span class="pill">現在のリストを共有</span> 相手はカメラで読み取るか「QR取り込み」で画像から読めます。</div>
<div class="card" style="margin-top:8px;display:flex;justify-content:center">
  <div id="qrcode"></div>
</div>

<!-- ★ここに追加する -->
<div id="qrCaption" class="small" style="text-align:center;margin-top:6px;color:var(--muted)"></div>

<div id="qrError" class="small" style="color:#b91c1c;margin-top:6px;display:none"></div>

      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="compact"> 圧縮共有（品名・数量・分類のみ）</label>
        <span class="small" style="margin-left:auto;color:var(--muted)">長大リストは圧縮推奨</span>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="saveQRToPhotos()">画像保存</button>

      <button class="ok" onclick="closeExport()">OK</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="modalImport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QR取り込み</strong>
      <button class="flat" onclick="closeImport()">閉じる</button>
    </div>
    <div class="body">
      <!-- 上部2ボタン -->
      <div class="row" style="gap:8px; margin-bottom:8px;">
        <button class="line" id="btnLiveScanTop">カメラでスキャン</button>
        <button class="line" id="btnPick">ファイルを選択</button>
        <input id="qrPick" type="file" accept="image/*" style="display:none">
      </div>

      <div class="small" style="margin-top:0;color:var(--muted)">※「ファイルを選択」でスマホ内の画像アルバムから選べます。</div>
      <div class="card" style="margin-top:8px">
        <strong>読み取った品目</strong>
        <ul id="qrListPreview" style="margin-top:6px"></ul>
      </div>
    </div>
    <div class="foot" style="justify-content:flex-start">
      <button class="line" onclick="applyImport('merge')">現在のリストに追加</button>
      <button class="ok" onclick="applyImport('replace')">リストをこれに入れ替え</button>
    </div>
  </div>
</div>

<!-- Capture Modal (新規撮影→名前/分類/メモを入力) -->
<div id="modalCapture" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>写真の追加</strong>
      <button class="flat" id="btnCapCancel">キャンセル</button>
    </div>
    <div class="body">
      <img id="capPreview" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <div class="small">品名</div>
          <input id="capName" type="text" placeholder="例：牛乳">
        </div>
        <div>
          <div class="small">分類</div>
          <select id="capCategory"></select>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <div class="small">スーパー</div>
          <div id="capSuper" class="pill"></div>
        </div>
        <div>
          <div class="small">メモ</div>
          <input id="capNote" type="text" placeholder="価格・規格など">
        </div>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">
        ※ 品名入力に応じて自動分類されます（手動で変更も可能）
      </div>
    </div>
    <div class="foot">
      <button class="ok" id="btnCapSave">アルバムに保存</button>
    </div>
  </div>
</div>


<!-- Photo Modal -->
<div id="modalPhoto" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>写真</strong>
      <button class="flat" onclick="closePhoto()">閉じる</button>
    </div>
    <div class="body">
      <img id="photoLarge" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <div class="small">分類</div>
          <div id="photoCat" class="pill"></div>
        </div>
        <div>
          <div class="small">スーパー</div>
          <div id="photoSuper" class="pill"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="photoNote" rows="3" style="flex:1" placeholder="メモ（価格・規格など）"></textarea>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="deletePhoto()">削除</button>
      <button class="ok" onclick="savePhotoNote()">更新</button>
    </div>
  </div>
</div>

<!-- Recipe Modal -->
<div id="modalRecipe" class="modal" aria-hidden="true">
  <div class="sheet" style="max-width:720px">
    <div class="head">
      <strong>レシピから材料を選ぶ</strong>
      <button class="flat" onclick="closeRecipe()">閉じる</button>
    </div>
    <div class="body">
      <div class="grid cols-2">
        <div class="card">
          <div class="small" style="margin-bottom:6px">料理分類</div>
          <select id="recipeCat" size="10" style="width:100%"></select>
        </div>
        <div class="card">
          <div class="small" style="margin-bottom:6px">料理</div>
          <select id="recipeDish" size="10" style="width:100%"></select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:baseline">
          <strong>材料</strong>
          <button class="flat" id="btnRecipeToggleAll">全選択/解除</button>
        </div>
        <ul id="recipeIngredients" style="margin-top:6px"></ul>
        <div class="small" style="color:var(--muted);margin-top:6px">
          ※ 家庭に常備されがちな <span class="pill">醤油・砂糖・みりん・味噌・料理酒・サラダ油</span> は除外済み
        </div>
      </div>
    </div>
    <div class="foot" style="justify-content:flex-end">
      <button class="ok" id="btnAddSelectedIngredients">買い物リストに追加</button>
    </div>
  </div>
</div>




<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<!-- 画面をキャンバスにレンダリングして画像化するため -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ========= 定数・分類 ========= */
const CATEGORY_NAMES = [
  '野菜・果物','精肉','鮮魚・刺身','惣菜・弁当','パン','乳製品','冷凍食品',
  '豆腐・納豆・漬物','乾物','調味料・油・だし','菓子・スナック','飲料','酒類',
  '缶詰','レトルト・カレー','インスタント麺・乾麺','パスタ','粉もの',
  '日用品・雑貨','卵','米','チルト食品・生麺・練り物','その他'
];


const CAT_RULES = [
  {cat:'野菜・果物',keys:[
    'トマト','レタス','きゅうり','にんじん','人参','玉ねぎ','玉葱','じゃが','じゃがいも','馬鈴薯',
    '白菜','ほうれん草','ほうれんそう','小松菜','水菜','バナナ','りんご','林檎','みかん','いちご','ぶどう','葡萄',
    'キャベツ','きゃべつ','ネギ','ねぎ','長ねぎ','長ネギ','大根','かぶ','蕪','ブロッコリー','カリフラワー',
    'ピーマン','パプリカ','なす','茄子','しいたけ','椎茸','しめじ','えのき','榎','まいたけ','舞茸','エリンギ',
    'きのこ','もやし','さつまいも','さといも','里芋','長芋','山芋','れんこん','蓮根','ごぼう','牛蒡',
    'きぬさや','スナップえんどう','枝豆','オクラ','トウモロコシ','とうもろこし','コーン','キュウリ'
  ]},
  {cat:'精肉',keys:[
    '牛肉','豚肉','鶏肉','挽き肉','ひき肉','合い挽き','合挽き','ミンチ',
    'ささみ','ササミ','むね','ムネ','もも','モモ','バラ','ベーコン','ハム','ソーセージ',
    'ラム','マトン','レバー','砂肝','胸肉','モモ肉','肩ロース','ロース','ヒレ','サーロイン'
  ]},
  {cat:'鮮魚・刺身',keys:[
    '刺身','鮭','サーモン','サバ','鯖','アジ','鯵','イワシ','鰯','タコ','蛸','イカ','烏賊','エビ','海老',
    'しらす','ホッケ','鰤','ブリ','マグロ','鮪','カツオ','鰹','タイ','鯛','切り身','切身','開き'
  ]},
  {cat:'惣菜・弁当',keys:[
    '弁当','総菜','惣菜','唐揚げ','からあげ','コロッケ','天ぷら','サラダ','寿司','おにぎり','サンドイッチ',
    'オードブル','煮物','炒め物','惣菜パン','グラタン','ドリア'
  ]},
  {cat:'パン',keys:['パン','食パン','バゲット','ロール','クロワッサン','フランスパン','ベーグル','バターロール']},
  {cat:'乳製品',keys:['牛乳','ミルク','ヨーグルト','チーズ','バター','生クリーム','クリームチーズ','カッテージ','モッツァレラ','スキムミルク']},
  {cat:'冷凍食品',keys:['冷凍','冷食','冷凍餃子','餃子(冷凍)','チャーハン(冷凍)','ピザ(冷凍)','冷凍うどん','冷凍パスタ','冷凍野菜','アイス']},
  {cat:'豆腐・納豆・漬物',keys:['豆腐','絹','木綿','納豆','厚揚げ','油揚げ','高野豆腐','漬物','キムチ','糠漬け','ぬか漬け','浅漬け','ピクルス']},
  {cat:'乾物',keys:['海苔','のり','鰹節','かつおぶし','煮干し','干し','春雨','切り干し','干し椎茸','高野豆腐','乾燥わかめ','乾燥']},
  {cat:'調味料・油・だし',keys:[
    '塩','砂糖','味噌','みそ','醤油','しょうゆ','酢','みりん','料理酒','酒','胡椒','コショウ','こしょう',
    'だし','白だし','顆粒だし','コンソメ','ブイヨン','ごま油','サラダ油','オリーブオイル','菜種油',
    'ソース','ケチャップ','マヨネーズ','マスタード','ラー油','豆板醤','甜麺醤','味覇','創味シャンタン','スパイス','ハーブ'
  ]},
  {cat:'菓子・スナック',keys:['お菓子','菓子','スナック','ポテチ','ポテトチップス','クッキー','チョコ','チョコレート','キャンディ','ガム','グミ','せんべい','ビスケット','ラスク']},
  {cat:'飲料',keys:['水','ミネラルウォーター','お茶','緑茶','麦茶','紅茶','コーヒー','ジュース','炭酸','スポーツドリンク','牛乳飲料','ココア']},
  {cat:'酒類',keys:['ビール','発泡酒','チューハイ','酎ハイ','ワイン','日本酒','焼酎','ウイスキー','ハイボール','梅酒','リキュール']},
// 缶詰
{cat:'缶詰',keys:[
  '缶詰','ツナ','コーン缶','トマト缶','サバ缶','いわし缶','オイルサーディン','ミートソース缶','コーンクリーム缶','さば缶'
]},

// レトルト・カレー（※レトルトパスタ/カレールーもここへ）
{cat:'レトルト・カレー',keys:[
  'レトルト','レトルトカレー','レトルトパスタ','カレールー',
  'ボンカレー','ククレカレー','銀座カリー','LEE','咖喱屋カレー',
  '日清カレーメシ','ハヤシメシ','ウマーメシ'
]},

// インスタント麺・乾麺（※ そうめん/素麺 もここ）
{cat:'インスタント麺・乾麺',keys:[
  'インスタント','カップ麺','袋麺','即席麺','即席',
  'カップヌードル','カップヌードルシーフード','シーフードヌードル','カップヌードルカレー','チリトマトヌードル','欧風チーズカレー',
  '日清麺職人','麺職人','日清ラ王','ラ王','ラ王豚骨','ラ王味噌','ラ王醤油','ラ王塩','チキンラーメン',
  '日清焼そばUFO','UFO','U.F.O','日清焼そば','日清焼きそば',
  'ペヤング','ペヤングソースやきそば','獄激辛','超大盛',
  '一平ちゃん','一平ちゃん夜店の焼そば','マヨビーム',
  '明星チャルメラ','チャルメラ','明星一平ちゃん','明星中華三昧',
  '出前一丁','ごまラー油',
  'マルちゃん正麺','正麺','マルちゃん昔ながらの中華そば','マルちゃん赤いきつね','赤いきつね','緑のたぬき','ごつ盛り','バリうま',
  'やきそば弁当','焼そば弁当',
  'ニュータッチ','凄麺','凄麺横浜家系','凄麺札幌味噌','凄麺仙台辛味噌','凄麺青森煮干',
  '金ちゃんラーメン','徳島製粉',
  '辛ラーメン','辛ラミョン','ノグリ','ノグリラーメン','三養ラーメン','ブルダック','プルダック',
  '一蘭カップ','一風堂カップ','天下一品カップ','家系カップ',
  '日清どん兵衛','どん兵衛きつねうどん','どん兵衛天ぷらそば','どん兵衛肉うどん',
  'マルタイラーメン','棒ラーメン',
  '大盛りいか焼そば','日清のどん兵衛焼うどん','日清太麺焼そば',
  'ラーメン横綱カップ','蒙古タンメン中本','北極ラーメン','とみ田つけ麺','六厘舎つけ麺',
  'そうめん','素麺'
]},

// パスタ（乾麺の「パスタ」一般はここ。レトルトパスタは↑に寄せてある）
{cat:'パスタ',keys:[
  'パスタ','スパゲッティ','スパゲティ'
]},

  {cat:'日用品・雑貨',keys:[
    'ティッシュ','ボックスティッシュ','トイレット','トイレットペーパー','キッチンペーパー','洗剤','柔軟剤','食洗機用','スポンジ',
    '歯磨き','歯みがき粉','歯ブラシ','シャンプー','コンディショナー','ボディソープ','石鹸','せっけん','ラップ','アルミホイル',
    'クッキングシート','電池','乾電池','ゴミ袋','ポリ袋','マスク','ウェットティッシュ','除菌','漂白剤','カビ取り','消臭剤'
  ]},
  {cat:'卵',keys:['卵','たまご','玉子']},
  {cat:'米',keys:['米','こめ','白米','玄米','無洗米']},
 // チルト食品・生麺・練り物（チルド麺＋練り物系）
{cat:'チルト食品・生麺・練り物', keys:[
  'チルト','チルド','チルド麺','生麺','生うどん','生そば','生ラーメン','冷蔵麺','レンジ麺',
  '餃子','ぎょうざ','生餃子','チルド餃子','しゅうまい','焼売','ワンタン',
  'かまぼこ','ちくわ','はんぺん','つみれ','さつま揚げ','笹かま',
  'ちゃんぽん','ラーメン(チルド)','うどん(チルド)','そば(チルド)'
]},

// 粉もの（製菓・製パン・家庭粉類）
{cat:'粉もの', keys:[
  '小麦粉','薄力粉','強力粉','中力粉','白玉粉','上新粉','米粉','片栗粉',
  'ホットケーキミックス','パンケーキミックス',
  'お好み焼き粉','たこ焼き粉','天ぷら粉','唐揚げ粉','から揚げ粉',
  'パン粉'
]},

];

let USER_DICT = loadJSON('shopping_userdict_v1', {}); // 手動学習: 正規化名→カテゴリ
function normalize(s){ if(!s) return ''; let t=s.normalize('NFKC');
  t=t.replace(/[\uff61-\uff9f]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60)).toLowerCase();
  return t.replace(/\s+/g,' ').trim();
}
function guessCategory(name){
  const n=normalize(name);
  if(USER_DICT[n]) return USER_DICT[n]; // 最優先
  for(const r of CAT_RULES){ if(r.keys.some(k=>n.includes(normalize(k)))) return r.cat; }
  for(const c of CATEGORY_NAMES){ if(n.includes(normalize(c))) return c; }
  return 'その他';
}

/* ========= ストレージ ========= */
const LS_ITEMS='shopping_items_v1';
const LS_SUPERS='shopping_supers_v1';
const LS_USERDICT='shopping_userdict_v1';
let items = loadJSON(LS_ITEMS, []);
let supers = loadJSON(LS_SUPERS, []);

// === 一度きりの移行：旧カテゴリ名を新ルールで再分類 ===
(function migrateOldCategory(){
  const OLD = '缶詰・レトルト・インスタント麺';
  let changed = 0;

  // items の再分類
  items.forEach(it=>{
    if(it.category === OLD){
      it.category = guessCategory(it.name); // 名前から再推定（新CAT_RULESで振り分け）
      changed++;
    }
  });

  // USER_DICT（学習辞書）の再分類
  for(const [k,v] of Object.entries(USER_DICT)){
    if(v === OLD){
      USER_DICT[k] = guessCategory(k);
      changed++;
    }
  }

  if(changed){
    try{ save(); }catch(e){}
    try{ saveUserDict(); }catch(e){}
    console.log('migrated old category ->', changed);
  }
})();

// === 一度きりの移行：旧「生麺」→ 新「チルト食品・生麺・練り物」 ===
(function migrateSeimenToChilled(){
  const OLD = '生麺';
  const NEW = 'チルト食品・生麺・練り物';
  let changed = 0;

  items.forEach(it=>{
    if(it.category === OLD){
      it.category = NEW;
      changed++;
    }
  });

  for(const [k,v] of Object.entries(USER_DICT)){
    if(v === OLD){
      USER_DICT[k] = NEW;
      changed++;
    }
  }

  if(changed){
    try{ save(); }catch(e){}
    try{ saveUserDict(); }catch(e){}
    console.log('migrated 生麺 -> チルト食品・生麺・練り物 :', changed);
  }
})();


function save(){ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }
function saveSupers(){ localStorage.setItem(LS_SUPERS, JSON.stringify(supers)); }
function saveUserDict(){ localStorage.setItem(LS_USERDICT, JSON.stringify(USER_DICT)); }
function loadJSON(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; }}

/* ========= IndexedDB（アルバム） ========= */
const DB_NAME='ShoppingAlbumDB'; const DB_STORE='photos';
let db=null;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>{ const d=e.target.result; d.createObjectStore(DB_STORE,{keyPath:'id'}); };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
async function dbAdd(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).add(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbPut(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbGetAll(){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readonly'); const req=tx.objectStore(DB_STORE).getAll();
  req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });}
async function dbDelete(id){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).delete(id);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbDeleteBulk(filterFn){ await openDBIf(); const list=await dbGetAll(); const targets=list.filter(filterFn);
  for(const p of targets){ await dbDelete(p.id); } return targets.length; }
async function openDBIf(){ if(db) return; await openDB(); }

/* ========= タブ & コントロール表示制御 ========= */
const pages={ list:document.getElementById('page-list'), market:document.getElementById('page-market'), album:document.getElementById('page-album') };
const tabButtons=[...document.querySelectorAll('.tabbar .tab')];
const controlsRow=document.getElementById('controlsRow');

function activateTab(name){
  tabButtons.forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
  Object.entries(pages).forEach(([k,el])=> el.classList.toggle('active', k===name));
  controlsRow.classList.toggle('hidden', name!=='list'); // リスト時のみ表示
}
tabButtons.forEach(b=> b.onclick=()=>{ activateTab(b.dataset.tab); if(b.dataset.tab==='album') renderAlbum(); if(b.dataset.tab==='market') refreshSuperList(); });

/* ========= スーパー選択・売場順 ========= */

// デフォルト売場順（未選択/新規スーパー時に適用）
const DEFAULT_SHELF_ORDER = [
  '野菜・果物',
  '豆腐・納豆・漬物',
  'チルト食品・生麺・練り物', // ← 旧「生麺」を包含
  '卵',
  '鮮魚・刺身',
  '乾物',
  '調味料・油・だし',
  'パスタ',
  '粉もの',                 // 新規
  '缶詰',
  'レトルト・カレー',
  '精肉',
  '菓子・スナック',
  'インスタント麺・乾麺',
  '乳製品',
  '飲料',
  '冷凍食品',
  '惣菜・弁当',
  'パン',
  '酒類',                   // 「種類」は「酒類」と解釈
  '日用品・雑貨',
  '米',
  'その他'
];



const selSuper=document.getElementById('superSelect');
function refreshSuperSelect(){
  const cur=selSuper.value; selSuper.innerHTML='';
  const opt0=new Option('スーパー選択',''); opt0.disabled=false; selSuper.add(opt0);
  supers.forEach(s=> selSuper.add(new Option(s.name,s.id)) );
  selSuper.value = supers.some(s=>s.id===cur)?cur:''; // 既存選択維持
}
function shelfOrderOf(id){ const s=supers.find(x=>x.id===id); return s?.shelfOrder || []; }
document.getElementById('btnSort').onclick = () => {
  // ここではフォールバックせず、そのまま現在の売場順を渡す
  const so = shelfOrderOf(selSuper.value);
  currentViewSorted = sortByShelf(items, so);
  renderList(currentViewSorted);
};


document.getElementById('btnUnsort').onclick=()=>{ currentViewSorted=null; renderList(); };
function sortByShelf(arr, orderArr){
  // 基準順：保存されている売場順 or 既定
  let base = (orderArr && orderArr.length) ? [...orderArr] : [...DEFAULT_SHELF_ORDER];

  // 「その他」はいったん除外して最後に固定
  base = base.filter(c => c !== 'その他');

  // 売場順に無い“新しい分類”を末尾に補完（例：後から追加したカテゴリ）
  CATEGORY_NAMES.forEach(c => {
    if (c !== 'その他' && !base.includes(c)) base.push(c);
  });

  // 「その他」を最終位置に固定
  base.push('その他');

  // ランク表（小さいほど前）
  const rank = Object.fromEntries(base.map((c, i) => [c, i]));

  const a = [...arr];
  a.sort((x, y) => {
    const rx = (rank[x.category] ?? 1e9);
    const ry = (rank[y.category] ?? 1e9);
    if (rx !== ry) return rx - ry;
    // 同ランク時は作成時刻→名前で安定化
    const cx = x.createdAt || 0, cy = y.createdAt || 0;
    if (cx !== cy) return cx - cy;
    return (x.name || '').localeCompare(y.name || '');
  });
  return a;
}


/* ========= リスト：追加/表示/操作（分類は小型プルダウンのみ、変更で学習） ========= */
const ul=document.getElementById('list');
const inpName=document.getElementById('inpName'); const selQty=document.getElementById('selQty');
const onlyActive=document.getElementById('onlyActive');
document.getElementById('btnAdd').onclick=()=>{
  const name=inpName.value.trim(); if(!name) return;
  const qty=Number(selQty.value||1);
  items.push({id:crypto.randomUUID(),name,qty,category:guessCategory(name),checked:false,skip:false,createdAt:Date.now()});
  save(); inpName.value=''; renderList();
};
document.getElementById('btnClearAll').onclick=()=>{ if(confirm('全アイテムを削除しますか？')){ items=[]; save(); renderList(); } };
onlyActive.onchange=()=>renderList();

let currentViewSorted=null;
function renderList(view){
  const src = view || items;
  ul.innerHTML = '';

  src.filter(it=>{
    if(onlyActive.checked && (it.checked || it.skip)) return false;
    return true;
  }).forEach(it=>{
    // ✅ チェック状態で色を変える（.item.checked）
    const li = document.createElement('li');
    li.className = 'item' + (it.checked ? ' checked' : '');

    // 本体（チェック・名前・数量・カメラ）
    li.innerHTML = `
      <input type="checkbox" ${it.checked ? 'checked' : ''} aria-label="チェック">
      <div class="name"><div>${escapeHtml(it.name)}</div></div>
      <div class="qty">×${it.qty}</div>
      <button class="flat cam" title="撮影">📷</button>
    `;

    // ✅ チェックで保存＆再描画（色も更新）
    li.querySelector('input').onchange = (e) => {
      it.checked = e.target.checked;
      save();

      // 並べ替え中なら維持して再描画
      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
    };

    // ✅ 左スワイプで削除（確認あり）
    let sx = 0, sy = 0;
    li.addEventListener('touchstart', e => {
      sx = e.touches[0].clientX;
      sy = e.touches[0].clientY;
    }, {passive:true});
    li.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - sx;
      const dy = e.changedTouches[0].clientY - sy;
      if (Math.abs(dx) > 40 && Math.abs(dy) < 30 && dx < 0) {
        if (confirm('この項目を削除しますか？')) {
          items = items.filter(x => x.id !== it.id);
          save();
          if (currentViewSorted) {
            currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
            renderList(currentViewSorted);
          } else {
            renderList(view);
          }
        }
      }
    }, {passive:true});

    // 📷 カメラ（既存ロジックを維持）
    li.querySelector('.cam').onclick = () => startCaptureForItem(it);

    // 🔽 分類プルダウン生成（小型）
    const catSel = document.createElement('select');
    catSel.className = 'cat-edit';
    catSel.title = '分類を変更すると次回以降この品名は同じ分類に自動分類されます';
    CATEGORY_NAMES.forEach(c=>{
      catSel.add(new Option(c, c, c === it.category, c === it.category));
    });
    catSel.onchange = () => {
      it.category = catSel.value;
      USER_DICT[normalize(it.name)] = catSel.value;
      saveUserDict();
      save();

      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
    };

    // 🖊️ 品目名タップで編集→分類も再判定
    const nameEl = li.querySelector('.name > div');
    nameEl.style.cursor = 'text';
    nameEl.title = 'タップして品名を編集';
    nameEl.onclick = () => {
      const newName = prompt('品名を修正', it.name);
      if (newName == null) return;               // キャンセル
      const trimmed = newName.trim();
      if (!trimmed || trimmed === it.name) return;

      it.name = trimmed;
      it.category = guessCategory(trimmed);      // ← 再判定
      USER_DICT[normalize(trimmed)] = it.category;
      saveUserDict();
      save();

      if (currentViewSorted) {
        currentViewSorted = sortByShelf(items, shelfOrderOf(selSuper.value));
        renderList(currentViewSorted);
      } else {
        renderList(view);
      }
      showToast('名称を更新しました（分類も再判定）');
    };

    // プルダウンを名前の下に差し込む
    li.querySelector('.name').appendChild(catSel);

    ul.appendChild(li);
  });

  // ✅ ここで全コンプリート判定を呼び出す
  setTimeout(celebrateIfCompleted, 0);
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
renderList();

/* ========= カメラからアルバム追加 ========= */
const hiddenPicker=document.createElement('input'); hiddenPicker.type='file'; hiddenPicker.accept='image/*'; hiddenPicker.capture='environment'; hiddenPicker.style.display='none'; document.body.appendChild(hiddenPicker);
let captureContext=null;

// 新規撮影の下書き
let currentCaptureDraft = null;

// 入力モーダル参照
const modalCapture  = document.getElementById('modalCapture');
const capPreview    = document.getElementById('capPreview');
const capName       = document.getElementById('capName');
const capCategory   = document.getElementById('capCategory');
const capNote       = document.getElementById('capNote');
const capSuper      = document.getElementById('capSuper');
const btnCapSave    = document.getElementById('btnCapSave');
const btnCapCancel  = document.getElementById('btnCapCancel');

// 分類プルダウン初期化
function fillCapCategory(selectEl, selected){
  selectEl.innerHTML = '';
  CATEGORY_NAMES.forEach(c => selectEl.add(new Option(c, c, c===selected, c===selected)));
}

// 入力モーダルを開く
function openCaptureModal(draft){
  currentCaptureDraft = draft; // { dataUrl, supermarketId, name?, category?, note? }
  capPreview.src = draft.dataUrl;
  capName.value  = draft.name || '';
  fillCapCategory(capCategory, draft.category || (draft.name ? guessCategory(draft.name) : 'その他'));
  capNote.value  = draft.note || '';
  capSuper.textContent = superNameOf(draft.supermarketId) || '—';
  modalCapture.classList.add('open');
}

// 閉じる/クリア
function closeCaptureModal(){
  modalCapture.classList.remove('open');
  currentCaptureDraft = null;
  capPreview.src = '';
  capName.value = '';
  capNote.value = '';
}

// 品名入力に応じて自動分類（ユーザーが分類を手で触ったら上書きしない）
let capCatTouched = false;
capCategory.onchange = () => { capCatTouched = true; };
capName.addEventListener('input', () => {
  if (!capCatTouched){
    const g = guessCategory(capName.value.trim());
    fillCapCategory(capCategory, g);
  }
});
btnCapCancel.onclick = () => closeCaptureModal();

// 保存 → IndexedDB
btnCapSave.onclick = async () => {
  if(!currentCaptureDraft) return;
  const name = capName.value.trim();
  if(!name){ alert('品名を入力してください'); return; }
  const category = capCategory.value || guessCategory(name);
  const note = capNote.value.trim();

  // 学習辞書に反映（次回以降の自動分類に活きる）
  USER_DICT[normalize(name)] = category;
  saveUserDict();

  const photo = {
    id: crypto.randomUUID(),
    dataUrl: currentCaptureDraft.dataUrl,
    category,
    name,
    supermarketId: currentCaptureDraft.supermarketId || '',
    takenAt: Date.now(),
    note
  };
  await dbAdd(photo);
  closeCaptureModal();
  showToast('アルバムに保存しました');
  renderAlbum();
  capCatTouched = false;
};



function startCaptureForItem(item){
  captureContext={item, supermarketId: selSuper.value || ''};
  hiddenPicker.value=''; hiddenPicker.click();
}
hiddenPicker.onchange = async (e) => {
  const f = e.target.files[0];
  if (!f || !captureContext) return;

  const img = await fileToImage(f);
  const resized = await shrinkAndOrient(img, 1280);

  // 📷ボタンからの「フリーモード」
  if (captureContext.mode === 'free') {
    openCaptureModal({
      dataUrl: resized,
      supermarketId: captureContext.supermarketId || '',
      name: '',
      category: 'その他',
      note: ''
    });
    captureContext = null; // リセット
    return;
  }

  // 既存アイテムに紐付け（従来の動作）
  if (captureContext.item) {
    const photo = {
      id: crypto.randomUUID(),
      dataUrl: resized,
      category: captureContext.item.category,
      name: captureContext.item.name,
      supermarketId: captureContext.supermarketId || '',
      takenAt: Date.now(),
      note: ''
    };
    await dbAdd(photo);
    renderAlbum();
    showToast('アルバムに保存しました');
    captureContext = null;
  }
};

function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{URL.revokeObjectURL(url); res(img)}; img.onerror=rej; img.src=url; });}
async function shrinkAndOrient(img, maxSide){
  const r= Math.min(1, maxSide/Math.max(img.width,img.height));
  const w=Math.round(img.width*r), h=Math.round(img.height*r);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return cvs.toDataURL('image/jpeg',0.85);
}

/* ========= アルバム ========= */
const albumCat=document.getElementById('albumCat'); const albumText=document.getElementById('albumText'); const albumSuperOnly=document.getElementById('albumSuperOnly');
CATEGORY_NAMES.forEach(c=> albumCat.add(new Option(c,c)) );
albumCat.onchange=renderAlbum; albumText.oninput=renderAlbum; albumSuperOnly.onchange=renderAlbum;

const albumGrid=document.getElementById('albumGrid'); let albumCache=[];
async function renderAlbum(){
  albumGrid.innerHTML='';
  albumCache = await dbGetAll();
  const cat=albumCat.value; const q=normalize(albumText.value); const superId=albumSuperOnly.checked?selSuper.value:'';
  albumCache.filter(p=>{
    if(cat && p.category!==cat) return false;
    if(superId && p.supermarketId!==superId) return false;
    if(q && !(normalize(p.name).includes(q) || normalize(p.note||'').includes(q))) return false;
    return true;
  }).sort((a,b)=>b.takenAt-a.takenAt)
  .forEach(p=>{
    const card = document.createElement('div');
    card.className = 'photo-card';
    card.tabIndex = 0;

    const superNameTxt = superNameOf(p.supermarketId) || '—';

    card.innerHTML = `
      <button class="photo-del" title="削除">削除</button>
      <div class="thumb-wrap">
        <img class="thumb" src="${p.dataUrl}" alt="">
      </div>
      <div class="photo-meta">
        <div class="row-top">
          <span class="tag">${escapeHtml(p.category)}</span>
          <span class="name">${escapeHtml(p.name)}</span>
        </div>
        <div class="sub">スーパー：${escapeHtml(superNameTxt)}</div>
        <div class="sub">${fmtDate(p.takenAt)}</div>
      </div>
    `;

    card.querySelector('img.thumb').onclick = (ev) => {
      ev.stopPropagation();
      openPhoto(p);
    };

    card.querySelector('.photo-del').onclick = async (ev) => {
      ev.stopPropagation();
      if (!confirm('この写真を削除しますか？')) return;
      await dbDelete(p.id);
      showToast('削除しました');
      renderAlbum();
    };

    albumGrid.appendChild(card);
  });

}
function fmtDate(t){ const d=new Date(t); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function superNameOf(id){ return supers.find(s=>s.id===id)?.name || ''; }
const modalPhoto=document.getElementById('modalPhoto');
let currentPhoto=null;
function openPhoto(p){ currentPhoto=p; document.getElementById('photoLarge').src=p.dataUrl;
  document.getElementById('photoCat').textContent=p.category; document.getElementById('photoSuper').textContent=superNameOf(p.supermarketId)||'—';
  document.getElementById('photoNote').value=p.note||''; modalPhoto.classList.add('open'); }
function closePhoto(){ modalPhoto.classList.remove('open'); currentPhoto=null; }
async function savePhotoNote(){ if(!currentPhoto) return; currentPhoto.note=document.getElementById('photoNote').value; await dbPut(currentPhoto); showToast('メモを更新しました'); closePhoto(); renderAlbum(); }
async function deletePhoto(){ if(!currentPhoto) return; if(!confirm('この写真を削除しますか？')) return; await dbDelete(currentPhoto.id); closePhoto(); renderAlbum(); showToast('削除しました'); }

/* 一括削除 */
document.getElementById('btnAlbumDeleteAll').onclick=async ()=>{
  if(!confirm('アルバム内のすべての写真を削除しますか？')) return;
  const n = await dbDeleteBulk(()=>true);
  showToast(`削除：${n}件`); renderAlbum();
};

/* ========= スーパー登録画面（売場順：選択済みを除外） ========= */
const superName=document.getElementById('superName'); const btnAddSuper=document.getElementById('btnAddSuper');
const superList=document.getElementById('superList'); const catPick=document.getElementById('catPick'); const shelfOrderUL=document.getElementById('shelfOrder');
const btnShelfAdd=document.getElementById('btnShelfAdd'); const btnSaveShelf=document.getElementById('btnSaveShelf'); const btnDeleteSuper=document.getElementById('btnDeleteSuper');

btnAddSuper.onclick = () => {
  const name = superName.value.trim(); if(!name) return;
  supers.push({
    id: crypto.randomUUID(),
    name,
    shelfOrder: [...DEFAULT_SHELF_ORDER],  // ここで既定を適用
    updatedAt: Date.now()
  });
  superName.value='';
  saveSupers(); refreshSuperList(); refreshSuperSelect();
  showToast('追加しました（売場順は既定で登録）');
};

btnDeleteSuper.onclick=()=>{ const id=superList.value; if(!id) return; if(!confirm('選択スーパーを削除しますか？')) return;
  supers=supers.filter(s=>s.id!==id); saveSupers(); refreshSuperList(); refreshSuperSelect(); };

function refreshSuperList(){
  superList.innerHTML=''; supers.forEach(s=> superList.add(new Option(s.name,s.id)) );
  renderShelfOrder(superList.value);
}
superList.onchange=()=>renderShelfOrder(superList.value);

function refreshCatPickOptions(used){
  catPick.innerHTML='';
  const remaining = CATEGORY_NAMES.filter(c=> !used.includes(c));
  remaining.forEach(c=> catPick.add(new Option(c,c)));
  if(!remaining.length) catPick.add(new Option('（全て追加済み）',''));
}
function renderShelfOrder(id){
  shelfOrderUL.innerHTML='';
  const soSource = shelfOrderOf(id);
  const so = (soSource && soSource.length) ? soSource : [...DEFAULT_SHELF_ORDER]; // 追加
  refreshCatPickOptions(so); // 使用済みを選択肢から除外

  so.forEach((c,idx)=>{
    const li=document.createElement('li'); li.className='item'; li.innerHTML=`
      <div class="name">${escapeHtml(c)}</div>
      <div class="row">
        <button class="line up">↑</button>
        <button class="line dn">↓</button>
        <button class="line rm">削除</button>
      </div>`;
    li.querySelector('.up').onclick=()=>{ if(idx>0){ [so[idx-1],so[idx]]=[so[idx],so[idx-1]]; renderShelfOrder(id);} };
    li.querySelector('.dn').onclick=()=>{ if(idx<so.length-1){ [so[idx+1],so[idx]]=[so[idx],so[idx+1]]; renderShelfOrder(id);} };
    li.querySelector('.rm').onclick=()=>{ so.splice(idx,1); renderShelfOrder(id); }; // 削除で候補復活
    shelfOrderUL.appendChild(li);
  });
}
btnShelfAdd.onclick=()=>{ const id=superList.value; if(!id) return; const c=catPick.value; if(!c) return;
  const s=supers.find(x=>x.id===id); if(!s.shelfOrder.includes(c)) s.shelfOrder.push(c); renderShelfOrder(id); };
btnSaveShelf.onclick=()=>{ const id=superList.value; if(!id) return; const s=supers.find(x=>x.id===id); s.updatedAt=Date.now(); saveSupers(); refreshSuperSelect(); showToast('売場順を保存しました'); };

/* ========= QR共有（qrcode-generator） ========= */
const modalExport=document.getElementById('modalExport'); const modalImport=document.getElementById('modalImport');
document.getElementById('btnExport').onclick=()=>openExport(); document.getElementById('btnImport').onclick=()=>openImport();
const compact=document.getElementById('compact');

function makePayload(isCompact){
  const data={type:'shopping-list',v:1,exportedAt:Date.now(),
    items: isCompact? items.map(({name,qty,category})=>({name,qty,category})) : items
  };
  return JSON.stringify(data);
}
function payloadBytes(str){ return new Blob([str]).size; }
function validatePayloadSize(str){
  const bytes = payloadBytes(str);
  if (bytes > 2950) { showToast(`サイズ大（${bytes}B）。分割QRや圧縮を推奨`); }
}
function renderQRCodeInto(box, text){
  // UTF-8 対応
  if (window.qrcode && qrcode.stringToBytesFuncs) {
    qrcode.stringToBytes = qrcode.stringToBytesFuncs['UTF-8'];
  }
  const qr = qrcode(0, 'M');
  qr.addData(text);
  qr.make();

  // キャンバス寸法：QR本体 + 下にラベル領域（約48px）
  const qrSize = 256;
  const labelH = 48;
  const size = qrSize + labelH;
  const cell = Math.floor(qrSize / qr.getModuleCount());
  const margin = Math.floor((qrSize - cell * qr.getModuleCount()) / 2);

  const cvs = document.createElement('canvas');
  cvs.width = cvs.height = size;
  const ctx = cvs.getContext('2d');

  // 背景
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, size, size);

  // QR本体
  ctx.fillStyle = '#000';
  for(let r=0; r<qr.getModuleCount(); r++){
    for(let c=0; c<qr.getModuleCount(); c++){
      if(qr.isDark(r,c)){
        ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
  }

  // 生成日時（QR下にセンタリングして描画）
  const now = new Date();
  const label = `生成: ${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  ctx.fillStyle = '#111';
  ctx.font = '14px system-ui, -apple-system, "Segoe UI", Roboto, Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(label, size/2, qrSize + (labelH/2));

  // 置換
  box.innerHTML = '';
  box.appendChild(cvs);

  // 画面上のキャプションにも表示（UI用）
  const cap = document.getElementById('qrCaption');
  if (cap) cap.textContent = label;
}

function openExport(){
  modalExport.classList.add('open');
  const box = document.getElementById('qrcode');
  const err = document.getElementById('qrError');
  err.style.display='none';
  box.innerHTML='';

  try{
    const payload = makePayload(compact.checked);
    validatePayloadSize(payload);
    // ← 日時付きでQRを再描画（関数内でUIキャプションと画像ラベルの両方を更新）
    renderQRCodeInto(box, payload);
  }catch(e){
    console.error(e);
    err.textContent = 'QR生成に失敗しました：' + (e?.message||e);
    err.style.display='block';
  }
}

// ★QRキャンバスのみを画像化して保存（共有シート→写真保存／非対応はDL）
async function saveQRToPhotos(){
  const cvs = document.querySelector('#qrcode canvas');
  if(!cvs){ alert('QRが見つかりません'); return; }

  // Blob化
  const blob = await new Promise(res => cvs.toBlob(res, 'image/png', 1.0));
  if(!blob){ alert('画像の作成に失敗しました'); return; }
  const file = new File([blob], 'shopping_qr.png', { type: 'image/png' });

  // Web Share API Level 2（モバイルの共有シート → 写真に保存）
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try{
      await navigator.share({
        files: [file],
        title: '買い物リスト QR',
        text: 'QRコード（生成日時付き）'
      });
      showToast('共有シートを開きました（写真に保存できます）');
      return;
    }catch(e){
      // ユーザーキャンセル等は握りつぶしてフォールバックへ
      console.warn(e);
    }
  }

  // フォールバック：ダウンロード（PC/非対応ブラウザ）
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'shopping_qr.png';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  showToast('画像をダウンロードしました');
}



function closeExport(){ modalExport.classList.remove('open'); }
function downloadQR(){
  const box=document.getElementById('qrcode'); const cvs=box.querySelector('canvas');
  if(!cvs) return alert('QRが見つかりません'); const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='shopping_qr.png'; a.click();
}

// ★スクリーン（表示中の範囲のみ）を画像化 → 共有/保存
async function captureScreenToPhotos(){
  try{
    const scale = 2; // 解像度アップ
    const vx = Math.floor(window.scrollX);
    const vy = Math.floor(window.scrollY);
    const vw = Math.floor(window.innerWidth);
    const vh = Math.floor(window.innerHeight);

    // html2canvas の x,y,width,height オプションでビューポートを厳密トリミング
    const canvas = await html2canvas(document.documentElement, {
      scale,
      // レンダリング時のウィンドウ状態
      windowWidth:  document.documentElement.scrollWidth, // ページ全体幅
      windowHeight: document.documentElement.scrollHeight, // ページ全体高
      scrollX: vx,
      scrollY: vy,
      // ←ここで切り出し範囲をビューポートに限定
      x: vx,
      y: vy,
      width:  vw,
      height: vh,
      useCORS: true,
      backgroundColor: '#ffffff'
    });

    // PNG Blob 作成
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1.0));
    if(!blob){ alert('画像の作成に失敗しました'); return; }
    const file = new File([blob], 'shopping_screenshot.png', { type: 'image/png' });

    // Web Share API (iOS/Android) → 写真に保存 へ誘導
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: '買い物リスト スクリーンショット',
        text: '画面に見えている範囲のみ'
      });
      showToast('共有シートを開きました（写真に保存できます）');
      return;
    }

    // フォールバック：ダウンロード
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'shopping_screenshot.png';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showToast('画像をダウンロードしました');
  }catch(e){
    console.error(e);
    alert('スクリーンショットの保存に失敗しました');
  }
}

/* ========= QR取り込み：UI/動作 ========= */
function openImport(){
  modalImport.classList.add('open');
  document.getElementById('qrPick').value='';
  setListPreview([]); importData=null;
}
function closeImport(){ modalImport.classList.remove('open'); }
document.getElementById('btnPick').addEventListener('click', ()=>{
  document.getElementById('qrPick').click();
});
document.getElementById('qrPick').onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=await fileToImage(f); const {data,w,h}=await imageToRGBA(img);
  const code = jsQR(data, w, h);
  if(!code){ alert('QRコードが見つかりません'); return; }
  try{
    const obj=JSON.parse(code.data);
    if(obj.type!=='shopping-list') throw 0;
    importData=obj;
    setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
  }catch{ alert('形式が正しくありません'); }
};
function setListPreview(arr){
  const ul = document.getElementById('qrListPreview');
  ul.innerHTML = '';
  if(!arr || !arr.length){ const li=document.createElement('li'); li.className='small'; li.textContent='読み取り結果はここに表示されます。'; ul.appendChild(li); return; }
  arr.forEach(it=>{ const li=document.createElement('li'); li.textContent = `${(it.name||'').toString()} × ${Number(it.qty||1)}`; ul.appendChild(li); });
}
let importData=null;
async function imageToRGBA(img){
  const maxSide = 1024, scale = Math.min(1, maxSide/Math.max(img.width,img.height));
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(img,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h); return {data:id.data, w, h};
}
function applyImport(mode){
  if(!importData){ alert('先にQRを読み込んでください'); return; }
  const incoming=(importData.items||[]).map(normalizeIncoming);
  if(mode==='replace'){ items=incoming; }
  else{
    const keyOf=it=>`${it.name}__${it.category||''}__${it.qty||1}`.toLowerCase();
    const map=new Map(items.map(it=>[keyOf(it),it])); for(const it of incoming){ if(!map.has(keyOf(it))) map.set(keyOf(it),it); }
    items=Array.from(map.values());
  }
  save(); renderList(); closeImport();
}
function normalizeIncoming(it){ return { id:crypto.randomUUID(), name:it.name||'', qty:Number(it.qty||1),
  category: it.category || guessCategory(it.name||''), checked:false, skip:false, createdAt:Date.now() }; }

/* HTTPS/ローカル確認 */
function verifySecureContext(){
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if(!isSecure){
    showToast('カメラ使用にはHTTPSまたはlocalhostが必要です');
    return false;
  }
  return true;
}

/* ライブスキャン（カメラ） */
let stream = null, scanRAF = null;
const liveCanvas = document.createElement('canvas');
const liveCtx = liveCanvas.getContext('2d', { willReadFrequently: true });
const liveVideo = document.createElement('video');
let scanning = false;

document.getElementById('btnLiveScanTop').addEventListener('click', async ()=>{
  if (scanning) return;
  if (!verifySecureContext()) return;

  scanning = true;

  try{
    liveVideo.setAttribute('playsinline','');
    liveVideo.setAttribute('autoplay','');
    liveVideo.muted = true;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } , width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
  }catch(e){
    console.error(e);
    showToast('カメラが使用できません（権限/HTTPSを確認）');
    scanning = false;
    return;
  }

  const body = document.querySelector('#modalImport .body');
  const wrap = document.createElement('div');
  wrap.className = 'card';
  wrap.style.cssText = 'margin-top:8px;display:flex;justify-content:center;align-items:center;padding:8px;';
  liveVideo.style.maxWidth = '100%';
  liveVideo.style.width = '100%';
  liveVideo.style.height = 'auto';
  wrap.appendChild(liveVideo);
  body.appendChild(wrap);

  liveVideo.srcObject = stream;
  try { await liveVideo.play(); } catch(e){ console.warn(e); }

  const scan = ()=>{
    if(!liveVideo.videoWidth){
      scanRAF = requestAnimationFrame(scan);
      return;
    }
    const vw = liveVideo.videoWidth, vh = liveVideo.videoHeight;
    const scale = Math.min(1, 1024 / Math.max(vw, vh));
    liveCanvas.width  = Math.round(vw * scale);
    liveCanvas.height = Math.round(vh * scale);

    const ctx = liveCtx;
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(liveVideo, 0, 0, liveCanvas.width, liveCanvas.height);

    const id = ctx.getImageData(0, 0, liveCanvas.width, liveCanvas.height);
    const code = jsQR(id.data, liveCanvas.width, liveCanvas.height, { inversionAttempts: 'attemptBoth' });

    if(code && code.data){
      if (scanRAF){ cancelAnimationFrame(scanRAF); scanRAF = null; }
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      liveVideo.srcObject = null;
      wrap.remove();
      scanning = false;

      try{
        const obj = JSON.parse(code.data);
        if(obj.type !== 'shopping-list') throw 0;
        importData = obj;
        setListPreview((obj.items||[]).map(x=>({name:x.name, qty:x.qty||1})));
        showToast('QRを検出しました');
      }catch{
        showToast('形式が正しくありません');
      }
      return;
    }
    scanRAF = requestAnimationFrame(scan);
  };
  scan();
});

const _origCloseImport = closeImport;
closeImport = function(){
  if (scanRAF){ cancelAnimationFrame(scanRAF); scanRAF = null; }
  if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  scanning = false;

  const body = document.querySelector('#modalImport .body');
  [...body.querySelectorAll('video')].forEach(v=> v.parentElement?.remove());
  _origCloseImport();
};


/* ========= レシピ機能 ========= */

// 常備調味料（除外対象）
const PANTRY_SET = new Set(['醤油','しょうゆ','砂糖','みりん','味噌','料理酒','サラダ油']);

// レシピデータ：{ カテゴリ: { 料理名: [ {name, qty?}, ... ] } }
// ※ 分量は目安。必要に応じて後で調整可能。
// ※ 常備調味料は最初から含めない設計にしています。
const RECIPES = {
  'ご飯もの・麺': {
    'カレーライス':        [{name:'玉ねぎ'},{name:'にんじん'},{name:'じゃがいも'},{name:'カレールー'},{name:'豚こま切れ'},{name:'ご飯'}],
    'オムライス':          [{name:'卵'},{name:'鶏もも肉'},{name:'玉ねぎ'},{name:'ご飯'},{name:'ケチャップ'}],
    '牛丼':                [{name:'牛こま肉'},{name:'玉ねぎ'},{name:'めんつゆ'},{name:'ご飯'}],
    '親子丼':              [{name:'鶏もも肉'},{name:'玉ねぎ'},{name:'卵'},{name:'めんつゆ'},{name:'ご飯'}],
    'カツ丼':              [{name:'豚ロース（とんかつ用）'},{name:'卵'},{name:'玉ねぎ'},{name:'パン粉'},{name:'小麦粉'},{name:'めんつゆ'},{name:'ご飯'}],
    '天丼':                [{name:'海老'},{name:'いか'},{name:'さつまいも'},{name:'なす'},{name:'天ぷら粉'},{name:'めんつゆ'},{name:'ご飯'}],
    '中華丼':              [{name:'豚こま肉'},{name:'白菜'},{name:'にんじん'},{name:'しいたけ'},{name:'うずら卵(茹で)'},{name:'中華スープの素'},{name:'片栗粉'},{name:'ご飯'}],
    'ちらし寿司':          [{name:'寿司酢'},{name:'錦糸卵用の卵'},{name:'きゅうり'},{name:'刺身盛り合わせ'},{name:'海苔'},{name:'ご飯'}],
    '手巻き寿司':          [{name:'刺身盛り合わせ'},{name:'きゅうり'},{name:'大葉'},{name:'寿司酢'},{name:'焼のり'},{name:'ご飯'}],
    'お茶漬け':            [{name:'お茶漬けの素'},{name:'梅干し'},{name:'焼のり'},{name:'ご飯'}],
    'いなり寿司':          [{name:'味付けいなり揚げ'},{name:'寿司酢'},{name:'白ごま'},{name:'ご飯'}],
    '焼きそば':            [{name:'焼きそば麺'},{name:'豚こま肉'},{name:'キャベツ'},{name:'もやし'},{name:'焼きそばソース'}],
    '肉うどん':            [{name:'うどん'},{name:'牛こま肉'},{name:'長ねぎ'},{name:'めんつゆ'}],
  },

  '魚料理': {
    '焼き鮭':              [{name:'生鮭切り身'}],
    'サバの味噌煮':        [{name:'サバ切り身'},{name:'しょうが'}], // 味噌は常備扱いで除外
    'サンマの塩焼き':      [{name:'生さんま'},{name:'大根'}],
    '煮魚（カレイなど）':  [{name:'カレイ切り身'},{name:'しょうが'}],
    'ブリの照り焼き':      [{name:'ブリ切り身'}],
    'アジの南蛮漬け':      [{name:'アジ'},{name:'玉ねぎ'},{name:'にんじん'},{name:'ピーマン'},{name:'南蛮漬けの素'}],
    'イワシの梅煮':        [{name:'いわし'},{name:'梅干し'},{name:'しょうが'}],
    '鮭のムニエル':        [{name:'生鮭切り身'},{name:'小麦粉'},{name:'バター'}],
    'ホッケの開き':        [{name:'ホッケ開き'}],
    '鯖の塩焼き':          [{name:'サバ切り身'}],
  },

  '肉料理': {
    '豚の生姜焼き':        [{name:'豚ロース薄切り'},{name:'しょうが'},{name:'玉ねぎ'}],
    '鶏の唐揚げ':          [{name:'鶏もも肉'},{name:'にんにく'},{name:'しょうが'},{name:'片栗粉'}],
    '鶏の照り焼き':        [{name:'鶏もも肉'}],
    '鶏肉と野菜の炒め物':  [{name:'鶏もも肉'},{name:'ピーマン'},{name:'にんじん'},{name:'玉ねぎ'}],
    'ハンバーグ':          [{name:'合い挽き肉'},{name:'玉ねぎ'},{name:'卵'},{name:'パン粉'},{name:'牛乳'}],
    '肉じゃが':            [{name:'牛こま肉'},{name:'じゃがいも'},{name:'玉ねぎ'},{name:'にんじん'}],
    '豚カツ':              [{name:'豚ロース（とんかつ用）'},{name:'パン粉'},{name:'小麦粉'},{name:'卵'}],
    'チキンカツ':          [{name:'鶏むね肉'},{name:'パン粉'},{name:'小麦粉'},{name:'卵'}],
    'メンチカツ':          [{name:'合い挽き肉'},{name:'玉ねぎ'},{name:'パン粉'},{name:'小麦粉'},{name:'卵'}],
    'ロールキャベツ':      [{name:'合い挽き肉'},{name:'キャベツ'},{name:'玉ねぎ'},{name:'パン粉'},{name:'卵'},{name:'コンソメ'}],
    '焼き鳥（家庭用グリル）':[ {name:'鶏もも肉'},{name:'長ねぎ'},{name:'竹串'} ],
    '豚肉の角煮':          [{name:'豚バラブロック'},{name:'しょうが'},{name:'長ねぎ（青い部分）'},{name:'ゆで卵'}],
    '牛肉のしぐれ煮':      [{name:'牛こま肉'},{name:'しょうが'}],
    '肉野菜炒め':          [{name:'豚こま肉'},{name:'キャベツ'},{name:'にんじん'},{name:'もやし'}],
    '鶏そぼろ':            [{name:'鶏ひき肉'},{name:'しょうが'},{name:'卵'}],
  },

  '卵料理': {
    '卵焼き':              [{name:'卵'}],
    'だし巻き卵':          [{name:'卵'},{name:'白だし'}],
    '目玉焼き':            [{name:'卵'}],
    'スクランブルエッグ':  [{name:'卵'},{name:'牛乳'},{name:'バター'}],
    '茶碗蒸し':            [{name:'卵'},{name:'白だし'},{name:'鶏もも肉'},{name:'しいたけ'}],
    'オムレツ（洋風）':    [{name:'卵'},{name:'ハム'},{name:'玉ねぎ'},{name:'チーズ'}],
    '親子煮':              [{name:'鶏もも肉'},{name:'卵'},{name:'玉ねぎ'},{name:'めんつゆ'}],
    '半熟煮卵':            [{name:'卵'}],
  },

  '野菜・豆腐料理': {
    '野菜炒め':            [{name:'キャベツ'},{name:'にんじん'},{name:'もやし'},{name:'ピーマン'}],
    'きんぴらごぼう':      [{name:'ごぼう'},{name:'にんじん'},{name:'白ごま'}],
    'ひじきの煮物':        [{name:'乾燥ひじき'},{name:'にんじん'},{name:'油揚げ'}],
    '切り干し大根の煮物':  [{name:'切り干し大根'},{name:'にんじん'},{name:'油揚げ'}],
    '筑前煮':              [{name:'鶏もも肉'},{name:'ごぼう'},{name:'れんこん'},{name:'にんじん'},{name:'しいたけ'},{name:'こんにゃく'}],
    '煮しめ':              [{name:'れんこん'},{name:'ごぼう'},{name:'にんじん'},{name:'里いも'},{name:'こんにゃく'},{name:'しいたけ'}],
    'ポテトサラダ':        [{name:'じゃがいも'},{name:'きゅうり'},{name:'玉ねぎ'},{name:'ハム'},{name:'マヨネーズ'}],
    'マカロニサラダ':      [{name:'マカロニ'},{name:'きゅうり'},{name:'にんじん'},{name:'ハム'},{name:'マヨネーズ'}],
    '冷ややっこ':          [{name:'絹ごし豆腐'},{name:'ねぎ'}],
    '湯豆腐':              [{name:'絹ごし豆腐'},{name:'昆布'}],
    '揚げ出し豆腐':        [{name:'木綿豆腐'},{name:'片栗粉'},{name:'大根'}],
    '麻婆豆腐（クックドゥー）':[ {name:'麻婆豆腐の素'},{name:'木綿豆腐'} ],
    '野菜の天ぷら':        [{name:'天ぷら粉'},{name:'なす'},{name:'さつまいも'},{name:'ピーマン'},{name:'しそ'}],
    'ゴーヤチャンプルー':  [{name:'ゴーヤ'},{name:'木綿豆腐'},{name:'卵'},{name:'豚こま肉'}],
    'ナスの味噌炒め':      [{name:'なす'},{name:'豚こま肉'}], // 味噌は除外
    'ほうれん草のおひたし':[ {name:'ほうれん草'},{name:'かつおぶし'} ],
  },

  '汁物': {
    '豚汁':                [{name:'豚こま肉'},{name:'里いも'},{name:'にんじん'},{name:'大根'},{name:'ごぼう'},{name:'長ねぎ'}], // 味噌は除外
    'けんちん汁':          [{name:'大根'},{name:'にんじん'},{name:'ごぼう'},{name:'里いも'},{name:'こんにゃく'},{name:'長ねぎ'}],
    'お吸い物':            [{name:'三つ葉'},{name:'昆布'},{name:'かまぼこ'}],
    'コーンスープ':        [{name:'コーンクリーム缶'},{name:'牛乳'},{name:'コンソメ'}],
    'ポタージュ':          [{name:'じゃがいも'},{name:'玉ねぎ'},{name:'牛乳'},{name:'コンソメ'}],
    'ミネストローネ':      [{name:'ベーコン'},{name:'玉ねぎ'},{name:'にんじん'},{name:'セロリ'},{name:'トマト缶'},{name:'コンソメ'}],
    '中華スープ（卵入り）':[ {name:'中華スープの素'},{name:'卵'},{name:'長ねぎ'} ],
  },

  '洋風料理': {
    'グラタン':            [{name:'マカロニ'},{name:'玉ねぎ'},{name:'しめじ'},{name:'ベーコン'},{name:'ホワイトソース缶'},{name:'ピザ用チーズ'}],
    'ドリア':              [{name:'ご飯'},{name:'ホワイトソース缶'},{name:'ピザ用チーズ'},{name:'ベーコン'},{name:'玉ねぎ'}],
    'ビーフシチュー':      [{name:'シチュールー'},{name:'牛角切り肉'},{name:'玉ねぎ'},{name:'にんじん'},{name:'じゃがいも'}],
    'クリームシチュー':    [{name:'シチュールー'},{name:'鶏もも肉'},{name:'玉ねぎ'},{name:'にんじん'},{name:'じゃがいも'},{name:'ブロッコリー'}],
    'ローストチキン':      [{name:'鶏もも肉（骨付き）'},{name:'にんにく'},{name:'ローズマリー'}],
    'ステーキ':            [{name:'牛ステーキ用肉'},{name:'にんにく'},{name:'バター'}],
    'ピザ（手作り）':      [{name:'強力粉'},{name:'ドライイースト'},{name:'トマトソース'},{name:'ピザ用チーズ'},{name:'ベーコン'},{name:'ピーマン'}],
    'サンドイッチ':        [{name:'食パン'},{name:'ハム'},{name:'レタス'},{name:'きゅうり'},{name:'卵'},{name:'マヨネーズ'}],
    'ミートソーススパゲッティ':[ {name:'スパゲッティ'},{name:'合い挽き肉'},{name:'玉ねぎ'},{name:'トマト缶'},{name:'にんにく'},{name:'コンソメ'} ],
    'ナポリタン':          [{name:'スパゲッティ'},{name:'玉ねぎ'},{name:'ピーマン'},{name:'ウインナー'},{name:'ケチャップ'}],
    'ペペロンチーノ':      [{name:'スパゲッティ'},{name:'にんにく'},{name:'唐辛子'},{name:'オリーブオイル'}],
    'カルボナーラ':        [{name:'スパゲッティ'},{name:'ベーコン'},{name:'卵'},{name:'粉チーズ'},{name:'黒こしょう'}],
  },

  'その他定番': {
    '餃子':                [{name:'餃子の皮'},{name:'豚ひき肉'},{name:'キャベツ'},{name:'にら'},{name:'にんにく'},{name:'しょうが'}],
    '春巻き':              [{name:'春巻きの皮'},{name:'豚こま肉'},{name:'たけのこ水煮'},{name:'にんじん'},{name:'しいたけ'},{name:'春雨'}],
    'お好み焼き':          [{name:'お好み焼き粉'},{name:'卵'},{name:'キャベツ'},{name:'豚バラ薄切り'}],
    'たこ焼き':            [{name:'たこ焼き粉'},{name:'茹でだこ'},{name:'青ねぎ'},{name:'天かす'},{name:'紅しょうが'}],
    'おでん':              [{name:'おでんの素'},{name:'大根'},{name:'卵'},{name:'こんにゃく'},{name:'ちくわ'},{name:'さつま揚げ'}],
  }
};

/* === 追加：レシピ拡張（RECIPES の直後に貼り付け） === */

// 卵料理：タイ風玉子焼き
RECIPES['卵料理']['タイ風玉子焼き'] = [
  {name:'卵'},
  {name:'ナンプラー'},
  {name:'青ねぎ'},
  {name:'パクチー'},
  {name:'赤玉ねぎ'},
  {name:'ライム'}
];

// 洋風料理：タンドリーチキン
RECIPES['洋風料理']['タンドリーチキン'] = [
  {name:'鶏もも肉'},
  {name:'プレーンヨーグルト'},
  {name:'カレー粉'},
  {name:'にんにく'},
  {name:'しょうが'},
  {name:'レモン'}
];

// 肉料理：チャーシュー
RECIPES['肉料理']['チャーシュー'] = [
  {name:'豚バラブロック'},
  {name:'しょうが'},
  {name:'長ねぎ（青い部分）'}
];

// ★新カテゴリ：鍋
RECIPES['鍋'] = {
  'すき焼き': [
    {name:'牛薄切り肉'},
    {name:'白菜'},
    {name:'長ねぎ'},
    {name:'春菊'},
    {name:'木綿豆腐'},
    {name:'しらたき'},
    {name:'えのき'},
    {name:'すき焼きの割り下'}
  ],
  'もつ鍋': [
    {name:'牛もつ（下処理済み）'},
    {name:'キャベツ'},
    {name:'にら'},
    {name:'にんにく'},
    {name:'鷹の爪'},
    {name:'鍋つゆ（もつ鍋用）'}
  ],
  '水炊き': [
    {name:'鶏もも肉'},
    {name:'白菜'},
    {name:'長ねぎ'},
    {name:'木綿豆腐'},
    {name:'しめじ'},
    {name:'昆布'}
  ],
  'しゃぶしゃぶ': [
    {name:'牛しゃぶ用肉'},
    {name:'白菜'},
    {name:'長ねぎ'},
    {name:'春菊'},
    {name:'木綿豆腐'},
    {name:'しらたき'},
    {name:'昆布'}
  ],
  '海鮮鍋': [
    {name:'たら切り身'},
    {name:'えび'},
    {name:'ほたて'},
    {name:'白菜'},
    {name:'長ねぎ'},
    {name:'木綿豆腐'},
    {name:'しめじ'},
    {name:'鍋つゆ（寄せ鍋用）'}
  ]
};


// 洋風料理：アクアパッツァ
RECIPES['洋風料理']['アクアパッツァ'] = [
  {name:'白身魚（鯛など）切り身'},
  {name:'あさり'},
  {name:'プチトマト'},
  {name:'ブラックオリーブ'},
  {name:'にんにく'},
  {name:'白ワイン'},
  {name:'イタリアンパセリ'}
];



// モーダル参照
const modalRecipe = document.getElementById('modalRecipe');
const recipeCat = document.getElementById('recipeCat');
const recipeDish = document.getElementById('recipeDish');
const recipeIngredients = document.getElementById('recipeIngredients');

// レシピボタン開く
document.getElementById('btnRecipe').onclick = openRecipe;

// 📷クイック撮影（レシピ横のボタン）
document.getElementById('btnQuickCam').onclick = () => {
  // 現在選択中のスーパーIDをコンテキストに
  captureContext = { mode: 'free', supermarketId: selSuper.value || '' };
  hiddenPicker.value = '';
  hiddenPicker.click(); // 端末カメラ起動（環境カメラ）
};


function openRecipe(){
  // 分類リスト作成
  recipeCat.innerHTML = '';
  Object.keys(RECIPES).forEach(cat => {
    const opt = new Option(cat, cat);
    recipeCat.add(opt);
  });
  // 先頭のカテゴリを選択
  if (recipeCat.options.length) recipeCat.selectedIndex = 0;
  // 料理リスト描画
  renderRecipeDishes();
  // 先頭料理の材料描画
  renderRecipeIngredients();
  modalRecipe.classList.add('open');
}
function closeRecipe(){ modalRecipe.classList.remove('open'); }

// カテゴリ変更で料理一覧を更新
recipeCat.onchange = renderRecipeDishes;
function renderRecipeDishes(){
  const cat = recipeCat.value;
  recipeDish.innerHTML = '';
  if(!cat) return;
  Object.keys(RECIPES[cat]).forEach(name=>{
    recipeDish.add(new Option(name, name));
  });
  if (recipeDish.options.length) recipeDish.selectedIndex = 0;
  renderRecipeIngredients();
}

// 料理変更で材料更新
recipeDish.onchange = renderRecipeIngredients;

function renderRecipeIngredients(){
  const cat = recipeCat.value;
  const dish = recipeDish.value;
  recipeIngredients.innerHTML = '';
  if(!cat || !dish) return;

  // 常備調味料除外
  const base = (RECIPES[cat][dish] || []).filter(it => !PANTRY_SET.has(it.name));

  for(const ing of base){
    const li = document.createElement('li');
    const id = crypto.randomUUID();
    li.innerHTML = `
      <input type="checkbox" id="${id}" checked>
      <label class="ing-name" for="${id}">${escapeHtml(ing.name)}</label>
      ${ing.qty ? `<span class="ing-qty">× ${escapeHtml(String(ing.qty))}</span>` : ''}
    `;
    recipeIngredients.appendChild(li);
  }
}

// 全選択/解除
document.getElementById('btnRecipeToggleAll').onclick = ()=>{
  const boxes = recipeIngredients.querySelectorAll('input[type="checkbox"]');
  const allChecked = Array.from(boxes).every(b=>b.checked);
  boxes.forEach(b=> b.checked = !allChecked);
};

// 選択材料を買い物リストに追加（重複は追加しない）
document.getElementById('btnAddSelectedIngredients').onclick = ()=>{
  const sel = Array.from(recipeIngredients.querySelectorAll('input[type="checkbox"]:checked'));
  if(!sel.length){ showToast('材料が選択されていません'); return; }

  const names = sel.map(b => b.nextElementSibling.textContent.trim()).filter(Boolean);

  // 既存チェック用（品名＋カテゴリで近似重複回避だが、まずは品名ベース）
  const existing = new Set(items.map(it => normalize(it.name)));

  let added = 0;
  for(const name of names){
    const n = normalize(name);
    if(existing.has(n)) continue; // すでにある
    const cat = guessCategory(name);
    items.push({
      id: crypto.randomUUID(),
      name,
      qty: 1,
      category: cat,
      checked: false,
      skip: false,
      createdAt: Date.now()
    });
    existing.add(n);
    added++;
  }

  if(added>0){ save(); renderList(); showToast(`追加：${added}件`); }
  else{ showToast('すでに全てリストにあります'); }
  closeRecipe();
};


/* ========= コンプリート祝福：花吹雪 ========= */
let _confettiRunning = false;
let _confettiStopTimer = null;

/** （必要なら）キャンバスを用意して返す */
function ensureConfettiCanvas(){
  let cvs = document.getElementById('confettiCanvas');
  if(!cvs){
    cvs = document.createElement('canvas');
    cvs.id = 'confettiCanvas';
    document.body.appendChild(cvs);
  }
  // サイズを毎回合わせる（回転時/アドレスバー縮み対策）
  cvs.width  = window.innerWidth  * (window.devicePixelRatio || 1);
  cvs.height = window.innerHeight * (window.devicePixelRatio || 1);
  return cvs;
}

/** 花吹雪本体（簡易・依存なし） */
function startConfetti(durationMs = 5000){
  if(_confettiRunning) return;
  const cvs = ensureConfettiCanvas();
  const ctx = cvs.getContext('2d');

  const dpr = window.devicePixelRatio || 1;
  const W = cvs.width, H = cvs.height;

  // パーティクル生成
  const N = Math.min(220, Math.max(120, Math.floor((W/dpr) * 0.25))); // 画面幅に応じて
  const colors = ['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6','#F59E0B','#10B981','#3B82F6'];
  const parts = Array.from({length:N}, (_,i)=>({
    x: Math.random()*W,
    y: -Math.random()*H*0.5,
    w: 6 + Math.random()*8,
    h: 10 + Math.random()*12,
    vy: 1.5 + Math.random()*2.5,
    vx: -1 + Math.random()*2,
    rot: Math.random()*Math.PI*2,
    vr: (-0.15 + Math.random()*0.3),
    color: colors[i % colors.length],
    tilt: Math.random()*Math.PI*2,
    vt: 0.05 + Math.random()*0.05
  }));

  cvs.style.display = 'block';
  _confettiRunning = true;

  const t0 = performance.now();
  cancelAnimationFrame(startConfetti._rafId);

  function frame(t){
    const elapsed = t - t0;
    ctx.clearRect(0,0,W,H);

    for(const p of parts){
      // ふわふわ横揺れ
      p.tilt += p.vt;
      p.x += p.vx + Math.sin(p.tilt)*0.6;
      p.y += p.vy;
      p.rot += p.vr;

      // 描画
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();

      // 画面下に落ち切ったら上に戻す（連続感）
      if(p.y - p.h > H){
        p.y = -20;
        p.x = Math.random()*W;
      }
    }

    // フェードアウト制御
    if(elapsed < durationMs){
      startConfetti._rafId = requestAnimationFrame(frame);
    }else{
      // なだらかに消す
      const fade = Math.min(1, (elapsed - durationMs)/600);
      ctx.fillStyle = `rgba(255,255,255,${fade})`;
      ctx.fillRect(0,0,W,H);
      if(fade < 1){
        startConfetti._rafId = requestAnimationFrame(frame);
      }else{
        stopConfetti();
      }
    }
  }
  startConfetti._rafId = requestAnimationFrame(frame);

  // 回転/リサイズ対応
  const onResize = ()=> {
    const scrolled = window.scrollY; // iOSアドレスバー対策で再計算
    const cvs2 = ensureConfettiCanvas();
    cvs2.style.top = '0px';
    // 再計算したのでW/Hも更新してOK
  };
  window.addEventListener('resize', onResize, { passive:true });

  _confettiStopTimer = setTimeout(()=>{ /* 自動ストップの予備 */ stopConfetti(); }, durationMs + 2000);

  function stopConfetti(){
    if(!_confettiRunning) return;
    _confettiRunning = false;
    cancelAnimationFrame(startConfetti._rafId);
    clearTimeout(_confettiStopTimer);
    window.removeEventListener('resize', onResize);
    cvs.style.display = 'none';
  }
  // 外からも止められるようにハンドル公開
  startConfetti.stop = stopConfetti;
}

/** 全コンプリート判定（skipは除外。未skipが全てcheckedなら祝福） */
function celebrateIfCompleted(){
  // アクティブ（skipでない）項目が対象
  const active = items.filter(it => !it.skip);
  if(active.length === 0) return;                     // 空リストでは祝福しない
  const allDone = active.every(it => it.checked === true);
  if(allDone){
    // 連発防止：すでに走ってなければ
    if(!_confettiRunning){
      startConfetti(5200);
      showToast('コンプリート！おつかれさま🎉');
    }
  }
}


/* ========= 初期化 ========= */
function init(){
  activateTab('list'); // 初期タブ
  refreshSuperSelect(); refreshSuperList(); renderList(); renderAlbum();
  window.addEventListener('load', ()=>{
    if(!window.qrcode){ console.error('qrcode-generator 読み込み失敗'); showToast('QR生成ライブラリの読み込みに失敗'); }
    if(!window.jsQR){ console.error('jsQR 読み込み失敗'); showToast('QR読み取りライブラリの読み込みに失敗'); }
  });
}
init();

/* ========= 小物 ========= */
function showToast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2256;color:#fff;padding:8px 12px;border-radius:999px;opacity:0.95;z-index:9999';
  document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600);
}
function escape(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body>
</html>



