<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>è²·ã„ç‰©ãƒªã‚¹ãƒˆï¼ˆä¸€ä½“å‹ï¼‰</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f0f6ff; --card:#ffffff; --line:#d6e4ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --pill:#eaf2ff; --ok:#18a558; --warn:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 0%,#f6f9ff 100%);
  border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
.brand{display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
.brand h1{font-size:20px;margin:0;color:#0b2256}
.brand .supsel{margin-left:auto;display:flex;gap:8px;align-items:center}
select,input,button,textarea{font:inherit}
button{border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.ghost{background:#fff;color:var(--accent)}
button.line{background:#fff;border-color:var(--line);color:#0f172a}
button.warn{background:var(--warn);border-color:var(--warn)}
button.ok{background:var(--ok);border-color:var(--ok)}
button.flat{border:none;background:transparent;color:var(--accent);padding:4px 8px}
.tabbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tabbar button{border:1px solid var(--line);background:#fff;color:#0f172a}
.tabbar button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.page{display:none;padding:16px}
.page.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{background:var(--pill);color:var(--accent-2);padding:4px 8px;border-radius:999px;font-size:12px}
input[type=text], input[type=search], select, textarea{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:0
}
ul{list-style:none;margin:0;padding:0}
.item{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--line);
  border-radius:12px;padding:10px 12px;margin-bottom:8px;touch-action:pan-y}
.item .name{flex:1;min-width:0}
.item .cat{font-size:12px;color:var(--muted)}
.item .qty{font-size:12px;color:#334155}
.item.skip{background:repeating-linear-gradient(135deg,#f3f7ff 0 6px,#e6eeff 6px 12px);text-decoration:line-through}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#eef3ff;border:1px solid #dbe6ff;border-radius:6px;padding:2px 6px;font-size:12px}

/* album cards */
.album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.photo-card{position:relative;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.photo-card img{width:100%;aspect-ratio:4/3;object-fit:cover;display:block;background:#eef3ff}
.photo-meta{padding:8px 10px;border-top:1px solid var(--line);display:grid;gap:4px}
.small{font-size:12px;color:var(--muted)}
.tag{display:inline-block;background:var(--pill);color:var(--accent-2);border-radius:999px;padding:2px 8px;font-size:12px}

/* per-card delete button */
.photo-del{ position:absolute; top:8px; right:8px; background:#fff; color:var(--warn); border:1px solid var(--warn);
  border-radius:999px; padding:4px 8px; font-size:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.08); }

/* modal */
.modal{position:fixed;inset:0;background:rgba(11,16,40,.5);display:none;align-items:center;justify-content:center;padding:16px}
.modal.open{display:flex}
.sheet{background:#fff;border-radius:16px;border:1px solid var(--line);max-width:720px;width:100%;max-height:90vh;overflow:auto}
.sheet .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
.sheet .body{padding:12px 14px}
.sheet .foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

hr.sep{border:none;border-top:1px dashed var(--line);margin:8px 0}

/* responsive tweaks */
@media (max-width:480px){
  .grid.cols-2{grid-template-columns:1fr}
  .grid.cols-3{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h1>
    <div class="supsel">
      <select id="superSelect"></select>
      <button class="line" id="btnSort">å£²å ´é †</button>
      <button class="line" id="btnUnsort">è§£é™¤</button>
    </div>
  </div>
  <div class="tabbar">
    <button class="active" data-tab="list">ãƒªã‚¹ãƒˆ</button>
    <button data-tab="market">ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ²</button>
    <button data-tab="album">ã‚¢ãƒ«ãƒãƒ </button>
    <span style="flex:1"></span>
    <button id="btnExport" class="ghost">QRã§å…±æœ‰</button>
    <button id="btnImport" class="ghost">QRå–ã‚Šè¾¼ã¿</button>
  </div>
</header>

<main>
  <!-- ãƒªã‚¹ãƒˆ -->
  <section id="page-list" class="page active">
    <div class="card">
      <div class="grid cols-3">
        <input id="inpName" type="text" placeholder="å“åï¼ˆä¾‹ï¼šç‰›ä¹³ï¼‰">
        <select id="selQty">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
        <button id="btnAdd">è¿½åŠ </button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="search" type="search" placeholder="æ¤œç´¢â€¦ï¼ˆæœªè³¼å…¥ã®ã¿ã¯å³ã®ãƒã‚§ãƒƒã‚¯ï¼‰" style="flex:1">
        <label class="small"><input type="checkbox" id="onlyActive"> æœªè³¼å…¥ã®ã¿</label>
        <button class="line" id="btnClearActive">æœªè³¼å…¥ã‚¯ãƒªã‚¢</button>
        <button class="warn" id="btnClearAll">å…¨ã‚¯ãƒªã‚¢</button>
      </div>
      <ul id="list" style="margin-top:10px"></ul>
    </div>
  </section>

  <!-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ² -->
  <section id="page-market" class="page">
    <div class="card">
      <h3 style="margin:0 0 8px">ã‚¹ãƒ¼ãƒ‘ãƒ¼ç™»éŒ²</h3>
      <div class="row">
        <input id="superName" type="text" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼å" style="flex:1">
        <button id="btnAddSuper">è¿½åŠ </button>
      </div>
      <div class="row small" style="margin-top:6px;color:var(--muted)">
        å·¦ã®ä¸€è¦§ã‹ã‚‰é¸æŠ â†’ å³ã§å£²å ´é †ï¼ˆå…¥å£â†’å¥¥ï¼‰ã‚’æ§‹æˆã€‚ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§ä¸¦ã³æ›¿ãˆã€å‰Šé™¤ã§é™¤å¤–ã€‚
      </div>
      <div class="grid cols-2" style="margin-top:12px">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>ã‚¹ãƒ¼ãƒ‘ãƒ¼ä¸€è¦§</strong>
            <button class="flat" id="btnDeleteSuper">é¸æŠå‰Šé™¤</button>
          </div>
          <select id="superList" size="8" style="width:100%"></select>
        </div>
        <div class="card">
          <strong>å£²å ´é †ï¼ˆå…¥å£â†’å¥¥ï¼‰</strong>
          <div class="row" style="margin:6px 0">
            <select id="catPick" style="flex:1"></select>
            <button id="btnShelfAdd">è¿½åŠ </button>
            <span class="small" style="margin-left:auto">â€»é‡è¤‡å¯ï¼ä½•åº¦ã§ã‚‚ä¸¦ã³æ›¿ãˆå¯</span>
          </div>
          <ul id="shelfOrder"></ul>
          <div class="row" style="justify-content:flex-end">
            <button class="ok" id="btnSaveShelf">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ã‚¢ãƒ«ãƒãƒ  -->
  <section id="page-album" class="page">
    <div class="card">
      <div class="grid cols-3">
        <select id="albumCat">
          <option value="">åˆ†é¡ã§çµã‚Šè¾¼ã¿</option>
        </select>
        <input id="albumText" type="search" placeholder="å“åãƒ¡ãƒ¢ã§çµã‚Šè¾¼ã¿">
        <div class="row" style="justify-content:flex-end">
          <input id="albumSuperOnly" type="checkbox"><label for="albumSuperOnly" class="small">é¸æŠã‚¹ãƒ¼ãƒ‘ãƒ¼ã®ã¿</label>
        </div>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end;gap:8px">
        <button class="warn" id="btnAlbumDeleteAll">ã‚¢ãƒ«ãƒãƒ ä¸€æ‹¬å‰Šé™¤</button>
      </div>
      <div class="album-grid" id="albumGrid" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<!-- Export Modal -->
<div id="modalExport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰</strong>
      <button class="flat" onclick="closeExport()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <div class="row small"><span class="pill">ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚’å…±æœ‰</span> ç›¸æ‰‹ã¯ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚‹ã‹ã€ŒQRå–ã‚Šè¾¼ã¿ã€ã§ç”»åƒã‹ã‚‰èª­ã‚ã¾ã™ã€‚</div>
      <div class="card" style="margin-top:8px;display:flex;justify-content:center"><div id="qrcode"></div></div>
      <div id="qrError" class="small" style="color:#b91c1c;margin-top:6px;display:none"></div>
      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="compact"> åœ§ç¸®å…±æœ‰ï¼ˆå“åãƒ»æ•°é‡ãƒ»åˆ†é¡ã®ã¿ï¼‰</label>
        <span class="small" style="margin-left:auto;color:var(--muted)">é•·å¤§ãƒªã‚¹ãƒˆã¯åœ§ç¸®æ¨å¥¨</span>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="downloadQR()">ç”»åƒä¿å­˜</button>
      <button class="ok" onclick="closeExport()">OK</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div id="modalImport" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>QRå–ã‚Šè¾¼ã¿</strong>
      <button class="flat" onclick="closeImport()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <input id="qrPick" type="file" accept="image/*" capture="environment">
      <div class="small" style="margin-top:6px;color:var(--muted)">ã‚¹ã‚¯ã‚·ãƒ§ã‚„å†™çœŸã‹ã‚‰èª­ã¿å–ã‚Œã¾ã™ã€‚</div>
      <pre id="qrPreview" class="card" style="white-space:pre-wrap;max-height:180px;overflow:auto;margin-top:8px"></pre>
    </div>
    <div class="foot">
      <button class="line" onclick="applyImport('merge')">ãƒãƒ¼ã‚¸</button>
      <button class="ok" onclick="applyImport('replace')">ç½®æ›</button>
      <button class="line" id="btnLiveScan">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</button>
    </div>
  </div>
</div>

<!-- Photo Modal -->
<div id="modalPhoto" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <strong>å†™çœŸ</strong>
      <button class="flat" onclick="closePhoto()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="body">
      <img id="photoLarge" src="" alt="" style="width:100%;border-radius:10px;background:#eef3ff">
      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <div class="small">åˆ†é¡</div>
          <div id="photoCat" class="pill"></div>
        </div>
        <div>
          <div class="small">ã‚¹ãƒ¼ãƒ‘ãƒ¼</div>
          <div id="photoSuper" class="pill"></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="photoNote" rows="3" style="flex:1" placeholder="ãƒ¡ãƒ¢ï¼ˆä¾¡æ ¼ãƒ»è¦æ ¼ãªã©ï¼‰"></textarea>
      </div>
    </div>
    <div class="foot">
      <button class="line" onclick="deletePhoto()">å‰Šé™¤</button>
      <button class="ok" onclick="savePhotoNote()">æ›´æ–°</button>
    </div>
  </div>
</div>

<!-- libs -->
<!-- ç”Ÿæˆï¼šqrcode-generatorï¼ˆUTF-8å¯¾å¿œ & è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<!-- èª­å–ï¼šjsQR -->
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/* ========= å®šæ•°ãƒ»åˆ†é¡ ========= */
const CATEGORY_NAMES = [
 'é‡èœãƒ»æœç‰©','ç²¾è‚‰','é®®é­šãƒ»åˆºèº«','æƒ£èœãƒ»å¼å½“','ãƒ‘ãƒ³','ä¹³è£½å“','å†·å‡é£Ÿå“',
 'è±†è…ãƒ»ç´è±†ãƒ»æ¼¬ç‰©','ä¹¾ç‰©','èª¿å‘³æ–™ãƒ»æ²¹ãƒ»ã ã—','è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯','é£²æ–™','é…’é¡',
 'ç¼¶è©°ãƒ»ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéºº','æ—¥ç”¨å“ãƒ»é›‘è²¨','åµ','ç±³','ç”Ÿéºº','ãã®ä»–'
];
const CAT_RULES = [
  {cat:'é‡èœãƒ»æœç‰©',keys:['ãƒˆãƒãƒˆ','ãƒ¬ã‚¿ã‚¹','ãã‚…ã†ã‚Š','ã«ã‚“ã˜ã‚“','ç‰ã­ã','ã˜ã‚ƒãŒ','ç™½èœ','ã»ã†ã‚Œã‚“è‰','ãƒãƒŠãƒŠ','ã‚Šã‚“ã”','ã¿ã‹ã‚“','ã„ã¡ã”','ã¶ã©ã†']},
  {cat:'ç²¾è‚‰',keys:['ç‰›','è±š','é¶','ã²ãè‚‰','ã‚‚ã‚‚','ã‚€ã­','ãƒãƒ©','ãƒ™ãƒ¼ã‚³ãƒ³','ãƒãƒ ','ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸']},
  {cat:'é®®é­šãƒ»åˆºèº«',keys:['åˆºèº«','é®­','ã‚µãƒ¼ãƒ¢ãƒ³','ã‚µãƒ','ã‚¢ã‚¸','ã‚¤ãƒ¯ã‚·','ã‚¿ã‚³','ã‚¤ã‚«','ã‚¨ãƒ“','ã—ã‚‰ã™','åˆ‡ã‚Šèº«']},
  {cat:'æƒ£èœãƒ»å¼å½“',keys:['å¼å½“','ç·èœ','æƒ£èœ','å”æšã’','ã‚³ãƒ­ãƒƒã‚±','å¤©ã·ã‚‰','ã‚µãƒ©ãƒ€','å¯¿å¸','ãŠã«ãã‚Š','ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ']},
  {cat:'ãƒ‘ãƒ³',keys:['ãƒ‘ãƒ³','é£Ÿãƒ‘ãƒ³','ãƒã‚²ãƒƒãƒˆ','ãƒ­ãƒ¼ãƒ«','ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³']},
  {cat:'ä¹³è£½å“',keys:['ç‰›ä¹³','ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ','ãƒãƒ¼ã‚º','ãƒã‚¿ãƒ¼','ç”Ÿã‚¯ãƒªãƒ¼ãƒ ']},
  {cat:'å†·å‡é£Ÿå“',keys:['å†·å‡','å†·é£Ÿ','é¤ƒå­(å†·å‡)','ãƒãƒ£ãƒ¼ãƒãƒ³(å†·å‡)','ãƒ”ã‚¶(å†·å‡)']},
  {cat:'è±†è…ãƒ»ç´è±†ãƒ»æ¼¬ç‰©',keys:['è±†è…','ç´è±†','åšæšã’','æ²¹æšã’','æ¼¬ç‰©','ã‚­ãƒ ãƒ','ç³ æ¼¬ã‘']},
  {cat:'ä¹¾ç‰©',keys:['æµ·è‹”','ã®ã‚Š','é°¹ç¯€','ç…®å¹²ã—','å¹²ã—','æ˜¥é›¨','åˆ‡ã‚Šå¹²ã—','é«˜é‡è±†è…','ä¹¾ç‡¥']},
  {cat:'èª¿å‘³æ–™ãƒ»æ²¹ãƒ»ã ã—',keys:['å¡©','ç ‚ç³–','å‘³å™Œ','ã¿ã','é†¤æ²¹','ã—ã‚‡ã†ã‚†','é…¢','ã¿ã‚Šã‚“','æ–™ç†é…’','èƒ¡æ¤’','ã‚³ã‚·ãƒ§ã‚¦','ã ã—','ç™½ã ã—','ã‚³ãƒ³ã‚½ãƒ¡','ã”ã¾æ²¹','ã‚µãƒ©ãƒ€æ²¹','ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«','ã‚½ãƒ¼ã‚¹','ã‚±ãƒãƒ£ãƒƒãƒ—','ãƒãƒ¨ãƒãƒ¼ã‚º','ã‚¹ãƒ‘ã‚¤ã‚¹']},
  {cat:'è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯',keys:['ãŠè“å­','è“å­','ã‚¹ãƒŠãƒƒã‚¯','ãƒãƒ†ãƒ','ã‚¯ãƒƒã‚­ãƒ¼','ãƒãƒ§ã‚³','ã‚­ãƒ£ãƒ³ãƒ‡ã‚£','ã‚¬ãƒ ']},
  {cat:'é£²æ–™',keys:['æ°´','ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼','ãŠèŒ¶','ç·‘èŒ¶','éº¦èŒ¶','ç´…èŒ¶','ã‚³ãƒ¼ãƒ’ãƒ¼','ã‚¸ãƒ¥ãƒ¼ã‚¹','ç‚­é…¸']},
  {cat:'é…’é¡',keys:['ãƒ“ãƒ¼ãƒ«','ç™ºæ³¡é…’','ãƒãƒ¥ãƒ¼ãƒã‚¤','ãƒ¯ã‚¤ãƒ³','æ—¥æœ¬é…’','ç„¼é…','ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼','ãƒã‚¤ãƒœãƒ¼ãƒ«']},
  {cat:'ç¼¶è©°ãƒ»ãƒ¬ãƒˆãƒ«ãƒˆãƒ»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆéºº',keys:['ç¼¶è©°','ãƒ„ãƒŠ','ã‚³ãƒ¼ãƒ³ç¼¶','ãƒ¬ãƒˆãƒ«ãƒˆ','ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆ','ã‚«ãƒƒãƒ—éºº','è¢‹éºº']},
  {cat:'æ—¥ç”¨å“ãƒ»é›‘è²¨',keys:['ãƒ†ã‚£ãƒƒã‚·ãƒ¥','ãƒˆã‚¤ãƒ¬ãƒƒãƒˆ','ã‚­ãƒƒãƒãƒ³ãƒšãƒ¼ãƒ‘ãƒ¼','æ´—å‰¤','ã‚¹ãƒãƒ³ã‚¸','æ­¯ç£¨ã','æ­¯ãƒ–ãƒ©ã‚·','ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼','ãƒœãƒ‡ã‚£ã‚½ãƒ¼ãƒ—','ãƒ©ãƒƒãƒ—','ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«','é›»æ± ','ã‚´ãƒŸè¢‹']},
  {cat:'åµ',keys:['åµ','ãŸã¾ã”']},
  {cat:'ç±³',keys:['ç±³','ã“ã‚','ç™½ç±³','ç„ç±³']},
  {cat:'ç”Ÿéºº',keys:['ç”Ÿéºº','ç”Ÿãƒ‘ã‚¹ã‚¿','ç”Ÿã†ã©ã‚“','ç”Ÿãã°','ç”Ÿãƒ©ãƒ¼ãƒ¡ãƒ³']},
];
let USER_DICT = {};
function normalize(s){ if(!s) return ''; let t=s.normalize('NFKC');
  t=t.replace(/[\uff61-\uff9f]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60)).toLowerCase();
  return t.replace(/\s+/g,' ').trim();
}
function guessCategory(name){
  const n=normalize(name);
  if(USER_DICT[n]) return USER_DICT[n];
  for(const r of CAT_RULES){ if(r.keys.some(k=>n.includes(normalize(k)))) return r.cat; }
  for(const c of CATEGORY_NAMES){ if(n.includes(normalize(c))) return c; }
  return 'ãã®ä»–';
}

/* ========= ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ========= */
const LS_ITEMS='shopping_items_v1';
const LS_SUPERS='shopping_supers_v1';
const LS_USERDICT='shopping_userdict_v1';
let items = loadJSON(LS_ITEMS, []);
let supers = loadJSON(LS_SUPERS, []);
USER_DICT = loadJSON(LS_USERDICT, {});
function save(){ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }
function saveSupers(){ localStorage.setItem(LS_SUPERS, JSON.stringify(supers)); }
function saveUserDict(){ localStorage.setItem(LS_USERDICT, JSON.stringify(USER_DICT)); }
function loadJSON(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; }}

/* ========= IndexedDBï¼ˆã‚¢ãƒ«ãƒãƒ ï¼‰ ========= */
const DB_NAME='ShoppingAlbumDB'; const DB_STORE='photos';
let db=null;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>{ const d=e.target.result; d.createObjectStore(DB_STORE,{keyPath:'id'}); };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
async function dbAdd(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).add(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbPut(photo){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(photo);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbGetAll(){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readonly'); const req=tx.objectStore(DB_STORE).getAll();
  req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });}
async function dbDelete(id){ await openDBIf(); return new Promise((res,rej)=>{ const tx=db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).delete(id);
  tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function dbDeleteBulk(filterFn){ await openDBIf(); const list=await dbGetAll(); const targets=list.filter(filterFn);
  for(const p of targets){ await dbDelete(p.id); } return targets.length; }
async function openDBIf(){ if(db) return; await openDB(); }

/* ========= UIè¦ç´  ========= */
const tabButtons=[...document.querySelectorAll('.tabbar button[data-tab]')];
const pages={ list:document.getElementById('page-list'), market:document.getElementById('page-market'), album:document.getElementById('page-album') };
tabButtons.forEach(b=>b.onclick=()=>{ tabButtons.forEach(x=>x.classList.remove('active')); b.classList.add('active');
  Object.values(pages).forEach(p=>p.classList.remove('active')); pages[b.dataset.tab].classList.add('active');
  if(b.dataset.tab==='album') renderAlbum(); if(b.dataset.tab==='market') refreshSuperList();
});

/* ========= ã‚¹ãƒ¼ãƒ‘ãƒ¼é¸æŠãƒ»å£²å ´é † ========= */
const selSuper=document.getElementById('superSelect');
function refreshSuperSelect(){
  const cur=selSuper.value; selSuper.innerHTML='';
  const opt0=new Option('ã‚¹ãƒ¼ãƒ‘ãƒ¼é¸æŠ','');
  opt0.disabled=false;
  selSuper.add(opt0);
  supers.forEach(s=> selSuper.add(new Option(s.name,s.id)) );
  selSuper.value = supers.some(s=>s.id===cur)?cur:'';
}
function shelfOrderOf(id){ const s=supers.find(x=>x.id===id); return s?.shelfOrder || []; }
document.getElementById('btnSort').onclick=()=>{ const so=shelfOrderOf(selSuper.value);
  currentViewSorted = sortByShelf(items, so);
  renderList(currentViewSorted);
};
document.getElementById('btnUnsort').onclick=()=>{ currentViewSorted=null; renderList(); };
function sortByShelf(arr, orderArr){
  const order=Object.fromEntries(orderArr.map((c,i)=>[c,i+1])); // æœªçŸ¥ã¯0â†’å…ˆé ­
  const rank=cat=> (cat in order)?order[cat]:0;
  const a=[...arr]; a.sort((x,y)=> rank(x.category)-rank(y.category)); return a;
}

/* ========= ãƒªã‚¹ãƒˆï¼šè¿½åŠ /è¡¨ç¤º/æ“ä½œ ========= */
const ul=document.getElementById('list');
const inpName=document.getElementById('inpName'); const selQty=document.getElementById('selQty');
const onlyActive=document.getElementById('onlyActive'); const search=document.getElementById('search');
document.getElementById('btnAdd').onclick=()=>{
  const name=inpName.value.trim(); if(!name) return;
  const qty=Number(selQty.value||1);
  items.push({id:crypto.randomUUID(),name,qty,category:guessCategory(name),checked:false,skip:false,createdAt:Date.now()});
  save(); inpName.value=''; renderList();
};
document.getElementById('btnClearActive').onclick=()=>{ items=items.filter(x=>x.checked||x.skip); save(); renderList(); };
document.getElementById('btnClearAll').onclick=()=>{ if(confirm('å…¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ items=[]; save(); renderList(); } };
search.oninput=()=>renderList(); onlyActive.onchange=()=>renderList();

let currentViewSorted=null;
function renderList(view){
  const src = view || items;
  const q=normalize(search.value);
  ul.innerHTML='';
  src.filter(it=>{
    if(onlyActive.checked && (it.checked||it.skip)) return false;
    if(q && !normalize(it.name).includes(q)) return false;
    return true;
  }).forEach(it=>{
    const li=document.createElement('li'); li.className='item'+(it.skip?' skip':'');
    li.innerHTML=`
      <input type="checkbox" ${it.checked?'checked':''} aria-label="ãƒã‚§ãƒƒã‚¯">
      <div class="name"><div>${escapeHtml(it.name)}</div>
        <div class="cat">${escapeHtml(it.category||'ãã®ä»–')}</div></div>
      <div class="qty">Ã—${it.qty}</div>
      <button class="flat cam" title="æ’®å½±">ğŸ“·</button>
    `;
    li.querySelector('input').onchange=(e)=>{ it.checked=e.target.checked; save(); };
    let sx=0, sy=0; li.addEventListener('touchstart',e=>{ sx=e.touches[0].clientX; sy=e.touches[0].clientY;},{passive:true});
    li.addEventListener('touchend',e=>{
      const dx=e.changedTouches[0].clientX-sx, dy=e.changedTouches[0].clientY-sy;
      if(Math.abs(dx)>40 && Math.abs(dy)<30 && dx<0){ it.skip=!it.skip; save(); renderList(view); }
    },{passive:true});
    li.querySelector('.cam').onclick=()=>startCaptureForItem(it);
    ul.appendChild(li);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
renderList();

/* ========= ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã‚¢ãƒ«ãƒãƒ è¿½åŠ  ========= */
const hiddenPicker=document.createElement('input'); hiddenPicker.type='file'; hiddenPicker.accept='image/*'; hiddenPicker.capture='environment'; hiddenPicker.style.display='none'; document.body.appendChild(hiddenPicker);
let captureContext=null;
function startCaptureForItem(item){
  captureContext={item, supermarketId: selSuper.value || ''};
  hiddenPicker.value=''; hiddenPicker.click();
}
hiddenPicker.onchange=async (e)=>{
  const f=e.target.files[0]; if(!f||!captureContext) return;
  const img=await fileToImage(f);
  const resized=await shrinkAndOrient(img,1280);
  const photo={ id:crypto.randomUUID(), dataUrl:resized, category:captureContext.item.category,
    name:captureContext.item.name, supermarketId:captureContext.supermarketId, takenAt:Date.now(), note:'' };
  await dbAdd(photo); renderAlbum(); showToast('ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã¾ã—ãŸ');
};
function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>{URL.revokeObjectURL(url); res(img)}; img.onerror=rej; img.src=url; });}
async function shrinkAndOrient(img, maxSide){
  const r= Math.min(1, maxSide/Math.max(img.width,img.height));
  const w=Math.round(img.width*r), h=Math.round(img.height*r);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return cvs.toDataURL('image/jpeg',0.85);
}

/* ========= ã‚¢ãƒ«ãƒãƒ è¡¨ç¤ºãƒ»è©³ç´° ========= */
const albumCat=document.getElementById('albumCat'); const albumText=document.getElementById('albumText'); const albumSuperOnly=document.getElementById('albumSuperOnly');
CATEGORY_NAMES.forEach(c=> albumCat.add(new Option(c,c)) );
albumCat.onchange=renderAlbum; albumText.oninput=renderAlbum; albumSuperOnly.onchange=renderAlbum;

const albumGrid=document.getElementById('albumGrid'); let albumCache=[];
async function renderAlbum(){
  albumGrid.innerHTML='';
  albumCache = await dbGetAll();
  const cat=albumCat.value; const q=normalize(albumText.value); const superId=albumSuperOnly.checked?selSuper.value:'';
  albumCache.filter(p=>{
    if(cat && p.category!==cat) return false;
    if(superId && p.supermarketId!==superId) return false;
    if(q && !(normalize(p.name).includes(q) || normalize(p.note||'').includes(q))) return false;
    return true;
  }).sort((a,b)=>b.takenAt-a.takenAt)
  .forEach(p=>{
    const card=document.createElement('div'); card.className='photo-card'; card.tabIndex=0;
    card.innerHTML=`
      <button class="photo-del" title="å‰Šé™¤">å‰Šé™¤</button>
      <img src="${p.dataUrl}" alt="">
      <div class="photo-meta">
        <div><span class="tag">${escapeHtml(p.category)}</span> <span class="small">${escapeHtml(p.name)}</span></div>
        <div class="small">ã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼š${escapeHtml(superNameOf(p.supermarketId)||'â€”')}</div>
        <div class="small">${fmtDate(p.takenAt)}</div>
      </div>`;
    card.querySelector('img').onclick=()=>openPhoto(p);
    card.querySelector('.photo-del').onclick=async (ev)=>{
      ev.stopPropagation();
      if(!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await dbDelete(p.id);
      showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
      renderAlbum();
    };
    albumGrid.appendChild(card);
  });
}
function fmtDate(t){ const d=new Date(t); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function superNameOf(id){ return supers.find(s=>s.id===id)?.name || ''; }
const modalPhoto=document.getElementById('modalPhoto');
let currentPhoto=null;
function openPhoto(p){ currentPhoto=p; document.getElementById('photoLarge').src=p.dataUrl;
  document.getElementById('photoCat').textContent=p.category; document.getElementById('photoSuper').textContent=superNameOf(p.supermarketId)||'â€”';
  document.getElementById('photoNote').value=p.note||''; modalPhoto.classList.add('open'); }
function closePhoto(){ modalPhoto.classList.remove('open'); currentPhoto=null; }
async function savePhotoNote(){ if(!currentPhoto) return; currentPhoto.note=document.getElementById('photoNote').value; await dbPut(currentPhoto); showToast('ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); closePhoto(); renderAlbum(); }
async function deletePhoto(){ if(!currentPhoto) return; if(!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; await dbDelete(currentPhoto.id); closePhoto(); renderAlbum(); showToast('å‰Šé™¤ã—ã¾ã—ãŸ'); }

/* ä¸€æ‹¬å‰Šé™¤ */
document.getElementById('btnAlbumDeleteAll').onclick=async ()=>{
  if(!confirm('ã‚¢ãƒ«ãƒãƒ å†…ã®ã™ã¹ã¦ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const n = await dbDeleteBulk(()=>true);
  showToast(`å‰Šé™¤ï¼š${n}ä»¶`); renderAlbum();
};

/* ========= QRå…±æœ‰ï¼ˆqrcode-generator ã‚’ä½¿ç”¨ï¼‰ ========= */
const modalExport=document.getElementById('modalExport'); const modalImport=document.getElementById('modalImport');
document.getElementById('btnExport').onclick=()=>openExport(); document.getElementById('btnImport').onclick=()=>openImport();
const compact=document.getElementById('compact');

function makePayload(isCompact){
  const data={type:'shopping-list',v:1,exportedAt:Date.now(),
    items: isCompact? items.map(({name,qty,category})=>({name,qty,category})) : items
  };
  return JSON.stringify(data);
}
function payloadBytes(str){ return new Blob([str]).size; }
function validatePayloadSize(str){
  const bytes = payloadBytes(str);
  if (bytes > 2950) { showToast(`ã‚µã‚¤ã‚ºå¤§ï¼ˆ${bytes}Bï¼‰ã€‚åˆ†å‰²QRã‚„åœ§ç¸®ã‚’æ¨å¥¨`); }
}
function renderQRCodeInto(box, text){
  // UTF-8ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã›ã‚‹
  if (window.qrcode && qrcode.stringToBytesFuncs) {
    qrcode.stringToBytes = qrcode.stringToBytesFuncs['UTF-8'];
  }
  // 0: è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ / 'M': èª¤ã‚Šè¨‚æ­£M
  const qr = qrcode(0, 'M');
  qr.addData(text);
  qr.make();
  // Canvasæç”»
  const size = 256;
  const cell = Math.floor(size / qr.getModuleCount());
  const margin = Math.floor((size - cell * qr.getModuleCount()) / 2);
  const cvs = document.createElement('canvas');
  cvs.width = cvs.height = size;
  const ctx = cvs.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#000';
  for(let r=0;r<qr.getModuleCount();r++){
    for(let c=0;c<qr.getModuleCount();c++){
      if(qr.isDark(r,c)){
        ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
  }
  box.innerHTML = '';
  box.appendChild(cvs);
}
function openExport(){
  modalExport.classList.add('open');
  const box=document.getElementById('qrcode'); const err=document.getElementById('qrError');
  err.style.display='none'; box.innerHTML='';
  try{
    const payload = makePayload(compact.checked);
    validatePayloadSize(payload);
    renderQRCodeInto(box, payload);
  }catch(e){
    console.error(e);
    err.textContent = 'QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (e && e.message ? e.message : e);
    err.style.display='block';
  }
}
function closeExport(){ modalExport.classList.remove('open'); }
function downloadQR(){
  const box=document.getElementById('qrcode'); const cvs=box.querySelector('canvas');
  if(!cvs) return alert('QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='shopping_qr.png'; a.click();
}
function openImport(){
  modalImport.classList.add('open');
  document.getElementById('qrPick').value='';
  document.getElementById('qrPreview').textContent='';
  importData=null;
}
function closeImport(){ modalImport.classList.remove('open'); }

let importData=null;
document.getElementById('qrPick').onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const img=await fileToImage(f); const {data,w,h}=await imageToRGBA(img);
  const code = jsQR(data, w, h);
  if(!code){ alert('QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  try{
    const obj=JSON.parse(code.data);
    if(obj.type!=='shopping-list') throw 0;
    importData=obj;
    document.getElementById('qrPreview').textContent=`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š${obj.items?.length||0}ä»¶\n`+truncate(code.data,300);
  }catch{ alert('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
};
function truncate(s,n){ return s.length>n ? s.slice(0,n)+'â€¦':s; }

async function imageToRGBA(img){
  const maxSide = 1024;
  const scale = Math.min(1, maxSide/Math.max(img.width,img.height));
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(img,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h);
  const d=id.data;
  for(let i=0;i<d.length;i+=4){
    const gray = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
    let v = (gray - 128) * 1.2 + 128;
    v = Math.max(0, Math.min(255, v));
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(id,0,0);
  return {data:id.data, w, h};
}
function applyImport(mode){
  if(!importData){ alert('å…ˆã«QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  const incoming=(importData.items||[]).map(normalizeIncoming);
  if(mode==='replace'){ items=incoming; }
  else{
    const keyOf=it=>`${it.name}__${it.category||''}__${it.qty||1}`.toLowerCase();
    const map=new Map(items.map(it=>[keyOf(it),it])); for(const it of incoming){ if(!map.has(keyOf(it))) map.set(keyOf(it),it); }
    items=Array.from(map.values());
  }
  save(); renderList(); closeImport();
}
function normalizeIncoming(it){ return { id:crypto.randomUUID(), name:it.name||'', qty:Number(it.qty||1),
  category: it.category || guessCategory(it.name||''), checked:false, skip:false, createdAt:Date.now() }; }

/* åœ§ç¸®ãƒã‚§ãƒƒã‚¯ãŒå¤‰ã‚ã£ãŸã‚‰å³å†ç”Ÿæˆï¼ˆæ–°å®Ÿè£…ï¼‰ */
document.getElementById('compact').addEventListener('change', () => {
  const box=document.getElementById('qrcode'); const err=document.getElementById('qrError');
  if(!box) return;
  try{
    const payload=makePayload(document.getElementById('compact').checked);
    validatePayloadSize(payload);
    renderQRCodeInto(box, payload);
    err.style.display='none';
  }catch(e){
    console.error(e);
    err.textContent='QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š'+(e && e.message ? e.message : e);
    err.style.display='block';
  }
});

/* ãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ */
let stream=null, scanRAF=null;
const liveCanvas=document.createElement('canvas'); const liveCtx=liveCanvas.getContext('2d');
const liveVideo=document.createElement('video'); liveVideo.setAttribute('playsinline','');
document.getElementById('btnLiveScan').addEventListener('click', async ()=>{
  try{
    stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  }catch(e){
    showToast('ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“'); return;
  }
  const body=document.querySelector('#modalImport .body');
  const wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='8px'; wrap.style.display='flex'; wrap.style.justifyContent='center';
  wrap.appendChild(liveVideo); body.appendChild(wrap);
  liveVideo.srcObject=stream; await liveVideo.play();

  const scan=()=>{
    if(!liveVideo.videoWidth){ scanRAF=requestAnimationFrame(scan); return; }
    const w=liveVideo.videoWidth, h=liveVideo.videoHeight;
    const scale=Math.min(1, 640/Math.max(w,h));
    liveCanvas.width=Math.round(w*scale); liveCanvas.height=Math.round(h*scale);
    liveCtx.drawImage(liveVideo,0,0,liveCanvas.width,liveCanvas.height);
    const id=liveCtx.getImageData(0,0,liveCanvas.width,liveCanvas.height);
    const code=jsQR(id.data, liveCanvas.width, liveCanvas.height);
    if(code && code.data){
      cancelAnimationFrame(scanRAF); scanRAF=null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      liveVideo.srcObject=null; wrap.remove();
      try{
        const obj=JSON.parse(code.data);
        if(obj.type!=='shopping-list') throw 0;
        importData=obj; document.getElementById('qrPreview').textContent=`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š${obj.items?.length||0}ä»¶\n`+truncate(code.data,300);
        showToast('QRã‚’æ¤œå‡ºã—ã¾ã—ãŸ');
      }catch{ showToast('å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
      return;
    }
    scanRAF=requestAnimationFrame(scan);
  };
  scan();
});
const _origCloseImport = closeImport;
closeImport = function(){
  if(scanRAF){ cancelAnimationFrame(scanRAF); scanRAF=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  const body=document.querySelector('#modalImport .body');
  [...body.querySelectorAll('video')].forEach(v=>v.remove());
  _origCloseImport();
};

/* ========= åˆæœŸåŒ– ========= */
function init(){
  refreshSuperSelect(); refreshSuperList(); renderList(); renderAlbum();
  window.addEventListener('load', ()=>{
    if(!window.qrcode){ console.error('qrcode-generator èª­ã¿è¾¼ã¿å¤±æ•—'); showToast('QRç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'); }
    if(!window.jsQR){ console.error('jsQR èª­ã¿è¾¼ã¿å¤±æ•—'); showToast('QRèª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'); }
  });
}
init();

/* ========= å°ç‰© ========= */
function showToast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2256;color:#fff;padding:8px 12px;border-radius:999px;opacity:0.95;z-index:9999';
  document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600);
}
selSuper.onchange=()=>{};
function escape(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body>
</html>


