<!DOCTYPE html>
<html lang="ja" class="dark">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppStudio</title>

  <script>
    window.addEventListener('error', (e) => {
      if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
        alert('ã€èµ·å‹•ã‚¨ãƒ©ãƒ¼ã€‘\nãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nFailed: ' + (e.target.src || e.target.href));
      }
    }, true);
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            forge: { 800: '#1e1e2e', 900: '#181825', 700: '#313244', accent: '#89b4fa', surface: '#45475a' }
          }
        }
      }
    }
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #181825; }
    ::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #585b70; }
    .glass-panel { background: rgba(30, 30, 46, 0.98); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .sidebar-panel { background: #1e1e2e; border-right: 1px solid #313244; transition: width 0.3s ease; }
    .gutter { background-color: #313244; cursor: col-resize; width: 6px; transition: background 0.2s; }
    .gutter:hover { background-color: #89b4fa; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    .pill-btn { border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .pill-btn:hover { background: rgba(255,255,255,.10); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New"; }

    /* Toast */
    .toast-enter-active, .toast-leave-active { transition: all .18s ease; }
    .toast-enter-from { opacity:0; transform: translateY(8px); }
    .toast-leave-to { opacity:0; transform: translateY(8px); }

    /* Draggable cursor */
    .drag-handle { cursor: move; user-select: none; }

    /* line-clamp fallback */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    @keyframes guide-tooltip-fade {
      0% { opacity: 0; transform: translate(-50%, -5px); }
      10% { opacity: 1; transform: translate(-50%, 5px); }
      80% { opacity: 1; transform: translate(-50%, 5px); }
      100% { opacity: 0; transform: translate(-50%, 5px); pointer-events: none; }
    }
  </style>
</head>

<body class="bg-forge-900 text-gray-200 overflow-hidden font-sans">
<div id="loading-screen" style="position:fixed;inset:0;z-index:9999;background:#1e1e2e;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;color:#89b4fa;font-family:monospace;">
  <div style="width:40px;height:40px;border:4px solid #313244;border-top-color:#89b4fa;border-radius:50%;animation:spin 1s linear infinite;"></div>
  <div style="font-size:12px;letter-spacing:2px;opacity:0.8;">AppStudio Loading...</div>
  <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
</div>
<div id="app" class="h-screen flex flex-col">

  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[999] w-[92%] max-w-[760px] space-y-2 pointer-events-none">
    <transition-group name="toast" tag="div">
      <div v-for="t in toasts" :key="t.id"
           class="pointer-events-none bg-gray-900/95 border border-gray-700 rounded-xl shadow-2xl backdrop-blur px-4 py-3 flex items-start gap-3">
        <div class="mt-0.5">
          <i class="fas" :class="t.iconClass"></i>
        </div>
        <div class="min-w-0">
          <div class="text-xs font-bold text-gray-100">{{ t.title }}</div>
          <div class="text-[11px] text-gray-400 mt-0.5 whitespace-pre-wrap break-words">{{ t.message }}</div>
        </div>
      </div>
    </transition-group>
  </div>

    <div class="fixed bottom-4 right-4 z-[50] flex flex-col items-end gap-2 pointer-events-none">
    <div class="pointer-events-auto">
      <button v-if="codeHistory.length > 0" @click="undoCode" class="bg-gray-800/90 hover:bg-gray-700 text-white text-xs px-4 py-2 rounded-full border border-gray-600 shadow-xl backdrop-blur transition flex items-center gap-2">
        <i class="fas fa-undo"></i> å…ƒã«æˆ»ã™
      </button>
    </div>
    <div class="text-xs text-white font-mono font-bold opacity-80 select-none drop-shadow-md">
      (c)2026 Hisashi Fujinaka All rights reserved.
    </div>
  </div>

  <header class="glass-panel h-14 flex justify-between items-center px-4 z-30 shadow-lg relative">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 mr-1">
          <span class="text-lg font-bold tracking-wider">
                        AppStudio <span class="text-xs bg-gray-700 px-1 rounded"><span @click.stop="openGithubModal" class="cursor-pointer hover:text-blue-400 select-none" title="Developer Menu">v</span>5.1</span>
          </span>
        </div>

                <button v-if="appMode === 'project'" @click="toggleSidebar"
                class="group relative w-8 h-8 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition">
          <i class="fas fa-bars text-lg"></i>
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            å±¥æ­´ã‚µã‚¤ãƒ‰ãƒãƒ¼
          </div>
          <div class="pointer-events-none absolute top-full left-1/2 mt-1 w-max px-3 py-1.5 bg-blue-600 text-white text-[10px] font-bold rounded shadow-xl z-[55]"
               style="animation: guide-tooltip-fade 4s ease-out forwards; opacity: 0;">
            ğŸ‘ˆ å±¥æ­´ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ‡æ›¿
          </div>
        </button>

        <div class="relative">
          <button @click="menus.file = !menus.file"
                  class="group flex items-center gap-2 text-xs font-bold text-gray-300 hover:text-white transition px-3 py-1.5 rounded hover:bg-white/10 border border-transparent hover:border-gray-600">
            <div class="pointer-events-none absolute top-full left-0 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
              ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ‡æ›¿ãƒ»æ–°è¦ä½œæˆ
            </div>
            <i class="fas fa-folder text-yellow-500"></i>
            <span>{{ projectDisplayName }}</span>
            <i class="fas fa-caret-down opacity-50"></i>
          </button>

<div v-if="menus.file"
               class="absolute top-full left-0 mt-1 w-72 bg-forge-800 border border-gray-600 rounded shadow-2xl py-1 z-50">
            <div class="px-3 py-1 text-[10px] text-gray-500 font-bold uppercase">å˜ç™ºã‚¢ãƒ—ãƒª</div>
            
            <a @click="createNewSingleApp" class="group relative block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
              <i class="fas fa-file-circle-plus w-4 text-green-400"></i> å˜ç™ºhtmlã‚¢ãƒ—ãƒªã‚’æ–°è¦ä½œæˆ
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-64 p-3 bg-gray-900/95 border border-gray-600 rounded-lg shadow-2xl text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] backdrop-blur-sm">
                <strong class="text-green-400 block mb-1">å˜ç™ºã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰</strong>
                å±¥æ­´ç®¡ç†ãªã—ã§ã€1ã¤ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µã‚¯ãƒƒã¨ä½œã‚ŠãŸã„æ™‚ã«æœ€é©ã§ã™ã€‚ä¿å­˜å…ˆã¯ãã®éƒ½åº¦æŒ‡å®šã—ã¾ã™ã€‚
              </div>
            </a>

            <a @click="openSingleFile" class="group relative block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
              <i class="fas fa-file-code w-4"></i> HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-64 p-3 bg-gray-900/95 border border-gray-600 rounded-lg shadow-2xl text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] backdrop-blur-sm">
                <strong class="text-green-400 block mb-1">å˜ç™ºã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰</strong>
                æ—¢å­˜ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ç·¨é›†ã—ã¾ã™ã€‚å±¥æ­´æ©Ÿèƒ½ã¯ä½¿ãˆã¾ã›ã‚“ãŒæ‰‹è»½ã§ã™ã€‚
              </div>
            </a>

            <div class="border-t border-gray-700 my-1"></div>
            <div class="px-3 py-1 text-[10px] text-gray-500 font-bold uppercase">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
            
            <a @click="createNewProject" class="group relative block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
              <i class="fas fa-plus-circle w-4"></i> æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-64 p-3 bg-gray-900/95 border border-gray-600 rounded-lg shadow-2xl text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] backdrop-blur-sm">
                <strong class="text-blue-400 block mb-1">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ (æ¨å¥¨)</strong>
                ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ã‚©ãƒ«ãƒ€å˜ä½ã§ç®¡ç†ã—ã¾ã™ã€‚ä¿å­˜ã™ã‚‹ãŸã³ã«å±¥æ­´ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã€ã„ã¤ã§ã‚‚éå»ã®çŠ¶æ…‹ã«æˆ»ã›ã¾ã™ã€‚
              </div>
            </a>

            <a @click="openProjectFolder" class="group relative block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
              <i class="fas fa-folder w-4"></i> æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-64 p-3 bg-gray-900/95 border border-gray-600 rounded-lg shadow-2xl text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-[60] backdrop-blur-sm">
                <strong class="text-blue-400 block mb-1">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ (æ¨å¥¨)</strong>
                éå»ã«ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã„ã¦é–‹ç™ºã‚’å†é–‹ã—ã¾ã™ã€‚å¤‰æ›´å±¥æ­´ã‚‚èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
              </div>
            </a>

            <div class="border-t border-gray-700 my-1"></div>
            <a v-if="appMode==='project'" @click="refreshLibrary" class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
              <i class="fas fa-rotate w-4"></i> å±¥æ­´ã‚’å†èª­è¾¼
            </a>
          </div>
        </div>
      </div>

      <div class="h-8 w-px bg-gray-700"></div>

            <div class="flex items-center p-1 gap-1 rounded border border-gray-600 bg-gray-800/50">
        <button @click="runEmulator"
                class="group relative px-4 py-1.5 bg-green-700 hover:bg-green-600 text-white text-xs rounded flex items-center gap-2 transition font-bold shadow hover:shadow-green-500/20">
          <i class="fas fa-play"></i> å®Ÿè¡Œ
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ (Ctrl+Enter)
          </div>
        </button>
        <button @click="openFullWindow"
                class="group relative px-3 py-1.5 text-gray-300 hover:bg-gray-700 hover:text-white rounded text-xs transition flex items-center gap-2">
          <i class="fas fa-external-link-alt"></i> <span class="hidden xl:inline">åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦è¡¨ç¤º</span>
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            å¤§ããªç”»é¢ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </div>
        </button>
        <button @click="stopEmulator"
                class="group relative px-3 py-1.5 text-red-400 hover:bg-gray-700 hover:text-red-300 rounded text-xs transition">
          <i class="fas fa-stop"></i>
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            å®Ÿè¡Œåœæ­¢ãƒ»ãƒªã‚»ãƒƒãƒˆ
          </div>
        </button>
      </div>

      <div class="h-8 w-px bg-gray-700"></div>

            <div class="flex items-center gap-2">
        <button @click="openAiModal"
                class="group relative text-xs px-3 py-1.5 rounded bg-purple-800 hover:bg-purple-700 flex items-center gap-2 transition border border-purple-600 text-purple-100 shadow">
          <i class="fas fa-robot"></i> AIæŒ‡ç¤º
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            AIã«ã‚³ãƒ¼ãƒ‰ä½œæˆãƒ»ä¿®æ­£ã‚’ä¾é ¼
          </div>
        </button>
                                                                                <button @click="openPatchModal"
                class="group relative text-xs px-3 py-1.5 rounded bg-yellow-700 hover:bg-yellow-600 flex items-center gap-2 font-bold text-white transition border border-yellow-600 shadow">
          <i class="fas fa-sync-alt"></i> ã‚¢ãƒ—ãƒªã‚’æ›´æ–°
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            AIãŒä½œã£ãŸä¿®æ­£æ¡ˆã‚’å–ã‚Šè¾¼ã‚“ã§ã€ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¾ã™
          </div>
        </button>

        <div class="h-8 w-px bg-gray-700"></div>

                        <button @click="openConsultModal"
                class="group relative text-xs px-3 py-1.5 rounded bg-teal-700 hover:bg-teal-600 flex items-center gap-2 font-bold text-white transition border border-teal-600 shadow">
          <i class="fas fa-comments"></i> AIã«ç›¸è«‡
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            æ©Ÿèƒ½ææ¡ˆãƒ»è©•ä¾¡ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ã†
          </div>
        </button>
      </div>

            <div class="h-8 w-px bg-gray-700"></div>

            <div class="flex gap-2">
                        <button @click="openSaveModal"
                class="group relative btn-primary text-xs px-5 py-1.5 rounded bg-blue-600 hover:bg-blue-500 flex items-center gap-2 transition shadow-lg shadow-blue-900/30 font-bold text-white">
          <i class="fas fa-save"></i> ä¿å­˜
          <div class="pointer-events-none absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
            ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
          </div>
        </button>
      </div>
    </div>

        <div class="flex items-center gap-2">
      <button @click="modals.settings = true"
              class="group relative w-9 h-9 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition">
        <i class="fas fa-cog"></i>
        <div class="pointer-events-none absolute top-full right-0 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
          ä¿å­˜å…ˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
        </div>
      </button>
      <button @click="modals.help = true"
              class="group relative w-9 h-9 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition">
        <i class="fas fa-question-circle"></i>
        <div class="pointer-events-none absolute top-full right-0 mt-2 w-max px-2 py-1 bg-gray-900 text-[10px] text-gray-200 rounded border border-gray-700 shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-[60]">
          ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
        </div>
      </button>
    </div>
  </header>

  <div class="flex-1 flex relative overflow-hidden">

    <transition name="fade">
      <aside v-if="appMode === 'project' && isSidebarOpen"
             class="w-80 sidebar-panel flex-shrink-0 flex flex-col z-10 shadow-xl">
        <div class="p-3 bg-forge-700 text-xs font-bold text-gray-300 flex justify-between items-center border-b border-gray-600">
          <span><i class="fas fa-history mr-1"></i> ã“ã®PJã®å±¥æ­´</span>
          <button @click="refreshLibrary" class="hover:text-white" title="å†èª­è¾¼">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <div class="p-2 border-b border-gray-700">
          <div class="text-[11px] text-gray-400 mb-1">ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</div>
          <div class="flex gap-2">
            <button @click="historyMode='flat'; refreshLibrary()"
                    class="group relative flex-1 px-2 py-2 rounded text-[11px] font-bold flex flex-col items-center gap-1 leading-tight"
                    :class="historyMode==='flat' ? 'bg-blue-700 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'">
              <i class="fas fa-clock"></i>
              ã“ã®PJã®å±¥æ­´
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-48 p-2 bg-gray-900/95 border border-gray-600 rounded shadow-xl text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity z-50 text-left normal-case font-normal leading-relaxed backdrop-blur-sm">
                <strong class="text-blue-300 block mb-1">å±¥æ­´ãƒ¢ãƒ¼ãƒ‰ (Default)</strong>
                ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å†…ã«ã‚ã‚‹ã€å…¨ã¦ã®ä¿å­˜å±¥æ­´ï¼ˆHTMLï¼‰ã‚’æ—¥æ™‚é †ã«è¡¨ç¤ºã—ã¾ã™ã€‚
              </div>
            </button>
            <button @click="historyMode='group'; refreshLibrary()"
                    class="group relative flex-1 px-2 py-2 rounded text-[11px] font-bold flex flex-col items-center gap-1 leading-tight"
                    :class="historyMode==='group' ? 'bg-teal-700 text-white shadow-lg' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'">
              <i class="fas fa-folder-tree"></i>
              PJä¸€è¦§ (Root)
              <div class="pointer-events-none absolute left-full top-0 ml-2 w-48 p-2 bg-gray-900/95 border border-gray-600 rounded shadow-xl text-[10px] text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity z-50 text-left normal-case font-normal leading-relaxed backdrop-blur-sm">
                <strong class="text-teal-300 block mb-1">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ‰</strong>
                è¨­å®šã•ã‚ŒãŸã€Œè¦ªãƒ•ã‚©ãƒ«ãƒ€(Root)ã€ç›´ä¸‹ã®å„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ãã‚Œãã‚Œã®æœ€æ–°ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
              </div>
            </button>
          </div>

          <div class="mt-2 text-[10px] text-gray-500">
            èª­ã¿è¾¼ã¿: <span class="text-gray-200 font-bold">{{ libraryFiles.length }}</span>ä»¶
            <span class="ml-2" v-if="libraryScanStatus">/ {{ libraryScanStatus }}</span>
          </div>

          <div class="mt-2 flex gap-2">
            <button @click="refreshLibrary"
                    class="flex-1 px-3 py-1.5 rounded text-xs font-bold bg-gray-900/40 hover:bg-gray-800 border border-gray-700"
                    title="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°">
              <i class="fas fa-rotate mr-1"></i> å†èª­ã¿è¾¼ã¿
            </button>
            <button @click="revealCurrentFolder"
                    class="px-3 py-1.5 rounded text-xs font-bold bg-gray-900/40 hover:bg-gray-800 border border-gray-700 text-gray-400 hover:text-white"
                    title="ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã§å ´æ‰€ã‚’ç¢ºèª">
              <i class="fas fa-folder-open"></i>
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-2">

          <div v-if="libraryFiles.length === 0" class="text-center text-gray-500 py-10 text-xs">
            <i class="fas fa-folder-open mb-2 text-2xl opacity-30"></i><br>
            å±¥æ­´ãªã—ï¼ˆãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« .html ãŒè¦‹ã¤ã‹ã‚‰ãªã„ / èª­ã¿å–ã‚Šä¸å¯ã®å¯èƒ½æ€§ï¼‰
          </div>

<template v-if="historyMode==='group'">
            <div v-for="grp in groupedApps" :key="grp.groupKey"
                 class="rounded border border-gray-700 bg-gray-900/40 overflow-hidden hover:border-blue-500 transition cursor-pointer"
                 @click="openProjectFromList(grp.versions[0])">
              <div class="p-3 bg-gray-900/60 flex items-start justify-between gap-3">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fas fa-folder text-yellow-500 text-sm"></i>
                    <div class="text-xs font-bold text-blue-200 truncate">
                      {{ grp.latestTitle || grp.groupKey }}
                    </div>
                  </div>
                  <div class="text-[10px] text-gray-500 mb-1">
                    æœ€çµ‚æ›´æ–°: {{ grp.versions[0]?.savedAtStr }}
                  </div>
                                                      <div class="text-[10px] text-gray-400 mt-1 line-clamp-2 bg-gray-800/50 p-1.5 rounded hover:bg-gray-700/80 transition-colors"
                       v-if="grp.latestAiInstruction"
                       @mouseenter="showHistoryDetail($event, grp.latestAiInstruction)"
                       @mouseleave="hideHistoryDetail">
                    <i class="fas fa-robot mr-1 opacity-70"></i>{{ grp.latestAiInstruction }}
                  </div>
                </div>
                <div class="flex flex-col gap-1 shrink-0">
                  <button class="px-3 py-1 text-[10px] rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg flex items-center justify-center gap-1">
                    <i class="fas fa-door-open"></i> é–‹ã
                  </button>
                                    <button @click.stop="openDiffModal(grp.versions[0])" class="px-3 py-1 text-[10px] rounded bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 flex items-center justify-center gap-1" title="ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒ">
                    <i class="fas fa-columns"></i> å·®åˆ†
                  </button>
                  <button @click.stop="openHistoryEditModal(grp.versions[0])" class="px-3 py-1 text-[10px] rounded bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 flex items-center justify-center gap-1" title="å±¥æ­´ãƒ¡ãƒ¢ã‚’ç·¨é›†">
                    <i class="fas fa-pen"></i> ãƒ¡ãƒ¢
                  </button>
                </div>
              </div>
            </div>
          </template>

                    <template v-else>
            <div v-for="(file, idx) in libraryFilesFlat" :key="file.name"
                 class="group p-2 rounded bg-gray-800 border border-gray-700 hover:border-gray-500 transition cursor-pointer flex flex-col gap-1 relative"
                 :class="{'border-forge-accent bg-gray-700': currentFileName === file.name}"
                 @click="loadFile(file.handle)">
                            <div class="flex justify-between items-start gap-2">
                <span class="text-xs font-bold text-blue-300 truncate w-52">
                  {{ file.displayTitle }}
                  <span v-if="idx === 0" class="inline-block bg-pink-600 text-white text-[9px] px-1.5 rounded-sm ml-1 font-mono shadow-sm">LATEST</span>
                </span>
                <span class="text-[10px] text-gray-400 whitespace-nowrap">{{ file.savedAtStr }}</span>
              </div>
              <div class="text-[10px] text-gray-500">
                key: <span class="mono">{{ file.groupKey.slice(0,12) }}</span>
              </div>
              <div class="text-[10px] text-gray-500 break-all">
                {{ file.name }}
              </div>
                            <div class="text-[11px] text-gray-300 mt-1 bg-gray-900 bg-opacity-50 p-1 rounded italic line-clamp-2 hover:bg-gray-700 transition-colors"
                   v-if="file.meta.aiInstruction || file.meta.comment"
                   @mouseenter="showHistoryDetail($event, file.meta.aiInstruction || file.meta.comment)"
                   @mouseleave="hideHistoryDetail">
                <i class="fas fa-comment-alt text-[9px] mr-1 opacity-50"></i>{{ file.meta.aiInstruction || file.meta.comment }}
              </div>
                            <div class="mt-2 flex gap-1 opacity-60 group-hover:opacity-100 transition">
                <button @click.stop="runExternal(file)"
                        class="flex-1 py-1 bg-gray-600 hover:bg-gray-500 rounded text-[10px]" title="åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Ÿè¡Œ">
                  <i class="fas fa-external-link-alt"></i> å®Ÿè¡Œ
                </button>
                                <button @click.stop="openDiffModal(file)"
                        class="flex-1 py-1 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded text-[10px]" title="ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒ">
                  <i class="fas fa-columns"></i> å·®åˆ†
                </button>
                <button @click.stop="openHistoryEditModal(file)"
                        class="flex-1 py-1 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded text-[10px]" title="å±¥æ­´ãƒ¡ãƒ¢ã‚’ç·¨é›†">
                  <i class="fas fa-pen"></i> ãƒ¡ãƒ¢
                </button>
              </div>
            </div>
          </template>

        </div>
            </aside>
    </transition>

    
    <div v-if="hoveredHistory"
         class="fixed z-[100] w-72 p-3 bg-gray-900/95 border border-gray-500 rounded-lg shadow-2xl text-xs text-gray-100 pointer-events-none whitespace-pre-wrap break-words backdrop-blur font-sans leading-relaxed"
         :style="{ top: hoveredHistory.top + 'px', left: hoveredHistory.left + 'px' }">
      <div class="text-[10px] text-blue-300 font-bold mb-1 border-b border-gray-700 pb-1">History Comment</div>
      {{ hoveredHistory.text }}
    </div>

        <section id="editor-pane" v-show="isEditorOpen" class="flex-1 flex flex-col min-w-[300px] relative z-0">
      <div class="bg-forge-800 h-8 flex items-center justify-between px-2 border-b border-gray-700 select-none">
        <div class="flex items-center gap-2">
          <button @click="toggleEditor" class="text-gray-400 hover:text-white px-2 py-1 rounded hover:bg-gray-700" title="ã‚¨ãƒ‡ã‚£ã‚¿ã‚’éš ã™">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="text-xs font-bold text-gray-500 px-2"><i class="fas fa-code"></i> ã‚¨ãƒ‡ã‚£ã‚¿</span>

          <button @click="openFindReplace('find')"
                  class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="æ¤œç´¢ (Ctrl+F)">
            <i class="fas fa-search"></i>
          </button>
          <button @click="openFindReplace('replace')"
                  class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="ç½®æ› (Ctrl+H)">
            <i class="fas fa-i-cursor"></i>
          </button>

          <button @click="clearCode"
                  class="text-gray-400 hover:text-red-400 px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="å…¨ã‚¯ãƒªã‚¢">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>

        <div class="text-[10px] text-gray-500 font-mono flex gap-3">
          <span>{{ editorStats.lines }} è¡Œ</span>
          <span>{{ editorStats.chars }} æ–‡å­—</span>
        </div>
      </div>

      <div class="flex-1 relative group">
        <div id="editor-container" class="w-full h-full"></div>

        <div v-if="findUI.open"
             class="absolute z-20 w-[720px] max-w-[92%] bg-gray-900/95 border border-gray-700 rounded-lg shadow-2xl backdrop-blur p-3"
             :style="{ left: findUI.x + 'px', top: findUI.y + 'px' }">
          <div class="flex items-center justify-between mb-2 drag-handle"
               @mousedown.prevent="startDragFindUI">
            <div class="text-xs font-bold text-gray-200 flex items-center gap-2">
              <i class="fas fa-search text-blue-300"></i>
              <span>Find / Replace</span>
              <span class="text-[10px] text-gray-500">(Escã§é–‰ã˜ã‚‹ / ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•)</span>
            </div>
            <button @click.stop="closeFindReplace"
                    class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200"
                    title="é–‰ã˜ã‚‹">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>

          <div class="mb-2 flex items-center justify-between gap-2">
            <label class="flex items-center gap-2 text-[11px] text-gray-200 select-none cursor-pointer bg-gray-900/40 border border-gray-700 rounded px-3 py-1.5">
              <input type="checkbox" v-model="findUI.ignoreWhitespace" class="accent-blue-500">
              <span class="font-bold">æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–</span>
              <span class="text-gray-500">(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON)</span>
            </label>
            <div class="text-[10px] text-gray-500">â€»å˜ç´”æ¤œç´¢ï¼ˆæ­£è¦è¡¨ç¾ãªã—ï¼‰</div>
          </div>

          <div class="mb-2">
            <div class="flex items-center justify-between mb-1">
              <label class="text-[11px] font-bold text-gray-300">Find</label>
              <button type="button"
                      @click="findUI.find=''; recomputeMatchCount(); $nextTick(()=>findInputEl && findInputEl.focus())"
                      class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200 flex items-center gap-1"
                      title="Findã‚’ã‚¯ãƒªã‚¢">
                <i class="fas fa-eraser text-[10px]"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>

            <textarea ref="findInputEl"
                      v-model="findUI.find"
                      class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-xs text-gray-100 outline-none focus:border-blue-400 font-mono h-24 resize-y whitespace-pre"
                      placeholder="æ¤œç´¢æ–‡å­—åˆ—ï¼ˆãã®ã¾ã¾è²¼ã‚Šä»˜ã‘OK / Ctrl+Fï¼‰"
                      @input="recomputeMatchCount"
                      @keydown.enter.exact.prevent="findNext()"></textarea>
          </div>

          <div class="mb-2">
            <div class="flex items-center justify-between mb-1">
              <label class="text-[11px] font-bold text-gray-300">Replace</label>
              <button type="button"
                      @click="findUI.replace=''; $nextTick(()=>replaceInputEl && replaceInputEl.focus())"
                      class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200 flex items-center gap-1"
                      title="Replaceã‚’ã‚¯ãƒªã‚¢">
                <i class="fas fa-eraser text-[10px]"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>

            <textarea ref="replaceInputEl"
                      v-model="findUI.replace"
                      class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-xs text-gray-100 outline-none focus:border-yellow-400 font-mono h-24 resize-y whitespace-pre"
                      placeholder="ç½®æ›æ–‡å­—åˆ—ï¼ˆãã®ã¾ã¾è²¼ã‚Šä»˜ã‘OK / Ctrl+Hï¼‰"
                      @keydown.enter.exact.prevent="replaceOne()"></textarea>
          </div>

          <div class="flex items-center justify-between gap-2 mt-2">
            <div class="flex gap-2">
              <button @click="findNext"
                      class="px-3 py-2 rounded bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold border border-blue-600">
                æ¬¡ã‚’æ¤œç´¢
              </button>
              <button @click="findPrev"
                      class="px-3 py-2 rounded bg-blue-900 hover:bg-blue-800 text-white text-xs font-bold border border-blue-800">
                å‰ã‚’æ¤œç´¢
              </button>
            </div>

            <div class="flex gap-2">
              <button @click="replaceOne"
                      class="px-3 py-2 rounded bg-yellow-700 hover:bg-yellow-600 text-white text-xs font-bold border border-yellow-600">
                ç½®æ›
              </button>
              <button @click="replaceAll"
                      class="px-3 py-2 rounded bg-yellow-900 hover:bg-yellow-800 text-white text-xs font-bold border border-yellow-800">
                å…¨ç½®æ›
              </button>
            </div>
          </div>

          <div class="mt-2 text-[10px] text-gray-500 flex justify-between items-center">
            <span v-if="findUI.find && findUI.matchCount > 0" class="text-red-400 font-bold text-[12px]">è©²å½“ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š{{ findUI.matchCount }}ä»¶</span>
                        <span v-else-if="findUI.find && findUI.matchCount === 0">
              <span v-if="findUI.hint" class="text-yellow-400 font-bold animate-pulse">{{ findUI.hint }}</span>
              <span v-else>è©²å½“ç®‡æ‰€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</span>
            </span>
            <span v-else>æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
            <span class="text-gray-600">Enter=æ¬¡</span>
          </div>
        </div>

        <button @click="copyFullCode"
                class="absolute top-4 right-6 bg-gray-700 bg-opacity-80 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded shadow-lg backdrop-blur opacity-0 group-hover:opacity-100 transition duration-200 z-10 flex items-center gap-2 font-bold">
          <i class="fas fa-copy"></i> ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
    </section>

        <div class="gutter" v-show="isEditorOpen" @mousedown="startResize"></div>

    <section id="emulator-pane" class="flex-1 flex flex-col min-w-[300px] bg-white transition-all duration-200">
      <div class="bg-gray-100 h-8 flex items-center justify-between px-3 border-b border-gray-300">
        <div class="flex items-center gap-2">
          <button v-if="!isEditorOpen" @click="toggleEditor" class="flex items-center gap-2 text-xs font-bold text-gray-700 hover:bg-gray-200 px-2 py-1 rounded transition border border-gray-300 bg-white" title="ã‚¨ãƒ‡ã‚£ã‚¿ã‚’è¡¨ç¤º">
             <i class="fas fa-code"></i> ã‚³ãƒ¼ãƒ‰
          </button>
          <div class="relative group z-20">
            <button class="flex items-center gap-2 text-xs font-bold text-gray-700 hover:bg-gray-200 px-2 py-1 rounded transition" title="ãƒ‡ãƒã‚¤ã‚¹ã‚µã‚¤ã‚ºåˆ‡ã‚Šæ›¿ãˆ">
              <i class="fas" :class="currentDevice.icon"></i>
              <span class="hidden sm:inline">{{ currentDevice.name }}</span>
              <i class="fas fa-caret-down text-[10px] opacity-50"></i>
            </button>
            <div class="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-300 rounded shadow-xl py-1 hidden group-hover:block">
              <div v-for="d in deviceModes" :key="d.name" 
                   @click="currentDevice = d"
                   class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-xs text-gray-700 flex items-center gap-2 transition"
                   :class="{'bg-blue-100 font-bold text-blue-800': currentDevice.name === d.name}">
                <i class="fas w-4 text-center" :class="d.icon"></i> {{ d.name }}
              </div>
            </div>
          </div>

          <button @click="runEmulator" class="text-gray-400 hover:text-green-600 ml-2" title="ãƒªãƒ­ãƒ¼ãƒ‰">
            <i class="fas fa-redo"></i>
          </button>
        </div>

        <div class="flex items-center gap-1">
          <button @click="openDbModal"
                  class="flex items-center gap-2 text-xs font-bold text-gray-700 hover:bg-gray-200 px-3 py-1 rounded transition"
                  title="IndexedDB ç°¡æ˜“è¡¨ç¤º">
            <i class="fas fa-database text-blue-600"></i>
            <span>DB</span>
          </button>

          <div class="h-4 w-px bg-gray-300 mx-1"></div>

          <button @click="openFullWindow"
                  class="flex items-center gap-2 text-xs font-bold text-gray-700 hover:bg-gray-200 px-3 py-1 rounded transition"
                  title="åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦è¡¨ç¤º">
            <i class="fas fa-external-link-alt text-green-600"></i>
            <span>åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦</span>
          </button>
        </div>
      </div>

            <div class="flex-1 relative bg-gray-50 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTVlNzViIiBzdHJva2Utd2lkdGg9IjEiPjxwYXRoIGQ9Ik0wIDBoMjB2MjBIMHoiLz48cGF0aCBkPSJNMCAyMGgyME0yMCAwdjIwIiBvcGFjaXR5PSIuMiIvPjwvc3ZnPg==')] overflow-auto flex items-center justify-center">
        <div :style="{ width: currentDevice.width, height: currentDevice.height }" class="transition-all duration-300 relative shadow-2xl bg-white border border-gray-300 flex-shrink-0">
          <iframe id="emulator-frame" class="w-full h-full border-none bg-white"></iframe>
          <div v-if="isRunLoading" class="absolute inset-0 bg-white/50 backdrop-blur-[2px] flex flex-col items-center justify-center z-50 transition-opacity duration-300">
            <div class="animate-spin rounded-full h-12 w-12 border-[5px] border-gray-300 border-t-blue-600 mb-4 shadow-lg"></div>
            <div class="text-xs font-bold text-blue-700 bg-white/90 px-4 py-1.5 rounded-full shadow-xl border border-blue-100 flex items-center gap-2 animate-pulse">
               <i class="fas fa-rocket"></i> ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ä¸­...
            </div>
          </div>
        </div>
      </div>

      <div class="h-24 bg-gray-900 border-t border-gray-700 flex flex-col font-mono text-[10px]">
        <div class="px-2 py-0.5 bg-gray-800 text-gray-500 flex justify-between">
          <span>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
          <button @click="consoleLogs=[]" class="hover:text-white">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="console-output">
          <div v-for="(log, i) in consoleLogs" :key="i" class="mb-0.5 border-b border-gray-800 pb-0.5"
               :class="{'text-red-400': log.type === 'error', 'text-yellow-400': log.type === 'warn', 'text-green-400': log.type === 'info'}">
            > {{ log.message }}
          </div>
        </div>
      </div>
    </section>
  </div>

  <div v-if="modals.ai" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-0 rounded-lg w-[780px] max-w-full shadow-2xl border border-gray-600 flex flex-col overflow-hidden">
      <div class="flex border-b border-gray-600 bg-gray-800">
        <button @click="aiTab='full'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="aiTab==='full' ? 'bg-forge-700 text-blue-400 border-b-2 border-blue-400' : 'text-gray-400 hover:text-white'">
          â‘  å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (æ–°è¦/ãƒªã‚»ãƒƒãƒˆ)
        </button>
        <button @click="aiTab='patch'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="aiTab==='patch' ? 'bg-forge-700 text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400 hover:text-white'">
          â‘¡ éƒ¨åˆ†ä¿®æ­£ (æ‰‹å‹•)
        </button>
        <button @click="aiTab='json'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="aiTab==='json' ? 'bg-forge-700 text-pink-400 border-b-2 border-pink-400' : 'text-gray-400 hover:text-white'">
          â‘¢ éƒ¨åˆ†ä¿®æ­£ (ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆ)
        </button>
      </div>

            <div class="p-6 bg-forge-900">
        <div class="flex items-start justify-between gap-2 mb-2">
          <p class="text-xs text-gray-400 flex-1 leading-relaxed">
                        <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                        <span v-if="aiTab==='full'">ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚AIã«ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ä½œã£ã¦ã‚‚ã‚‰ã†ãŸã‚ã®ã€æŒ‡ç¤ºæ–‡ã€ã‚’è‡ªå‹•ã§ä½œæˆã—ã¾ã™ã€‚<span class="text-yellow-200 ml-1">â€»éƒ¨åˆ†ä¿®æ­£ãŒã†ã¾ãã„ã‹ãªã„å ´åˆã®ã€Œä½œã‚Šç›´ã—ï¼ˆãƒªã‚«ãƒãƒªãƒ¼ï¼‰ã€ã«ã‚‚æœ€é©ã§ã™ã€‚</span></span>
                        <span v-else-if="aiTab==='patch'">å¤‰æ›´æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIã«ã€Œå¤‰æ›´å‰ã®å†…å®¹ã€ã¨ã€Œå¤‰æ›´å¾Œã®å†…å®¹ã€ã‚’æ˜ç¢ºã«å‡ºåŠ›ã•ã›ã€æ‰‹å‹•ã§ä¿®æ­£ã‚’åæ˜ ã—ã‚„ã™ãã—ã¾ã™ã€‚</span>
            <span v-else>AIã«ã€ä¿®æ­£å†…å®¹ã‚’ã€ŒAIãŒç†è§£ã—ã‚„ã™ã„å°‚ç”¨ã®è¨€è‘‰(JSON)ã€ã§ä½œã‚‰ã›ã¾ã™ã€‚ãã‚Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ç”»é¢ã®ã€Œâ‘¢ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆã€ã«è²¼ã‚‹ã ã‘ã§ã€ã™ã¹ã¦ã®å¤‰æ›´ãŒä¸€æ‹¬ã§é©ç”¨ã•ã‚Œã¾ã™ã€‚</span>
          </p>
          <button @click="aiHelp = !aiHelp" class="flex-shrink-0 text-xs bg-yellow-900/40 text-yellow-200 border border-yellow-700/50 px-2 py-1 rounded hover:bg-yellow-900/60 transition">
            <i class="fas fa-life-ring mr-1"></i>è¿·ã£ãŸã‚‰ï¼Ÿ
          </button>
        </div>

        <div v-if="aiHelp" class="mb-4 bg-gray-800/90 border border-yellow-700/40 rounded-lg p-3 text-xs text-gray-300 space-y-2 relative animate-fade-in">
          <div class="absolute top-2 right-2 text-gray-500 cursor-pointer hover:text-white" @click="aiHelp=false"><i class="fas fa-times"></i></div>
          <p class="font-bold text-yellow-400 border-b border-gray-700 pb-1 mb-1"><i class="fas fa-lightbulb mr-1"></i> åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ï¼šã©ã‚Œã‚’é¸ã¹ã°ã„ã„ï¼Ÿ</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-blue-500 transition" @click="aiTab='full'">
              <strong class="text-blue-300 block mb-1">â‘  å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</strong>
              <span class="text-[10px] text-gray-400">ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¼ãƒ­ã‹ã‚‰ä½œã‚ŠãŸã„ã€ã€Œãƒã‚°ã‚Šã™ãã¦ä½œã‚Šç›´ã—ãŸã„ã€ã¨ã</span>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-yellow-500 transition" @click="aiTab='patch'">
              <strong class="text-yellow-300 block mb-1">â‘¡ éƒ¨åˆ†ä¿®æ­£ (æ‰‹å‹•)</strong>
              <span class="text-[10px] text-gray-400">AIãŒè‡ªå‹•ã§ç›´ã›ãªã„ã¨ãã‚„ã€è‡ªåˆ†ã®ç›®ã§ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ç›´ã—ãŸã„ã¨ã</span>
            </div>
            <div class="bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-pink-500 transition" @click="aiTab='json'">
              <strong class="text-pink-300 block mb-1">â‘¢ éƒ¨åˆ†ä¿®æ­£ (ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆ)</strong>
              <span class="text-[10px] text-gray-400">â˜…éƒ¨åˆ†ä¿®æ­£ãªã‚‰ã€åŸºæœ¬ã¯ã“ã‚Œï¼ã€Œãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰ãˆã¦ã€ã€Œæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€ãªã©è¤‡æ•°å€‹æ‰€ã‚’è‡ªå‹•ã§ä¸€æ°—ã«ä¿®æ­£</span>
            </div>
                    </div>
        </div>

                <div v-if="aiTab==='full'" class="mb-4 animate-fade-in">
          <button @click="showRecipes = !showRecipes" class="flex items-center gap-2 text-xs font-bold text-gray-300 mb-2 hover:text-white transition w-full text-left">
            <i class="fas" :class="showRecipes ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
            ğŸ”° åˆã‚ã¦ã®æ–¹ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ãŒæµ®ã‹ã°ãªã„æ–¹ã¯ã“ã¡ã‚‰ï¼ˆãŠè©¦ã—ãƒ¬ã‚·ãƒ”ï¼‰
          </button>
          <div v-if="showRecipes" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button v-for="recipe in recipePrompts" :key="recipe.label"
                    @click="aiPromptInput = recipe.prompt"
                    class="text-left px-3 py-2 rounded border transition flex flex-col gap-0.5 shadow-sm"
                    :class="recipe.class">
              <span class="text-xs font-bold">{{ recipe.label }}</span>
              <span class="text-[10px] opacity-80">{{ recipe.desc }}</span>
            </button>
          </div>
        </div>

        <div v-if="aiTab==='patch' || aiTab==='json'" class="mb-4 animate-fade-in">
          <button @click="showRecipes = !showRecipes" class="flex items-center gap-2 text-xs font-bold text-gray-300 mb-2 hover:text-white transition w-full text-left">
            <i class="fas" :class="showRecipes ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
            ğŸ†˜ ä¿®æ­£æŒ‡ç¤ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå›°ã£ãŸã¨ãã¯ã‚³ãƒãƒ©ï¼‰
          </button>
          <div v-if="showRecipes" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <button v-for="recipe in patchRecipes" :key="recipe.label"
                    @click="aiPromptInput = recipe.prompt"
                    class="text-left px-3 py-2 rounded border transition flex flex-col gap-0.5 shadow-sm"
                    :class="recipe.class">
              <span class="text-xs font-bold">{{ recipe.label }}</span>
              <span class="text-[10px] opacity-80">{{ recipe.desc }}</span>
            </button>
          </div>
        </div>

        <div class="mb-2 text-[11px] text-gray-500" v-if="appMode==='project'">
          å¯¾è±¡ã‚¢ãƒ—ãƒª: <span class="text-gray-200 font-bold">{{ currentAppTitle || '(æœªé¸æŠ)' }}</span>
          <span class="ml-2 text-gray-600">(key: <span class="mono">{{ (currentGroupKey||'').slice(0,12) }}</span>)</span>
        </div>

        <div class="mb-4">
          <div class="flex justify-between items-end mb-1">
            <label class="block text-xs font-bold text-gray-300">æŒ‡ç¤ºå†…å®¹ï¼ˆã“ã®ã‚¢ãƒ—ãƒªã«ç´ã¥ã‘ï¼‰</label>
            <button v-if="aiTab==='full'" @click="toggleWizard" class="text-[10px] bg-indigo-900/50 border border-indigo-500/50 text-indigo-200 px-2 py-0.5 rounded hover:bg-indigo-800 transition flex items-center gap-1">
              <i class="fas fa-wand-magic-sparkles"></i> ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§æŒ‡ç¤ºã‚’ä½œã‚‹
            </button>
          </div>

          <div v-if="wizardOpen" class="mb-2 bg-gray-800/80 border border-indigo-500/30 rounded-lg p-3 animate-fade-in">
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
              <span class="text-xs font-bold text-indigo-300"><span class="mr-2 px-1.5 rounded bg-indigo-900 text-white">Step {{ wizardStep }}/3</span> {{ wizardTitle }}</span>
              <button @click="wizardOpen=false" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-3">
              <div v-if="wizardStep===1" class="grid grid-cols-2 gap-2">
                <button v-for="opt in wizardOptions.types" :key="opt" @click="setWizardType(opt)" 
                  class="text-left px-3 py-2 rounded border text-xs transition"
                  :class="wizardData.type===opt ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-gray-700 border-gray-600 hover:bg-gray-600 text-gray-200'">
                  {{ opt }}
                </button>
              </div>
              <div v-if="wizardStep===2" class="grid grid-cols-2 gap-2">
                 <button v-for="opt in wizardOptions.designs" :key="opt" @click="setWizardDesign(opt)"
                  class="text-left px-3 py-2 rounded border text-xs transition"
                  :class="wizardData.design===opt ? 'bg-pink-700 border-pink-400 text-white' : 'bg-gray-700 border-gray-600 hover:bg-gray-600 text-gray-200'">
                  {{ opt }}
                </button>
              </div>
              <div v-if="wizardStep===3" class="space-y-1">
                 <label v-for="opt in wizardOptions.features" :key="opt" 
                  class="flex items-center gap-2 px-3 py-2 rounded border border-gray-600 bg-gray-700 hover:bg-gray-600 cursor-pointer text-xs text-gray-200">
                  <input type="checkbox" :value="opt" v-model="wizardData.features" class="accent-indigo-400">
                  {{ opt }}
                </label>
              </div>
            </div>

            <div class="flex justify-between pt-2 border-t border-gray-700">
              <button v-if="wizardStep > 1" @click="wizardStep--" class="text-xs px-3 py-1 rounded bg-gray-700 hover:text-white">æˆ»ã‚‹</button>
              <span v-else></span>
              <button v-if="wizardStep < 3" @click="wizardStep++" class="text-xs px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-500">æ¬¡ã¸</button>
              <button v-else @click="completeWizard" class="text-xs px-4 py-1 rounded bg-green-600 text-white hover:bg-green-500 font-bold"><i class="fas fa-check mr-1"></i> ç”Ÿæˆ</button>
            </div>
          </div>

          <textarea v-model="aiPromptInput"
                    class="w-full h-32 bg-gray-800 border border-gray-600 rounded p-3 text-sm text-white focus:border-forge-accent outline-none resize-none"
                    :placeholder="aiTab==='full' ? 'ä¾‹: ã‚·ãƒ³ãƒ—ãƒ«ãªTODOã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã€‚è‰²ã¯é’ãƒ™ãƒ¼ã‚¹ã§ã€‚' : 'ä¾‹: ã€Œä¿å­˜ãƒœã‚¿ãƒ³ã€ã®è‰²ã‚’èµ¤ã«å¤‰æ›´ã—ã¦ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã‚‹ã‚ˆã†ã«ã—ã¦ã€‚'"></textarea>
          <div class="text-[10px] text-gray-500 mt-1">
            â€»ã“ã“ã§ã®æŒ‡ç¤ºã¯ä¸€æ™‚çš„ã«è“„ç©ã•ã‚Œã€ä¿å­˜æ™‚ã®å±¥æ­´ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆåˆæœŸå€¤ï¼‰ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-300 mb-2">ã‚³ãƒ¼ãƒ‰æ·»ä»˜</label>
          <div class="flex flex-col gap-2 bg-gray-900/40 border border-gray-700 rounded p-3">
            <label class="flex items-center gap-2 text-sm text-gray-200 cursor-pointer">
              <input type="radio" class="accent-blue-500" name="ai-attach" :value="true" v-model="aiIncludeFullCode">
              <span class="font-bold text-gray-100">ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ·»ä»˜ã™ã‚‹</span>
              <span class="text-[11px] text-gray-500">ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’çœç•¥ã›ãšã€ã™ã¹ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ï¼‰</span>
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-200 cursor-pointer">
              <input type="radio" class="accent-blue-500" name="ai-attach" :value="false" v-model="aiIncludeFullCode">
              <span class="font-bold text-gray-100">ã‚³ãƒ¼ãƒ‰æ·»ä»˜ã‚’çœç•¥</span>
              <span class="text-[11px] text-gray-500">ï¼ˆAIãŒæ—¢ã«ã‚³ãƒ¼ãƒ‰ã‚’æŠŠæ¡ã—ã¦ã„ã‚‹å‰æï¼‰</span>
            </label>
          </div>
        </div>

                <div class="flex justify-end gap-3 mt-2">
          <button @click="modals.ai = false" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">é–‰ã˜ã‚‹</button>
          <button @click="generateAndCopyPrompt"
                  class="px-6 py-2 rounded font-bold text-white shadow-lg flex items-center gap-2"
                  :class="aiTab==='full' ? 'bg-blue-600 hover:bg-blue-500' : (aiTab==='json' ? 'bg-pink-600 hover:bg-pink-500' : 'bg-yellow-600 hover:bg-yellow-500')">
            <i class="fas fa-magic"></i> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼†ã‚³ãƒ”ãƒ¼
          </button>
        </div>

        <div v-if="aiMessage" class="mt-2 text-center text-xs text-green-400 font-bold">
          {{ aiMessage }}
        </div>
      </div>
    </div>
  </div>

    <div v-if="modals.github" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-6 rounded-lg w-[500px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
        <i class="fas fa-user-secret text-white"></i> é–‹ç™ºè€…å°‚ç”¨
      </h3>
            <p class="text-xs text-gray-400 mb-4">
        ã“ã®ã‚¢ãƒ—ãƒªã®é–‹ç™ºè€…å°‚ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€‚
      </p>

      <div class="space-y-3 mb-4">
        <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">Access Token</label>
          <input v-model="githubSettings.token" type="password" placeholder="ghp_..."
                 class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
        </div>
        <div class="flex gap-2">
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-400 mb-1">Repository Name</label>
            <input v-model="githubSettings.repo" type="text" placeholder="my-app"
                   class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
          </div>
          <div class="w-1/3">
             <label class="block text-xs font-bold text-gray-400 mb-1">Branch</label>
             <input v-model="githubSettings.branch" type="text" placeholder="main"
                    class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-400 mb-1">File Path</label>
          <input v-model="githubSettings.path" type="text" placeholder="index.html"
                 class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
        </div>
      </div>

      <div v-if="githubStatus" class="mb-4 p-2 rounded bg-gray-900 border text-xs whitespace-pre-wrap"
           :class="githubStatus.includes('Error') ? 'border-red-800 text-red-300' : 'border-green-800 text-green-300'">
        {{ githubStatus }}
      </div>
      <div v-if="githubUrl" class="mb-4 text-center">
         <a :href="githubUrl" target="_blank" class="text-blue-400 underline text-xs font-bold">
           <i class="fas fa-external-link-alt"></i> å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’é–‹ã (åæ˜ ã«æ•°åˆ†ã‹ã‹ã‚Šã¾ã™)
         </a>
      </div>

      <div class="flex justify-end gap-2 pt-2 border-t border-gray-700">
        <button @click="modals.github = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600 text-white">é–‰ã˜ã‚‹</button>
        <button @click="publishToGithub" class="px-4 py-2 text-sm rounded bg-gray-100 hover:bg-white text-gray-900 font-bold shadow-lg">
          <i class="fas fa-cloud-upload-alt mr-1"></i> Upload
        </button>
      </div>
    </div>
  </div>

  <div v-if="modals.save" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-6 rounded-lg w-[480px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
        <i class="fas fa-save text-blue-400"></i> ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
      </h3>

      <div class="mb-3 text-[11px] text-gray-400">
        <span v-if="appMode==='project'">
          ä¿å­˜å…ˆ: <span class="font-bold text-gray-100">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å†…</span>
        </span>
        <span v-else>
          ä¿å­˜å…ˆ: <span class="font-bold text-gray-100">æ¯å›æŒ‡å®š</span>ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚ã¦é¸æŠã§ãã¾ã™ï¼‰
        </span>
      </div>

      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">ãƒ•ã‚¡ã‚¤ãƒ«å (ç·¨é›†å¯èƒ½)</label>
        <input v-model="saveFilename" type="text"
               class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
        <p class="text-[10px] text-gray-500 mt-1">â€»è‡ªå‹•çš„ã«æ—¥æ™‚ãŒä»˜ä¸ã•ã‚Œã¾ã™ï¼ˆå¤‰æ›´å¯ï¼‰ã€‚</p>
      </div>

      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">å¤‰æ›´å±¥æ­´ãƒ¡ãƒ¢ï¼ˆAIæŒ‡ç¤ºãŒè‡ªå‹•å…¥åŠ›ï¼‰</label>
        <textarea v-model="saveComment"
                  class="w-full h-20 bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none resize-none"></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="modals.save = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button @click="performSave" class="px-4 py-2 text-sm rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">ä¿å­˜å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>

  <div v-if="modals.patch" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-0 rounded-lg w-[92%] max-w-[980px] h-[90vh] shadow-2xl border border-gray-600 flex flex-col overflow-hidden">
            <div class="flex border-b border-gray-600 bg-gray-800 flex-shrink-0">
                                <button @click="patchMode='full'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="patchMode==='full' ? 'bg-forge-700 text-blue-400 border-b-2 border-blue-400' : 'text-gray-400 hover:text-white'">
          â‘  ã¾ã‚‹ã”ã¨æ›´æ–° (Full)
        </button>
        <button @click="patchMode='manual'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="patchMode==='manual' ? 'bg-forge-700 text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400 hover:text-white'">
          â‘¡ æ‰‹å‹•ã§æ›´æ–° (Manual)
        </button>
        <button @click="patchMode='json'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="patchMode==='json' ? 'bg-forge-700 text-pink-400 border-b-2 border-pink-400' : 'text-gray-400 hover:text-white'">
          â‘¢ è‡ªå‹•ã§æ›´æ–° (Auto)
        </button>
      </div>

            <div class="p-6 flex-1 flex flex-col overflow-hidden bg-forge-900">
        <div class="flex-shrink-0 mb-3" v-if="!patchHelp">
           <button @click="patchHelp = true" class="w-full text-xs bg-gray-800 text-gray-400 border border-gray-700 border-dashed px-2 py-1.5 rounded hover:bg-gray-700 hover:text-yellow-200 transition flex items-center justify-center gap-2">
             <i class="fas fa-life-ring"></i> ã©ã£ã¡ã®ç”»é¢ã‚’ä½¿ãˆã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„æ™‚ã¯ã“ã¡ã‚‰
           </button>
        </div>
                <div v-else class="flex-shrink-0 mb-3 bg-gray-800/90 border border-yellow-700/40 rounded-lg p-3 text-xs text-gray-300 relative animate-fade-in">
          <div class="absolute top-2 right-2 text-gray-500 cursor-pointer hover:text-white" @click="patchHelp=false"><i class="fas fa-times"></i></div>
          <p class="font-bold text-yellow-400 border-b border-gray-700 pb-1 mb-2"><i class="fas fa-check-circle mr-1"></i> AIã‹ã‚‰ã®è¿”ç­”ã«åˆã‚ã›ã¦é¸ã³ã¾ã—ã‚‡ã†</p>
                    <div class="flex gap-2">
                        <div class="flex-1 bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-blue-500 transition" @click="patchMode='full'">
              <strong class="text-blue-300 block mb-1">â‘  ã¾ã‚‹ã”ã¨æ›´æ–°</strong>
              <p class="text-[10px] text-gray-400 mb-1">AIãŒã€Œæ–°ã—ã„HTMLã‚³ãƒ¼ãƒ‰å…¨ä½“ã€ã‚’ä½œã£ãŸå ´åˆ</p>
            </div>
            <div class="flex-1 bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-yellow-500 transition" @click="patchMode='manual'">
              <strong class="text-yellow-300 block mb-1">â‘¡ æ‰‹å‹•ã§æ›´æ–°</strong>
              <p class="text-[10px] text-gray-400 mb-1">AIãŒã€Œå¤‰æ›´å‰ã€ã€Œå¤‰æ›´å¾Œã€ã‚’æç¤ºã—ãŸå ´åˆ</p>
            </div>
            <div class="flex-1 bg-gray-900/50 p-2 rounded border border-gray-700 cursor-pointer hover:border-pink-500 transition" @click="patchMode='json'">
              <strong class="text-pink-300 block mb-1">â‘¢ è‡ªå‹•ã§æ›´æ–°</strong>
              <p class="text-[10px] text-gray-400 mb-1">AIãŒã€ŒJSONãƒ‡ãƒ¼ã‚¿ã€ã‚’æç¤ºã—ãŸå ´åˆ</p>
            </div>
          </div>
        </div>

                <template v-if="patchMode==='full'">
          <div class="flex items-center justify-between gap-2 flex-shrink-0">
            <p class="text-xs text-gray-400">
              AIãŒå‡ºåŠ›ã—ãŸã€Œæ–°ã—ã„HTMLã‚³ãƒ¼ãƒ‰å…¨ä½“ã€ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¨å®Œå…¨ã«å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚
            </p>
          </div>
                    <div class="flex-1 flex flex-col mt-3">
            <textarea v-model="patchFullInput"
                      class="flex-1 bg-gray-900 border border-blue-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-blue-500 outline-none resize-none whitespace-pre"
                      placeholder="<!DOCTYPE html>..."></textarea>
          </div>
          <div class="flex justify-end gap-2 mt-3 flex-shrink-0">
            <button @click="modals.patch = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">é–‰ã˜ã‚‹</button>
                                                <button @click="applyFullCode" class="px-6 py-2 text-sm rounded bg-blue-700 hover:bg-blue-600 text-white font-bold shadow-lg">
              <i class="fas fa-file-import mr-1"></i> ã‚¢ãƒ—ãƒªã‚’ã™ã¹ã¦æ›´æ–°
            </button>
          </div>
        </template>

        <template v-else-if="patchMode==='manual'">
          <div class="flex items-center justify-between gap-2 flex-shrink-0">
            <p class="text-xs text-gray-400">
              AIãŒå‡ºåŠ›ã—ãŸã€Œå¤‰æ›´å‰ã®ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œå¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
            </p>
            <label class="flex items-center gap-2 text-xs text-gray-200 select-none cursor-pointer bg-gray-900/40 border border-gray-700 rounded px-3 py-1.5">
              <input type="checkbox" v-model="patchIgnoreWhitespace" class="accent-yellow-500">
              <span class="font-bold">æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–ã—ã¦æ¤œç´¢</span>
              <span class="text-gray-500">(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON)</span>
            </label>
          </div>

          <div class="flex-1 flex flex-col gap-3 overflow-hidden mt-3">
            <div class="flex-1 flex flex-col min-h-[180px]">
              <div class="flex justify-between items-end mb-1">
                <label class="text-xs font-bold text-red-300"><i class="fas fa-search"></i> æ¤œç´¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ (ç½®æ›å…ƒ)</label>
                                <span v-if="patchFindInput" class="text-xs font-bold"
                      :class="patchMatchCount > 0 ? 'text-red-400' : (patchMatchMessage.includes('ã‚‚ã—ã‹ã—ã¦') ? 'text-yellow-400 animate-pulse' : 'text-gray-500')">
                  {{ patchMatchMessage }}
                </span>
              </div>
              <textarea v-model="patchFindInput"
                        class="flex-1 bg-gray-900 border border-red-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-red-500 outline-none resize-y whitespace-pre"
                        placeholder="ã“ã“ã«ç½®æ›å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ï¼ˆæ”¹è¡ŒOKï¼‰..."></textarea>
            </div>
            <div class="flex justify-center items-center flex-shrink-0 text-gray-500 h-4">
              <i class="fas fa-arrow-down"></i>
            </div>
            <div class="flex-1 flex flex-col min-h-[180px]">
              <label class="text-xs font-bold text-green-300 mb-1"><i class="fas fa-pen"></i> ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ (æ–°ã—ã„ã‚³ãƒ¼ãƒ‰)</label>
              <textarea v-model="patchReplaceInput"
                        class="flex-1 bg-gray-900 border border-green-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-green-500 outline-none resize-y whitespace-pre"
                        placeholder="...ã“ã“ã«ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ï¼ˆæ”¹è¡ŒOKï¼‰"></textarea>
            </div>
          </div>

          <div class="flex justify-end gap-2 mt-3 flex-shrink-0">
            <button @click="modals.patch = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">é–‰ã˜ã‚‹</button>
                        <button @click="applyPatch" class="px-6 py-2 text-sm rounded bg-yellow-700 hover:bg-yellow-600 text-white font-bold shadow-lg">
              æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹
            </button>
          </div>
        </template>

        <template v-else>
          <div class="flex items-center justify-between gap-2 flex-shrink-0">
            <p class="text-xs text-gray-400">
              AIãŒå‡ºåŠ›ã—ãŸã€ŒAIãŒç†è§£ã—ã‚„ã™ã„å°‚ç”¨ã®è¨€è‘‰ï¼ˆJSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã€ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
            </p>
            <label class="flex items-center gap-2 text-xs text-gray-200 select-none cursor-pointer bg-gray-900/40 border border-gray-700 rounded px-3 py-1.5">
              <input type="checkbox" v-model="patchIgnoreWhitespace" class="accent-pink-500">
              <span class="font-bold">æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–</span>
            </label>
          </div>

                    <div class="flex-1 flex flex-col mt-3">
                        <textarea v-model="patchJsonInput"
                    class="flex-1 bg-gray-900 border border-pink-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-pink-500 outline-none resize-none whitespace-pre"
                    placeholder='[
  {
    "search": "...",
    "replace": "..."
  }
]'></textarea>
            <div v-if="patchJsonStatus" class="mt-2 animate-fade-in">
              <div class="px-3 py-2 rounded border text-xs font-bold flex items-center gap-2 select-none"
                   :class="[patchJsonStatus.type === 'error' ? 'bg-red-900/30 border-red-700/50 text-red-300' : 'bg-green-900/30 border-green-700/50 text-green-300']">
                <i class="fas" :class="patchJsonStatus.type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'"></i>
                <span class="flex-1">{{ patchJsonStatus.message }}</span>
              </div>
              <div v-if="patchJsonStatus.type === 'error'" class="mt-2 flex gap-2">
                <button @click="copyRecoveryPrompt('manual')" 
                        class="flex-1 py-2 bg-yellow-900/30 hover:bg-yellow-800/50 border border-yellow-700/50 text-yellow-200 rounded text-[10px] flex flex-col items-center gap-1 transition group"
                        title="AIã«ä¿®æ­£ç®‡æ‰€ã‚’æ•´ç†ã•ã›ã€æ‰‹å‹•ã§åæ˜ ã—ã¾ã™">
                                      <div class="font-bold group-hover:text-white"><i class="fas fa-tools"></i> æ‰‹å‹•ã§ä¿®æ­£</div>
                   <div class="opacity-60 scale-90 group-hover:opacity-100">æ›´æ–°å…ˆ: â‘¡æ‰‹å‹•ã§æ›´æ–°</div>
                </button>
                <button @click="copyRecoveryPrompt('full')" 
                        class="flex-1 py-2 bg-blue-900/30 hover:bg-blue-800/50 border border-blue-700/50 text-blue-200 rounded text-[10px] flex flex-col items-center gap-1 transition group"
                        title="ã€åˆå¿ƒè€…å‘ã‘ã€‘ã‚³ãƒ¼ãƒ‰ã‚’ã„ã˜ã‚‰ãšã€å…¨ã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚Šç›´ã—ã¾ã™">
                   <div class="font-bold group-hover:text-white"><i class="fas fa-redo"></i> ã¾ã‚‹ã”ã¨ä½œã‚Šç›´ã—</div>
                   <div class="opacity-60 scale-90 group-hover:opacity-100">æ›´æ–°å…ˆ: â‘ ã¾ã‚‹ã”ã¨æ›´æ–°</div>
                </button>
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-2 mt-3 flex-shrink-0">
            <button @click="modals.patch = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">é–‰ã˜ã‚‹</button>
                        <button @click="applyAutoJsonPatch" class="px-6 py-2 text-sm rounded bg-pink-700 hover:bg-pink-600 text-white font-bold shadow-lg">
              <i class="fas fa-magic mr-1"></i> è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œ
            </button>
          </div>
        </template>
      </div>
    </div>
  </div>

  <div v-if="modals.db" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-lg w-[92%] max-w-[900px] h-[84vh] shadow-2xl border border-gray-600 flex flex-col">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-blue-300 flex items-center gap-2">
          <i class="fas fa-database"></i> IndexedDB ç°¡æ˜“è¡¨ç¤º
        </h3>
        <div class="flex items-center gap-2">
          <button @click="refreshDbDump"
                  class="px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-xs font-bold">
            <i class="fas fa-rotate"></i> å†å–å¾—
          </button>
          <button @click="modals.db=false"
                  class="px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-xs font-bold">
            <i class="fas fa-times"></i> é–‰ã˜ã‚‹
          </button>
        </div>
      </div>

      <div class="mt-2 text-[11px] text-gray-400 leading-relaxed">
        ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´(iframe)ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å–å¾—ã—ã¾ã™ã€‚<br>
        ãƒ»å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ <span class="kbd">indexedDB.databases()</span> ã‚’ä½¿ã„ã¾ã™ï¼ˆæœªå¯¾å¿œã®å ´åˆã¯ä¸€éƒ¨æƒ…å ±ã®ã¿ï¼‰ã€‚
      </div>

      <div class="mt-4 flex-1 overflow-auto bg-gray-900/50 border border-gray-700 rounded p-3">
        <div v-if="dbDump.loading" class="text-gray-400 text-sm">
          <i class="fas fa-spinner fa-spin"></i> å–å¾—ä¸­...
        </div>

        <div v-else-if="dbDump.error" class="text-red-300 text-sm whitespace-pre-wrap">
          {{ dbDump.error }}
        </div>

        <div v-else-if="dbDump.items.length===0" class="text-gray-400 text-sm">
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯æœªå¯¾å¿œï¼‰ã€‚
        </div>

        <div v-else class="space-y-3">
          <div v-for="db in dbDump.items" :key="db.name"
               class="rounded border border-gray-700 bg-gray-800/60 overflow-hidden">
            <div class="px-3 py-2 bg-gray-900/70 border-b border-gray-700 flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="text-sm font-bold text-gray-100 truncate">
                  {{ db.name }} <span class="text-[11px] text-gray-400 font-normal">v{{ db.version }}</span>
                </div>
                <div class="text-[11px] text-gray-400">
                  stores: {{ db.stores?.length || 0 }}
                </div>
              </div>
              <button class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700"
                      @click="db.open=!db.open">
                {{ db.open ? 'é–‰ã˜ã‚‹' : 'é–‹ã' }}
              </button>
            </div>

            <div v-if="db.open" class="p-3 space-y-2">
              <div v-if="(db.stores||[]).length===0" class="text-gray-400 text-sm">
                storeæƒ…å ±ãªã—ï¼ˆå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰
              </div>
              <div v-for="st in (db.stores||[])" :key="st.name"
                   class="rounded border border-gray-700 bg-gray-900/60 p-2">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-bold text-blue-200">{{ st.name }}</div>
                  <div class="text-[11px] text-gray-400">count: {{ st.count }}</div>
                </div>
                <div class="text-[11px] text-gray-400 mt-1 break-all">
                  keyPath: {{ st.keyPath ?? '(none)' }} / autoIncrement: {{ st.autoIncrement ? 'true' : 'false' }}
                </div>
                <details class="mt-2">
                  <summary class="text-[11px] text-gray-300 cursor-pointer">ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ¼ï¼ˆæœ€å¤§20ä»¶ï¼‰</summary>
                  <pre class="mt-2 text-[10px] text-gray-200 whitespace-pre-wrap">{{ JSON.stringify(st.sampleKeys||[], null, 2) }}</pre>
                </details>
              </div>
            </div>
          </div>
        </div>

        <div class="text-[10px] text-gray-500">
          â€» ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ã®DBå–å¾—ã¯ã€Œèª­ã¿å–ã‚Šã®ã¿ã€ã§ã™ï¼ˆå‰Šé™¤/æ›´æ–°ã¯ã—ã¾ã›ã‚“ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <div v-if="modals.help" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-0 rounded-lg w-[800px] max-w-full h-[85vh] shadow-2xl border border-gray-600 flex flex-col overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 bg-gray-800 border-b border-gray-700 flex-shrink-0">
        <div class="flex items-center gap-4">
          <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <i class="fas fa-book-open text-green-400"></i> AppStudio ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
          </h3>
                    <div class="flex bg-gray-900 rounded p-1 gap-1">
            <button @click="helpTab='beginner'" 
                    class="px-3 py-1 rounded text-xs font-bold transition"
                    :class="helpTab==='beginner' ? 'bg-green-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'">
              ğŸ”° åˆç´š
            </button>
            <button @click="helpTab='intermediate'" 
                    class="px-3 py-1 rounded text-xs font-bold transition"
                    :class="helpTab==='intermediate' ? 'bg-yellow-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'">
              âš¡ å®Ÿè·µãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
            </button>
            <button @click="helpTab='advanced'" 
                    class="px-3 py-1 rounded text-xs font-bold transition"
                    :class="helpTab==='advanced' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'">
              ğŸ”§ æŠ€è¡“è§£èª¬
            </button>
          </div>
        </div>
        <button @click="markHelpSeen" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>

            <div class="flex-1 overflow-y-auto p-8 text-gray-300 bg-forge-900">
        
        
        <div v-if="helpTab==='beginner'" class="space-y-10 animate-fade-in">
                    <section class="space-y-6">
            <h4 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">
              ğŸš€ AppStudioã£ã¦ä½•ï¼Ÿ (AIã¨ã®é–¢ä¿‚)
            </h4>

            
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-600 shadow-lg">
              <h5 class="text-lg font-bold text-blue-300 mb-3 flex items-center gap-2">
                <i class="fas fa-bridge"></i> â‘  äººé–“ã¨AIã®ã€Œæ©‹æ¸¡ã—ã€å½¹
              </h5>
              <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                ã“ã®ã‚¢ãƒ—ãƒªè‡ªä½“ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è€ƒãˆã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                <b>ã€Œã‚ãªãŸã®ã‚¢ã‚¤ãƒ‡ã‚¢ã€</b>ã‚’<b>ã€ŒAIã¸ã®æœ€é©ãªæŒ‡ç¤ºã€</b>ã«ç¿»è¨³ã—ã€AIãŒä½œã£ãŸã‚³ãƒ¼ãƒ‰ã‚’<b>ã€Œå‹•ãã‚¢ãƒ—ãƒªã€</b>ã«çµ„ã¿ç«‹ã¦ã‚‹å·¥å ´ã§ã™ã€‚
              </p>

                            <div class="flex flex-col md:flex-row items-center justify-between gap-4 bg-gray-900/50 p-4 rounded-lg border border-gray-700 mb-4">
                <div class="text-center">
                  <div class="text-3xl mb-1">ğŸ‘¤</div>
                  <div class="text-xs font-bold text-yellow-300">ã‚ãªãŸ</div>
                  <div class="text-[10px] text-gray-400">ã‚¢ã‚¤ãƒ‡ã‚¢</div>
                </div>
                <i class="fas fa-arrow-right text-gray-500 hidden md:block"></i>
                <i class="fas fa-arrow-down text-gray-500 md:hidden"></i>
                <div class="text-center bg-blue-900/30 p-2 rounded border border-blue-500/30">
                  <div class="text-2xl mb-1">ğŸ› ï¸</div>
                  <div class="text-xs font-bold text-blue-300">AppStudio</div>
                  <div class="text-[10px] text-gray-400">æŒ‡ç¤ºä½œæˆãƒ»å®Ÿè¡Œãƒ»è‡ªå‹•ä¿®æ­£</div>
                </div>
                                <div class="flex flex-col items-center gap-0.5">
                  <div class="text-xl">ğŸ‘¤</div>
                  <span class="text-[9px] text-gray-400">ã‚³ãƒ”ãƒš (æ‰‹å‹•)</span>
                  <i class="fas fa-exchange-alt text-gray-500 text-xs"></i>
                </div>
                <div class="text-center">
                  <div class="text-3xl mb-1">ğŸ¤–</div>
                  <div class="text-xs font-bold text-purple-300">ç”ŸæˆAI</div>
                  <div class="text-[10px] text-gray-400">ã‚³ãƒ¼ãƒ‰ä½œæˆãƒ»æ€è€ƒãƒ»ç›¸è«‡</div>
                </div>
              </div>

              <div class="space-y-3">
                <div class="flex gap-3 items-start bg-gray-700/30 p-2 rounded">
                  <i class="fas fa-magic text-yellow-400 mt-1"></i>
                  <div>
                    <strong class="text-yellow-200 text-xs">æœ€å¤§ã®æ­¦å™¨ï¼šè‡ªå‹•ä¿®æ­£ (Auto Patch)</strong>
                    <p class="text-[11px] text-gray-400 mt-1">
                      ã‚¢ãƒ—ãƒªä½œã‚Šã§ä¸€ç•ªé›£ã—ã„ã®ã¯ã€Œä¸å…·åˆã®ä¿®æ­£ã€ã€Œæ©Ÿèƒ½è¿½åŠ ãƒ»æ”¹é€ ã€ã§ã™ã€‚äººé–“ãŒã‚³ãƒ¼ãƒ‰ã‚’ç›´ã™ã®ã¯AIã‚’ä½¿ã£ãŸã¨ã—ã¦ã‚‚å¤§å¤‰ã§ã™ã€‚AIã¯ä¸å…·åˆã‚’ç›´ã™ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä¿®æ­£ã¯å¾—æ„ã§ã™ãŒã€åˆå¿ƒè€…ã§ã‚‚åˆ†ã‹ã‚‹ã‚ˆã†ã«ã¯ãªã‹ãªã‹ä¼ãˆã¦ãã‚Œãªã„ã‹ã‚‰ã§ã™ã€‚
                      AppStudioã¯ã‚ãªãŸã®ã€Œã“ã†ç›´ã—ã¦ã»ã—ã„ã€ã€Œã“ã‚“ãªæ”¹é€ ã‚’ã—ãŸã„ã€ã¨ã„ã†è¦æœ›ã‚’ã‚‚ã¨ã«ã€AIå‘ã‘ã®ç‰¹æ®ŠãªæŒ‡ç¤ºã‚’ç”Ÿæˆã—ã€<b>AIã®å›ç­”ã‚’ã‚‚ã¨ã«ã€æ•°åã‹æ‰€ã«ã‚‚ã®ã¼ã‚‹è¤‡é›‘ãªä¿®æ­£ã§ã‚‚ä¸€ç™ºã§è‡ªå‹•é©ç”¨</b>ã•ã›ã¾ã™ã€‚
                      ãƒ—ãƒ­å‘ã‘ã®æœ‰æ–™ã‚½ãƒ•ãƒˆã‚¦ã‚¨ã‚¢ï¼ˆCursorãªã©ï¼‰ã«è¿‘ã„æ©Ÿèƒ½ã‚’ã€èª°ã§ã‚‚ã€ã©ã‚“ãªç’°å¢ƒã§ã‚‚åˆ©ç”¨å¯èƒ½ã¨ã—ãŸç‚¹ãŒã€ã“ã®ã‚¢ãƒ—ãƒªã®æœ€å¤§ã®ç‰¹å¾´ã§ã™ã€‚
                    </p>
                  </div>
                </div>
                <div class="flex gap-3 items-start bg-gray-700/30 p-2 rounded">
                  <i class="fas fa-comments text-teal-400 mt-1"></i>
                  <div>
                    <strong class="text-teal-200 text-xs">AIã¸ã®ç›¸è«‡ã‚‚ã‚µãƒãƒ¼ãƒˆ</strong>
                    <p class="text-[11px] text-gray-400 mt-1">
                      ã€Œæ¬¡ã¯ä½•ã‚’ä½œã‚Œã°ã„ã„ï¼Ÿã€ã¨ã„ã£ãŸç›¸è«‡ã‚‚ã€AIãŒç­”ãˆã‚„ã™ã„å½¢ã«æ•´ãˆã¦è³ªå•ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚’å®¢è¦³çš„ã«è©•ä¾¡ã—ã€100ç‚¹æº€ç‚¹ã§ç‚¹æ•°ã‚’ã¤ã‘ã€ã•ã‚‰ã«æ”¹å–„ææ¡ˆã‚’AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µãƒ³ãƒ—ãƒ«ä»˜ãã§ãŠé¡˜ã„ã™ã‚‹ã€ã¨ã„ã†ã“ã¨ã‚‚ã€ã“ã®ã‚¢ãƒ—ãƒªãªã‚‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã™ã‚‹ã ã‘ã§å®Ÿç¾ã§ãã¾ã™ã€‚
                    </p>
                  </div>
                </div>
              </div>
            </div>

            
            <div class="bg-gray-800 p-5 rounded-xl border border-gray-600 shadow-lg">
              <h5 class="text-lg font-bold text-green-300 mb-3 flex items-center gap-2">
                <i class="fas fa-history"></i> â‘¡ å¤±æ•—ã—ã¦ã‚‚å¤§ä¸ˆå¤« (å±¥æ­´ç®¡ç†)
              </h5>
              <p class="text-sm text-gray-300 mb-3 leading-relaxed">
                å¤±æ•—ã‚’æã‚Œã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                AppStudioã¯ã€<b>ã€Œã„ã¤ã€ã©ã‚“ãªæŒ‡ç¤ºã§ä¿å­˜ã—ãŸã‹ã€</b>ã‚’å…¨ã¦è¨˜éŒ²ã—ã¦ã„ã¾ã™ã€‚
              </p>
              <ul class="list-disc list-inside text-xs text-gray-400 space-y-1 ml-1">
                <li>AIã¸ã®æŒ‡ç¤ºå±¥æ­´ã¨ã€ãã®æ™‚ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆã§ä¿å­˜ã€€â€»ã“ã¾ã‚ã«ä¿å­˜ã—ã¾ã—ã‚‡ã†</li>
                <li>ã€Œã•ã£ãã®çŠ¶æ…‹ã«æˆ»ã—ãŸã„ï¼ã€ã¨æ€ã£ãŸã‚‰ã€å·¦ã®å±¥æ­´ã‹ã‚‰ã™ãã«å¾©å…ƒå¯èƒ½</li>
                <li>å®‰å¿ƒã—ã¦ã©ã‚“ã©ã‚“ä¿®æ­£ãƒ»å®Ÿé¨“ãŒã§ãã¾ã™</li>
              </ul>
            </div>
          </section>

          <section>
            <h4 class="text-lg font-bold text-blue-300 mb-4 flex items-center gap-2">
              <i class="fas fa-route"></i> é–‹ç™ºã®4ã‚¹ãƒ†ãƒƒãƒ—
            </h4>
            
            <div class="space-y-6 relative border-l-2 border-gray-700 ml-3 pl-6 pb-2">
              
              <div class="relative">
                <span class="absolute -left-[33px] top-0 w-8 h-8 bg-blue-900 border-2 border-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs">1</span>
                <h5 class="font-bold text-white mb-1">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™</h5>
                <p class="text-xs text-gray-400 mb-2">
                  ã¾ãšã¯å·¦ä¸Šã®ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ <i class="fas fa-folder text-yellow-500"></i> ã‹ã‚‰é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã³ã¾ã™ã€‚
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                  <div class="bg-gray-800 p-2 rounded border border-gray-700">
                    <strong class="text-blue-300">ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ (æ¨å¥¨)</strong><br>
                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯ã€ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚’å®Œæˆã•ã›ã‚‹ãŸã‚åˆ©ç”¨ã™ã‚‹ã²ã¨ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ã¨è€ƒãˆã¦ãã ã•ã„ã€‚ã‚¢ãƒ—ãƒªã¥ãã‚Šã§ã¯è©¦è¡ŒéŒ¯èª¤ã®ä¸­ã§ã€ãŸãã•ã‚“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒ—ãƒªãŒç”Ÿã¾ã‚Œã¾ã™ã€‚AppStudioã¯ã€æ–°ãŸãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒ—ãƒªã‚’ä¿å­˜ã™ã‚‹ãŸã³ã«æ›´æ–°å±¥æ­´ã‚’æ®‹ã—ã¾ã™ã€‚ã„ã¤ã§ã‚‚éå»ã®çŠ¶æ…‹ã«æˆ»ã›ã‚‹ã®ã§ã€ã‚¢ãƒ—ãƒªãŒå£Šã‚Œã‚‹ã“ã¨ã‚’æã‚Œãšã€å¤§èƒ†ãªæŒ‘æˆ¦ãŒå¯èƒ½ã§ã™ã€‚
                  </div>
                  <div class="bg-gray-800 p-2 rounded border border-gray-700">
                    <strong class="text-green-300">ğŸ“„ å˜ç™ºã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰</strong><br>
                    å±¥æ­´ç®¡ç†ãªã—ã§ã€1æšã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µã‚¯ãƒƒã¨ä½œã‚ŠãŸã„æ™‚ã«ä½¿ã„ã¾ã™ã€‚æœ¬æ ¼çš„ã«ä½•ã‹ã®ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã‚ã‘ã§ã¯ãªã„ã‘ã‚Œã©ã€ã“ã‚“ãªã“ã¨ãŒã§ãã‚‹ã‹è©¦ã—ã¦ã¿ã‚ˆã†ã€ã¨ã„ã†ã¨ãã«ãŠå‹§ã‚ã§ã™ã€‚
                  </div>
                </div>
              </div>

              <div class="relative">
                <span class="absolute -left-[33px] top-0 w-8 h-8 bg-gray-700 border-2 border-gray-500 rounded-full flex items-center justify-center text-white font-bold text-xs">2</span>
                <h5 class="font-bold text-white mb-1">å®Ÿè¡Œãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                <p class="text-xs text-gray-400 mb-2">
                  ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹çŠ¶æ…‹ã§ <button class="px-2 py-0.5 bg-green-700 text-white rounded text-[10px]"><i class="fas fa-play"></i> å®Ÿè¡Œ</button> ã‚’æŠ¼ã™ã¨ã€å³å´ã®ç”»é¢ã§ã‚¢ãƒ—ãƒªãŒå‹•ãã¾ã™ã€‚
                </p>
                <ul class="list-disc list-inside text-xs text-gray-400">
                  <li>ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã§ã€ã‚¹ãƒãƒ›ã‚„PCã®ç”»é¢ã‚µã‚¤ã‚ºã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                  <li><i class="fas fa-external-link-alt"></i> <b>åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦è¡¨ç¤º</b>ã‚’ä½¿ã†ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å…¨ç”»é¢ã§å‹•ä½œç¢ºèªã§ãã€ã‚ˆã‚Šåºƒãç”»é¢ã‚’ä½¿ãˆã¾ã™ã€‚</li>
                </ul>
              </div>

                            <div class="relative">
                <span class="absolute -left-[33px] top-0 w-8 h-8 bg-purple-900 border-2 border-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xs">3</span>
                <h5 class="font-bold text-white mb-1">AIã«æŒ‡ç¤ºãƒ»ä¿®æ­£</h5>
                <p class="text-xs text-gray-400 mb-3">
                  <button class="px-2 py-0.5 bg-purple-800 text-purple-100 border border-purple-600 rounded text-[10px]"><i class="fas fa-robot"></i> AIæŒ‡ç¤º</button> ãƒœã‚¿ãƒ³ã®ä½¿ã„åˆ†ã‘ãŒé‡è¦ã§ã™ã€‚
                </p>
                
                <div class="space-y-3">
                  
                  <div class="bg-gray-800/80 p-3 rounded border border-blue-900/50">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">æœ€åˆ</span>
                      <strong class="text-blue-200 text-xs">ã‚¢ãƒ—ãƒªã‚’æ–°è¦ä½œæˆã™ã‚‹ã¨ã</strong>
                    </div>
                    <div class="pl-2 border-l-2 border-blue-600/30">
                      <span class="text-blue-300 font-bold text-xs block mb-1">â‘  å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (Full)</span>
                      <p class="text-[11px] text-gray-400 leading-relaxed">
                        ã€Œã€‡ã€‡ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã€ã¨æŒ‡ç¤ºã—ã€AIã«ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ä½œã‚‰ã›ã¾ã™ã€‚<br>
                        ã§ããŸã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«<b>ã€Œå…¨ã‚¯ãƒªã‚¢ã€â†’ã€Œè²¼ã‚Šä»˜ã‘ã€</b>ã—ã¾ã™ã€‚
                      </p>
                    </div>
                  </div>

                  
                  <div class="bg-gray-800/80 p-3 rounded border border-pink-900/50">
                    <div class="flex items-center gap-2 mb-2">
                      <span class="bg-pink-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold">ä¿®æ­£</span>
                      <strong class="text-pink-200 text-xs">æ©Ÿèƒ½è¿½åŠ ãƒ»ç”»é¢èª¿æ•´ãƒ»ãƒã‚°ä¿®æ­£</strong>
                    </div>
                    
                    <div class="pl-2 border-l-2 border-pink-600/30 space-y-3">
                      <div>
                        <span class="text-pink-300 font-bold text-xs block mb-1">â‘¢ éƒ¨åˆ†ä¿®æ­£ (ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆ) <span class="text-pink-500 text-[10px] ml-1">â˜…åŸºæœ¬ã¯ã‚³ãƒ¬</span></span>
                        <p class="text-[11px] text-gray-400 leading-relaxed">
                          AIãŒä½œã£ãŸã€Œå°‚ç”¨JSONã€ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ã€ä¸€æ‹¬ã§è‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã™ã€‚
                        </p>
                      </div>

                      
                                            <div class="bg-gray-900/50 p-2 rounded text-[10px] text-gray-500">
                        <div class="font-bold text-gray-400 mb-1"><i class="fas fa-exclamation-circle text-yellow-500 mr-1"></i>ã†ã¾ãã„ã‹ãªã„æ™‚ã¯ï¼Ÿ</div>
                        <p class="mb-2 leading-relaxed">
                          AIã¯ã€Œæ¤œç´¢å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰(search)ã€ã‚’ä¸€å­—ä¸€å¥é–“é•ãˆãšã«å†ç¾ã™ã‚‹ã®ãŒè‹¦æ‰‹ã§ã™ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã®æ•°ã‚„æ”¹è¡Œä½ç½®ãªã©ã€‚Copilotã®å ´åˆã¯æ–‡å­—åŒ–ã‘çš„äº‹è±¡ã‚‚ç™ºç”Ÿï¼‰ã€‚<br>
                          AppStudioã¯ãã®ã‚ˆã†ãªå ´åˆã§ã‚‚ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆä¿®æ­£ã‚’å¯èƒ½ã¨ã™ã‚‹ä»•çµ„ã¿ã‚’æŒã¡ã¾ã™ãŒã€ãã‚Œã§ã‚‚å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
                        </p>
                        <div class="flex flex-col gap-2">
                          <div class="flex items-start gap-2">
                            <i class="fas fa-arrow-turn-down text-gray-600 mt-1"></i>
                            <div>
                              <strong class="text-yellow-500">â‘¡ éƒ¨åˆ†ä¿®æ­£ (æ‰‹å‹•)</strong>
                              <div class="text-gray-400">ã€Œå¤‰æ›´å‰ã€ã€Œå¤‰æ›´å¾Œã€ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œè²¼ã‚Šä»˜ã‘ã¦æ‰‹å‹•ç½®æ›ã—ã¾ã™ã€‚ãƒ¯ãƒ¼ãƒ‰ã®æ¤œç´¢ãƒ»ç½®æ›æ©Ÿèƒ½ã¨åŒã˜ã¨è€ƒãˆã¦ãã ã•ã„ã€‚æ·±ãè€ƒãˆãšã€AIã®æŒ‡ç¤ºé€šã‚Šç½®æ›ã—ã¾ã—ã‚‡ã†ã€‚</div>
                            </div>
                          </div>
                          <div class="flex items-start gap-2">
                            <i class="fas fa-arrow-turn-down text-gray-600 mt-1"></i>
                            <div>
                              <strong class="text-blue-400">â‘  å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (ä½œã‚Šç›´ã—)</strong>
                              <div class="text-gray-400">ã©ã†ã—ã¦ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€Œä»Šã®ã‚³ãƒ¼ãƒ‰ã€ã‚’æ·»ä»˜ã—ã¦ã€Œå…¨ä½“ã‚’ä½œã‚Šç›´ã—ã¦ã€ã¨é ¼ã¿ã¾ã™ã€‚AIã®è€ƒãˆã‚‹æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€ç°¡å˜ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ãªã‚‰ã“ã‚Œã§ã‚‚OKã§ã™ã€‚ãŸã ã—ã€è¤‡é›‘ã§é•·ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å ´åˆã€AIãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¦šãˆãã‚‰ãªããªã‚Šã€å‹æ‰‹ã«å…ƒã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰ãˆã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="relative">
                <span class="absolute -left-[33px] top-0 w-8 h-8 bg-blue-900 border-2 border-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xs">4</span>
                <h5 class="font-bold text-white mb-1">ä¿å­˜ãƒ»å±¥æ­´ç®¡ç†</h5>
                <p class="text-xs text-gray-400">
                  <button class="px-2 py-0.5 bg-blue-600 text-white rounded text-[10px]"><i class="fas fa-save"></i> ä¿å­˜</button> ã‚’æŠ¼ã™ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
                  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€ä¿å­˜ã®ãŸã³ã«æ—¥æ™‚ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å±¥æ­´ãŒç©ã¿ä¸ŠãŒã‚Šã¾ã™ã€‚
                  å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã„ã¤ã§ã‚‚éå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¾©å…ƒï¼ˆèª­ã¿è¾¼ã¿ï¼‰ãŒå¯èƒ½ã§ã™ã€‚
                </p>
              </div>

            </div>
          </section>

          <section>
            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">
              <i class="fas fa-lightbulb text-orange-400 mr-2"></i>é–‹ç™ºã®ãƒ’ãƒ³ãƒˆ (åˆå¿ƒè€…å‘ã‘)
            </h4>
            <div class="space-y-3 text-xs text-gray-300">
                            <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <strong class="text-yellow-300 block mb-1">Q. æœ€åˆã®æŒ‡ç¤ºã®ã‚³ãƒ„ã¯ï¼Ÿ</strong>
                <p class="mb-2">
                  æœ€åˆã¯<b>ã€Œæœ€å°é™å®Ÿç¾ã—ãŸã„ã“ã¨ã€</b>ã ã‘ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚è©³ç´°ãªæ©Ÿèƒ½ã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ã®æŒ‡å®šã¯ä¸è¦ã§ã™ã€‚
                </p>
                <p class="text-xs text-gray-400">
                  AIã¯ã‚¢ãƒ—ãƒªå…¨ä½“ã®æ§‹é€ ã‚’æ·±ãç†è§£ã—ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚»ãƒ³ã‚¹ã‚‚ä¸€èˆ¬äººã‚ˆã‚Šå„ªã‚Œã¦ã„ã¾ã™ã€‚<br>
                  ã¾ãšã¯AIã«ã€ŒãŸãŸãå°ã€ã‚’ä½œã‚‰ã›ã¦ã€ãã®ã‚ã¨äººé–“ã®æŒ‡ç¤ºã§ä¿®æ­£ã—ã¦ç†æƒ³å½¢ã«è¿‘ã¥ã‘ã¦ã„ãï¼ˆAIã¨ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ã£ã¦å¯¾è©±ã—ãªãŒã‚‰å”åŠ›ã™ã‚‹ï¼‰ã®ãŒã€æœ€ã‚‚åŠ¹ç‡ã‚ˆãé«˜å“è³ªãªã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã‚³ãƒ„ã§ã™ã€‚
                </p>
              </div>
              <div class="bg-gray-800 p-3 rounded border border-gray-700">
              <strong class="text-orange-300 block mb-1">Q. ä½•ã‚’ä½œã‚Œã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„æ™‚ã¯ï¼Ÿ</strong>
              <p class="mb-2">
                ç”»é¢ä¸Šéƒ¨ã® <button class="px-2 py-0.5 bg-teal-700 text-white border border-teal-600 rounded text-[10px]"><i class="fas fa-comments"></i> AIã«ç›¸è«‡</button> ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
              </p>
              <p class="text-xs text-gray-400">
                ã€Œæ¬¡ã«å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½ã‚’ææ¡ˆã—ã¦ã€ãªã©ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸ã¶ã ã‘ã§ã€AIãŒã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã—ã¦ãã‚Œã¾ã™ã€‚<br>
                ç›¸è«‡å†…å®¹ã¯ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥åæ˜ ã•ã‚Œãªã„ã®ã§ã€ã¾ãšã¯ã“ã“ã§ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å›ºã‚ã¦ã‹ã‚‰ã€ŒAIæŒ‡ç¤ºã€ã§ä½œæˆä¾é ¼ã‚’ã™ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚
              </p>
            </div>
            </div>
          </section>

          <section>
            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">
              <i class="fas fa-shapes text-purple-400 mr-2"></i>ä½œã‚Œã‚‹ã‚¢ãƒ—ãƒªã®ä¾‹
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-gray-300">
              <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <strong class="text-blue-300 block mb-1"><i class="fas fa-briefcase"></i> ä»•äº‹ã«å½¹ç«‹ã¤</strong>
                <ul class="list-disc list-inside opacity-80">
                  <li>ä¼šè­°ç”¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼</li>
                  <li>Markdownãƒ¡ãƒ¢ã‚¨ãƒ‡ã‚£ã‚¿</li>
                  <li>è¦‹ç©æ›¸ãƒ»è«‹æ±‚æ›¸PDFç”Ÿæˆãƒ„ãƒ¼ãƒ«</li>
                  <li>ã‚«ãƒ³ãƒãƒ³æ–¹å¼ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒœãƒ¼ãƒ‰</li>
                </ul>
              </div>
              <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <strong class="text-green-300 block mb-1"><i class="fas fa-coffee"></i> ç”Ÿæ´»ã«å½¹ç«‹ã¤</strong>
                <ul class="list-disc list-inside opacity-80">
                  <li>è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ»å†·è”µåº«åœ¨åº«ç®¡ç†</li>
                  <li>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ï¼ˆãƒãƒ“ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ï¼‰</li>
                  <li>ã‚·ãƒ³ãƒ—ãƒ«ãªå®¶è¨ˆç°¿ãƒ»æ”¯å‡ºã‚°ãƒ©ãƒ•</li>
                  <li>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ã‚¿ã‚¤ãƒãƒ¼</li>
                </ul>
              </div>
              <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <strong class="text-pink-300 block mb-1"><i class="fas fa-language"></i> èªå­¦å­¦ç¿’ã«å½¹ç«‹ã¤</strong>
                <ul class="list-disc list-inside opacity-80">
                  <li>è‹±å˜èªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</li>
                  <li>éŸ³å£°èªè­˜ã‚’ä½¿ã£ãŸç™ºéŸ³ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ—ãƒª</li>
                  <li>AIã¨ä¼šè©±ã™ã‚‹è‹±ä¼šè©±ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</li>
                  <li>ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·´ç¿’ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</li>
                </ul>
              </div>
                            <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <strong class="text-yellow-300 block mb-1"><i class="fas fa-gamepad"></i> ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡</strong>
                <ul class="list-disc list-inside opacity-80">
                  <li>è½ã¡ç‰©ãƒ‘ã‚ºãƒ«ï¼ˆãƒ†ãƒˆãƒªã‚¹é¢¨ï¼‰</li>
                  <li>ãƒ–ãƒ­ãƒƒã‚¯å´©ã—ãƒ»ã‚¤ãƒ³ãƒ™ãƒ¼ãƒ€ãƒ¼é¢¨</li>
                  <li>é¸æŠè‚¢ã§é€²ã‚€ãƒãƒ™ãƒ«ã‚²ãƒ¼ãƒ </li>
                  <li>æ”¾ç½®ç³»ã‚¯ãƒªãƒƒã‚«ãƒ¼ã‚²ãƒ¼ãƒ </li>
                </ul>
              </div>
            </div>
          </section>

                    <section>
            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">
              <i class="fas fa-shield-alt text-green-400 mr-2"></i>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦
            </h4>
            <div class="bg-gray-800 p-4 rounded border border-gray-700 text-xs text-gray-300 space-y-2 leading-relaxed">
              <p>
                AppStudioã¯ã€<b>ã€Œä½œã£ãŸã‚¢ãƒ—ãƒªãŒå‹æ‰‹ã«å¤–éƒ¨ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚“ã ã‚Šé€ä¿¡ã—ãŸã‚Šã—ãªã„ã€</b>ã‚ˆã†ã«ã§ãã‚‹è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
              </p>
              <ul class="list-disc list-inside space-y-1 ml-1">
                <li><strong class="text-white">å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œ:</strong> ä½œæˆã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ãªãŸã®PCå†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è¡Œã„ã¾ã›ã‚“ã€‚</li>
                <li><strong class="text-white">å¤–éƒ¨é€šä¿¡ãƒ–ãƒ­ãƒƒã‚¯:</strong> è¨­å®šã«ã‚ˆã‚Šã€AIã«ã€Œå¤–éƒ¨ã‚µã‚¤ãƒˆã¸ã®æ¥ç¶šç¦æ­¢ã€ã€Œãƒ‡ãƒ¼ã‚¿é€ä¿¡ç¦æ­¢ã€ã‚’å¼·åˆ¶ã™ã‚‹æŒ‡ç¤ºã‚’è‡ªå‹•ã§è¿½åŠ ã—ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ã€‚</li>
                <li><strong class="text-white">æ¥­å‹™åˆ©ç”¨ã‚‚å®‰å¿ƒ:</strong> æ¥­å‹™ç›®çš„ã®ã‚¢ãƒ—ãƒªã§ã‚‚ã€æƒ…å ±æ¼æ´©ã®ãƒªã‚¹ã‚¯ã‚’æ¥µé™ã¾ã§ä½ãæŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
              </ul>
            </div>
          </section>

          <section>
            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">
              <i class="fas fa-mobile-screen-button text-pink-400 mr-2"></i>ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã”æ¡ˆå†…
            </h4>
            <div class="bg-gray-800 p-4 rounded border border-gray-700 text-xs text-gray-300 space-y-2 leading-relaxed">
              <p>
                é€šå‹¤é€”ä¸­ã‚„å¤–å‡ºå…ˆã§ã‚‚ã€ã‚¹ãƒãƒ›ã ã‘ã§ç°¡å˜ã«ã‚¢ãƒ—ãƒªé–‹ç™ºãŒã§ãã‚‹ <b>AppStudio Mobile</b> ã‚‚å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚<br>
                PCç‰ˆã¨åŒã˜æ„Ÿè¦šã§ã€AIã¨å¯¾è©±ã—ãªãŒã‚‰ã‚µã‚¯ã‚µã‚¯é–‹ç™ºã§ãã¾ã™ã€‚
              </p>
              <div class="mt-3">
                <div class="text-[10px] text-gray-500 mb-1">ã‚¢ã‚¯ã‚»ã‚¹ã¯ã“ã¡ã‚‰ (ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼):</div>
                <button 
                  onclick="navigator.clipboard.writeText('https://fujichu2008.github.io/kaimono_apps/AppStudioMobile.html').then(function(){alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚')})"
                  class="w-full text-left bg-black/40 border border-gray-600 rounded p-3 text-blue-300 font-mono text-[11px] break-all hover:bg-black/60 hover:border-blue-500 transition group relative">
                  https://fujichu2008.github.io/kaimono_apps/AppStudioMobile.html
                  <i class="fas fa-copy absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 group-hover:text-white"></i>
                </button>
              </div>
            </div>
          </section>
        </div>

        
                <div v-else-if="helpTab==='intermediate'" class="space-y-10 animate-fade-in">
          <section class="space-y-4">
            <h4 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">
              âš¡ å®Ÿè·µãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼šã‚¢ãƒ—ãƒªã‚’ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã•ã›ã‚ˆã†
            </h4>
            <p class="text-sm leading-relaxed">
              ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–æ©Ÿèƒ½ã‚„ä¾¿åˆ©ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ãˆã°ã€é©šãã»ã©é«˜æ©Ÿèƒ½ãªã‚¢ãƒ—ãƒªãŒä½œã‚Œã¾ã™ã€‚
              ã€ŒAIæŒ‡ç¤ºã€ã«è²¼ã‚Šä»˜ã‘ã¦ä½¿ãˆã‚‹<b>æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«</b>ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
            </p>
          </section>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-pink-300 font-bold">
                <i class="fas fa-microphone-lines"></i>
                <span>éŸ³å£°èª­ã¿ä¸Šã’ & èªè­˜</span>
              </div>
              <p class="text-xs text-gray-400">
                ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®Web Speech APIã‚’ä½¿ãˆã°ã€ã€Œå–‹ã‚‹ã‚¢ãƒ—ãƒªã€ã‚„ã€Œå£°ã§æ“ä½œã™ã‚‹ã‚¢ãƒ—ãƒªã€ãŒä½œã‚Œã¾ã™ã€‚è¿½åŠ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä¸è¦ã§ã™ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
å…¥åŠ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿ä¸Šã’ã‚‹ã€Œå†ç”Ÿãƒœã‚¿ãƒ³ã€ã¨ã€ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦å–‹ã£ãŸå†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã«å…¥åŠ›ã™ã‚‹ã€ŒéŸ³å£°èªè­˜ãƒœã‚¿ãƒ³ã€ã‚’ã¤ã‘ã¦ã€‚å£°ã®é«˜ã•ã‚„é€Ÿåº¦ã‚‚ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€‚
                </code>
              </div>
            </div>

            
                        <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-blue-300 font-bold">
                <i class="fas fa-qrcode"></i>
                <span>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</span>
                <span class="text-[9px] bg-blue-900 text-blue-200 px-1.5 py-0.5 rounded border border-blue-700">CDNåˆ©ç”¨</span>
              </div>
              <p class="text-xs text-gray-400">
                ã‚¹ãƒãƒ›ã§èª­ã¿å–ã‚Œã‚‹QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚CDNãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ç°¡å˜ã§ã™ãŒã€é€šä¿¡ãŒç™ºç”Ÿã—ã¾ã™ã€‚
                <br><span class="text-gray-500">â€»ã€Œéƒ½åº¦é€šä¿¡ã•ã›ãŸããªã„ã€å ´åˆã¯ã€AIã«ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãšãƒãƒ‹ãƒ©JSã§æ›¸ã„ã¦ã€ã‚„ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ãƒ—ãƒªå†…ã«åŸ‹ã‚è¾¼ã‚“ã§ã€ã¨é ¼ã‚€ã¨ã€å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒ–ã§ãã¾ã™ã€‚</span>
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
å…¥åŠ›ã•ã‚ŒãŸURLã‚„ãƒ†ã‚­ã‚¹ãƒˆã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºã—ã¦ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒª 'qrcode.js' ã‚’CDNã§èª­ã¿è¾¼ã‚“ã§ä½¿ã£ã¦ã€‚
                </code>
              </div>
            </div>

            
            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-yellow-300 font-bold">
                <i class="fas fa-database"></i>
                <span>å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ (IndexedDB)</span>
              </div>
              <p class="text-xs text-gray-400">
                LocalStorageã‚ˆã‚Šã‚‚å¤§å®¹é‡ã§æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã™ã€‚ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚„æ•°ä¸‡ä»¶ã®ãƒ­ã‚°ä¿å­˜ã«æœ€é©ã§ã™ã€‚AppStudioã®DBãƒ‡ãƒãƒƒã‚¬ã§ä¸­èº«ã‚’ç¢ºèªã§ãã¾ã™ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å…ˆã‚’LocalStorageã‹ã‚‰IndexedDBã«å¤‰æ›´ã—ã¦ã€‚DBåã¯'MyAppDB'ã€ã‚¹ãƒˆã‚¢åã¯'records'ã§ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«æ°¸ç¶šåŒ–ã—ã¦ã€‚
                </code>
              </div>
            </div>

            
            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-teal-300 font-bold">
                <i class="fas fa-file-code"></i>
                <span>JSONãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›</span>
              </div>
              <p class="text-xs text-gray-400">
                ã‚¢ãƒ—ãƒªå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã‚Šã€åˆ¥ã®ç«¯æœ«ã«ç§»ã—ãŸã‚Šã§ãã¾ã™ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã¨ã€JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€‚
                </code>
              </div>
            </div>

            
            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-red-300 font-bold">
                <i class="fas fa-camera"></i>
                <span>ã‚«ãƒ¡ãƒ© & ç”»åƒä¿å­˜</span>
              </div>
              <p class="text-xs text-gray-400">
                ã‚¹ãƒãƒ›ã‚„PCã®ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€å†™çœŸã‚’æ’®ã£ã¦ä¿å­˜ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚æ—¥è¨˜ã‚„è¨˜éŒ²ã‚¢ãƒ—ãƒªã«ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
ãƒ‡ãƒã‚¤ã‚¹ã®ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã€ç”»é¢ä¸Šã®videoã‚¿ã‚°ã«æ˜ åƒã‚’è¡¨ç¤ºã—ã¦ã€‚ã€Œæ’®å½±ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãã®ç¬é–“ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€‚
                </code>
              </div>
            </div>

            
                        <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-purple-300 font-bold">
                <i class="fas fa-chart-pie"></i>
                <span>ã‚°ãƒ©ãƒ•æç”» (Chart.js)</span>
                <span class="text-[9px] bg-purple-900 text-purple-200 px-1.5 py-0.5 rounded border border-purple-700">CDNåˆ©ç”¨</span>
              </div>
              <p class="text-xs text-gray-400">
                ãƒ‡ãƒ¼ã‚¿ã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã—ã¾ã™ã€‚å®¶è¨ˆç°¿ã‚„ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ãªã©ã«å¿…é ˆã§ã™ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
é›†è¨ˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ©ãƒ•ã§è¦‹ãŸã„ã€‚Chart.jsã‚’CDNã§èª­ã¿è¾¼ã‚“ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’å††ã‚°ãƒ©ãƒ•ï¼ˆã¾ãŸã¯æ£’ã‚°ãƒ©ãƒ•ï¼‰ã§è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ã‚’è¿½åŠ ã—ã¦ã€‚è‰²ã¯è¦‹ã‚„ã™ãèª¿æ•´ã—ã¦ã€‚
                </code>
              </div>
            </div>

            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-orange-300 font-bold">
                <i class="fas fa-hand-rock"></i>
                <span>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
              </div>
              <p class="text-xs text-gray-400">
                HTML5ã®æ¨™æº–æ©Ÿèƒ½ã ã‘ã§ã€è¦ç´ ã‚’ãƒã‚¦ã‚¹ã§æ´ã‚“ã§ç§»å‹•ã•ã›ã‚‹UIãŒä½œã‚Œã¾ã™ã€‚ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ã‚„ä¸¦ã¹æ›¿ãˆãƒªã‚¹ãƒˆã«ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
ã‚¿ã‚¹ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¦ã‚¹ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ä¸¦ã¹æ›¿ãˆãŸã‚Šã€åˆ¥ã®ãƒªã‚¹ãƒˆã«ç§»å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€‚å‹•ããŒã‚ã‹ã‚‹ã‚ˆã†ã«ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ãªå ´æ‰€ã¯è‰²ã‚’å¤‰ãˆã¦ã€‚
                </code>
              </div>
            </div>

            <div class="bg-gray-800 p-4 rounded border border-gray-700 space-y-3">
              <div class="flex items-center gap-2 text-pink-300 font-bold">
                <i class="fas fa-palette"></i>
                <span>ãŠçµµæããƒ»ç”»åƒç·¨é›† (Canvas)</span>
              </div>
              <p class="text-xs text-gray-400">
                æ‰‹æ›¸ããƒ¡ãƒ¢ã‚„ã€ç”»åƒã®ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ»ãƒ•ã‚£ãƒ«ã‚¿åŠ å·¥ãªã©ãŒã§ãã¾ã™ã€‚ç½²åæ©Ÿèƒ½ãªã©ã«ã‚‚å¿œç”¨å¯èƒ½ã§ã™ã€‚
              </p>
              <div class="bg-black/30 p-2 rounded border border-gray-600/50">
                <div class="text-[10px] text-gray-500 mb-1">AIã¸ã®æŒ‡ç¤ºæ–‡ã‚µãƒ³ãƒ—ãƒ«:</div>
                <code class="block text-xs text-green-300 select-all font-mono whitespace-pre-wrap">
ç”»é¢ä¸Šã«æ‰‹æ›¸ãã§ãã‚‹ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ã‚’ä½œã£ã¦ã€‚ãƒšãƒ³ã®è‰²ã¨å¤ªã•ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ã—ã€ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§æã„ãŸå†…å®¹ã‚’ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€‚
                </code>
              </div>
            </div>
          </div>
        </div>

        <div v-else-if="helpTab==='advanced'" class="space-y-10 animate-fade-in">
          <section class="space-y-4">
            <h4 class="text-2xl font-bold text-white border-b border-gray-700 pb-2">
              ğŸ› ï¸ AppStudio Technical Overview
            </h4>
            <p class="text-sm leading-relaxed">
              AppStudioã¯ã€<b>AI-Native Development (Vibe Coding)</b> ã‚’å…·ç¾åŒ–ã—ãŸã€ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµå‹ã®çµ±åˆé–‹ç™ºç’°å¢ƒã§ã™ã€‚
              å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„ã•ã‚Œã€LocalFileSystem APIã‚’é€šã˜ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§æ°¸ç¶šåŒ–ã•ã‚Œã¾ã™ã€‚
              <br><br>
              AIã«è‡ªç„¶è¨€èªã§æŒ‡ç¤ºã‚’å‡ºã—ã€ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å³åº§ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å®Ÿè¡Œã™ã‚‹ã‚µã‚¤ã‚¯ãƒ«ã‚’é«˜é€Ÿã«å›ã™ã“ã¨ã§ã€å¾“æ¥ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ã¯ç•°ãªã‚‹æ¬¡å…ƒã®ç”Ÿç”£æ€§ã‚’æä¾›ã—ã¾ã™ã€‚
            </p>
            <div class="grid grid-cols-2 gap-4 mt-4">
              <div class="bg-gray-800 p-3 rounded border border-gray-700 text-xs">
                <strong class="text-blue-300 block mb-1">Architecture</strong>
                Vue.js + Tailwind CSS + Monaco Editorã‚’ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§å‹•ä½œã•ã›ã€iframeå†…ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ“ãƒ«ãƒ‰ä¸è¦ã®Hot Reloadã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚
              </div>
              <div class="bg-gray-800 p-3 rounded border border-gray-700 text-xs">
                <strong class="text-purple-300 block mb-1">Single File Concept</strong>
                ä½œæˆã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã¯ã€HTML/CSS/JSã™ã¹ã¦ãŒ1ãƒ•ã‚¡ã‚¤ãƒ«(`index.html`)ã«å«ã¾ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ãŒæœ€å¤§åŒ–ã•ã‚Œã€é…å¸ƒã‚„å…±æœ‰ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚
              </div>
            </div>
          </section>

          <section>
            <h4 class="text-lg font-bold text-blue-300 mb-4">
              <i class="fas fa-code-branch mr-2"></i>Advanced Features & Internals
            </h4>
            <ul class="space-y-4 text-sm">
              <li class="bg-gray-800/50 p-3 rounded border border-gray-700">
                <strong class="text-white block mb-1"><i class="fas fa-file-code text-yellow-400 mr-2"></i>AI Patching Strategy (JSON/Manual)</strong>
                <p class="text-gray-400 text-xs mt-1">
                  ã‚³ãƒ¼ãƒ‰å…¨ä½“ã®å†ç”Ÿæˆï¼ˆFull Genï¼‰ã ã‘ã§ãªãã€å·®åˆ†ã®ã¿ã‚’é©ç”¨ã™ã‚‹ã€ŒPatch Modeã€ã‚’æ­è¼‰ã—ã¦ã„ã¾ã™ã€‚
                  <b>JSON Mode:</b> AIã« `search` / `replace` ãƒ–ãƒ­ãƒƒã‚¯ã‚’å«ã‚€JSONã‚’å‡ºåŠ›ã•ã›ã€Monaco Editorã®APIã‚’ç”¨ã„ã¦å®‰å…¨ã«ç½®æ›ã‚’é©ç”¨ã—ã¾ã™ã€‚ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‚ç…§ã®æºã‚‰ãï¼ˆ<code>&amp;lt;</code> vs <code><</code>ï¼‰ã‚‚è‡ªå‹•è£œæ­£ã—ã¾ã™ã€‚
                  <b>Manual Mode:</b> AIãŒdiffå½¢å¼ã§å‡ºåŠ›ã—ãŸå ´åˆãªã©ã«ã€æ‰‹å‹•ã§ç½®æ›å…ƒ/ç½®æ›å…ˆã‚’æŒ‡å®šã—ã¦ãƒ‘ãƒƒãƒã‚’é©ç”¨ã§ãã¾ã™ã€‚
                </p>
              </li>
              <li class="bg-gray-800/50 p-3 rounded border border-gray-700">
                <strong class="text-white block mb-1"><i class="fas fa-database text-green-400 mr-2"></i>IndexedDB Debugger</strong>
                <p class="text-gray-400 text-xs mt-1">
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒï¼ˆiframeï¼‰å†…ã®IndexedDBã‚’ã€è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰éåŒæœŸã§ãƒ€ãƒ³ãƒ—ãƒ»å¯è¦–åŒ–ã™ã‚‹ãƒ‡ãƒãƒƒã‚¬ã‚’å†…è”µã—ã¦ã„ã¾ã™ã€‚
                  `postMessage` ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³åˆ¶ç´„ä¸‹ï¼ˆnull originï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
                  ã“ã‚Œã«ã‚ˆã‚Šã€æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ã‚¢ãƒ—ãƒªï¼ˆToDoã€å®¶è¨ˆç°¿ãªã©ï¼‰ã®ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚
                </p>
              </li>
              <li class="bg-gray-800/50 p-3 rounded border border-gray-700">
                <strong class="text-white block mb-1"><i class="fas fa-shield-alt text-red-400 mr-2"></i>Security Injection</strong>
                <p class="text-gray-400 text-xs mt-1">
                  è¨­å®šã«ã‚ˆã‚Šã€AIã¸ã®æŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¼·åŠ›ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„ï¼ˆNo Fetch / No External Transmissionï¼‰ã‚’è‡ªå‹•æ³¨å…¥ã§ãã¾ã™ã€‚
                  ã“ã‚Œã«ã‚ˆã‚Šã€ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒå¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ãŸã‚Šã€æ„å›³ã—ãªã„CDNã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚’é˜²ãã€å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµå‹ã®ã‚¢ãƒ—ãƒªé–‹ç™ºã‚’å¼·åˆ¶ã§ãã¾ã™ã€‚
                  ä¼æ¥­å†…åˆ©ç”¨ã‚„æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ã‚¢ãƒ—ãƒªã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã«æœ€é©ã§ã™ã€‚
                </p>
              </li>
            </ul>
          </section>

          <section>
            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">
              <i class="fas fa-terminal text-gray-400 mr-2"></i>Tips for Engineers
            </h4>
            <div class="text-xs text-gray-400 space-y-2">
              <p>â— <b>Console Hook:</b> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã® `console.log/error/warn` ã¯ãƒ•ãƒƒã‚¯ã•ã‚Œã€`postMessage` çµŒç”±ã§ã‚¨ãƒ‡ã‚£ã‚¿ä¸‹éƒ¨ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«è»¢é€ã•ã‚Œã¾ã™ã€‚iframeå†…ã®ã‚¨ãƒ©ãƒ¼ã‚‚å³åº§ã«æŠŠæ¡ã§ãã¾ã™ã€‚</p>
              <p>â— <b>External Window:</b> ãƒãƒ«ãƒãƒ¢ãƒ‹ã‚¿ç’°å¢ƒã§ã¯ã€Œåˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦è¡¨ç¤ºã€ãŒæ¨å¥¨ã§ã™ã€‚ãƒã‚¤ãƒ†ã‚£ãƒ–ã®Chrome DevToolsãŒãƒ•ãƒ«æ©Ÿèƒ½ã§ä½¿ç”¨ã§ãã€ãƒ¢ãƒã‚¤ãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç›£è¦–ã‚‚å¯èƒ½ã§ã™ã€‚</p>
              <p>â— <b>Refactoring:</b> AIã«ã€Œãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã€ã€Œã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½è¨˜ã—ã¦ã€ã¨æŒ‡ç¤ºã—ã€`Full Code` ãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿæˆã•ã›ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£åŒ–ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’æ•´ç†ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã§ãã¾ã™ã€‚</p>
              <p>â— <b>Tech Spec Generation:</b> ã€ŒAIã«ç›¸è«‡ã€æ©Ÿèƒ½ã§ã€ŒæŠ€è¡“ä»•æ§˜æ›¸ã‚’æ›¸ã„ã¦ã€ã¨ä¾é ¼ã™ã‚‹ã¨ã€ã‚³ãƒ¼ãƒ‰ã‚’è§£æã—ã¦MDå½¢å¼ã®ä»•æ§˜æ›¸ã‚’å‡ºåŠ›ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>
          </section>
        </div>

      </div>
      <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-end">
        <button @click="markHelpSeen" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold transition shadow-lg">
          ç†è§£ã—ãŸ
        </button>
      </div>
    </div>
  </div>

    <div v-if="modals.consult" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-6 rounded-lg w-[600px] max-w-[95%] shadow-2xl border border-gray-600 flex flex-col">
      <h3 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
        <i class="fas fa-comments text-teal-400"></i> AIã«ç›¸è«‡ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ã†
      </h3>
            <div class="mb-4">
        <p class="text-xs text-gray-400 mb-2">
          ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã‚’AIã«å…±æœ‰ã—ã€æ”¹å–„ç‚¹ã‚„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç›¸è«‡ã§ãã¾ã™ã€‚
        </p>
        <div class="bg-yellow-900/30 border border-yellow-700/50 rounded p-2 text-[10px] text-yellow-200 flex gap-2 items-start">
          <i class="fas fa-info-circle mt-0.5 text-yellow-400"></i>
          <span class="leading-relaxed">
             <b>ç¢ºèª:</b> ã“ã“ã§ã®ä¼šè©±ã¯ã€Œç›¸è«‡ã€ã®ã¿ã§ã™ã€‚ã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚„ç”»é¢ã«ã¯<b>è‡ªå‹•åæ˜ ã•ã‚Œã¾ã›ã‚“</b>ã€‚<br>
             åæ˜ ã•ã›ã‚‹ã«ã¯ã€AIã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…ƒã«ã€ŒAIæŒ‡ç¤ºã€ã‚’è¡Œã†ã‹ã€ã‚³ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
          </span>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto mb-4">
        <label class="block text-xs font-bold text-gray-300 mb-2">ç›¸è«‡ã—ãŸã„å†…å®¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
        <div class="space-y-2 mb-4">
          <label v-for="topic in consultTopics" :key="topic.label" 
                 class="flex items-center gap-2 text-sm text-gray-200 cursor-pointer bg-gray-800/50 p-2 rounded hover:bg-gray-700 border border-gray-700">
            <input type="checkbox" v-model="topic.checked" class="accent-teal-500">
            <span>{{ topic.label }}</span>
          </label>
        </div>

        <label class="block text-xs font-bold text-gray-300 mb-2">è©³ã—ãèããŸã„ã“ã¨ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
        <textarea v-model="consultFreeInput" 
                  class="w-full h-24 bg-gray-900 border border-gray-600 rounded p-3 text-sm text-white focus:border-teal-500 outline-none resize-none"
                  placeholder="ä¾‹ï¼šã‚‚ã£ã¨ä½¿ã„ã‚„ã™ãã™ã‚‹ã«ã¯ã©ã†ã—ãŸã‚‰ã„ã„ï¼Ÿ"></textarea>
      </div>

      <div class="flex justify-end gap-2 pt-2 border-t border-gray-700">
        <button @click="modals.consult = false" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm text-white">é–‰ã˜ã‚‹</button>
        <button @click="generateConsultPrompt" 
                class="px-6 py-2 rounded font-bold text-white shadow-lg flex items-center gap-2 bg-teal-600 hover:bg-teal-500">
          <i class="fas fa-clipboard-list"></i> ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
      <div v-if="aiMessage" class="mt-2 text-center text-xs text-green-400 font-bold">
        {{ aiMessage }}
      </div>
    </div>
  </div>

  <div v-if="modals.settings" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-lg w-[420px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-4 text-gray-200 flex items-center gap-2"><i class="fas fa-cog"></i> è¨­å®š</h3>
      <div class="mb-4">
        <label class="block text-xs font-bold text-gray-400 mb-2">ã“ã®ã‚µã‚¤ãƒˆã§å¤‰æ›´ã‚’ä¿å­˜ã§ãã‚‹å ´æ‰€ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å…ˆ)</label>
        <div v-if="projectRootHandle" class="text-xs text-green-400 mb-3 flex items-center gap-2 bg-green-900/30 p-2 rounded border border-green-800">
           <i class="fas fa-check-circle"></i> æŒ‡å®šæ¸ˆã¿: <span class="font-mono">{{ projectRootHandle.name }}</span>
        </div>
        <div v-else class="text-xs text-gray-500 mb-3 bg-gray-800 p-2 rounded border border-gray-700">
           æœªæŒ‡å®š (ä½œæˆã®ãŸã³ã«é¸æŠã—ã¾ã™)
        </div>
        Â  Â  Â  Â  <button @click="setProjectRoot" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white border border-gray-600 flex items-center justify-center gap-2">
Â  Â  Â  Â  Â  Â <i class="fas fa-folder-tree"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®š
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  <div class="mb-4 border-t border-gray-700 pt-4">
Â  Â  Â  Â  <label class="block text-xs font-bold text-gray-400 mb-2"><i class="fas fa-shield-alt"></i> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š (AIæŒ‡ç¤ºã¸è‡ªå‹•è¿½åŠ )</label>
Â  Â  Â  Â  <label class="flex items-center gap-2 text-xs text-gray-200 mb-2 cursor-pointer hover:bg-gray-800 p-1 rounded">
Â  Â  Â  Â  Â  <input type="checkbox" v-model="securitySettings.noFetch" @change="saveSecuritySettings" class="accent-red-500">
Â  Â  Â  Â  Â  <span>å¤–éƒ¨ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ã®æƒ…å ±å–å¾—ç¦æ­¢</span>
Â  Â  Â  Â  Â  <span class="text-gray-500 text-[10px]">(CDNç­‰ã¯ä½¿ã‚ãšè‡ªå·±å®Œçµ)</span>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label class="flex items-center gap-2 text-xs text-gray-200 cursor-pointer hover:bg-gray-800 p-1 rounded">
Â  Â  Â  Â  Â  <input type="checkbox" v-model="securitySettings.noTransmit" @change="saveSecuritySettings" class="accent-red-500">
Â  Â  Â  Â  Â  <span>å¤–éƒ¨ã¸ã®æƒ…å ±ä¼é€ç¦æ­¢</span>
Â  Â  Â  Â  Â  <span class="text-gray-500 text-[10px]">(å¤–éƒ¨ã‚µãƒ¼ãƒé€šä¿¡ã‚’è¡Œã‚ãªã„)</span>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>

Â  Â  Â        <div class="flex justify-end pt-2 border-t border-gray-700">
        <button @click="modals.settings=false" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-xs text-white">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div v-if="modals.diff" class="fixed inset-0 bg-black bg-opacity-70 z-[100] backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-0 rounded-lg w-[95%] max-w-[1400px] h-[90vh] shadow-2xl border border-gray-600 flex flex-col overflow-hidden bg-[#1e1e1e]">
      <div class="flex items-center justify-between px-4 py-2 bg-[#2d2d2d] border-b border-black flex-shrink-0">
        <div class="flex items-center gap-4">
          <h3 class="text-sm font-bold text-gray-200 flex items-center gap-2">
            <i class="fas fa-columns text-blue-400"></i> å±¥æ­´å·®åˆ†æ¯”è¼ƒ
          </h3>
          <div class="flex items-center gap-8 text-xs font-mono">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 bg-[#4e4e4e] border border-gray-500 inline-block"></span>
              <span class="text-gray-400">Original (å±¥æ­´: {{ diffTargetDate }})</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 bg-[#1e1e1e] border border-blue-500 inline-block"></span>
              <span class="text-gray-100">Modified (ç¾åœ¨)</span>
            </div>
          </div>
        </div>
        <button @click="closeDiffModal" class="text-gray-400 hover:text-white px-3 py-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
            <div id="diff-editor-container" class="flex-1 w-full h-full relative"></div>
    </div>
  </div>

  <div v-if="modals.historyEdit" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] backdrop-blur-sm">
    <div class="glass-panel p-6 rounded-lg w-[500px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
        <i class="fas fa-pen-to-square text-blue-400"></i> å±¥æ­´ãƒ¡ãƒ¢ã®ç·¨é›†
      </h3>
      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ¡ãƒ¢ (AIæŒ‡ç¤º/ã‚³ãƒ¡ãƒ³ãƒˆ)</label>
        <textarea v-model="editingHistoryText"
                  class="w-full h-32 bg-gray-800 border border-gray-600 rounded p-3 text-sm text-white focus:border-blue-500 outline-none resize-none"
                  placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button @click="modals.historyEdit = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600 text-white">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button @click="saveHistoryMemo" class="px-4 py-2 text-sm rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">
          <i class="fas fa-save mr-1"></i> ä¸Šæ›¸ãä¿å­˜
        </button>
      </div>
    </div>
  </div>

</div>

<template id="default-code">
<!DOCTYPE html>
<html lang="ja">
<head>
/**
* ==========================================================================
* A P P   S T U D I O   :   W h e r e   I d e a s   T a k e   S h a p e
* ==========================================================================
* * *
* ã€ ã‚³ãƒ³ã‚»ãƒ—ãƒˆ ã€‘
* ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®çŸ¥è­˜ã¯ä¸€åˆ‡ä¸è¦ã€‚å¿…è¦ãªã®ã¯ã€Œã‚¢ã‚¤ãƒ‡ã‚¢ã€ã ã‘ã€‚
* AIã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€ç†æƒ³ã®ã‚¢ãƒ—ãƒªã‚’ç¬æ™‚ã«å½¢ã«ã™ã‚‹ã€‚
* * *
* ã€ ç‰¹å¾´ ã€‘
* â–¶ AI-Native Dev ..... è‡ªç„¶è¨€èªã®ãƒãƒ£ãƒƒãƒˆã ã‘ã§ã€Œã‚ã£ãŸã‚‰ã„ã„ãªã€ãŒï¼“åˆ†ã§å½¢ã«
* â–¶ Instant Preview ... ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å³åº§ã«å®Ÿè¡Œãƒ»ç¢ºèª
* â–¶ Secure Local ...... ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«å†…ã§å®Œçµã€‚å±é™ºãªé€šä¿¡ã‚’è¡Œã„ã¾ã›ã‚“
* * *
* ã€ ä½¿ã„æ–¹: 4ã‚¹ãƒ†ãƒƒãƒ— ã€‘
* 1. SET ...... å·¦ä¸Šã®ã€Œé–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹ã€ã‹ã‚‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¾ãŸã¯å˜ç™ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
* 2. ASK ...... ã€ŒAIæŒ‡ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªã‚’è¨€è‘‰ã§ä¼ãˆã‚‹
* 3. RUN ...... ç”ŸæˆAIã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€‚ã‚³ãƒ”ãƒšã—ã¦ã“ã®ã‚¢ãƒ—ãƒªã§å®Ÿè¡Œã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèª
* 4. REFINE ... æ°—ã«ãªã‚‹ç‚¹ã¯ã€ŒAIæŒ‡ç¤ºã€ã§ä¿®æ­£æŒ‡ç¤ºã€‚ã€Œä¿®æ­£ã‚’åæ˜ ã€ãƒœã‚¿ãƒ³ã§è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
* * *
* ==========================================================================
* Let's build something amazing.                    (c) 2026 Hisashi Fujinaka
* ==========================================================================
*/
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>AppStudio - Where ideas take shape</title>
   <style>
       :root {
           --bg-color: #050011;
           --text-color: #ffffff;
           --accent-gradient: linear-gradient(135deg, #00c6ff, #0072ff);
           --glass-bg: rgba(255, 255, 255, 0.05);
           --glass-border: rgba(255, 255, 255, 0.1);
       }

       body {
           margin: 0;
           padding: 0;
           overflow: hidden;
           background-color: var(--bg-color);
           font-family: 'Helvetica Neue', Arial, sans-serif;
           height: 100vh;
           display: flex;
           justify-content: center;
           align-items: center;
           color: var(--text-color);
       }

       /* èƒŒæ™¯ï¼š3Dã‚¹ã‚¿ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
       #starfield {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           z-index: 0;
       }

       /* ã‚³ãƒ¼ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒ èƒŒæ™¯ */
       #code-stream {
           position: absolute;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           z-index: 1;
           padding: 2rem;
           box-sizing: border-box;
           font-family: 'Consolas', 'Monaco', monospace;
           font-size: 0.9rem;
           color: rgba(0, 198, 255, 0.07); /* æœªçµŒé¨“è€…ãŒåœ§è¿«æ„Ÿã‚’æ„Ÿã˜ãªã„ã‚ˆã†è–„ãèª¿æ•´ */
           overflow: hidden;
           white-space: pre-wrap;
           word-break: break-all;
           pointer-events: none;
           text-shadow: 0 0 5px rgba(0, 198, 255, 0.2);
           transition: opacity 1s ease;
       }

       /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
       #content-layer {
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           z-index: 10;
           text-align: center;
           width: 100%;
           max-width: 800px;
           height: 300px;
           display: flex;
           flex-direction: column;
           justify-content: center;
           align-items: center;
           pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
       }

       /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ */
       .title-container {
           transition: all 1s ease-in-out;
           opacity: 1;
           transform: scale(1);
       }

       h1 {
           font-size: 5rem;
           margin: 0;
           font-weight: 800;
           letter-spacing: -2px;
           background: linear-gradient(to right, #fff, #a5b4fc);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
           text-shadow: 0 0 30px rgba(0, 100, 255, 0.3);
       }

       .subtitle {
           font-size: 1.5rem;
           margin-top: 1rem;
           font-weight: 300;
           letter-spacing: 4px;
           color: #cbd5e1;
           opacity: 0;
           animation: fadeInSub 2s ease-out 1s forwards;
       }

       /* æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
       .prompt-container {
           position: absolute;
           opacity: 0;
           transform: translateY(20px) scale(0.95);
           transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
           background: var(--glass-bg);
           border: 1px solid var(--glass-border);
           padding: 2rem 3rem;
           border-radius: 16px;
           backdrop-filter: blur(10px);
           box-shadow: 0 10px 40px rgba(0,0,0,0.5);
           width: 80%;
       }

       .prompt-text {
           font-family: 'Courier New', monospace;
           font-size: 1.4rem;
           line-height: 1.6;
           color: #e2e8f0;
       }

       .prompt-cursor {
           display: inline-block;
           width: 10px;
           height: 1.4rem;
           background: #00c6ff;
           margin-left: 5px;
           animation: blink 1s infinite;
       }

       .prompt-label {
           position: absolute;
           top: -12px;
           left: 20px;
           background: #0072ff;
           color: white;
           font-size: 0.7rem;
           padding: 2px 10px;
           border-radius: 10px;
           font-weight: bold;
           text-transform: uppercase;
           letter-spacing: 1px;
       }

       /* æœ€å¾Œã®CTAãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
       .cta-container {
           position: absolute;
           opacity: 0;
           transform: scale(0.9);
           transition: all 1s ease;
           text-align: center;
           pointer-events: auto;
       }

       .cta-text {
           font-size: 2rem;
           font-weight: bold;
           margin-bottom: 1rem;
           background: linear-gradient(135deg, #00c6ff, #0072ff);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
       }

       .cta-sub {
           font-size: 0.9rem;
           color: #94a3b8;
           margin-top: 1.5rem;
           line-height: 1.6;
       }
       .cta-btn {
           margin-top: 2rem; padding: 1rem 3rem; font-size: 1.2rem; font-weight: bold;
           color: white; background: var(--accent-gradient); border: none; border-radius: 50px;
           cursor: pointer; box-shadow: 0 0 20px rgba(0, 114, 255, 0.5); pointer-events: auto;
           transition: transform 0.2s;
       }
       .cta-btn:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(0, 114, 255, 0.8); }
       #guide-arrow {
           position: fixed; top: 5px; left: 10px; font-size: 6rem; color: #00c6ff; z-index: 9999;
           opacity: 0; pointer-events: none; font-weight:800; text-shadow: 0 0 20px cyan, 0 0 40px blue;
           line-height: 1;
       }
       .animate-guide { animation: pointNw 2s ease-in-out infinite; }
       @keyframes pointNw {
           0% { opacity: 0; transform: translate(60px, 60px); }
           20% { opacity: 1; transform: translate(10px, 10px); }
           50% { opacity: 1; transform: translate(0, 0); }
           100% { opacity: 0; transform: translate(0, 0); }
       }

       /* UI Preview Card */
       .preview-card {
           position: absolute;
           top: 50%; left: 50%;
           transform: translate(-50%, -50%) scale(0.8);
           width: 300px; height: 480px;
           background: #fff;
           border-radius: 20px;
           box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
           z-index: 20;
           opacity: 0;
           pointer-events: none;
           /* ã‚†ã£ãŸã‚Šã¨ã—ãŸé«˜ç´šæ„Ÿã®ã‚ã‚‹å‡ºç¾ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ (0.6s -> 1.2s) */
           transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
           display: flex; flex-direction: column; overflow: hidden;
       }
       .preview-card.show {
           opacity: 1;
           transform: translate(-50%, -50%) scale(1);
           animation: popGlow 1.5s ease-out forwards;
       }
       /* ã‚«ãƒ¼ãƒ‰å‡ºç¾æ™‚ã®ã€Œã‚­ãƒ©ãƒªã€ã¨å…‰ã‚‹åå°„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
       .preview-card.show::after {
           content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
           background: linear-gradient(to right, transparent, rgba(255,255,255,0.6), transparent);
           transform: skewX(-25deg);
           animation: shine 1.5s ease-out 0.2s forwards;
           pointer-events: none;
       }
       @keyframes shine { to { left: 200%; } }

       @keyframes popGlow {
           0% { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
           40% { box-shadow: 0 0 70px rgba(0, 198, 255, 0.6), 0 0 30px rgba(0, 114, 255, 0.4); border: 1px solid rgba(255,255,255,0.8); }
           100% { box-shadow: 0 35px 70px -15px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0); }
       }
       /* è¿½åŠ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
       @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
       @keyframes dropBounce { 0% { opacity:0; transform: translateY(-100px); } 60% { transform: translateY(10px); } 80% { transform: translateY(-5px); } 100% { opacity:1; transform: translateY(0); } }
       @keyframes pulseAlert { 0% { transform: scale(0.9); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
       .anim-chat { opacity: 0; animation: slideUp 0.5s ease-out forwards; }
       .anim-block { opacity: 0; animation: dropBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
       .preview-header { height: 45px; background: #f1f5f9; border-bottom: 1px solid #cbd5e1; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#475569; font-size:0.8rem;}
       .preview-body { flex: 1; padding: 20px; display:flex; flex-direction:column; gap:10px; position:relative; }

       /* Demo UI Elements */
       .demo-bar { height: 20px; background: #fee2e2; border-radius: 4px; overflow: hidden; position: relative; }
       .demo-bar-fill { height: 100%; background: #ef4444; width: 0%; transition: width 1s ease-out; }
       .demo-chat { background: #eff6ff; padding: 10px; border-radius: 12px; font-size: 0.8rem; color: #1e293b; margin-bottom: 5px; }
       .demo-chat.alt { background: #f1f5f9; align-self: flex-end; }
       .demo-block { height: 35px; border-radius: 6px; margin-bottom: 4px; }

       /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
       .hidden {
           opacity: 0 !important;
           transform: translateY(-20px) scale(0.95) !important;
           pointer-events: none;
       }

       .visible {
           opacity: 1 !important;
           transform: translateY(0) scale(1) !important;
           pointer-events: auto;
       }

       @keyframes fadeInSub {
           from { opacity: 0; transform: translateY(10px); }
           to { opacity: 0.8; transform: translateY(0); }
       }

       @keyframes blink {
           0%, 100% { opacity: 1; }
           50% { opacity: 0; }
       }

       /* ã‚¹ãƒãƒ›å¯¾å¿œ */
       @media (max-width: 600px) {
           h1 { font-size: 3rem; }
           .subtitle { font-size: 1rem; }
           .prompt-text { font-size: 1rem; }
           .prompt-container { width: 90%; padding: 1.5rem; }
           /* ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
           #code-stream { font-size: 0.7rem; opacity: 0.3; line-height: 1.2; }
       }

       /* æ¡ˆå†…é€šçŸ¥ (èµ·å‹•ç›´å¾Œã«è¡¨ç¤ºã—ã¦æ¶ˆãˆã‚‹) */
       #top-notice {
           position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
           background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(56, 189, 248, 0.3);
           padding: 8px 24px; border-radius: 99px; color: #bae6fd; font-size: 0.85rem;
           z-index: 1000; animation: fadeNotice 12s ease-out forwards; pointer-events: auto;
           white-space: nowrap; backdrop-filter: blur(8px); box-shadow: 0 4px 20px rgba(0,0,0,0.3);
           display: flex; align-items: center; gap: 8px; cursor: pointer;
       }
       @keyframes fadeNotice { 0% {opacity:0; transform:translate(-50%, -20px);} 10% {opacity:1; transform:translate(-50%, 0);} 85% {opacity:1;} 100% {opacity:0;} }

       /* CTA ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ */
       .cta-steps { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 0.85rem; color: #94a3b8; }
       .cta-step { background: rgba(255,255,255,0.05); padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
       .cta-arrow { color: #38bdf8; font-weight: bold; padding-top: 5px; }
       .security-note { margin-top: 15px; font-size: 0.75rem; color: #475569; display: flex; align-items: center; justify-content: center; gap: 6px; }

       /* å·¦ä¸Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆ & ã‚¬ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
       #app-menu-btn { position: fixed; top: 20px; left: 20px; font-size: 2rem; color: rgba(255,255,255,0.2); z-index: 50; cursor: default; }
       #guide-tooltip { position: fixed; top: 70px; left: 25px; background: #00c6ff; color: #000; padding: 6px 12px; border-radius: 4px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10000; font-size: 0.8rem; white-space: nowrap; }
       #guide-tooltip::after { content:''; position: absolute; top: -8px; left: 15px; border-width: 0 6px 8px 6px; border-style: solid; border-color: transparent transparent #00c6ff transparent; }
       #guide-tooltip.show-tip { opacity: 1; animation: bounceTip 1s infinite; }
       @keyframes bounceTip { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

       /* ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ */
       #skip-btn { position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; cursor: pointer; z-index: 1000; font-size: 0.8rem; backdrop-filter: blur(5px); transition: all 0.3s; opacity: 0.7; }
       #skip-btn:hover { background: rgba(255,255,255,0.2); opacity: 1; }

       /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: è¦–å·®åŠ¹æœã‚’æ¸›ã‚‰ã™è¨­å®šã¸ã®å¯¾å¿œ */
       @media (prefers-reduced-motion: reduce) {
           *, ::before, ::after {
               animation-duration: 0.001s !important;
               animation-delay: 0s !important;
               transition-duration: 0.001s !important;
               transition-delay: 0s !important;
           }
           /* æ˜Ÿç©ºã¯é™æ­¢ç”»ã«ãªã‚‹ãŸã‚ã€ãƒã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ãŸã‚å°‘ã—æš—ãã™ã‚‹ */
           #starfield { opacity: 0.4; }
           /* ç‚¹æ»…ã‚„å¼·ã„å…‰æ²¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«éš ã™ */
           .preview-card.show::after { display: none; }
           /* ã‚¬ã‚¤ãƒ‰çŸ¢å°ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã›ãšé™æ­¢è¡¨ç¤º */
           .animate-guide { animation: none !important; opacity: 1 !important; transform: translate(10px, 10px) !important; }
       }
   </style>



   <div id="top-notice" onclick="this.style.display='none'">â„¹ï¸ ã“ã®ç”»é¢ã¯ãƒ‡ãƒ¢ã§ã™ã€‚å·¦ä¸Šã®ã€é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹ã€ã‹ã‚‰ã™ãã«é–‹å§‹ã§ãã¾ã™ã€‚<span style="opacity:0.6; margin-left:8px;">âœ•</span></div>


   <div id="app-menu-btn">â‰¡</div>
   <div id="guide-tooltip">AppStudioã®å·¦ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
   <button id="skip-btn" onclick="skipDemo()">Skip Intro >></button>

   <canvas id="starfield"></canvas>
   <div id="code-stream"></div>

   <div id="content-layer">
       <div id="title-box" class="title-container visible">
           <h1>AppStudio</h1>
           <div class="subtitle">Where ideas take shape.</div>
       </div>

       <div id="prompt-box" class="prompt-container">
           <div id="prompt-label" class="prompt-label">Business</div>
           <div class="prompt-text">
               <span id="typewriter-text"></span><span class="prompt-cursor"></span>
           </div>
       </div>

       <div id="cta-box" class="cta-container">
           <div class="cta-text">ã¾ãšã¯ã€ä½œã£ã¦ã¿ã‚ˆã†ã€‚</div>
           <button class="cta-btn" onclick="triggerGuide()">é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹</button>

                      <div class="cta-steps">
               <span class="cta-step">â‘  AIæŒ‡ç¤ºã‚’ä½œæˆ</span> <span class="cta-arrow">â†’</span>
               <span class="cta-step">â‘¡ AIã«ãƒãƒ£ãƒƒãƒˆã§è¦æœ›</span> <span class="cta-arrow">â†’</span>
               <span class="cta-step">â‘¢ ãã®å ´ã§å‹•ã</span>
           </div>

                      <div class="security-note">
               ğŸ”’ å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ & å¤–éƒ¨é€šä¿¡ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿
           </div>
       </div>
       <div id="guide-arrow">â†–</div>
   </div>

   <div id="app-preview" class="preview-card">
       <div class="preview-header">App Preview</div>
       <div class="preview-body" id="preview-content"></div>
   </div>

<script>
/**
* 3D Starfield Animation
*/
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');

let stars = [];
const numStars = 800;
// ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ: è¦–å·®åŠ¹æœã‚’æ¸›ã‚‰ã™è¨­å®šã®å ´åˆã¯æ˜Ÿã‚’æ­¢ã‚ã‚‹
const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
let speed = prefersReduced ? 0 : 2;
let width, height, centerX, centerY;

function resize() {
   width = window.innerWidth;
   height = window.innerHeight;
   canvas.width = width;
   canvas.height = height;
   centerX = width / 2;
   centerY = height / 2;
}

// ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹(è¦–å·®)åŠ¹æœç”¨ã®ãƒã‚¦ã‚¹ä½ç½®
let parallaxX = 0;
let parallaxY = 0;

window.addEventListener('mousemove', (e) => {
   if (prefersReduced) return;
   // ç”»é¢ä¸­å¿ƒã‹ã‚‰ã®ã‚ºãƒ¬ã‚’è¨ˆç®— (ä¿‚æ•°0.05ã§ãµã‚“ã‚ã‚Šå‹•ã‹ã™)
   parallaxX = (e.clientX - centerX) * 0.05;
   parallaxY = (e.clientY - centerY) * 0.05;
});

class Star {
   constructor() { this.init(); }
   init() {
       this.x = (Math.random() - 0.5) * width * 2;
       this.y = (Math.random() - 0.5) * height * 2;
       this.z = Math.random() * width;
   }
   update() {
       this.z = this.z - speed;
       if (this.z <= 0) { this.init(); this.z = width; }
   }
   draw() {
       // ãƒã‚¦ã‚¹ã¨é€†æ–¹å‘ã«ãšã‚‰ã—ã¦å¥¥è¡Œãã‚’è¡¨ç¾
       let x = (this.x / this.z) * width + centerX - parallaxX;
       let y = (this.y / this.z) * height + centerY - parallaxY;
       
       let radius = (1 - this.z / width) * 2.5;
       if (x < 0 || x > width || y < 0 || y > height) return;
       
       const opacity = (1 - this.z / width);
       ctx.beginPath();
       ctx.arc(x, y, radius, 0, Math.PI * 2);
       ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
       ctx.fill();
   }
}

function initStars() {
   stars = [];
   for (let i = 0; i < numStars; i++) stars.push(new Star());
}

function animateStars() {
   ctx.fillStyle = "rgba(5, 0, 17, 0.4)";
   ctx.fillRect(0, 0, width, height);
   stars.forEach(star => { star.update(); star.draw(); });
   // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ: å‹•ãã‚’æ¸›ã‚‰ã™è¨­å®šãªã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹
   if (!prefersReduced) requestAnimationFrame(animateStars);
}

window.addEventListener('resize', resize);
resize();
initStars();
animateStars();

/**
* Presentation Sequencer
*/
const titleBox = document.getElementById('title-box');
const promptBox = document.getElementById('prompt-box');
const promptLabel = document.getElementById('prompt-label');
const typeText = document.getElementById('typewriter-text');
const ctaBox = document.getElementById('cta-box');
const codeStream = document.getElementById('code-stream');
const previewBox = document.getElementById('app-preview');
const previewContent = document.getElementById('preview-content');

const scenarios = [
   {
       label: "BUSINESS",
       text: "ã€Œæµ·å¤–ã¨ã®ä¼šè­°ã®è­°äº‹ã‚’æ–‡å­—èµ·ã“ã—ã™ã‚‹ã‚¢ãƒ—ãƒªã§ã€Copilotã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨é€£å‹•ã—ãŸç¿»è¨³ã‚’å®Ÿç¾ã—ãŸã„ã€‚ã€",
       code: `import { TranscribeService } from '@app/ai';\nconst session = new AudioSession();\nsession.on('data', async (buffer) => {\n  const text = await TranscribeService.parse(buffer);\n  const translated = await AIService.translate(text, 'ja');\n  UI.updateLiveCaption(translated);\n});\n// Generating UI Components...\n<View class="meeting-log">...`,
       preview: (el) => {
           el.innerHTML = `
               <div class="demo-chat anim-chat" style="animation-delay:0.2s"><b>Aã•ã‚“:</b> Next, let's discuss...</div>
               <div class="demo-chat alt anim-chat" style="animation-delay:0.8s"><b>AIç¿»è¨³:</b> æ¬¡ã«ã€...ã«ã¤ã„ã¦è­°è«–ã—ã¾ã—ã‚‡ã†</div>
               <div class="demo-chat anim-chat" style="animation-delay:1.6s"><b>B-san:</b> I agree with that.</div>
               <div class="demo-chat alt anim-chat" style="animation-delay:2.2s"><b>AIç¿»è¨³:</b> ç§ã‚‚ãã‚Œã«è³›æˆã§ã™ã€‚</div>
               <div style="margin-top:auto; font-size:0.7rem; color:#aaa; text-align:center; animation: blink 2s infinite;">éŒ²éŸ³ä¸­... <i class="fas fa-microphone"></i></div>
           `;
       }
   },
   {
       label: "LIFESTYLE",
       text: "ã€Œé£²é…’é‡ã‚’è¨˜éŒ²ã—ã¦ã‚°ãƒ©ãƒ•åŒ–ã™ã‚‹ç”Ÿæ´»ç¿’æ…£ç®¡ç†ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã€‚ã€",
       code: `const updateHealthData = (drinkType, amount) => {\n  const alcoholContent = calculatePureAlcohol(drinkType, amount);\n  db.dailyLogs.add({ date: new Date(), amount: alcoholContent });\n  const weeklyData = await db.getWeeklySummary();\n  ChartRenderer.draw(weeklyData, { type: 'bar', color: '#ff4444' });\n  if(alcoholContent > LIMIT) Alert.notify('Over limit');\n};`,
       preview: (el) => {
           el.innerHTML = `
               <div style='font-size:0.8rem; color:#666; margin-bottom:5px;'>ä»Šé€±ã®æ‘‚å–é‡</div>
               <div class='demo-bar'><div class='demo-bar-fill' style='width:0%'></div></div>
               <div style='text-align:right; font-size:1.5rem; font-weight:bold; color:#ef4444; margin-top:5px;'>420g <span style='font-size:0.8rem'>/ week</span></div>
               <div id='alert-msg' style='margin-top:20px; padding:10px; background:#fef2f2; border-radius:8px; color:#b91c1c; font-size:0.8rem; opacity:0;'>âš ï¸ é£²ã¿éãæ³¨æ„ï¼</div>
           `;
           setTimeout(() => {
               try{
                   el.querySelector('.demo-bar-fill').style.width = '80%';
                   const alert = el.querySelector('#alert-msg');
                   alert.style.animation = 'pulseAlert 0.5s ease-out forwards';
                   alert.style.animationDelay = '0.8s';
               }catch(e){}
           }, 100);
       }
   },
   {
       label: "GAME",
       text: "ã€ŒãŠæ­£æœˆã«è¦ªæˆšã®å®¶ã§ã¿ãŸãŠã‚‚ã¡ã‚ƒã‚’3Dã®çŸ¥è‚²ã‚²ãƒ¼ãƒ ã¨ã—ã¦å†ç¾ã—ã¦ã€‚ã€",
       code: `const scene = new THREE.Scene();\nconst geometry = new THREE.CylinderGeometry(5, 5, 20, 32);\nconst material = new THREE.MeshPhysicalMaterial({ color: 0xff0000 });\nconst daruma = new THREE.Mesh(geometry, material);\nphysicsWorld.addBody(daruma);\nfunction animate() {\n  requestAnimationFrame(animate);\n  renderer.render(scene, camera);\n}`,
              preview: (el) => {
           el.innerHTML = `
               <style>
                 @keyframes kickOut { 
                   0% { transform: translateX(0); }
                   20% { transform: translateX(-15px) rotate(-5deg); }
                   100% { transform: translateX(400px) rotate(180deg); opacity: 0; } 
                 }
                 @keyframes dropDown {
                   0% { transform: translateY(0); }
                   100% { transform: translateY(37px); }
                 }
               </style>
               <div style="display:flex; flex-direction:column; align-items:center; gap:2px; justify-content:center; height:100%; overflow:hidden;">
                 <div class="demo-block" style="width:60px; background:#ef4444; opacity:0; animation: dropBounce 0.6s forwards 0.1s, dropDown 0.3s cubic-bezier(0.5, 0, 1, 1) forwards 1.7s;"></div>
                 <div class="demo-block" style="width:70px; background:#3b82f6; opacity:0; animation: dropBounce 0.6s forwards 0.3s, dropDown 0.3s cubic-bezier(0.5, 0, 1, 1) forwards 1.7s;"></div>
                 <div class="demo-block" style="width:80px; background:#eab308; opacity:0; animation: dropBounce 0.6s forwards 0.5s, kickOut 0.4s ease-in forwards 1.6s;"></div>
                 <div class="demo-block" style="width:90px; background:#22c55e; opacity:0; animation: dropBounce 0.6s forwards 0.7s;"></div>
                 <div style="margin-top:10px; font-weight:bold; color:#333; opacity:0; animation:slideUp 0.5s ease-out 2.2s forwards">Score: 1000</div>
               </div>
           `;
       }
   },
   {
       label: "LEARN",
       text: "ã€ŒTOEICã®é »å‡ºå˜èªã‚’ãƒ¬ãƒ™ãƒ«åˆ¥ã«å‡ºé¡Œã™ã‚‹è‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒªã‚’ã¤ãã£ã¦ãã ã•ã„ã€‚ã€",
       code: `const fetchQuestions = async (level) => {\n  const words = await db.vocab.where('level', '==', level).toArray();\n  return words.map(w => ({\n    question: w.english,\n    options: generateChoices(w.japanese),\n    answer: w.japanese\n  }));\n};\nconst checkAnswer = (selected, correct) => {\n  return selected === correct ? Sound.play('correct') : Sound.play('wrong');\n}`,
       preview: (el) => {
           el.innerHTML = `
               <div style="text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; height:100%;">
                 <h2 style="font-size:2rem; color:#333; margin:0;">Abundance</h2>
                 <p style="color:#666; margin-bottom:30px;">[noun]</p>
                 <div style="display:grid; gap:10px;">
                   <button id="btn-correct" style="padding:12px; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:bold; transition:all 0.3s;">å¤§é‡ã€è±Šå¯Œ</button>
                   <button style="padding:12px; background:#e2e8f0; border:none; border-radius:8px; color:#475569;">æ”¾æ£„ã€æ–­å¿µ</button>
                 </div>
               </div>
           `;
                      setTimeout(() => {
               try {
                   const btn = el.querySelector('#btn-correct');
                   btn.style.transform = 'scale(1.1)';
                   btn.style.background = '#22c55e'; // Green for success
                   btn.innerHTML = 'å¤§é‡ã€è±Šå¯Œ âœ…';
               } catch(e) {}
           }, 1200);
       }
   },
      {
       label: "DEBUG",
       text: "ã€Œãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ç”»é¢ãŒãƒ•ãƒªãƒ¼ã‚ºã—ã¦å‹•ã‹ãªããªã‚‹... åŸå› ã‚’ç‰¹å®šã—ã¦ç›´ã—ã¦ã€‚ã€",
       code: `// âŒ Bad: Blocking Main Thread\nwhile(items.length < 9999) {\n  items.push(process()); // Freezes UI\n}\n\n// âœ… Fixed: Async/Await Pattern\nconst load = async () => {\n  while(notDone) {\n    processChunk();\n    await new Promise(r => requestAnimationFrame(r));\n  }\n};`,
       preview: (el) => {
           el.innerHTML = `
               <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:15px;">
                 <div style="font-size:0.8rem; color:#666;">Heavy Processing</div>
                 <div id="loader-box" style="width:50px; height:50px; border:5px solid #e2e8f0; border-top-color:#3b82f6; border-radius:50%;"></div>
                 <div id="status-text" style="color:#ef4444; font-weight:bold; font-size:0.9rem;">âš ï¸ Unresponsive (Freeze)</div>
                 <div id="fix-overlay" style="position:absolute; inset:0; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none;">
                    <div style="font-size:3rem; color:#22c55e; text-shadow:0 5px 15px rgba(34,197,94,0.5);"><i class="fas fa-magic"></i></div>
                 </div>
               </div>
           `;
           
           setTimeout(() => {
               try {
                   const overlay = el.querySelector('#fix-overlay');
                   if(overlay) {
                       overlay.style.transition = 'opacity 0.3s';
                       overlay.style.opacity = '1';
                       overlay.style.animation = 'popGlow 0.5s ease-out';
                   }
               } catch(e){}
           }, 1500);

           setTimeout(() => {
               try {
                   const loader = el.querySelector('#loader-box');
                   const status = el.querySelector('#status-text');
                   const overlay = el.querySelector('#fix-overlay');
                   
                   if(loader && status) {
                       const style = document.createElement('style');
                       style.innerHTML = '@keyframes spin { to { transform: rotate(360deg); } }';
                       el.appendChild(style);
                       loader.style.animation = 'spin 0.8s linear infinite';
                       status.innerHTML = 'Processing Smoothly...';
                       status.style.color = '#3b82f6';
                       status.style.transition = 'color 0.3s';
                   }
                   if(overlay) overlay.style.opacity = '0';
               } catch(e){}
           }, 2000);
           
           setTimeout(() => {
                try {
                    const status = el.querySelector('#status-text');
                    const loader = el.querySelector('#loader-box');
                    if(status) {
                        status.innerHTML = 'âœ¨ Completed!';
                        status.style.color = '#22c55e';
                    }
                    if(loader) {
                        loader.style.borderColor = '#22c55e';
                        loader.style.animation = 'none';
                    }
                } catch(e){}
           }, 3200);
       }
   }
];

const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function typeWriter(text, element) {
   element.innerHTML = "";
   for (let i = 0; i < text.length; i++) {
       element.innerHTML += text.charAt(i);
       await wait(50);
   }
}

async function runSequence() {
   speed = 2;
   titleBox.classList.remove('hidden');
   titleBox.classList.add('visible');
   promptBox.classList.remove('visible');
   promptBox.classList.add('hidden');
   ctaBox.classList.remove('visible');
   ctaBox.classList.add('hidden');
   codeStream.innerHTML = "";

   await wait(3500);

   titleBox.classList.remove('visible');
   titleBox.classList.add('hidden');
   await wait(1000); // å¾…æ©Ÿå»¶é•·

   promptBox.classList.remove('hidden');
   promptBox.classList.add('visible');

   speed = 15;

   for (const scenario of scenarios) {

       promptLabel.innerText = scenario.label;
       const isLastScenario = (scenario === scenarios[scenarios.length - 1]);

       // 1. Type Prompt & 2. Stream Codeï¼ˆåŒæ™‚é–‹å§‹ï¼‰
       typeText.innerHTML = "";
       codeStream.innerHTML = "";

       let codeIndex = 0;
       const streamPromise = new Promise(resolve => {
           const codeInterval = setInterval(() => {
               if (codeIndex < scenario.code.length) {
                   codeStream.innerHTML += scenario.code.charAt(codeIndex);
                   codeIndex++;
               }
           }, 6); // ã‚³ãƒ¼ãƒ‰ç”Ÿæˆé€Ÿåº¦ã‚’å°‘ã—ã‚†ã£ãã‚Šã«

           // ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºæ™‚é–“ã‚’å»¶é•·
           setTimeout(() => {
               clearInterval(codeInterval);
               resolve();
           }, 2200);
       });

       const typingPromise = typeWriter(scenario.text, typeText);

       await Promise.all([typingPromise, streamPromise]);

       // æŒ‡ç¤ºã‚’èª­ã¾ã›ã‚‹æ™‚é–“ã‚’ãŸã£ã·ã‚Šã¨ã‚‹ (0.6s -> 1.5s)
       await wait(1500);

       // 3. Show Preview
       if (scenario.preview) {
           // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¶ˆå»
           promptBox.classList.remove('visible');
           promptBox.classList.add('hidden');

           // ã‚¢ãƒ—ãƒªãŒå‡ºã‚‹å‰ã®ã€Œæºœã‚ã€ã‚’ä½œã‚‹ (0.85s -> 1.0s)
           await wait(1000);

           // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
           scenario.preview(previewContent);
           previewBox.classList.add('show');

           // ã‚¢ãƒ—ãƒªã®å‹•ä½œã‚’ã‚†ã£ãã‚Šè¦‹ã›ã‚‹ (2.5s -> 4.5s)
           await wait(4500);

           // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¶ˆå»
           previewBox.classList.remove('show');
           await wait(1000);

           typeText.innerHTML = "";
           codeStream.innerHTML = "";
           await wait(50);

           if (!isLastScenario) {
               promptBox.classList.remove('hidden');
               promptBox.classList.add('visible');
               await wait(200);
           }
       }

       typeText.innerHTML = "";
       codeStream.innerHTML = "";
       await wait(300);
   }

   promptBox.classList.remove('visible');
   promptBox.classList.add('hidden');
   speed = 2;
   await wait(1000);

   ctaBox.classList.remove('hidden');
   ctaBox.classList.add('visible');

   await wait(6000);

   ctaBox.classList.remove('visible');
   ctaBox.classList.add('hidden');
   await wait(1000);

   runSequence();
}

// Control Logic
let isStopped = false;

window.skipDemo = function() {
   if (isStopped) return;
   isStopped = true;
   document.getElementById('skip-btn').style.display = 'none';

   // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦å³æ™‚éè¡¨ç¤ºã«ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
   const kill = (el) => {
       el.style.transition = 'none';
       el.style.opacity = '0';
       el.classList.add('hidden');
       el.classList.remove('visible', 'show');
   };

   // å¼·åˆ¶çš„ã«CTAç”»é¢ã¸é·ç§»
   kill(titleBox);
   kill(promptBox);
   kill(previewBox);
   
   codeStream.innerHTML = "";

   // CTAã¯è¡¨ç¤º
   ctaBox.classList.remove('hidden');
   ctaBox.classList.add('visible');
};

window.triggerGuide = function() {
   // çŸ¢å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   const arrow = document.getElementById('guide-arrow');
   arrow.classList.remove('animate-guide');
   void arrow.offsetWidth;
   arrow.classList.add('animate-guide');

   // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
   const tip = document.getElementById('guide-tooltip');
   tip.classList.add('show-tip');

   // å·¦ä¸Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å¼·èª¿
   const target = document.getElementById('app-menu-btn');
   target.style.color = '#fff';
   target.style.textShadow = '0 0 10px #00c6ff';

   setTimeout(() => {
       arrow.classList.remove('animate-guide');
       tip.classList.remove('show-tip');
       target.style.color = '';
       target.style.textShadow = '';
   }, 5000);
};

// æ—¢å­˜ã®runSequenceã«åœæ­¢ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
const originalWait = wait;
// waité–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã€åœæ­¢æ™‚ã¯å¾…æ©Ÿã—ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆå³æ™‚è§£æ±ºã¯ã—ãªã„ãŒã€å‡¦ç†ã‚’æ­¢ã‚ã‚‹ï¼‰
// ã“ã“ã§ã¯å˜ç´”ã« runSequence å†…ã§ isStopped ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹å¼ã«å¤‰æ›´

async function runSequenceOverride() {
   if (isStopped) return;

   // ... (å…ƒã®åˆæœŸåŒ–å‡¦ç†) ...
   speed = 2;
   titleBox.classList.remove('hidden');
   titleBox.classList.add('visible');
   promptBox.classList.remove('visible');
   promptBox.classList.add('hidden');
   ctaBox.classList.remove('visible');
   ctaBox.classList.add('hidden');
   codeStream.innerHTML = "";

   if(isStopped) return;
   await wait(3500);
   if(isStopped) return;

   titleBox.classList.remove('visible');
   titleBox.classList.add('hidden');
   await wait(1000);
   if(isStopped) return;

   promptBox.classList.remove('hidden');
   promptBox.classList.add('visible');
   speed = 15;

   for (const scenario of scenarios) {
       if (isStopped) return;
       promptLabel.innerText = scenario.label;
       const isLastScenario = (scenario === scenarios[scenarios.length - 1]);

       typeText.innerHTML = "";
       codeStream.innerHTML = "";

       let codeIndex = 0;
       const streamPromise = new Promise(resolve => {
           const codeInterval = setInterval(() => {
               if (isStopped) { clearInterval(codeInterval); resolve(); return; }
               if (codeIndex < scenario.code.length) {
                   codeStream.innerHTML += scenario.code.charAt(codeIndex);
                   codeIndex++;
               }
           }, 6);
           setTimeout(() => { clearInterval(codeInterval); resolve(); }, 2200);
       });

       const typingPromise = typeWriter(scenario.text, typeText);
       await Promise.all([typingPromise, streamPromise]);
       if (isStopped) return;
       await wait(1500);
       if (isStopped) return;

       if (scenario.preview) {
           promptBox.classList.remove('visible');
           promptBox.classList.add('hidden');
           await wait(1000);
           if (isStopped) return;

           scenario.preview(previewContent);
           previewBox.classList.add('show');
           await wait(4500);
           if (isStopped) return;

           previewBox.classList.remove('show');
           await wait(1000);

           typeText.innerHTML = "";
           codeStream.innerHTML = "";
           await wait(50);
           if (!isLastScenario) {
               promptBox.classList.remove('hidden');
               promptBox.classList.add('visible');
               await wait(200);
           }
       }
       typeText.innerHTML = "";
       codeStream.innerHTML = "";
       await wait(300);
   }

   if (isStopped) return;
   promptBox.classList.remove('visible');
   promptBox.classList.add('hidden');
   speed = 2;
   await wait(1000);

   ctaBox.classList.remove('hidden');
   ctaBox.classList.add('visible');
   document.getElementById('skip-btn').style.display = 'none'; // æœ€å¾Œã¾ã§è¦‹ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³æ¶ˆã™

   await wait(6000);
   if (isStopped) return;

   ctaBox.classList.remove('visible');
   ctaBox.classList.add('hidden');
   document.getElementById('skip-btn').style.display = 'block';
   await wait(1000);

   runSequenceOverride();
}

runSequenceOverride();
</script>




























































<script id="lfs-meta" type="application/json">
{
  "appId": "d24aadecf689702c755cf0dd978f4ec2",
  "createdAt": "2026-01-09T23:39:59.240Z",
  "schema": 2,
  "title": "AppStudio",
  "savedAt": "2026-01-18T15:36:30.651Z",
  "aiInstruction": "UIã®ç”¨èªã‚’ä¿®æ­£ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åˆå¿ƒè€…ã§ã‚‚ç›´æ„Ÿçš„ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚\nã€Œã‚³ãƒ¼ãƒ‰ã€ã€Œåæ˜ ã€ã€Œãƒ‘ãƒƒãƒã€ã¨ã„ã£ãŸå°‚é–€ç”¨èªã‚’é¿ã‘ã€ã€Œæ›´æ–°ã€ã¨ã„ã†è¨€è‘‰ã«çµ±ä¸€ã—ã¾ã™ã€‚\n\nä»¥ä¸‹ã®3ç‚¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n1. **ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³åç§°å¤‰æ›´**:\n   - ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚\n   - ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚‚ã€ŒAIç”Ÿæˆã‚³ãƒ¼ãƒ‰(å…¨é‡ãƒ»ä¿®æ­£)ã‚’åæ˜ ã€ã‹ã‚‰ **ã€ŒAIãŒä½œã£ãŸä¿®æ­£æ¡ˆã‚’å–ã‚Šè¾¼ã‚“ã§ã€ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¾ã™ã€** ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚\n\n2. **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰åæ˜ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰å†…ã®ã‚¿ãƒ–åç§°å¤‰æ›´**:\n   - â‘ : ã€Œå…¨ã‚³ãƒ¼ãƒ‰åæ˜  (Full)ã€ â†’ **ã€Œâ‘  ã¾ã‚‹ã”ã¨æ›´æ–° (Full)ã€**\n   - â‘¡: ã€Œæ‰‹å‹•ãƒ‘ãƒƒãƒ (Manual)ã€ â†’ **ã€Œâ‘¡ æ‰‹å‹•ã§æ›´æ–° (Manual)ã€**\n   - â‘¢: ã€Œãƒ•ãƒ«ã‚ªãƒ¼ãƒˆ (Auto)ã€ â†’ **ã€Œâ‘¢ è‡ªå‹•ã§æ›´æ–° (Auto)ã€**\n   - ã¾ãŸã€å„ã‚¿ãƒ–ã®èª¬æ˜æ–‡ï¼ˆã€ŒAIãŒï½ä½œã£ãŸå ´åˆã€ãªã©ï¼‰ã«å«ã¾ã‚Œã‚‹ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ã‚„ã€Œãƒ‘ãƒƒãƒã€ã¨ã„ã†è¨€è‘‰ã‚‚ã€æ–‡è„ˆã«åˆã‚ã›ã¦è‡ªç„¶ãªã€Œæ›´æ–°ã€ã‚„ã€Œä¿®æ­£ã€ãªã©ã®è¡¨ç¾ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n3. **AIæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£**:\n   - `generateAndCopyPrompt` é–¢æ•°å†…ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãŠã„ã¦ã€AIãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’æ¡ˆå†…ã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šã€ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—...ã€ï¼‰ã€‚\n   - ã“ã®æ¡ˆå†…æ–‡è¨€ã‚’ã€æ–°ã—ã„ãƒœã‚¿ãƒ³å **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ãŠã‚ˆã³æ–°ã—ã„ã‚¿ãƒ–å **ã€Œã¾ã‚‹ã”ã¨æ›´æ–°ã€ã€Œè‡ªå‹•ã§æ›´æ–°ã€** ãªã©ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n4.ãƒ˜ãƒ«ãƒ—ç”»é¢ã®æ›´æ–°\nã€€ã“ã®æ›´æ–°ã«ä¼´ã„ã€ãƒ˜ãƒ«ãƒ—ç”»é¢ã§ä¿®æ­£å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n1. **AIæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£**:\n\n   - `generateAndCopyPrompt` é–¢æ•°å†…ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãŠã„ã¦ã€AIãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’æ¡ˆå†…ã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šã€ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—...ã€ï¼‰ã€‚\n\n   - ã“ã®æ¡ˆå†…æ–‡è¨€ã‚’ã€æ–°ã—ã„ãƒœã‚¿ãƒ³å **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ãŠã‚ˆã³æ–°ã—ã„ã‚¿ãƒ–å **ã€Œã¾ã‚‹ã”ã¨æ›´æ–°ã€ã€Œè‡ªå‹•ã§æ›´æ–°ã€** ãªã©ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n\n\n2.ãƒ˜ãƒ«ãƒ—ç”»é¢ã®æ›´æ–°\n\nã€€ã“ã®æ›´æ–°ã«ä¼´ã„ã€ãƒ˜ãƒ«ãƒ—ç”»é¢ã§ä¿®æ­£å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚",
  "comment": "UIã®ç”¨èªã‚’ä¿®æ­£ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åˆå¿ƒè€…ã§ã‚‚ç›´æ„Ÿçš„ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚\nã€Œã‚³ãƒ¼ãƒ‰ã€ã€Œåæ˜ ã€ã€Œãƒ‘ãƒƒãƒã€ã¨ã„ã£ãŸå°‚é–€ç”¨èªã‚’é¿ã‘ã€ã€Œæ›´æ–°ã€ã¨ã„ã†è¨€è‘‰ã«çµ±ä¸€ã—ã¾ã™ã€‚\n\nä»¥ä¸‹ã®3ç‚¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n1. **ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³åç§°å¤‰æ›´**:\n   - ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚\n   - ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚‚ã€ŒAIç”Ÿæˆã‚³ãƒ¼ãƒ‰(å…¨é‡ãƒ»ä¿®æ­£)ã‚’åæ˜ ã€ã‹ã‚‰ **ã€ŒAIãŒä½œã£ãŸä¿®æ­£æ¡ˆã‚’å–ã‚Šè¾¼ã‚“ã§ã€ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¾ã™ã€** ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚\n\n2. **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰åæ˜ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰å†…ã®ã‚¿ãƒ–åç§°å¤‰æ›´**:\n   - â‘ : ã€Œå…¨ã‚³ãƒ¼ãƒ‰åæ˜  (Full)ã€ â†’ **ã€Œâ‘  ã¾ã‚‹ã”ã¨æ›´æ–° (Full)ã€**\n   - â‘¡: ã€Œæ‰‹å‹•ãƒ‘ãƒƒãƒ (Manual)ã€ â†’ **ã€Œâ‘¡ æ‰‹å‹•ã§æ›´æ–° (Manual)ã€**\n   - â‘¢: ã€Œãƒ•ãƒ«ã‚ªãƒ¼ãƒˆ (Auto)ã€ â†’ **ã€Œâ‘¢ è‡ªå‹•ã§æ›´æ–° (Auto)ã€**\n   - ã¾ãŸã€å„ã‚¿ãƒ–ã®èª¬æ˜æ–‡ï¼ˆã€ŒAIãŒï½ä½œã£ãŸå ´åˆã€ãªã©ï¼‰ã«å«ã¾ã‚Œã‚‹ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ã‚„ã€Œãƒ‘ãƒƒãƒã€ã¨ã„ã†è¨€è‘‰ã‚‚ã€æ–‡è„ˆã«åˆã‚ã›ã¦è‡ªç„¶ãªã€Œæ›´æ–°ã€ã‚„ã€Œä¿®æ­£ã€ãªã©ã®è¡¨ç¾ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n3. **AIæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£**:\n   - `generateAndCopyPrompt` é–¢æ•°å†…ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãŠã„ã¦ã€AIãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’æ¡ˆå†…ã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šã€ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—...ã€ï¼‰ã€‚\n   - ã“ã®æ¡ˆå†…æ–‡è¨€ã‚’ã€æ–°ã—ã„ãƒœã‚¿ãƒ³å **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ãŠã‚ˆã³æ–°ã—ã„ã‚¿ãƒ–å **ã€Œã¾ã‚‹ã”ã¨æ›´æ–°ã€ã€Œè‡ªå‹•ã§æ›´æ–°ã€** ãªã©ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n4.ãƒ˜ãƒ«ãƒ—ç”»é¢ã®æ›´æ–°\nã€€ã“ã®æ›´æ–°ã«ä¼´ã„ã€ãƒ˜ãƒ«ãƒ—ç”»é¢ã§ä¿®æ­£å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n1. **AIæŒ‡ç¤ºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£**:\n\n   - `generateAndCopyPrompt` é–¢æ•°å†…ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãŠã„ã¦ã€AIãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’æ¡ˆå†…ã™ã‚‹ã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼šã€ã€Œã‚³ãƒ¼ãƒ‰åæ˜ ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—...ã€ï¼‰ã€‚\n\n   - ã“ã®æ¡ˆå†…æ–‡è¨€ã‚’ã€æ–°ã—ã„ãƒœã‚¿ãƒ³å **ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€** ãŠã‚ˆã³æ–°ã—ã„ã‚¿ãƒ–å **ã€Œã¾ã‚‹ã”ã¨æ›´æ–°ã€ã€Œè‡ªå‹•ã§æ›´æ–°ã€** ãªã©ã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚\n\n\n\n2.ãƒ˜ãƒ«ãƒ—ç”»é¢ã®æ›´æ–°\n\nã€€ã“ã®æ›´æ–°ã«ä¼´ã„ã€ãƒ˜ãƒ«ãƒ—ç”»é¢ã§ä¿®æ­£å¿…è¦ãªç®‡æ‰€ãŒã‚ã‚Œã°ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚",
  "sourceMode": "project",
  "runId": "5b84d1608811c6136e2087f7097f8b04"
}
</script>
</body>
</html>
</template>
<script>
const { createApp, ref, reactive, onMounted, nextTick, computed, watch } = Vue;

createApp({
  setup() {
    // --- STATE ---
    const appMode = ref('single'); // 'project' | 'single'
    const projectHandle = ref(null);
    const projectDisplayName = ref('é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹');
    const currentFileHandle = ref(null);
    const currentFileName = ref('');

        // Library / History
    const libraryFiles = ref([]);
    const libraryScanStatus = ref('');

    // History Tooltip
    const hoveredHistory = ref(null);
    const showHistoryDetail = (e, text) => {
      if (!text) return;
      const rect = e.target.getBoundingClientRect();
      // Adjust position to avoid bottom overflow
      const top = Math.min(rect.top, window.innerHeight - 200);
      hoveredHistory.value = { text, top, left: rect.right + 12 };
    };
    const hideHistoryDetail = () => { hoveredHistory.value = null; };

    // History mode
    const historyMode = ref('flat'); // 'flat' (å±¥æ­´) | 'group' (Rootã‹ã‚‰ã®PJä¸€è¦§)

    // UI state
    Â  Â              const menus = reactive({ file: false });
        const modals = reactive({ ai: false, save: false, patch: false, db: false, settings: false, help: false, consult: false, diff: false, github: false, historyEdit: false });
    const editingHistoryItem = ref(null);
    const editingHistoryText = ref('');
    const projectRootHandle = ref(null);
    
    // GitHub State
    const githubSettings = reactive({ token: '', repo: '', branch: 'main', path: 'index.html' });
    const githubStatus = ref('');
    const githubUrl = ref('');

    // Consult State
            const consultTopics = ref([
      { label: 'ã“ã®ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ã‚„ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ï¼ˆè‰¯ã„ç‚¹ãƒ»æ”¹å–„ç‚¹ï¼‰', checked: false },
      { label: 'ä»Šã®ã‚¢ãƒ—ãƒªã«100ç‚¹æº€ç‚¹ã§ç‚¹æ•°ã‚’ã¤ã‘ã¦ã‚‚ã‚‰ã†', checked: false },
      { label: 'æ¬¡ã«å®Ÿè£…ã™ã¹ãã€ä¾¿åˆ©ã§é¢ç™½ã„æ©Ÿèƒ½ã‚’ææ¡ˆã—ã¦', checked: false },
      { label: 'ã“ã®ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ï¼ˆèª¬æ˜æ›¸ï¼‰ã‚’æ›¸ã„ã¦', checked: false },
      { label: 'ãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦', checked: false },
      { label: 'ã€ä¸Šç´šè€…å‘ã€‘ã“ã®ã‚¢ãƒ—ãƒªã®æŠ€è¡“ä»•æ§˜æ›¸ï¼ˆå†…éƒ¨æ§‹é€ ã®è§£èª¬ï¼‰ã‚’æ›¸ã„ã¦', checked: false }
    ]);
        const consultFreeInput = ref('');
        const securitySettings = reactive({ noFetch: true, noTransmit: true });
    const isSidebarOpen = ref(true);
    const isEditorOpen = ref(false);

    const aiTab = ref('json'); // 'full' | 'patch' | 'json''''
    const aiInstruction = ref(''); // è“„ç©ç”¨(â‘ )
    const aiPromptInput = ref(''); // ãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›ç”¨
    const aiMessage = ref('');
        const aiIncludeFullCode = ref(true);
    const aiHelp = ref(false);
    const patchHelp = ref(false);
    const showRecipes = ref(false);
    const helpTab = ref('beginner');

    const saveComment = ref('');
    const saveFilename = ref('');

        const patchMode = ref('manual'); // 'full' | 'manual' | 'json'
    const patchFullInput = ref('');
    const patchFindInput = ref('');
    const patchReplaceInput = ref('');
    const patchJsonInput = ref('');
    const patchIgnoreWhitespace = ref(true);

    // Patch Status
        const patchMatchCount = ref(0);
    const patchMatchMessage = ref('');
    const patchJsonStatus = ref(null);

    const updatePatchStatus = () => {
      if (!editor || !patchFindInput.value) {
        patchMatchCount.value = 0;
        patchMatchMessage.value = '';
        return;
      }
      const find = patchFindInput.value;
      const full = editor.getValue();
      let count = 0;

      if (!patchIgnoreWhitespace.value) {
        // å®Œå…¨ä¸€è‡´
        let pos = 0;
        while (true) {
          const idx = full.indexOf(find, pos);
          if (idx === -1) break;
          count++;
          pos = idx + find.length;
        }
      } else {
        // ç©ºç™½ç„¡è¦–
        const normFind = normalizeFind(find);
        if (!normFind) { count = 0; }
        else {
          const { compact } = buildCompacted(full);
          let pos = 0;
          while (true) {
            const idx = compact.indexOf(normFind, pos);
            if (idx === -1) break;
            count++;
            pos = idx + normFind.length;
          }
        }
      }
            patchMatchCount.value = count;
      if (count > 0) {
        patchMatchMessage.value = `è©²å½“ç®‡æ‰€ã‚ã‚Š (${count}ä»¶)`;
      } else {
        const hint = findPossibleRange(find);
        patchMatchMessage.value = hint ? hint.replace(/[\r\n]+/g, ' ').trim() : 'è©²å½“ãªã—';
      }
    };

        watch([patchFindInput, patchIgnoreWhitespace], updatePatchStatus);

    const updateJsonStatus = () => {
      if (!patchJsonInput.value.trim()) { patchJsonStatus.value = null; return; }
      try {
        let jsonStr = patchJsonInput.value.trim();
        jsonStr = jsonStr.replace(/^```json\s*/, '').replace(/^```\s*/, '').replace(/\s*```$/, '');
        const start = jsonStr.indexOf('['); const end = jsonStr.lastIndexOf(']');
        if (start > -1 && end > start) jsonStr = jsonStr.substring(start, end + 1);
        const items = JSON.parse(jsonStr);
        if (!Array.isArray(items)) throw new Error("é…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“");

        const full = editor ? editor.getValue() : '';
        let validCount = 0;
        const total = items.length;
        const { compact: compactFull } = patchIgnoreWhitespace.value ? buildCompacted(full) : { compact: null };
        const decodeEnt = (s) => s.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&#039;/g, "'");
        const encodeEnt = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

        for (const item of items) {
          if (!item.search) continue;
          const raw = item.search;
          const cands = new Set([raw, decodeEnt(raw), decodeEnt(decodeEnt(raw)), encodeEnt(raw)]);
          let matchFound = false;
          for (const cand of cands) {
            if (!patchIgnoreWhitespace.value) {
              if (full.indexOf(cand) !== -1) { matchFound = true; break; }
            } else {
              const cf = normalizeFind(cand);
              if (cf && compactFull.indexOf(cf) !== -1) { matchFound = true; break; }
            }
          }
          if (matchFound) validCount++;
        }
        if (validCount === total) {
          patchJsonStatus.value = { type: 'success', message: `OK: å…¨${total}ä»¶ã®ç½®æ›ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ` };
        } else {
          patchJsonStatus.value = { type: 'error', message: `æ³¨æ„: ${validCount}/${total}ä»¶ã®ã¿ä¸€è‡´ã€‚æ®‹ã‚Š${total - validCount}ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“` };
        }
      } catch(e) {
        patchJsonStatus.value = { type: 'error', message: "JSONè§£æã‚¨ãƒ©ãƒ¼: " + e.message };
      }
    };
    watch([patchJsonInput, patchIgnoreWhitespace], updateJsonStatus);

    // Emulator Device Mode
    const deviceModes = [
      { name: 'PC/ã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ', width: '100%', height: '100%', icon: 'fa-desktop' },
      { name: 'iPhone SE', width: '375px', height: '667px', icon: 'fa-mobile-screen-button' },
      { name: 'iPhone 14/15', width: '393px', height: '852px', icon: 'fa-mobile-screen' },
      { name: 'iPad Air', width: '820px', height: '1180px', icon: 'fa-tablet-screen-button' },
      { name: 'Android (Pixel)', width: '412px', height: '915px', icon: 'fa-mobile' },
    ];
        const currentDevice = ref(deviceModes[0]);
    const isRunLoading = ref(false);

    // Find/Replace custom UI
    const findUI = reactive({
      open: false,
      mode: 'find',
      find: '',
      replace: '',
            matchCount: 0,
      ignoreWhitespace: true,
      hint: '',
      x: 8,
      y: 8
    });
    const findInputEl = ref(null);
    const replaceInputEl = ref(null);
    let lastFindDirection = 1;

    // Drag state for Find UI
    let dragActive = false;
    let dragStartX = 0, dragStartY = 0;
    let dragBaseX = 0, dragBaseY = 0;

    // Editor & logs
    const editorStats = reactive({ lines: 0, chars: 0 });
    const consoleLogs = ref([]);
    let editor = null;

    // Full window handle
    let fullWin = null;
    let lastRunId = null;

    // Current identity
    const currentAppTitle = ref('');
    const currentGroupKey = ref('');
    const currentMeta = reactive({});

    // DB dump state
    const dbDump = reactive({ loading: false, error: '', items: [] });

    // Toast
    const toasts = ref([]);
    const pushToast = (title, message, iconClass='fa-circle-info text-sky-300', timeout=2200) => {
      const id = crypto.getRandomValues(new Uint32Array(1))[0].toString(16) + Date.now().toString(16);
      toasts.value.push({ id, title, message, iconClass });
      setTimeout(() => {
        const idx = toasts.value.findIndex(t => t.id === id);
        if (idx >= 0) toasts.value.splice(idx, 1);
      }, Math.max(900, timeout|0));
    };

    Â  Â  // --- SETTINGS DB ---
Â  Â  const DB_CFG = { name: 'AppStudio_DB', store: 'handles', key: 'root_dir' };
Â  Â  const getDB = () => new Promise((res, rej) => {
Â  Â  Â  const r = indexedDB.open(DB_CFG.name, 1);
Â  Â  Â  r.onupgradeneeded = e => {
Â  Â  Â  Â  const db = e.target.result;
Â  Â  Â  Â  if(!db.objectStoreNames.contains(DB_CFG.store)) db.createObjectStore(DB_CFG.store);
Â  Â  Â  };
Â  Â  Â  r.onsuccess = () => res(r.result);
Â  Â  Â  r.onerror = () => rej(r.error);
Â  Â  });
Â  Â  const saveRootHandle = async (h) => {
Â  Â  Â  try { const db = await getDB(); db.transaction(DB_CFG.store, 'readwrite').objectStore(DB_CFG.store).put(h, DB_CFG.key); } catch(e){}
Â  Â  };
Â  Â  const loadRootHandle = async () => {
Â  Â  Â  try {
Â  Â  Â  Â  const db = await getDB();
Â  Â  Â  Â  return new Promise(r => {
Â  Â  Â  Â  Â  const req = db.transaction(DB_CFG.store, 'readonly').objectStore(DB_CFG.store).get(DB_CFG.key);
Â  Â  Â  Â  Â  req.onsuccess = () => r(req.result);
Â  Â  Â  Â  Â  req.onerror = () => r(null);
Â  Â  Â  Â  });
Â  Â  Â  } catch { return null; }
Â  Â  };
Â  Â  const saveSecuritySettings = async () => {
Â  Â  Â  try {
Â  Â  Â  Â  const db = await getDB();
Â  Â  Â  Â  const tx = db.transaction(DB_CFG.store, 'readwrite').objectStore(DB_CFG.store);
Â  Â  Â  Â  tx.put(securitySettings.noFetch, 'sec_no_fetch');
Â  Â  Â  Â  tx.put(securitySettings.noTransmit, 'sec_no_transmit');
Â  Â  Â  } catch(e){}
Â  Â  };
Â  Â      const loadSecuritySettings = async () => {
      try {
        const db = await getDB();
        const store = db.transaction(DB_CFG.store, 'readonly').objectStore(DB_CFG.store);
        const g1 = new Promise(r => store.get('sec_no_fetch').onsuccess = e => r(e.target.result));
        const g2 = new Promise(r => store.get('sec_no_transmit').onsuccess = e => r(e.target.result));
        const [v1, v2] = await Promise.all([g1, g2]);
        if (v1 !== undefined) securitySettings.noFetch = v1;
        if (v2 !== undefined) securitySettings.noTransmit = v2;
      } catch { }
    };
    const saveEditorState = async () => {
      try {
        const db = await getDB();
        db.transaction(DB_CFG.store, 'readwrite').objectStore(DB_CFG.store).put(isEditorOpen.value, 'ui_editor_open');
      } catch(e){}
    };
    const loadEditorState = async () => {
      try {
        const db = await getDB();
        const store = db.transaction(DB_CFG.store, 'readonly').objectStore(DB_CFG.store);
        const v = await new Promise(r => store.get('ui_editor_open').onsuccess = e => r(e.target.result));
        if (v !== undefined) isEditorOpen.value = !!v;
      } catch { }
    };

        // --- UTIL ---
    const codeHistory = ref([]);

    const saveHistory = () => {
      if(!editor) return;
      const current = editor.getValue();
      if(codeHistory.value.length > 0 && codeHistory.value[codeHistory.value.length-1] === current) return;
      codeHistory.value.push(current);
      if(codeHistory.value.length > 50) codeHistory.value.shift();
    };

    const undoCode = () => {
      if(codeHistory.value.length === 0) return;
      const prev = codeHistory.value.pop();
      if(editor) {
        editor.setValue(prev);
        syncIdentityFromCode(prev);
        runEmulator(true); // å±¥æ­´ä¿å­˜ã›ãšå®Ÿè¡Œ
        pushToast('Undo', 'ç›´å‰ã®ã‚³ãƒ¼ãƒ‰ã«æˆ»ã—ã¾ã—ãŸ', 'fa-undo text-gray-300');
      }
    };

    const genId = () => {
      const buf = new Uint8Array(16);
      crypto.getRandomValues(buf);
      return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('');
    };

    const safeParseJSON = (s) => {
      try { return JSON.parse(s); } catch { return null; }
    };

    const extractTitleFromHtml = (html) => {
      const m = html.match(/<title>([\s\S]*?)<\/title>/i);
      return m ? m[1].trim() : '';
    };

    const extractMeta = (html) => {
      const m = html.match(/<script id="lfs-meta"\s+type="application\/json">\s*([\s\S]*?)\s*<\/script>/i);
      if (!m) return {};
      const j = safeParseJSON(m[1]);
      return j && typeof j === 'object' ? j : {};
    };

    const normalizeTs = (isoOrAny) => {
      if (!isoOrAny) return null;
      const d = new Date(isoOrAny);
      if (isNaN(d.getTime())) return null;
      return d;
    };

    const formatLocal = (d) => {
      try { return d.toLocaleString(); } catch { return String(d); }
    };

const injectMeta = (code, metaObj) => {
      const meta = JSON.stringify(metaObj, null, 2);
      // è‡ªå·±ç½®æ›å›é¿: ã“ã®ã‚³ãƒ¼ãƒ‰è‡ªä½“ãŒæ¤œç´¢ã«å¼•ã£ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã€ã‚¿ã‚°æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¦çµåˆã™ã‚‹
      const tagOpen = '<script id="lfs-meta" ' + 'type="application/json">';
      const tagClose = '<\/script>';
      const tag = `\n${tagOpen}\n${meta}\n${tagClose}\n`;

      // æ¤œç´¢å³å¯†åŒ–: ã‚³ãƒ¼ãƒ‰å†…ã®regexãƒªãƒ†ãƒ©ãƒ«(\s+ç­‰)ã«ãƒãƒƒãƒã—ãªã„ã‚ˆã†ã€å±æ€§é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚‚å³å¯†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã™ã‚‹
      const pattern = /<script id="lfs-meta" type="application\/json">[\s\S]*?<\/script>\s*/i;

      if (pattern.test(code)) {
        return code.replace(pattern, () => tag);
      }
      if (code.match(/<\/body>/i)) return code.replace(/<\/body>/i, () => tag + '</body>');
      return code + tag;
    };

    const miniHash = (s) => {
      // fast, stable (not crypto) - enough for grouping fallback
      let h = 2166136261;
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16).padStart(8,'0');
    };

    const stableGroupKeyFromFile = (text, meta, fileName) => {
      // Priority: meta.appId > meta.createdAt > (title + first 200 chars hash)
      if (meta && typeof meta.appId === 'string' && meta.appId.length >= 8) return `app:${meta.appId}`;
      if (meta && typeof meta.createdAt === 'string' && meta.createdAt.length >= 8) return `crt:${meta.createdAt}`;
      const title = (meta && meta.title) ? String(meta.title) : (extractTitleFromHtml(text) || '');
      const head = (text || '').slice(0, 240);
      return `h:${miniHash(title + '|' + head + '|' + (fileName||''))}`;
    };

    const syncIdentityFromCode = (code) => {
      const meta = extractMeta(code);
      const title = meta.title || extractTitleFromHtml(code) || 'App';
      const groupKey = stableGroupKeyFromFile(code, meta, currentFileName.value);

      currentAppTitle.value = title;
      currentGroupKey.value = groupKey;

      Object.keys(currentMeta).forEach(k => delete currentMeta[k]);
      Object.assign(currentMeta, meta);
    };

    const markHelpSeen = () => {
      modals.help = false;
      try { localStorage.setItem('appstudio_v4_help_seen', '1'); } catch(e){}
    };

    // --- MONACO INIT ---
    onMounted(async () => {
      // åˆå›è¨ªå•ãªã‚‰ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
      try {
        if (!localStorage.getItem('appstudio_v4_help_seen')) {
          modals.help = true;
        }
      } catch(e){}

      initMonaco();

      Â  Â  Â        // è¨­å®šä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãƒãƒ³ãƒ‰ãƒ«ã®å¾©å…ƒ
      const saved = await loadRootHandle();
      if (saved) projectRootHandle.value = saved;
      await loadSecuritySettings();
      await loadEditorState();

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.relative')) menus.file = false;
      });

      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runEmulator(); return; }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) { e.preventDefault(); openFindReplace('find'); return; }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'h' || e.key === 'H')) { e.preventDefault(); openFindReplace('replace'); return; }
        if (e.key === 'Escape' && findUI.open) { e.preventDefault(); closeFindReplace(); return; }
      });

      // message receiver from preview iframes/windows
            window.addEventListener('message', (e) => {
        const d = e.data || {};
        if (d?.type === 'request_ai_fix') {
          const err = d.error || 'Unknown Error';
          const code = editor ? editor.getValue() : '';
          const prompt = `ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nåŸå› ã‚’ç‰¹å®šã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸]\n${err}\n\n[ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰]\n\`\`\`html\n${code}\n\`\`\``;
          navigator.clipboard.writeText(prompt).then(() => {
             pushToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'ã€ŒAIæŒ‡ç¤ºã€ã‚’é–‹ã„ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'fas fa-robot text-purple-300', 4000);
          }).catch(e => alert("ã‚³ãƒ”ãƒ¼å¤±æ•—: " + e));
          return;
        }
        if (d?.type === 'console') {
          consoleLogs.value.push({ type: d.l, message: d.m });
          return;
        }
                if (d?.type === 'idb_dump_result') {
          if (d?.runId && d.runId !== lastRunId) return;
          dbDump.loading = false;
          dbDump.error = d.error || '';
          dbDump.items = Array.isArray(d.items) ? d.items : [];
          return;
        }
      });

      const loader = document.getElementById('loading-screen');
      if (loader) {
        loader.style.opacity = '0';
        loader.style.transition = 'opacity 0.5s';
        setTimeout(() => loader.remove(), 500);
      }
    });

    const initMonaco = () => {
      require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
      require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor-container'), {
          value: document.getElementById('default-code').innerHTML.trim(),
          language: 'html',
          theme: 'vs-dark',
          automaticLayout: true,
          minimap: { enabled: false },
          fontSize: 14,
          scrollBeyondLastLine: false,
        });

        const updateStats = () => {
          const model = editor.getModel();
          editorStats.lines = model.getLineCount();
          editorStats.chars = model.getValueLength();
        };

        editor.onDidChangeModelContent(() => {
          updateStats();
          if (findUI.open) recomputeMatchCount();
        });
        updateStats();

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyF, () => openFindReplace('find'));
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyH, () => openFindReplace('replace'));
        editor.addCommand(monaco.KeyCode.Escape, () => { if(findUI.open) closeFindReplace(); });

        // identity from initial code
        syncIdentityFromCode(editor.getValue());
        runEmulator();
      });
    };

        // --- FIND/REPLACE (WHITESPACE-IGNORING SUPPORTED) ---
    const buildCompacted = (src) => {
      const compactChars = [];
      const mapNormToOrig = [];
      for (let i = 0; i < src.length; i++) {
        const ch = src[i];
        // Ignore whitespace, quotes, and backticks for robust AI matching
        if (/[\s'"`]/.test(ch)) continue;
        mapNormToOrig.push(i);
        compactChars.push(ch);
      }
      return { compact: compactChars.join(""), mapNormToOrig };
    };
    const normalizeFind = (src) => (src || '').replace(/[\s'"`]+/g, '');

    const getMatches = () => {
      if(!editor) return [];
      const qRaw = findUI.find || '';
      if(!qRaw) { findUI.matchCount = 0; return []; }

      const model = editor.getModel();
      const full = model.getValue();

      if(!findUI.ignoreWhitespace) {
        const matches = model.findMatches(qRaw, true, false, false, null, true);
        findUI.matchCount = matches.length;
        return matches;
      }

      const compactFind = normalizeFind(qRaw);
      if(!compactFind) { findUI.matchCount = 0; return []; }

      const { compact: compactFull, mapNormToOrig } = buildCompacted(full);

      const ranges = [];
      let idx = 0;
      while(true) {
        const p = compactFull.indexOf(compactFind, idx);
        if (p === -1) break;

        const startOrig = mapNormToOrig[p];
        const endOrig = mapNormToOrig[p + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

        ranges.push({ range });
        idx = p + Math.max(1, compactFind.length);
      }

      findUI.matchCount = ranges.length;
      return ranges;
    };

        const recomputeMatchCount = () => {
      getMatches();
      if (findUI.matchCount === 0 && findUI.find) {
        const hint = findPossibleRange(findUI.find);
        findUI.hint = hint ? hint.replace(/[\r\n]+/g, ' ').trim() : '';
      } else {
        findUI.hint = '';
      }
    };

    const selectMatch = (match) => {
      if(!editor || !match?.range) return;
      editor.setSelection(match.range);
      editor.revealRangeInCenter(match.range);
      editor.focus();
    };

    const openFindReplace = (mode='find') => {
      findUI.open = true;
      findUI.mode = mode;

      recomputeMatchCount();
      setTimeout(() => {
        if (mode === 'replace') (replaceInputEl.value || findInputEl.value)?.focus?.();
        else (findInputEl.value || replaceInputEl.value)?.focus?.();
      }, 0);
    };

    const closeFindReplace = () => {
      findUI.open = false;
      editor?.focus?.();
      stopDragFindUI();
    };

    const findNext = () => {
      if(!editor) return;
      lastFindDirection = 1;
      const matches = getMatches();
      if(!matches.length) return;

      const model = editor.getModel();
      const sel = editor.getSelection();
      const curOffset = sel ? model.getOffsetAt(sel.getStartPosition()) : 0;

      let next = null;
      for (const m of matches) {
        const off = model.getOffsetAt(m.range.getStartPosition());
        if (off > curOffset) { next = m; break; }
      }
      if(!next) next = matches[0];
      selectMatch(next);
    };

    const findPrev = () => {
      if(!editor) return;
      lastFindDirection = -1;
      const matches = getMatches();
      if(!matches.length) return;

      const model = editor.getModel();
      const sel = editor.getSelection();
      const curOffset = sel ? model.getOffsetAt(sel.getStartPosition()) : 0;

      let prev = null;
      for (let i = matches.length - 1; i >= 0; i--) {
        const off = model.getOffsetAt(matches[i].range.getStartPosition());
        if (off < curOffset) { prev = matches[i]; break; }
      }
      if(!prev) prev = matches[matches.length - 1];
      selectMatch(prev);
    };

    const replaceOne = () => {
      if(!editor) return;
      const qRaw = findUI.find || '';
      if(!qRaw) return;

      (lastFindDirection === -1 ? findPrev : findNext)();
      const model = editor.getModel();
      const sel = editor.getSelection();
      if(!sel || sel.isEmpty()) return;

      const selectedText = model.getValueInRange(sel);

      if(!findUI.ignoreWhitespace) {
        if(selectedText !== qRaw) return;
        editor.executeEdits('findui-replace-one', [{ range: sel, text: findUI.replace }]);
        editor.pushUndoStop();
        findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
        recomputeMatchCount();
        pushToast('ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', '1ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚', 'fa-circle-check text-emerald-300', 1800);
        return;
      }

      if (normalizeFind(selectedText) !== normalizeFind(qRaw)) return;

      editor.executeEdits('findui-replace-one', [{ range: sel, text: findUI.replace }]);
      editor.pushUndoStop();
      findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
      recomputeMatchCount();
      pushToast('ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', '1ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚ï¼ˆç©ºç™½ç„¡è¦–ï¼‰', 'fa-circle-check text-emerald-300', 2000);
    };

    const replaceAll = () => {
      if(!editor) return;
      const qRaw = findUI.find || '';
      if(!qRaw) return;

      const model = editor.getModel();
      const full = model.getValue();
      const replaceText = findUI.replace;

      if(!findUI.ignoreWhitespace) {
        const matches = model.findMatches(qRaw, true, false, false, null, true);
        findUI.matchCount = matches.length;
        if(!matches.length) return;

        const edits = matches
          .slice()
          .sort((a,b) => model.getOffsetAt(b.range.getStartPosition()) - model.getOffsetAt(a.range.getStartPosition()))
          .map(m => ({ range: m.range, text: replaceText }));

        editor.pushUndoStop();
        editor.executeEdits('findui-replace-all', edits);
        editor.pushUndoStop();
        findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
        recomputeMatchCount();
        pushToast('å…¨ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', `${edits.length}ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚`, 'fa-circle-check text-emerald-300', 2200);
        return;
      }

      const compactFind = normalizeFind(qRaw);
      if(!compactFind) return;

      const { compact: compactFull, mapNormToOrig } = buildCompacted(full);

      const found = [];
      let idx = 0;
      while(true) {
        const p = compactFull.indexOf(compactFind, idx);
        if (p === -1) break;

        const startOrig = mapNormToOrig[p];
        const endOrig = mapNormToOrig[p + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);
        found.push(range);

        idx = p + Math.max(1, compactFind.length);
      }

      findUI.matchCount = found.length;
      if (!found.length) return;

      const edits = found
        .slice()
        .sort((a,b) => model.getOffsetAt(b.getStartPosition()) - model.getOffsetAt(a.getStartPosition()))
        .map(r => ({ range: r, text: replaceText }));

      editor.pushUndoStop();
      editor.executeEdits('findui-replace-all', edits);
      editor.pushUndoStop();
      findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
      recomputeMatchCount();
      pushToast('å…¨ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', `${edits.length}ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚ï¼ˆç©ºç™½ç„¡è¦–ï¼‰`, 'fa-circle-check text-emerald-300', 2400);
    };

    // --- DRAG FIND UI ---
    const startDragFindUI = (e) => {
      dragActive = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      dragBaseX = findUI.x || 0;
      dragBaseY = findUI.y || 0;

      window.addEventListener('mousemove', onDragFindUI);
      window.addEventListener('mouseup', stopDragFindUI, { once: true });
    };

    const onDragFindUI = (e) => {
      if (!dragActive) return;
      const dx = e.clientX - dragStartX;
      const dy = e.clientY - dragStartY;

      const pane = document.getElementById('editor-pane');
      const rect = pane ? pane.getBoundingClientRect() : { left:0, top:0, width: window.innerWidth, height: window.innerHeight };

      const maxX = Math.max(8, rect.width - 60);
      const maxY = Math.max(8, rect.height - 60);

      let nx = dragBaseX + dx;
      let ny = dragBaseY + dy;

      nx = Math.min(maxX, Math.max(8, nx));
      ny = Math.min(maxY, Math.max(8, ny));

      findUI.x = nx;
      findUI.y = ny;
    };

    const stopDragFindUI = () => {
      dragActive = false;
      window.removeEventListener('mousemove', onDragFindUI);
    };

    // --- PROJECT & FILE OPS ---
    const setProject = async (handle, name) => {
      projectHandle.value = handle;
      projectDisplayName.value = name;
      appMode.value = 'project';
      menus.file = false;
    };

    const ensureDirPermission = async (dir) => {
      try{
        if (!dir) return false;
        if (!dir.queryPermission) return true;
        let p = await dir.queryPermission({ mode: 'readwrite' });
        if (p !== 'granted') p = await dir.requestPermission({ mode: 'readwrite' });
        return p === 'granted';
      } catch {
        return true;
      }
    };

    const refreshLibrary = async () => {
      // CLEAR
      libraryFiles.value = [];
      libraryScanStatus.value = 'scanning...';

      // MODE CHECK
      const isProjectListMode = (historyMode.value === 'group');
      const targetHandle = isProjectListMode ? projectRootHandle.value : projectHandle.value;

      if (!targetHandle) {
        libraryScanStatus.value = isProjectListMode ? 'Root folder not set' : 'No project selected';
        if(isProjectListMode) {
          pushToast('è¨­å®šãŒå¿…è¦ã§ã™', 'ã€Œè¨­å®šã€ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å…ˆã®è¦ªãƒ•ã‚©ãƒ«ãƒ€(Root)ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', 'fa-cog text-gray-300', 4000);
          modals.settings = true;
        }
        return;
      }

      // PERMISSION CHECK
      const ok = await ensureDirPermission(targetHandle);
      if (!ok) {
        libraryScanStatus.value = 'permission denied';
        pushToast('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚å†åº¦é¸æŠã—ã¦ãã ã•ã„ã€‚', 'fa-triangle-exclamation text-amber-300', 3400);
        return;
      }

      const files = [];
      let scanned = 0;
      let readable = 0;
      let failed = 0;

      try {
        if (isProjectListMode) {
          // --- ROOT SCAN (Project List) ---
          // ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ—æŒ™ã—ã€å„ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ã€Œæœ€ã‚‚æ–°ã—ã„HTMLã€ã‚’1ã¤æ¢ã™
          for await (const entry of targetHandle.values()) {
            if (entry.kind !== 'directory') continue; // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®ã¿å¯¾è±¡
            
            scanned++;
            let latestFile = null;
            let latestTime = 0;

            // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’æµ…ãã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æœ€æ–°ã‚’æ¢ã™
            try {
               for await (const subEntry of entry.values()) {
                 if (subEntry.kind !== 'file') continue;
                 const low = subEntry.name.toLowerCase();
                 if(!(low.endsWith('.html') || low.endsWith('.htm'))) continue;
                 
                 const file = await subEntry.getFile();
                 const mTime = file.lastModified;
                 if (mTime > latestTime) {
                   latestTime = mTime;
                   latestFile = { handle: subEntry, file: file };
                 }
               }
            } catch(e) { console.warn("Subfolder scan error", e); }

            if (latestFile) {
               try {
                 const text = await latestFile.file.text();
                 const meta = extractMeta(text);
                 const title = meta.title || entry.name; // ãƒ¡ã‚¿ã‚¿ã‚¤ãƒˆãƒ«å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ«ãƒ€å
                 const savedAt = new Date(latestTime);
                 
                 // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã‚°ãƒ«ãƒ¼ãƒ—ã‚­ãƒ¼ã‚’ã€Œãƒ•ã‚©ãƒ«ãƒ€åã€ã«ã™ã‚‹
                 const groupKey = entry.name; 

                 readable++;
                 files.push({
                    name: entry.name + '/' + latestFile.handle.name,
                    handle: latestFile.handle,
                    content: text,
                    meta,
                    displayTitle: title,
                    savedAt,
                    savedAtStr: formatLocal(savedAt),
                    groupKey,
                    relPath: entry.name + '/',
                    projectDirHandle: entry,
                    projectName: entry.name
                  });
               } catch (e) {
                 failed++;
               }
            }
          }
        } else {
          // --- CURRENT PROJECT SCAN (Flat History) ---
          // æ—¢å­˜ã®å†å¸°ã‚¹ã‚­ãƒ£ãƒ³
          const walk = async (dirHandle, relPath, depth) => {
            if (depth > 10) return;
            for await (const entry of dirHandle.values()) {
              if(entry.kind === 'directory') {
                await walk(entry, relPath + entry.name + '/', depth + 1);
                continue;
              }
              if(entry.kind !== 'file') continue;
              const low = entry.name.toLowerCase();
              if(!(low.endsWith('.html') || low.endsWith('.htm'))) continue;

              scanned++;
              try {
                const file = await entry.getFile();
                const text = await file.text();
                const meta = extractMeta(text);
                const title = meta.title || extractTitleFromHtml(text) || entry.name;
                const savedAt = normalizeTs(meta.savedAt) || new Date(file.lastModified);
                const groupKey = stableGroupKeyFromFile(text, meta, entry.name);

                readable++;
                files.push({
                  name: relPath + entry.name,
                  handle: entry,
                  content: text,
                  meta,
                  displayTitle: title,
                  savedAt,
                  savedAtStr: formatLocal(savedAt),
                  groupKey,
                  relPath
                });
              } catch(e) {
                failed++;
                files.push({
                  name: relPath + entry.name,
                  handle: entry,
                  content: '',
                  meta: {},
                  displayTitle: entry.name,
                  savedAt: new Date(0),
                  savedAtStr: '(read error)',
                  groupKey: stableGroupKeyFromFile(entry.name, {}, entry.name),
                  relPath,
                  readError: true
                });
              }
            }
          };
          await walk(targetHandle, '', 0);
        }

        // ã‚½ãƒ¼ãƒˆ: æ–°ã—ã„é †
        files.sort((a,b) => (b.savedAt?.getTime?.()||0) - (a.savedAt?.getTime?.()||0));
        libraryFiles.value = files;

        libraryScanStatus.value = `done (scanned:${scanned}, items:${files.length})`;
        
        if (files.length === 0) {
          pushToast('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€ã«HTMLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'fa-circle-info text-sky-300', 2000);
        } else {
          const modeName = isProjectListMode ? 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§' : 'å±¥æ­´';
          pushToast(`${modeName}ã‚’æ›´æ–°`, `${files.length}ä»¶ èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`, 'fa-rotate text-teal-300', 1500);
        }

      } catch(e) {
        libraryScanStatus.value = 'error';
        console.error(e);
        pushToast('èª­è¾¼ã‚¨ãƒ©ãƒ¼', e?.message || String(e), 'fa-triangle-exclamation text-rose-300', 3600);
      }
    };

    const revealCurrentFolder = async () => {
      const h = (historyMode.value === 'group') ? projectRootHandle.value : projectHandle.value;
      if (!h) {
        pushToast('ç¢ºèªä¸å¯', 'ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'fa-triangle-exclamation text-amber-300');
        return;
      }
      // Browser Security Limitation: Cannot open explorer directly.
      alert(`ã€ç¾åœ¨ã®ä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ã€‘\nğŸ“‚ ${h.name}\n\nâ€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã€ç›´æ¥ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚\nä¸Šè¨˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„ã€‚`);
    };

    const setProjectRoot = async () => {
      try {
        const handle = await window.showDirectoryPicker({ id: 'localforge_root', mode: 'readwrite' });
        projectRootHandle.value = handle;
        await saveRootHandle(handle);
        pushToast('è¨­å®šå®Œäº†', `è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’ã€Œ${handle.name}ã€ã«è¨­å®šãƒ»ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'fa-check text-green-300');
      } catch(e) { /* cancel */ }
    };

    const createNewProject = async () => {
      try {
        // è¨­å®šæ¸ˆã¿ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼ˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        let parentHandle = projectRootHandle.value;
        if (!parentHandle) {
          parentHandle = await window.showDirectoryPicker({ id: 'localforge_root', mode: 'readwrite' });
        } else {
          // æ¨©é™ç¢ºèªã®ã¿è¡Œã†ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯å‡ºãªã„ã€ã¾ãŸã¯æ¨©é™è¨±å¯ã®ã¿ï¼‰
          await ensureDirPermission(parentHandle);
        }

        const name = prompt("æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "NewApp");
        if(!name) return;

        const newDirHandle = await parentHandle.getDirectoryHandle(name, { create: true });
        await setProject(newDirHandle, name);

        const fileHandle = await newDirHandle.getFileHandle('index_v1.html', { create: true });
        const writable = await fileHandle.createWritable();
        
        // æ–°è¦æ™‚ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã‚ãšã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã™ã‚‹
        const seed = "";

        const nowIso = new Date().toISOString();
        const seedMeta = {
          schema: 2,
          appId: genId(),
          createdAt: nowIso,
          savedAt: nowIso,
          title: 'New App',
          aiInstruction: '',
          comment: 'initial',
          runId: ''
        };
        
                const initialContent = injectMeta(seed, seedMeta);
        await writable.write(initialContent);
        await writable.close();

        // ä½œæˆã—ãŸç©ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«å³æ™‚ãƒ­ãƒ¼ãƒ‰
        editor.setValue(''); // ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã¯ç©ºæ¬„ã‚¹ã‚¿ãƒ¼ãƒˆ
        currentFileName.value = 'index_v1.html';
        syncIdentityFromCode(initialContent); // ãƒ¡ã‚¿æƒ…å ±ã¯ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
        runEmulator();

                await refreshLibrary();
        pushToast('ä½œæˆå®Œäº†', `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚`, 'fa-check text-green-300', 2000);
        
        // åˆå¿ƒè€…å‘ã‘èª˜å°ãƒˆãƒ¼ã‚¹ãƒˆ
        setTimeout(() => {
          pushToast('ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—', 'ã¾ãšã¯ã€ŒAIæŒ‡ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œå…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼', 'fa-robot text-purple-300', 4000);
        }, 1200);
      } catch(e) {
        console.error(e);
        if(e.name !== 'AbortError') alert("ä½œæˆã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    };

    const openProjectFolder = async () => {
      try {
        // è¨­å®šæ¸ˆã¿ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ãã“ã‚’èµ·ç‚¹ã«é–‹ã
        const opts = { id: 'localforge_root', mode: 'readwrite' };
        if (projectRootHandle.value) opts.startIn = projectRootHandle.value;

        const handle = await window.showDirectoryPicker(opts);
        await setProject(handle, handle.name);

        isSidebarOpen.value = true;
        historyMode.value = 'flat';

        await refreshLibrary();
      } catch(e) { if(e.name !== 'AbortError') alert(e.message); }
    };

    const openSingleFile = async () => {
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'HTML Files', accept: {'text/html': ['.html', '.htm']} }]
        });
        const file = await handle.getFile();
        const text = await file.text();

        editor.setValue(text);
        currentFileHandle.value = handle;
        currentFileName.value = file.name;
        projectDisplayName.value = file.name + " (å˜ç™º)";
        appMode.value = 'single';
        menus.file = false;

        syncIdentityFromCode(text);
        runEmulator();
      } catch(e) { if(e.name !== 'AbortError') alert(e.message); }
    };

const createNewSingleApp = async () => {
  // ç›®çš„ï¼šå˜ç™ºæ–°è¦ï¼ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Œå…¨ãƒ–ãƒ©ãƒ³ã‚¯ï¼ˆã‚³ãƒ”ãƒšå³é–‹å§‹ï¼‰
  menus.file = false;

  appMode.value = 'single';
            projectHandle.value = null;
      currentFileHandle.value = null;
      currentFileName.value = '';
      projectDisplayName.value = 'æ–°è¦ã‚¢ãƒ—ãƒª (å˜ç™º)';

      // â˜…ã“ã“ãŒæœ¬é¡Œï¼šãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å…¥ã‚Œãšç©ºã«ã™ã‚‹
  editor.setValue('');

  // identity / meta ã‚’ç©ºã‚³ãƒ¼ãƒ‰ã¨ã—ã¦åŒæœŸ
  syncIdentityFromCode('');
  aiInstruction.value = '';
  saveComment.value = '';

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€Œç©ºã‚³ãƒ¼ãƒ‰ã€è¡¨ç¤ºã«ã™ã‚‹ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã¯ç©ºã®ã¾ã¾ï¼‰
    runEmulator();
  pushToast('å˜ç™ºæ–°è¦', 'ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã—ã¾ã—ãŸã€‚ã“ã“ã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚', 'fa-circle-check text-emerald-300', 2200);

  // åˆå¿ƒè€…å‘ã‘èª˜å°ãƒˆãƒ¼ã‚¹ãƒˆ
  setTimeout(() => {
    pushToast('ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—', 'ã¾ãšã¯ã€ŒAIæŒ‡ç¤ºã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œå…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼', 'fa-robot text-purple-300', 4000);
  }, 1200);
};

    const openProjectFromList = async (fileItem) => {
      // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
      await loadFile(fileItem.handle);

      // 2. ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      if (fileItem.projectDirHandle) {
        await setProject(fileItem.projectDirHandle, fileItem.projectName);
        
        // 3. ãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œã“ã®PJã®å±¥æ­´ã€ã«åˆ‡ã‚Šæ›¿ãˆ
        historyMode.value = 'flat';
        
        // 4. æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å±¥æ­´å†ã‚¹ã‚­ãƒ£ãƒ³
        await refreshLibrary();
        
        pushToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã¾ã—ãŸ', `${fileItem.projectName} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`, 'fa-folder-open text-blue-300');
      }
    };

        const loadFile = async (handle) => {
      codeHistory.value = [];
      const file = await handle.getFile();
      const text = await file.text();

      editor.setValue(text);
      currentFileName.value = handle.name;

      syncIdentityFromCode(text);

      // æ–°ãŸã«é–‹ã„ãŸã¨ãã¯ãƒªã‚»ãƒƒãƒˆï¼ˆå¼•ãç¶™ãŒãªã„ï¼‰
      aiInstruction.value = '';
      aiPromptInput.value = '';
      saveComment.value = '';

      runEmulator();
    };

    const runExternal = async (fileEntry) => {
      // fileEntry can be from grouped/flat, should include handle
      try{
        const file = await fileEntry.handle.getFile();
        const text = await file.text();
        const runId = genId();
        const shim = buildPreviewShim(runId);
        const safeCode = injectShimIntoHtml(text, shim);
        const blob = new Blob([safeCode], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        // æ–°è¦ã‚¿ãƒ–ã§é–‹ã (_blank)
        window.open(url, '_blank', 'noopener,noreferrer');
      } catch(e){
        alert("åˆ¥çª“å®Ÿè¡Œã«å¤±æ•—: " + (e.message || String(e)));
      }
    };

    // --- COMPUTED: GROUPED HISTORY ---
    const libraryFilesFlat = computed(() => libraryFiles.value);

    const groupedApps = computed(() => {
      const map = new Map();
      for (const f of libraryFiles.value) {
        const key = f.groupKey || 'unknown';
        if (!map.has(key)) map.set(key, { groupKey: key, versions: [], open: false });
        map.get(key).versions.push(f);
      }

      const arr = Array.from(map.values()).map(grp => {
        const versions = grp.versions.slice().sort((a,b)=> (b.savedAt?.getTime?.()||0) - (a.savedAt?.getTime?.()||0));
        const latest = versions[0];
        const latestTitle = latest?.displayTitle || '';
        const latestAiInstruction = (latest?.meta?.aiInstruction || latest?.meta?.comment || '').trim();

        return {
          groupKey: grp.groupKey,
          open: grp.open,
          versions,
          latestTitle,
          latestAiInstruction
        };
      });

      arr.sort((a,b)=> {
        const at = a.versions[0]?.savedAt?.getTime?.()||0;
        const bt = b.versions[0]?.savedAt?.getTime?.()||0;
        return bt - at;
      });

      return arr;
    });

    // --- GITHUB INTEGRATION ---
    onMounted(() => {
      const savedGh = localStorage.getItem('appstudio_gh_config');
      if(savedGh) { try { Object.assign(githubSettings, JSON.parse(savedGh)); } catch(e){} }
    });

    const publishToGithub = async () => {
      githubStatus.value = 'Preparing...'; githubUrl.value = '';
      const { token, repo, branch, path } = githubSettings;
      if(!token || !repo || !path) { githubStatus.value = 'Error: Token, Repo, Path are required.'; return; }
      
      localStorage.setItem('appstudio_gh_config', JSON.stringify(githubSettings));
      const headers = { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'X-GitHub-Api-Version': '2022-11-28' };

      try {
        githubStatus.value = 'Fetching user info...';
        const userRes = await fetch('https://api.github.com/user', { headers });
        if(!userRes.ok) throw new Error('Token invalid or network error');
        const user = await userRes.json();
        const owner = user.login;

        githubStatus.value = `Checking repo ${owner}/${repo}...`;
        let repoRes = await fetch(`https://api.github.com/repos/${owner}/${repo}`, { headers });
        if(repoRes.status === 404) {
          if(!confirm(`ãƒªãƒã‚¸ãƒˆãƒª '${owner}/${repo}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) throw new Error('Aborted');
          githubStatus.value = 'Creating repository...';
          const createRes = await fetch('https://api.github.com/user/repos', { method: 'POST', headers, body: JSON.stringify({ name: repo, auto_init: true }) });
          if(!createRes.ok) throw new Error('Failed to create repo');
          await new Promise(r => setTimeout(r, 2000));
        }

        githubStatus.value = 'Checking existing file...';
        let sha = null;
        const fileRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers });
        if(fileRes.ok) { const d = await fileRes.json(); sha = d.sha; }

        githubStatus.value = 'Uploading content...';
        const content = editor.getValue();
        const contentBase64 = btoa(unescape(encodeURIComponent(content)));

        const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT', headers,
          body: JSON.stringify({ message: `Update ${path} via AppStudio`, content: contentBase64, branch: branch, sha: sha || undefined })
        });
        if(!putRes.ok) { const err = await putRes.json(); throw new Error(err.message); }

        try { await fetch(`https://api.github.com/repos/${owner}/${repo}/pages`, { method: 'POST', headers, body: JSON.stringify({ source: { branch: branch, path: '/' } }) }); } catch(e){}

        githubStatus.value = 'âœ… Upload Success!';
        githubUrl.value = `https://${owner}.github.io/${repo}/${path === 'index.html' ? '' : path}`;
        pushToast('Uploadå®Œäº†', 'GitHubã¸ã®åæ˜ ã«æˆåŠŸã—ã¾ã—ãŸã€‚', 'fab fa-github text-white');
            } catch(e) {
        githubStatus.value = 'Error: ' + e.message;
      }
    };

    const openGithubModal = () => {
      modals.github = true;
      githubStatus.value = '';
      // é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ
      if (currentFileName.value) {
        githubSettings.path = currentFileName.value;
      } else {
        githubSettings.path = 'index.html';
      }
    };

    // --- SAVE LOGIC ---
    const openSaveModal = () => {
      // â‘ (è“„ç©)ã‚’â‘¡(åˆæœŸå€¤)ã«åŒæœŸã€‚ãƒãƒ³ãƒ‰ä¿®æ­£(â‘¢)ãŒç©ºãªã‚‰å…¥ã‚Œã‚‹ã€‚
      if (!saveComment.value && aiInstruction.value) {
        saveComment.value = aiInstruction.value;
      }

      const now = new Date();
      const ts =
        now.getFullYear() +
        (now.getMonth()+1).toString().padStart(2,'0') +
        now.getDate().toString().padStart(2,'0') + '_' +
        now.getHours().toString().padStart(2,'0') +
        now.getMinutes().toString().padStart(2,'0');

      let base = (currentAppTitle.value || 'App').replace(/[\\\/:*?"<>|]/g,'_').slice(0,40);
      if(!base) base = 'App';

      saveFilename.value = `${base}_${ts}.html`;

      // å˜ç™ºã‚¢ãƒ—ãƒªã®å ´åˆã¯ç·¨é›†ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€OSæ¨™æº–ã®ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¸ç›´è¡Œ
      if (appMode.value === 'single') {
        performSave();
        return;
      }

      modals.save = true;
    };

    const performSave = async () => {
      try {
        let filename = saveFilename.value || 'App.html';
        if(!filename.toLowerCase().endsWith('.html')) filename += '.html';

        const rawCode = editor.getValue();
        const metaExisting = extractMeta(rawCode);

        const nowIso = new Date().toISOString();

                // Ensure identifiers
        const title = metaExisting.title || extractTitleFromHtml(rawCode) || currentAppTitle.value || 'App';

        // We keep appId stable if present; otherwise create (and set createdAt)
        const finalMeta = { ...metaExisting };
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ãŒç©ºã§ã‚¿ã‚°ãŒãªã„å ´åˆã€ãƒ¡ãƒ¢ãƒªä¸Šã®ç¾åœ¨ã®æƒ…å ±ã‚’å¼•ãç¶™ã
        if (!finalMeta.appId && currentMeta.appId) finalMeta.appId = currentMeta.appId;
        if (!finalMeta.createdAt && currentMeta.createdAt) finalMeta.createdAt = currentMeta.createdAt;

        if (!finalMeta.appId) finalMeta.appId = genId();
        if (!finalMeta.createdAt) finalMeta.createdAt = nowIso;

        finalMeta.schema = 2;
        finalMeta.title = title;
        finalMeta.savedAt = nowIso;
        
        // â‘¢ãŒâ‘£ã«åæ˜ ã•ã‚Œã‚‹ï¼ˆãƒãƒ³ãƒ‰ä¿®æ­£å†…å®¹ã‚’æ­£ã¨ã—ã¦ä¸¡æ–¹ã«è¨˜éŒ²ï¼‰
        const finalNote = (saveComment.value || '').trim();
        finalMeta.aiInstruction = finalNote;
        finalMeta.comment = finalNote;
        
        finalMeta.sourceMode = appMode.value;
        finalMeta.runId = lastRunId || '';

        const codeWithMeta = injectMeta(rawCode, finalMeta);

        if (appMode.value === 'project') {
          if(!projectHandle.value) throw new Error("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæœªé¸æŠã§ã™ã€‚");

          const newHandle = await projectHandle.value.getFileHandle(filename, { create: true });
          const writable = await newHandle.createWritable();
          await writable.write(codeWithMeta);
          await writable.close();

          currentFileName.value = filename;
          syncIdentityFromCode(codeWithMeta);

          await refreshLibrary();
          modals.save = false;
          // ä¿å­˜å®Œäº†ã§ãƒªã‚»ãƒƒãƒˆ
          saveComment.value = '';
          aiInstruction.value = '';
          aiPromptInput.value = '';

          editor.setValue(codeWithMeta);
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ï¼‰: " + filename);
          return;
        }

        if ('showSaveFilePicker' in window) {
          const picker = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }]
          });
          const writable = await picker.createWritable();
          await writable.write(codeWithMeta);
          await writable.close();

          currentFileHandle.value = picker;
          currentFileName.value = filename;
          projectDisplayName.value = filename + " (å˜ç™º)";
          syncIdentityFromCode(codeWithMeta);

          modals.save = false;
          // ä¿å­˜å®Œäº†ã§ãƒªã‚»ãƒƒãƒˆ
          saveComment.value = '';
          aiInstruction.value = '';
          aiPromptInput.value = '';

          editor.setValue(codeWithMeta);
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆæŒ‡å®šå…ˆï¼‰: " + filename);
          return;
        }

        // Fallback download
        const blob = new Blob([codeWithMeta], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();

        currentFileName.value = filename;
        projectDisplayName.value = filename + " (å˜ç™º)";
        syncIdentityFromCode(codeWithMeta);

        modals.save = false;
        saveComment.value = '';
        aiInstruction.value = '';
        aiPromptInput.value = '';
        editor.setValue(codeWithMeta);
        alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ä¿å­˜ã—ã¾ã—ãŸ: " + filename);

      } catch(e) {
        if(e.name !== 'AbortError') alert("ä¿å­˜å¤±æ•—: " + (e.message || String(e)));
      }
    };

    // --- AI PROMPT ---
            const openAiModal = () => {
      // ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆæœªä½œæˆçŠ¶æ…‹ï¼‰ã§ã®è­¦å‘Š
      if (projectDisplayName.value === 'é–‹ç™ºã‚’ã¯ã˜ã‚ã‚‹') {
        const msg = "ã€ãƒ’ãƒ³ãƒˆã€‘\nç¾åœ¨ã¯ãƒ‡ãƒ¢ç”»é¢ï¼ˆãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼‰ã§ã™ã€‚\nã“ã®ã¾ã¾æŒ‡ç¤ºã‚’å‡ºã™ã¨ã€ãƒ‡ãƒ¢ç”¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¸ã®ä¿®æ­£ã¨ãªã‚Šã¾ã™ã€‚\n\nã¯ã˜ã‚ã¦ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹å ´åˆã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å·¦ä¸Šã®ãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰\nã€Œæ–°è¦ä½œæˆã€ã‚’è¡Œã£ã¦ã‹ã‚‰é–‹å§‹ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚\n\nã“ã®ã¾ã¾AIæŒ‡ç¤ºç”»é¢ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ";
        if (!confirm(msg)) return;
      }

      modals.ai = true;
      aiMessage.value = '';
      aiPromptInput.value = ''; // å…¥åŠ›æ¬„ã¯å¸¸ã«ã‚¯ãƒªã‚¢ï¼ˆéå»ã®èª­è¾¼ã¯ã—ãªã„ï¼‰
      // ã‚¨ãƒ‡ã‚£ã‚¿ãŒç©ºãªã‚‰è‡ªå‹•ã§å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
      if (editor && !editor.getValue().trim()) {
        aiTab.value = 'full';
      }
    };

    Â  Â  const generateAndCopyPrompt = () => {
      const input = (aiPromptInput.value || '').trim();
      
      // â‘ : è“„ç© (è¤‡æ•°ã‚ã‚‹å ´åˆã¯é€£çµ)
      if (input) {
        const sep = aiInstruction.value ? '\n\n' : '';
        aiInstruction.value = aiInstruction.value + sep + input;
      }
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯ä»Šå›ã®å…¥åŠ›ã‚’ä½¿ã†ï¼ˆç©ºãªã‚‰è“„ç©å…¨ä½“ã‚’ä½¿ã†ï¼‰
      const baseInst = input || aiInstruction.value || '';
      const fullCode = editor ? editor.getValue() : '';

      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŒ‡ç¤ºã®æ§‹æˆ
      let secNote = "";
      if (securitySettings.noFetch) secNote += "\n- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„] å¤–éƒ¨ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ã®æƒ…å ±å–å¾—ç¦æ­¢: CDNã‚„å¤–éƒ¨APIã‹ã‚‰ã®fetchã¯çµ¶å¯¾ã«è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹(ç”»åƒç­‰)ã¯DataURIã‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ä½¿ç”¨ã—ã€JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ãªå ´åˆã¯ã‚³ãƒ¼ãƒ‰å†…ã«ãƒãƒ³ãƒ‰ãƒ«ã§ãã‚‹å°è¦æ¨¡ãªã‚‚ã®ã®ã¿æ›¸ã„ã¦ãã ã•ã„ã€‚\n";
      if (securitySettings.noTransmit) secNote += "\n- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„] å¤–éƒ¨ã¸ã®æƒ…å ±ä¼é€ç¦æ­¢: å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡(POST/GETç­‰)ã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ã¯çµ¶å¯¾ã«ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚localStorageã‚„IndexedDBãªã©ãƒ–ãƒ©ã‚¦ã‚¶å†…å®Œçµã®ä¿å­˜æ©Ÿèƒ½ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\n";
      
      const inst = baseInst + (secNote ? ("\n\n[é‡è¦:ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š]\n" + secNote) : "");

      const cdnRule = securitySettings.noFetch
         ? "- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(CDN)ã®ä½¿ç”¨ã¯ç¦æ­¢ã—ã¾ã™ã€‚å¿…è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒãƒ‹ãƒ©JSã§æ›¸ãã‹ã€æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã‚’å†…åŒ…ã—ã¦ãã ã•ã„ã€‚"
         : "- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯CDN(Tailwind, Vue, Reactç­‰)ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã„ã€‚";

      // å…±é€šã®å½¹å‰²è¨­å®š
      const roleDescription = "ã‚ãªãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹é–‹ç™ºç’°å¢ƒã€ŒAppStudioã€ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAIã§ã™ã€‚";

            let prompt = "";
                  if(aiTab.value === 'full') {
        const commonInst = `\n[å‡ºåŠ›å½¢å¼]\n1. å†’é ­ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ã€Œâ‘  ã¾ã‚‹ã”ã¨æ›´æ–° (Full)ã€ã‚¿ãƒ–ã‚’ä½¿ã£ã¦é©ç”¨ã—ã¦ãã ã•ã„ã€ã¨æ¡ˆå†…ã—ã€ä¿®æ­£ç®‡æ‰€ãƒ»åˆ¶ç´„æ¡ä»¶ã‚’ç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚\n2. ãã®å¾Œã€ä¿®æ­£æ¸ˆã¿ã®å®Œå…¨ãªHTMLãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

        if (aiIncludeFullCode.value) {
          prompt =
`${roleDescription}
ä»¥ä¸‹ã®ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¨æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’å†æ§‹ç¯‰ï¼ˆã¾ãŸã¯æ–°è¦ä½œæˆï¼‰ã—ã¦ãã ã•ã„ã€‚

[ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰]
\`\`\`html
${fullCode}
\`\`\`

[æŒ‡ç¤º]
${inst}

[åˆ¶ç´„]
- HTML, CSS, JSã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã€‚
${cdnRule}
${commonInst}`; 
        } else {
          prompt =
`${roleDescription}
ä»¥ä¸‹ã®æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

[æŒ‡ç¤º]
${inst}

[åˆ¶ç´„]
- HTML, CSS, JSã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã€‚
${cdnRule}
${commonInst}`; 
        }
                        } else if (aiTab.value !== 'json') {
        const patchInst = `\n[é‡è¦ï¼šå‡ºåŠ›å½¢å¼]\nç§ãŒæ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ä»¥ä¸‹ã®é †åºã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n1. å†’é ­ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ã€Œâ‘¡ æ‰‹å‹•ã§æ›´æ–° (Manual)ã€ã‚¿ãƒ–ã‚’ä½¿ã£ã¦é©ç”¨ã—ã¦ãã ã•ã„ã€ã¨æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚\n\n2. ä¿®æ­£æ–¹é‡ãƒ»åˆ¶ç´„ãƒ»æ”¹å–„æ¡ˆã®ç°¡æ½”ãªè§£èª¬\n\n3. å¤‰æ›´ã‚³ãƒ¼ãƒ‰ï¼ˆä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰\nâ€»ä¿®æ­£ç®‡æ‰€ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã€1-1, 1-2, 2-1, 2-2... ã®ã‚ˆã†ã«é€šã—ç•ªå·ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n\n# 1-1. ä¿®æ­£å‰ (Search)\n\`\`\`\n(ã“ã“ã«ç½®æ›å¯¾è±¡ã¨ãªã‚‹ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ•°è¡Œï½ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãã®ã¾ã¾æ›¸ã)\n\`\`\`\n\n# 1-2. ä¿®æ­£å¾Œ (Replace)\n\`\`\`\n(ã“ã“ã«æ–°ã—ãç½®ãæ›ãˆã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã)\n\`\`\`\n`;
        if (aiIncludeFullCode.value) {
          prompt =
`${roleDescription}
ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

[å¯¾è±¡ã‚³ãƒ¼ãƒ‰(å…¨ä½“)]
\`\`\`html
${fullCode}
\`\`\`

[ä¿®æ­£æŒ‡ç¤º]
${inst}
${patchInst}`; 
        } else {
          prompt =
`${roleDescription}
ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ä¿®æ­£æŒ‡ç¤ºã«å¾“ã£ã¦ã€æ—¢å­˜ã‚¢ãƒ—ãƒªã®ä¸€éƒ¨ä¿®æ­£ãƒ‘ãƒƒãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ï¼ˆâ€»ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã§ã¯æ·»ä»˜ã—ã¾ã›ã‚“ã€‚ï¼‰

[ä¿®æ­£æŒ‡ç¤º]
${inst}
${patchInst}`; 
        }
      } else {
        // JSON Auto Mode
        const codeBlock = aiIncludeFullCode.value ? `[å¯¾è±¡ã‚³ãƒ¼ãƒ‰(å…¨ä½“)]\n\`\`\`html\n${fullCode}\n\`\`\`\n` : '';
        prompt =
`${roleDescription}
ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

${codeBlock}
[ä¿®æ­£æŒ‡ç¤º]
${inst}

[é‡è¦ï¼šå‡ºåŠ›å½¢å¼]
ãƒ„ãƒ¼ãƒ«ã§è‡ªå‹•ç½®æ›ã‚’è¡Œã†ãŸã‚ã€ä»¥ä¸‹ã®æ‰‹é †ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

1. ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€ã€Œã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ã€Œâ‘¢ è‡ªå‹•ã§æ›´æ–° (Auto)ã€ã‚¿ãƒ–ã«ä»¥ä¸‹ã®JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€ã¨æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚
2. æ¬¡ã«ã€ä¿®æ­£æ–¹é‡ãƒ»åˆ¶ç´„ãƒ»æ”¹å–„æ¡ˆã‚’ç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚
3. æœ€å¾Œã«ã€ã‚³ãƒ¼ãƒ‰ç½®æ›ç”¨ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ **Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯(\`\`\`json ... \`\`\`)** ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

\`\`\`json
[
  {
    "search": "(ç½®æ›å¯¾è±¡ã¨ãªã‚‹ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ•°è¡Œï½ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãã®ã¾ã¾æ›¸ãã€‚æ”¹è¡Œã‚³ãƒ¼ãƒ‰å«ã‚€)",
    "replace": "(æ–°ã—ãç½®ãæ›ãˆã‚‹ã‚³ãƒ¼ãƒ‰)"
  },
  {
    "search": "...",
    "replace": "..."
  }
]
\`\`\`
`;
      }

            navigator.clipboard.writeText(prompt).then(() => {
        aiMessage.value = "ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚";
        setTimeout(() => aiMessage.value = '', 3000);
      });
    };

    const openConsultModal = () => {
      modals.consult = true;
      aiMessage.value = '';
      // Reset selection but keep free input maybe? No, reset all for fresh start.
      consultTopics.value.forEach(t => t.checked = false);
      consultFreeInput.value = '';
    };

    const generateConsultPrompt = () => {
      const selected = consultTopics.value.filter(t => t.checked).map(t => 'ãƒ»' + t.label).join('\n');
      const free = consultFreeInput.value.trim();
      const query = [selected, free].filter(Boolean).join('\n\n[å…·ä½“çš„ãªç›¸è«‡]\n');
      
      if(!query) {
        alert("ç›¸è«‡å†…å®¹ã‚’é¸æŠã™ã‚‹ã‹ã€å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const fullCode = editor ? editor.getValue() : '';

            // æŠ€è¡“ä»•æ§˜æ›¸ãƒ¢ãƒ¼ãƒ‰ã‹åˆ¤å®š
      const isTechSpec = consultTopics.value.some(t => t.checked && t.label.includes('æŠ€è¡“ä»•æ§˜æ›¸'));
      
      let roleDesc = "ã‚ãªãŸã¯ãƒ—ãƒ­ã®Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚ã‚Šã€è¦ªåˆ‡ãªç›¸è«‡ç›¸æ‰‹ã§ã™ã€‚";
      let rules = `1. ã‚¢ãƒ—ãƒªã®æ¦‚è¦ã‚’æŠŠæ¡ã—ãŸä¸Šã§ã€è¦ªèº«ã«ãªã£ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚\n2. ã‚‚ã—æ–°ã—ã„æ©Ÿèƒ½è¿½åŠ ã‚„ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚’ææ¡ˆã™ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã™ãã«å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã€ã€ŒAppStudioã®ã€AIæŒ‡ç¤ºã€ç”»é¢ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨ãã®ã¾ã¾ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã€ã‚’å…·ä½“çš„ã«æç¤ºã—ã¦ãã ã•ã„ã€‚\nï¼ˆä¾‹ï¼šã€Œã€‡ã€‡æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚ãã®å ´åˆã¯AIã«ã€ï½ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€ã¨æŒ‡ç¤ºã™ã‚‹ã¨è‰¯ã„ã§ã™ã‚ˆã€ï¼‰`;

      if (isTechSpec) {
        roleDesc = "ã‚ãªãŸã¯ç†Ÿç·´ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã§ã™ã€‚";
        rules = `1. å¯¾è±¡èª­è€…ã¯ä¸­ç´šä»¥ä¸Šã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚å°‚é–€ç”¨èªã‚’ç”¨ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã€ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’æ­£ç¢ºã‹ã¤è©³ç´°ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚\n2. HTMLæ§‹é€ ã€CSSè¨­è¨ˆã€JavaScriptã®ä¸»è¦é–¢æ•°ãƒ»å¤‰æ•°ã«ã¤ã„ã¦ç¶²ç¾…çš„ãªã€ŒæŠ€è¡“ä»•æ§˜æ›¸ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n3. åˆå¿ƒè€…ã¸ã®é…æ…®ã¯ä¸è¦ã§ã™ã€‚æŠ€è¡“çš„ãªæ­£ç¢ºæ€§ã¨æ·±ã•ã‚’æœ€å„ªå…ˆã—ã¦ãã ã•ã„ã€‚`;
      }

      const prompt = 
`${roleDesc}
ç¾åœ¨ã€ç§ã¯ã€ŒAppStudioã€ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ãå˜ä¸€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®Webã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

[ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰]
\`\`\`html
${fullCode}
\`\`\`

[ã‚ãªãŸã¸ã®ç›¸è«‡]
${query}

[å›ç­”ã®ãƒ«ãƒ¼ãƒ«]
${rules}
`;

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ï¼ˆéã‚»ã‚­ãƒ¥ã‚¢ç’°å¢ƒå¯¾å¿œã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
      const doCopy = (txt) => {
        if (navigator.clipboard && window.isSecureContext) {
          return navigator.clipboard.writeText(txt);
        }
        return new Promise((resolve, reject) => {
          try {
            const ta = document.createElement('textarea');
            ta.value = txt;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            resolve();
          } catch(e) { reject(e); }
        });
      };

      doCopy(prompt).then(() => {
        aiMessage.value = "ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIã®ãƒãƒ£ãƒƒãƒˆæ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚";
        setTimeout(() => aiMessage.value = '', 5000);
      }).catch(e => {
        console.error(e);
        alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãŠæ‰‹æ•°ã§ã™ãŒæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
      });
    };

            // --- PATCH ---
        const openPatchModal = () => {
      if (aiTab.value === 'json') {
        patchMode.value = 'json';
      } else if (aiTab.value === 'full') {
        patchMode.value = 'full';
      } else {
        patchMode.value = 'manual';
      }

      patchFullInput.value = '';
      patchFindInput.value = '';
      patchReplaceInput.value = '';
      patchJsonInput.value = '';
      patchIgnoreWhitespace.value = true;
      patchMatchCount.value = 0;
      patchMatchMessage.value = '';
      modals.patch = true;
    };

    // é¡ä¼¼ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã‚’æ¨å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const findPossibleRange = (rawSearch) => {
      if (!editor || !rawSearch) return '';
      try {
        const model = editor.getModel();
        // ç©ºè¡Œã‚’é™¤ã„ãŸæœ‰åŠ¹ãªè¡Œã‚’æŠ½å‡º
        const lines = rawSearch.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 2);
        if (lines.length < 2) return '';

        const head = lines[0].replace(/\s/g, '');
        const tail = lines[lines.length - 1].replace(/\s/g, '');
        const maxLines = model.getLineCount();

        // å…¨è¡Œèµ°æŸ»ã—ã¦ã€Œå…ˆé ­è¡Œã€ã¨ã€Œæœ«å°¾è¡Œã€ãŒè¿‘ãã«ã‚ã‚‹å ´æ‰€ã‚’æ¢ã™
        for (let i = 1; i <= maxLines; i++) {
          const lineContent = model.getLineContent(i).replace(/\s/g, '');
          if (lineContent.includes(head)) {
             const estLines = rawSearch.split(/\r?\n/).length;
             // äºˆæƒ³ã•ã‚Œã‚‹çµ‚äº†ä½ç½®å‘¨è¾º (Â±20è¡Œ) ã‚’æ¢ã™
             const searchLimit = Math.min(maxLines, i + estLines + 20);
             const searchStart = Math.max(i, i + estLines - 20);
             for (let j = searchStart; j <= searchLimit; j++) {
               const endContent = model.getLineContent(j).replace(/\s/g, '');
               if (endContent.includes(tail)) {
                 return `\n\nğŸ” ã‚‚ã—ã‹ã—ã¦: ${i}è¡Œç›® ï½ ${j}è¡Œç›® ä»˜è¿‘ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã‹ï¼Ÿ`;
               }
             }
          }
        }
      } catch(e) { console.error(e); }
      return '';
    };

        const suggestRecovery = (errorMsg, jsonContext = null) => {
      let msg = `âŒ ãƒ‘ãƒƒãƒé©ç”¨å¤±æ•—: ${errorMsg}\n\nã€ãƒªã‚«ãƒãƒªãƒ¼ç­–ã‚’é¸ã‚“ã§ãã ã•ã„ã€‘\n`;
      if (jsonContext) {
        msg += `\n1ï¸âƒ£ æ‰‹å‹•ä¿®æ­£ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ (æ¨å¥¨)\n   â†’ AIã«ä¿®æ­£ç®‡æ‰€ã‚’æ•´ç†ã•ã›ã€æ‰‹å‹•ã§åæ˜ ã—ã¾ã™ã€‚\n`;
      }
      msg += `\n2ï¸âƒ£ å…¨ã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚Šç›´ã™\n   â†’ AIã«ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’å†ç”Ÿæˆã•ã›ã¾ã™ã€‚\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`;

      const def = jsonContext ? "1" : "2";
      const choice = prompt(msg, def);

      if (choice === '1' && jsonContext) {
        patchMode.value = 'manual';
        const p = `å…ˆã»ã©ã®ä¿®æ­£æŒ‡ç¤ºã§ã™ãŒã€ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã“ã®JSONã‚³ãƒ¼ãƒ‰ã‹ã‚‰ä¿®æ­£å‰ã€ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸è¶³ãªãã™ã¹ã¦æŠœãå‡ºã—ã€æ‰‹å‹•ã§ç½®æ›ã§ãã‚‹ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æç¤ºã—ã¦ãã ã•ã„ã€‚\n\n[JSON Code]\n${jsonContext}`;
        navigator.clipboard.writeText(p).then(() => alert("ğŸ“‹ ãƒªã‚«ãƒãƒªãƒ¼ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\nAIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"));
      } else if (choice === '2') {
        modals.patch = false;
        modals.ai = true;
        aiTab.value = 'full';
        const full = editor.getValue();
        const p = `å…ˆã»ã©ã®ä¿®æ­£æŒ‡ç¤ºã§ã™ãŒã€ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\néƒ¨åˆ†ä¿®æ­£ã§ã¯ãªãã€ä¿®æ­£ã‚’é©ç”¨ã—ãŸã‚ã¨ã®ã€HTMLãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã€ã‚’ã™ã¹ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n[ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰]\n\`\`\`html\n${full}\n\`\`\``;
        navigator.clipboard.writeText(p).then(() => alert("ğŸ“‹ ãƒªã‚«ãƒãƒªãƒ¼ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\nAIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"));
      }
    };

        const applyPatch = () => {
      saveHistory();
      try {
        const findTextRaw = patchFindInput.value;
        const replaceText = patchReplaceInput.value;

        if (!findTextRaw || !replaceText) {
          alert("æ¤œç´¢ã‚³ãƒ¼ãƒ‰ã¨ç½®æ›ã‚³ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const model = editor.getModel();
        const full = model.getValue();

        if (!patchIgnoreWhitespace.value) {
          const idx = full.indexOf(findTextRaw);
          if (idx === -1) {
            suggestRecovery("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚" + findPossibleRange(findTextRaw));
            return;
          }
          const idx2 = full.indexOf(findTextRaw, idx + 1);
          if (idx2 !== -1) {
            alert("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¤‡æ•°ã‚ã‚Šã¾ã™ã€‚æ„å›³ã—ãªã„å¤‰æ›´ã‚’é˜²ããŸã‚ã€ã‚ˆã‚Šé•·ã„ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦ä¸€æ„ã«å®šã‚ã¦ãã ã•ã„ã€‚");
            return;
          }

          const startPos = model.getPositionAt(idx);
          const endPos = model.getPositionAt(idx + findTextRaw.length);
          const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

          editor.executeEdits("manual-patch", [{ range, text: replaceText }]);
          modals.patch = false;
          runEmulator();
          alert("ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã¾ã—ãŸï¼ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰");
          return;
        }

        const { compact: compactFull, mapNormToOrig } = buildCompacted(full);
        const compactFind = normalizeFind(findTextRaw);
        if (!compactFind) { alert("æ¤œç´¢ã‚³ãƒ¼ãƒ‰ãŒç©ºç™½ã®ã¿ã§ã™ã€‚"); return; }

        const normIdx = compactFull.indexOf(compactFind);
        if (normIdx === -1) {
          suggestRecovery("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç©ºç™½ç„¡è¦–ï¼‰ã€‚" + findPossibleRange(findTextRaw));
          return;
        }
        const normIdx2 = compactFull.indexOf(compactFind, normIdx + 1);
        if (normIdx2 !== -1) {
          alert("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¤‡æ•°ã‚ã‚Šã¾ã™ï¼ˆç©ºç™½ç„¡è¦–ï¼‰ã€‚æ„å›³ã—ãªã„å¤‰æ›´ã‚’é˜²ããŸã‚ã€ã‚ˆã‚Šé•·ã„ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦ä¸€æ„ã«å®šã‚ã¦ãã ã•ã„ã€‚");
          return;
        }

        const startOrig = mapNormToOrig[normIdx];
        const endOrig = mapNormToOrig[normIdx + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

        editor.executeEdits("manual-patch", [{ range, text: replaceText }]);
        modals.patch = false;
        runEmulator();
        alert("ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã¾ã—ãŸï¼ï¼ˆç©ºç™½ãƒ»æ”¹è¡Œã¯ç„¡è¦–ï¼‰");
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + (e.message || String(e)));
      }
    };

        const applyAutoJsonPatch = () => {
      saveHistory();
      let items = [];
      try {
        let jsonStr = patchJsonInput.value.trim();
        const start = jsonStr.indexOf('[');
        const end = jsonStr.lastIndexOf(']');
        if (start !== -1 && end !== -1 && end > start) {
          jsonStr = jsonStr.substring(start, end + 1);
        } else {
          jsonStr = jsonStr.replace(/^```json/, '').replace(/^```/, '').replace(/```$/, '');
        }
        items = JSON.parse(jsonStr);
        if (!Array.isArray(items)) throw new Error("JSON is not an array");
      } catch(e) {
        suggestRecovery("JSONè§£æã‚¨ãƒ©ãƒ¼: " + e.message, patchJsonInput.value);
        return;
      }

      const model = editor.getModel();
      const full = model.getValue();
      const edits = [];
      let entityAdjusted = false;
      
      let compactData = null;
      if (patchIgnoreWhitespace.value) {
        compactData = buildCompacted(full);
      }

      const decodeEnt = (s) => s.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&#039;/g, "'");
      const encodeEnt = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

      for (const item of items) {
        if (!item.search || typeof item.replace !== 'string') continue;

        const raw = item.search;
        const cands = new Set([raw, decodeEnt(raw), decodeEnt(decodeEnt(raw)), encodeEnt(raw)]);
        
        let bestCand = null;
        let bestRange = null;
        let totalMatches = 0;

        for (const cand of cands) {
            let ranges = [];
            if (!patchIgnoreWhitespace.value) {
                let pos = 0;
                while(true) {
                    const idx = full.indexOf(cand, pos);
                    if (idx === -1) break;
                    ranges.push({ s: idx, e: idx + cand.length });
                    pos = idx + 1;
                }
            } else {
                const { compact: compactFull, mapNormToOrig } = compactData;
                const compactFind = normalizeFind(cand);
                if (!compactFind) continue;

                let idx = 0;
                while(true) {
                    const p = compactFull.indexOf(compactFind, idx);
                    if (p === -1) break;
                    const s = mapNormToOrig[p];
                    const e = mapNormToOrig[p + compactFind.length - 1] + 1;
                    ranges.push({ s, e });
                    idx = p + 1;
                }
            }

            if (ranges.length > 0) {
                totalMatches += ranges.length;
                if (ranges.length === 1) {
                    bestCand = cand;
                    const startPos = model.getPositionAt(ranges[0].s);
                    const endPos = model.getPositionAt(ranges[0].e);
                    bestRange = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);
                }
            }
        }

        if (totalMatches === 0) {
            suggestRecovery("è©²å½“ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + raw.slice(0,30) + "...", patchJsonInput.value);
            return;
        }
        if (totalMatches > 1) {
             suggestRecovery("è¤‡æ•°ç®‡æ‰€ä¸€è‡´ã—ã¦ã—ã¾ã„ç‰¹å®šã§ãã¾ã›ã‚“: " + raw.slice(0,30) + "...", patchJsonInput.value);
             return;
        }

        let finalReplace = item.replace;
        if (bestCand !== raw) {
            entityAdjusted = true;
            if (bestCand === decodeEnt(raw)) finalReplace = decodeEnt(finalReplace);
            else if (bestCand === encodeEnt(raw)) finalReplace = encodeEnt(finalReplace);
            else if (bestCand === decodeEnt(decodeEnt(raw))) finalReplace = decodeEnt(decodeEnt(finalReplace));
        }

        edits.push({ range: bestRange, text: finalReplace });
      }
      
      if (edits.length === 0) {
        alert("é©ç”¨å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        return;
      }
      
      editor.executeEdits("auto-json-patch", edits);
      modals.patch = false;
      runEmulator();
            const msg = `${edits.length}ç®‡æ‰€ã®ä¿®æ­£ã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸï¼` + (entityAdjusted ? "\n(ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æºã‚‰ãã‚’è‡ªå‹•è£œæ­£)" : "");
      alert(msg);
    };

        const applyFullCode = () => {
      const code = patchFullInput.value;
      if (!code) {
        alert("ã‚³ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ç¢ºèª
      if (editor && editor.getValue().trim()) {
        if (!confirm("ã‚¨ãƒ‡ã‚£ã‚¿ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦ä¸Šæ›¸ãã—ã¦ã€å…¥ã‚Œæ›¿ãˆã¾ã™ã‹ï¼Ÿ\n(ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã¯å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã™)")) return;
      }
      
      saveHistory();
      editor.setValue(code);
      syncIdentityFromCode(code);
      
      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰AIæŒ‡ç¤ºãªã©ã‚’å¾©å…ƒ
      const meta = extractMeta(code);
      if (meta.aiInstruction) aiInstruction.value = meta.aiInstruction;
      
      modals.patch = false;
      runEmulator();
      pushToast('åæ˜ å®Œäº†', 'å…¨ã‚³ãƒ¼ãƒ‰ã‚’åæ˜ ã—ã¾ã—ãŸã€‚', 'fa-check text-green-300', 2000);
    };

        const copyRecoveryPrompt = (mode = 'manual') => {
      if (!patchJsonStatus.value || patchJsonStatus.value.type !== 'error') return;
      
      const jsonContent = patchJsonInput.value || '';
      let prompt = '';
      let nextMode = '';
      let nextModeName = '';
      
            if (mode === 'full') {
        const full = editor.getValue();
        prompt = `å…ˆã»ã©ã®ä¿®æ­£æŒ‡ç¤ºã§ã™ãŒã€ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\néƒ¨åˆ†ä¿®æ­£ã§ã¯ãªãã€ä¿®æ­£ã‚’é©ç”¨ã—ãŸã‚ã¨ã®ã€HTMLãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã€ã‚’ã™ã¹ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n[ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰]\n\`\`\`html\n${full}\n\`\`\``;
        nextMode = 'full';
        nextModeName = 'â‘  ã¾ã‚‹ã”ã¨æ›´æ–°';
      } else {
                prompt = `å…ˆã»ã©ã®ä¿®æ­£æŒ‡ç¤ºã§ã™ãŒã€ãƒ‘ãƒƒãƒé©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONä¸æ­£ã¾ãŸã¯è©²å½“ç®‡æ‰€ãªã—ï¼‰ã€‚\nä»¥ä¸‹ã®JSONã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã‚‹å†…å®¹ã‹ã‚‰ã€ã€Œä¿®æ­£å‰(search)ã€ã¨ã€Œä¿®æ­£å¾Œ(replace)ã€ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºã—ã¦ã€ç§ãŒæ‰‹å‹•ã§é©ç”¨ã§ãã‚‹ã‚ˆã†ã«å†æç¤ºã—ã¦ãã ã•ã„ã€‚\n\n[å…ƒã®JSON]\n${jsonContent}`;
        nextMode = 'manual';
        nextModeName = 'â‘¡ æ‰‹å‹•ã§æ›´æ–°';
      }

      navigator.clipboard.writeText(prompt).then(() => {
        patchMode.value = nextMode;
        pushToast('ãƒªã‚«ãƒãƒªãƒ¼æŒ‡ç¤ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', `AIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚\nå›ç­”ãŒæ¥ãŸã‚‰ã€Œ${nextModeName}ã€ã‚¿ãƒ–ã‚’ä½¿ã„ã¾ã™ã€‚`, 'fas fa-clipboard-check text-green-300', 6000);
      });
    };

    // --- PREVIEW SHIM (console + idb dump) ---
      const buildPreviewShim = (runId) => {
      return `
<script>
(() => {
  const RUN_ID = ${JSON.stringify(runId)};
  const send = (obj) => { try { window.parent?.postMessage(obj, "*"); } catch(e){} };

    const showErrorOverlay = (msg) => {
    const div = document.createElement('div');
    div.id = 'app-error-overlay';
    div.style = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#fee2e2;color:#b91c1c;padding:12px;font-family:sans-serif;font-size:12px;border-bottom:2px solid #ef4444;box-shadow:0 4px 12px rgba(0,0,0,0.1)';
    const safeMsg = String(msg).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px"><div><strong style="display:block;margin-bottom:4px;font-size:13px">âš ï¸ Runtime Error</strong><div style="white-space:pre-wrap;word-break:break-all">'+safeMsg+'</div></div><button onclick="document.getElementById(\'app-error-overlay\').remove()" style="background:none;border:none;color:#b91c1c;cursor:pointer;font-size:20px;font-weight:bold;padding:0 4px;line-height:1">Ã—</button></div><button id="ai-fix-btn" style="background:#fff;border:1px solid #b91c1c;color:#b91c1c;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;display:inline-flex;align-items:center;gap:4px;transition:all 0.2s">ğŸš‘ AIã«ä¿®æ­£ã‚’ä¾é ¼ã™ã‚‹</button>';
    document.body?.appendChild(div) || document.documentElement.appendChild(div);
    const btn = div.querySelector('#ai-fix-btn');
    if(btn) btn.onclick = () => {
      send({ type: "request_ai_fix", error: msg });
      btn.style.background = '#b91c1c'; btn.style.color = '#fff'; btn.innerText = 'æŒ‡ç¤ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    };
  };

  window.onerror = (msg, url, line, col, error) => {
    const cleanMsg = msg + " (line:" + line + ")";
    showErrorOverlay(cleanMsg);
    send({ type: "console", l: "error", m: cleanMsg });
    return false;
  };

  window.onunhandledrejection = (event) => {
    const msg = "Unhandled Promise Rejection: " + event.reason;
    showErrorOverlay(msg);
    send({ type: "console", l: "error", m: msg });
  };

  const _log = console.log.bind(console);
  const _err = console.error.bind(console);
  const _warn = console.warn.bind(console);
  console.log = (...a)=>{ _log(...a); send({ type: "console", l: "info", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };
  console.error = (...a)=>{ _err(...a); showErrorOverlay(a.join(" ")); send({ type: "console", l: "error", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };
  console.warn = (...a)=>{ _warn(...a); send({ type: "console", l: "warn", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };

  async function dumpIdb() {
    const items = [];
    const databasesFn = indexedDB.databases ? indexedDB.databases.bind(indexedDB) : null;
    if (!databasesFn) {
      return { items: [], warning: "indexedDB.databases() ãŒæœªå¯¾å¿œã®ãŸã‚ã€DBä¸€è¦§ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚" };
    }
    const dbs = await databasesFn();
    for (const d of (dbs||[])) {
      const name = d.name;
      const version = d.version || 0;
      if (!name) continue;

      const info = { name, version, stores: [], open: true };

      await new Promise((resolve) => {
        const req = indexedDB.open(name);
        req.onerror = () => resolve();
        req.onsuccess = () => {
          const db = req.result;
          try {
            info.version = db.version || info.version;
            const storeNames = Array.from(db.objectStoreNames || []);
            const tx = db.transaction(storeNames, "readonly");
            const storeInfos = [];

            let pending = storeNames.length;
            if (pending === 0) { try{db.close()}catch(e){}; info.stores = []; resolve(); return; }

            storeNames.forEach(sn => {
              try {
                const st = tx.objectStore(sn);
                const stInfo = {
                  name: sn,
                  keyPath: st.keyPath ?? null,
                  autoIncrement: !!st.autoIncrement,
                  count: 0,
                  sampleKeys: []
                };

                const cReq = st.count();
                cReq.onsuccess = () => { stInfo.count = cReq.result || 0; maybeDone(); };
                cReq.onerror = () => { maybeDone(); };

                const keys = [];
                const kReq = st.openKeyCursor();
                kReq.onsuccess = (ev) => {
                  const cur = ev.target.result;
                  if (cur && keys.length < 20) { keys.push(cur.key); cur.continue(); }
                  else { stInfo.sampleKeys = keys; }
                };
                kReq.onerror = () => {};

                storeInfos.push(stInfo);
              } catch(e) {
                pending = Math.max(0, pending - 1);
              }
            });

            function maybeDone(){
              pending = Math.max(0, pending - 1);
              if (pending === 0) {
                info.stores = storeInfos.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
                try { db.close(); } catch(e){}
                resolve();
              }
            }
          } catch(e) {
            try { db.close(); } catch(_){}
            resolve();
          }
        };
      });

      items.push(info);
    }

    items.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
    return { items };
  }

  window.addEventListener("message", async (ev) => {
    const data = ev.data || {};
    if (data.type === "idb_dump_request" && data.runId === RUN_ID) {
      try {
        const res = await dumpIdb();
        send({ type: "idb_dump_result", runId: RUN_ID, items: res.items || [], error: res.warning || "" });
      } catch(e) {
        send({ type: "idb_dump_result", runId: RUN_ID, items: [], error: String(e && e.message ? e.message : e) });
      }
    }
  });
})();
<\/script>`;
    };

    const injectShimIntoHtml = (code, shim) => {
      if (code.match(/<head[^>]*>/i)) return code.replace(/<head[^>]*>/i, (m)=> m + shim);
      return shim + code;
    };

        // --- PREVIEW (iframe) ---
const runEmulator = (skipSave = false) => {
  if(!editor) return;
  if(!skipSave) saveHistory();

  const frame = document.getElementById('emulator-frame');
  isRunLoading.value = true;
  frame.onload = () => {
    setTimeout(() => { isRunLoading.value = false; }, 300);
  };

  const code = editor.getValue() || '';
  syncIdentityFromCode(code);

  lastRunId = genId();
  const shim = buildPreviewShim(lastRunId);

    // â˜…ç©ºã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼šã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’è¡¨ç¤º
  if (code.trim() === '') {
    const emptyHtml =
`<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Welcome to AppStudio</title>
<style>
  body{font-family:'Helvetica Neue',Arial,sans-serif; margin:0; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#f8fafc; color:#334155; text-align:center;}
  .icon{font-size:48px; margin-bottom:16px; animation:bounce 2s infinite;}
  h1{font-size:24px; margin:0 0 12px; color:#1e293b;}
  p{font-size:14px; margin:0 0 24px; line-height:1.6; max-width:400px;}
  .arrow{font-size:32px; color:#8b5cf6; font-weight:bold; margin-bottom:8px; display:inline-block; transform:rotate(-45deg);}
  @keyframes bounce { 0%, 100% { transform:translateY(0); } 50% { transform:translateY(-10px); } }
</style>
</head>
<body>
  <div class="icon">ğŸš€</div>
  <h1>ã•ã‚ã€ã‚¢ãƒ—ãƒªã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</h1>
  <p>ã¾ã ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚ã‚‹ <b style="color:#6b21a8">ã€ŒAIæŒ‡ç¤ºã€</b> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€<br>ä½œã‚ŠãŸã„ã‚¢ãƒ—ãƒªã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚</p>
  <div class="arrow">â†–</div>
</body>
</html>`;
    const safe = injectShimIntoHtml(emptyHtml, shim);
    frame.srcdoc = safe;
    return;
  }

  const safeCode = injectShimIntoHtml(code, shim);
  frame.srcdoc = safeCode;
};


    const stopEmulator = () => {
      const frame = document.getElementById('emulator-frame');
      frame.src = 'about:blank';
      consoleLogs.value.push({type:'info', message:'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚'});

      if (fullWin && !fullWin.closed) {
        try { fullWin.close(); } catch {}
      }
      fullWin = null;
    };

    // --- FULLSCREEN (separate window) ---
    const openFullWindow = () => {
      if(!editor) return;

      const code = editor.getValue();
      syncIdentityFromCode(code);

      const runId = genId();
      const shim = buildPreviewShim(runId);
      const safeCode = injectShimIntoHtml(code, shim);

      const blob = new Blob([safeCode], { type: 'text/html' });
      const url = URL.createObjectURL(blob);

      // å¸¸ã«æ–°è¦ã‚¿ãƒ–ã§é–‹ã (_blank)
      // â€»ä¸€éƒ¨ç’°å¢ƒã§é–‹ã„ã¦ã„ã‚‹ã®ã«winãŒnullåˆ¤å®šã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®šã¯å‰Šé™¤
      window.open(url, '_blank', 'noopener,noreferrer');
    };

    Â  Â  // --- DB MODAL ---
Â  Â  const openDbModal = async () => {
Â  Â  Â  if (!confirm("ã€æ³¨æ„ã€‘\nIndexedDBç°¡æ˜“è¡¨ç¤ºã¯ç¾åœ¨ã€æ©Ÿèƒ½ãŒä¸å®Œå…¨ãªãŸã‚åœæ­¢æ¨å¥¨ã¨ãªã£ã¦ã„ã¾ã™ã€‚\n\nç„¡ç†ã«å®Ÿè¡Œã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ•ãƒªãƒ¼ã‚ºã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã§ã‚‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;

Â  Â  Â  modals.db = true;
Â  Â  Â  await refreshDbDump();
Â  Â  };

    const refreshDbDump = async () => {
      dbDump.loading = true;
      dbDump.error = '';
      dbDump.items = [];

      const frame = document.getElementById('emulator-frame');
      if (!frame || !frame.contentWindow) {
        dbDump.loading = false;
        dbDump.error = "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œå®Ÿè¡Œã€ã—ã¦ãã ã•ã„ã€‚";
        return;
      }
      if (!lastRunId) {
        dbDump.loading = false;
        dbDump.error = "runId ãŒæœªè¨­å®šã§ã™ã€‚ã„ã£ãŸã‚“ã€Œå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      try {
        frame.contentWindow.postMessage({ type: 'idb_dump_request', runId: lastRunId }, '*');
        setTimeout(() => {
          if (dbDump.loading) {
            dbDump.loading = false;
            dbDump.error = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ãŒå¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚";
          }
        }, 4000);
      } catch(e) {
        dbDump.loading = false;
        dbDump.error = "DBå–å¾—ã«å¤±æ•—: " + (e.message || String(e));
      }
    };

    // --- OTHER HELPERS ---
const clearCode = () => {
      if(!confirm("æœ¬å½“ã«ã‚³ãƒ¼ãƒ‰ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      // ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Œå…¨ã«ç©ºã«ã™ã‚‹
      editor.setValue('');

      // å†…éƒ¨çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ã‚¿æƒ…å ±ã‚„AIæŒ‡ç¤ºã‚‚ã‚¯ãƒªã‚¢ï¼‰
      syncIdentityFromCode('');
      aiInstruction.value = '';
      saveComment.value = '';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
      runEmulator();
      pushToast('å…¨ã‚¯ãƒªã‚¢', 'ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã—ã¾ã—ãŸã€‚', 'fa-trash-alt text-red-300', 1500);
    };
    const copyFullCode = async () => {
      try{
        await navigator.clipboard.writeText(editor.getValue());
        pushToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚', 'fa-circle-check text-emerald-300', 1600);
      }catch(e){
        alert("ã‚³ãƒ”ãƒ¼å¤±æ•—: " + (e.message || String(e)));
      }
    };

        const toggleSidebar = () => { isSidebarOpen.value = !isSidebarOpen.value; };

        const toggleEditor = () => {
      isEditorOpen.value = !isEditorOpen.value;
      saveEditorState();
      // Reset layout styles to flex default
      const ep = document.getElementById('editor-pane');
      const em = document.getElementById('emulator-pane');
      if(ep) { ep.style.width = ''; ep.style.flex = ''; }
      if(em) { em.style.width = ''; em.style.flex = ''; }
      if(isEditorOpen.value && editor) setTimeout(() => editor.layout(), 100);
    };

    // --- RESIZE ---
    let resizing = false;
    const startResize = (e) => {
      resizing = true;
      const editorPane = document.getElementById('editor-pane');
      const emulatorPane = document.getElementById('emulator-pane');
      const root = editorPane.parentElement;

      const onMove = (ev) => {
        if(!resizing) return;
        const rect = root.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const w = rect.width;
        const left = Math.max(260, Math.min(w - 260, x));
        editorPane.style.flex = 'none';
        emulatorPane.style.flex = 'none';
        editorPane.style.width = left + 'px';
        emulatorPane.style.width = (w - left - 6) + 'px';
      };
      const onUp = () => {
        resizing = false;
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      };

      window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onUp);
    };

    // --- DIFF VIEWER ---
    let diffEditor = null;
    const diffTargetDate = ref('');

    const openDiffModal = async (fileItem) => {
      let originalCode = fileItem.content || '';
      if (!originalCode && fileItem.handle) {
         try {
           const f = await fileItem.handle.getFile();
           originalCode = await f.text();
         } catch(e) { console.error(e); }
      }
      const modifiedCode = editor ? editor.getValue() : '';
      diffTargetDate.value = fileItem.savedAtStr || 'Unknown Date';
      modals.diff = true;

      await nextTick();
      const container = document.getElementById('diff-editor-container');
      if (!container) return;
      if (diffEditor) diffEditor.dispose();

      diffEditor = monaco.editor.createDiffEditor(container, {
        originalEditable: false,
        readOnly: true,
        theme: 'vs-dark',
        automaticLayout: true,
        renderSideBySide: true,
        diffWordWrap: 'off'
      });
      diffEditor.setModel({
        original: monaco.editor.createModel(originalCode, 'html'),
        modified: monaco.editor.createModel(modifiedCode, 'html')
      });
    };

        const closeDiffModal = () => {
      modals.diff = false;
      if (diffEditor) {
        diffEditor.dispose();
        diffEditor = null;
      }
    };

    // --- HISTORY EDIT ---
    const openHistoryEditModal = (fileItem) => {
      if (!fileItem || !fileItem.handle) return;
      editingHistoryItem.value = fileItem;
      const meta = fileItem.meta || {};
      editingHistoryText.value = meta.aiInstruction || meta.comment || '';
      modals.historyEdit = true;
    };

    const saveHistoryMemo = async () => {
      if (!editingHistoryItem.value) return;
      try {
        const fileItem = editingHistoryItem.value;
        const handle = fileItem.handle;
        const file = await handle.getFile();
        const text = await file.text();
        
        const meta = extractMeta(text);
        const newMemo = editingHistoryText.value;
        meta.aiInstruction = newMemo;
        meta.comment = newMemo;
        
        const newCode = injectMeta(text, meta);
        const writable = await handle.createWritable();
        await writable.write(newCode);
        await writable.close();
        
        modals.historyEdit = false;
        pushToast('æ›´æ–°å®Œäº†', 'å±¥æ­´ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'fa-check text-green-300');
        await refreshLibrary();
        
        if (currentFileName.value === handle.name) {
           Object.assign(currentMeta, meta);
        }
      } catch(e) {
        console.error(e);
        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };

    // --- WIZARD LOGIC ---
    const wizardOpen = ref(false);
    const wizardStep = ref(1);
    const wizardData = reactive({ type: '', design: '', features: [] });
    const wizardOptions = {
      types: ['ã‚¿ã‚¹ã‚¯ç®¡ç†(ToDo)', 'å­¦ç¿’ãƒ»ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª', 'æ¥­å‹™åŠ¹ç‡åŒ–ãƒ„ãƒ¼ãƒ«', 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', 'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ', 'ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ', 'æ–‡å­—èµ·ã“ã—ãƒ»éŒ²éŸ³'],
      designs: ['ãƒ¢ãƒ€ãƒ³ãƒ»ãƒ€ãƒ¼ã‚¯', 'ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ãƒŸãƒ‹ãƒãƒ«', 'ãƒãƒƒãƒ—ãƒ»ã‚«ãƒ©ãƒ•ãƒ«', 'ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«(ä¿¡é ¼æ„Ÿ)', 'ãƒ¬ãƒˆãƒ­ãƒ»ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼'],
      features: ['ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜(LocalStorage)', 'ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ(ã‚¹ãƒãƒ›OK)', 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡º', 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ©Ÿèƒ½', 'CSV/PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ']
    };
    const wizardTitle = computed(() => {
       if(wizardStep.value===1) return 'ä½•ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ';
       if(wizardStep.value===2) return 'ãƒ‡ã‚¶ã‚¤ãƒ³ã®é›°å›²æ°—ã¯ï¼Ÿ';
       return 'ã“ã ã‚ã‚Šæ©Ÿèƒ½ã¯ï¼Ÿ';
    });

    const toggleWizard = () => {
      wizardOpen.value = !wizardOpen.value;
      if(wizardOpen.value) {
        wizardStep.value = 1;
        wizardData.type = ''; wizardData.design = ''; wizardData.features = [];
      }
    };
    const setWizardType = (t) => { wizardData.type = t; wizardStep.value = 2; };
    const setWizardDesign = (d) => { wizardData.design = d; wizardStep.value = 3; };
    const completeWizard = () => {
      const parts = [];
      if(wizardData.type) parts.push(`ã€ã‚¢ãƒ—ãƒªæ¦‚è¦ã€‘\n${wizardData.type}ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`);
      if(wizardData.design) parts.push(`ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€‘\n${wizardData.design}ãªé›°å›²æ°—ã§ã€è¦‹ã‚„ã™ãä½¿ã„ã‚„ã™ã„UIã«ã—ã¦ãã ã•ã„ã€‚`);
      if(wizardData.features.length > 0) parts.push(`ã€æ©Ÿèƒ½è¦ä»¶ã€‘\nä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š\n` + wizardData.features.map(f=>`ãƒ»${f}`).join('\n'));
      
      aiPromptInput.value = (aiPromptInput.value ? aiPromptInput.value + '\n\n' : '') + parts.join('\n\n');
      wizardOpen.value = false;
    };

        return {
      wizardOpen, wizardStep, wizardData, wizardOptions, wizardTitle, toggleWizard, setWizardType, setWizardDesign, completeWizard,
            openDiffModal, closeDiffModal, diffTargetDate,
      openHistoryEditModal, saveHistoryMemo, editingHistoryText,
            // state
appMode, projectDisplayName, menus, modals, isSidebarOpen, isRunLoading,
                  aiTab, aiInstruction, aiPromptInput, aiMessage, aiIncludeFullCode, aiHelp, patchHelp, showRecipes, helpTab,
      consultTopics, consultFreeInput,
          saveComment, saveFilename,
      patchMode, patchFindInput, patchReplaceInput, patchJsonInput, patchIgnoreWhitespace,
                  patchMatchCount, patchMatchMessage, patchJsonStatus,
            applyAutoJsonPatch, copyRecoveryPrompt, applyFullCode,
      patchFullInput,
      deviceModes, currentDevice,
      findUI, findInputEl, replaceInputEl,
            editorStats, consoleLogs,
      libraryFiles, libraryFilesFlat, groupedApps, historyMode,
      currentAppTitle, currentGroupKey, libraryScanStatus,
      hoveredHistory, showHistoryDetail, hideHistoryDetail,

                  // actions
      toggleSidebar, toggleEditor, isEditorOpen,
      createNewProject, openProjectFolder, openSingleFile, createNewSingleApp,
      refreshLibrary, revealCurrentFolder,
      loadFile, runExternal,
      runEmulator, stopEmulator, openFullWindow,
      openAiModal, generateAndCopyPrompt,
      openConsultModal, generateConsultPrompt,
            openSaveModal, performSave,
            githubSettings, githubStatus, githubUrl, publishToGithub, openGithubModal,
      openPatchModal, applyPatch,
      openDbModal, refreshDbDump,
      openFindReplace, closeFindReplace,
      startDragFindUI,
      findNext, findPrev, replaceOne, replaceAll, recomputeMatchCount,
      clearCode, copyFullCode,
      startResize,
      Â  Â  Â  toasts,
Â  Â  Â  projectRootHandle, setProjectRoot,
Â  Â  Â        securitySettings, saveSecuritySettings,
                        markHelpSeen, codeHistory, undoCode,
      patchRecipes: [
        {
          label: 'ğŸ ãƒã‚°ä¿®æ­£ãƒ»ãƒ•ãƒªãƒ¼ã‚º',
          desc: 'å‹•ã‹ãªã„ãƒ»ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹æ™‚',
          class: 'bg-red-900/40 border-red-700/50 hover:bg-red-800 text-red-100 border',
          prompt: `ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ•ãƒªãƒ¼ã‚ºã—ãŸã‚Šã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚Šã—ã¦å‹•ãã¾ã›ã‚“ã€‚\nã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’è¦‹ç›´ã—ã¦ã€åŸå› ã‚’ç‰¹å®šã—ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\nã¾ãŸã€å†ç™ºé˜²æ­¢ã®ãŸã‚ã®ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`
        },
        {
          label: 'ğŸ¨ è¡¨ç¤ºå´©ã‚Œãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³',
          desc: 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒãŠã‹ã—ã„æ™‚',
          class: 'bg-orange-900/40 border-orange-700/50 hover:bg-orange-800 text-orange-100 border',
          prompt: `ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå´©ã‚Œã¦ã„ã¾ã™ï¼ˆã‚¹ãƒãƒ›è¡¨ç¤ºã‚„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ãªã©ï¼‰ã€‚\nCSSã‚’è¦‹ç›´ã—ã¦ã€ãã‚Œã„ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã‚’å«ã‚ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`
        },
        {
          label: 'âœ¨ æ©Ÿèƒ½è¿½åŠ ',
          desc: 'æ–°ã—ã„æ©Ÿèƒ½ã‚’å…¥ã‚ŒãŸã„æ™‚',
          class: 'bg-purple-900/40 border-purple-700/50 hover:bg-purple-800 text-purple-100 border',
          prompt: `ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚\nãƒ»[ã“ã“ã«è¿½åŠ ã—ãŸã„æ©Ÿèƒ½ã‚’æ›¸ã]\n\næ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ã¨æ•´åˆæ€§ãŒå–ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚`
        },
        {
          label: 'ğŸ§¹ ã‚³ãƒ¼ãƒ‰æ•´ç†',
          desc: 'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°',
          class: 'bg-teal-900/40 border-teal-700/50 hover:bg-teal-800 text-teal-100 border',
          prompt: `ã‚³ãƒ¼ãƒ‰ãŒè¤‡é›‘ã«ãªã£ã¦ããŸã®ã§æ•´ç†ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰ã—ã¦ãã ã•ã„ã€‚\nå¯èª­æ€§ã‚’ä¸Šã’ã‚‹ãŸã‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½è¨˜ã—ã€é•·ã™ãã‚‹é–¢æ•°ãŒã‚ã‚Œã°åˆ†å‰²ã—ã¦ãã ã•ã„ã€‚\næ©Ÿèƒ½ã‚„å‹•ä½œã¯å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚`
        }
      ],
      recipePrompts: [
        {
          label: 'ğŸ™ï¸ è‡ªå‹•è­°äº‹éŒ²',
          desc: 'ä¼šè­°ã®éŸ³å£°ã‚’æ–‡å­—èµ·ã“ã—ãƒ»ä¿å­˜',
          class: 'bg-blue-900/40 border-blue-700/50 hover:bg-blue-800 text-blue-100 border',
          prompt: `PCã®ãƒã‚¤ã‚¯ã‚’ä½¿ã£ã¦ã€ä¼šè­°ã®è­°äº‹éŒ²ã‚’è‡ªå‹•ã§ã¨ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã€‚\nè©±ã—ã¦ã„ã‚‹å†…å®¹ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç”»é¢ã«æ–‡å­—ã«ãªã£ã¦å‡ºã¦ãã‚‹æ„Ÿã˜ã§ã€‚\næœ€å¾Œã«ã€ãã®å†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã»ã—ã„ã€‚\nãƒ‡ã‚¶ã‚¤ãƒ³ã¯ä»•äº‹ã§ä½¿ã†ã‹ã‚‰ã€ç´ºè‰²ã£ã½ãã¦ã‚«ãƒƒã‚³ã„ã„æ„Ÿã˜ã§é ¼ã‚€ã€‚`
        },
        {
          label: 'ğŸ“š TOEIC 600å˜èªå¸³',
          desc: 'ãƒ¬ãƒ™ãƒ«åˆ¥ãƒ»é€²æ—ãƒãƒ¼ä»˜ã',
          class: 'bg-green-900/40 border-green-700/50 hover:bg-green-800 text-green-100 border',
          prompt: `TOEIC600ç‚¹ã‚’ç›®æŒ‡ã—ã¦å‹‰å¼·ã—ãŸã„ã‹ã‚‰ã€è‹±å˜èªå¸³ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã»ã—ã„ã€‚\nç§ã®ãƒ¬ãƒ™ãƒ«ã«ã‚ã£ãŸå˜èªãŒ100å€‹ãã‚‰ã„æœ€åˆã‹ã‚‰å…¥ã£ã¦ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è£è¿”ã£ã¦æ—¥æœ¬èªãŒå‡ºã‚‹ã‚„ã¤ã€‚\nã€è¦šãˆãŸã€ã‹ã€ã¾ã ã€ã‹ã‚’é¸ã¹ã¦ã€é€²ã¿å…·åˆãŒãƒãƒ¼ã§ã‚ã‹ã‚‹ã¨ã‚„ã‚‹æ°—ãŒå‡ºã‚‹ã‹ã‚‚ã€‚`
        },
        {
          label: 'ğŸ“‹ ç§˜å¯†ã®ã‚«ãƒ³ãƒãƒ³',
          desc: 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ»D&Då¯¾å¿œ',
          class: 'bg-purple-900/40 border-purple-700/50 hover:bg-purple-800 text-purple-100 border',
          prompt: `ãƒãƒƒãƒˆã«ç¹‹ãŒãªã„ã§ä½¿ãˆã‚‹ã€è‡ªåˆ†å°‚ç”¨ã®ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒœãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã€‚\nã‚¿ã‚¹ã‚¯ã‚’æ›¸ã„ãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¦ã‚¹ã§æ´ã‚“ã§ã€ã€æœªç€æ‰‹ã€ã‹ã‚‰ã€å®Œäº†ã€ã¨ã‹ã«ç§»å‹•ã§ãã‚‹ã‚„ã¤ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚å†…å®¹ã¯æ¶ˆãˆãªã„ã‚ˆã†ã«ã—ã¦ãŠã„ã¦ã€‚ç›®ã«å„ªã—ã„ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã€‚`
        },
        {
          label: 'ğŸ’£ ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘',
          desc: 'ãƒ¬ãƒˆãƒ­ãªæš‡ã¤ã¶ã—ã‚²ãƒ¼ãƒ ',
          class: 'bg-gray-700/40 border-gray-600/50 hover:bg-gray-600 text-gray-200 border',
          prompt: `æ˜¼ä¼‘ã¿ã®æš‡ã¤ã¶ã—ç”¨ã«ã€ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘ãƒ¼ã‚’ä½œã£ã¦ã€‚\nè¦‹ãŸç›®ã¯æ˜”ã®Windowsã®ã¿ãŸã„ãªã€ã‚°ãƒ¬ãƒ¼ã§ãƒ¬ãƒˆãƒ­ãªæ„Ÿã˜ã§ã€‚\nå·¦ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã„ã¦ã€å³ã‚¯ãƒªãƒƒã‚¯ã§æ——ã‚’ç«‹ã¦ã‚‹ã€ã„ã¤ã‚‚ã®ãƒ«ãƒ¼ãƒ«ã§éŠã¹ã‚‹ã‚ˆã†ã«ã—ã¦ã€‚`
        }
      ]
    };
  }
}).mount('#app');
</script>
</body>
</html>