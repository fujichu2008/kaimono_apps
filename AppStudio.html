<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AppStudio</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            forge: { 800: '#1e1e2e', 900: '#181825', 700: '#313244', accent: '#89b4fa', surface: '#45475a' }
          }
        }
      }
    }
  </script>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #181825; }
    ::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #585b70; }
    .glass-panel { background: rgba(30, 30, 46, 0.98); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .sidebar-panel { background: #1e1e2e; border-right: 1px solid #313244; transition: width 0.3s ease; }
    .gutter { background-color: #313244; cursor: col-resize; width: 6px; transition: background 0.2s; }
    .gutter:hover { background-color: #89b4fa; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    .pill-btn { border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .pill-btn:hover { background: rgba(255,255,255,.10); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New"; }

    /* Toast */
    .toast-enter-active, .toast-leave-active { transition: all .18s ease; }
    .toast-enter-from { opacity:0; transform: translateY(8px); }
    .toast-leave-to { opacity:0; transform: translateY(8px); }

    /* Draggable cursor */
    .drag-handle { cursor: move; user-select: none; }

    /* line-clamp fallback */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="bg-forge-900 text-gray-200 overflow-hidden font-sans">
<div id="app" class="h-screen flex flex-col">

  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[999] w-[92%] max-w-[760px] space-y-2 pointer-events-none">
    <transition-group name="toast" tag="div">
      <div v-for="t in toasts" :key="t.id"
           class="pointer-events-none bg-gray-900/95 border border-gray-700 rounded-xl shadow-2xl backdrop-blur px-4 py-3 flex items-start gap-3">
        <div class="mt-0.5">
          <i class="fas" :class="t.iconClass"></i>
        </div>
        <div class="min-w-0">
          <div class="text-xs font-bold text-gray-100">{{ t.title }}</div>
          <div class="text-[11px] text-gray-400 mt-0.5 whitespace-pre-wrap break-words">{{ t.message }}</div>
        </div>
      </div>
    </transition-group>
  </div>

  <div class="fixed bottom-1 right-2 z-[50] text-[10px] text-white font-mono pointer-events-none opacity-50 select-none">
    (c)2026 Hisashi Fujinaka All rights reserved.
  </div>

  <header class="glass-panel h-14 flex justify-between items-center px-4 z-30 shadow-lg relative">
    <div class="flex items-center gap-3 min-w-[320px]">
      <div class="flex items-center gap-2 mr-1">
        <span class="text-lg font-bold tracking-wider">
          AppStudio <span class="text-xs bg-gray-700 px-1 rounded">v4.0</span>
        </span>
      </div>

      <button v-if="appMode === 'project'" @click="toggleSidebar"
              class="w-8 h-8 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition"
              title="å±¥æ­´è¡¨ç¤ºåˆ‡æ›¿">
        <i class="fas fa-bars text-lg"></i>
      </button>

      <div class="relative">
        <button @click="menus.file = !menus.file"
                class="btn-secondary text-xs px-3 py-1.5 rounded bg-forge-700 hover:bg-gray-600 flex items-center gap-2 border border-gray-600 shadow-sm">
          <i class="fas fa-folder-open text-yellow-500"></i>
          <span class="font-bold">{{ projectDisplayName }}</span>
          <i class="fas fa-caret-down opacity-50"></i>
        </button>

        <div v-if="menus.file"
             class="absolute top-full left-0 mt-1 w-72 bg-forge-800 border border-gray-600 rounded shadow-2xl py-1 z-50">
          <div class="px-3 py-1 text-[10px] text-gray-500 font-bold uppercase">å˜ç™ºã‚¢ãƒ—ãƒª</div>

          <a @click="createNewSingleApp"
             class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
            <i class="fas fa-file-circle-plus w-4 text-green-400"></i> å˜ç™ºhtmlã‚¢ãƒ—ãƒªã‚’æ–°è¦ä½œæˆ
          </a>

          <a @click="openSingleFile"
             class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
            <i class="fas fa-file-code w-4"></i> HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
          </a>

          <div class="border-t border-gray-700 my-1"></div>
          <div class="px-3 py-1 text-[10px] text-gray-500 font-bold uppercase">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
          <a @click="createNewProject"
             class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
            <i class="fas fa-plus-circle w-4"></i> æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
          </a>
          <a @click="openProjectFolder"
             class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
            <i class="fas fa-folder w-4"></i> æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã
          </a>

          <div class="border-t border-gray-700 my-1"></div>
          <a v-if="appMode==='project'" @click="refreshLibrary"
             class="block px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm">
            <i class="fas fa-rotate w-4"></i> å±¥æ­´ã‚’å†èª­è¾¼
          </a>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="flex items-center bg-gray-800 rounded p-0.5 border border-gray-600">
        <button @click="runEmulator"
                class="px-4 py-1 bg-green-700 hover:bg-green-600 text-white text-xs rounded flex items-center gap-2 transition font-bold shadow hover:shadow-green-500/20"
                title="å®Ÿè¡Œ (Ctrl+Enter)">
          <i class="fas fa-play"></i> <span class="hidden sm:inline">å®Ÿè¡Œ</span>
        </button>
        <div class="w-px h-4 bg-gray-600 mx-1"></div>
        <button @click="stopEmulator"
                class="px-3 py-1 text-red-400 hover:bg-gray-700 hover:text-red-300 rounded text-xs transition"
                title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åœæ­¢">
          <i class="fas fa-stop"></i>
        </button>
      </div>

      <button @click="modals.settings = true"
              class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 flex items-center gap-2 transition border border-gray-600 text-gray-100 shadow"
              title="è¨­å®š">
        <i class="fas fa-cog text-gray-400"></i>
      </button>

      <button @click="openDbModal"
              class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 flex items-center gap-2 transition border border-gray-600 text-gray-100 shadow"
              title="IndexedDB ç°¡æ˜“è¡¨ç¤º">
        <i class="fas fa-database text-blue-300"></i> DB
      </button>

      <button @click="openFullWindow"
              class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 flex items-center gap-2 transition border border-gray-600 text-gray-100 shadow"
              title="åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§å…¨ç”»é¢è¡¨ç¤º">
        <i class="fas fa-up-right-from-square text-green-300"></i> å…¨ç”»é¢
      </button>

      <div class="h-6 w-px bg-gray-700 mx-1"></div>

      <button @click="modals.help = true"
              class="text-xs px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 flex items-center gap-2 transition border border-gray-600 text-gray-200 shadow"
              title="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">
        <i class="fas fa-question-circle"></i> ãƒ˜ãƒ«ãƒ—
      </button>

      <button @click="openAiModal"
              class="text-xs px-3 py-1.5 rounded bg-purple-800 hover:bg-purple-700 flex items-center gap-2 transition border border-purple-600 text-purple-100 shadow hover:shadow-purple-500/20">
        <i class="fas fa-robot"></i> AIæŒ‡ç¤º
      </button>

      <button @click="openPatchModal"
              class="text-xs px-3 py-1.5 rounded bg-yellow-700 hover:bg-yellow-600 flex items-center gap-2 font-bold text-white transition border border-yellow-600 shadow hover:shadow-yellow-500/20">
        <i class="fas fa-sync-alt"></i> ã‚³ãƒ¼ãƒ‰ç½®æ›
      </button>

      <div class="h-6 w-px bg-gray-700 mx-1"></div>

      <button @click="openSaveModal"
              class="btn-primary text-xs px-4 py-1.5 rounded bg-blue-600 hover:bg-blue-500 flex items-center gap-2 transition shadow-lg shadow-blue-900/30 font-bold">
        <i class="fas fa-save"></i> ä¿å­˜
      </button>
    </div>
  </header>

  <div class="flex-1 flex relative overflow-hidden">

    <transition name="fade">
      <aside v-if="appMode === 'project' && isSidebarOpen"
             class="w-80 sidebar-panel flex-shrink-0 flex flex-col z-10 shadow-xl">
        <div class="p-3 bg-forge-700 text-xs font-bold text-gray-300 flex justify-between items-center border-b border-gray-600">
          <span><i class="fas fa-history mr-1"></i> å¤‰æ›´å±¥æ­´ï¼ˆã‚¢ãƒ—ãƒªåå¤‰æ›´OKï¼‰</span>
          <button @click="refreshLibrary" class="hover:text-white" title="å†èª­è¾¼">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>

        <div class="p-2 border-b border-gray-700">
          <div class="text-[11px] text-gray-400 mb-1">è¡¨ç¤º</div>
          <div class="flex gap-2">
            <button @click="historyMode='group'"
                    class="flex-1 px-3 py-1.5 rounded text-xs font-bold"
                    :class="historyMode==='group' ? 'bg-blue-700 text-white' : 'bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700'">
              ã‚¢ãƒ—ãƒªåˆ¥
            </button>
            <button @click="historyMode='flat'"
                    class="flex-1 px-3 py-1.5 rounded text-xs font-bold"
                    :class="historyMode==='flat' ? 'bg-blue-700 text-white' : 'bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700'">
              å…¨å±¥æ­´
            </button>
          </div>

          <div class="mt-2 text-[10px] text-gray-500 leading-relaxed">
            â€»å±¥æ­´ã¯ <span class="kbd">meta.appId</span> ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã€
            ç„¡ã„å ´åˆã¯ <span class="kbd">meta.createdAt</span> / ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ãƒãƒƒã‚·ãƒ¥ã§å®‰å®šã‚­ãƒ¼åŒ–ã—ã¾ã™ã€‚
          </div>

          <div class="mt-2 text-[10px] text-gray-500">
            èª­ã¿è¾¼ã¿: <span class="text-gray-200 font-bold">{{ libraryFiles.length }}</span>ä»¶
            <span class="ml-2" v-if="libraryScanStatus">/ {{ libraryScanStatus }}</span>
          </div>

          <div class="mt-2">
            <button @click="debugRescanHard"
                    class="w-full px-3 py-1.5 rounded text-xs font-bold bg-gray-900/40 hover:bg-gray-800 border border-gray-700">
              <i class="fas fa-bug mr-1"></i> å¼·åˆ¶å†ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-2">

          <div v-if="libraryFiles.length === 0" class="text-center text-gray-500 py-10 text-xs">
            <i class="fas fa-folder-open mb-2 text-2xl opacity-30"></i><br>
            å±¥æ­´ãªã—ï¼ˆãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« .html ãŒè¦‹ã¤ã‹ã‚‰ãªã„ / èª­ã¿å–ã‚Šä¸å¯ã®å¯èƒ½æ€§ï¼‰
          </div>

          <template v-if="historyMode==='group'">
            <div v-for="grp in groupedApps" :key="grp.groupKey"
                 class="rounded border border-gray-700 bg-gray-900/40 overflow-hidden">
              <div class="p-2 bg-gray-900/60 border-b border-gray-700 flex items-start justify-between gap-2">
                <div class="min-w-0">
                  <div class="text-xs font-bold text-blue-200 truncate">
                    {{ grp.latestTitle || '(ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜)' }}
                  </div>
                  <div class="text-[10px] text-gray-500">
                    key: <span class="mono">{{ grp.groupKey.slice(0,12) }}</span>
                    / versions: {{ grp.versions.length }}
                  </div>
                  <div class="text-[10px] text-gray-400 mt-1 line-clamp-2" v-if="grp.latestAiInstruction">
                    <i class="fas fa-robot mr-1 opacity-70"></i>{{ grp.latestAiInstruction }}
                  </div>
                </div>
                <button @click="grp.open = !grp.open"
                        class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700">
                  {{ grp.open ? 'é–‰ã˜ã‚‹' : 'é–‹ã' }}
                </button>
              </div>

              <div v-if="grp.open" class="p-2 space-y-2">
                <div v-for="ver in grp.versions" :key="ver.name"
                     class="group p-2 rounded bg-gray-800 border border-gray-700 hover:border-gray-500 transition cursor-pointer flex flex-col gap-1"
                     :class="{'border-forge-accent bg-gray-700': currentFileName === ver.name}"
                     @click="loadFile(ver.handle)">
                  <div class="flex justify-between items-start gap-2">
                    <span class="text-xs font-bold text-blue-300 truncate">
                      {{ ver.displayTitle }}
                    </span>
                    <span class="text-[10px] text-gray-400 whitespace-nowrap">
                      {{ ver.savedAtStr }}
                    </span>
                  </div>

                  <div class="text-[10px] text-gray-500 break-all">
                    {{ ver.name }}
                  </div>

                  <div class="text-[11px] text-gray-300 mt-1 bg-gray-900 bg-opacity-50 p-1 rounded italic line-clamp-2" v-if="ver.meta.aiInstruction || ver.meta.comment">
                    <i class="fas fa-comment-alt text-[9px] mr-1 opacity-50"></i>{{ ver.meta.aiInstruction || ver.meta.comment }}
                  </div>

                  <div class="mt-2 flex gap-1 opacity-60 group-hover:opacity-100 transition">
                    <button @click.stop="runExternal(ver)"
                            class="flex-1 py-1 bg-gray-600 hover:bg-gray-500 rounded text-[10px]">
                      <i class="fas fa-external-link-alt"></i> åˆ¥çª“ã§å®Ÿè¡Œ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <template v-else>
            <div v-for="file in libraryFilesFlat" :key="file.name"
                 class="group p-2 rounded bg-gray-800 border border-gray-700 hover:border-gray-500 transition cursor-pointer flex flex-col gap-1 relative"
                 :class="{'border-forge-accent bg-gray-700': currentFileName === file.name}"
                 @click="loadFile(file.handle)">
              <div class="flex justify-between items-start gap-2">
                <span class="text-xs font-bold text-blue-300 truncate w-52">{{ file.displayTitle }}</span>
                <span class="text-[10px] text-gray-400 whitespace-nowrap">{{ file.savedAtStr }}</span>
              </div>
              <div class="text-[10px] text-gray-500">
                key: <span class="mono">{{ file.groupKey.slice(0,12) }}</span>
              </div>
              <div class="text-[10px] text-gray-500 break-all">
                {{ file.name }}
              </div>
              <div class="text-[11px] text-gray-300 mt-1 bg-gray-900 bg-opacity-50 p-1 rounded italic line-clamp-2" v-if="file.meta.aiInstruction || file.meta.comment">
                <i class="fas fa-comment-alt text-[9px] mr-1 opacity-50"></i>{{ file.meta.aiInstruction || file.meta.comment }}
              </div>
              <div class="mt-2 flex gap-1 opacity-60 group-hover:opacity-100 transition">
                <button @click.stop="runExternal(file)"
                        class="flex-1 py-1 bg-gray-600 hover:bg-gray-500 rounded text-[10px]">
                  <i class="fas fa-external-link-alt"></i> åˆ¥çª“ã§å®Ÿè¡Œ
                </button>
              </div>
            </div>
          </template>

        </div>
      </aside>
    </transition>

    <section id="editor-pane" class="flex-1 flex flex-col min-w-[300px] relative z-0">
      <div class="bg-forge-800 h-8 flex items-center justify-between px-2 border-b border-gray-700 select-none">
        <div class="flex items-center gap-2">
          <span class="text-xs font-bold text-gray-500 px-2"><i class="fas fa-code"></i> ã‚¨ãƒ‡ã‚£ã‚¿</span>

          <button @click="openFindReplace('find')"
                  class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="æ¤œç´¢ (Ctrl+F)">
            <i class="fas fa-search"></i>
          </button>
          <button @click="openFindReplace('replace')"
                  class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="ç½®æ› (Ctrl+H)">
            <i class="fas fa-i-cursor"></i>
          </button>

          <button @click="clearCode"
                  class="text-gray-400 hover:text-red-400 px-2 py-1 hover:bg-gray-700 rounded text-xs"
                  title="å…¨ã‚¯ãƒªã‚¢">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>

        <div class="text-[10px] text-gray-500 font-mono flex gap-3">
          <span>{{ editorStats.lines }} è¡Œ</span>
          <span>{{ editorStats.chars }} æ–‡å­—</span>
        </div>
      </div>

      <div class="flex-1 relative group">
        <div id="editor-container" class="w-full h-full"></div>

        <div v-if="findUI.open"
             class="absolute z-20 w-[720px] max-w-[92%] bg-gray-900/95 border border-gray-700 rounded-lg shadow-2xl backdrop-blur p-3"
             :style="{ left: findUI.x + 'px', top: findUI.y + 'px' }">
          <div class="flex items-center justify-between mb-2 drag-handle"
               @mousedown.prevent="startDragFindUI">
            <div class="text-xs font-bold text-gray-200 flex items-center gap-2">
              <i class="fas fa-search text-blue-300"></i>
              <span>Find / Replace</span>
              <span class="text-[10px] text-gray-500">(Escã§é–‰ã˜ã‚‹ / ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•)</span>
            </div>
            <button @click.stop="closeFindReplace"
                    class="w-7 h-7 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200"
                    title="é–‰ã˜ã‚‹">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>

          <div class="mb-2 flex items-center justify-between gap-2">
            <label class="flex items-center gap-2 text-[11px] text-gray-200 select-none cursor-pointer bg-gray-900/40 border border-gray-700 rounded px-3 py-1.5">
              <input type="checkbox" v-model="findUI.ignoreWhitespace" class="accent-blue-500">
              <span class="font-bold">æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–</span>
              <span class="text-gray-500">(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON)</span>
            </label>
            <div class="text-[10px] text-gray-500">â€»å˜ç´”æ¤œç´¢ï¼ˆæ­£è¦è¡¨ç¾ãªã—ï¼‰</div>
          </div>

          <div class="mb-2">
            <div class="flex items-center justify-between mb-1">
              <label class="text-[11px] font-bold text-gray-300">Find</label>
              <button type="button"
                      @click="findUI.find=''; recomputeMatchCount(); $nextTick(()=>findInputEl && findInputEl.focus())"
                      class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200 flex items-center gap-1"
                      title="Findã‚’ã‚¯ãƒªã‚¢">
                <i class="fas fa-eraser text-[10px]"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>

            <textarea ref="findInputEl"
                      v-model="findUI.find"
                      class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-xs text-gray-100 outline-none focus:border-blue-400 font-mono h-24 resize-y whitespace-pre"
                      placeholder="æ¤œç´¢æ–‡å­—åˆ—ï¼ˆãã®ã¾ã¾è²¼ã‚Šä»˜ã‘OK / Ctrl+Fï¼‰"
                      @input="recomputeMatchCount"
                      @keydown.enter.exact.prevent="findNext()"></textarea>
          </div>

          <div class="mb-2">
            <div class="flex items-center justify-between mb-1">
              <label class="text-[11px] font-bold text-gray-300">Replace</label>
              <button type="button"
                      @click="findUI.replace=''; $nextTick(()=>replaceInputEl && replaceInputEl.focus())"
                      class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-200 flex items-center gap-1"
                      title="Replaceã‚’ã‚¯ãƒªã‚¢">
                <i class="fas fa-eraser text-[10px]"></i> ã‚¯ãƒªã‚¢
              </button>
            </div>

            <textarea ref="replaceInputEl"
                      v-model="findUI.replace"
                      class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-xs text-gray-100 outline-none focus:border-yellow-400 font-mono h-24 resize-y whitespace-pre"
                      placeholder="ç½®æ›æ–‡å­—åˆ—ï¼ˆãã®ã¾ã¾è²¼ã‚Šä»˜ã‘OK / Ctrl+Hï¼‰"
                      @keydown.enter.exact.prevent="replaceOne()"></textarea>
          </div>

          <div class="flex items-center justify-between gap-2 mt-2">
            <div class="flex gap-2">
              <button @click="findNext"
                      class="px-3 py-2 rounded bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold border border-blue-600">
                æ¬¡ã‚’æ¤œç´¢
              </button>
              <button @click="findPrev"
                      class="px-3 py-2 rounded bg-blue-900 hover:bg-blue-800 text-white text-xs font-bold border border-blue-800">
                å‰ã‚’æ¤œç´¢
              </button>
            </div>

            <div class="flex gap-2">
              <button @click="replaceOne"
                      class="px-3 py-2 rounded bg-yellow-700 hover:bg-yellow-600 text-white text-xs font-bold border border-yellow-600">
                ç½®æ›
              </button>
              <button @click="replaceAll"
                      class="px-3 py-2 rounded bg-yellow-900 hover:bg-yellow-800 text-white text-xs font-bold border border-yellow-800">
                å…¨ç½®æ›
              </button>
            </div>
          </div>

          <div class="mt-2 text-[10px] text-gray-500 flex justify-between items-center">
            <span v-if="findUI.find && findUI.matchCount > 0" class="text-red-400 font-bold text-[12px]">è©²å½“ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š{{ findUI.matchCount }}ä»¶</span>
            <span v-else-if="findUI.find && findUI.matchCount === 0">è©²å½“ç®‡æ‰€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</span>
            <span v-else>æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
            <span class="text-gray-600">Enter=æ¬¡</span>
          </div>
        </div>

        <button @click="copyFullCode"
                class="absolute top-4 right-6 bg-gray-700 bg-opacity-80 hover:bg-blue-600 text-white text-xs px-3 py-2 rounded shadow-lg backdrop-blur opacity-0 group-hover:opacity-100 transition duration-200 z-10 flex items-center gap-2 font-bold">
          <i class="fas fa-copy"></i> ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>
    </section>

    <div class="gutter" @mousedown="startResize"></div>

    <section id="emulator-pane" class="flex-1 flex flex-col min-w-[300px] bg-white transition-all duration-200">
      <div class="bg-gray-100 h-8 flex items-center justify-between px-3 border-b border-gray-300">
        <div class="flex items-center gap-2">
          <span class="text-xs font-bold text-gray-700"><i class="fas fa-desktop"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
          <button @click="runEmulator" class="text-gray-400 hover:text-green-600 ml-2" title="ãƒªãƒ­ãƒ¼ãƒ‰">
            <i class="fas fa-redo"></i>
          </button>
        </div>

        <div class="flex items-center gap-2">
          <button @click="openDbModal"
                  class="text-xs text-gray-700 hover:bg-blue-100 px-2 py-0.5 rounded transition"
                  title="IndexedDB ç°¡æ˜“è¡¨ç¤º">
            <i class="fas fa-database"></i><span class="ml-1">DB</span>
          </button>

          <button @click="openFullWindow"
                  class="text-xs text-gray-700 hover:bg-green-100 px-2 py-0.5 rounded transition"
                  title="åˆ¥ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã«è¡¨ç¤º">
            <i class="fas fa-up-right-from-square"></i><span class="ml-1">åˆ¥çª“</span>
          </button>
        </div>
      </div>

      <div class="flex-1 relative bg-gray-5 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTVlNzViIiBzdHJva2Utd2lkdGg9IjEiPjxwYXRoIGQ9Ik0wIDBoMjB2MjBIMHoiLz48cGF0aCBkPSJNMCAyMGgyME0yMCAwdjIwIiBvcGFjaXR5PSIuMiIvPjwvc3ZnPg==')]">
        <iframe id="emulator-frame" class="w-full h-full border-none bg-white"></iframe>
      </div>

      <div class="h-24 bg-gray-900 border-t border-gray-700 flex flex-col font-mono text-[10px]">
        <div class="px-2 py-0.5 bg-gray-800 text-gray-500 flex justify-between">
          <span>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
          <button @click="consoleLogs=[]" class="hover:text-white">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="console-output">
          <div v-for="(log, i) in consoleLogs" :key="i" class="mb-0.5 border-b border-gray-800 pb-0.5"
               :class="{'text-red-400': log.type === 'error', 'text-yellow-400': log.type === 'warn', 'text-green-400': log.type === 'info'}">
            > {{ log.message }}
          </div>
        </div>
      </div>
    </section>
  </div>

  <div v-if="modals.ai" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-0 rounded-lg w-[780px] max-w-full shadow-2xl border border-gray-600 flex flex-col overflow-hidden">
      <div class="flex border-b border-gray-600 bg-gray-800">
        <button @click="aiTab='full'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="aiTab==='full' ? 'bg-forge-700 text-blue-400 border-b-2 border-blue-400' : 'text-gray-400 hover:text-white'">
          â‘  å…¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (æ–°è¦/ãƒªã‚»ãƒƒãƒˆ)
        </button>
        <button @click="aiTab='patch'"
                class="flex-1 py-3 text-sm font-bold transition"
                :class="aiTab==='patch' ? 'bg-forge-700 text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400 hover:text-white'">
          â‘¡ éƒ¨åˆ†ä¿®æ­£ (ç½®æ›ç”¨ã‚³ãƒ¼ãƒ‰ä½œæˆ)
        </button>
      </div>

      <div class="p-6 bg-forge-900">
        <p class="text-xs text-gray-400 mb-2">
          <i class="fas fa-info-circle"></i>
          <span v-if="aiTab==='full'">ã‚ãªãŸã®æŒ‡ç¤ºã‚’å…ƒã«ã€AIã«ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ã›ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</span>
          <span v-else>å¤‰æ›´æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIã«ã€Œå¤‰æ›´å‰ã®ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œå¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã€ã‚’æ˜ç¢ºã«å‡ºåŠ›ã•ã›ã€æ‰‹å‹•ã§ç½®æ›ã—ã‚„ã™ãã—ã¾ã™ã€‚</span>
        </p>

        <div class="mb-2 text-[11px] text-gray-500" v-if="appMode==='project'">
          å¯¾è±¡ã‚¢ãƒ—ãƒª: <span class="text-gray-200 font-bold">{{ currentAppTitle || '(æœªé¸æŠ)' }}</span>
          <span class="ml-2 text-gray-600">(key: <span class="mono">{{ (currentGroupKey||'').slice(0,12) }}</span>)</span>
        </div>

        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-300 mb-1">æŒ‡ç¤ºå†…å®¹ï¼ˆã“ã®ã‚¢ãƒ—ãƒªã«ç´ã¥ã‘ï¼‰</label>
          <textarea v-model="aiInstruction"
                    class="w-full h-32 bg-gray-800 border border-gray-600 rounded p-3 text-sm text-white focus:border-forge-accent outline-none resize-none"
                    :placeholder="aiTab==='full' ? 'ä¾‹: ã‚·ãƒ³ãƒ—ãƒ«ãªTODOã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã€‚è‰²ã¯é’ãƒ™ãƒ¼ã‚¹ã§ã€‚' : 'ä¾‹: ã€Œä¿å­˜ãƒœã‚¿ãƒ³ã€ã®è‰²ã‚’èµ¤ã«å¤‰æ›´ã—ã¦ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã‚‹ã‚ˆã†ã«ã—ã¦ã€‚'"></textarea>
          <div class="text-[10px] text-gray-500 mt-1">
            â€»ä¿å­˜æ™‚ã« <span class="kbd">meta.aiInstruction</span> ã¨ã—ã¦è¨˜éŒ²ã—ã€å±¥æ­´ä¸€è¦§ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div v-if="aiTab==='patch'" class="mb-4">
          <label class="block text-xs font-bold text-gray-300 mb-2">ã‚³ãƒ¼ãƒ‰æ·»ä»˜</label>
          <div class="flex flex-col gap-2 bg-gray-900/40 border border-gray-700 rounded p-3">
            <label class="flex items-center gap-2 text-sm text-gray-200 cursor-pointer">
              <input type="radio" class="accent-blue-500" name="ai-attach" :value="true" v-model="aiIncludeFullCode">
              <span class="font-bold text-gray-100">ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ·»ä»˜ã™ã‚‹</span>
              <span class="text-[11px] text-gray-500">ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’çœç•¥ã›ãšã€ã™ã¹ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ï¼‰</span>
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-200 cursor-pointer">
              <input type="radio" class="accent-blue-500" name="ai-attach" :value="false" v-model="aiIncludeFullCode">
              <span class="font-bold text-gray-100">ã‚³ãƒ¼ãƒ‰æ·»ä»˜ã‚’çœç•¥</span>
              <span class="text-[11px] text-gray-500">ï¼ˆChatGPTãŒæ—¢ã«ã‚³ãƒ¼ãƒ‰ã‚’æŠŠæ¡ã—ã¦ã„ã‚‹å‰æï¼‰</span>
            </label>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-2">
          <button @click="modals.ai = false" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">é–‰ã˜ã‚‹</button>
          <button @click="generateAndCopyPrompt"
                  class="px-6 py-2 rounded font-bold text-white shadow-lg flex items-center gap-2"
                  :class="aiTab==='full' ? 'bg-blue-600 hover:bg-blue-500' : 'bg-yellow-600 hover:bg-yellow-500'">
            <i class="fas fa-magic"></i> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼†ã‚³ãƒ”ãƒ¼
          </button>
        </div>

        <div v-if="aiMessage" class="mt-2 text-center text-xs text-green-400 font-bold">
          {{ aiMessage }}
        </div>
      </div>
    </div>
  </div>

  <div v-if="modals.save" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-panel p-6 rounded-lg w-[480px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-3 text-white flex items-center gap-2">
        <i class="fas fa-save text-blue-400"></i> ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
      </h3>

      <div class="mb-3 text-[11px] text-gray-400">
        <span v-if="appMode==='project'">
          ä¿å­˜å…ˆ: <span class="font-bold text-gray-100">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å†…</span>
        </span>
        <span v-else>
          ä¿å­˜å…ˆ: <span class="font-bold text-gray-100">æ¯å›æŒ‡å®š</span>ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚ã¦é¸æŠã§ãã¾ã™ï¼‰
        </span>
      </div>

      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">ãƒ•ã‚¡ã‚¤ãƒ«å (ç·¨é›†å¯èƒ½)</label>
        <input v-model="saveFilename" type="text"
               class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
        <p class="text-[10px] text-gray-500 mt-1">â€»è‡ªå‹•çš„ã«æ—¥æ™‚ãŒä»˜ä¸ã•ã‚Œã¾ã™ï¼ˆå¤‰æ›´å¯ï¼‰ã€‚</p>
      </div>

      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">å¤‰æ›´å±¥æ­´ãƒ¡ãƒ¢ï¼ˆAIæŒ‡ç¤ºãŒè‡ªå‹•å…¥åŠ›ï¼‰</label>
        <textarea v-model="saveComment"
                  class="w-full h-20 bg-gray-800 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 outline-none resize-none"></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="modals.save = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button @click="performSave" class="px-4 py-2 text-sm rounded bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">ä¿å­˜å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>

  <div v-if="modals.patch" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-lg w-[92%] max-w-[980px] h-[90vh] shadow-2xl border border-gray-600 flex flex-col">
      <div class="flex items-center justify-between gap-3 flex-shrink-0">
        <h3 class="text-lg font-bold text-yellow-400"><i class="fas fa-sync-alt"></i> ã‚³ãƒ¼ãƒ‰ç½®æ› (æ‰‹å‹•ãƒ‘ãƒƒãƒ)</h3>
        <label class="flex items-center gap-2 text-xs text-gray-200 select-none cursor-pointer bg-gray-900/40 border border-gray-700 rounded px-3 py-1.5">
          <input type="checkbox" v-model="patchIgnoreWhitespace" class="accent-yellow-500">
          <span class="font-bold">æ”¹è¡Œãƒ»ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–ã—ã¦æ¤œç´¢</span>
          <span class="text-gray-500">(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON)</span>
        </label>
      </div>

      <p class="text-xs text-gray-400 mt-2 mb-2 flex-shrink-0">
        AIãŒå‡ºåŠ›ã—ãŸã€Œå¤‰æ›´å‰ã®ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œå¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆè¤‡æ•°è¡ŒOKï¼‰ã€‚
      </p>

      <div class="flex-1 flex flex-col gap-3 overflow-hidden">
        <div class="flex-1 flex flex-col min-h-[220px]">
          <label class="text-xs font-bold text-red-300 mb-1"><i class="fas fa-search"></i> æ¤œç´¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ (ç½®æ›å…ƒ)</label>
          <textarea v-model="patchFindInput"
                    class="flex-1 bg-gray-900 border border-red-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-red-500 outline-none resize-y whitespace-pre"
                    placeholder="ã“ã“ã«ç½®æ›å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ï¼ˆæ”¹è¡ŒOKï¼‰..."></textarea>
        </div>

        <div class="flex justify-center items-center flex-shrink-0 text-gray-500">
          <i class="fas fa-arrow-down"></i> ã“ã‚Œã«ç½®ãæ›ãˆã‚‹ <i class="fas fa-arrow-down"></i>
        </div>

        <div class="flex-1 flex flex-col min-h-[220px]">
          <label class="text-xs font-bold text-green-300 mb-1"><i class="fas fa-pen"></i> ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ (æ–°ã—ã„ã‚³ãƒ¼ãƒ‰)</label>
          <textarea v-model="patchReplaceInput"
                    class="flex-1 bg-gray-900 border border-green-900/50 rounded p-3 font-mono text-xs text-gray-200 focus:border-green-500 outline-none resize-y whitespace-pre"
                    placeholder="...ã“ã“ã«ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ï¼ˆæ”¹è¡ŒOKï¼‰"></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-3 flex-shrink-0">
        <button @click="modals.patch = false" class="px-4 py-2 text-sm rounded bg-gray-700 hover:bg-gray-600">é–‰ã˜ã‚‹</button>
        <button @click="applyPatch" class="px-6 py-2 text-sm rounded bg-yellow-700 hover:bg-yellow-600 text-white font-bold shadow-lg">
          ç½®æ›ã‚’å®Ÿè¡Œã™ã‚‹
        </button>
      </div>
    </div>
  </div>

  <div v-if="modals.db" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-lg w-[92%] max-w-[900px] h-[84vh] shadow-2xl border border-gray-600 flex flex-col">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-blue-300 flex items-center gap-2">
          <i class="fas fa-database"></i> IndexedDB ç°¡æ˜“è¡¨ç¤º
        </h3>
        <div class="flex items-center gap-2">
          <button @click="refreshDbDump"
                  class="px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-xs font-bold">
            <i class="fas fa-rotate"></i> å†å–å¾—
          </button>
          <button @click="modals.db=false"
                  class="px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 text-xs font-bold">
            <i class="fas fa-times"></i> é–‰ã˜ã‚‹
          </button>
        </div>
      </div>

      <div class="mt-2 text-[11px] text-gray-400 leading-relaxed">
        ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´(iframe)ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å–å¾—ã—ã¾ã™ã€‚<br>
        ãƒ»å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ <span class="kbd">indexedDB.databases()</span> ã‚’ä½¿ã„ã¾ã™ï¼ˆæœªå¯¾å¿œã®å ´åˆã¯ä¸€éƒ¨æƒ…å ±ã®ã¿ï¼‰ã€‚
      </div>

      <div class="mt-4 flex-1 overflow-auto bg-gray-900/50 border border-gray-700 rounded p-3">
        <div v-if="dbDump.loading" class="text-gray-400 text-sm">
          <i class="fas fa-spinner fa-spin"></i> å–å¾—ä¸­...
        </div>

        <div v-else-if="dbDump.error" class="text-red-300 text-sm whitespace-pre-wrap">
          {{ dbDump.error }}
        </div>

        <div v-else-if="dbDump.items.length===0" class="text-gray-400 text-sm">
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã¾ãŸã¯æœªå¯¾å¿œï¼‰ã€‚
        </div>

        <div v-else class="space-y-3">
          <div v-for="db in dbDump.items" :key="db.name"
               class="rounded border border-gray-700 bg-gray-800/60 overflow-hidden">
            <div class="px-3 py-2 bg-gray-900/70 border-b border-gray-700 flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="text-sm font-bold text-gray-100 truncate">
                  {{ db.name }} <span class="text-[11px] text-gray-400 font-normal">v{{ db.version }}</span>
                </div>
                <div class="text-[11px] text-gray-400">
                  stores: {{ db.stores?.length || 0 }}
                </div>
              </div>
              <button class="px-2 py-1 text-[10px] rounded bg-gray-800 hover:bg-gray-700 border border-gray-700"
                      @click="db.open=!db.open">
                {{ db.open ? 'é–‰ã˜ã‚‹' : 'é–‹ã' }}
              </button>
            </div>

            <div v-if="db.open" class="p-3 space-y-2">
              <div v-if="(db.stores||[]).length===0" class="text-gray-400 text-sm">
                storeæƒ…å ±ãªã—ï¼ˆå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰
              </div>
              <div v-for="st in (db.stores||[])" :key="st.name"
                   class="rounded border border-gray-700 bg-gray-900/60 p-2">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-bold text-blue-200">{{ st.name }}</div>
                  <div class="text-[11px] text-gray-400">count: {{ st.count }}</div>
                </div>
                <div class="text-[11px] text-gray-400 mt-1 break-all">
                  keyPath: {{ st.keyPath ?? '(none)' }} / autoIncrement: {{ st.autoIncrement ? 'true' : 'false' }}
                </div>
                <details class="mt-2">
                  <summary class="text-[11px] text-gray-300 cursor-pointer">ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ¼ï¼ˆæœ€å¤§20ä»¶ï¼‰</summary>
                  <pre class="mt-2 text-[10px] text-gray-200 whitespace-pre-wrap">{{ JSON.stringify(st.sampleKeys||[], null, 2) }}</pre>
                </details>
              </div>
            </div>
          </div>
        </div>

        <div class="text-[10px] text-gray-500">
          â€» ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ã®DBå–å¾—ã¯ã€Œèª­ã¿å–ã‚Šã®ã¿ã€ã§ã™ï¼ˆå‰Šé™¤/æ›´æ–°ã¯ã—ã¾ã›ã‚“ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <div v-if="modals.help" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-0 rounded-lg w-[800px] max-w-full h-[85vh] shadow-2xl border border-gray-600 flex flex-col overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 bg-gray-800 border-b border-gray-700">
        <h3 class="text-lg font-bold text-white flex items-center gap-2">
          <i class="fas fa-book-open text-green-400"></i> AppStudio ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
        </h3>
        <button @click="modals.help=false" class="text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-8 text-gray-300 space-y-8 bg-forge-900">
        
        <section>
          <h4 class="text-xl font-bold text-white mb-3 border-b border-gray-700 pb-2">ğŸš€ AppStudioã¨ã¯ï¼Ÿ</h4>
          <p class="text-sm leading-relaxed">
            AppStudioã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹<b>ã€Œå˜ä¸€HTMLã‚¢ãƒ—ãƒªã€å°‚ç”¨ã®çµ±åˆé–‹ç™ºç’°å¢ƒ</b>ã§ã™ã€‚<br>
            å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãªãã€ã‚ãªãŸã®PCå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ãƒ»ä¿å­˜ã—ã¾ã™ã€‚<br>
            ChatGPTãªã©ã®AIã¨çµ„ã¿åˆã‚ã›ã¦ã€ã€ŒVibe Codingã€ï¼ˆAIã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ã›ã¦ã€äººé–“ã¯æŒ‡ç¤ºã¨ç¢ºèªã«å¾¹ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’è¡Œã†ã®ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
          </p>
        </section>

        <section class="grid grid-cols-2 gap-6">
          <div>
            <h4 class="text-md font-bold text-blue-300 mb-2"><i class="fas fa-project-diagram"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰</h4>
            <p class="text-xs leading-relaxed text-gray-400">
              ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦é–‹ç™ºã‚’å§‹ã‚ã¾ã™ã€‚<br>
              ä¿å­˜ã™ã‚‹ãŸã³ã«å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã€ã„ã¤ã§ã‚‚éå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã—ãŸã‚Šã€å·®åˆ†ã‚’ç¢ºèªã—ãŸã‚Šã§ãã¾ã™ã€‚<br>
              æœ¬æ ¼çš„ãªã‚¢ãƒ—ãƒªé–‹ç™ºã¯ã“ã¡ã‚‰ãŒãŠã™ã™ã‚ã§ã™ã€‚
            </p>
          </div>
          <div>
            <h4 class="text-md font-bold text-yellow-300 mb-2"><i class="fas fa-file-code"></i> å˜ç™ºãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰</h4>
            <p class="text-xs leading-relaxed text-gray-400">
              1ã¤ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µã‚¯ãƒƒã¨ç·¨é›†ã—ãŸã„æ™‚ã«ä½¿ã„ã¾ã™ã€‚<br>
              å±¥æ­´ç®¡ç†æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ‰‹è»½ã«åˆ©ç”¨ã§ãã¾ã™ã€‚
            </p>
          </div>
        </section>

        <section>
          <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">ğŸ¤– AIã‚’ä½¿ã£ãŸé–‹ç™ºãƒ•ãƒ­ãƒ¼</h4>
          <ol class="list-decimal list-inside text-sm space-y-3 text-gray-300">
            <li>
              <strong class="text-purple-300">AIæŒ‡ç¤ºãƒœã‚¿ãƒ³</strong><br>
              ã€Œã“ã†ã„ã†ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã€ã‚„ã€Œã“ã“ã‚’ä¿®æ­£ã—ã¦ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã <b>æœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</b>ã‚’ç”Ÿæˆã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
            </li>
            <li>
              <strong class="text-green-300">AIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘</strong><br>
              ChatGPTã‚„Claudeãªã©ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã¦é€ä¿¡ã—ã¾ã™ã€‚AIãŒä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã‚Œã¾ã™ã€‚
            </li>
            <li>
              <strong class="text-yellow-300">ã‚³ãƒ¼ãƒ‰ç½®æ› (Patch)</strong><br>
              AIãŒå‡ºåŠ›ã—ãŸã€Œå¤‰æ›´å‰ã€ã¨ã€Œå¤‰æ›´å¾Œã€ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ã€Œã‚³ãƒ¼ãƒ‰ç½®æ›ã€ç”»é¢ã«è²¼ã‚Šä»˜ã‘ã‚‹ã ã‘ã§ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã«ä¿®æ­£ã‚’é©ç”¨ã§ãã¾ã™ã€‚<br>
              ï¼ˆã‚‚ã¡ã‚ã‚“ã€å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã«ä¸Šæ›¸ãã—ã¦ã‚‚OKã§ã™ï¼‰
            </li>
          </ol>
        </section>

        <section>
          <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">âœ¨ ä¾¿åˆ©ãªæ©Ÿèƒ½</h4>
          <ul class="list-disc list-inside text-sm space-y-2 text-gray-400">
            <li><span class="text-gray-200 font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åˆ¥çª“è¡¨ç¤º:</span> <i class="fas fa-up-right-from-square"></i> ãƒœã‚¿ãƒ³ã§ã€æ–°ã—ã„ã‚¿ãƒ–ã§ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã®ãƒ‡ãƒãƒƒã‚°ã«ä¾¿åˆ©ã§ã™ã€‚</li>
            <li><span class="text-gray-200 font-bold">IndexedDBç¢ºèª:</span> ã‚¢ãƒ—ãƒªãŒãƒ–ãƒ©ã‚¦ã‚¶å†…DBã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ä¸­èº«ã‚’ç°¡æ˜“è¡¨ç¤ºã§ãã¾ã™ã€‚</li>
            <li><span class="text-gray-200 font-bold">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š:</span> è¨­å®šãƒœã‚¿ãƒ³ <i class="fas fa-cog"></i> ã‹ã‚‰ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’å›ºå®šã—ã¦ãŠãã¨ã€æ¬¡å›ã‹ã‚‰ã‚¹ãƒ ãƒ¼ã‚ºã«é–‹ç™ºã‚’å†é–‹ã§ãã¾ã™ã€‚</li>
          </ul>
        </section>

      </div>
      <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-end">
        <button @click="modals.help=false" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">
          ã‚ã‹ã£ãŸï¼
        </button>
      </div>
    </div>
  </div>

  <div v-if="modals.settings" class="fixed inset-0 bg-black bg-opacity-70 z-50 backdrop-blur-sm flex items-center justify-center">
    <div class="glass-panel p-6 rounded-lg w-[420px] shadow-2xl border border-gray-600">
      <h3 class="text-lg font-bold mb-4 text-gray-200 flex items-center gap-2"><i class="fas fa-cog"></i> è¨­å®š</h3>
      <div class="mb-4">
        <label class="block text-xs font-bold text-gray-400 mb-2">ã“ã®ã‚µã‚¤ãƒˆã§å¤‰æ›´ã‚’ä¿å­˜ã§ãã‚‹å ´æ‰€ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜å…ˆ)</label>
        <div v-if="projectRootHandle" class="text-xs text-green-400 mb-3 flex items-center gap-2 bg-green-900/30 p-2 rounded border border-green-800">
           <i class="fas fa-check-circle"></i> æŒ‡å®šæ¸ˆã¿: <span class="font-mono">{{ projectRootHandle.name }}</span>
        </div>
        <div v-else class="text-xs text-gray-500 mb-3 bg-gray-800 p-2 rounded border border-gray-700">
           æœªæŒ‡å®š (ä½œæˆã®ãŸã³ã«é¸æŠã—ã¾ã™)
        </div>
        <button @click="setProjectRoot" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white border border-gray-600 flex items-center justify-center gap-2">
           <i class="fas fa-folder-tree"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®š
        </button>
      </div>
      <div class="flex justify-end pt-2 border-t border-gray-700">
        <button @click="modals.settings=false" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-xs text-white">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

</div>

<script type="text/template" id="default-code">
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>My App</title>
  <style>
    body { font-family: system-ui, sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#f0f4f8; color:#333; }
    .card { background:white; padding:2rem; border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,.12); text-align:center; max-width:420px; width:min(92vw,420px); }
    h1 { color:#2563eb; margin:0 0 .5rem; }
    p { color:#64748b; margin:0 0 1.2rem; line-height:1.5; }
    button { background:#2563eb; color:white; border:none; padding:.75rem 1.25rem; border-radius:.65rem; cursor:pointer; font-weight:700; transition:.2s; }
    button:hover { background:#1d4ed8; transform: translateY(-1px); }
  </style>
</head>
<body>
  <div class="card">
    <h1>Hello, AppStudio!</h1>
    <p>ã¾ã£ã•ã‚‰ãªçŠ¶æ…‹ã‹ã‚‰ã€ã“ã“ã«UI/JSã‚’è¶³ã—ã¦ã„ã‘ã¾ã™ã€‚</p>
    <button onclick="alert('ã‚¢ãƒ—ãƒªã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼')">ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
  </div>











<script id="lfs-meta" type="application/json">
{
  "appId": "3af38cc9d541d668dc7682a3ecc0a65e",
  "createdAt": "2026-01-03T20:11:20.821Z",
  "schema": 2,
  "title": "AppStudio",
  "savedAt": "2026-01-03T21:31:29.141Z",
  "aiInstruction": "ãƒªãƒ—ãƒ¬ãƒ¼ã‚¹æ™‚ã«ã‚¯ãƒªã‚¢",
  "comment": "v4.0",
  "sourceMode": "project",
  "runId": "5cb49a96ab7a38f9f96403412a401712"
}
</script>
</body>
</html>
</script>

<script>
const { createApp, ref, reactive, onMounted, nextTick, computed } = Vue;

createApp({
  setup() {
    // --- STATE ---
    const appMode = ref('single'); // 'project' | 'single'
    const projectHandle = ref(null);
    const projectDisplayName = ref('æœªé¸æŠ (å˜ç™º)');
    const currentFileHandle = ref(null);
    const currentFileName = ref('');

    // Library / History
    const libraryFiles = ref([]);
    const libraryScanStatus = ref('');

    // History mode
    const historyMode = ref('group'); // 'group' | 'flat'

    // UI state
    const menus = reactive({ file: false });
    const modals = reactive({ ai: false, save: false, patch: false, db: false, settings: false, help: false });
    const projectRootHandle = ref(null);
    const isSidebarOpen = ref(true);

    const aiTab = ref('full'); // 'full' | 'patch'
    const aiInstruction = ref('');
    const aiMessage = ref('');
    const aiIncludeFullCode = ref(true);

    const saveComment = ref('');
    const saveFilename = ref('');
    const patchFindInput = ref('');
    const patchReplaceInput = ref('');
    const patchIgnoreWhitespace = ref(true);

    // Find/Replace custom UI
    const findUI = reactive({
      open: false,
      mode: 'find',
      find: '',
      replace: '',
      matchCount: 0,
      ignoreWhitespace: true,
      x: 8,
      y: 8
    });
    const findInputEl = ref(null);
    const replaceInputEl = ref(null);
    let lastFindDirection = 1;

    // Drag state for Find UI
    let dragActive = false;
    let dragStartX = 0, dragStartY = 0;
    let dragBaseX = 0, dragBaseY = 0;

    // Editor & logs
    const editorStats = reactive({ lines: 0, chars: 0 });
    const consoleLogs = ref([]);
    let editor = null;

    // Full window handle
    let fullWin = null;
    let lastRunId = null;

    // Current identity
    const currentAppTitle = ref('');
    const currentGroupKey = ref('');
    const currentMeta = reactive({});

    // DB dump state
    const dbDump = reactive({ loading: false, error: '', items: [] });

    // Toast
    const toasts = ref([]);
    const pushToast = (title, message, iconClass='fa-circle-info text-sky-300', timeout=2200) => {
      const id = crypto.getRandomValues(new Uint32Array(1))[0].toString(16) + Date.now().toString(16);
      toasts.value.push({ id, title, message, iconClass });
      setTimeout(() => {
        const idx = toasts.value.findIndex(t => t.id === id);
        if (idx >= 0) toasts.value.splice(idx, 1);
      }, Math.max(900, timeout|0));
    };

    // --- SETTINGS DB ---
    const DB_CFG = { name: 'AppStudio_DB', store: 'handles', key: 'root_dir' };
    const getDB = () => new Promise((res, rej) => {
      const r = indexedDB.open(DB_CFG.name, 1);
      r.onupgradeneeded = e => {
        const db = e.target.result;
        if(!db.objectStoreNames.contains(DB_CFG.store)) db.createObjectStore(DB_CFG.store);
      };
      r.onsuccess = () => res(r.result);
      r.onerror = () => rej(r.error);
    });
    const saveRootHandle = async (h) => {
      try { const db = await getDB(); db.transaction(DB_CFG.store, 'readwrite').objectStore(DB_CFG.store).put(h, DB_CFG.key); } catch(e){}
    };
    const loadRootHandle = async () => {
      try {
        const db = await getDB();
        return new Promise(r => {
          const req = db.transaction(DB_CFG.store, 'readonly').objectStore(DB_CFG.store).get(DB_CFG.key);
          req.onsuccess = () => r(req.result);
          req.onerror = () => r(null);
        });
      } catch { return null; }
    };

    // --- UTIL ---
    const genId = () => {
      const buf = new Uint8Array(16);
      crypto.getRandomValues(buf);
      return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('');
    };

    const safeParseJSON = (s) => {
      try { return JSON.parse(s); } catch { return null; }
    };

    const extractTitleFromHtml = (html) => {
      const m = html.match(/<title>([\s\S]*?)<\/title>/i);
      return m ? m[1].trim() : '';
    };

    const extractMeta = (html) => {
      const m = html.match(/<script id="lfs-meta"\s+type="application\/json">\s*([\s\S]*?)\s*<\/script>/i);
      if (!m) return {};
      const j = safeParseJSON(m[1]);
      return j && typeof j === 'object' ? j : {};
    };

    const normalizeTs = (isoOrAny) => {
      if (!isoOrAny) return null;
      const d = new Date(isoOrAny);
      if (isNaN(d.getTime())) return null;
      return d;
    };

    const formatLocal = (d) => {
      try { return d.toLocaleString(); } catch { return String(d); }
    };

const injectMeta = (code, metaObj) => {
      const meta = JSON.stringify(metaObj, null, 2);
      // è‡ªå·±ç½®æ›å›é¿: ã“ã®ã‚³ãƒ¼ãƒ‰è‡ªä½“ãŒæ¤œç´¢ã«å¼•ã£ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã€ã‚¿ã‚°æ–‡å­—åˆ—ã‚’åˆ†å‰²ã—ã¦çµåˆã™ã‚‹
      const tagOpen = '<script id="lfs-meta" ' + 'type="application/json">';
      const tagClose = '<\/script>';
      const tag = `\n${tagOpen}\n${meta}\n${tagClose}\n`;

      // æ¤œç´¢å³å¯†åŒ–: ã‚³ãƒ¼ãƒ‰å†…ã®regexãƒªãƒ†ãƒ©ãƒ«(\s+ç­‰)ã«ãƒãƒƒãƒã—ãªã„ã‚ˆã†ã€å±æ€§é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚‚å³å¯†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã™ã‚‹
      const pattern = /<script id="lfs-meta" type="application\/json">[\s\S]*?<\/script>\s*/i;

      if (pattern.test(code)) {
        return code.replace(pattern, () => tag);
      }
      if (code.match(/<\/body>/i)) return code.replace(/<\/body>/i, () => tag + '</body>');
      return code + tag;
    };

    const miniHash = (s) => {
      // fast, stable (not crypto) - enough for grouping fallback
      let h = 2166136261;
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16).padStart(8,'0');
    };

    const stableGroupKeyFromFile = (text, meta, fileName) => {
      // Priority: meta.appId > meta.createdAt > (title + first 200 chars hash)
      if (meta && typeof meta.appId === 'string' && meta.appId.length >= 8) return `app:${meta.appId}`;
      if (meta && typeof meta.createdAt === 'string' && meta.createdAt.length >= 8) return `crt:${meta.createdAt}`;
      const title = (meta && meta.title) ? String(meta.title) : (extractTitleFromHtml(text) || '');
      const head = (text || '').slice(0, 240);
      return `h:${miniHash(title + '|' + head + '|' + (fileName||''))}`;
    };

    const syncIdentityFromCode = (code) => {
      const meta = extractMeta(code);
      const title = meta.title || extractTitleFromHtml(code) || 'App';
      const groupKey = stableGroupKeyFromFile(code, meta, currentFileName.value);

      currentAppTitle.value = title;
      currentGroupKey.value = groupKey;

      Object.keys(currentMeta).forEach(k => delete currentMeta[k]);
      Object.assign(currentMeta, meta);
    };

    // --- MONACO INIT ---
    onMounted(async () => {
      initMonaco();

      // è¨­å®šä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãƒãƒ³ãƒ‰ãƒ«ã®å¾©å…ƒ
      const saved = await loadRootHandle();
      if (saved) projectRootHandle.value = saved;

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.relative')) menus.file = false;
      });

      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runEmulator(); return; }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'f' || e.key === 'F')) { e.preventDefault(); openFindReplace('find'); return; }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'h' || e.key === 'H')) { e.preventDefault(); openFindReplace('replace'); return; }
        if (e.key === 'Escape' && findUI.open) { e.preventDefault(); closeFindReplace(); return; }
      });

      // message receiver from preview iframes/windows
      window.addEventListener('message', (e) => {
        const d = e.data || {};
        if (d?.type === 'console') {
          consoleLogs.value.push({ type: d.l, message: d.m });
          return;
        }
        if (d?.type === 'idb_dump_result') {
          if (d?.runId && d.runId !== lastRunId) return;
          dbDump.loading = false;
          dbDump.error = d.error || '';
          dbDump.items = Array.isArray(d.items) ? d.items : [];
          return;
        }
      });
    });

    const initMonaco = () => {
      require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
      require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor-container'), {
          value: document.getElementById('default-code').innerHTML.trim(),
          language: 'html',
          theme: 'vs-dark',
          automaticLayout: true,
          minimap: { enabled: false },
          fontSize: 14,
          scrollBeyondLastLine: false,
        });

        const updateStats = () => {
          const model = editor.getModel();
          editorStats.lines = model.getLineCount();
          editorStats.chars = model.getValueLength();
        };

        editor.onDidChangeModelContent(() => {
          updateStats();
          if (findUI.open) recomputeMatchCount();
        });
        updateStats();

        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyF, () => openFindReplace('find'));
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyH, () => openFindReplace('replace'));
        editor.addCommand(monaco.KeyCode.Escape, () => { if(findUI.open) closeFindReplace(); });

        // identity from initial code
        syncIdentityFromCode(editor.getValue());
        runEmulator();
      });
    };

    // --- FIND/REPLACE (WHITESPACE-IGNORING SUPPORTED) ---
    const buildCompacted = (src) => {
      const compactChars = [];
      const mapNormToOrig = [];
      for (let i = 0; i < src.length; i++) {
        const ch = src[i];
        if (/\s/.test(ch)) continue;
        mapNormToOrig.push(i);
        compactChars.push(ch);
      }
      return { compact: compactChars.join(""), mapNormToOrig };
    };
    const normalizeFind = (src) => (src || '').replace(/\s+/g, '');

    const getMatches = () => {
      if(!editor) return [];
      const qRaw = findUI.find || '';
      if(!qRaw) { findUI.matchCount = 0; return []; }

      const model = editor.getModel();
      const full = model.getValue();

      if(!findUI.ignoreWhitespace) {
        const matches = model.findMatches(qRaw, true, false, false, null, true);
        findUI.matchCount = matches.length;
        return matches;
      }

      const compactFind = normalizeFind(qRaw);
      if(!compactFind) { findUI.matchCount = 0; return []; }

      const { compact: compactFull, mapNormToOrig } = buildCompacted(full);

      const ranges = [];
      let idx = 0;
      while(true) {
        const p = compactFull.indexOf(compactFind, idx);
        if (p === -1) break;

        const startOrig = mapNormToOrig[p];
        const endOrig = mapNormToOrig[p + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

        ranges.push({ range });
        idx = p + Math.max(1, compactFind.length);
      }

      findUI.matchCount = ranges.length;
      return ranges;
    };

    const recomputeMatchCount = () => { getMatches(); };

    const selectMatch = (match) => {
      if(!editor || !match?.range) return;
      editor.setSelection(match.range);
      editor.revealRangeInCenter(match.range);
      editor.focus();
    };

    const openFindReplace = (mode='find') => {
      findUI.open = true;
      findUI.mode = mode;

      recomputeMatchCount();
      setTimeout(() => {
        if (mode === 'replace') (replaceInputEl.value || findInputEl.value)?.focus?.();
        else (findInputEl.value || replaceInputEl.value)?.focus?.();
      }, 0);
    };

    const closeFindReplace = () => {
      findUI.open = false;
      editor?.focus?.();
      stopDragFindUI();
    };

    const findNext = () => {
      if(!editor) return;
      lastFindDirection = 1;
      const matches = getMatches();
      if(!matches.length) return;

      const model = editor.getModel();
      const sel = editor.getSelection();
      const curOffset = sel ? model.getOffsetAt(sel.getStartPosition()) : 0;

      let next = null;
      for (const m of matches) {
        const off = model.getOffsetAt(m.range.getStartPosition());
        if (off > curOffset) { next = m; break; }
      }
      if(!next) next = matches[0];
      selectMatch(next);
    };

    const findPrev = () => {
      if(!editor) return;
      lastFindDirection = -1;
      const matches = getMatches();
      if(!matches.length) return;

      const model = editor.getModel();
      const sel = editor.getSelection();
      const curOffset = sel ? model.getOffsetAt(sel.getStartPosition()) : 0;

      let prev = null;
      for (let i = matches.length - 1; i >= 0; i--) {
        const off = model.getOffsetAt(matches[i].range.getStartPosition());
        if (off < curOffset) { prev = matches[i]; break; }
      }
      if(!prev) prev = matches[matches.length - 1];
      selectMatch(prev);
    };

    const replaceOne = () => {
      if(!editor) return;
      const qRaw = findUI.find || '';
      if(!qRaw) return;

      (lastFindDirection === -1 ? findPrev : findNext)();
      const model = editor.getModel();
      const sel = editor.getSelection();
      if(!sel || sel.isEmpty()) return;

      const selectedText = model.getValueInRange(sel);

      if(!findUI.ignoreWhitespace) {
        if(selectedText !== qRaw) return;
        editor.executeEdits('findui-replace-one', [{ range: sel, text: findUI.replace }]);
        editor.pushUndoStop();
        findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
        recomputeMatchCount();
        pushToast('ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', '1ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚', 'fa-circle-check text-emerald-300', 1800);
        return;
      }

      if (normalizeFind(selectedText) !== normalizeFind(qRaw)) return;

      editor.executeEdits('findui-replace-one', [{ range: sel, text: findUI.replace }]);
      editor.pushUndoStop();
      findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
      recomputeMatchCount();
      pushToast('ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', '1ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚ï¼ˆç©ºç™½ç„¡è¦–ï¼‰', 'fa-circle-check text-emerald-300', 2000);
    };

    const replaceAll = () => {
      if(!editor) return;
      const qRaw = findUI.find || '';
      if(!qRaw) return;

      const model = editor.getModel();
      const full = model.getValue();
      const replaceText = findUI.replace;

      if(!findUI.ignoreWhitespace) {
        const matches = model.findMatches(qRaw, true, false, false, null, true);
        findUI.matchCount = matches.length;
        if(!matches.length) return;

        const edits = matches
          .slice()
          .sort((a,b) => model.getOffsetAt(b.range.getStartPosition()) - model.getOffsetAt(a.range.getStartPosition()))
          .map(m => ({ range: m.range, text: replaceText }));

        editor.pushUndoStop();
        editor.executeEdits('findui-replace-all', edits);
        editor.pushUndoStop();
        findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
        recomputeMatchCount();
        pushToast('å…¨ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', `${edits.length}ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚`, 'fa-circle-check text-emerald-300', 2200);
        return;
      }

      const compactFind = normalizeFind(qRaw);
      if(!compactFind) return;

      const { compact: compactFull, mapNormToOrig } = buildCompacted(full);

      const found = [];
      let idx = 0;
      while(true) {
        const p = compactFull.indexOf(compactFind, idx);
        if (p === -1) break;

        const startOrig = mapNormToOrig[p];
        const endOrig = mapNormToOrig[p + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);
        found.push(range);

        idx = p + Math.max(1, compactFind.length);
      }

      findUI.matchCount = found.length;
      if (!found.length) return;

      const edits = found
        .slice()
        .sort((a,b) => model.getOffsetAt(b.getStartPosition()) - model.getOffsetAt(a.getStartPosition()))
        .map(r => ({ range: r, text: replaceText }));

      editor.pushUndoStop();
      editor.executeEdits('findui-replace-all', edits);
      editor.pushUndoStop();
      findUI.find = ''; findUI.replace = ''; // æˆåŠŸæ™‚ã«ã‚¯ãƒªã‚¢
      recomputeMatchCount();
      pushToast('å…¨ç½®æ›ãŒå®Œäº†ã—ã¾ã—ãŸ', `${edits.length}ä»¶ç½®æ›ã—ã¾ã—ãŸã€‚ï¼ˆç©ºç™½ç„¡è¦–ï¼‰`, 'fa-circle-check text-emerald-300', 2400);
    };

    // --- DRAG FIND UI ---
    const startDragFindUI = (e) => {
      dragActive = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      dragBaseX = findUI.x || 0;
      dragBaseY = findUI.y || 0;

      window.addEventListener('mousemove', onDragFindUI);
      window.addEventListener('mouseup', stopDragFindUI, { once: true });
    };

    const onDragFindUI = (e) => {
      if (!dragActive) return;
      const dx = e.clientX - dragStartX;
      const dy = e.clientY - dragStartY;

      const pane = document.getElementById('editor-pane');
      const rect = pane ? pane.getBoundingClientRect() : { left:0, top:0, width: window.innerWidth, height: window.innerHeight };

      const maxX = Math.max(8, rect.width - 60);
      const maxY = Math.max(8, rect.height - 60);

      let nx = dragBaseX + dx;
      let ny = dragBaseY + dy;

      nx = Math.min(maxX, Math.max(8, nx));
      ny = Math.min(maxY, Math.max(8, ny));

      findUI.x = nx;
      findUI.y = ny;
    };

    const stopDragFindUI = () => {
      dragActive = false;
      window.removeEventListener('mousemove', onDragFindUI);
    };

    // --- PROJECT & FILE OPS ---
    const setProject = async (handle, name) => {
      projectHandle.value = handle;
      projectDisplayName.value = name;
      appMode.value = 'project';
      menus.file = false;
    };

    const ensureDirPermission = async (dir) => {
      try{
        if (!dir) return false;
        if (!dir.queryPermission) return true;
        let p = await dir.queryPermission({ mode: 'readwrite' });
        if (p !== 'granted') p = await dir.requestPermission({ mode: 'readwrite' });
        return p === 'granted';
      } catch {
        return true;
      }
    };

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼ˆå±¥æ­´ãŒå‡ºãªã„åŸå› å¯¾ç­–ï¼‰:
    // - ã“ã‚Œã¾ã§ã€Œå„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ queryPermission/requestPermissionã€ã—ã¦å¤±æ•—â†’ã‚¹ã‚­ãƒƒãƒ—ã«ãªã‚ŠãŒã¡ã€‚
    // - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™ã ã‘ç¢ºä¿ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã®ã¾ã¾èª­ã¿ã«è¡Œãï¼ˆEdgeã§å®‰å®šï¼‰ã€‚
    // - èª­ã‚ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ã€Œæœ€ä½é™ã®ã‚¨ãƒ³ãƒˆãƒªã€ã‚’ä½œã£ã¦è¡¨ç¤ºã¯ç¶™ç¶šã™ã‚‹ã€‚
    const refreshLibrary = async () => {
      if(!projectHandle.value) return;

      libraryScanStatus.value = 'scanning...';
      libraryFiles.value = [];

      const ok = await ensureDirPermission(projectHandle.value);
      if (!ok) {
        libraryScanStatus.value = 'permission denied';
        pushToast('å±¥æ­´èª­è¾¼å¤±æ•—', 'ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„ã€‚', 'fa-triangle-exclamation text-amber-300', 3400);
        return;
      }

      const files = [];
      let scanned = 0;
      let readable = 0;
      let failed = 0;

      const walk = async (dirHandle, relPath, depth) => {
        if (depth > 10) return; // å®‰å…¨
        for await (const entry of dirHandle.values()) {
          if(entry.kind === 'directory') {
            await walk(entry, relPath + entry.name + '/', depth + 1);
            continue;
          }
          if(entry.kind !== 'file') continue;
          const low = entry.name.toLowerCase();
          if(!(low.endsWith('.html') || low.endsWith('.htm'))) continue;

          scanned++;
          try {
            const file = await entry.getFile();
            const text = await file.text();
            const meta = extractMeta(text);
            const title = meta.title || extractTitleFromHtml(text) || entry.name;
            const savedAt = normalizeTs(meta.savedAt) || new Date(file.lastModified);
            const savedAtStr = formatLocal(savedAt);
            const groupKey = stableGroupKeyFromFile(text, meta, entry.name);

            readable++;

            files.push({
              name: relPath + entry.name,
              handle: entry,
              content: text,
              meta,
              displayTitle: title,
              savedAt,
              savedAtStr,
              groupKey,
              relPath
            });
          } catch(e) {
            failed++;
            // èª­ã‚ãªã„å ´åˆã‚‚è¡¨ç¤ºã ã‘ã¯å‡ºã™ï¼ˆå±¥æ­´ã‚¼ãƒ­ã«è¦‹ãˆã‚‹ã®ã‚’é˜²ãï¼‰
            const text = '';
            const meta = {};
            const title = entry.name;
            const savedAt = new Date(0);
            const savedAtStr = '(read error)';
            const groupKey = stableGroupKeyFromFile(entry.name, meta, entry.name);

            files.push({
              name: relPath + entry.name,
              handle: entry,
              content: text,
              meta,
              displayTitle: title,
              savedAt,
              savedAtStr,
              groupKey,
              relPath,
              readError: true
            });
          }
        }
      };

      try {
        await walk(projectHandle.value, '', 0);

        files.sort((a,b) => (b.savedAt?.getTime?.()||0) - (a.savedAt?.getTime?.()||0));
        libraryFiles.value = files;

        libraryScanStatus.value = `done (scanned:${scanned}, read:${readable}, fail:${failed})`;

        if (files.length === 0) {
          pushToast('å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'é¸æŠãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« .html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚‚æ¤œç´¢æ¸ˆã¿ï¼‰ã€‚', 'fa-circle-info text-sky-300', 2800);
        } else {
          pushToast('å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', `${files.length}ä»¶ / ${libraryScanStatus.value}`, 'fa-circle-check text-emerald-300', 2000);
        }
      } catch(e) {
        libraryScanStatus.value = 'error';
        console.error(e);
        pushToast('å±¥æ­´èª­è¾¼ã‚¨ãƒ©ãƒ¼', e?.message || String(e), 'fa-triangle-exclamation text-rose-300', 3600);
      }
    };

    const debugRescanHard = async () => {
      // è¿½åŠ ã®ã€Œè¦‹ãˆã‚‹åŒ–ã€ç”¨ï¼ˆæŒ™å‹•ã¯åŒã˜ã€ãƒˆãƒ¼ã‚¹ãƒˆã‚’å¼·ã‚ã«ï¼‰
      await refreshLibrary();
      if (libraryFiles.value.length) {
        pushToast('ãƒ‡ãƒãƒƒã‚°', `å…ˆé ­: ${libraryFiles.value[0].name}`, 'fa-bug text-lime-300', 2400);
      }
    };

    const setProjectRoot = async () => {
      try {
        const handle = await window.showDirectoryPicker({ id: 'localforge_root', mode: 'readwrite' });
        projectRootHandle.value = handle;
        await saveRootHandle(handle);
        pushToast('è¨­å®šå®Œäº†', `è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’ã€Œ${handle.name}ã€ã«è¨­å®šãƒ»ä¿å­˜ã—ã¾ã—ãŸã€‚`, 'fa-check text-green-300');
      } catch(e) { /* cancel */ }
    };

    const createNewProject = async () => {
      try {
        // è¨­å®šæ¸ˆã¿ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼ˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        let parentHandle = projectRootHandle.value;
        if (!parentHandle) {
          parentHandle = await window.showDirectoryPicker({ id: 'localforge_root', mode: 'readwrite' });
        } else {
          // æ¨©é™ç¢ºèªã®ã¿è¡Œã†ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯å‡ºãªã„ã€ã¾ãŸã¯æ¨©é™è¨±å¯ã®ã¿ï¼‰
          await ensureDirPermission(parentHandle);
        }

        const name = prompt("æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "NewApp");
        if(!name) return;

        const newDirHandle = await parentHandle.getDirectoryHandle(name, { create: true });
        await setProject(newDirHandle, name);

        const fileHandle = await newDirHandle.getFileHandle('index_v1.html', { create: true });
        const writable = await fileHandle.createWritable();
        
        // æ–°è¦æ™‚ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã‚ãšã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã™ã‚‹
        const seed = "";

        const nowIso = new Date().toISOString();
        const seedMeta = {
          schema: 2,
          appId: genId(),
          createdAt: nowIso,
          savedAt: nowIso,
          title: 'New App',
          aiInstruction: '',
          comment: 'initial',
          runId: ''
        };
        
        const initialContent = injectMeta(seed, seedMeta);
        await writable.write(initialContent);
        await writable.close();

        // ä½œæˆã—ãŸç©ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«å³æ™‚ãƒ­ãƒ¼ãƒ‰
        editor.setValue(initialContent);
        currentFileName.value = 'index_v1.html';
        syncIdentityFromCode(initialContent);
        runEmulator();

        await refreshLibrary();
        pushToast('ä½œæˆå®Œäº†', `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚`, 'fa-check text-green-300', 2000);
      } catch(e) {
        console.error(e);
        if(e.name !== 'AbortError') alert("ä½œæˆã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    };

    const openProjectFolder = async () => {
      try {
        // è¨­å®šæ¸ˆã¿ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ãã“ã‚’èµ·ç‚¹ã«é–‹ã
        const opts = { id: 'localforge_root', mode: 'readwrite' };
        if (projectRootHandle.value) opts.startIn = projectRootHandle.value;

        const handle = await window.showDirectoryPicker(opts);
        await setProject(handle, handle.name);

        isSidebarOpen.value = true;
        historyMode.value = 'group';

        await refreshLibrary();
      } catch(e) { if(e.name !== 'AbortError') alert(e.message); }
    };

    const openSingleFile = async () => {
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'HTML Files', accept: {'text/html': ['.html', '.htm']} }]
        });
        const file = await handle.getFile();
        const text = await file.text();

        editor.setValue(text);
        currentFileHandle.value = handle;
        currentFileName.value = file.name;
        projectDisplayName.value = file.name + " (å˜ç™º)";
        appMode.value = 'single';
        menus.file = false;

        syncIdentityFromCode(text);
        runEmulator();
      } catch(e) { if(e.name !== 'AbortError') alert(e.message); }
    };

const createNewSingleApp = async () => {
  // ç›®çš„ï¼šå˜ç™ºæ–°è¦ï¼ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Œå…¨ãƒ–ãƒ©ãƒ³ã‚¯ï¼ˆã‚³ãƒ”ãƒšå³é–‹å§‹ï¼‰
  menus.file = false;

  appMode.value = 'single';
  projectHandle.value = null;
  currentFileHandle.value = null;
  currentFileName.value = '';
  projectDisplayName.value = 'æœªé¸æŠ (å˜ç™º)';

  // â˜…ã“ã“ãŒæœ¬é¡Œï¼šãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å…¥ã‚Œãšç©ºã«ã™ã‚‹
  editor.setValue('');

  // identity / meta ã‚’ç©ºã‚³ãƒ¼ãƒ‰ã¨ã—ã¦åŒæœŸ
  syncIdentityFromCode('');
  aiInstruction.value = '';
  saveComment.value = '';

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€Œç©ºã‚³ãƒ¼ãƒ‰ã€è¡¨ç¤ºã«ã™ã‚‹ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã¯ç©ºã®ã¾ã¾ï¼‰
  runEmulator();
  pushToast('å˜ç™ºæ–°è¦', 'ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã—ã¾ã—ãŸã€‚ã“ã“ã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚', 'fa-circle-check text-emerald-300', 2200);
};


    const loadFile = async (handle) => {
      const file = await handle.getFile();
      const text = await file.text();

      editor.setValue(text);
      currentFileName.value = handle.name;

      syncIdentityFromCode(text);

      const meta = extractMeta(text);
      // èª­ã¿è¾¼ã¿æ™‚ã«ã€ŒAIæŒ‡ç¤ºã€ã‚ˆã‚Šã‚‚ã€Œä¿å­˜æ™‚ã®ãƒ¡ãƒ¢(comment)ã€ã‚’å„ªå…ˆã—ã¦è¡¨ç¤ºã™ã‚‹
      const lastNote = meta.comment || meta.aiInstruction || '';
      aiInstruction.value = lastNote;
      saveComment.value = lastNote;

      runEmulator();
    };

    const runExternal = async (fileEntry) => {
      // fileEntry can be from grouped/flat, should include handle
      try{
        const file = await fileEntry.handle.getFile();
        const text = await file.text();
        const runId = genId();
        const shim = buildPreviewShim(runId);
        const safeCode = injectShimIntoHtml(text, shim);
        const blob = new Blob([safeCode], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        // æ–°è¦ã‚¿ãƒ–ã§é–‹ã (_blank)
        window.open(url, '_blank', 'noopener,noreferrer');
      } catch(e){
        alert("åˆ¥çª“å®Ÿè¡Œã«å¤±æ•—: " + (e.message || String(e)));
      }
    };

    // --- COMPUTED: GROUPED HISTORY ---
    const libraryFilesFlat = computed(() => libraryFiles.value);

    const groupedApps = computed(() => {
      const map = new Map();
      for (const f of libraryFiles.value) {
        const key = f.groupKey || 'unknown';
        if (!map.has(key)) map.set(key, { groupKey: key, versions: [], open: false });
        map.get(key).versions.push(f);
      }

      const arr = Array.from(map.values()).map(grp => {
        const versions = grp.versions.slice().sort((a,b)=> (b.savedAt?.getTime?.()||0) - (a.savedAt?.getTime?.()||0));
        const latest = versions[0];
        const latestTitle = latest?.displayTitle || '';
        const latestAiInstruction = (latest?.meta?.aiInstruction || latest?.meta?.comment || '').trim();

        return {
          groupKey: grp.groupKey,
          open: grp.open,
          versions,
          latestTitle,
          latestAiInstruction
        };
      });

      arr.sort((a,b)=> {
        const at = a.versions[0]?.savedAt?.getTime?.()||0;
        const bt = b.versions[0]?.savedAt?.getTime?.()||0;
        return bt - at;
      });

      return arr;
    });

// --- SAVE LOGIC ---
    const openSaveModal = () => {
      if(aiInstruction.value && !saveComment.value) saveComment.value = aiInstruction.value;

      const now = new Date();
      const ts =
        now.getFullYear() +
        (now.getMonth()+1).toString().padStart(2,'0') +
        now.getDate().toString().padStart(2,'0') + '_' +
        now.getHours().toString().padStart(2,'0') +
        now.getMinutes().toString().padStart(2,'0');

      let base = (currentAppTitle.value || 'App').replace(/[\\\/:*?"<>|]/g,'_').slice(0,40);
      if(!base) base = 'App';

      saveFilename.value = `${base}_${ts}.html`;

      // å˜ç™ºã‚¢ãƒ—ãƒªã®å ´åˆã¯ç·¨é›†ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€OSæ¨™æº–ã®ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¸ç›´è¡Œ
      if (appMode.value === 'single') {
        performSave();
        return;
      }

      modals.save = true;
    };

    const performSave = async () => {
      try {
        let filename = saveFilename.value || 'App.html';
        if(!filename.toLowerCase().endsWith('.html')) filename += '.html';

        const rawCode = editor.getValue();
        const metaExisting = extractMeta(rawCode);

        const nowIso = new Date().toISOString();

        // Ensure identifiers
        const title = metaExisting.title || extractTitleFromHtml(rawCode) || currentAppTitle.value || 'App';
        const appId = (metaExisting.appId || (metaExisting.createdAt ? null : null)) || metaExisting.appId || null;

        // We keep appId stable if present; otherwise create (and set createdAt)
        const finalMeta = { ...metaExisting };
        if (!finalMeta.appId) finalMeta.appId = genId();
        if (!finalMeta.createdAt) finalMeta.createdAt = nowIso;

        finalMeta.schema = 2;
        finalMeta.title = title;
        finalMeta.savedAt = nowIso;
        finalMeta.aiInstruction = (aiInstruction.value || '').trim();
        finalMeta.comment = (saveComment.value || '').trim();
        finalMeta.sourceMode = appMode.value;
        finalMeta.runId = lastRunId || '';

        const codeWithMeta = injectMeta(rawCode, finalMeta);

        if (appMode.value === 'project') {
          if(!projectHandle.value) throw new Error("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæœªé¸æŠã§ã™ã€‚");

          const newHandle = await projectHandle.value.getFileHandle(filename, { create: true });
          const writable = await newHandle.createWritable();
          await writable.write(codeWithMeta);
          await writable.close();

          currentFileName.value = filename;
          syncIdentityFromCode(codeWithMeta);

          await refreshLibrary();
          modals.save = false;
          saveComment.value = '';
          editor.setValue(codeWithMeta);
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ï¼‰: " + filename);
          return;
        }

        if ('showSaveFilePicker' in window) {
          const picker = await window.showSaveFilePicker({
            suggestedName: filename,
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }]
          });
          const writable = await picker.createWritable();
          await writable.write(codeWithMeta);
          await writable.close();

          currentFileHandle.value = picker;
          currentFileName.value = filename;
          projectDisplayName.value = filename + " (å˜ç™º)";
          syncIdentityFromCode(codeWithMeta);

          modals.save = false;
          saveComment.value = '';
          editor.setValue(codeWithMeta);
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆæŒ‡å®šå…ˆï¼‰: " + filename);
          return;
        }

        // Fallback download
        const blob = new Blob([codeWithMeta], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();

        currentFileName.value = filename;
        projectDisplayName.value = filename + " (å˜ç™º)";
        syncIdentityFromCode(codeWithMeta);

        modals.save = false;
        saveComment.value = '';
        editor.setValue(codeWithMeta);
        alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ä¿å­˜ã—ã¾ã—ãŸ: " + filename);

      } catch(e) {
        if(e.name !== 'AbortError') alert("ä¿å­˜å¤±æ•—: " + (e.message || String(e)));
      }
    };

    // --- AI PROMPT ---
    const openAiModal = () => {
      modals.ai = true;
      aiMessage.value = '';
      try {
        const meta = extractMeta(editor.getValue());
        if (meta.aiInstruction) aiInstruction.value = meta.aiInstruction;
      } catch {}
    };

    const generateAndCopyPrompt = () => {
      const inst = (aiInstruction.value || '').trim();
      if(inst && !saveComment.value) saveComment.value = inst;

      let prompt = "";
      if(aiTab.value === 'full') {
        prompt =
`ã‚ãªãŸã¯ãƒ—ãƒ­ã®Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€å˜ä¸€ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ä½œã™ã‚‹ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

[æŒ‡ç¤º]
${inst}

[åˆ¶ç´„]
- HTML, CSS, JSã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã€‚
- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯CDN(Tailwind, Vue, Reactç­‰)ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã„ã€‚
- æˆæœç‰©ã¯å¿…ãšå®Œå…¨ãªHTMLã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›ã—ã€è§£èª¬ã¯æœ€å°é™ã«ã™ã‚‹ã“ã¨ã€‚`;
      } else {
        if (aiIncludeFullCode.value) {
          const fullCode = editor ? editor.getValue() : '';
          prompt =
`ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

[å¯¾è±¡ã‚³ãƒ¼ãƒ‰(å…¨ä½“)]
\`\`\`html
${fullCode}
\`\`\`

[ä¿®æ­£æŒ‡ç¤º]
${inst}

[é‡è¦ï¼šå‡ºåŠ›å½¢å¼]
ç§ãŒæ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€Œå¤‰æ›´å‰ã®ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œå¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã€ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

â˜…æ¤œç´¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ (Search)
\`\`\`
(ã“ã“ã«ç½®æ›å¯¾è±¡ã¨ãªã‚‹ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ•°è¡Œï½ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãã®ã¾ã¾æ›¸ã)
\`\`\`

â˜…ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ (Replace)
\`\`\`
(ã“ã“ã«æ–°ã—ãç½®ãæ›ãˆã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã)
\`\`\`

è§£èª¬ã¯ä¸è¦ã§ã™ã€‚`;
        } else {
          prompt =
`ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ä¿®æ­£ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ä¿®æ­£æŒ‡ç¤ºã«å¾“ã£ã¦ã€æ—¢å­˜ã‚¢ãƒ—ãƒªã®ä¸€éƒ¨ä¿®æ­£ãƒ‘ãƒƒãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
ï¼ˆâ€»ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã§ã¯æ·»ä»˜ã—ã¾ã›ã‚“ã€‚ï¼‰

[ä¿®æ­£æŒ‡ç¤º]
${inst}

[é‡è¦ï¼šå‡ºåŠ›å½¢å¼]
ç§ãŒæ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€Œå¤‰æ›´å‰ã®ã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œå¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã€ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚

â˜…æ¤œç´¢ã™ã‚‹ã‚³ãƒ¼ãƒ‰ (Search)
\`\`\`
(ã“ã“ã«ç½®æ›å¯¾è±¡ã¨ãªã‚‹ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ•°è¡Œï½ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãã®ã¾ã¾æ›¸ã)
\`\`\`

â˜…ç½®æ›å¾Œã®ã‚³ãƒ¼ãƒ‰ (Replace)
\`\`\`
(ã“ã“ã«æ–°ã—ãç½®ãæ›ãˆã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã)
\`\`\`

è§£èª¬ã¯ä¸è¦ã§ã™ã€‚`;
        }
      }

      navigator.clipboard.writeText(prompt).then(() => {
        aiMessage.value = "ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚";
        setTimeout(() => aiMessage.value = '', 3000);
      });
    };

    // --- PATCH ---
    const openPatchModal = () => {
      patchFindInput.value = '';
      patchReplaceInput.value = '';
      patchIgnoreWhitespace.value = true;
      modals.patch = true;
    };

    const applyPatch = () => {
      try {
        const findTextRaw = patchFindInput.value;
        const replaceText = patchReplaceInput.value;

        if (!findTextRaw || !replaceText) {
          alert("æ¤œç´¢ã‚³ãƒ¼ãƒ‰ã¨ç½®æ›ã‚³ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const model = editor.getModel();
        const full = model.getValue();

        if (!patchIgnoreWhitespace.value) {
          const idx = full.indexOf(findTextRaw);
          if (idx === -1) { alert("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚"); return; }
          const idx2 = full.indexOf(findTextRaw, idx + 1);
          if (idx2 !== -1) { if(!confirm("ä¸€è‡´å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ã€‚å…ˆé ­ã®ä¸€è‡´ã‚’ç½®æ›ã—ã¾ã™ãŒã‚ˆã„ã§ã™ã‹ï¼Ÿ")) return; }

          const startPos = model.getPositionAt(idx);
          const endPos = model.getPositionAt(idx + findTextRaw.length);
          const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

          editor.executeEdits("manual-patch", [{ range, text: replaceText }]);
          modals.patch = false;
          runEmulator();
          alert("ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã¾ã—ãŸï¼ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰");
          return;
        }

        const { compact: compactFull, mapNormToOrig } = buildCompacted(full);
        const compactFind = normalizeFind(findTextRaw);
        if (!compactFind) { alert("æ¤œç´¢ã‚³ãƒ¼ãƒ‰ãŒç©ºç™½ã®ã¿ã§ã™ã€‚"); return; }

        const normIdx = compactFull.indexOf(compactFind);
        if (normIdx === -1) { alert("ä¸€è‡´ã™ã‚‹ç®‡æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç©ºç™½ç„¡è¦–ï¼‰ã€‚"); return; }
        const normIdx2 = compactFull.indexOf(compactFind, normIdx + 1);
        if (normIdx2 !== -1) { if(!confirm("ä¸€è‡´å€™è£œãŒè¤‡æ•°ã‚ã‚Šã¾ã™ã€‚å…ˆé ­ã®ä¸€è‡´ã‚’ç½®æ›ã—ã¾ã™ãŒã‚ˆã„ã§ã™ã‹ï¼Ÿ")) return; }

        const startOrig = mapNormToOrig[normIdx];
        const endOrig = mapNormToOrig[normIdx + compactFind.length - 1] + 1;

        const startPos = model.getPositionAt(startOrig);
        const endPos = model.getPositionAt(endOrig);
        const range = new monaco.Range(startPos.lineNumber, startPos.column, endPos.lineNumber, endPos.column);

        editor.executeEdits("manual-patch", [{ range, text: replaceText }]);
        modals.patch = false;
        runEmulator();
        alert("ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã—ã¾ã—ãŸï¼ï¼ˆç©ºç™½ãƒ»æ”¹è¡Œã¯ç„¡è¦–ï¼‰");
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + (e.message || String(e)));
      }
    };

    // --- PREVIEW SHIM (console + idb dump) ---
    const buildPreviewShim = (runId) => {
      return `
<script>
(() => {
  const RUN_ID = ${JSON.stringify(runId)};
  const send = (obj) => { try { window.parent?.postMessage(obj, "*"); } catch(e){} };

  const _log = console.log.bind(console);
  const _err = console.error.bind(console);
  const _warn = console.warn.bind(console);
  console.log = (...a)=>{ _log(...a); send({ type: "console", l: "info", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };
  console.error = (...a)=>{ _err(...a); send({ type: "console", l: "error", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };
  console.warn = (...a)=>{ _warn(...a); send({ type: "console", l: "warn", m: a.map(x=>{try{return typeof x==="string"?x:JSON.stringify(x)}catch(e){return String(x)}}).join(" ") }); };

  async function dumpIdb() {
    const items = [];
    const databasesFn = indexedDB.databases ? indexedDB.databases.bind(indexedDB) : null;
    if (!databasesFn) {
      return { items: [], warning: "indexedDB.databases() ãŒæœªå¯¾å¿œã®ãŸã‚ã€DBä¸€è¦§ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚" };
    }
    const dbs = await databasesFn();
    for (const d of (dbs||[])) {
      const name = d.name;
      const version = d.version || 0;
      if (!name) continue;

      const info = { name, version, stores: [], open: true };

      await new Promise((resolve) => {
        const req = indexedDB.open(name);
        req.onerror = () => resolve();
        req.onsuccess = () => {
          const db = req.result;
          try {
            info.version = db.version || info.version;
            const storeNames = Array.from(db.objectStoreNames || []);
            const tx = db.transaction(storeNames, "readonly");
            const storeInfos = [];

            let pending = storeNames.length;
            if (pending === 0) { try{db.close()}catch(e){}; info.stores = []; resolve(); return; }

            storeNames.forEach(sn => {
              try {
                const st = tx.objectStore(sn);
                const stInfo = {
                  name: sn,
                  keyPath: st.keyPath ?? null,
                  autoIncrement: !!st.autoIncrement,
                  count: 0,
                  sampleKeys: []
                };

                const cReq = st.count();
                cReq.onsuccess = () => { stInfo.count = cReq.result || 0; maybeDone(); };
                cReq.onerror = () => { maybeDone(); };

                const keys = [];
                const kReq = st.openKeyCursor();
                kReq.onsuccess = (ev) => {
                  const cur = ev.target.result;
                  if (cur && keys.length < 20) { keys.push(cur.key); cur.continue(); }
                  else { stInfo.sampleKeys = keys; }
                };
                kReq.onerror = () => {};

                storeInfos.push(stInfo);
              } catch(e) {
                pending = Math.max(0, pending - 1);
              }
            });

            function maybeDone(){
              pending = Math.max(0, pending - 1);
              if (pending === 0) {
                info.stores = storeInfos.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
                try { db.close(); } catch(e){}
                resolve();
              }
            }
          } catch(e) {
            try { db.close(); } catch(_){}
            resolve();
          }
        };
      });

      items.push(info);
    }

    items.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
    return { items };
  }

  window.addEventListener("message", async (ev) => {
    const data = ev.data || {};
    if (data.type === "idb_dump_request" && data.runId === RUN_ID) {
      try {
        const res = await dumpIdb();
        send({ type: "idb_dump_result", runId: RUN_ID, items: res.items || [], error: res.warning || "" });
      } catch(e) {
        send({ type: "idb_dump_result", runId: RUN_ID, items: [], error: String(e && e.message ? e.message : e) });
      }
    }
  });
})();
<\/script>`;
    };

    const injectShimIntoHtml = (code, shim) => {
      if (code.match(/<head[^>]*>/i)) return code.replace(/<head[^>]*>/i, (m)=> m + shim);
      return shim + code;
    };

    // --- PREVIEW (iframe) ---
const runEmulator = () => {
  if(!editor) return;

  const frame = document.getElementById('emulator-frame');
  const code = editor.getValue() || '';
  syncIdentityFromCode(code);

  lastRunId = genId();
  const shim = buildPreviewShim(lastRunId);

  // â˜…ç©ºã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼šã‚¨ãƒ‡ã‚£ã‚¿ã¯ç©ºã®ã¾ã¾ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã ã‘èª¬æ˜è¡¨ç¤º
  if (code.trim() === '') {
    const emptyHtml =
`<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>(empty)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; display:grid; place-items:center; height:100vh; background:#f3f4f6; color:#111827;}
  .card{background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:18px 16px; width:min(92vw,520px); box-shadow:0 10px 24px rgba(0,0,0,.08);}
  h1{font-size:16px; margin:0 0 6px;}
  p{font-size:12px; margin:0; color:#6b7280; line-height:1.6;}
  code{background:#f9fafb; border:1px solid #e5e7eb; padding:2px 6px; border-radius:8px;}
</style>
</head>
<body>
  <div class="card">
    <h1>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šã‚³ãƒ¼ãƒ‰ãŒç©ºã§ã™</h1>
    <p>ã‚¨ãƒ‡ã‚£ã‚¿ã¯ <b>å®Œå…¨ã«ç©º</b> ã®çŠ¶æ…‹ã§ã™ã€‚<br>ãã®ã¾ã¾HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ <code>å®Ÿè¡Œ</code> ã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</body>
</html>`;
    const safe = injectShimIntoHtml(emptyHtml, shim);
    frame.srcdoc = safe;
    return;
  }

  const safeCode = injectShimIntoHtml(code, shim);
  frame.srcdoc = safeCode;
};


    const stopEmulator = () => {
      const frame = document.getElementById('emulator-frame');
      frame.src = 'about:blank';
      consoleLogs.value.push({type:'info', message:'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚'});

      if (fullWin && !fullWin.closed) {
        try { fullWin.close(); } catch {}
      }
      fullWin = null;
    };

    // --- FULLSCREEN (separate window) ---
    const openFullWindow = () => {
      if(!editor) return;

      const code = editor.getValue();
      syncIdentityFromCode(code);

      const runId = genId();
      const shim = buildPreviewShim(runId);
      const safeCode = injectShimIntoHtml(code, shim);

      const blob = new Blob([safeCode], { type: 'text/html' });
      const url = URL.createObjectURL(blob);

      // å¸¸ã«æ–°è¦ã‚¿ãƒ–ã§é–‹ã (_blank)
      // â€»ä¸€éƒ¨ç’°å¢ƒã§é–‹ã„ã¦ã„ã‚‹ã®ã«winãŒnullåˆ¤å®šã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆåˆ¤å®šã¯å‰Šé™¤
      window.open(url, '_blank', 'noopener,noreferrer');
    };

    // --- DB MODAL ---
    const openDbModal = async () => {
      modals.db = true;
      await refreshDbDump();
    };

    const refreshDbDump = async () => {
      dbDump.loading = true;
      dbDump.error = '';
      dbDump.items = [];

      const frame = document.getElementById('emulator-frame');
      if (!frame || !frame.contentWindow) {
        dbDump.loading = false;
        dbDump.error = "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œå®Ÿè¡Œã€ã—ã¦ãã ã•ã„ã€‚";
        return;
      }
      if (!lastRunId) {
        dbDump.loading = false;
        dbDump.error = "runId ãŒæœªè¨­å®šã§ã™ã€‚ã„ã£ãŸã‚“ã€Œå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      try {
        frame.contentWindow.postMessage({ type: 'idb_dump_request', runId: lastRunId }, '*');
        setTimeout(() => {
          if (dbDump.loading) {
            dbDump.loading = false;
            dbDump.error = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å´ãŒå¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚";
          }
        }, 4000);
      } catch(e) {
        dbDump.loading = false;
        dbDump.error = "DBå–å¾—ã«å¤±æ•—: " + (e.message || String(e));
      }
    };

    // --- OTHER HELPERS ---
const clearCode = () => {
      if(!confirm("æœ¬å½“ã«ã‚³ãƒ¼ãƒ‰ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;

      // ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Œå…¨ã«ç©ºã«ã™ã‚‹
      editor.setValue('');

      // å†…éƒ¨çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ã‚¿æƒ…å ±ã‚„AIæŒ‡ç¤ºã‚‚ã‚¯ãƒªã‚¢ï¼‰
      syncIdentityFromCode('');
      aiInstruction.value = '';
      saveComment.value = '';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
      runEmulator();
      pushToast('å…¨ã‚¯ãƒªã‚¢', 'ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç©ºã«ã—ã¾ã—ãŸã€‚', 'fa-trash-alt text-red-300', 1500);
    };
    const copyFullCode = async () => {
      try{
        await navigator.clipboard.writeText(editor.getValue());
        pushToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'ãƒ•ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚', 'fa-circle-check text-emerald-300', 1600);
      }catch(e){
        alert("ã‚³ãƒ”ãƒ¼å¤±æ•—: " + (e.message || String(e)));
      }
    };

    const toggleSidebar = () => { isSidebarOpen.value = !isSidebarOpen.value; };

    // --- RESIZE ---
    let resizing = false;
    const startResize = (e) => {
      resizing = true;
      const editorPane = document.getElementById('editor-pane');
      const emulatorPane = document.getElementById('emulator-pane');
      const root = editorPane.parentElement;

      const onMove = (ev) => {
        if(!resizing) return;
        const rect = root.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const w = rect.width;
        const left = Math.max(260, Math.min(w - 260, x));
        editorPane.style.flex = 'none';
        emulatorPane.style.flex = 'none';
        editorPane.style.width = left + 'px';
        emulatorPane.style.width = (w - left - 6) + 'px';
      };
      const onUp = () => {
        resizing = false;
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      };

      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    };

    return {
      // state
      appMode, projectDisplayName, menus, modals, isSidebarOpen,
      aiTab, aiInstruction, aiMessage, aiIncludeFullCode,
      saveComment, saveFilename,
      patchFindInput, patchReplaceInput, patchIgnoreWhitespace,
      findUI, findInputEl, replaceInputEl,
      editorStats, consoleLogs,
      libraryFiles, libraryFilesFlat, groupedApps, historyMode,
      currentAppTitle, currentGroupKey, libraryScanStatus,

      // actions
      toggleSidebar,
      createNewProject, openProjectFolder, openSingleFile, createNewSingleApp,
      refreshLibrary, debugRescanHard,
      loadFile, runExternal,
      runEmulator, stopEmulator, openFullWindow,
      openAiModal, generateAndCopyPrompt,
      openSaveModal, performSave,
      openPatchModal, applyPatch,
      openDbModal, refreshDbDump,
      openFindReplace, closeFindReplace,
      startDragFindUI,
      findNext, findPrev, replaceOne, replaceAll, recomputeMatchCount,
      clearCode, copyFullCode,
      startResize,
      toasts,
      projectRootHandle, setProjectRoot
    };
  }
}).mount('#app');
</script>
</body>
</html>