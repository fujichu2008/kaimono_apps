<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>QR/バーコード リーダー（画像フォールバック対応）</title>
<meta name="theme-color" content="#185adb">
<style>
:root{--bg:#f4f7ff;--card:#fff;--line:#dbe4ff;--text:#0f172a;--muted:#5b6b8a;--accent:#185adb;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff 0%,#f7faff 100%);border-bottom:1px solid var(--line);padding:12px 16px}
h1{margin:0;font-size:18px}
main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--accent);background:#fff;color:var(--accent);padding:8px 12px;border-radius:10px;font-weight:600}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{border-color:var(--line);color:var(--text)}
.btn:disabled{opacity:.5}
.badge{display:inline-block;background:#eef4ff;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
#videoWrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
video{width:100%;height:auto;display:block;background:#000}
#guide{position:absolute;inset:0;border:2px dashed rgba(255,255,255,.6);border-radius:12px;pointer-events:none}
#overlay{position:absolute;inset:0;pointer-events:none}
#status{font-size:14px;color:var(--muted)}
pre{white-space:pre-wrap;word-break:break-all;background:#f8faff;border:1px solid var(--line);padding:10px;border-radius:10px;margin:8px 0}
small{color:var(--muted)}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
footer{padding:16px;text-align:center;color:var(--muted);font-size:12px}
</style>
<!-- フォールバック用ライブラリ（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
</head>
<body>
<header><h1>QR/バーコード リーダー（文字化）</h1></header>
<main>
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn primary">カメラでスキャン開始</button>
      <button id="stopBtn" class="btn ghost" disabled>停止</button>
      <button id="torchBtn" class="btn" disabled>ライト</button>
      <span id="supportBadge" class="badge">環境チェック中…</span>
    </div>
    <div id="videoWrap" style="margin-top:8px;display:none">
      <video id="video" playsinline muted></video>
      <div id="guide"></div>
      <canvas id="overlay"></canvas>
    </div>
    <div id="status" style="margin-top:8px">未開始</div>
    <hr>
    <div class="row">
      <input type="file" id="fileInp" accept="image/*" class="btn">
      <small>→ 画像からも読み取り（フォールバック対応）</small>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <strong>読み取り結果</strong>
      <span id="typeBadge" class="badge" style="display:none"></span>
    </div>
    <pre id="resultText">（ここに読み取った文字が表示されます）</pre>
    <div class="row">
      <button id="copyBtn" class="btn">コピー</button>
      <button id="shareBtn" class="btn">共有</button>
      <small id="timeStamp"></small>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <details>
      <summary>対応形式・ヒント</summary>
      <ul>
        <li>カメラ：端末対応時は BarcodeDetector（QR/EAN/UPC/Code128/Code39/ITF/PDF417/DataMatrix/Aztec 等）</li>
        <li>画像：BarcodeDetector → jsQR（QR）→ ZXing（QR/1D/2D）で自動フォールバック</li>
        <li>ピントや傾きがシビアです。よく写った写真でお試しください</li>
      </ul>
    </details>
  </div>
</main>
<footer>ローカル動作・カメラ映像は送信されません</footer>

<script>
(() => {
  const q = (s)=>document.querySelector(s);
  const $start = q('#startBtn'), $stop=q('#stopBtn'), $torch=q('#torchBtn');
  const $support = q('#supportBadge'), $video=q('#video'), $wrap=q('#videoWrap');
  const $overlay=q('#overlay'), $guide=q('#guide'), $status=q('#status');
  const $file=q('#fileInp'), $res=q('#resultText'), $type=q('#typeBadge'), $ts=q('#timeStamp');
  const $copy=q('#copyBtn'), $share=q('#shareBtn');
  let stream=null, det=null, raf=null, track=null, torchOn=false;

  const supportedFormats = [
    'qr_code','ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','pdf417','data_matrix','aztec'
  ];

  async function initSupport(){
    if('BarcodeDetector' in window){
      try{
        const formats = await BarcodeDetector.getSupportedFormats();
        const ok = formats.some(f=>supportedFormats.includes(f));
        $support.textContent = ok ? 'BarcodeDetector 対応' : '一部のみ対応';
        $support.style.background = '#eaf2ff';
      }catch{
        $support.textContent = '検出APIあり/利用不可（画像はフォールバック使用）';
        $support.style.background = '#fff3cd';
      }
    }else{
      $support.textContent = 'BarcodeDetector 非対応（画像はフォールバック使用）';
      $support.style.background = '#fff3cd';
    }
  }

  function showResult(text, format){
    if(!text) return;
    $res.textContent = text;
    if(format){ $type.textContent = format; $type.style.display='inline-block'; }
    $ts.textContent = new Date().toLocaleString();
  }

  function drawBox(box, label){
    const cv = $overlay, ctx = cv.getContext('2d');
    cv.width = $video.videoWidth; cv.height = $video.videoHeight;
    ctx.clearRect(0,0,cv.width,cv.height);
    if(!box) return;
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(0,200,0,.9)';
    ctx.strokeRect(box.x, box.y, box.width, box.height);
    ctx.font = '16px system-ui';
    ctx.fillStyle = 'rgba(0,0,0,.5)';
    ctx.fillRect(box.x, box.y-24, ctx.measureText(label).width+10, 22);
    ctx.fillStyle = '#fff';
    ctx.fillText(label, box.x+5, box.y-8);
  }

  // ---- カメラ読み取り（BD対応端末のみ） ----
  async function start(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal:'environment' }, width:{ideal:1280}, height:{ideal:720} },
        audio: false
      });
      $video.srcObject = stream; await $video.play();
      $wrap.style.display = ''; $start.disabled = true; $stop.disabled=false;
      $status.textContent = 'スキャン中…';

      track = stream.getVideoTracks()[0];
      // トーチ対応判定
      try{
        const caps = track.getCapabilities?.() || {};
        $torch.disabled = !caps.torch;
      }catch{ $torch.disabled = true; }

      if('BarcodeDetector' in window){
        det = new BarcodeDetector({ formats: supportedFormats });
        loopDetect();
      }else{
        $status.textContent = 'この端末はリアルタイム検出に未対応です（画像読込を使用）';
      }
    }catch(e){
      console.error(e);
      $status.textContent = 'カメラ起動に失敗: ' + e.message;
    }
  }

  async function loopDetect(){
    const cv = document.createElement('canvas');
    const ctx = cv.getContext('2d');
    const step = async () => {
      if(!$video.videoWidth){ raf = requestAnimationFrame(step); return; }
      cv.width = $video.videoWidth; cv.height = $video.videoHeight;
      ctx.drawImage($video, 0, 0, cv.width, cv.height);
      try{
        const bmp = await createImageBitmap(cv);
        const codes = await det.detect(bmp);
        if(codes && codes.length){
          const c = codes[0];
          showResult(c.rawValue, c.format);
          drawBox(c.boundingBox, c.format);
        }else{
          drawBox(null);
        }
      }catch{ /* ignore */ }
      raf = requestAnimationFrame(step);
    };
    raf = requestAnimationFrame(step);
  }

  async function stop(){
    if(raf) cancelAnimationFrame(raf), raf=null;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; }
    $wrap.style.display='none'; $start.disabled=false; $stop.disabled=true; $torch.disabled=true;
    $status.textContent='停止しました';
  }

  async function toggleTorch(){
    try{
      if(!track) return;
      const caps = track.getCapabilities?.() || {};
      if(!caps.torch) return;
      torchOn = !torchOn;
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      $torch.textContent = torchOn ? 'ライト（ON）' : 'ライト';
    }catch(e){ console.warn('Torch error', e); }
  }

  // ---- 画像ファイル読み取り：BD → jsQR → ZXing の順で試行 ----
  $file.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    $status.textContent = '画像を解析中…';
    try{
      const img = await loadImage(URL.createObjectURL(file));
      const {canvas, ctx} = drawScaled(img, 1600);
      // 1) BarcodeDetector があればまず試す（対応端末はこれが最も精度/速度高い）
      const bdText = await detectWithBD(canvas).catch(()=>null);
      if(bdText){ showResult(bdText.text, bdText.format); $status.textContent='画像→BDで読み取り'; return; }

      // 2) jsQR（QR専用）で尝试。回転 0/90/180/270
      const qrText = detectWithJsQR(canvas, ctx);
      if(qrText){ showResult(qrText, 'qr_code(jsQR)'); $status.textContent='画像→jsQRで読み取り'; return; }

      // 3) ZXing（QR/1D/2D対応）で最后の頼み
      const zxText = await detectWithZXing(file).catch(()=>null);
      if(zxText){ showResult(zxText.text, zxText.format); $status.textContent='画像→ZXingで読み取り'; return; }

      $status.textContent = '画像から読めませんでした（ピント/解像度/光量をご確認ください）';
    }catch(err){
      console.error(err);
      $status.textContent = '画像読込に失敗しました: ' + err.message;
    }
  });

  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  function drawScaled(img, maxSide=1600){
    const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
    const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
    const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    return {canvas, ctx};
  }

  async function detectWithBD(canvas){
    if(!('BarcodeDetector' in window)) return null;
    try{
      const det = new BarcodeDetector({ formats: supportedFormats });
      const bmp = await createImageBitmap(canvas);
      const codes = await det.detect(bmp);
      if(codes && codes.length){
        const c = codes[0];
        return { text: c.rawValue, format: c.format };
      }
      return null;
    }catch{ return null; }
  }

  function detectWithJsQR(canvas, ctx){
    if(!window.jsQR) return null;
    const rotations = [0,90,180,270];
    for(const deg of rotations){
      const cv = (deg===0)?canvas:rotateCanvas(canvas, deg);
      const imgData = (deg===0)?ctx.getImageData(0,0,canvas.width,canvas.height)
                               :cv.getContext('2d').getImageData(0,0,cv.width,cv.height);
      const res = jsQR(imgData.data, imgData.width, imgData.height, {inversionAttempts:'attemptBoth'});
      if(res && res.data) return res.data;
    }
    return null;
  }

  function rotateCanvas(srcCanvas, deg){
    const rad = deg*Math.PI/180;
    const s = Math.sin(rad), c = Math.cos(rad);
    const w = srcCanvas.width, h = srcCanvas.height;
    const dst = document.createElement('canvas');
    if(deg===90 || deg===270){ dst.width = h; dst.height = w; } else { dst.width = w; dst.height = h; }
    const ctx = dst.getContext('2d');
    ctx.translate(dst.width/2, dst.height/2);
    ctx.rotate(rad);
    ctx.drawImage(srcCanvas, -w/2, -h/2);
    return dst;
  }

  async function detectWithZXing(file){
    if(!window.ZXing) return null;
    const reader = new ZXing.BrowserMultiFormatReader();
    try{
      // ZXing は File/Blob から直接 decode するユーティリティがないため ImageBitmap 経由にする
      const imgUrl = URL.createObjectURL(file);
      const res = await reader.decodeFromImageUrl(imgUrl);
      URL.revokeObjectURL(imgUrl);
      if(res && res.text){
        // フォーマット名は enum 値を文字列化
        const format = res.getBarcodeFormat ? String(res.getBarcodeFormat()) : 'zxing';
        return { text: res.text, format };
      }
      return null;
    }finally{
      reader.reset();
    }
  }

  $start.addEventListener('click', start);
  $stop.addEventListener('click', stop);
  $torch.addEventListener('click', toggleTorch);
  $copy.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText($res.textContent||''); $status.textContent='コピーしました'; }
    catch(e){ $status.textContent='コピー失敗: ' + e.message; }
  });
  $share.addEventListener('click', async ()=>{
    const text = $res.textContent || '';
    if(navigator.share){ try{ await navigator.share({text}); }catch{} }
    else{
      try{ await navigator.clipboard.writeText(text); $status.textContent='共有未対応：コピーしました'; }catch{}
    }
  });

  initSupport();
  window.addEventListener('pagehide', stop);
})();
</script>
</body>
</html>
