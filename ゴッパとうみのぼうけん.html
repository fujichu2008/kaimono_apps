<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã‚´ãƒƒãƒ‘ã¨ ã†ã¿ã®ã¼ã†ã‘ã‚“ï¼</title>
<meta name="theme-color" content="#0ea5e9" />
<style>
  :root{
    --bg:#e0f7ff; --sea:#b7ecff; --deep:#8bd7ff; --card:#ffffff; --line:#cfe8ff;
    --text:#0f172a; --muted:#5b6b8a; --accent:#0ea5e9; --ok:#16a34a; --warn:#f59e0b;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif; color:var(--text); background:linear-gradient(var(--bg),var(--sea));}
  .app{max-width:720px; margin:0 auto; padding:16px; min-height:100%; display:flex; flex-direction:column; gap:12px}
  h1{margin:0; font-weight:800; letter-spacing:.02em}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(2,6,23,.06)}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .btn{appearance:none; border:0; border-radius:14px; padding:12px 16px; background:var(--accent); color:white; font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(14,165,233,.35)}
  .btn.sec{background:#1e293b}
  .btn.ghost{background:transparent; color:var(--accent); border:2px solid var(--accent)}
  .muted{color:var(--muted)}
  .hidden{display:none !important}

  /* Title */
  .title{display:flex; align-items:center; gap:12px}
  .goppa-logo{font-size:44px; filter:drop-shadow(0 2px 0 rgba(0,0,0,.08))}

  /* Sea play area */
  .sea{position:relative; overflow:hidden; border-radius:20px; background:linear-gradient(180deg,var(--sea),var(--deep)); height:480px; border:1px solid var(--line)}
  .sea::before{content:""; position:absolute; inset:-40px -60px auto; height:120px; background:radial-gradient(ellipse at top, rgba(255,255,255,.5), transparent 60%); filter:blur(10px)}

  /* Goppa avatar center */
  .avatar-wrap{position:absolute; left:50%; bottom:20px; transform:translateX(-50%); width:140px; height:140px; pointer-events:none}
  .avatar{position:relative; width:100%; height:100%}
  .goppa{position:absolute; inset:0; display:grid; place-items:center; font-size:72px; filter:drop-shadow(0 8px 0 rgba(0,0,0,.06))}
  .slot{position:absolute; pointer-events:auto; touch-action:manipulation}
  .slot.head{top:-8px; left:30px; width:80px; height:60px}
  .slot.back{top:30px; right:-8px; width:80px; height:80px}
  .slot.acc{bottom:6px; left:10px; width:80px; height:40px}
  .slot.tail{bottom:-4px; right:16px; width:60px; height:50px}

  /* Closet */
  .closet{display:flex; gap:8px; overflow:auto; padding:8px; border-top:1px dashed var(--line); background:rgba(255,255,255,.75); border-radius:12px}
  /* ã‚¿ãƒƒãƒç‹¬è‡ªãƒ‰ãƒ©ãƒƒã‚°ï¼‹ã‚¿ãƒƒãƒ—å³è£…å‚™ã«å¯¾å¿œ */
  .item{flex:0 0 auto; display:grid; place-items:center; width:56px; height:56px; border-radius:14px; border:1px solid var(--line); background:#fff; font-size:28px; cursor:grab; user-select:none; touch-action:none}
  .item:active{cursor:grabbing}
  .equipped{position:absolute; transform-origin:center; pointer-events:none}

  /* Swimming characters */
  .fish{position:absolute; display:grid; place-items:center; width:72px; height:72px; border-radius:50%; background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.9); box-shadow:0 6px 16px rgba(2,6,23,.12); cursor:pointer; touch-action:manipulation}
  .fish .body{font-size:28px}
  .fish::after{content:"\1F41F"; position:absolute; right:-10px; font-size:24px; opacity:.25}
  @keyframes swim {
    0%{transform:translateX(var(--x0)) translateY(var(--y0))}
    100%{transform:translateX(var(--x1)) translateY(var(--y1))}
  }

  /* Toast */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:.25s; box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* Header HUD */
  .hud{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .badge{display:inline-flex; align-items:center; gap:6px; background:#fff; border:1px solid var(--line); padding:6px 10px; border-radius:999px}
  .tag{font-weight:700; color:#0ea5e9}

  /* Modal */
  dialog{border:0; border-radius:16px; padding:0; overflow:hidden; max-width:560px; width:calc(100% - 24px)}
  dialog::backdrop{background:rgba(0,0,0,.3)}
  .modal{padding:16px}

  /* Confetti (simple) */
  .confetti{position:absolute; width:10px; height:10px; border-radius:2px; opacity:.9; animation:fall 900ms ease-out forwards}
  @keyframes fall{to{transform:translateY(140px) rotate(260deg); opacity:0}}

  /* Flashy motions */
  @keyframes spin360{from{transform:rotate(0)}to{transform:rotate(1turn)}}
  @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}
  @keyframes wiggle{0%,100%{transform:rotate(0)}25%{transform:rotate(-12deg)}75%{transform:rotate(12deg)}}
  @keyframes flipY{from{transform:rotateY(0)}to{transform:rotateY(360deg)}}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
  @keyframes hue{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
  @keyframes leap{0%{transform:translate(-50%,0) scale(1)}50%{transform:translate(-50%,-40px) scale(1.1)}100%{transform:translate(-50%,0) scale(1)}}
  @keyframes splash{0%{opacity:0; transform:scale(0.6)}50%{opacity:1; transform:scale(1.2)}100%{opacity:0; transform:scale(1.6)}}
  @keyframes zoomPop{0%{transform:scale(0.7)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
</style>
</head>
<body>
<div class="app">
  <div class="title card">
    <div class="goppa-logo">ğŸŸ</div>
    <div>
      <h1>ã‚´ãƒƒãƒ‘ã¨ ã†ã¿ã®ã¼ã†ã‘ã‚“ï¼</h1>
      <div class="muted">ã‚ãã‚“ã§å­¦ã¹ã‚‹ï¼šã™ã†ã˜ï¼ã²ã‚‰ãŒãªï¼ABCï¼ˆéŸ³å£°ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¤ãï¼‰</div>
    </div>
    <div style="margin-left:auto" class="row">
      <button class="btn" id="btnStart">ã¯ã˜ã‚ã‚‹</button>
      <button class="btn ghost" id="btnCloset">ãã›ã‹ãˆ</button>
    </div>
  </div>

  <div class="card" id="modeCard">
    <div class="row">
      <strong>ãƒ¢ãƒ¼ãƒ‰ã‚’ãˆã‚‰ã‚“ã§ã­ï¼š</strong>
      <button class="btn sec" data-mode="num">ã™ã†ã˜</button>
      <button class="btn sec" data-mode="hiragana">ã²ã‚‰ãŒãª</button>
      <button class="btn sec" data-mode="abc">ABC</button>
    </div>
    <div class="muted" style="margin-top:8px">ã‚´ãƒƒãƒ‘ï¼ˆãƒ©ã‚¤ãƒˆé–¢è¥¿å¼ï¼‰ãŒãŠã†ãˆã‚“ã™ã‚‹ã§ï¼</div>
  </div>

  <div class="card hud hidden" id="hud">
    <div class="badge"><span>ãƒ¢ãƒ¼ãƒ‰</span><span class="tag" id="hudMode">-</span></div>
    <div class="badge"><span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</span><span class="tag" id="hudTarget">-</span></div>
    <div class="badge"><span>ã‚¹ã‚³ã‚¢</span><span class="tag" id="hudScore">0</span></div>
    <div class="row">
      <button class="btn ghost" id="btnSay">ã‚‚ã†ã„ã£ã‹ã„ ã„ã†</button>
      <button class="btn ghost" id="btnNext">ã¤ãã¸</button>
    </div>
  </div>

  <div class="sea card" id="sea">
    <div class="avatar-wrap" id="avatarWrap">
      <div class="avatar">
        <div class="goppa" id="goppa">ğŸŸ</div>
        <div class="slot head" data-slot="head"></div>
        <div class="slot back" data-slot="back"></div>
        <div class="slot acc" data-slot="acc"></div>
        <div class="slot tail" data-slot="tail"></div>
      </div>
    </div>
  </div>

  <div class="card" id="closetCard">
    <div class="row" style="justify-content:space-between">
      <strong>ãã›ã‹ãˆï¼ˆãƒ‰ãƒ©ãƒƒã‚° or ã‚¿ãƒƒãƒ—ã§å³è£…å‚™ï¼‰</strong>
      <div class="muted">é ­ï¼ã›ãªã‹ï¼ã‚¢ã‚¯ã‚»ï¼ã—ã£ã½ ã«ç½®ã„ã¦ã­ï¼ˆåŒã‚¹ãƒ­ãƒƒãƒˆã¯å¸¸ã«1ã¤ï¼‰</div>
    </div>
    <div class="closet" id="closet"></div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<dialog id="rewardDlg">
  <div class="modal">
    <h3>ã”ã»ã†ã³ã‚²ãƒƒãƒˆï¼</h3>
    <p id="rewardText" class="muted">ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‰‹ã«å…¥ã‚ŒãŸã§ï¼ãã›ã‹ãˆã§ä½¿ãˆã‚‹ã‚ˆï¼</p>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="rewardOk">ã‚„ã£ãŸï¼</button>
    </div>
  </div>
</dialog>

<dialog id="resultDlg">
  <div class="modal">
    <h3>ãã‚‡ã†ã® ã¼ã†ã‘ã‚“ çµæœï¼</h3>
    <p class="muted">5å•ã®ã‚¹ã‚³ã‚¢ã¯â€¦ <strong id="setScore">0</strong> / 5</p>
    <p id="setComment" class="muted">ã‚³ãƒ¡ãƒ³ãƒˆãŒå…¥ã‚‹ã‚ˆ</p>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="btnAgain">ã‚‚ã†1ã‚»ãƒƒãƒˆï¼</button>
    </div>
  </div>
</dialog>

<script>
(()=>{
  // ====== State ======
  const state = {
    mode:null, score:0, target:"", needReward:0,
    round:0, setSize:5,
    equipped: { head:null, back:null, acc:null, tail:null },
    inventory: [],
    voices: { ja:null, en:null },
    speaking:false,
  };

  const el = (id)=>document.getElementById(id);
  const sea = el('sea');
  const hud = el('hud');
  const hudMode = el('hudMode');
  const hudTarget = el('hudTarget');
  const hudScore = el('hudScore');
  const closet = el('closet');
  const rewardDlg = el('rewardDlg');
  const rewardText = el('rewardText');
  const resultDlg = document.getElementById('resultDlg');
  const setScoreEl = document.getElementById('setScore');
  const setCommentEl = document.getElementById('setComment');

  // ====== Data ======
  const NUMS = Array.from({length:10}, (_,i)=>String(i));
  const HIRAGANA = Array.from('ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“');
  const ABC = Array.from({length:26}, (_,i)=>String.fromCharCode(65+i));

  // Dress-up items (emoji-based)
  const ITEMS = [
    { id:'hat_pirate', slot:'head', icon:'ğŸ´\u200dâ˜ ï¸', name:'ã‹ã„ããã¼ã†ã—' },
    { id:'hat_star',   slot:'head', icon:'ğŸŒŸ',         name:'ã»ã—ã‚«ãƒãƒ¥ãƒ¼ã‚·ãƒ£' },
    { id:'hat_jelly',  slot:'head', icon:'ğŸª¼',         name:'ãã‚‰ã’ãƒ‹ãƒƒãƒˆ' },
    { id:'back_dolphin', slot:'back', icon:'ğŸ¬',      name:'ã‚¤ãƒ«ã‚«ãƒãƒ³ãƒˆ' },
    { id:'back_crab',    slot:'back', icon:'ğŸ¦€',      name:'ã‚«ãƒ‹ã‚ˆã‚ã„' },
    { id:'back_ring',    slot:'back', icon:'ğŸ›Ÿ',      name:'ã†ãã‚' },
    { id:'acc_glass',  slot:'acc',  icon:'ğŸ˜',         name:'ã‚µãƒ³ã‚°ãƒ©ã‚¹' },
    { id:'acc_shell',  slot:'acc',  icon:'ğŸ“¿',         name:'ã‹ã„ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹' },
    { id:'tail_ribbon', slot:'tail', icon:'ğŸ€',       name:'ã—ã£ã½ãƒªãƒœãƒ³' },
    { id:'tail_light',  slot:'tail', icon:'ğŸ’¡',       name:'ã»ãŸã‚‹ãƒ©ã‚¤ãƒˆ' },
  ];

  // Kansai-light lines
  const LINES = {
    ask: [
      (c)=>`ã€${c}ã€ã‚’ ã¤ã‹ã¾ãˆã¦ã¿ã‚ˆã‹ï¼`,
      (c)=>`æ¬¡ã¯ã€${c}ã€ã‚„ã§ã€‚ã©ã“ãŠã‚‹ã‹ãªã€œï¼Ÿ`,
      (c)=>`ã€${c}ã€è¦‹ã¤ã‘ãŸã‚‰ã€ã‚´ãƒƒãƒ‘ã€ãã‚‹ã£ã¨å›ã‚‹ã§ï¼`,
    ],
    ok: [
      ()=>`ã‚„ã‚‹ã‚„ã‚“ï¼ã‚´ãƒƒãƒ‘ã‚‚è² ã‘ã¦ã‚‰ã‚Œã¸ã‚“ãªã€œï¼`,
      ()=>`ã™ã”ã„ã‚„ã‚“ï¼ã‚´ãƒƒãƒ‘ã€ã†ã‚Œã—ã™ãã¦ãƒã‚¯è»¢ã‚„ï¼ï¼ˆã§ãã¸ã‚“ï¼‰`,
      ()=>`ãŠãŠã£ï¼ãã‚Œã‚„ã§ï¼ãƒŠã‚¤ã‚¹ï¼`,
    ],
    ng: [
      ()=>`ã¡ã‚‡ã£ã¨ã¡ãŒã†ãªã€œã€‚ã§ã‚‚å¤§ä¸ˆå¤«ã‚„ï¼ã‚‚ã†ã„ã£ã‹ã„è¡Œã“ã‹ï¼`,
      ()=>`ãŠã—ã„ã£ï¼æ¬¡ã¯ã„ã‘ã‚‹ã§ï¼`,
      ()=>`ã‚ã‹ã‚‹ã‚ã€œã€‚ã‚´ãƒƒãƒ‘ã‚‚ã‚ˆã†ã¾ã¡ãŒãˆã‚‹ã­ã‚“ã€‚`,
    ],
    reward: [
      (name)=>`${name} ã‚’æ‰‹ã«å…¥ã‚ŒãŸã§ï¼ã‚´ãƒƒãƒ‘ã€ä¼¼åˆã†ã‹ãªï¼Ÿ`,
      (name)=>`æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã€${name}ã€ã‚„ï¼è£…å‚™ã—ã¦ã¿ã‚ˆï¼`,
    ]
  };

  // ====== Speech ======
  function pickVoice(langStarts){
    const list = window.speechSynthesis.getVoices();
    const v = list.find(v=>langStarts.some(ls=>v.lang && v.lang.startsWith(ls)));
    return v || list.find(v=>v.lang && v.lang.startsWith('ja')) || list[0] || null;
  }
  function loadVoices(){
    state.voices.ja = pickVoice(['ja']);
    state.voices.en = pickVoice(['en']);
  }
  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  function speak(text,{lang='ja-JP', rate=1.0}={}){
    try{ window.speechSynthesis.cancel(); }catch(e){}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang; u.rate = rate;
    u.voice = (lang.startsWith('en')? state.voices.en : state.voices.ja) || null;
    state.speaking = true;
    u.onend = ()=>{ state.speaking = false; };
    window.speechSynthesis.speak(u);
  }

  function sayAsk(){
    const c = state.target;
    const f = LINES.ask[Math.floor(Math.random()*LINES.ask.length)];
    speak(f(c), {lang:'ja-JP', rate:1.05});
    if(state.mode==='abc'){
      const name = letterNameJP(c);
      setTimeout(()=>speak(`${c}ï¼ˆ${name}ï¼‰`, {lang:'ja-JP', rate:1.0}), 600);
    }
  }

  function letterNameJP(c){
    const map = {A:'ã‚¨ãƒ¼',B:'ãƒ“ãƒ¼',C:'ã‚·ãƒ¼',D:'ãƒ‡ã‚£ãƒ¼',E:'ã‚¤ãƒ¼',F:'ã‚¨ãƒ•',G:'ã‚¸ãƒ¼',H:'ã‚¨ã‚¤ãƒ',I:'ã‚¢ã‚¤',J:'ã‚¸ã‚§ã‚¤',K:'ã‚±ãƒ¼',L:'ã‚¨ãƒ«',M:'ã‚¨ãƒ ',N:'ã‚¨ãƒŒ',O:'ã‚ªãƒ¼',P:'ãƒ”ãƒ¼',Q:'ã‚­ãƒ¥ãƒ¼',R:'ã‚¢ãƒ¼ãƒ«',S:'ã‚¨ã‚¹',T:'ãƒ†ã‚£ãƒ¼',U:'ãƒ¦ãƒ¼',V:'ãƒ–ã‚¤',W:'ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼',X:'ã‚¨ãƒƒã‚¯ã‚¹',Y:'ãƒ¯ã‚¤',Z:'ã‚ºã‚£ãƒ¼'};
    return map[c]||c;
  }

  // ====== Helpers ======
  function toast(msg, ms=1400){
    const t = el('toast'); t.textContent = msg; t.classList.add('show');
    clearTimeout(t._tid); t._tid = setTimeout(()=>t.classList.remove('show'), ms);
  }
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const shuffle = (arr)=>arr.map(v=>[v,Math.random()]).sort((a,b)=>a[1]-b[1]).map(v=>v[0]);

  // ====== Game Flow ======
  function start(mode){
    state.mode = mode; state.score = 0; state.needReward = 0; state.round = 0;
    hud.classList.remove('hidden');
    seaFocus();
    hudMode.textContent = modeLabel(mode);
    nextRound();
  }

  function modeLabel(m){
    return m==='num'? 'ã™ã†ã˜' : (m==='hiragana'? 'ã²ã‚‰ãŒãª' : 'ABC');
  }

  function seaFocus(){
    document.querySelectorAll('.fish').forEach(n=>n.remove());
  }

  function poolForMode(){
    if(state.mode==='num') return NUMS;
    if(state.mode==='hiragana') return HIRAGANA;
    return ABC;
  }

  function nextRound(){
    seaFocus();
    const pool = poolForMode();
    const choices = shuffle(pool).slice(0,6);
    state.target = pick(choices);
    hudTarget.textContent = state.target;
    spawnFishes(choices);
    sayAsk();
  }

  function spawnFishes(chars){
    const W = sea.clientWidth, H = sea.clientHeight;
    chars.forEach((ch)=>{
      const n = document.createElement('div');
      n.className = 'fish';
      n.style.setProperty('--x0', `${rand(-40, W-80)}px`);
      n.style.setProperty('--y0', `${rand(20, H-200)}px`);
      n.style.setProperty('--x1', `${rand(-20, W-60)}px`);
      n.style.setProperty('--y1', `${rand(30, H-180)}px`);
      n.style.animation = `swim ${rand(4,7).toFixed(1)}s ease-in-out ${rand(0,1).toFixed(2)}s infinite alternate`;
      n.dataset.char = ch;
      n.innerHTML = `<div class="body">${ch}</div>`;
      n.addEventListener('click', onFishTap);
      sea.appendChild(n);
    });
  }

  function onFishTap(e){
    const ch = e.currentTarget.dataset.char;
    if(ch === state.target){
      correct(e.currentTarget);
    }else{
      wrong(e.currentTarget);
    }
  }

  function confettiBurst(x,y){
    for(let i=0;i<14;i++){
      const c = document.createElement('div');
      c.className='confetti';
      c.style.left = x+rand(-24,24)+'px';
      c.style.top = y+rand(-10,10)+'px';
      c.style.background = `hsl(${Math.floor(rand(0,360))}deg 90% 60%)`;
      c.style.transform = `translateY(0) rotate(${rand(-60,60)}deg)`;
      sea.appendChild(c);
      setTimeout(()=>c.remove(), 900);
    }
  }

  function correct(node){
    const r = node.getBoundingClientRect();
    const s = sea.getBoundingClientRect();
    confettiBurst(r.left - s.left + r.width/2, r.top - s.top + r.height/2);
    node.style.transition='transform .25s, opacity .25s';
    node.style.transform='scale(1.2)';
    node.style.opacity='.1';
    setTimeout(()=>node.remove(), 260);

    state.score += 1; state.needReward += 1; state.round += 1;
    hudScore.textContent = state.score;
    speak(pick(LINES.ok)(), {lang:'ja-JP', rate:1.05});

    performEquipAction();

    if(state.needReward >= 3){ state.needReward = 0; grantReward(); }

    if(state.round >= state.setSize){
      setTimeout(()=>endSet(), 600);
    }else{
      setTimeout(()=>nextRound(), 650);
    }
  }

  function wrong(node){
    node.animate(
      [{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
      {duration:240}
    );
    speak(pick(LINES.ng)(), {lang:'ja-JP', rate:1.0});
  }

  function grantReward(){
    const owned = new Set(state.inventory.map(x=>x.id));
    const pool = ITEMS.filter(x=>!owned.has(x.id));
    const item = pool.length? pick(pool) : pick(ITEMS);
    if(!owned.has(item.id)) state.inventory.push(item);
    save(); renderCloset();
    rewardText.textContent = pick(LINES.reward)(item.name);
    rewardDlg.showModal();
  }

  // ====== Closet / Equip ======
  function renderCloset(){
    closet.innerHTML='';
    const inv = state.inventory.length? state.inventory : ITEMS.slice(0,4);
    inv.forEach(it=>{
      const d = document.createElement('div');
      d.className='item';
      d.draggable=true;
      d.dataset.itemId = it.id;
      d.title = `${it.name}ï¼ˆ${slotLabel(it.slot)}ï¼‰`;
      d.textContent = it.icon;
      d.addEventListener('click', ()=>equipAuto(it));
      d.addEventListener('pointerdown', (ev)=>{ dragItem = it; createGhost(ev.pageX, ev.pageY, it); ev.preventDefault(); });
      d.addEventListener('dragstart', onDragStart);
      closet.appendChild(d);
    });
  }
  const slotLabel = (s)=> s==='head'?'ã‚ãŸã¾' : s==='back'?'ã›ãªã‹' : s==='acc'?'ã‚¢ã‚¯ã‚»' : 'ã—ã£ã½';

  // Drag helpers & pointer drag
  let dragGhost=null, dragItem=null;
  function onDragStart(ev){
    dragItem = ITEMS.find(x=>x.id === ev.target.dataset.itemId);
    createGhost(ev.pageX, ev.pageY, dragItem);
  }
  function createGhost(x,y,item){
    dragGhost = document.createElement('div');
    dragGhost.className='equipped';
    dragGhost.style.fontSize='42px';
    dragGhost.textContent=item.icon;
    dragGhost.style.position='fixed';
    dragGhost.style.left=(x-20)+'px';
    dragGhost.style.top=(y-28)+'px';
    dragGhost.style.pointerEvents='none';
    document.body.appendChild(dragGhost);
  }
  function onPointerMove(ev){
    if(!dragGhost) return;
    dragGhost.style.left = (ev.pageX-20)+'px';
    dragGhost.style.top  = (ev.pageY-28)+'px';
  }
  function onPointerUp(ev){
    if(!dragGhost || !dragItem) return cleanupDrag();
    const drop = document.elementFromPoint(ev.clientX, ev.clientY);
    const slotEl = drop && drop.closest && drop.closest('.slot');
    if(slotEl){
      equip(slotEl.dataset.slot, dragItem);
      toast(`${dragItem.name} ã‚’è£…å‚™ã—ãŸã§ï¼`);
    }
    cleanupDrag();
  }
  function cleanupDrag(){ if(dragGhost){ dragGhost.remove(); dragGhost=null; } dragItem=null; }
  document.addEventListener('pointermove', onPointerMove);
  document.addEventListener('pointerup', onPointerUp);

  function equipAuto(item){ equip(item.slot, item); toast(`${item.name} ã‚’è£…å‚™ã—ãŸã§ï¼`); }

  function equip(slot, item){
    if(item.slot !== slot){ toast(`${slotLabel(slot)} ã«ã¯ ã¤ã‘ã‚‰ã‚Œã¸ã‚“ã¿ãŸã„ã‚„â€¦`); return; }
    state.equipped[slot] = item; // 1ã‚¹ãƒ­ãƒƒãƒˆ1ã¤ï¼šè‡ªå‹•ã§ç½®ãæ›ãˆ
    save(); renderEquipped();
  }
  function renderEquipped(){
    document.querySelectorAll('.slot').forEach(s=>s.innerHTML='');
    Object.entries(state.equipped).forEach(([slot,item])=>{
      if(!item) return;
      const s = document.querySelector(`.slot.${slot}`) || document.querySelector(`.slot[data-slot="${slot}"]`);
      if(!s) return;
      const d = document.createElement('div');
      d.className='equipped';
      d.style.fontSize = slot==='back'? '54px':'40px';
      d.textContent=item.icon;
      s.appendChild(d);
    });
  }

  // ====== Persistence ======
  const LS_KEY = 'goppa_save_v2';
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify({equipped:state.equipped, inventory:state.inventory})) }
  function load(){ try{ const o = JSON.parse(localStorage.getItem(LS_KEY)||'{}'); if(o.equipped) state.equipped=o.equipped; if(o.inventory) state.inventory=o.inventory; }catch(e){} }

  // ====== Set end & Equip-based actions ======
  function endSet(){
    const s = state.score;
    setScoreEl && (setScoreEl.textContent = String(s));
    let comment='';
    if(s===5) comment='æº€ç‚¹ã‚„ã‚“ï¼ã‚´ãƒƒãƒ‘ã€å°Šæ•¬ã—ã¦ã¾ã†ã‚ã€œï¼';
    else if(s>=4) comment='ã‚ã£ã¡ã‚ƒãˆãˆæ„Ÿã˜ï¼ã‚ã¨ã¡ã‚‡ã£ã¨ã§æº€ç‚¹ã‚„ï¼';
    else if(s>=2) comment='ãƒŠã‚¤ã‚¹æŒ‘æˆ¦ï¼æ¬¡ã¯ã‚‚ã£ã¨ã„ã‘ã‚‹ã§ï¼';
    else comment='æœ€åˆã¯ã“ã‚“ãªã‚‚ã‚“ã‚„ï¼ä¸€ç·’ã«ã‚³ãƒ„ã‚³ãƒ„ã„ã“ï¼';
    setCommentEl && (setCommentEl.textContent = comment);
    resultDlg && resultDlg.showModal();
  }

  function performEquipAction(){
    const g = document.getElementById('goppa');
    const wrap = document.getElementById('avatarWrap');
    const eq = state.equipped;
    const act = [];
    // å„ªå…ˆåº¦ï¼šèƒŒä¸­(ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯) > é ­ > ã‚¢ã‚¯ã‚» > ã—ã£ã½
    if(eq.back){
      if(eq.back.id==='back_dolphin') act.push(()=>{ wrap.style.animation='leap 800ms ease-out'; setTimeout(()=>wrap.style.animation='',820); splashFX(); toast('ã‚¤ãƒ«ã‚«ã‚¸ãƒ£ãƒ³ãƒ—ï¼'); });
      if(eq.back.id==='back_crab')    act.push(()=>{ g.style.animation='wiggle 800ms ease-in-out'; setTimeout(()=>g.style.animation='',820); toast('ã‚«ãƒ‹ã‚¬ãƒ¼ãƒ‰ï¼'); });
      if(eq.back.id==='back_ring')    act.push(()=>{ g.style.animation='bob 900ms ease-in-out'; setTimeout(()=>g.style.animation='',920); toast('ã·ã‹ã·ã‹ã€œï¼'); });
    }
    if(eq.head){
      if(eq.head.id==='hat_pirate')   act.push(()=>{ g.style.animation='flipY 750ms ease-in-out'; setTimeout(()=>g.style.animation='',770); toast('ã©ã‚„ã£ï¼'); });
      if(eq.head.id==='hat_star')     act.push(()=>{ g.style.animation='pulse 720ms ease-out'; setTimeout(()=>g.style.animation='',740); rayFX(); toast('ã‚­ãƒ©ã‚­ãƒ©â˜†'); });
      if(eq.head.id==='hat_jelly')    act.push(()=>{ g.style.animation='wiggle 900ms ease-in-out'; setTimeout(()=>g.style.animation='',920); toast('ã·ã‚‹ã·ã‚‹ã€œï¼'); });
    }
    if(eq.acc){
      if(eq.acc.id==='acc_glass')     act.push(()=>{ g.style.animation='hue 1000ms linear, pulse 700ms ease-out'; setTimeout(()=>g.style.animation='',1020); toast('ã‚­ãƒã£ã¦ã‚‹ã‚„ã‚“ï¼'); });
      if(eq.acc.id==='acc_shell')     act.push(()=>{ g.style.animation='spin360 700ms ease-out'; setTimeout(()=>g.style.animation='',720); toast('ãã‚‹ã‚Šã‚“ï¼'); });
    }
    if(eq.tail){
      if(eq.tail.id==='tail_ribbon')  act.push(()=>{ g.style.animation='spin360 800ms ease-out'; setTimeout(()=>g.style.animation='',820); confettiBurst(sea.clientWidth/2, 120); });
      if(eq.tail.id==='tail_light')   act.push(()=>{ glowFX(); toast('ãƒ”ã‚«ãƒ”ã‚«ã€œï¼'); });
    }
    if(act.length===0) act.push(()=>{ g.style.animation='pulse 650ms ease-out'; setTimeout(()=>g.style.animation='',670); });
    pick(act)();
  }

  function splashFX(){
    const d = document.createElement('div');
    d.textContent='ğŸ’¦'; d.style.position='absolute'; d.style.left='50%'; d.style.top='35%'; d.style.transform='translate(-50%,-50%)'; d.style.fontSize='52px'; d.style.opacity='0';
    sea.appendChild(d);
    d.animate([{opacity:0, transform:'translate(-50%,-50%) scale(0.6)'},{opacity:1, transform:'translate(-50%,-60%) scale(1.2)'},{opacity:0, transform:'translate(-50%,-50%) scale(1.6)'}],{duration:900, easing:'ease-out'});
    setTimeout(()=>d.remove(), 920);
  }
  function glowFX(){
    const d = document.createElement('div');
    d.textContent='âœ¨'; d.style.position='absolute'; d.style.left='50%'; d.style.top='40%'; d.style.transform='translate(-50%,-50%)'; d.style.fontSize='56px'; d.style.opacity='0';
    sea.appendChild(d);
    d.animate([{opacity:0, transform:'translate(-50%,-50%) scale(0.7)'},{opacity:1, transform:'translate(-50%,-65%) scale(1.1)'},{opacity:0}],{duration:900, easing:'ease-out'});
    setTimeout(()=>d.remove(), 920);
  }
  function rayFX(){
    // æ”¾å°„çŠ¶ã®ãã‚‰ã‚ã
    const N=8; const centerX=sea.clientWidth/2, centerY=sea.clientHeight*0.35;
    for(let i=0;i<N;i++){
      const r=document.createElement('div');
      r.textContent='âœ´ï¸'; r.style.position='absolute'; r.style.left=centerX+'px'; r.style.top=centerY+'px'; r.style.transform='translate(-50%,-50%) scale(0.6)'; r.style.opacity='0'; r.style.fontSize='28px';
      sea.appendChild(r);
      const angle = (Math.PI*2/N)*i; const dx=Math.cos(angle)*60; const dy=Math.sin(angle)*40;
      r.animate([{opacity:0, transform:'translate(-50%,-50%) scale(0.6)'},{opacity:1, transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.1)`},{opacity:0}], {duration:800, easing:'ease-out'});
      setTimeout(()=>r.remove(), 820);
    }
  }

  // ====== Minimal BGM (WebAudio simple percussion loop) ======
  let audioCtx=null, bgmTimer=null;
  function unlockAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    blip(880, .08); setTimeout(()=>blip(1174, .08), 120); setTimeout(()=>blip(1568, .12), 240);
    startBgm();
  }
  function blip(freq, dur){
    if(!audioCtx) return;
    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
    o.type='square'; o.frequency.value=freq; g.gain.value=.0001; o.connect(g).connect(audioCtx.destination);
    o.start(); g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
    o.stop(audioCtx.currentTime+dur+.02);
  }
  function clicker(){ if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=420; g.gain.value=.0001; o.connect(g).connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.08); o.stop(audioCtx.currentTime+0.1); }
  function startBgm(){
    if(!audioCtx) return; if(bgmTimer) clearInterval(bgmTimer);
    const tempo=105; const beat=(60/tempo)*1000; let step=0;
    bgmTimer = setInterval(()=>{ if(step%2===0) blip(100, .05); else clicker(); step=(step+1)%8; }, beat);
  }

  // ====== Controls ======
  document.querySelectorAll('#modeCard [data-mode]').forEach(btn=>{ btn.addEventListener('click',()=>{ start(btn.dataset.mode); }); });
  el('btnSay').addEventListener('click',()=>sayAsk());
  el('btnNext').addEventListener('click',()=>nextRound());
  el('btnCloset').addEventListener('click',()=>{ document.getElementById('closetCard').scrollIntoView({behavior:'smooth'}); toast('ã‚¢ã‚¤ãƒ†ãƒ ï¼šã‚¿ãƒƒãƒ—ã§å³è£…å‚™ or ãƒ‰ãƒ©ãƒƒã‚°ã§è£…å‚™ã§ãã‚‹ã§ï¼'); });
  el('btnStart').addEventListener('click',()=>{ unlockAudio(); toast('ã‚´ãƒƒãƒ‘ã€å‡ºç™ºã‚„ã§ï¼ ã¾ãšã¯ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãªï¼'); });
  el('rewardOk').addEventListener('click',()=>rewardDlg.close());
  document.getElementById('btnAgain').addEventListener('click', ()=>{ resultDlg.close(); state.score = 0; state.round = 0; hudScore.textContent = state.score; nextRound(); });

  // ====== Init ======
  load(); renderCloset(); renderEquipped();
})();
</script>
</body>
</html>
