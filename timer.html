<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Timer</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --panel-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --warning: #eab308;
            --danger: #ef4444;
            --success: #22c55e;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            user-select: none; /* 会議中の誤操作防止のためテキスト選択無効 */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background-color 0.5s;
        }

        /* 状態による背景色変化 */
        body.status-warning { background-color: #fef9c3; }
        body.status-danger { background-color: #fee2e2; }

        .app-container {
            background-color: var(--panel-bg);
            width: 90%;
            max-width: 600px;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-sub);
            font-weight: 700;
        }

        /* Input Panel */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .custom-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        input[type="number"] {
            width: 100px;
            padding: 0.5rem;
            font-size: 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            outline: none;
        }
        input[type="number"]:focus {
            border-color: var(--primary);
        }

        /* Timer Display */
        .timer-display {
            font-variant-numeric: tabular-nums; /* 数字の幅を等しく */
            font-size: 6rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -2px;
            color: var(--text-main);
            margin: 1rem 0;
        }
        
        .timer-display.blink {
            animation: blink 1s infinite;
            color: var(--danger);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%; /* JSで制御 */
            transition: width 1s linear, background-color 0.5s;
        }

        /* Buttons */
        button {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:active { transform: scale(0.96); }

        .btn-primary { background-color: var(--primary); color: white; width: 100%; font-size: 1.2rem; }
        .btn-primary:hover { background-color: var(--primary-hover); }

        .btn-outline { background-color: white; border: 2px solid #e2e8f0; color: var(--text-main); }
        .btn-outline:hover { background-color: #f8fafc; border-color: #cbd5e1; }

        .btn-danger { background-color: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background-color: #fecaca; }

        .btn-control { flex: 1; font-size: 1.1rem; }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Utility classes */
        .hidden { display: none !important; }
        .text-sm { font-size: 0.875rem; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.5rem; }

        /* Responsive */
        @media (max-width: 480px) {
            .timer-display { font-size: 4rem; }
            .app-container { padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>会議タイマー</h1>

        <div id="setup-view" class="input-group">
            <div class="presets">
                <button class="btn-outline" onclick="startTimer(15)">15分</button>
                <button class="btn-outline" onclick="startTimer(30)">30分</button>
                <button class="btn-outline" onclick="startTimer(60)">60分</button>
            </div>
            
            <div class="custom-input">
                <input type="number" id="minutes-input" min="1" max="180" placeholder="0" value="10">
                <span>分で開始</span>
            </div>

            <button class="btn-primary" onclick="startCustomTimer()">
                <span id="start-icon">▶</span> スタート
            </button>
        </div>

        <div id="timer-view" class="hidden">
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar" style="width: 100%;"></div>
            </div>

            <div id="time-display" class="timer-display">00:00</div>
            
            <div class="text-sm text-sub" id="target-time-display">終了予定: --:--</div>

            <div class="controls">
                <button id="pause-btn" class="btn-outline btn-control" onclick="togglePause()">
                    ⏸ 一時停止
                </button>
                <button class="btn-danger btn-control" onclick="resetTimer()">
                    ⏹ 終了
                </button>
            </div>
            
            <div class="mt-2 text-center">
                <label style="font-size: 0.8rem; color: #94a3b8; cursor: pointer;">
                    <input type="checkbox" id="sound-toggle" checked> 終了時に音を鳴らす
                </label>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let totalSeconds = 0;
        let remainingSeconds = 0;
        let timerInterval = null;
        let isPaused = false;
        let endTime = null;

        // --- DOM Elements ---
        const setupView = document.getElementById('setup-view');
        const timerView = document.getElementById('timer-view');
        const timeDisplay = document.getElementById('time-display');
        const progressBar = document.getElementById('progress-bar');
        const pauseBtn = document.getElementById('pause-btn');
        const targetTimeDisplay = document.getElementById('target-time-display');
        const body = document.body;
        const minutesInput = document.getElementById('minutes-input');
        const soundCheck = document.getElementById('sound-toggle');

        // --- Audio Context (Web Audio API for No-External-File Beep) ---
        let audioCtx = null;

        function playBeep() {
            if (!soundCheck.checked) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine'; // 正弦波
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); // 880Hz (La)
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.1);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playAlarm() {
            if (!soundCheck.checked) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            const now = audioCtx.currentTime;
            // 3回鳴らす Pi-Pi-Pi
            [0, 0.4, 0.8].forEach(offset => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'square'; // 目立つ矩形波
                osc.frequency.setValueAtTime(1000, now + offset);
                gain.gain.setValueAtTime(0.1, now + offset);
                gain.gain.linearRampToValueAtTime(0, now + offset + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now + offset);
                osc.stop(now + offset + 0.2);
            });
        }

        // --- Timer Logic ---
        function startCustomTimer() {
            const min = parseInt(minutesInput.value);
            if (min > 0) startTimer(min);
        }

        function startTimer(minutes) {
            // AudioContextはユーザー操作で初期化する必要があるためここでresume
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            
            totalSeconds = minutes * 60;
            remainingSeconds = totalSeconds;
            isPaused = false;
            
            // 終了予定時刻の計算
            const now = new Date();
            const end = new Date(now.getTime() + minutes * 60000);
            targetTimeDisplay.textContent = `終了予定: ${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;

            // View切り替え
            setupView.classList.add('hidden');
            timerView.classList.remove('hidden');
            pauseBtn.textContent = '⏸ 一時停止';
            body.className = ''; // 背景リセット
            timeDisplay.classList.remove('blink');

            updateDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
        }

        function tick() {
            if (isPaused) return;

            remainingSeconds--;
            updateDisplay();

            // 残り時間によるアラート
            const ratio = remainingSeconds / totalSeconds;
            if (remainingSeconds > 0) {
                if (ratio < 0.1 || remainingSeconds < 60) {
                    body.className = 'status-danger';
                    progressBar.style.backgroundColor = '#ef4444';
                } else if (ratio < 0.25 || remainingSeconds < 300) {
                    body.className = 'status-warning';
                    progressBar.style.backgroundColor = '#eab308';
                } else {
                    body.className = '';
                    progressBar.style.backgroundColor = '#3b82f6';
                }
            }

            if (remainingSeconds <= 0) {
                timeUp();
            }
        }

        function updateDisplay() {
            const displaySec = Math.max(0, remainingSeconds);
            const m = Math.floor(displaySec / 60).toString().padStart(2, '0');
            const s = (displaySec % 60).toString().padStart(2, '0');
            timeDisplay.textContent = `${m}:${s}`;

            const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);
            progressBar.style.width = `${percent}%`;
        }

        function timeUp() {
            clearInterval(timerInterval);
            remainingSeconds = 0;
            updateDisplay();
            timeDisplay.textContent = "TIME UP";
            timeDisplay.classList.add('blink');
            body.className = 'status-danger';
            playAlarm();
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseBtn.textContent = '▶ 再開';
                body.style.opacity = '0.7';
            } else {
                pauseBtn.textContent = '⏸ 一時停止';
                body.style.opacity = '1';
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            setupView.classList.remove('hidden');
            timerView.classList.add('hidden');
            body.className = '';
            body.style.opacity = '1';
            document.title = "Meeting Timer";
        }

        // タイトルバーにも時間を表示
        setInterval(() => {
            if (!timerView.classList.contains('hidden') && remainingSeconds > 0) {
                const m = Math.floor(remainingSeconds / 60).toString().padStart(2, '0');
                const s = (remainingSeconds % 60).toString().padStart(2, '0');
                document.title = `${m}:${s} - Meeting Timer`;
            } else {
                document.title = "Meeting Timer";
            }
        }, 1000);

    </script>
</body>
</html>