<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no" />
<title>SpeakNoteï¼ˆè‹±èªä¾‹æ–‡ãƒ»å ´é¢å­¦ç¿’ï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --bg2:#0c1220;
    --card:#121826; --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --warn:#ffb020; --danger:#ff4d4f; --star:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:linear-gradient(var(--bg),var(--bg2));color:var(--ink);
    font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif
  }
  header{
    position:sticky;top:0;z-index:10;background:rgba(12,15,20,.8);backdrop-filter:saturate(1.2) blur(10px);
    border-bottom:1px solid var(--line);padding:10px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap
  }
  h1{font-size:18px;margin:0}
  .subtitle{font-size:12px;color:var(--muted);white-space:nowrap}
  nav{display:flex;gap:8px;margin-left:auto}
  nav button{
    appearance:none;border:1px solid var(--line);background:#0e1525;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:14px;cursor:pointer
  }
  nav button.active{border-color:var(--pri);box-shadow:0 0 0 2px rgba(77,163,255,.15) inset}
  main{padding:12px 12px 48px}
  .wrap{max-width:880px;margin:0 auto}
  section{display:none}
  section.active{display:block}
  .row{display:grid;gap:10px}
  @media(min-width:640px){ .row.two{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
  input[type="text"], input[type="search"], textarea, select{
    width:100%;background:var(--card);border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:10px;font-size:16px;outline:none
  }
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .btn{
    appearance:none;border:1px solid var(--line);background:#10192b;color:var(--ink);
    padding:10px 12px;border-radius:12px;font-size:16px;cursor:pointer
  }
  .btn.pri{background:linear-gradient(180deg,#1b3b64,#10223b);border-color:#285082}
  .btn.ok{background:linear-gradient(180deg,#115a2b,#0f2e1b);border-color:#1d7a44}
  .btn.warn{background:linear-gradient(180deg,#5d430f,#2f230a);border-color:#7d5a14}
  .btn.danger{background:linear-gradient(180deg,#5a1313,#2b0f0f);border-color:#7a1d1d}
  .grid{display:grid;gap:10px}
  .filters{display:grid;gap:8px;margin-bottom:12px}
  @media(min-width:640px){ .filters{grid-template-columns:1fr 160px 1fr auto} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;cursor:pointer}
  .card:hover{outline:1px solid #2b4b7a}
  .card h3{margin:0 0 6px 0;font-size:16px}
  .meta{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
  .flag{padding:2px 6px;border-radius:6px;border:1px solid var(--line);font-size:12px}
  dialog{width:min(820px,92vw);border:1px solid var(--line);border-radius:16px;background:#0f1524;color:var(--ink);padding:14px}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .tiny{font-size:12px;color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
  .divider{height:1px;background:var(--line);margin:8px 0}
  footer{position:fixed;left:0;right:0;bottom:6px;text-align:center;font-size:11px;color:#8591a6;pointer-events:none}

  .speak-text{white-space:pre-wrap;line-height:1.9;max-height:36vh;overflow:auto;padding:6px 8px;border:1px dashed rgba(255,255,255,.08);border-radius:8px}
  .speak-text .w{padding:0 .03em;border-radius:.15em}
  .speak-text .w.hl{color:#ff4d4f;}
  .badge{font-variant-numeric:tabular-nums;background:#0e1525;border:1px solid var(--line);border-radius:8px;padding:6px 10px}

  #view-shadow .speak-text{max-height:52vh;padding:10px}
  #sh-scene{font-size:15px;color:#c2cad8;margin:2px 0 8px}

  .help-body{max-height:64vh;overflow:auto;padding:4px 2px}
  .lookup-body{max-height:50vh;overflow:auto;background:#0e1525;border:1px solid var(--line);
    border-radius:10px;padding:10px;margin:8px 0;font-size:14px;line-height:1.8}

  /* RECã®è¦–è¦šå¼·èª¿ */
  #d-rec-toggle.recording{
    border-color:#ff4d4f;
    box-shadow:0 0 0 2px rgba(255,77,79,.15) inset;
    background:linear-gradient(180deg,#5a1313,#2b0f0f);
  }
</style>
</head>
<body>
<header>
  <h1>SpeakNote</h1>
  <span class="subtitle">TOEIC-Speakingç”¨ä¾‹æ–‡ç®¡ç†ã‚¢ãƒ—ãƒª</span>
  <nav>
    <button id="nav-create" class="active">ç™»éŒ²</button>
    <button id="nav-list">ä¸€è¦§</button>
    <button id="nav-shadow" class="ok">ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</button>
    <button id="nav-settings">è¨­å®š</button>
    <button id="nav-help">ä½¿ã„æ–¹</button>
  </nav>
</header>

<main class="wrap">
  <section id="view-create" class="active">
    <div class="row">
      <div>
        <label>å…·ä½“çš„ãªå ´é¢ï¼ˆSceneï¼‰<span class="tiny">â€»å¿…é ˆ</span></label>
        <input id="scene" type="text" placeholder="ä¾‹ï¼šè¨­å‚™æ®ä»˜ã®å·¥ç¨‹ä¼šè­°ã§å¤–éƒ¨æ¤œæŸ»ã‚’ææ¡ˆ" />
      </div>
    </div>
    <div class="row two">
      <div>
        <label>è‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰</label>
        <textarea id="en" placeholder="ä¾‹ï¼šGiven our tight schedule, I suggest outsourcing the inspection to meet the deadline."></textarea>
        <div id="preview-en" class="speak-text tiny hidden" style="margin-top:6px;"></div>
      </div>
      <div>
        <label>å’Œè¨³ï¼ˆJapaneseï¼æ‰‹å…¥åŠ›ï¼‰</label>
        <textarea id="ja" placeholder="ä¾‹ï¼šå·¥ç¨‹ãŒå³ã—ã„ãŸã‚ã€ç· åˆ‡ã‚’å®ˆã‚‹ã«ã¯æ¤œæŸ»ã‚’å¤–éƒ¨å§”è¨—ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚"></textarea>
      </div>
    </div>
    <div class="row two">
      <div>
        <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°å¯ï¼å®Ÿéš›ã®å ´é¢æƒ³èµ·ï¼‰</label>
        <select id="cats" multiple size="6">
          <option>è‡ªå·±ç´¹ä»‹</option><option>è¶£å‘³ãƒ»ä¼‘æ—¥</option><option>ç¤¾å†…ã®ä¼šè©±</option>
          <option>ä¼šè­°ã®é€²è¡Œ</option><option>å ±é€£ç›¸</option><option>è³‡æ–™èª¬æ˜ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³</option>
          <option>ä¾é ¼ãƒ»æœŸé™èª¿æ•´</option><option>å–å¼•å…ˆã¨ã®äº¤æ¸‰</option><option>å“è³ªãƒ»ä¸å…·åˆå¯¾å¿œ</option>
          <option>ç´æœŸç®¡ç†ãƒ»å‡ºè·èª¿æ•´</option><option>æŠ€è¡“ãƒ»ä»•æ§˜ç¢ºèª</option><option>æ”¯æ‰•ãƒ»è«‹æ±‚ãƒ»å¥‘ç´„</option>
          <option>éƒ¨é–€é–“èª¿æ•´</option><option>æ”¹å–„ææ¡ˆãƒ»åŠ¹ç‡åŒ–</option>
        </select>
        <div class="tiny">â€» <span class="kbd">Ctrl</span>/<span class="kbd">âŒ˜</span> ã§è¤‡æ•°é¸æŠ</div>
      </div>
      <div>
        <label>ã‚¿ã‚°ï¼ˆcomma, separatedï¼‰</label>
        <input id="tags" type="text" placeholder="ä¾‹ï¼šèª¿é”, ç´æœŸ, å¤–æ³¨" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>ãƒ¡ãƒ¢ï¼ˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰</label>
        <input id="notes" type="text" placeholder="ä¾‹ï¼šã‚³ã‚¹ãƒˆå‰Šæ¸›ã®è«–æ‹ ã‚’å…¥ã‚Œã‚‹ã¨è‰¯ã„" />
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btn-preview">â–¶ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ</button>
      <button class="btn" id="btn-pause-preview">â¸ ä¸€æ™‚åœæ­¢/å†é–‹</button>
      <button class="btn pri" id="btn-save">ä¿å­˜</button>
      <button class="btn" id="btn-clear">ã‚¯ãƒªã‚¢</button>
    </div>
  </section>

  <section id="view-list">
    <div class="actions" style="justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆå ´é¢/ã‚¿ã‚°/ã‚«ãƒ†ã‚´ãƒªï¼‰" />
        <select id="f-cat"><option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option></select>
        <input id="f-tag" type="search" placeholder="ã‚¿ã‚°ã‚’å«ã‚€ï¼ˆä¾‹ï¼šç´æœŸï¼‰">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btn-export">Export</button>
        <label class="btn" for="file-import">Import</label>
        <input id="file-import" type="file" accept=".json" class="hidden">
      </div>
    </div>
    <div class="grid" id="cards"></div>
  </section>

  <section id="view-shadow">
    <h3 style="margin:0 0 6px">ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</h3>
    <div class="meta" id="sh-scene"></div>
    <div class="actions">
      <!-- å†ç”Ÿ/ä¸€æ™‚åœæ­¢ çµ±åˆ -->
      <button class="btn ok" id="sh-toggle">â–¶ï¸ å†ç”Ÿ</button>
      <button class="btn warn" id="sh-next">â© æ¬¡ã®è‹±æ–‡</button>
      <span class="badge" id="rate-badge">1.0Ã—</span>
      <button class="btn" id="sh-slower">âˆ’ é€Ÿåº¦</button>
      <button class="btn" id="sh-faster">ï¼‹ é€Ÿåº¦</button>
      <button class="btn right" id="sh-back">ä¸€è¦§ã¸æˆ»ã‚‹</button>
    </div>
    <div id="sh-text" class="speak-text" style="margin-top:8px">(ã“ã“ã«ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</div>
  </section>
</main>

<dialog id="dlg-detail">
  <h3 id="d-scene" style="margin:0 0 6px"></h3>
  <div class="meta" id="d-meta"></div>
  <div class="divider"></div>
  <div class="tiny">English</div>
  <div id="d-en" class="speak-text" style="margin-bottom:8px"></div>
  <div class="tiny">Japanese</div>
  <div id="d-ja" style="white-space:pre-wrap;margin-bottom:8px"></div>
  <div class="divider"></div>

  <!-- è¡Œ1ï¼šå†ç”Ÿãƒ»RECç³»ï¼ˆRECã¯çµ±åˆï¼é•·æŠ¼ã—ã§ã‚„ã‚Šç›´ã—ï¼‰ -->
  <div class="actions" id="d-row-audio">
    <button class="btn" id="d-toggle">â–¶ï¸ å†ç”Ÿ</button>
    <button class="btn" id="d-rec-toggle">â— REC</button>
    <button class="btn danger hidden" id="d-rec-delete">RECå‰Šé™¤</button>
    <span class="tiny" id="d-rec-timer" style="margin-left:6px;min-width:72px;display:inline-block"></span>
  </div>

  <!-- è¡Œ2ï¼šç·¨é›†ãƒ»å‰Šé™¤ãƒ»é–‰ã˜ã‚‹ï¼ˆç·¨é›†/å‰Šé™¤ï¼šå·¦ã€é–‰ã˜ã‚‹ï¼šå³ï¼‰ -->
  <div class="actions" id="d-row-actions">
    <button class="btn" id="d-edit">âœ ç·¨é›†</button>
    <button class="btn danger" id="d-del">ğŸ—‘ å‰Šé™¤</button>
    <button class="btn right" id="d-close">é–‰ã˜ã‚‹</button>
  </div>

  <!-- éŒ²éŸ³ã®å†ç”Ÿç”¨ï¼ˆéè¡¨ç¤ºï¼‰ -->
  <audio id="d-rec-audio" class="hidden"></audio>
</dialog>

<dialog id="dlg-settings">
  <form method="dialog">
    <h3 style="margin:0 0 8px">éŸ³å£°ãƒ»å†ç”Ÿè¨­å®š</h3>
    <div class="row two">
      <div>
        <label>Voice</label>
        <select id="voice"></select>
        <div class="tiny">â€» iOSã¯â€œSamantha (en-US)â€ã€PCã¯â€œMicrosoft Eric Online (Natural) (en-US)â€ã‚’å„ªå…ˆã€‚Androidã¯æœªæŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯ã€‚</div>
      </div>
      <div>
        <label>Language hint</label>
        <select id="lang">
          <option value="">Auto</option>
          <option value="en-US" selected>English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>
    <div class="row two">
      <div><label>Rate</label><input id="rate" type="range" min="0.5" max="2" step="0.1"></div>
      <div><label>Pitch</label><input id="pitch" type="range" min="0" max="2" step="0.1"></div>
    </div>
    <div class="row two">
      <div><label>Volume</label><input id="volume" type="range" min="0" max="1" step="0.1"></div>
      <div><label>Gapï¼ˆæ¬¡ãƒ‘ãƒ¼ãƒˆã¾ã§ã®é–“åˆã„ç§’ï¼‰</label><input id="gap" type="number" min="0" max="5" step="0.5"></div>
    </div>
    <div class="row two">
      <div><label>Repeatï¼ˆè‹±èªã®ç¹°ã‚Šè¿”ã—å›æ•°ï¼‰</label><input id="repeat" type="number" min="1" max="5" step="1"></div>
      <div>
        <label>èª­ã¿ä¸Šã’å¯¾è±¡</label>
        <select id="speak-target">
          <option value="en">è‹±èªã®ã¿</option>
          <option value="ja">å’Œè¨³ã®ã¿</option>
          <option value="both">è‹± â†’ é–“ â†’ å’Œ</option>
        </select>
      </div>
    </div>
    <div class="row">
      <label style="display:flex;align-items:center;gap:8px">
        <input id="keep-awake" type="checkbox"> ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ä¸­ã«ç”»é¢ã‚’è‡ªå‹•ã‚¹ãƒªãƒ¼ãƒ—ã•ã›ãªã„ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»ã«æ³¨æ„ï¼‰
      </label>
    </div>
    <div class="actions">
      <button class="btn warn" id="reset-standard">æ¨™æº–è¨­å®š</button>
      <button class="btn ok" id="save-settings">ä¿å­˜</button>
      <button class="btn right" value="close">é–‰ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<!-- ä½¿ã„æ–¹ï¼ˆå…¨æ–‡ï¼‰ -->
<dialog id="dlg-help" aria-labelledby="help-title">
  <h3 id="help-title" style="margin:0 0 8px">ä½¿ã„æ–¹ï¼ˆHow toï¼‰</h3>
  <div class="help-body" id="help-body">
    <h3>ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
    <p>SpeakNoteã¯ã€è‹±èªã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ã®ãŸã‚ã«ã€å ´é¢ï¼ˆSceneï¼‰ã‚’èµ·ç‚¹ã«ä¾‹æ–‡ã‚’ä½œæˆãƒ»ç®¡ç†ãƒ»å†ç”Ÿã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
    ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿æŒã•ã‚Œã€å¤–éƒ¨ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
    TOEICÂ® Speakingãªã©ã®å®Ÿè·µç·´ç¿’ã«æœ€é©ã§ã€ãƒãƒƒãƒˆæ¥ç¶šãªã—ã§ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚</p>

    <h3>åŸºæœ¬ã®æµã‚Œï¼ˆ0ã€œ4ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h3>
    <h4>0. ä¾‹æ–‡ç”Ÿæˆï¼ˆChatGPTãªã©ã®AIæ´»ç”¨ã‚‚OKï¼‰</h4>
    <p>ã¾ãšã¯ç·´ç¿’ã—ãŸã„è‹±æ–‡ã‚’æº–å‚™ã—ã¾ã™ã€‚<br>
    è‡ªåˆ†ã§æ—¥æœ¬èªã‹ã‚‰ä½œã£ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ChatGPTãªã©ã®ç”ŸæˆAIã§ä¸‹æ›¸ãã‚’ä½œã‚‹ã“ã¨ã‚‚åŠ¹ç‡çš„ãªæ‰‹æ®µã§ã™ã€‚</p>

    <div class="help-callout">
      <strong>ç”ŸæˆAIã‚’ä½¿ã†ä¾‹</strong>
      <ul>
        <li>ã€Œç§ã®è¶£å‘³ã¯ã€ã‚¬ãƒ¼ãƒ‡ãƒ‹ãƒ³ã‚°ã¨ãƒ“ã‚ªãƒˆãƒ¼ãƒ—ã¥ãã‚Šã§ã™ã€‚ã“ã®å‰æã§ã€1åˆ†ä»¥å†…ã§è©±ã™è‹±èªã®ã‚¹ãƒ”ãƒ¼ãƒä¾‹ã‚’ä½œã£ã¦ã€‚æ—¥æœ¬èªè¨³ã‚‚ä½µè¨˜ã—ã¦ã€‚ã€</li>
        <li>ã€Œç§ã¯è£½é€ æ¥­ã®èª¿é”æ‹…å½“ã§ã€ã€‡ã€‡ã®èª¿é”ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚ãƒãƒªã‚·ãƒ¼ã¯Ã—Ã—ã§ã™ã€‚ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€è‡ªåˆ†ã®è·å‹™ã‚’è‹±èªã§è‡ªç„¶ã«èª¬æ˜ã™ã‚‹1åˆ†é–“ã®ã‚¹ãƒ”ãƒ¼ãƒã‚’ä½œã£ã¦ã€‚æ—¥æœ¬èªè¨³ã‚‚ã¤ã‘ã¦ãã ã•ã„ã€‚ã€</li>
        <li>ã€Œç§ã¯ä¼‘æ—¥ã«ã€ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚’æ¥½ã—ã¿ã€ã‚µã‚¦ãƒŠã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹ã“ã¨ãŒè¶£å‘³ã§ã™ã€‚ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€45ç§’ä»¥å†…ã®è‹±èªã‚¹ãƒ”ãƒ¼ãƒã‚’æ—¥æœ¬èªè¨³ä»˜ãã§ä½œæˆã—ã¦ã€‚ã€</li>
        <li>ã€Œè‡ªå·±ç´¹ä»‹ãƒ»è¶£å‘³ãƒ»ä»•äº‹ãƒ»å®¶æ—ã‚’ãƒ†ãƒ¼ãƒã«ã€TOEIC Speakingç·´ç¿’ç”¨ã®ã‚¹ãƒ”ãƒ¼ãƒä¾‹ã‚’è‹±èªã¨æ—¥æœ¬èªã§ä½œæˆã—ã¦ã€‚ã€</li>
      </ul>
      <p>å¾—ã‚‰ã‚ŒãŸè‹±æ–‡ã¨å’Œè¨³ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã™ã‚Œã°ã€è‡ªå‹•ã§èª­ã¿ä¸Šã’ãƒ»ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ç·´ç¿’ãŒã§ãã¾ã™ã€‚</p>
    </div>

    <h4>1. ç™»éŒ²</h4>
    <ul>
      <li>å¿…é ˆé …ç›®ã¯ã€Œå ´é¢ã€ã¨ã€Œè‹±æ–‡ã€ã§ã™ã€‚</li>
      <li>ã€Œå ´é¢ï¼ˆSceneï¼‰ã€ã«ã¯ã€ã„ã¤ãƒ»ã©ã‚“ãªçŠ¶æ³ã§ä½¿ã†è‹±æ–‡ã‹ã‚’ç°¡æ½”ã«æ›¸ãã¾ã™ï¼ˆä¾‹ï¼šã€Œä¼šè­°ã§è‡ªå·±ç´¹ä»‹ã™ã‚‹ã¨ãã€ï¼‰ã€‚</li>
      <li>ã€Œè‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰ã€ã«æœ¬æ–‡ã‚’å…¥åŠ›ã—ã€ã€Œä¿å­˜ã€ã€‚</li>
      <li>ã€Œâ–¶ï¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿã€ã§éŸ³å£°ç¢ºèªã§ãã¾ã™ã€‚<br>
          ãªãŠã€iOSã§ã¯ç™ºè©±ãŒã‚„ã‚„ãã“ã¡ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</li>
    </ul>

    <h4>2. ä¸€è¦§</h4>
    <ul>
      <li>æ¤œç´¢ã‚„ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿å¯èƒ½ã€‚</li>
      <li>ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ç”»é¢ãŒé–‹ãã¾ã™ã€‚</li>
      <li>å³ä¸Šã®ã€ŒExportã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ã€ŒImportã€ã§ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚‚ã§ãã¾ã™ã€‚</li>
    </ul>

    <h4>3. è©³ç´°ï¼ˆå€‹åˆ¥ãƒˆãƒ”ãƒƒã‚¯ï¼‰</h4>
    <ul>
      <li>â–¶ï¸ å†ç”Ÿï¼â¸ ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ï¼âœ ç·¨é›†ï¼ğŸ—‘ å‰Šé™¤</li>
      <li>é–‰ã˜ã‚‹ã¨ãã¯ç™ºè©±ã‚’è‡ªå‹•åœæ­¢ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚è§£é™¤ã•ã‚Œã¾ã™ã€‚</li>
      <li>ç·¨é›†å¾Œã¯ã€Œæ›´æ–°ã—ã¾ã—ãŸã€ã¨è¡¨ç¤ºã•ã‚Œã€ä¸€è¦§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</li>
    </ul>

    <h4>4. ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°</h4>
    <ul>
      <li>ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã€ãƒœã‚¿ãƒ³ã‹ã‚‰é–‹å§‹ã€‚ç™»éŒ²æ¸ˆã¿è‹±æ–‡ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è‡ªå‹•å†ç”Ÿã€‚</li>
      <li>è‹±æ–‡ã¯å˜èªã”ã¨ã«èµ¤ããƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€‚</li>
      <li><strong>é€Ÿåº¦èª¿æ•´ï¼ˆâˆ’/ï¼‹ï¼‰</strong>ã¯ã€ãã®ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°<span style="text-decoration:underline">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶šãé–“</span>ã¯å„å›ã®ç™ºè©±ã«å¼•ãç¶™ãŒã‚Œã¾ã™ï¼ˆè¨­å®šã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚</li>
      <li>ã€Œâ¸ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ã€ã€Œâ©æ¬¡ã®è‹±æ–‡ã€ã§ãƒ†ãƒ³ãƒã‚ˆãç·´ç¿’å¯èƒ½ã€‚</li>
      <li>çµ‚äº†æ™‚ã¯è‡ªå‹•ã§èª­ã¿ä¸Šã’ãŒåœæ­¢ã—ã¾ã™ã€‚</li>
    </ul>

    <h3>å­¦ç¿’ã®ã‚³ãƒ„ï¼ˆTOEIC Speakingï¼‰</h3>
    <ul>
      <li>1æ–‡1å ´é¢ä¸»ç¾©ï¼š1ã¤ã®ã‚·ãƒ¼ãƒ³ã«1ã¤ã®è‹±æ–‡ã‚’ç™»éŒ²ã€‚çŠ¶æ³ã¨ã‚»ãƒƒãƒˆã§è¦šãˆã‚„ã™ã„ã€‚</li>
      <li>éŸ³èª­â†’ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°â†’ã‚¹ãƒ”ãƒ¼ãƒåŒ–ï¼š1ã¤ã®ç´ æã‚’3æ®µéšã§ç¹°ã‚Šè¿”ã™ã€‚</li>
      <li>ã€Œ1åˆ†ä»¥å†…ã€ã‚’æ„è­˜ï¼šTOEIC Speakingã§ã¯60ç§’ãŒç›®å®‰ã€‚</li>
      <li>ã‚¿ã‚°æ´»ç”¨ï¼šã€Œä¾é ¼ã€ã€Œèª¬æ˜ã€ã€Œææ¡ˆã€ã€ŒåŒæ„ã€ãªã©æ©Ÿèƒ½åˆ¥ã‚¿ã‚°ã‚’ä½¿ã†ã¨æ•´ç†ã—ã‚„ã™ã„ã€‚</li>
      <li>é€Ÿåº¦ç·´ç¿’ï¼šæœ€åˆã¯0.8Ã—ã€œ1.0Ã—ã€æ…£ã‚ŒãŸã‚‰1.2Ã—ã§æŒ‘æˆ¦ã€‚</li>
    </ul>

    <h3>ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h3>
    <ul>
      <li>Exportï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦ä¿å­˜ï¼ˆä¾‹ï¼šspeaknote_backup_2025-11-03.jsonï¼‰ã€‚</li>
      <li>Importï¼šä»–ç«¯æœ«ãƒ»ä»–ãƒ–ãƒ©ã‚¦ã‚¶ã¸ç§»è¡Œå¯èƒ½ï¼ˆé‡è¤‡ã¯è‡ªå‹•ã§åˆ¥IDè¿½åŠ ï¼‰ã€‚</li>
      <li>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼šãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã€ã‚µãƒ¼ãƒã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</li>
    </ul>

    <h3>ãƒˆãƒ©ãƒ–ãƒ«å¯¾å‡¦</h3>
    <ul>
      <li><strong>éŸ³ãŒå‡ºãªã„ï¼š</strong>è¨­å®šã§Voiceã‚’å†é¸æŠ â†’ ä¿å­˜ã€‚ç«¯æœ«ã®æ¶ˆéŸ³ã‚¹ã‚¤ãƒƒãƒã‚„éŸ³é‡è¨­å®šã‚’ç¢ºèªã€‚iPhoneã§ã¯æœ€åˆã«ãƒœã‚¿ãƒ³ã‚’ä¸€åº¦æŠ¼ã—ã¦éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ã€‚</li>
      <li><strong>å†ç”ŸãŒé€”ä¸­ã§æ­¢ã¾ã‚‹ï¼é£›ã¶ï¼š</strong>è‡ªå‹•å†è©¦è¡Œæ©Ÿèƒ½ãŒåƒãã®ã§ã€å†åº¦â–¶ï¸å†ç”Ÿã§å¾©å¸°ã—ã¾ã™ã€‚</li>
      <li><strong>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ï¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œãªã„ï¼š</strong>é•·æ–‡ã§ã¯é…å»¶ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚â¸â†’å†é–‹ã§å¾©å¸°ã€‚</li>
    </ul>

    <h3>æ¨å¥¨æ´»ç”¨ä¾‹</h3>
    <ul>
      <li>å¹³æ—¥ï¼šé€šå‹¤ä¸­ã«ã€Œã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°ã€ã‚’3ä»¶ã€‚</li>
      <li>é€±æœ«ï¼šè‹¦æ‰‹ã‚¿ã‚°ï¼ˆä¾‹ï¼šã€Œææ¡ˆã€ã€Œå ±å‘Šã€ï¼‰ã‚’é›†ä¸­ç·´ç¿’ã€‚</li>
      <li>æœˆæœ«ï¼šExportã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã€AIã§æ–°ã—ã„ä¾‹æ–‡ã‚’ç”Ÿæˆã—ã¦è¿½åŠ ã€‚</li>
    </ul>
  </div>
  <div class="actions">
    <button class="btn right" id="help-close">é–‰ã˜ã‚‹</button>
  </div>
</dialog>

<dialog id="dlg-lookup" aria-labelledby="lk-title">
  <h3 id="lk-title" style="margin:0 0 6px">å˜èªæ¤œç´¢</h3>
  <div id="lk-body" class="lookup-body">å˜èªã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div class="actions">
    <a id="lk-google" class="btn" target="_blank" rel="noopener">Google</a>
    <a id="lk-cambridge" class="btn" target="_blank" rel="noopener">Cambridge</a>
    <a id="lk-longman" class="btn" target="_blank" rel="noopener">Longman</a>
    <button class="btn right" id="lk-close">é–‰ã˜ã‚‹</button>
  </div>
</dialog>

<footer>(C)Hisashi Fujinaka All Rights Reserved. All Code is generated by AI.</footer>

<script>
/* ====== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>crypto.randomUUID();
const now = ()=>Date.now();
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isAndroid = /Android/i.test(navigator.userAgent);

let playSession = 0;
function stopAllPlayback(){
  playSession++;
  try { speechSynthesis.cancel(); } catch(_) {}
  try {
    if (speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
    if (speechSynthesis.paused) speechSynthesis.resume();
    speechSynthesis.cancel();
  } catch(_) {}
  try {
    const u = new SpeechSynthesisUtterance(' ');
    u.volume = 0.001; u.rate = 2.0; u.lang = 'en-US';
    u.onend = ()=> { try { speechSynthesis.cancel(); } catch(_) {} };
    setTimeout(()=>{ try { speechSynthesis.speak(u); } catch(_) {} }, 16);
  } catch(_) {}
}

/* ====== Wake Lock ====== */
const KeepAwake = (()=>{
  let wakeLock=null, enabled=false, videoEl=null, canvas=null, stream=null;
  async function requestWakeLock(){ if(!('wakeLock' in navigator)) throw new Error('no_wakelock'); wakeLock = await navigator.wakeLock.request('screen'); }
  function ensureVideoNode(){ if(videoEl) return; videoEl=document.createElement('video'); videoEl.muted=true; videoEl.loop=true; videoEl.playsInline=true; Object.assign(videoEl.style,{position:'fixed',width:'1px',height:'1px',left:'-9999px',top:'-9999px'}); document.body.appendChild(videoEl); }
  function ensureCanvasStream(){ if(canvas&&stream) return; canvas=document.createElement('canvas'); canvas.width=1; canvas.height=1; const ctx=canvas.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,1,1); stream=canvas.captureStream(1); }
  async function startVideoFallback(){ ensureVideoNode(); ensureCanvasStream(); try{ if(videoEl.srcObject!==stream) videoEl.srcObject=stream; await videoEl.play(); }catch(e){} }
  async function enable(){ if(enabled) return; enabled=true; try{ await requestWakeLock(); document.addEventListener('visibilitychange', reAcquire, false); }catch(e){ await startVideoFallback(); document.addEventListener('visibilitychange', ensureVideoResume, false); } }
  async function reAcquire(){ if(document.visibilityState==='visible' && enabled){ try{ if(wakeLock?.released) await requestWakeLock(); }catch(e){} } }
  async function ensureVideoResume(){ if(document.visibilityState==='visible' && enabled && videoEl && videoEl.paused){ try{ await videoEl.play(); }catch(e){} } }
  async function disable(){ enabled=false; document.removeEventListener('visibilitychange', reAcquire, false); document.removeEventListener('visibilitychange', ensureVideoResume, false); try{ await wakeLock?.release(); }catch(e){} wakeLock=null; if(videoEl){ try{ videoEl.pause(); }catch(e){} } }
  return { enable, disable };
})();

/* ====== è¨­å®š ====== */
const LS_SETTINGS='speakscene_settings_v1';
const defaultSettings={ ttsLang:'en-US', voiceName:'', rate:1.0, pitch:1.0, volume:1.0, gapSec:1.0, repeat:1, speakTarget:'en', keepAwake:false };
let settings = loadSettings();
function loadSettings(){ try{ return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}')); }catch(e){ return {...defaultSettings}; } }
function saveSettings(){ localStorage.setItem(LS_SETTINGS, JSON.stringify(settings)); }

/* ====== IndexedDB ====== */
const DB_NAME='speakscene_db', DB_VER=1, STORE='sentences';
let db;
openDB();
function openDB(){
  const req = indexedDB.open(DB_NAME, DB_VER);
  req.onupgradeneeded = e=>{
    const db = e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      const os = db.createObjectStore(STORE,{keyPath:'id'});
      os.createIndex('createdAt','createdAt'); os.createIndex('updatedAt','updatedAt');
      os.createIndex('english','english'); os.createIndex('playCount','playCount');
    }
  };
  req.onsuccess = e=>{ db = e.target.result; refreshList(); fillCategoryFilter(); };
  req.onerror = e=>{ console.error('DB open error', e); alert('DBåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'); };
}
function store(mode='readonly'){ return db.transaction([STORE], mode).objectStore(STORE); }
const addSentence = item => new Promise(res=> store('readwrite').add(item).onsuccess=()=>res());
const updateSentence = item => new Promise(res=> store('readwrite').put(item).onsuccess=()=>res());
const deleteSentence = id => new Promise(res=> store('readwrite').delete(id).onsuccess=()=>res());
const getAll = ()=> new Promise((res,rej)=>{ const r=store().getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=rej; });
const getOne = id => new Promise((res,rej)=>{ const r=store().get(id); r.onsuccess=()=>res(r.result||null); r.onerror=rej; });

/* ====== ç”»é¢é·ç§» ====== */
const views = { create: $('#view-create'), list: $('#view-list'), shadow: $('#view-shadow') };
function closeAllDialogs(){ try{$('#dlg-detail')?.open&&$('#dlg-detail').close();}catch(_){} try{$('#dlg-settings')?.open&&$('#dlg-settings').close();}catch(_){} try{$('#dlg-help')?.open&&$('#dlg-help').close();}catch(_){} try{$('#dlg-lookup')?.open&&$('#dlg-lookup').close();}catch(_){} }
function show(view){ stopAllPlayback(); KeepAwake.disable(); closeAllDialogs(); Object.values(views).forEach(v=>v.classList.remove('active')); views[view].classList.add('active'); }
$('#nav-create').onclick = () => { setActiveNav('nav-create'); show('create'); };
$('#nav-list').onclick   = () => { setActiveNav('nav-list');   show('list'); refreshList(); };
$('#nav-settings').onclick = () => { stopAllPlayback(); setActiveNav(); $('#dlg-settings').showModal(); openSettingsFields(); };
$('#nav-help').onclick = () => { stopAllPlayback(); $('#dlg-help').showModal(); };
$('#help-close')?.addEventListener('click', ()=>{ stopAllPlayback(); $('#dlg-help').close(); });
$('#nav-shadow').onclick = () => { setActiveNav('nav-shadow'); prepareShadow(); show('shadow'); };
function setActiveNav(id){ $$('nav button').forEach(b=>b.classList.remove('active')); if(id) $('#'+id).classList.add('active'); }

/* ====== ç™»éŒ²ç”»é¢ ====== */
function defaultSaveHandler(){
  $('#btn-save').onclick = async ()=>{
    const scene = $('#scene').value.trim();
    const english = $('#en').value.trim();
    if(!scene){ alert('ã€Œå ´é¢ã€ã¯å¿…é ˆã§ã™'); return; }
    if(!english && !$('#ja').value.trim()){
      if(!confirm('è‹±æ–‡ã¨å’Œè¨³ãŒæœªå…¥åŠ›ã§ã™ã€‚ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
    }
    const item = collectFormToItem();
    item.id = uid(); item.createdAt = now(); item.updatedAt = now();
    item.favorite=false; item.playCount=0;
    await addSentence(item);
    clearForm(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
    fillCategoryFilter(); refreshList();
    setActiveNav('nav-list'); show('list');
  };
}
function collectFormToItem(base={}){
  const scene = $('#scene').value.trim();
  const english = $('#en').value.trim();
  const japanese = $('#ja').value.trim();
  const categories = Array.from($('#cats').selectedOptions).map(o=>o.value);
  const tags = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const notes = $('#notes').value.trim();
  return Object.assign(base, { scene, english, japanese, categories, tags, notes });
}
function clearForm(){ ['scene','en','ja','tags','notes'].forEach(id=>$('#'+id).value=''); Array.from($('#cats').options).forEach(o=>o.selected=false); const pv=$('#preview-en'); pv.classList.add('hidden'); pv.innerHTML=''; }
$('#btn-clear').onclick = ()=> clearForm();

/* ====== ãƒã‚¤ãƒ©ã‚¤ãƒˆ ====== */
function tokenizeWords(text){ const tokens=[]; if(!text) return tokens; const re=/\S+/g; let m; while((m=re.exec(text))!==null){ tokens.push({text:m[0], start:m.index, end:m.index+m[0].length}); } return tokens; }
function renderSpeakText(container, text){
  container.innerHTML = ''; container.classList.add('speak-text');
  const tokens = tokenizeWords(text);
  if(tokens.length===0){ container.textContent = text||''; container._tokens=[]; return; }
  let html='', cursor=0;
  for(const t of tokens){
    if(cursor<t.start) html += escapeHTML(text.slice(cursor, t.start));
    html += `<span class="w" data-start="${t.start}" data-end="${t.end}">${escapeHTML(t.text)}</span><wbr>`;
    cursor=t.end;
  }
  if(cursor<text.length) html += escapeHTML(text.slice(cursor));
  container.innerHTML = html; container._tokens = tokens; container._lastKey=null;
}
function clearHighlight(container){ container?.querySelectorAll('.w.hl').forEach(el=>el.classList.remove('hl')); }
let _scrollLock=false;
function scrollIntoViewIfNeeded(el, container){
  if(!el||!container||_scrollLock) return;
  _scrollLock=true;
  requestAnimationFrame(()=>{
    try{
      const cRect=container.getBoundingClientRect(); const eRect=el.getBoundingClientRect(); const pad=8;
      if(eRect.top<cRect.top+pad || eRect.bottom>cRect.bottom-pad){ el.scrollIntoView({block:'center', inline:'nearest', behavior:'smooth'}); }
    }finally{ setTimeout(()=>{ _scrollLock=false; },60); }
  });
}
function highlightToken(container, token){
  const key=token.start+'-'+token.end; if(container._lastKey===key) return;
  container._lastKey=key;
  clearHighlight(container);
  const el=container.querySelector(`.w[data-start="${token.start}"][data-end="${token.end}"]`);
  if(el){ el.classList.add('hl'); scrollIntoViewIfNeeded(el, container); }
}
function highlightAtCharIndex(container, charIndex){
  if(!container||!container._tokens) return; const tokens=container._tokens; if(tokens.length===0) return;
  let idx=-1; for(let i=0;i<tokens.length;i++){ const t=tokens[i]; if(charIndex>=t.start && charIndex<t.end){ idx=i; break; } if(charIndex<t.start){ idx=i-1; break; } }
  if(idx<0) idx=0; highlightToken(container, tokens[idx]);
}

/* ====== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ====== */
$('#btn-preview').onclick = async ()=>{
  const mySession = ++playSession;
  const en = ($('#en').value.trim() || '').substring(0,400);
  const ja = $('#ja').value.trim();
  if(!en && !ja){ alert('è‹±èªä¾‹æ–‡ã‹å’Œè¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const cont = $('#preview-en');
  renderSpeakText(cont, en); cont.classList.remove('hidden'); cont.scrollTop = 0;
  await loadVoices().catch(()=>{});
  await ensureTtsUnlocked();
  await new Promise(r=>setTimeout(r, 60));
  await speakFlowWithRetry({english: en, japanese: ja}, {targetEl: cont, session: mySession});
};
$('#btn-pause-preview').onclick = ()=> togglePause();
defaultSaveHandler();

/* ====== ä¸€è¦§ã¨ã‚«ãƒ¼ãƒ‰ ====== */
const fCat=$('#f-cat'), fTag=$('#f-tag'), q=$('#q');
[fCat,fTag,q].forEach(el=> el.oninput = ()=>refreshList());
async function fillCategoryFilter(){
  const rows = await getAll();
  const cats = new Set(); rows.forEach(r=>(r.categories||[]).forEach(c=>cats.add(c)));
  fCat.innerHTML = `<option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option>` + Array.from(cats).sort().map(c=>`<option>${escapeHTML(c)}</option>`).join('');
}
async function refreshList(){
  if(!db) return;
  const rows = await getAll();
  const kw = q.value.trim().toLowerCase();
  const cat = fCat.value;
  const tagkw = fTag.value.trim().toLowerCase();
  let list = rows.filter(r=>{
    if(cat && !(r.categories||[]).includes(cat)) return false;
    if(tagkw && !(r.tags||[]).some(t=>t.toLowerCase().includes(tagkw))) return false;
    if(kw){
      const hay = [r.scene,(r.tags||[]).join(' '),(r.categories||[]).join(' ')].join(' ').toLowerCase();
      if(!hay.includes(kw)) return false;
    }
    return true;
  }).sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
  renderCards(list);
}
function renderCards(list){
  const root=$('#cards'); root.innerHTML='';
  if(list.length===0){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = '<div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®<strong>ç™»éŒ²</strong>ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    root.appendChild(div); return;
  }
  for(const r of list){
    const card=document.createElement('div'); card.className='card';
    const cats=(r.categories||[]).map(c=>`<span class="chip">${escapeHTML(c)}</span>`).join(' ');
    const tags=(r.tags||[]).map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join(' ');
    card.innerHTML = `<h3>${escapeHTML(r.scene || '(å ´é¢æœªè¨­å®š)')}</h3><div class="chips">${cats}</div><div class="chips" style="margin-top:4px">${tags}</div>`;
    card.onclick = ()=> openDetail(r.id);
    root.appendChild(card);
  }
}

/* ====== éŒ²éŸ³ï¼ˆè©³ç´°ç”»é¢ï½œã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šã€çµ±åˆãƒˆã‚°ãƒ«ï¼‰ ====== */
const recState = { mediaRecorder:null, chunks:[], stream:null, url:null, startedAt:0, timerId:null, mime:'' , mode:'idle', longPressTimer:null};
function formatMs(ms){ const s = Math.floor(ms/1000); const m = Math.floor(s/60); const ss = String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
function pickAudioMime(){
  try{
    if (window.MediaRecorder && typeof MediaRecorder.isTypeSupported === 'function'){
      // Safariå„ªå…ˆï¼šmp4
      if (MediaRecorder.isTypeSupported('audio/mp4'))  return 'audio/mp4';
      if (MediaRecorder.isTypeSupported('audio/webm')) return 'audio/webm';
      if (MediaRecorder.isTypeSupported('audio/ogg'))  return 'audio/ogg';
    }
  }catch(_){}
  return '';
}
function stopRecTimer(){ if(recState.timerId){ clearInterval(recState.timerId); recState.timerId = null; } }
function setRecDeleteVisible(v){ $('#d-rec-delete').classList.toggle('hidden', !v); }
function setRecToggleLabel({mode}){
  recState.mode = mode; const b=$('#d-rec-toggle');
  b.classList.remove('recording');
  if(mode==='recording'){ b.textContent='â–  STOP'; b.classList.add('recording'); }
  else if(mode==='playable'){ b.textContent='â–¶ï¸ RECå†ç”Ÿ'; }
  else { b.textContent='â— REC'; }
}
function clearRecBlob(){
  try{ $('#d-rec-audio').pause(); }catch(_){}
  if(recState.url){ try{ URL.revokeObjectURL(recState.url); }catch(_){ } recState.url=null; }
  setRecDeleteVisible(false);
}

/* ====== å†ç”Ÿãƒˆã‚°ãƒ«ï¼ˆå…±é€šUIãƒ˜ãƒ«ãƒ‘ï¼‰ ====== */
function setToggleLabel(btn, state){
  // state: 'idle'|'playing'|'paused'
  if(!btn) return;
  if(state==='playing'){ btn.textContent='â¸ ä¸€æ™‚åœæ­¢'; btn.classList.add('ok'); }
  else if(state==='paused'){ btn.textContent='â–¶ï¸ å†é–‹'; btn.classList.remove('ok'); }
  else { btn.textContent='â–¶ï¸ å†ç”Ÿ'; btn.classList.remove('ok'); }
}

/* ====== è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ====== */
let currentDetailId=null;
let detailPlayState='idle'; // 'idle' | 'playing' | 'paused'
async function openDetail(id){
  const row=await getOne(id); if(!row) return;
  currentDetailId=id;
  $('#d-scene').textContent=row.scene||'(å ´é¢æœªè¨­å®š)';
  const meta=[];
  if(row.categories?.length) meta.push(...row.categories.map(c=>`<span class="flag">${escapeHTML(c)}</span>`));
  meta.push(`<span class="flag">å†ç”Ÿ ${row.playCount||0}</span>`);
  $('#d-meta').innerHTML=meta.join(' ');

  renderSpeakText($('#d-en'), row.english||''); $('#d-en').scrollTop=0;
  $('#d-ja').textContent=row.japanese||'';
  $('#dlg-detail').showModal();

  // REC UIåˆæœŸåŒ–
  if (recState.url) { clearRecBlob(); }
  stopRecTimer();
  $('#d-rec-timer').textContent='';
  setRecToggleLabel({mode:'idle'});
  setRecDeleteVisible(false);
  detailPlayState='idle';
  setToggleLabel($('#d-toggle'),'idle');

  // å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒˆã‚°ãƒ«ï¼ˆæœ¬æ–‡ï¼‰
  $('#d-toggle').onclick = async ()=>{
    const btn = $('#d-toggle');
    const targetEl = $('#d-en');

    if(detailPlayState==='idle'){
      renderSpeakText(targetEl, row.english||''); targetEl.scrollTop=0;
      if (isAndroid){
        androidGestureSpeak(row, targetEl, async ()=>{
          if(detailPlayState!=='paused'){ detailPlayState='idle'; setToggleLabel(btn,'idle'); }
          const fresh = await getOne(currentDetailId); if(fresh){
            fresh.playCount=(fresh.playCount||0)+1; fresh.updatedAt=now(); await updateSentence(fresh);
            const m=[]; if(fresh.categories?.length) m.push(...fresh.categories.map(c=>`<span class="flag">${escapeHTML(c)}</span>`));
            m.push(`<span class="flag">å†ç”Ÿ ${fresh.playCount}</span>`); $('#d-meta').innerHTML=m.join(' ');
          }
        });
        detailPlayState='playing'; setToggleLabel(btn,'playing');
      } else {
        (async ()=>{
          const mySession = ++playSession;
          await loadVoices().catch(()=>{});
          await ensureTtsUnlocked();
          await new Promise(r=>setTimeout(r, 60));
          detailPlayState='playing'; setToggleLabel(btn,'playing');
          await speakFlowWithRetry(row, {targetEl, session: mySession});
          if (mySession!==playSession) return;
          if(detailPlayState!=='paused'){ detailPlayState='idle'; setToggleLabel(btn,'idle'); }
          row.playCount=(row.playCount||0)+1; row.updatedAt=now(); await updateSentence(row);
          const m=[]; if(row.categories?.length) m.push(...row.categories.map(c=>`<span class="flag">${escapeHTML(c)}</span>`));
          m.push(`<span class="flag">å†ç”Ÿ ${row.playCount}</span>`); $('#d-meta').innerHTML=m.join(' ');
        })();
      }
    }else if(detailPlayState==='playing'){
      try{ speechSynthesis.pause(); }catch(_){}
      detailPlayState='paused'; setToggleLabel(btn,'paused');
    }else{
      try{ speechSynthesis.resume(); }catch(_){}
      detailPlayState='playing'; setToggleLabel(btn,'playing');
    }
  };

  // ===== çµ±åˆRECãƒˆã‚°ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼šéŒ²éŸ³/åœæ­¢/å†ç”Ÿã€é•·æŠ¼ã—ï¼šã‚„ã‚Šç›´ã—ï¼‰ =====
  const recBtn = $('#d-rec-toggle');
  const delBtn = $('#d-rec-delete');

  function bindLongPress(){
    const start = (e)=>{
      if(recState.mode!=='playable') return;
      if(recState.longPressTimer) clearTimeout(recState.longPressTimer);
      recState.longPressTimer = setTimeout(()=>{ // é•·æŠ¼ã—ç¢ºå®š â†’ ã‚„ã‚Šç›´ã—
        try{ $('#d-rec-audio').pause(); }catch(_){}
        clearRecBlob();
        startRecording();
      }, 600);
    };
    const cancel = ()=>{ if(recState.longPressTimer){ clearTimeout(recState.longPressTimer); recState.longPressTimer=null; } };
    recBtn.addEventListener('mousedown', start);
    recBtn.addEventListener('touchstart', start, {passive:true});
    ['mouseup','mouseleave','touchend','touchcancel','click'].forEach(ev=> recBtn.addEventListener(ev, cancel));
  }

  async function startRecording(){
    stopAllPlayback();
    try{ $('#d-rec-audio').pause(); }catch(_){}
    if(!('MediaRecorder' in window)){
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²éŸ³ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chrome/Edge/Safariã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      return;
    }
    let stream=null;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    }catch(e){
      alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    const mime = pickAudioMime();
    const mr = new MediaRecorder(stream, mime ? {mimeType:mime} : undefined);
    recState.mediaRecorder = mr;
    recState.stream = stream;
    recState.chunks = [];
    recState.mime = mime;
    recState.startedAt = performance.now();
    $('#d-rec-timer').textContent = '0:00';
    stopRecTimer();
    recState.timerId = setInterval(()=>{ const ms = performance.now() - recState.startedAt; $('#d-rec-timer').textContent = formatMs(ms); }, 250);
    setRecToggleLabel({mode:'recording'});

    mr.ondataavailable = (ev)=>{ if(ev?.data && ev.data.size>0) recState.chunks.push(ev.data); };
    mr.onstop = async ()=>{
      // æœ€çµ‚ãƒãƒ£ãƒ³ã‚¯å¾…ã¡ï¼ˆå®‰å…¨ã«60ã€œ120msï¼‰
      await new Promise(r=>setTimeout(r, 100));
      stopRecTimer();
      const type = recState.mime || (mr.mimeType || 'audio/webm');
      const blob = new Blob(recState.chunks, { type });
      if(!blob.size){
        alert('éŒ²éŸ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ï¼ˆéŒ²éŸ³æ™‚é–“ãŒçŸ­ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰');
        try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){}
        recState.mediaRecorder=null; recState.stream=null; recState.chunks=[];
        setRecToggleLabel({mode:'idle'}); setRecDeleteVisible(false); $('#d-rec-timer').textContent='';
        return;
      }
      // æ—¢å­˜URLã®ç ´æ£„â†’ç™ºè¡Œ
      clearRecBlob();
      recState.url = URL.createObjectURL(blob);
      $('#d-rec-audio').src = recState.url;
      setRecToggleLabel({mode:'playable'});
      setRecDeleteVisible(true);

      try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){}
      recState.mediaRecorder=null; recState.stream=null; recState.chunks=[];
    };

    // ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ã‚¹ç„¡ã—ã§é–‹å§‹ï¼ˆstopæ™‚ã«1å›dataavailableï¼‰
    mr.start();
  }

  function stopRecording(){
    const mr = recState.mediaRecorder;
    if(!mr || mr.state!=='recording') return;
    // çŸ­ã™ãã‚‹åœæ­¢ã¯ç„¡è¦–ï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼‰
    if (performance.now() - recState.startedAt < 400) return;
    try{ mr.requestData(); }catch(_){}
    try{ mr.stop(); }catch(_){}
  }

  async function playRecording(){
    stopAllPlayback();
    const audio = $('#d-rec-audio');
    if(!recState.url){
      alert('éŒ²éŸ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      setRecToggleLabel({mode:'idle'}); setRecDeleteVisible(false); return;
    }
    try{ audio.src = recState.url; await audio.play(); }catch(e){ alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
  }

  recBtn.onclick = ()=>{
    if(recState.mode==='idle'){ startRecording(); }
    else if(recState.mode==='recording'){ stopRecording(); }
    else{ playRecording(); }
  };
  bindLongPress();

  // éŒ²éŸ³ã®å‰Šé™¤ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šï¼‰
  delBtn.onclick = ()=>{
    clearRecBlob();
    setRecToggleLabel({mode:'idle'});
    $('#d-rec-timer').textContent='';
  };

  // ç·¨é›†/å‰Šé™¤/é–‰ã˜ã‚‹
  $('#d-edit').onclick = ()=>{
    stopAllPlayback();
    $('#dlg-detail').close();
    setActiveNav('nav-create'); show('create');
    getOne(id).then(row=>{
      if(!row) return;
      $('#scene').value=row.scene||''; $('#en').value=row.english||''; $('#ja').value=row.japanese||''; 
      Array.from($('#cats').options).forEach(o=>o.selected=(row.categories||[]).includes(o.value));
      $('#tags').value=(row.tags||[]).join(', '); $('#notes').value=row.notes||'';
      $('#btn-save').onclick = async ()=>{
        const scene=$('#scene').value.trim(); if(!scene){ alert('ã€Œå ´é¢ã€ã¯å¿…é ˆã§ã™'); return; }
        collectFormToItem(row); row.updatedAt=now(); await updateSentence(row);
        alert('æ›´æ–°ã—ã¾ã—ãŸ'); defaultSaveHandler(); clearForm(); setActiveNav('nav-list'); show('list'); refreshList(); fillCategoryFilter();
      };
    });
  };
  $('#d-del').onclick = async ()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ stopAllPlayback(); await deleteSentence(id); $('#dlg-detail').close(); refreshList(); fillCategoryFilter(); } };
  $('#d-close').onclick = ()=>{ stopAllPlayback(); $('#dlg-detail').close(); };
}
$('#dlg-detail').addEventListener('close', ()=>{
  stopAllPlayback();
  clearHighlight($('#d-en'));
  try{ const a=$('#d-rec-audio'); if(a){ a.pause(); a.src=''; } }catch(_){}
  stopRecTimer();
  try{ if(recState.stream){ recState.stream.getTracks().forEach(t=>t.stop()); } }catch(_){}
  clearRecBlob();
  recState.mediaRecorder=null; recState.chunks=[]; recState.stream=null; recState.mode='idle'; $('#d-rec-timer').textContent='';
  detailPlayState='idle'; setToggleLabel($('#d-toggle'),'idle');
});

/* ====== Export/Import ====== */
$('#btn-export').onclick = async ()=>{
  const data = await getAll();
  const safe = data.map(({recBlob,recType,recDurationMs,recUpdatedAt,recExpiresAt, ...rest})=>rest);
  const blob = new Blob([JSON.stringify({sentences:safe},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `speaknote_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
};
$('#file-import').onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  try{
    const json = JSON.parse(text);
    if(!json.sentences || Array.isArray(json.sentences)===false) throw new Error('format');
    if(!confirm(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã¨é‡è¤‡ã™ã‚‹å ´åˆã¯æ–°è¦IDã§è¿½åŠ ã—ã¾ã™ã€‚`)) return;
    for(const r of json.sentences){
      const item = {
        id: uid(), english: r.english||'', japanese: r.japanese||'', scene: r.scene||'',
        categories: Array.isArray(r.categories)? r.categories:[], tags: Array.isArray(r.tags)? r.tags:[],
        notes: r.notes||'', favorite: !!r.favorite, playCount: Number(r.playCount||0),
        createdAt: now(), updatedAt: now()
      };
      await addSentence(item);
    }
    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); fillCategoryFilter(); refreshList();
  }catch(err){ alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™'); }
  finally{ e.target.value=''; }
};

/* ====== TTS ====== */
let voices=[]; let ttsWarmed=false; let audioCtx=null;
let androidNoEnglishVoice=false;
speechSynthesis.onvoiceschanged = ()=> loadVoices();

function findAndroidEnglishVoices(list){
  const enCandidates = (list||[]).filter(v=>/^en(-|_)?/i.test(v.lang||'') || /English/i.test(v.name||''));
  const google = enCandidates.filter(v=>/Google/i.test(v.name||''));
  return google.length ? google : enCandidates;
}
async function loadVoices(){
  voices = speechSynthesis.getVoices() || [];
  if (!voices.length) {
    for (let i=0; i<10 && (!voices || voices.length===0); i++){
      await new Promise(r=>setTimeout(r,100));
      voices = speechSynthesis.getVoices() || [];
    }
  }
  if(!settings.voiceName){
    if(isIOS){
      const samantha = voices.find(v=>/Samantha/i.test(v.name) && /^en-US/i.test(v.lang));
      if(samantha){ settings.voiceName=samantha.name; settings.ttsLang='en-US'; }
    }else if(isAndroid){
      const picks = findAndroidEnglishVoices(voices);
      if(picks.length){ settings.voiceName = ''; settings.ttsLang = picks[0].lang || 'en-US'; androidNoEnglishVoice=false; }
      else{ settings.voiceName=''; settings.ttsLang='en-US'; androidNoEnglishVoice=true; }
    }else{
      const pref=[/Microsoft\s+Eric\s+Online.*Natural/i,/Microsoft\s+Aria\s+Online.*Natural/i,/Microsoft\s+Guy\s+Online.*Natural/i,/Microsoft\s+Jenny\s+Online.*Natural/i];
      let picked=null; for(const re of pref){ picked=voices.find(v=>re.test(v.name) && /^en-US/i.test(v.lang)); if(picked) break; }
      if(!picked){ picked=voices.find(v=>/^en-US/i.test(v.lang)) || voices.find(v=>v.default) || voices[0]; }
      if(picked){ settings.voiceName=picked.name; settings.ttsLang=picked.lang||'en-US'; }
    }
    saveSettings();
  }else{
    if(isAndroid){
      const exists = voices.some(v=>v.name===settings.voiceName);
      if(!exists){
        const picks = findAndroidEnglishVoices(voices);
        if(picks.length){ settings.voiceName=''; settings.ttsLang=picks[0].lang||'en-US'; androidNoEnglishVoice=false; }
        else{ settings.voiceName=''; settings.ttsLang='en-US'; androidNoEnglishVoice=true; }
        saveSettings();
      }
    }
  }
  renderVoiceList();
}
function renderVoiceList(){
  const sel=$('#voice'); if(!sel) return;
  const prev=settings.voiceName||''; sel.innerHTML='';
  const list=(voices||[]).slice().sort((a,b)=>(a.lang||'').localeCompare(b.lang||'')||(a.name||'').localeCompare(b.name||'')); 
  for(const v of list){ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})${v.default?' â˜…':''}`; sel.appendChild(opt); }
  sel.value = list.some(v=>v.name===prev) ? prev : (list[0]?.name || '');
}
function pickVoice(){
  if(!voices || voices.length===0) voices = speechSynthesis.getVoices() || [];
  if(isAndroid){ if(settings.voiceName){ const byName = voices.find(v=>v.name===settings.voiceName); if(byName) return byName; else return null; } return null; }
  if(settings.voiceName){ const byName = voices.find(v=>v.name===settings.voiceName); if(byName) return byName; }
  if(isIOS){ const s=voices.find(v=>/Samantha/i.test(v.name) && /^en-US/i.test(v.lang)); if(s) return s; }
  const e=voices.find(v=>/Microsoft\s+Eric\s+Online.*Natural/i.test(v.name) && /^en-US/i.test(v.lang));
  if(e) return e;
  if(settings.ttsLang){ const byLang = voices.find(v=>v.lang && v.lang.startsWith(settings.ttsLang)); if(byLang) return byLang; }
  return voices.find(v=>v.default) || voices[0] || null;
}
function togglePause(){ try{ if(speechSynthesis.speaking && !speechSynthesis.paused){ speechSynthesis.pause(); } else { speechSynthesis.resume(); } }catch(e){} }

async function translateToJa(text){
  const src = (text||'').trim();
  if(!src) return '';
  try{
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(src)}&langpair=en|ja`;
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('translate http');
    const json = await res.json();
    const out = json?.responseData?.translatedText || '';
    return (out || src);
  }catch(e){
    return src;
  }
}

async function ensureTtsUnlocked(){
  if(ttsWarmed) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    gain.gain.value = 0.0001; osc.connect(gain).connect(audioCtx.destination); osc.start();
    setTimeout(()=>{ try{osc.stop();osc.disconnect();gain.disconnect();}catch(_){} }, 12);
  }catch(_){}
  try {
    try{ speechSynthesis.cancel(); }catch(e){}
    const v = pickVoice();
    const warm = new SpeechSynthesisUtterance('okay');
    if (v) warm.voice = v;
    warm.lang = v?.lang || settings.ttsLang || 'en-US';
    warm.rate = 1.0; warm.pitch = 1.0; warm.volume = 0.01;
    await new Promise(res=>{
      let done=false; const finish=()=>{ if(!done){ done=true; res(); } };
      warm.onend = finish; warm.onerror = finish;
      setTimeout(()=>{ try{ speechSynthesis.speak(warm); }catch(_){ finish(); } }, 80);
      setTimeout(finish, 1200);
    });
  } finally { ttsWarmed = true; }
}
function speak(text,{voice,rate,pitch,volume,targetEl}={}){
  return new Promise(async (res)=>{
    if(!text){ res(); return; }
    if(!voices || voices.length===0){ await loadVoices(); }
    const u=new SpeechSynthesisUtterance(text);
    const v=voice ?? pickVoice();
    if(v) u.voice=v;
    if(!u.lang){ u.lang = v?.lang || settings.ttsLang || (/[a-zA-Z]/.test(text) ? 'en-US' : 'ja-JP'); }
    u.rate=rate??settings.rate; u.pitch=pitch??settings.pitch; u.volume=volume??settings.volume;
    let fbTimer=null, usedBoundary=false;
    if(targetEl && /[A-Za-z]/.test(text)){
      u.onboundary=(e)=>{ if(typeof e.charIndex==='number'){ usedBoundary=true; highlightAtCharIndex(targetEl, e.charIndex); } };
      const tokens=(targetEl._tokens||tokenizeWords(text)); if(tokens.length>0){
        let idx=0; const wpm=170*(u.rate||1.0); const msPerWord=Math.max(120, Math.round(60000/wpm));
        fbTimer=setInterval(()=>{ if(usedBoundary){clearInterval(fbTimer);return;} if(idx>=tokens.length){clearInterval(fbTimer);return;}
          const t=tokens[Math.min(idx++, tokens.length-1)]; highlightAtCharIndex(targetEl, t.start); }, msPerWord);
      }
    }
    const cleanup=()=>{ if(fbTimer) clearInterval(fbTimer); if(targetEl) clearHighlight(targetEl); };
    u.onend = ()=>{ cleanup(); res(); };
    u.onerror=()=>{ cleanup(); res(); };
    try { speechSynthesis.cancel(); } catch(e){}
    setTimeout(()=>{ try { speechSynthesis.speak(u); } catch(e) { setTimeout(()=>{ try{ speechSynthesis.speak(u); }catch(_){ res(); } }, 120); } }, isAndroid ? 120 : 40);
  });
}
async function speakFlowWithRetry(row, opts = {}) {
  const begin = performance.now();
  const sessionAtStart = playSession;
  await speakFlow(row, opts);
  const dur = performance.now() - begin;
  if (sessionAtStart === playSession && dur < 150 && !speechSynthesis.speaking) {
    try { await loadVoices(); } catch(_) {}
    try { await ensureTtsUnlocked(); } catch(_) {}
    await new Promise(r => setTimeout(r, 120));
    if (sessionAtStart === playSession) { await speakFlow(row, opts); }
  }
}
async function speakFlow(row, opts={}){
  const mySession = opts.session ?? playSession;
  try{ speechSynthesis.resume(); }catch(e){}
  await ensureTtsUnlocked();
  if (mySession!==playSession) return;
  const en=(row.english||'').trim(); const ja=(row.japanese||'').trim();
  const gap=Math.max(0, Number(settings.gapSec||0))*1000; const rep=Math.max(1, parseInt(settings.repeat||1,10)); const tgt=settings.speakTarget||'en';
  const targetEl=opts.targetEl||null;
  if(tgt==='en'){
    if(targetEl){ renderSpeakText(targetEl, en); targetEl.scrollTop=0; }
    for(let i=0;i<rep;i++){
      if (mySession!==playSession) return;
      await speak(en,{targetEl});
      if (i<rep-1 && gap){ if (mySession!==playSession) return; await sleep(gap); }
    }
  }else if(tgt==='ja'){
    if (mySession!==playSession) return;
    await speak(ja);
  }else{
    if(targetEl){ renderSpeakText(targetEl, en); targetEl.scrollTop=0; }
    for(let i=0;i<rep;i++){
      if (mySession!==playSession) return;
      await speak(en,{targetEl});
      if (gap){ if (mySession!==playSession) return; await sleep(gap); }
    }
    if(ja){ if (mySession!==playSession) return; await speak(ja); }
  }
}

/* ====== Androidå‘ã‘ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å†ç”Ÿï¼ˆè©³ç´°ï¼‰ ====== */
function androidGestureSpeak(row, targetEl, onEnded){
  try{ speechSynthesis.cancel(); }catch(_){}
  try{
    if (window.AudioContext||window.webkitAudioContext){
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      audioCtx.resume?.();
    }
  }catch(_){}
  const warm = new SpeechSynthesisUtterance('ok');
  const langHint = settings.ttsLang || 'en-US';
  warm.lang = langHint || navigator.language || 'en-GB';
  warm.rate = 1.0; warm.pitch = 1.0; warm.volume = 0.01;
  let handed=false;
  warm.onend = function(){
    if(handed) return; handed=true;
    const mySession = ++playSession;
    speakFlowAndroid(row, {targetEl, session: mySession}, onEnded);
  };
  warm.onerror = warm.onend;
  try{ speechSynthesis.speak(warm); }catch(e){
    const mySession = ++playSession;
    speakFlowAndroid(row, {targetEl, session: mySession}, onEnded);
  }
}
function speakFlowAndroid(row, opts={}, onEnded){
  const mySession = opts.session ?? playSession;
  const en=(row.english||'').trim(); const ja=(row.japanese||'').trim();
  const gap=Math.max(0, Number(settings.gapSec||0))*1000; const rep=Math.max(1, parseInt(settings.repeat||1,10)); const tgt=settings.speakTarget||'en';
  const targetEl=opts.targetEl||null;
  function speakOne(text){
    return new Promise((resolve)=>{
      if(!text){ resolve(); return; }
      const u=new SpeechSynthesisUtterance(text);
      if (settings.voiceName) {
        const v = voices.find(vv=>vv.name===settings.voiceName);
        if (v) u.voice=v;
      }
      u.lang = settings.ttsLang || 'en-US';
      u.rate=settings.rate; u.pitch=settings.pitch; u.volume=settings.volume;
      let fbTimer=null, usedBoundary=false;
      if(targetEl && /[A-Za-z]/.test(text)){
        u.onboundary=(e)=>{ if(typeof e.charIndex==='number'){ usedBoundary=true; highlightAtCharIndex(targetEl, e.charIndex); } };
        const tokens=(targetEl._tokens||tokenizeWords(text)); if(tokens.length>0){
          let idx=0; const wpm=170*(u.rate||1.0); const msPerWord=Math.max(120, Math.round(60000/wpm));
          fbTimer=setInterval(()=>{ if(usedBoundary){clearInterval(fbTimer);return;} const absIdx=idx; if(absIdx>=tokens.length){clearInterval(fbTimer);return;} highlightAtCharIndex(targetEl, tokens[absIdx].start); idx++; }, msPerWord);
        }
      }
      const cleanup=()=>{ if(fbTimer) clearInterval(fbTimer); if(targetEl) clearHighlight(targetEl); };
      u.onend = ()=>{ cleanup(); resolve(); };
      u.onerror=()=>{ cleanup(); resolve(); };
      try{ speechSynthesis.speak(u); }catch(e){ resolve(); }
    });
  }
  (async ()=>{
    if (tgt==='en'){
      if(targetEl){ renderSpeakText(targetEl, en); targetEl.scrollTop=0; }
      for(let i=0;i<rep;i++){ if (mySession!==playSession) return;
        await speakOne(en); if(i<rep-1 && gap){ if (mySession!==playSession) return; await sleep(gap); }
      }
    }else if (tgt==='ja'){
      if (mySession!==playSession) return; await speakOne(ja);
    }else{
      if(targetEl){ renderSpeakText(targetEl, en); targetEl.scrollTop=0; }
      for(let i=0;i<rep;i++){ if (mySession!==playSession) return;
        await speakOne(en); if(gap){ if (mySession!==playSession) return; await sleep(gap); }
      }
      if(ja){ if (mySession!==playSession) return; await speakOne(ja); }
    }
    if(typeof onEnded==='function') onEnded();
  })();
}

/* ====== è¨­å®šUI ====== */
async function openSettingsFields(){ await loadVoices(); renderVoiceList(); fillSettingsFields(); $('#lang').onchange = ()=>{ settings.ttsLang=$('#lang').value||settings.ttsLang; saveSettings(); loadVoices(); renderVoiceList(); }; }
function fillSettingsFields(){
  $('#lang').value = settings.ttsLang||''; $('#rate').value = settings.rate; $('#pitch').value = settings.pitch;
  $('#volume').value = settings.volume; $('#gap').value = settings.gapSec; $('#repeat').value = settings.repeat; $('#speak-target').value = settings.speakTarget;
  $('#keep-awake').checked = !!settings.keepAwake;
}
$('#reset-standard').onclick = (ev)=>{ ev.preventDefault(); settings = { ...defaultSettings, voiceName: '' }; saveSettings(); loadVoices(); fillSettingsFields(); alert('æ¨™æº–è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸï¼ˆéŸ³å£°ã¯OSæ¨å¥¨ã«è‡ªå‹•è¨­å®šï¼‰ã€‚'); };
$('#save-settings').onclick = (ev)=>{
  ev.preventDefault();
  settings.ttsLang=$('#lang').value; settings.voiceName=$('#voice').value || settings.voiceName || '';
  settings.rate=Number($('#rate').value)||1.0; settings.pitch=Number($('#pitch').value)||1.0; settings.volume=Number($('#volume').value)||1.0;
  settings.gapSec=Number($('#gap').value)||0; settings.repeat=Math.max(1, parseInt($('#repeat').value||'1',10)); settings.speakTarget=$('#speak-target').value||'en';
  settings.keepAwake = !!$('#keep-awake').checked;
  const chosen=voices.find(v=>v.name===settings.voiceName); if(chosen&&chosen.lang&&chosen.lang!==settings.ttsLang){ settings.ttsLang=chosen.lang; }
  if(isAndroid){
    const picks = findAndroidEnglishVoices(voices);
    androidNoEnglishVoice = picks.length===0;
    if(androidNoEnglishVoice){ settings.voiceName=''; }
  }
  saveSettings(); renderVoiceList(); $('#dlg-settings').close(); alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
};

/* ====== ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚° ====== */
const sh = { list: [], index: 0, rate: 1.0, container: null, tokens: [], startCharOffset: 0, lastCharIndex: 0, restarting:false, glitchRetry:false, opened:false, state:'idle' };
async function prepareShadow(){
  const rows = await getAll();
  const pool = rows.filter(r=> (r.english||'').trim().length>0 );
  if(pool.length===0){ alert('è‹±èªä¾‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚'); setActiveNav('nav-create'); show('create'); return; }
  sh.list = pool.sort(()=>Math.random()-0.5);
  sh.index = 0; sh.rate = settings.rate || 1.0; sh.container = $('#sh-text'); sh.tokens=[]; sh.startCharOffset=0; sh.lastCharIndex=0;
  $('#rate-badge').textContent = (Math.round(sh.rate*10)/10).toFixed(1)+'Ã—';
  const row = sh.list[0];
  $('#sh-scene').textContent = 'å ´é¢ï¼š' + (row.scene || '(æœªè¨­å®š)');
  sh.opened = true; sh.state='idle'; setToggleLabel($('#sh-toggle'),'idle');
}
$('#sh-back').onclick = ()=>{ sh.opened=false; sh.restarting=false; sh.glitchRetry=false; stopAllPlayback(); KeepAwake.disable(); clearHighlight($('#sh-text')); $('#sh-text').textContent='(ã“ã“ã«ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)'; $('#sh-scene').textContent=''; setActiveNav('nav-list'); show('list'); refreshList(); };
function requestRestartFromCurrentPos(){ sh.restarting = true; try{ speechSynthesis.cancel(); }catch(e){} }
function handleEnded(natural=true){
  if (!sh.opened) return;
  if (sh.restarting){ sh.restarting = false; const base = sh.startCharOffset||0; const nextIdx = findTokenIndexAtChar(sh.tokens, base + (sh.lastCharIndex||0)); speakFromToken(nextIdx, false); return; }
  if (natural === 'glitch' && !sh.glitchRetry){ sh.glitchRetry = true; speakFromToken(0, true); return; }
  sh.glitchRetry = false; sh.index = (sh.index+1) % sh.list.length; const row = sh.list[sh.index]; $('#sh-scene').textContent = 'å ´é¢ï¼š' + (row.scene || '(æœªè¨­å®š)'); setTimeout(()=> playCurrent(), Math.max(0, Math.round((settings.gapSec||0)*1000)));
}
function findTokenIndexAtChar(tokens, absChar){ if(!tokens||tokens.length===0) return 0; let idx=0; for(let i=0;i<tokens.length;i++){ const t=tokens[i]; if(absChar>=t.start && absChar<t.end){ idx=i; break; } if(absChar<t.start){ idx=Math.max(0,i-1); break; } idx=i; } return idx; }
function speakFromToken(startTokenIdx, forceCancel){
  const row = sh.list[sh.index]; const text = (row.english||'').trim(); if(!text || !sh.opened) return;
  if(sh.tokens.length===0){ renderSpeakText(sh.container, text); sh.tokens = sh.container._tokens||[]; }
  const startChar = sh.tokens[startTokenIdx]?.start || 0; sh.startCharOffset = startChar; sh.lastCharIndex = 0; const tail = text.slice(startChar);
  const u = new SpeechSynthesisUtterance(tail);
  const v = pickVoice(); if(v) u.voice=v; u.lang = settings.ttsLang || 'en-US'; u.rate = sh.rate; u.pitch = settings.pitch; u.volume = settings.volume;
  let fbTimer=null, usedBoundary=false, startedAt=0; u.onstart=()=>{ startedAt = performance.now(); };
  if(/[A-Za-z]/.test(tail)){
    u.onboundary=(e)=>{ if(typeof e.charIndex==='number'){ usedBoundary=true; sh.lastCharIndex=e.charIndex; highlightAtCharIndex(sh.container, sh.startCharOffset + e.charIndex); } };
    const remain=sh.tokens.filter(t=>t.end>startChar); if(remain.length>0){ let idx=0; const wpm=170*(u.rate||1.0); const msPerWord=Math.max(120, Math.round(60000/wpm));
      fbTimer=setInterval(()=>{ if(usedBoundary){clearInterval(fbTimer);return;} const absIdx=startTokenIdx+idx; if(absIdx>=sh.tokens.length){clearInterval(fbTimer);return;} highlightAtCharIndex(sh.container, sh.tokens[absIdx].start); idx++; }, msPerWord);
    }
  }
  u.onend=()=>{ if(fbTimer) clearInterval(fbTimer); clearHighlight(sh.container); const dur = performance.now() - startedAt; handleEnded(dur<300 ? 'glitch' : true); };
  u.onerror=()=>{ if(fbTimer) clearInterval(fbTimer); clearHighlight(sh.container); handleEnded(true); };
  try{ if (forceCancel || speechSynthesis.speaking){ try { speechSynthesis.cancel(); } catch(e){} } setTimeout(()=>{ if(sh.opened) speechSynthesis.speak(u); }, isAndroid ? 120 : 40); }catch(e){ handleEnded(true); }
}
async function playCurrent(){
  const mySession = ++playSession;
  await ensureTtsUnlocked();
  if (!sh.opened || mySession!==playSession) return;
  if (settings.keepAwake) { try{ await KeepAwake.enable(); }catch(e){} }
  const row = sh.list[sh.index]; const text = (row.english||'').trim();
  $('#sh-scene').textContent = 'å ´é¢ï¼š' + (row.scene || '(æœªè¨­å®š)');
  renderSpeakText(sh.container, text); sh.container.scrollTop=0; sh.tokens = sh.container._tokens || tokenizeWords(text);
  speakFromToken(0, true);
}
$('#sh-toggle').onclick = async ()=>{
  const btn = $('#sh-toggle');
  if(sh.state==='idle'){
    sh.restarting=false; sh.glitchRetry=false; sh.state='playing'; setToggleLabel(btn,'playing');
    await ensureTtsUnlocked();
    playCurrent();
  }else if(sh.state==='playing'){
    try{ speechSynthesis.pause(); }catch(_){}
    sh.state='paused'; setToggleLabel(btn,'paused');
  }else{
    try{ speechSynthesis.resume(); }catch(_){}
    sh.state='playing'; setToggleLabel(btn,'playing');
  }
};
$('#sh-next').onclick = ()=>{ try{ speechSynthesis.cancel(); }catch(e){} sh.restarting=false; sh.glitchRetry=false; handleEnded(true); };
$('#sh-slower').onclick = ()=>{ sh.rate = Math.max(0.5, Math.round((sh.rate-0.1)*10)/10); $('#rate-badge').textContent=(Math.round(sh.rate*10)/10).toFixed(1)+'Ã—'; requestRestartFromCurrentPos(); };
$('#sh-faster').onclick = ()=>{ sh.rate = Math.min(2.0, Math.round((sh.rate+0.1)*10)/10); $('#rate-badge').textContent=(Math.round(sh.rate*10)/10).toFixed(1)+'Ã—'; requestRestartFromCurrentPos(); };

/* ====== ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ— ====== */
function sanitizeWord(s){ return (s||'').replace(/^[^\w'-]+|[^\w'-]+$/g,'').replace(/â€™/g,"'"); }
function setLookupLinks(word){
  const q = encodeURIComponent(word);
  $('#lk-google').href   = `https://www.google.com/search?q=${q}+æ„å‘³`;
  $('#lk-cambridge').href= `https://dictionary.cambridge.org/dictionary/english/${q}`;
  $('#lk-longman').href  = `https://www.ldoceonline.com/dictionary/${q}`;
}
async function renderLookupContent(word, data){
  const body = $('#lk-body');
  const safeWord = escapeHTML(word);
  if(!data || !Array.isArray(data) || data.length===0){
    body.innerHTML =
      `<div><span class="lookup-word">${safeWord}</span><span class="lookup-phon"></span></div>
       <div class="tiny" style="margin-top:6px">
         å®šç¾©ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸‹ã®ãƒªãƒ³ã‚¯ï¼ˆCambridge/Longman/Weblio/ALCãªã©ï¼‰ã§æ„å‘³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
       </div>`;
    return;
  }
  const entry = data[0] || {};
  const phon = (entry.phonetics?.find(p=>p.text)?.text) || '';
  const defs = [];
  (entry.meanings||[]).forEach(m=>{
    (m.definitions||[]).slice(0,2).forEach(d=>{
      if(d?.definition) defs.push(d.definition);
    });
  });
  const joined = defs.slice(0,6).map((t,i)=>`${i+1}. ${t}`).join('\n');
  let jaText = '';
  try{ jaText = await translateToJa(joined || ''); }catch(_){ jaText = joined; }
  const lines = (jaText||'').split(/\n+/).map(x=>escapeHTML(x));
  const senseHtml = lines.length
    ? lines.map(x=>`<div class="lookup-sense">${x}</div>`).join('')
    : `<div class="tiny" style="margin-top:6px">æ—¥æœ¬èªã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
  const top = `<div><span class="lookup-word">${safeWord}</span>${phon?`<span class="lookup-phon">${escapeHTML(phon)}</span>`:''}</div>`;
  body.innerHTML = top + senseHtml;
}
async function openLookup(word){
  if(!word) return;
  setLookupLinks(word);
  $('#lk-body').innerHTML = 'å˜èªã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  $('#dlg-lookup').showModal();
  try{
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`, {mode:'cors'});
    if(!res.ok) throw new Error('fetch failed');
    const json = await res.json();
    renderLookupContent(word, json);
  }catch(e){ renderLookupContent(word, null); }
}
$('#lk-close').onclick = ()=> $('#dlg-lookup').close();
document.addEventListener('click', (e)=>{ const wEl = e.target.closest('.speak-text .w'); if(!wEl) return; const word = sanitizeWord(wEl.textContent); if(!word) return; openLookup(word.toLowerCase()); });

/* ====== ãƒ–ãƒ¼ãƒˆ ====== */
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') loadVoices(); });
window.addEventListener('pageshow', ()=> loadVoices());
</script>
</body>
</html>
