<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>„Åù„Çâ„Åü„Çì„Åë„ÇìÔºÅ</title>
<meta name="theme-color" content="#fff3d6" />
<style>
  :root{
    --cream:#fff7e6;
    --sky-top:#bfe7ff; --sky-mid:#87cffc; --sky-bot:#56b3ff; /* ÂàùÊúüÔºöÊòº */
    --text:#0f172a; --muted:#5b6b8a; --line:#dfe7f6; --card:#ffffff;
    --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b;
    --test-pass:#065f46; --test-fail:#b91c1c;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;color:var(--text);background:var(--cream)}
  .app{max-width:820px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;gap:12px;padding:16px 16px 24px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:28px;display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 10px;border-radius:999px}
  .hud{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .hud .pill{background:#fff;border:1px solid var(--line);padding:8px 14px;border-radius:999px;min-width:84px;text-align:center;font-size:16px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);padding:12px 18px;border-radius:14px;font-size:18px}
  button.primary{background:var(--accent);color:#fff;border-color:transparent}
  button.ghost{background:transparent}
  button:disabled{opacity:.6}
  input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}

  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px}

  .stage{position:relative;flex:1;overflow:hidden;border-radius:20px;border:1px solid var(--line);
         background:linear-gradient(var(--sky-top),var(--sky-mid),var(--sky-bot));
         transition:background 1.2s linear; touch-action:manipulation;}
  .sun{position:absolute;right:16px;top:16px;font-size:34px;opacity:.9;filter:drop-shadow(0 2px 1px rgba(0,0,0,.1)); z-index: 5}

  .cloud{z-index: 2}
  .drop,.bonus,.bird,.plane,.note,.token,.meteor,.vortex{z-index: 3}
  .tally{z-index: 7}
  .boss{z-index: 6}
  .specialBanner,.rainbow{z-index: 8}

  .tally{position:absolute;left:10px;top:10px;background:rgba(255,255,255,.75);border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:14px;color:var(--muted)}
  .tally .row{display:flex;gap:6px;align-items:center}
  .tally .row span{min-width:20px;display:inline-block;text-align:center}

  .cloud{position:absolute; --s:1; transform:translateZ(0) scale(var(--s));
         filter:drop-shadow(0 8px 6px rgba(0,0,0,.08)); opacity:.95}
  .cloud .p{position:absolute;background:#fff;border-radius:999px}
  .cloud .p.a{width:180px;height:100px;left:0;top:32px}
  .cloud .p.b{width:130px;height:82px;left:120px;top:0}
  .cloud .p.c{width:160px;height:95px;left:200px;top:40px}
  .cloud .p.d{width:100px;height:65px;left:90px;top:58px}
  @keyframes floatLR{from{transform:translateX(-15%)}to{transform:translateX(115%)}}
  @keyframes floatRL{from{transform:translateX(115%)}to{transform:translateX(-15%)}}

  .drop{position:absolute;font-size:48px;user-select:none;cursor:pointer;transition:transform .08s}
  .drop:active{transform:scale(1.12)}
  .popScore{position:absolute;font-size:16px;font-weight:700;color:#0f766e;opacity:0;pointer-events:none;transform:translateY(0);animation:popfade .7s ease forwards}
  @keyframes popfade{0%{opacity:0;transform:translateY(0)}10%{opacity:1}100%{opacity:0;transform:translateY(-18px)}}

  .bonus,.token{position:absolute;font-size:40px;user-select:none;cursor:pointer;}
  .bird{position:absolute;font-size:34px;user-select:none;cursor:pointer;}
  .plane{position:absolute;font-size:36px;user-select:none;cursor:pointer;}
  .note{position:absolute;font-size:32px;user-select:none;cursor:pointer;}
  .meteor{position:absolute;font-size:30px;user-select:none;cursor:pointer;}
  .vortex{position:absolute;width:140px;height:140px;border-radius:50%;box-shadow:inset 0 0 0 3px rgba(0,0,0,.08);background:radial-gradient(closest-side, rgba(173,216,230,.45), rgba(173,216,230,.15), rgba(255,255,255,0));animation:pulse 1s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

  .boss{position:absolute;inset:0;display:none;align-items:center;justify-content:center;gap:18px;text-align:center;padding:18px;pointer-events:auto}
  .boss.active{display:flex}

  .bossWrap{position:relative;width:520px;height:400px}
  .ship{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:220px;height:132px;filter:drop-shadow(0 10px 12px rgba(0,0,0,.2));animation:bob 3s ease-in-out infinite}
  .hull{position:absolute;inset:0;background:radial-gradient(60% 80% at 50% 40%,#e8edf8,#aebad6 60%,#8fa0c6);border-radius:150px/95px}
  .window{position:absolute;left:50%;top:42%;transform:translate(-50%,-50%);width:74px;height:74px;border-radius:50%;background:radial-gradient(55% 55% at 40% 35%,#ffffff,#bfe7ff 60%,#7db7ff);border:2px solid #8aa7d1}
  .finL,.finR{position:absolute;bottom:-6px;width:66px;height:34px;background:linear-gradient(#9db1d8,#738bb8);border-radius:8px}
  .finL{left:18px;transform:skewX(-14deg)}
  .finR{right:18px;transform:skewX(14deg)}
  .emblem{position:absolute;left:8px;top:8px;font-size:28px}
  @keyframes bob{0%{transform:translate(-50%,-50%) translateY(0)}50%{transform:translate(-50%,-50%) translateY(-8px)}100%{transform:translate(-50%,-50%) translateY(0)}}

  .digitsRing{position:absolute;inset:0}
  .bubble{position:absolute;padding:18px 22px;background:#fff;border-radius:999px;border:2px solid var(--line);font-size:34px;min-width:84px;text-align:center;animation:sway 2.6s ease-in-out infinite}
  .bubble:before,.bubble:after{content:"";position:absolute;background:#fff;border-radius:999px;border:2px solid var(--line)}
  .bubble:before{width:26px;height:26px;left:-6px;top:16px}
  .bubble:after{width:20px;height:20px;left:-22px;top:30px}
  @keyframes sway{0%{transform:translateY(0) rotate(0)}50%{transform:translateY(-6px) rotate(0.5deg)}100%{transform:translateY(0) rotate(0)}}

  .butter{position:absolute;font-size:22px;animation:flap 1.2s ease-in-out infinite, orbit 1.6s linear infinite}
  @keyframes flap{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
  @keyframes orbit{0%{offset-distance:0%}100%{offset-distance:100%}}

  .toast{position:absolute;left:50%;top:16px;transform:translateX(-50%);padding:8px 12px;background:#000;color:#fff;border-radius:999px;opacity:0;transition:opacity .25s, transform .25s;pointer-events:none;z-index:9999}
  .toast.show{opacity:1;transform:translate(-50%,0)}
  .specialBanner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:28px;background:rgba(255,255,255,.85);border:2px solid var(--line);border-radius:16px;padding:10px 14px;display:none}
  .specialActive .specialBanner{display:block}
  .rainbow{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen;background:linear-gradient(90deg, rgba(255,0,0,.25), rgba(255,165,0,.25), rgba(255,255,0,.25), rgba(0,128,0,.25), rgba(0,0,255,.25), rgba(75,0,130,.25), rgba(238,130,238,.25)); display:none}
  .rainbow.show{display:block}

  .seg{display:inline-flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{border:0;border-right:1px solid var(--line);padding:10px 14px}
  .seg button:last-child{border-right:0}
  .seg button.active{background:var(--accent);color:#fff}

  .result{display:none;flex-direction:column;gap:12px}
  .stars{font-size:24px}

  .testlog{position:fixed;right:12px;bottom:12px;max-width:60ch;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none}
  .testlog b{display:block;margin-bottom:6px}
  .ok{color:var(--test-pass)} .ng{color:var(--test-fail)}

  #bossLine2{position:absolute;bottom:20px;left:50%;transform:translateX(-50%)}
  #bossProgress{position:absolute;bottom:56px;left:50%;transform:translateX(-50%)}
  #bossLine1{display:none}
  /* Ê≠£Ëß£ÊôÇÔºöÊï∞Â≠ó„ÇíÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑ„Å´Êã°Â§ß */
  .bigNum{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.2);font-size:24vw;font-weight:900;color:rgba(255,255,255,.95);text-shadow:0 6px 20px rgba(0,0,0,.25);animation:zoomHuge .75s ease forwards;z-index:9;pointer-events:none}
  @keyframes zoomHuge{0%{transform:translate(-50%,-50%) scale(0.2);opacity:.2}60%{transform:translate(-50%,-50%) scale(1.05);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>„Åù„Çâ„Åü„Çì„Åë„ÇìÔºÅ <span class="badge">iPadÊúÄÈÅ©Âåñ</span></h1>
    <div class="hud">
      <div class="pill" id="scoreBox">Score 0</div>
      <div class="pill" id="timeBox">00:00</div>
    </div>
  </header>

  <div class="toolbar">
    <div class="seg" id="diffSeg">
      <button data-diff="easy" class="active">„ÇÑ„Åï„Åó„ÅÑ</button>
      <button data-diff="normal">„Åµ„Å§„ÅÜ</button>
    </div>
    <label style="display:flex;gap:6px;align-items:center">„Å™„Åæ„Åà:<input id="nameInput" type="text" placeholder="„Åä„Å™„Åæ„Åà" style="width:140px"/><button id="saveNameBtn">‰øùÂ≠ò</button></label>
    <button id="muteBtn" class="ghost">üîä „Çµ„Ç¶„É≥„Éâ</button>
    <button id="startBtn" class="primary">‚ñ∂ „ÅØ„Åò„ÇÅ„Çã</button>
    <button id="retryBtn" style="display:none">‚Ü∫ „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
    <button id="testBtn" style="display:none">üß™ „ÉÜ„Çπ„Éà</button>
  </div>

  <div class="stage card" id="stage">
    <div class="sun">‚òÄÔ∏è</div>
    <div class="tally" id="tally"></div>
    <div class="specialBanner" id="specialBanner">üåü „Çπ„Éö„Ç∑„É£„É´„Çø„Ç§„É†ÔºÅ</div>
    <div class="rainbow" id="rainbow"></div>
    <div class="boss" id="boss">
      <div class="bossWrap">
        <div class="ship" id="ship">
          <div class="hull"></div>
          <div class="window"></div>
          <div class="finL"></div>
          <div class="finR"></div>
          <div class="emblem" id="em">üê§</div>
        </div>
        <div class="digitsRing" id="digitsRing"></div>
      </div>
      <div id="bossLine1">ÔºàhiddenÔºâ</div>
      <div id="bossLine2" style="font-size:22px">3 „Çí „Åä„Åó„Å¶ÔºÅ</div>
      <div id="bossProgress" style="font-size:14px;color:var(--muted)">1 / 5</div>
    </div>
    <div class="toast" id="toast">Level Up!</div>
  </div>

  <div class="result card" id="result">
    <div style="font-size:20px">„Åë„Å£„ÅãÁô∫Ë°®</div>
    <div class="stars" id="resultStars">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</div>
    <div id="resultScore" style="font-size:18px"></div>
    <div id="resultDetail" style="color:var(--muted)"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="againBtn" class="primary">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„ÅÇ„Åù„Å∂</button>
      <button id="homeBtn">„Çø„Ç§„Éà„É´„Å´„ÇÇ„Å©„Çã</button>
    </div>
  </div>
</div>

<div class="testlog" id="testlog"><b>Self Tests</b><div id="testout"></div></div>

<script>
(function(){
  'use strict';
  var stageEl = document.getElementById('stage');
  var startBtn = document.getElementById('startBtn');
  var retryBtn = document.getElementById('retryBtn');
  var muteBtn = document.getElementById('muteBtn');
  var testBtn = document.getElementById('testBtn');
  var scoreBox = document.getElementById('scoreBox');
  var timeBox = document.getElementById('timeBox');
  var bossEl = document.getElementById('boss');
  var bossLine2 = document.getElementById('bossLine2');
  var bossProgress = document.getElementById('bossProgress');
  var digitsRing = document.getElementById('digitsRing');
  var em = document.getElementById('em');
  var toast = document.getElementById('toast');
  var specialBanner = document.getElementById('specialBanner');
  var rainbowEl = document.getElementById('rainbow');
  var result = document.getElementById('result');
  var resultStars = document.getElementById('resultStars');
  var resultScore = document.getElementById('resultScore');
  var resultDetail = document.getElementById('resultDetail');
  var againBtn = document.getElementById('againBtn');
  var homeBtn = document.getElementById('homeBtn');
  var diffSeg = document.getElementById('diffSeg');
  var tallyEl = document.getElementById('tally');
  var testlog = document.getElementById('testlog');
  var testout = document.getElementById('testout');
  var nameInput = document.getElementById('nameInput');
  var saveNameBtn = document.getElementById('saveNameBtn');

  // ===== Name storage =====
  function storedName(){
    try{
      var v = localStorage.getItem('playerName');
      return (v && v.trim()) ? v.trim() : '„ÅÇ„ÇÑ„Åã';
    }catch(e){ return '„ÅÇ„ÇÑ„Åã'; }
  }
  function saveName(n){ try{ localStorage.setItem('playerName', n||''); }catch(e){} }
  nameInput.value = storedName();
  saveNameBtn.addEventListener('click', function(){ var v=(nameInput.value||'').trim(); if(!v) v='„ÅÇ„ÇÑ„Åã'; nameInput.value=v; saveName(v); showToast('„Å™„Åæ„Åà„Çí „Åª„Åû„Çì„Åó„Åü„Çà'); });

  // ===== Audio =====
  var audioEnabled = true; var actx = null; var bgmTimer = null;
  function ensureCtx(){ if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq, dur, type, vol){ if(!audioEnabled) return; ensureCtx();
    freq = freq||880; dur = dur||0.12; type=type||'sine'; vol=vol||0.06;
    var t0 = actx.currentTime; var o = actx.createOscillator(); var g = actx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(vol,t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g).connect(actx.destination); o.start(); o.stop(t0+dur);
  }
  function pinpon(){ beep(880,0.1,'triangle',0.05); setTimeout(function(){beep(1175,0.12,'triangle',0.05);},90); }
  function buzz(){ beep(220,0.18,'sawtooth',0.04); }
  function startBgm(){ if(!audioEnabled) return; ensureCtx(); stopBgm();
    var notes = [523.25,659.25,783.99,659.25,587.33,698.46,880.00,698.46];
    var i=0; bgmTimer = setInterval(function(){ var f = notes[i%notes.length]; i++; beep(f,0.18,'sine',0.03); }, 340);
  }
  function stopBgm(){ if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } }

  // ===== Speech =====
  function speakWait(text){
    return new Promise(function(resolve){
      if(!audioEnabled || !('speechSynthesis' in window)) return resolve();
      try{ window.speechSynthesis.cancel(); }catch(e){}
      var u = new SpeechSynthesisUtterance(text);
      u.lang='ja-JP'; u.rate=1.0; u.pitch=1.0; u.volume=1.0;
      var settled=false; var safeMs = Math.max(2500, Math.min(9000, 150*String(text||'').length));
      var timeout = setTimeout(function(){ if(!settled){ settled=true; resolve(); } }, safeMs);
      u.onend = function(){ if(!settled){ settled=true; clearTimeout(timeout); resolve(); } };
      u.onerror= function(){ if(!settled){ settled=true; clearTimeout(timeout); resolve(); } };
      try{ window.speechSynthesis.speak(u); }catch(e){ if(!settled){ settled=true; clearTimeout(timeout); resolve(); } }
    });
  }
  function maybeNamePrefix(p){ if(p===void 0) p=0.55; var n=storedName(); return (n && Math.random()<p)? (n+'„Å°„ÇÉ„Çì„ÄÅ') : ''; }

  // ===== Difficulty =====
  var diff = 'easy';
  diffSeg.addEventListener('click', function(e){ var btn=e.target.closest('button'); if(!btn) return; [].slice.call(diffSeg.querySelectorAll('button')).forEach(function(b){b.classList.remove('active');}); btn.classList.add('active'); diff=btn.dataset.diff; });
  muteBtn.addEventListener('click',function(){ audioEnabled=!audioEnabled; muteBtn.textContent = audioEnabled? 'üîä „Çµ„Ç¶„É≥„Éâ' : 'üîá „Éü„É•„Éº„Éà'; if(audioEnabled){ beep(660,0.08); startBgm(); } else { stopBgm(); try{speechSynthesis.cancel();}catch(e){} } });

  // ===== Clouds =====
  var clouds = [];
  function spawnCloudTop(){
    var c = document.createElement('div'); c.className='cloud'; c.style.setProperty('--s', (1.0+Math.random()*0.7).toFixed(2));
    var W = stageEl.clientWidth; var H = stageEl.clientHeight; var topBand = H*0.22;
    var x = Math.random()*W*0.8+W*0.1; var y = Math.random()*topBand*0.8; c.style.left=x+'px'; c.style.top=y+'px';
    var dir = Math.random()<0.5 ? 'floatLR' : 'floatRL'; var dur = 42 + Math.random()*20; c.style.animation = dir+' '+dur+'s linear infinite';
    ;['a','b','c','d'].forEach(function(cls){ var p=document.createElement('div'); p.className='p '+cls; c.appendChild(p); });
    stageEl.appendChild(c); clouds.push(c);
  }
  function initClouds(){ clouds.forEach(function(c){c.remove();}); clouds.length=0; for(var i=0;i<6;i++) spawnCloudTop(); }

  // ===== Fruits / Bonuses =====
  var fruitList = [
    {e:'üçé', n:'„Çä„Çì„Åî'}, {e:'üçå', n:'„Éê„Éä„Éä'}, {e:'üçá', n:'„Å∂„Å©„ÅÜ'}, {e:'üçì', n:'„ÅÑ„Å°„Åî'},
    {e:'üçä', n:'„Åø„Åã„Çì'}, {e:'üçê', n:'„Å™„Åó'}, {e:'üçí', n:'„Åï„Åè„Çâ„Çì„Åº'}, {e:'üçç', n:'„Éë„Ç§„Éä„ÉÉ„Éó„É´'}, {e:'ü•ù', n:'„Ç≠„Ç¶„Ç§'}
  ];
  var activeDrops = new Set();
  var counts = new Map(fruitList.map(function(f){return [f.e,0];}));
  function renderTally(){ tallyEl.innerHTML = fruitList.map(function(f){ var c = counts.get(f.e)||0; return '<div class="row"><span>'+f.e+'</span><b>'+c+'</b></div>'; }).join(''); }
  function randX(){ var w=stageEl.clientWidth; var margin=12; return Math.random()*(w - margin*2) + margin; }
  function clamp(v,min,max){ return v<min?min:(v>max?max:v); }

  // scoring helpers
  var rainbowActive=false, rainbowT=0;
  var score=0, running=false, stage=0, elapsed=0, lastTick=0; var spawnTimer=0, spawnIntervalBase=620; var rafStarted=false;
  var legacyEventTimer=0, birdTimer=0, planeTimer=0; var specialActive=false, specialT=0; var specialPlanned=false, specialAt=9999;
  var eventTimer=0;

  function addScore(p){ if(rainbowActive) p+=1; score += p; scoreBox.textContent='Score '+score; }

  function spawnDrop(){
    var f = fruitList[Math.floor(Math.random()*fruitList.length)];
    var el=document.createElement('div'); el.className='drop'; el.textContent = f.e; var x = randX(); el.style.left=x+'px'; el.style.top='-56px';
    var scale = 0.75 + Math.random()*0.60; el.style.transform = 'scale('+scale+')';
    var pts = Math.max(1, Math.min(5, Math.round((1.5 - scale)*6))); el.dataset.pts = String(pts);
    var baseVy = (diff==='easy'? 120:170); var scaleVy = diffScale(); el.dataset.vy = (baseVy + Math.random()*50) * scaleVy;
    el.dataset.y=-56; el.dataset.f = f.e; el.dataset.x=x;
    el.dataset.vx = 0; el.dataset.wiggle = (Math.random()*0.6+0.2).toFixed(2); el.dataset.phase=(Math.random()*Math.PI*2).toFixed(3);
    el.addEventListener('pointerdown', function(){
      var p = Number(el.dataset.pts)||1; addScore(p); beep(990,0.07,'sine',0.05);
      var pop = document.createElement('div'); pop.className='popScore'; pop.textContent = '+'+p; stageEl.appendChild(pop);
      var rect = el.getBoundingClientRect(); var srect = stageEl.getBoundingClientRect();
      var px = (rect.left - srect.left + 22); var py = (rect.top - srect.top - 4);
      var sw = stageEl.clientWidth; px = Math.max(4, Math.min(sw-40, px));
      pop.style.left = px + 'px'; pop.style.top = py + 'px';
      setTimeout(function(){pop.remove();}, 700);
      counts.set(f.e, (counts.get(f.e)||0) + 1); renderTally();
      var c = counts.get(f.e)||0; if(c>0 && c%10===0){ var nameLabel = f.n; speakWait(nameLabel+'„Çí '+c+'„Åì „ÅÇ„Å§„ÇÅ„Åü„Çà'); }
      el.remove(); activeDrops.delete(el);
    }, {once:true});
    stageEl.appendChild(el); activeDrops.add(el);
  }

  // legacy small bonuses (keep)
  function spawnBonus(){ var types=['üéà','ü™ô','üåü']; var t=types[Math.floor(Math.random()*types.length)]; var el=document.createElement('div'); el.className='bonus'; el.textContent=t; var x=randX(); var y=-40; el.style.left=x+'px'; el.style.top=y+'px'; var vy=90+Math.random()*60; var pts = t==='üåü'? 15 : (t==='ü™ô'? 10: 8); el.dataset.vy=vy; el.dataset.y=y; el.dataset.x=x; el.dataset.pts=pts; el.addEventListener('pointerdown', function(){ addScore(pts); pinpon(); el.remove(); activeDrops.delete(el); }); stageEl.appendChild(el); activeDrops.add(el); }

  // Birds / Planes
  function spawnBird(){ var el=document.createElement('div'); el.className='bird'; el.textContent='üê¶'; var y = 20 + Math.random()*60; var w=stageEl.clientWidth; el.style.top=y+'px'; el.style.left=(w+40)+'px'; stageEl.appendChild(el); var vx = - (140 + Math.random()*80); el.dataset.vx=vx; el.dataset.x=w+40; el.addEventListener('pointerdown', function(){ addScore(1); beep(1200,0.06,'sine',0.05); el.remove(); activeDrops.delete(el); }); activeDrops.add(el); }
  function spawnPlane(){ var el=document.createElement('div'); el.className='plane'; el.textContent='‚úàÔ∏è'; var y = 50 + Math.random()*70; var w=stageEl.clientWidth; el.style.top=y+'px'; el.style.left=(w+60)+'px'; stageEl.appendChild(el); var vx = - (180 + Math.random()*120); el.dataset.vx=vx; el.dataset.x=w+60; el.addEventListener('pointerdown', function(){ addScore(3); pinpon(); el.remove(); activeDrops.delete(el); }); activeDrops.add(el); }

  // ===== Random Event System (max 3 per game, no duplicates) =====
  var usedEvents = new Set(); var eventCount=0;
  var magnetActive=false, magnetT=0;
  var slowActive=false, slowT=0;
  var melodyActive=false, melodyCount=0, melodyT=0;
  var vortexActive=false, vortexT=0, vortex={x:0,y:0,r:70};

  function speedFactor(){ return slowActive? 0.5 : 1; }

  function spawnToken(emoji, onclick){ var el=document.createElement('div'); el.className='token'; el.textContent=emoji; var x=randX(); var y=-40; el.style.left=x+'px'; el.style.top=y+'px'; el.dataset.vy=100; el.dataset.y=y; el.dataset.x=x; el.addEventListener('pointerdown', function(){ onclick(); el.remove(); activeDrops.delete(el); }); stageEl.appendChild(el); activeDrops.add(el); }

  function triggerMagnet(){ spawnToken('üß≤', function(){ magnetActive=true; magnetT=10; showToast('„Éû„Ç∞„Éç„ÉÉ„ÉàÔºÅ'); speakWait(maybeNamePrefix(0.5)+'„Éû„Ç∞„Éç„ÉÉ„ÉàÔºÅ'); }); }
  function triggerSlow(){ spawnToken('‚è≥', function(){ slowActive=true; slowT=5; showToast('„Çπ„É≠„ÉºÔºÅ'); speakWait(maybeNamePrefix(0.5)+'„Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥ÔºÅ'); }); }
  function triggerMelody(){ melodyActive=true; melodyCount=0; melodyT=8; showToast('„É°„É≠„Éá„Ç£ÔºÅ'); speakWait(maybeNamePrefix(0.5)+'„É°„É≠„Éá„Ç£ „Ç≥„É≥„ÉúÔºÅ'); var notesSpawned=0; var timer=setInterval(function(){ if(!melodyActive){ clearInterval(timer); return; } if(notesSpawned>=5){ clearInterval(timer); return; } notesSpawned++; var el=document.createElement('div'); el.className='note'; el.textContent='üéµ'; var x=randX(); var y=-30; el.style.left=x+'px'; el.style.top=y+'px'; el.dataset.vy=120; el.dataset.y=y; el.dataset.x=x; el.addEventListener('pointerdown', function(){ melodyCount++; addScore(2); pinpon(); el.remove(); activeDrops.delete(el); if(melodyCount>=3){ melodyActive=false; addScore(10); pinpon(); pinpon(); showToast('„Ç≥„É≥„ÉúÔºÅ+10'); } }); stageEl.appendChild(el); activeDrops.add(el); }, 1200); }
  function triggerMystery(){ spawnToken('üéÅ', function(){ var delta = (Math.random()<0.7? +8 : -3); if(delta>0){ addScore(delta); pinpon(); showToast('„Éú„Éº„Éä„ÇπÔºÅ+'+delta); } else { addScore(delta); buzz(); showToast('„ÅÇ„Çå„Çå‚Ä¶ '+delta); } speakWait('„Çµ„Éó„É©„Ç§„Ç∫ÔºÅ'); }); }
  function triggerMeteor(){ var el=document.createElement('div'); el.className='meteor'; el.textContent='‚≠êÔ∏è'; var w=stageEl.clientWidth, h=stageEl.clientHeight; var x=w+20, y=20; el.style.left=x+'px'; el.style.top=y+'px'; stageEl.appendChild(el); el.dataset.x=x; el.dataset.y=y; el.dataset.vx=-240; el.dataset.vy=120; el.addEventListener('pointerdown', function(){ addScore(8); pinpon(); el.remove(); activeDrops.delete(el); }); activeDrops.add(el); }
  function triggerVortex(){ var el=document.createElement('div'); el.className='vortex'; var w=stageEl.clientWidth, h=stageEl.clientHeight; vortex.x = Math.random()*(w-160)+80; vortex.y = Math.random()*(h*0.5)+h*0.25; el.style.left=(vortex.x-70)+'px'; el.style.top=(vortex.y-70)+'px'; stageEl.appendChild(el); vortexActive=true; vortexT=6; setTimeout(function(){ el.remove(); }, 6000); }
  function triggerRainbow(){ rainbowActive=true; rainbowT=8; rainbowEl.classList.add('show'); speakWait('„Å´„Åò„Éï„Ç£„É´„Çø„ÉºÔºÅ'); }

  var eventCatalog=[
    {key:'magnet', fn:triggerMagnet, weight:1.0},
    {key:'slow', fn:triggerSlow, weight:1.0},
    {key:'melody', fn:triggerMelody, weight:1.0},
    {key:'mystery', fn:triggerMystery, weight:0.5},
    {key:'meteor', fn:triggerMeteor, weight:1.0},
    {key:'vortex', fn:triggerVortex, weight:1.0},
    {key:'rainbow', fn:triggerRainbow, weight:0.5}
  ];
  function weightedPick(list){ var avail=list.filter(function(x){return !usedEvents.has(x.key)}); var sum=avail.reduce(function(s,x){return s+x.weight;},0); if(sum<=0) return null; var r=Math.random()*sum; var acc=0; for(var i=0;i<avail.length;i++){ acc+=avail[i].weight; if(r<=acc) return avail[i]; } return avail[avail.length-1]; }
  function maybeTriggerEvent(){ if(eventCount>=3) return; var pick=weightedPick(eventCatalog); if(!pick) return; usedEvents.add(pick.key); eventCount++; pick.fn(); }

  // ===== Physics / Tick =====
  function tickDrops(dt){
    var w=stageEl.clientWidth, h=stageEl.clientHeight; var sf = speedFactor(); dt = dt*sf;
    // timers for effects
    if(magnetActive){ magnetT-=dt; if(magnetT<=0){ magnetActive=false; }}
    if(slowActive){ slowT-=dt; if(slowT<=0){ slowActive=false; }}
    if(melodyActive){ melodyT-=dt; if(melodyT<=0){ melodyActive=false; }}
    if(vortexActive){ vortexT-=dt; if(vortexT<=0){ vortexActive=false; }}
    if(rainbowActive){ rainbowT-=dt; if(rainbowT<=0){ rainbowActive=false; rainbowEl.classList.remove('show'); }}

    activeDrops.forEach(function(el){
      // diagonal meteor
      if(el.classList.contains('meteor')){
        var mx=parseFloat(el.dataset.x||'0'); var my=parseFloat(el.dataset.y||'0');
        var mvx=parseFloat(el.dataset.vx||'0'); var mvy=parseFloat(el.dataset.vy||'0'); mx+=mvx*dt; my+=mvy*dt; el.dataset.x=mx; el.dataset.y=my; el.style.left=mx+'px'; el.style.top=my+'px'; if(mx<-80 || my>h+80){ el.remove(); activeDrops.delete(el); } return;
      }
      // bird/plane/token/note fall or move
      if(el.classList.contains('bird')||el.classList.contains('plane')||el.classList.contains('token')||el.classList.contains('note')){
        var x1=parseFloat(el.dataset.x||'-40'); var vx1=parseFloat(el.dataset.vx||'0'); var vy1=parseFloat(el.dataset.vy||'120'); var y1=parseFloat(el.dataset.y||'-40');
        if(vx1){ x1+=vx1*dt; } y1+=vy1*dt; el.dataset.x=x1; el.dataset.y=y1; el.style.left=x1+'px'; el.style.top=y1+'px'; if(x1<-80 || x1>w+80 || y1>h+80){ el.remove(); activeDrops.delete(el); } return;
      }
      // normal drops (fruits & bonus)
      var vy=parseFloat(el.dataset.vy||'140'); var y=parseFloat(el.dataset.y||'-56'); y+=vy*dt; el.dataset.y=y; el.style.top=y+'px';
      if(el.classList.contains('drop')){
        var x=parseFloat(el.dataset.x||'0'); var phase=parseFloat(el.dataset.phase||'0'); var wiggle=parseFloat(el.dataset.wiggle||'0.3');
        // magnet: pull to center x
        if(magnetActive){ var cx=w*0.5; x += (cx - x)*0.8*dt; }
        // wiggle / avoid
        var prog = Math.min(Math.max(elapsed/20,0), 3);
        phase += dt * (1.2 + prog*0.35);
        var ax=Math.sin(phase)*20*wiggle*(0.6+prog*0.2);
        x += ax*dt;
        if(prog>1.5){ x += (Math.random()-0.5)*18*dt; }
        // vortex: rotate around center if near
        if(vortexActive){
          var dx=x - vortex.x; var dy=(y) - vortex.y; var dist=Math.sqrt(dx*dx+dy*dy);
          if(dist<vortex.r){ var ang=Math.atan2(dy,dx)+2.5*dt; var rr=dist; x=vortex.x + Math.cos(ang)*rr; y=vortex.y + Math.sin(ang)*rr; el.dataset.y=y; el.style.top=y+'px'; }
        }
        x = clamp(x, 8, w-48); el.dataset.x=x; el.style.left=x+'px'; el.dataset.phase=phase;
      }
      if(y>h+80){ el.remove(); activeDrops.delete(el); }
    });
  }

  // ===== Sky (Êòº‚ÜíÂ§ï‚ÜíÂ§ú) =====
  function lerp(a,b,t){ return a + (b-a)*t; }
  function mixColor(c1,c2,t){ function toRGB(c){ return {r:parseInt(c.substr(1,2),16), g:parseInt(c.substr(3,2),16), b:parseInt(c.substr(5,2),16)} } var A=toRGB(c1), B=toRGB(c2); var r=Math.round(lerp(A.r,B.r,t)), g=Math.round(lerp(A.g,B.g,t)), b=Math.round(lerp(A.b,B.b,t)); return 'rgb('+r+','+g+','+b+')'; }
  function updateSky(total){ var t = Math.min(total/90,1); var dayTop='#bfe7ff', dayMid='#87cffc', dayBot='#56b3ff'; var eveTop='#ffd1a1', eveMid='#ff9c66', eveBot='#ff6b6b'; var nightTop='#0b1740', nightMid='#0e215b', nightBot='#122b73'; var cTop = t<0.66 ? mixColor(dayTop,eveTop,t/0.66) : mixColor(eveTop,nightTop,(t-0.66)/0.34); var cMid = t<0.66 ? mixColor(dayMid,eveMid,t/0.66) : mixColor(eveMid,nightMid,(t-0.66)/0.34); var cBot = t<0.66 ? mixColor(dayBot,eveBot,t/0.66) : mixColor(eveBot,nightBot,(t-0.66)/0.34); stageEl.style.background = 'linear-gradient('+cTop+','+cMid+','+cBot+')'; }

  // ===== Difficulty helpers (gradual) =====
  function diffScale(){ return 1 + Math.min(elapsed*0.03, 2.0); } // up to ~3x by ~67s
  function currentConcurrent(){ var base = (diff==='easy'?3:5); var extra = (diff==='easy'?3:4); var prog=Math.min(elapsed/60,1); return base + Math.floor(extra*prog); }

  function fmtTime(sec){ var m=Math.floor(sec/60), s=Math.floor(sec%60); return (''+m).padStart(2,'0')+':'+(''+s).padStart(2,'0'); }
  function resetHud(){ scoreBox.textContent='Score '+score; timeBox.textContent='00:00'; renderTally(); }
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(function(){toast.classList.remove('show');},1200); }

  // ===== Game Loop =====
  function loop(t){
    try {
      if(!lastTick) lastTick=t;
      var dt=(t-lastTick)/1000; lastTick=t;
      updateSky(elapsed);
      if(running){
        var sf=speedFactor();
        elapsed+=dt;
        timeBox.textContent=fmtTime(elapsed); /* gradual difficulty: no discrete level ups */

        if(!specialActive){ specialBanner.style.display='none'; stageEl.classList.remove('specialActive'); }
        if(!specialActive && specialPlanned && elapsed>=specialAt){
          specialActive=true; specialT=0; stageEl.classList.add('specialActive'); specialBanner.style.display='block';
          speakWait(maybeNamePrefix(0.5)+'„Çπ„Éö„Ç∑„É£„É´„Çø„Ç§„É†ÔºÅ');
        }
        if(specialActive){ specialT+=dt; if(specialT>=10){ specialActive=false; stageEl.classList.remove('specialActive'); specialBanner.style.display='none'; } }

        spawnTimer += dt*1000*sf;
        var interval = Math.max(120, spawnIntervalBase / diffScale() - (diff==='normal'?80:0));
        if(specialActive) interval = Math.max(60, interval*0.35);
        if(spawnTimer>=interval){ spawnTimer=0; spawnDrop(); if(specialActive){ for(var k=0;k<2;k++) spawnDrop(); } }

        var cc = currentConcurrent(); while(activeDrops.size< (specialActive ? cc+2 : cc)) spawnDrop();

        legacyEventTimer += dt*sf; if(legacyEventTimer> (6+Math.random()*4)){ legacyEventTimer=0; if(Math.random()<0.45) spawnBonus(); }
        birdTimer += dt*sf; if(birdTimer> (12+Math.random()*6)){ birdTimer=0; spawnBird(); }
        planeTimer += dt*sf; if(planeTimer> (20+Math.random()*15)){ planeTimer=0; spawnPlane(); }

        eventTimer += dt*sf; if(eventTimer> (10+Math.random()*4)){ eventTimer=0; if(eventCount<3) maybeTriggerEvent(); }

        tickDrops(dt);

        if(elapsed>=45){
          if(stage===1){ enterBoss(1); }
          if(stage===3){ enterBoss(2); }
        }
      }
    } catch(err){
      console.error('Game loop error:', err);
      if(testout){ var div=document.createElement('div'); div.className='ng'; div.textContent='Loop error: '+(err&&err.message||err); testout.appendChild(div);}
    }
    requestAnimationFrame(loop);
  }
  // ===== Boss =====
  var bossRound=0, bossCorrect=0, bossTarget=0, bossDigits=3, bossActive=false;
  var bossPromptVariants = [
    '{n} „Çí „Åä„Åó„Å¶', '{n} „Çí „Çø„ÉÉ„Éó„Åó„Å¶', '{n} „Çí „Åà„Çâ„Çì„Åß', '{n} „Å´ „Åï„Çè„Å£„Å¶', '{n} „Çí „Åø„Å§„Åë„Å¶',
    '{n} „Çí „Åä„Åó„Å¶„Å≠', '{n} „Çí „ÅΩ„Å°„Å£', '{n} „Çí „Åô„Å∞„ÇÑ„Åè', '{n} „Å´ „Çø„ÉÉ„ÉÅ', '{n} „Çí „Å§„Åã„Åæ„Åà„Å¶',
    '{n} „Çí „Åä„Å≠„Åå„ÅÑ', '{n} „Çí „ÇØ„É™„ÉÉ„ÇØ', '{n} „Çí „Å¥„Å£', '{n} „Çí „Åà„ÅÑ', '{n} „Çí „ÉÅ„Éß„Ç§„Çπ',
    '{n} „Åå „Åõ„ÅÑ„Åã„ÅÑ', '{n} „Çí „Åì„Åü„Åà„Å¶', '{n} „Çí „Åä„Åõ„Çã„Åã„Å™', '{n} „Çí „Åä„Åó„Å¶ „Åø„Çà„ÅÜ', '{n} „Çí „Åà„Çâ„Åº„ÅÜ'
  ];
  function promptText(n){
    var tpl = bossPromptVariants[Math.floor(Math.random()*bossPromptVariants.length)];
    return tpl.replace('{n}', n);
  }

  async function enterBoss(which){
    if(bossActive) return;
    bossActive=true;
    activeDrops.forEach(function(el){ el.remove(); });
    activeDrops.clear();
    // hide special UI on boss
    specialActive=false; specialBanner.style.display='none'; stageEl.classList.remove('specialActive'); rainbowActive=false; rainbowEl.classList.remove('show');

    bossDigits = (which===1?3:5);
    bossRound=0; bossCorrect=0; bossTarget=0;
    em.textContent = which===1? 'üê§' : 'üê±';
    bossEl.classList.add('active');
    running=false; lastTick=0; digitsRing.innerHTML='';
    var who = (which===1? '„Å≤„Çà„Åì „ÅÜ„Å°„ÇÖ„ÅÜ„Åõ„Çì' : '„ÅÜ„Å°„ÇÖ„ÅÜ „Å≠„Åì');
    await speakWait(maybeNamePrefix(0.6)+who+' „Åå „ÇØ„Ç§„Ç∫„Çí „Å†„Åó„Å¶„Åç„Åü');
    nextBossStep();
  }

  function layoutDigitsAroundCenter(nodes){
    var wrap = document.querySelector('.bossWrap');
    var rect = wrap.getBoundingClientRect();
    var radiusX = 190, radiusY = 140;
    var cx = rect.width/2, cy = rect.height/2;
    nodes.forEach(function(el, i){
      var a = (i / nodes.length) * Math.PI * 2;
      var x = cx + Math.cos(a)*radiusX - 36;
      var y = cy + Math.sin(a)*radiusY - 30;
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.style.animationDuration = (2400 + i*120) + 'ms';
    });
  }

  async function nextBossStep(){
    stageEl.querySelectorAll('.butter').forEach(function(b){ b.remove(); });
    if(bossRound>=5){
      pinpon(); speakWait(maybeNamePrefix(0.6)+'„Å†„ÅÑ„Åõ„ÅÑ„Åì„ÅÜÔºÅ');
      bossEl.classList.remove('active'); bossActive=false;
      if(stage===1){ startStage2(); } else if(stage===3){ finishGame(); }
      return;
    }
    digitsRing.innerHTML='';
    bossTarget=Math.floor(Math.random()*10);
    var pool=new Set([bossTarget]);
    while(pool.size<bossDigits){ pool.add(Math.floor(Math.random()*10)); }
    var arr=Array.from(pool).sort(function(){return Math.random()-0.5;});
    var nodes = arr.map(function(n){
      var b=document.createElement('button');
      b.className='bubble'; b.textContent=n;
      b.addEventListener('click',function(){ onPickDigit(n,b); });
      digitsRing.appendChild(b);
      return b;
    });
    layoutDigitsAroundCenter(nodes);
    var ptxt = promptText(bossTarget);
    bossLine2.textContent = ptxt + 'ÔºÅ';
    bossProgress.textContent = (bossRound+1)+' / 5';
    await speakWait(ptxt);
  }

  function onPickDigit(n, btn){
    if(n===bossTarget){
      pinpon(); addScore(10); bossRound++; bossCorrect++;
      bossLine2.textContent='„Åõ„ÅÑ„Åã„ÅÑÔºÅ';
      // „Åß„ÅãÊï∞Â≠óÊºîÂá∫
      var big=document.createElement('div'); big.className='bigNum'; big.textContent=String(n); stageEl.appendChild(big); setTimeout(function(){ big.remove(); }, 900);
      speakWait(maybeNamePrefix(0.6)+'„Åõ„ÅÑ„Åã„ÅÑÔºÅ');
      setTimeout(function(){nextBossStep();}, 650);
    } else {
      buzz(); bossLine2.textContent='„ÇÇ„ÅÜ„ÅÑ„Å°„Å©'; speakWait(maybeNamePrefix(0.6)+'„ÇÇ„ÅÜ„ÅÑ„Å°„Å©'); butterfliesAroundCorrect();
    }
  }

  function butterfliesAroundCorrect(){
    var target=[].slice.call(digitsRing.children).find(function(el){ return Number(el.textContent)===bossTarget; });
    if(!target) return;
    var rect=target.getBoundingClientRect(); var srect=stageEl.getBoundingClientRect();
    var cx=rect.left - srect.left + rect.width/2; var cy=rect.top - srect.top + rect.height/2;
    for(var i=0;i<3;i++){
      var b=document.createElement('div'); b.className='butter'; b.textContent='ü¶ã';
      b.style.left=(cx-10)+'px'; b.style.top=(cy-10)+'px';
      b.style.offsetPath="path('M 0 0 C 20 -30, 40 30, 60 0')";
      b.style.animationDelay = (i*0.15)+'s';
      stageEl.appendChild(b);
      setTimeout(function(){b.remove();},1400);
    }
  }

  // ===== Stage start/finish =====
  function startStage1(){
    running=true; stage=1; elapsed=0; lastTick=0; spawnTimer=0; score=0;
    legacyEventTimer=0; birdTimer=0; planeTimer=0;
    specialActive=false; specialT=0; specialPlanned = Math.random()<0.33; specialAt = 25 + Math.random()*15;
    usedEvents.clear(); eventCount=0; magnetActive=false; slowActive=false; melodyActive=false; vortexActive=false; rainbowActive=false; rainbowEl.classList.remove('show');
    counts.forEach(function(_,k){counts.set(k,0);});
    resetHud();
    spawnIntervalBase = (diff==='easy'? 620: 500);
    retryBtn.style.display='inline-block';
    result.style.display='none';
    bossEl.classList.remove('active'); specialBanner.style.display='none'; stageEl.classList.remove('specialActive');
    initClouds();
    speakWait(maybeNamePrefix(0.6)+'„Åù„Çâ„Åü„Çì„Åë„Çì  „ÅØ„Åò„Åæ„Çã„Çà');
    startBgm();
    if(!rafStarted){ rafStarted=true; requestAnimationFrame(loop); }
  }
  function startStage2(){
    running=true; stage=3; elapsed=0; lastTick=0; spawnTimer=0;
    legacyEventTimer=0; birdTimer=0; planeTimer=0;
    specialActive=false; specialT=0; specialPlanned = Math.random()<0.33; specialAt = 25 + Math.random()*15;
    usedEvents.clear(); eventCount=0; magnetActive=false; slowActive=false; melodyActive=false; vortexActive=false; rainbowActive=false; rainbowEl.classList.remove('show');
    spawnIntervalBase = (diff==='easy'? 520: 420);
    specialBanner.style.display='none'; stageEl.classList.remove('specialActive');
    initClouds();
    speakWait(maybeNamePrefix(0.6)+'„Çπ„ÉÜ„Éº„Ç∏ 2');
    startBgm();
    if(!rafStarted){ rafStarted=true; requestAnimationFrame(loop); }
  }
  function finishGame(){
    running=false;
    bossEl.classList.remove('active');
    stopBgm();
    specialActive=false; specialBanner.style.display='none'; stageEl.classList.remove('specialActive'); rainbowActive=false; rainbowEl.classList.remove('show');
    var stars = score>=220? '‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è' : score>=150? '‚≠êÔ∏è‚≠êÔ∏è' : '‚≠êÔ∏è';
    resultStars.textContent = stars;
    resultScore.textContent = '„Çπ„Ç≥„Ç¢Ôºö'+score;
    var comment = score>=220? '„Éï„É´„Éº„ÉÑ„Éû„Çπ„Çø„ÉºÔºÅ' : score>=150? '„Åü„ÅÆ„Åó„Åè„Åß„Åç„Åü„Å≠ÔºÅ' : '„Å§„Åé„ÅØ „Åª„Åó„ÇÇ „Åü„Åè„Åï„Çì „ÅÇ„Å§„ÇÅ„Å¶„Åø„Çà„ÅÜÔºÅ';
    resultDetail.textContent = comment;
    result.style.display='flex';
  }

  // ===== UI =====
  startBtn.addEventListener('click',function(){ startBtn.disabled=true; setTimeout(function(){startBtn.disabled=false;},600); startStage1(); });
  retryBtn.addEventListener('click',function(){ startStage1(); });
  if(againBtn) againBtn.addEventListener('click',function(){ startStage1(); window.scrollTo({top:0,behavior:'smooth'}); });
  if(homeBtn) homeBtn.addEventListener('click',function(){ location.reload(); });
  stageEl.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});

  // ===== Tests =====
  function log(msg, ok){ ok = (ok!==false); var div=document.createElement('div'); div.className= ok? 'ok' : 'ng'; div.textContent=(ok?'‚úî ':'‚úò ')+msg; testout.appendChild(div); console[ok?'log':'error'](msg); }
  async function runTests(){ testout.innerHTML=''; testlog.style.display='block';
    var oldAudio=audioEnabled; audioEnabled=false; var t0=performance.now(); await speakWait('„ÉÜ„Çπ„Éà'); var dt=performance.now()-t0; log('T1 speakWait resolves '+Math.round(dt)+'ms (<=9000)', dt<=9000); audioEnabled=oldAudio;
    var ok=true; var w=stageEl.clientWidth; for(var i=0;i<200;i++){ var x=randX(); if(!(x>=0 && x<=w)){ ok=false; break; } } log('T2 randX in width', ok);
    initClouds(); var c0=clouds.length; await new Promise(function(r){setTimeout(r, 1000);}); var c1=clouds.length; log('T3 clouds count fixed', c0===c1 && c1===6);
    startStage1(); await new Promise(function(r){setTimeout(r, 500);}); log('T4 special not immediate', !specialActive && specialBanner.style.display==='none');
    spawnBird(); var bird=document.querySelector('.bird'); var x0=bird? parseFloat(bird.dataset.x):0; await new Promise(function(r){setTimeout(r, 400);}); var x1=bird? parseFloat(bird.dataset.x):0; log('T5 bird moves R‚ÜíL', bird && x1<x0);
    await enterBoss(1); log('T6 boss progress placed', getComputedStyle(bossProgress).bottom!=='auto');
    // T7: storedName default
    var prev = storedName(); saveName(''); var sn=storedName(); log('T7 storedName default Ayaka', sn==='„ÅÇ„ÇÑ„Åã'); saveName(prev);
    // T8: special banner hides on finish
    finishGame(); log('T8 special banner hidden after finish', specialBanner.style.display==='none');
    // T9: events cap & unique
    usedEvents.clear(); eventCount=0; for(var i=0;i<10;i++){ maybeTriggerEvent(); } log('T9 event cap (<=3)', eventCount<=3 && usedEvents.size===eventCount);
  }
  if(new URLSearchParams(location.search).get('test')==='1'){ testBtn.style.display='inline-block'; testlog.style.display='block'; setTimeout(runTests, 300); }
  testBtn.addEventListener('click', runTests);
})();
</script>
</body>
</html>
