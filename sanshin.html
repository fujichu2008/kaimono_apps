<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no"/>
<title>Sanshin Simulatorï¼ˆæ²–ç¸„ä¸‰ç·šï¼‰</title>
<style>
  :root{
    --bg:#0b0f14; --bg2:#0a1320;
    --card:#121826; --card2:#0f1524;
    --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#19d37a; --warn:#ffb020; --danger:#ff4d4f;
    --shadow:0 16px 40px rgba(0,0,0,.45);
    --r:18px;

    --wood1:#5a3b22; --wood2:#3e2716;
    --skin1:#cbb892; --skin2:#9b8b6f;
    --metal:#cfd6e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2)); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Arial;}
  button, select, input{font:inherit}
  .wrap{max-width:1100px; margin:0 auto; padding:14px 12px 24px;}
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    position:sticky; top:0; z-index:20;
    padding:10px 10px;
    background:linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.72));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .brand{display:flex; flex-direction:column; line-height:1.1}
  .brand b{font-size:15px}
  .brand span{font-size:12px; color:var(--muted)}
  .controls{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    background:rgba(18,24,38,.9);
    border:1px solid rgba(255,255,255,.07);
    box-shadow: 0 10px 22px rgba(0,0,0,.25);
  }
  .chip label{font-size:12px; color:var(--muted)}
  .chip select, .chip input[type="range"]{accent-color: var(--pri)}
  .chip select{
    background:transparent; color:var(--ink);
    border:0; outline:0;
  }
  .chip .small{font-size:12px; color:var(--muted)}
  .btn{
    border:1px solid rgba(255,255,255,.1);
    background:linear-gradient(180deg,#1a2437,#111a2a);
    color:var(--ink);
    padding:10px 12px; border-radius:12px;
    box-shadow: var(--shadow);
    cursor:pointer;
  }
  .btn:active{transform: translateY(1px)}
  .btn.pri{
    border-color: rgba(77,163,255,.35);
    background:linear-gradient(180deg, rgba(77,163,255,.28), rgba(17,26,42,.95));
  }
  .btn.ok{
    border-color: rgba(25,211,122,.35);
    background:linear-gradient(180deg, rgba(25,211,122,.25), rgba(17,26,42,.95));
  }
  .btn.warn{
    border-color: rgba(255,176,32,.35);
    background:linear-gradient(180deg, rgba(255,176,32,.22), rgba(17,26,42,.95));
  }

  .grid{
    display:grid;
    grid-template-columns: 1.4fr .9fr;
    gap:12px;
    margin-top:12px;
  }
  @media (max-width: 920px){
    .grid{grid-template-columns:1fr; }
  }
  .panel{
    background:linear-gradient(180deg, rgba(18,24,38,.9), rgba(15,21,36,.85));
    border:1px solid rgba(255,255,255,.07);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .panel .hd{
    padding:12px 12px;
    border-bottom:1px solid rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .panel .hd b{font-size:14px}
  .panel .hd .sub{font-size:12px; color:var(--muted)}
  .panel .bd{padding:12px}

  /* --- Sanshin stage --- */
  .stageWrap{
    position:relative;
    width:100%;
    aspect-ratio: 16 / 9;
    min-height: 340px;
    background: radial-gradient(1200px 600px at 30% 40%, rgba(77,163,255,.10), transparent 60%),
                radial-gradient(900px 520px at 70% 70%, rgba(25,211,122,.08), transparent 60%),
                linear-gradient(180deg, rgba(10,16,26,.25), rgba(0,0,0,.15));
    border-radius: 18px;
    overflow:hidden;
  }
  @media (max-width: 600px){
    .stageWrap{aspect-ratio: 10/12; min-height: 520px;}
  }
  .hintOverlay{
    position:absolute; left:12px; top:12px;
    display:flex; gap:8px; flex-wrap:wrap;
    pointer-events:none;
  }
  .pill{
    font-size:12px; color:var(--ink);
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.12);
    padding:6px 10px; border-radius:999px;
    backdrop-filter: blur(8px);
  }

  /* Sanshin SVG-like parts using divs */
  .sanshin{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    transform: translateZ(0);
    user-select:none;
    touch-action: none;
  }
  .body{
    position:absolute;
    width:min(42%, 440px);
    aspect-ratio: 1 / 1;
    left: 16%;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 30% 70% 65% 35% / 40% 40% 60% 60%;
    background:
      radial-gradient(220px 220px at 45% 35%, rgba(255,255,255,.12), transparent 60%),
      radial-gradient(360px 300px at 55% 65%, rgba(0,0,0,.35), transparent 60%),
      /* snakeskin-ish */
      repeating-radial-gradient(circle at 40% 45%,
        rgba(0,0,0,.18) 0px, rgba(0,0,0,.18) 2px,
        rgba(255,255,255,.07) 3px, rgba(255,255,255,.07) 6px),
      linear-gradient(180deg, var(--skin1), var(--skin2));
    border: 10px solid rgba(70,48,30,.9);
    box-shadow: 0 28px 55px rgba(0,0,0,.45);
  }
  .body:after{
    content:"";
    position:absolute; inset:10px;
    border-radius: 30% 70% 65% 35% / 40% 40% 60% 60%;
    border: 1px solid rgba(255,255,255,.18);
    pointer-events:none;
  }

  .neck{
    position:absolute;
    height: 18%;
    width: 62%;
    left: 34%;
    top: 48%;
    transform: translateY(-50%) rotate(-1.5deg);
    border-radius: 16px;
    background:
      radial-gradient(120px 60px at 20% 40%, rgba(255,255,255,.14), transparent 60%),
      linear-gradient(90deg, var(--wood1), var(--wood2));
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 20px 36px rgba(0,0,0,.35);
  }
  .fingerboard{
    position:absolute;
    left: 36.5%;
    top: 46.4%;
    transform: translateY(-50%) rotate(-1.5deg);
    width: 58%;
    height: 12.5%;
    border-radius: 12px;
    background:
      linear-gradient(90deg, rgba(0,0,0,.35), rgba(0,0,0,.15)),
      linear-gradient(90deg, #3a2414, #24150c);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .fingerboard .markers{
    position:absolute; inset:0;
    display:flex;
  }
  .marker{
    flex:1;
    position:relative;
    border-right:1px solid rgba(255,255,255,.04);
  }
  .marker:last-child{border-right:0}
  .marker:before{
    content:"";
    position:absolute;
    width:10px; height:10px;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    border-radius:50%;
    background:rgba(255,255,255,.07);
    box-shadow: 0 0 0 1px rgba(255,255,255,.08);
    opacity:.7;
  }
  .marker.active:before{
    background: rgba(77,163,255,.85);
    box-shadow: 0 0 0 2px rgba(77,163,255,.25), 0 0 14px rgba(77,163,255,.55);
    opacity:1;
  }

  .head{
    position:absolute;
    right: 4%;
    top: 36%;
    width: 18%;
    height: 26%;
    transform: rotate(6deg);
    border-radius: 24px;
    background: linear-gradient(180deg, rgba(90,59,34,.95), rgba(40,22,12,.95));
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 18px 36px rgba(0,0,0,.35);
  }
  .peg{
    position:absolute;
    width: 18%;
    height: 12%;
    border-radius: 999px;
    background: linear-gradient(180deg, rgba(210,214,230,.95), rgba(130,136,158,.95));
    box-shadow: 0 10px 18px rgba(0,0,0,.35);
  }
  .peg.p1{left:-8%; top:18%; transform: rotate(-18deg)}
  .peg.p2{left:-10%; top:44%; transform: rotate(-6deg)}
  .peg.p3{left:-8%; top:70%; transform: rotate(12deg)}

  /* strings */
  .strings{
    position:absolute;
    left: 12%;
    top: 22%;
    width: 84%;
    height: 56%;
    pointer-events:none;
  }
  .stringLine{
    position:absolute;
    left:0; right:0;
    height:2px;
    background: linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.65));
    box-shadow: 0 1px 4px rgba(0,0,0,.35);
    opacity:.95;
  }
  .stringLine.s0{top:32%} /* ç”·å¼¦ */
  .stringLine.s1{top:50%} /* ä¸­å¼¦ */
  .stringLine.s2{top:68%} /* å¥³å¼¦ */

  /* bridge (uma) */
  .bridge{
    position:absolute;
    left: 28%;
    top: 56%;
    width: 7%;
    height: 9%;
    transform: rotate(-6deg);
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(220,225,240,.9), rgba(140,148,170,.95));
    border:1px solid rgba(255,255,255,.18);
    box-shadow: 0 12px 22px rgba(0,0,0,.35);
    pointer-events:none;
  }

  /* interactive zones */
  .pluckZone{
    position:absolute;
    left: 8%;
    top: 25%;
    width: 38%;
    height: 55%;
    border-radius: 22px;
    background: rgba(0,0,0,.0);
    /* debug: outline:1px dashed rgba(255,255,255,.15); */
  }
  .fretZone{
    position:absolute;
    left: 36%;
    top: 42%;
    width: 60%;
    height: 22%;
    transform: rotate(-1.5deg);
    border-radius: 14px;
    background: rgba(0,0,0,.0);
    /* debug: outline:1px dashed rgba(255,255,255,.15); */
  }

  /* guide highlight */
  .hl{
    position:absolute;
    width:22px; height:22px;
    border-radius:50%;
    border:2px solid rgba(77,163,255,.95);
    box-shadow: 0 0 0 6px rgba(77,163,255,.15), 0 0 18px rgba(77,163,255,.55);
    pointer-events:none;
    opacity:0;
    transform: translate(-50%,-50%);
  }
  .hl.show{opacity:1}

  .pickFx{
    position:absolute;
    width:18px; height:18px;
    border-radius:6px;
    border:2px solid rgba(255,176,32,.95);
    box-shadow: 0 0 0 6px rgba(255,176,32,.14), 0 0 16px rgba(255,176,32,.55);
    pointer-events:none;
    opacity:0;
    transform: translate(-50%,-50%) rotate(18deg);
  }
  .pickFx.show{opacity:1; animation: pop .22s ease-out}
  @keyframes pop{
    0%{transform: translate(-50%,-50%) scale(.8) rotate(18deg); opacity:.2}
    100%{transform: translate(-50%,-50%) scale(1.08) rotate(18deg); opacity:1}
  }

  /* right panel */
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .row > *{flex: 1}
  .kpi{
    display:grid; grid-template-columns: repeat(3, 1fr);
    gap:10px; margin-top:10px;
  }
  .tile{
    padding:10px 12px; border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.18);
  }
  .tile .t{font-size:12px; color:var(--muted)}
  .tile .v{font-size:16px; margin-top:6px}
  .log{
    margin-top:10px;
    font-size:12px; color:var(--muted);
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:10px 12px;
    max-height: 180px;
    overflow:auto;
    white-space: pre-wrap;
  }
  .progress{
    margin-top:10px;
    height:10px; border-radius:999px;
    background: rgba(255,255,255,.08);
    overflow:hidden;
  }
  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(77,163,255,.95), rgba(25,211,122,.8));
    border-radius:999px;
    transition: width .12s linear;
  }
  .noteList{
    display:flex; gap:8px; overflow:auto; padding-bottom:6px;
  }
  .noteChip{
    min-width: 72px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.18);
    font-size:12px;
  }
  .noteChip.active{
    border-color: rgba(77,163,255,.35);
    box-shadow: 0 0 0 4px rgba(77,163,255,.12);
  }
  .noteChip .s{color:var(--muted); font-size:11px}
  .toast{
    position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
    background: rgba(0,0,0,.72);
    border:1px solid rgba(255,255,255,.14);
    color:var(--ink);
    padding:10px 12px; border-radius: 999px;
    box-shadow: var(--shadow);
    font-size: 13px;
    opacity:0; pointer-events:none;
    transition: opacity .18s ease;
    max-width: 92vw;
  }
  .toast.show{opacity:1}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, Menlo, Consolas, monospace;}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <b>Sanshin Simulator</b>
      <span>ä¸‰ç·šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå®Ÿæ¼”ï¼‹ã‚¬ã‚¤ãƒ‰æ¼”å¥ï¼‰</span>
    </div>

    <div class="controls">
      <button class="btn pri" id="btnUnlock">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹åŒ–</button>
      <button class="btn" id="btnReset">â†º æŠ¼ã•ãˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn ok" id="btnGuide">ğŸµ ã‚¬ã‚¤ãƒ‰</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Stage -->
    <div class="panel">
      <div class="hd">
        <div>
          <b>ä¸‰ç·šï¼ˆæ¼”å¥ï¼‰</b>
          <div class="sub">æŒ‡æ¿ã‚’ã‚¿ãƒƒãƒ—â†’æŠ¼ã•ãˆã‚‹ / èƒ´ã®å¼¦ã‚’ã‚¿ãƒƒãƒ—ãƒ»ãªãã‚‹â†’å¼¾ã</div>
        </div>
        <div class="sub mono" id="status">LOCKED</div>
      </div>

      <div class="bd">
        <div class="stageWrap" id="stage">
          <div class="hintOverlay">
            <div class="pill">ğŸ‘† æŒ‡æ¿ï¼šæŠ¼ã•ãˆã‚‹ï¼ˆå‹˜æ‰€ï¼‰</div>
            <div class="pill">ğŸ– èƒ´ï¼šå¼¾ãï¼ˆã‚¿ãƒƒãƒ—/ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰</div>
            <div class="pill">ğŸµ ã‚¬ã‚¤ãƒ‰ï¼šæ¬¡ã®å ´æ‰€ãŒå…‰ã‚‹</div>
          </div>

          <div class="sanshin" id="sanshin">
            <div class="body"></div>
            <div class="bridge"></div>

            <div class="neck"></div>
            <div class="fingerboard" id="fingerboard">
              <div class="markers" id="markers"></div>
            </div>

            <div class="head">
              <div class="peg p1"></div>
              <div class="peg p2"></div>
              <div class="peg p3"></div>
            </div>

            <div class="strings" id="strings">
              <div class="stringLine s0"></div>
              <div class="stringLine s1"></div>
              <div class="stringLine s2"></div>
            </div>

            <!-- interactive zones -->
            <div class="pluckZone" id="pluckZone"></div>
            <div class="fretZone" id="fretZone"></div>

            <!-- guide highlights -->
            <div class="hl" id="hlFret"></div>
            <div class="pickFx" id="hlPick"></div>
          </div>
        </div>

        <div class="kpi">
          <div class="tile">
            <div class="t">ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</div>
            <div class="v" id="tuningLabel">æœ¬èª¿å­</div>
          </div>
          <div class="tile">
            <div class="t">ã„ã¾æŠ¼ã•ãˆã¦ã‚‹</div>
            <div class="v mono" id="holdLabel">â€”</div>
          </div>
          <div class="tile">
            <div class="t">ã‚¬ã‚¤ãƒ‰åˆ¤å®š</div>
            <div class="v" id="scoreLabel">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Guide / Settings -->
    <div class="panel">
      <div class="hd">
        <div>
          <b>ã‚¬ã‚¤ãƒ‰ / è¨­å®š</b>
          <div class="sub">æ›²ã®ç·´ç¿’ã€ãƒ†ãƒ³ãƒã€éŸ³è‰²ã‚’èª¿æ•´</div>
        </div>
        <div class="sub" id="modeLabel">FREE</div>
      </div>

      <div class="bd">
        <div class="row" style="margin-bottom:10px;">
          <div class="chip" style="flex:1.2">
            <label>ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</label>
            <select id="selTuning">
              <option value="hon">æœ¬èª¿å­ï¼ˆC-F-Cï¼‰</option>
              <option value="niage">äºŒæšã’ï¼ˆD-G-Dï¼‰</option>
              <option value="sansage">ä¸‰ä¸‹ã’ï¼ˆB-E-Bï¼‰</option>
            </select>
          </div>
          <div class="chip" style="flex:1">
            <label>ãƒ†ãƒ³ãƒ</label>
            <input id="rngTempo" type="range" min="50" max="150" value="90"/>
            <span class="small mono" id="tempoVal">90</span>
          </div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <div class="chip">
            <label>éŸ³é‡</label>
            <input id="rngVol" type="range" min="0" max="1" step="0.01" value="0.75"/>
            <span class="small mono" id="volVal">0.75</span>
          </div>
          <div class="chip">
            <label>ãƒªãƒãƒ¼ãƒ–</label>
            <input id="rngRev" type="range" min="0" max="1" step="0.01" value="0.28"/>
            <span class="small mono" id="revVal">0.28</span>
          </div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <div class="chip" style="flex:1.2">
            <label>æ›²</label>
            <select id="selSong"></select>
          </div>
          <button class="btn pri" id="btnDemo">â–¶ ãƒ‡ãƒ¢å†ç”Ÿ</button>
          <button class="btn ok" id="btnPractice">ğŸ§‘â€ğŸ¤ è‡ªåˆ†ã§ç·´ç¿’</button>
        </div>

        <div class="progress" title="ç·´ç¿’ã®é€²è¡Œ">
          <div class="bar" id="prog"></div>
        </div>

        <div style="margin-top:10px;">
          <div class="muted" style="font-size:12px; margin-bottom:6px;">æ¬¡ã®éŸ³ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰</div>
          <div class="noteList" id="noteList"></div>
        </div>

        <div class="log" id="log"></div>

        <div class="muted" style="font-size:12px; margin-top:10px; line-height:1.5;">
          <b>æ“ä½œã®ã‚³ãƒ„</b><br>
          ãƒ»èƒ´ã®å¼¦ã‚’<strong>ç¸¦ã«ãªãã‚‹</strong>ã¨ã€Œã‚«ãƒãƒ£ãƒ¼ã‚·ãƒ¼ã£ã½ã„é€£ç¶šå¼¾ãã€ã«ãªã‚Šã¾ã™ã€‚<br>
          ãƒ»æŒ‡æ¿ã¯ã€Œãƒ•ãƒ¬ãƒƒãƒˆã€ã§ã¯ãªãå‹˜æ‰€ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼ˆã‚¿ãƒƒãƒ—ä½ç½®ã§é¸æŠï¼‰ã€‚<br>
          ãƒ»iPhoneã¯æœ€åˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼ˆSafariåˆ¶é™å¯¾ç­–ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  // -----------------------------
  // Utilities
  // -----------------------------
  const $ = (q, el=document) => el.querySelector(q);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const now = () => performance.now() / 1000;

  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.classList.remove("show"), 1400);
  }

  // -----------------------------
  // Audio (WebAudio pluck model)
  // -----------------------------
  let audioCtx = null;
  let master = null;
  let revGain = null;
  let dryGain = null;
  let convolver = null;
  let unlocked = false;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });
    master = audioCtx.createGain();
    master.gain.value = parseFloat($("#rngVol").value);

    dryGain = audioCtx.createGain();
    revGain = audioCtx.createGain();
    revGain.gain.value = parseFloat($("#rngRev").value);

    convolver = audioCtx.createConvolver();
    convolver.buffer = makeImpulseResponse(audioCtx, 2.2, 0.45);

    dryGain.connect(master);
    convolver.connect(revGain);
    revGain.connect(master);

    master.connect(audioCtx.destination);
  }

  function makeImpulseResponse(ctx, seconds=2.0, decay=0.5){
    const rate = ctx.sampleRate;
    const length = Math.floor(rate * seconds);
    const impulse = ctx.createBuffer(2, length, rate);
    for(let ch=0; ch<2; ch++){
      const data = impulse.getChannelData(ch);
      for(let i=0; i<length; i++){
        const t = i / length;
        // decaying noise
        data[i] = (Math.random()*2-1) * Math.pow(1 - t, decay*6);
      }
    }
    return impulse;
  }

  function warmupUnlock(){
    ensureAudio();
    // iOS/Safari unlock trick: a tiny sound burst + resume
    audioCtx.resume().catch(()=>{});
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    g.gain.value = 0.0001;
    o.frequency.value = 220;
    o.connect(g);
    g.connect(master);
    o.start();
    o.stop(audioCtx.currentTime + 0.03);
    unlocked = true;
    $("#status").textContent = "READY";
    toast("éŸ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ");
  }

  // Karplus-Strong-ish pluck using noise burst through bandpass + resonator
  function pluck(freq, intensity=0.9){
    if(!unlocked) return;
    const t0 = audioCtx.currentTime;

    // excitation noise
    const noiseBuf = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * 0.06), audioCtx.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++){
      // more bite at beginning
      const x = (Math.random()*2-1);
      data[i] = x * Math.pow(1 - i/data.length, 1.8);
    }
    const src = audioCtx.createBufferSource();
    src.buffer = noiseBuf;

    // tone shaping
    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.value = freq * 1.2;
    bp.Q.value = 2.5;

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = Math.min(5200, freq*14);
    lp.Q.value = 0.7;

    // resonator
    const reson = audioCtx.createBiquadFilter();
    reson.type = "peaking";
    reson.frequency.value = freq;
    reson.Q.value = 8.5;
    reson.gain.value = 9.0;

    // body/air
    const body = audioCtx.createBiquadFilter();
    body.type = "lowshelf";
    body.frequency.value = 220;
    body.gain.value = 6.0;

    const body2 = audioCtx.createBiquadFilter();
    body2.type = "peaking";
    body2.frequency.value = 780;
    body2.Q.value = 1.2;
    body2.gain.value = 3.5;

    // amplitude env
    const g = audioCtx.createGain();
    const a = clamp(intensity, 0.15, 1.25);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.8 * a, t0 + 0.008);
    g.gain.exponentialRampToValueAtTime(0.28 * a, t0 + 0.08);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.25);

    // connect
    src.connect(bp);
    bp.connect(lp);
    lp.connect(reson);
    reson.connect(body);
    body.connect(body2);
    body2.connect(g);

    // dry + wet
    g.connect(dryGain);
    g.connect(convolver);

    src.start();
    src.stop(t0 + 0.07);
  }

  // -----------------------------
  // Music model (tuning & notes)
  // -----------------------------
  // Open strings: [Ojin, Nakajin, Mi-jin]
  // We'll use C3-F3-C4 as "hon" (æœ¬èª¿å­) base; other tunings shift.
  const TUNINGS = {
    hon:   { name:"æœ¬èª¿å­",  midi:[48, 53, 60] },  // C3 F3 C4
    niage: { name:"äºŒæšã’",  midi:[50, 55, 62] },  // D3 G3 D4
    sansage:{name:"ä¸‰ä¸‹ã’",  midi:[47, 52, 59] },  // B2 E3 B3
  };

  function midiToFreq(m){ return 440 * Math.pow(2, (m - 69)/12); }

  const STRINGS = [
    { key:"ojin", name:"ç”·å¼¦", idx:0 },
    { key:"nakajin", name:"ä¸­å¼¦", idx:1 },
    { key:"mijin", name:"å¥³å¼¦", idx:2 },
  ];

  // We will offer 12 "positions" (0=open .. 11) for simplicity.
  const POS_MAX = 11;

  // Current held position per string
  const held = [0,0,0];

  function getHeldLabel(){
    return `ç”·:${held[0]} / ä¸­:${held[1]} / å¥³:${held[2]}`;
  }

  function getNoteMidi(stringIdx, pos){
    const tuningKey = $("#selTuning").value;
    const base = TUNINGS[tuningKey].midi[stringIdx];
    return base + pos;
  }

  function getNoteName(m){
    const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const n = names[(m%12+12)%12];
    const oct = Math.floor(m/12)-1;
    return `${n}${oct}`;
  }

  // -----------------------------
  // UI: fingerboard markers
  // -----------------------------
  const markersEl = $("#markers");
  const markerDivs = [];
  function buildMarkers(){
    markersEl.innerHTML = "";
    markerDivs.length = 0;
    const count = POS_MAX + 1; // include open
    for(let i=0;i<count;i++){
      const d = document.createElement("div");
      d.className = "marker";
      d.dataset.pos = String(i);
      markersEl.appendChild(d);
      markerDivs.push(d);
    }
    updateMarkerHighlight();
  }

  function updateMarkerHighlight(){
    markerDivs.forEach(d => d.classList.remove("active"));
    // show the maximum held position as a single highlight (simple visual)
    const maxPos = Math.max(...held);
    const el = markerDivs[maxPos];
    if(el) el.classList.add("active");
    $("#holdLabel").textContent = getHeldLabel();
  }

  // Convert pointer position inside fretZone -> string + pos
  function pickStringFromY(relY){
    // relY: 0..1 across the fretZone height
    // map near 0.25,0.5,0.75
    const targets = [0.28, 0.5, 0.72];
    let best = 0, bestd = 9;
    for(let i=0;i<3;i++){
      const d = Math.abs(relY - targets[i]);
      if(d < bestd){ bestd = d; best = i; }
    }
    return best;
  }

  function posFromX(relX){
    // relX: 0..1 -> 0..POS_MAX
    return clamp(Math.round(relX * POS_MAX), 0, POS_MAX);
  }

  function setHold(stringIdx, pos){
    held[stringIdx] = pos;
    updateMarkerHighlight();
    const m = getNoteMidi(stringIdx, pos);
    logLine(`æŠ¼ã•ãˆ: ${STRINGS[stringIdx].name} pos=${pos} (${getNoteName(m)})`);
  }

  // -----------------------------
  // Pluck interaction
  // -----------------------------
  const pluckZone = $("#pluckZone");
  const fretZone  = $("#fretZone");
  const hlFret = $("#hlFret");
  const hlPick = $("#hlPick");

  let lastPluckedString = -1;
  let lastPluckAt = 0;

  function pluckString(sIdx, intensity=0.9){
    const m = getNoteMidi(sIdx, held[sIdx]);
    const f = midiToFreq(m);
    pluck(f, intensity);
    lastPluckedString = sIdx;
    lastPluckAt = now();

    // guide judge hook
    onUserPluck(sIdx, held[sIdx]);

    // visual pick FX
    const r = pluckZone.getBoundingClientRect();
    const yMap = [0.34, 0.52, 0.70];
    const x = r.left + r.width*0.55;
    const y = r.top + r.height*yMap[sIdx];
    hlPick.style.left = `${x}px`;
    hlPick.style.top  = `${y}px`;
    hlPick.classList.remove("show");
    void hlPick.offsetWidth;
    hlPick.classList.add("show");

    logLine(`å¼¾ã: ${STRINGS[sIdx].name} (${getNoteName(m)})`);
  }

  function getStringFromPluckY(relY){
    const targets = [0.34, 0.52, 0.70];
    let best = 0, bestd = 9;
    for(let i=0;i<3;i++){
      const d = Math.abs(relY - targets[i]);
      if(d < bestd){ bestd = d; best = i; }
    }
    return best;
  }

  let dragActive = false;
  let lastDragString = -1;
  let lastDragTime = 0;

  function handlePluckPointer(e){
    if(!unlocked) return;
    const r = pluckZone.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    const y = (e.clientY - r.top) / r.height;
    if(x < -0.1 || x > 1.1 || y < -0.1 || y > 1.1) return;

    const s = getStringFromPluckY(y);
    const t = now();
    // If dragging, trigger when crossing to another string or enough time passed.
    if(!dragActive){
      pluckString(s, 0.95);
      lastDragString = s;
      lastDragTime = t;
    }else{
      const dt = t - lastDragTime;
      if(s !== lastDragString || dt > 0.12){
        const intensity = clamp(0.55 + Math.abs(y - (s===0?0.34:s===1?0.52:0.70))*1.2, 0.45, 1.0);
        pluckString(s, intensity);
        lastDragString = s;
        lastDragTime = t;
      }
    }
  }

  // -----------------------------
  // Fret interaction
  // -----------------------------
  function handleFretPointer(e){
    if(!unlocked) return;
    const r = fretZone.getBoundingClientRect();
    const x = (e.clientX - r.left) / r.width;
    const y = (e.clientY - r.top) / r.height;
    if(x < 0 || x > 1 || y < 0 || y > 1) return;
    const s = pickStringFromY(y);
    const p = posFromX(x);
    setHold(s, p);

    // visual highlight
    const hx = r.left + r.width * (p / POS_MAX);
    const yMap = [0.28, 0.5, 0.72];
    const hy = r.top + r.height * yMap[s];
    hlFret.style.left = `${hx}px`;
    hlFret.style.top  = `${hy}px`;
    hlFret.classList.add("show");
    clearTimeout(handleFretPointer._tm);
    handleFretPointer._tm = setTimeout(()=>hlFret.classList.remove("show"), 260);
  }

  // -----------------------------
  // Guide mode (songs)
  // -----------------------------
  const SONGS = [
    {
      id:"warmup_scale",
      name:"ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ï¼šä¸Šè¡Œï¼ˆç°¡æ˜“ï¼‰",
      desc:"å„å¼¦ã§å°‘ã—ãšã¤ä¸Šã¸ã€‚æŠ¼ã•ãˆï¼†å¼¾ãã®åŸºæœ¬ã€‚",
      // Each note: {s:0..2, p:0..POS_MAX, d: beats}
      notes: [
        // ojin
        {s:0,p:0,d:1},{s:0,p:2,d:1},{s:0,p:4,d:1},{s:0,p:5,d:1},{s:0,p:7,d:1},
        // nakajin
        {s:1,p:0,d:1},{s:1,p:2,d:1},{s:1,p:4,d:1},{s:1,p:5,d:1},{s:1,p:7,d:1},
        // mijin
        {s:2,p:0,d:1},{s:2,p:2,d:1},{s:2,p:4,d:1},{s:2,p:5,d:1},{s:2,p:7,d:2},
      ]
    },
    {
      id:"kachaashi_rhythm",
      name:"ã‚«ãƒãƒ£ãƒ¼ã‚·ãƒ¼ï¼šãƒªã‚ºãƒ ç·´ç¿’",
      desc:"é€£ç¶šå¼¾ãã®ãƒãƒªã€‚æŠ¼ã•ãˆãªã—ã§OKã€‚",
      notes: [
        {s:0,p:0,d:.5},{s:1,p:0,d:.5},{s:2,p:0,d:.5},{s:1,p:0,d:.5},
        {s:0,p:0,d:.5},{s:1,p:0,d:.5},{s:2,p:0,d:.5},{s:1,p:0,d:.5},
        {s:0,p:0,d:.5},{s:1,p:0,d:.5},{s:2,p:0,d:.5},{s:1,p:0,d:.5},
        {s:0,p:0,d:.5},{s:1,p:0,d:.5},{s:2,p:0,d:.5},{s:1,p:0,d:1},
      ]
    },
    {
      id:"tinsagu_simple",
      name:"ã¦ãƒã‚“ã•ãã¬èŠ±ï¼ˆç·´ç¿’ç”¨ãƒ»ç°¡æ˜“ï¼‰",
      desc:"ä¼çµ±æ›²ã®é›°å›²æ°—ã§ã€åˆå¿ƒè€…å‘ã‘ã«çŸ­ãã€‚",
      notes: [
        {s:2,p:0,d:1},{s:2,p:2,d:1},{s:2,p:4,d:1},{s:2,p:2,d:1},
        {s:1,p:0,d:1},{s:1,p:2,d:1},{s:2,p:0,d:2},
        {s:2,p:0,d:1},{s:2,p:2,d:1},{s:2,p:4,d:1},{s:2,p:5,d:1},
        {s:1,p:2,d:1},{s:1,p:0,d:1},{s:2,p:0,d:2},
      ]
    },
    {
      id:"asadoya_simple",
      name:"å®‰é‡Œå±‹ãƒ¦ãƒ³ã‚¿ï¼ˆç·´ç¿’ç”¨ãƒ»ç°¡æ˜“ï¼‰",
      desc:"ä¼çµ±æ›²ã®é›°å›²æ°—ã§ã€çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºç·´ç¿’ã€‚",
      notes: [
        {s:1,p:0,d:1},{s:1,p:2,d:1},{s:2,p:0,d:1},{s:2,p:2,d:1},
        {s:2,p:4,d:1},{s:2,p:2,d:1},{s:1,p:0,d:2},
        {s:2,p:0,d:1},{s:2,p:2,d:1},{s:2,p:4,d:1},{s:2,p:5,d:1},
        {s:1,p:2,d:1},{s:1,p:0,d:1},{s:1,p:0,d:2},
      ]
    },
  ];

  const selSong = $("#selSong");
  function buildSongSelect(){
    selSong.innerHTML = "";
    for(const s of SONGS){
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      selSong.appendChild(opt);
    }
  }

  function getSong(){
    return SONGS.find(x => x.id === selSong.value) || SONGS[0];
  }

  // Guide state
  let guideMode = false;
  let guideRun = null; // {type:'demo'|'practice', idx, tStart, tNext, score...}
  let awaiting = null; // expected note for practice

  function bpmToSecPerBeat(bpm){ return 60 / bpm; }

  function renderUpcoming(){
    const list = $("#noteList");
    list.innerHTML = "";
    const song = getSong();
    const idx = guideRun?.idx ?? 0;
    const maxShow = 10;

    for(let k=0;k<maxShow;k++){
      const n = song.notes[idx+k];
      if(!n) break;
      const chip = document.createElement("div");
      chip.className = "noteChip" + (k===0 ? " active":"");
      chip.innerHTML = `<div><b>${STRINGS[n.s].name}</b> pos ${n.p}</div>
                        <div class="s">${n.d} beat</div>`;
      list.appendChild(chip);
    }
  }

  function moveGuideHighlight(note){
    // highlight fret target and predicted pick
    const fr = fretZone.getBoundingClientRect();
    const x = fr.left + fr.width * (note.p / POS_MAX);
    const yMapF = [0.28, 0.5, 0.72];
    const y = fr.top + fr.height * yMapF[note.s];
    hlFret.style.left = `${x}px`;
    hlFret.style.top  = `${y}px`;
    hlFret.classList.add("show");

    // also highlight pick in pluck zone
    const pr = pluckZone.getBoundingClientRect();
    const yMapP = [0.34, 0.52, 0.70];
    const px = pr.left + pr.width*0.55;
    const py = pr.top + pr.height*yMapP[note.s];
    hlPick.style.left = `${px}px`;
    hlPick.style.top  = `${py}px`;
  }

  function stopGuide(){
    guideRun = null;
    awaiting = null;
    $("#prog").style.width = "0%";
    $("#modeLabel").textContent = "FREE";
    $("#scoreLabel").textContent = "â€”";
    hlFret.classList.remove("show");
    hlPick.classList.remove("show");
    renderUpcoming();
    logLine("ã‚¬ã‚¤ãƒ‰åœæ­¢");
  }

  function startDemo(){
    if(!unlocked){ toast("å…ˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„"); return; }
    const song = getSong();
    const bpm = parseInt($("#rngTempo").value,10);
    const spb = bpmToSecPerBeat(bpm);
    guideRun = { type:"demo", idx:0, tNext: now() + 1.0, bpm, spb };
    $("#modeLabel").textContent = "DEMO";
    $("#scoreLabel").textContent = "â€”";
    $("#prog").style.width = "0%";
    logLine(`ãƒ‡ãƒ¢é–‹å§‹: ${song.name}ï¼ˆ${bpm} BPMï¼‰`);
    renderUpcoming();
    tickGuide();
  }

  function startPractice(){
    if(!unlocked){ toast("å…ˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„"); return; }
    const song = getSong();
    const bpm = parseInt($("#rngTempo").value,10);
    const spb = bpmToSecPerBeat(bpm);
    guideRun = { type:"practice", idx:0, tNext: now() + 1.0, bpm, spb, ok:0, miss:0, streak:0, total: song.notes.length };
    $("#modeLabel").textContent = "PRACTICE";
    $("#scoreLabel").textContent = "0%";
    $("#prog").style.width = "0%";
    logLine(`ç·´ç¿’é–‹å§‹: ${song.name}ï¼ˆ${bpm} BPMï¼‰`);
    renderUpcoming();
    tickGuide();
  }

  function tickGuide(){
    if(!guideRun) return;
    const song = getSong();
    const t = now();

    if(guideRun.idx >= song.notes.length){
      if(guideRun.type === "practice"){
        const pct = Math.round((guideRun.ok / Math.max(1, guideRun.total)) * 100);
        $("#scoreLabel").textContent = `${pct}%ï¼ˆOK:${guideRun.ok} / MISS:${guideRun.miss}ï¼‰`;
        toast(`å®Œäº†ï¼ã‚¹ã‚³ã‚¢ ${pct}%`);
      }else{
        toast("ãƒ‡ãƒ¢å®Œäº†");
      }
      stopGuide();
      return;
    }

    // update progress
    const prog = (guideRun.idx / song.notes.length) * 100;
    $("#prog").style.width = `${prog.toFixed(1)}%`;

    if(t >= guideRun.tNext){
      const note = song.notes[guideRun.idx];
      moveGuideHighlight(note);
      renderUpcoming();

      if(guideRun.type === "demo"){
        // auto: set hold + pluck
        held[note.s] = note.p;
        updateMarkerHighlight();
        pluckString(note.s, 0.92);
        // schedule next
        guideRun.tNext = t + note.d * guideRun.spb;
        guideRun.idx++;
      }else{
        // practice: just prompt expected note; user must pluck
        awaiting = {
          s: note.s, p: note.p,
          // allow timing window around the beat
          t0: t,
          t1: t + note.d * guideRun.spb,
          // tolerance: user can be early/late within this
          tol: Math.min(0.22, 0.14 + guideRun.spb*0.12)
        };
        // we don't advance here; advance on user pluck correct
        // but also set an auto-miss if time passes
        guideRun.tNext = t + note.d * guideRun.spb;
      }
    }

    // practice: if time passed and still awaiting, mark miss and advance
    if(guideRun.type === "practice" && awaiting){
      if(t > awaiting.t1 + awaiting.tol){
        guideRun.miss++;
        guideRun.streak = 0;
        logLine(`MISS: ${STRINGS[awaiting.s].name} pos${awaiting.p}`);
        advancePractice();
      }else{
        // show expectation in hold highlight (optional: auto-set? we won't)
        moveGuideHighlight(awaiting);
      }
      const pct = Math.round((guideRun.ok / Math.max(1, guideRun.total)) * 100);
      $("#scoreLabel").textContent = `${pct}%ï¼ˆOK:${guideRun.ok} / MISS:${guideRun.miss}ï¼‰`;
    }

    requestAnimationFrame(tickGuide);
  }

  function advancePractice(){
    if(!guideRun || guideRun.type !== "practice") return;
    awaiting = null;
    guideRun.idx++;
    renderUpcoming();
  }

  // called from pluckString
  function onUserPluck(s, p){
    if(!guideRun || guideRun.type !== "practice") return;
    if(!awaiting) return;

    const t = now();
    const okTime = (t >= awaiting.t0 - awaiting.tol) && (t <= awaiting.t1 + awaiting.tol);
    const okNote = (s === awaiting.s && p === awaiting.p);

    if(okTime && okNote){
      guideRun.ok++;
      guideRun.streak++;
      logLine(`OK! streak=${guideRun.streak}`);
      toast(guideRun.streak >= 3 ? `âœ… OK x${guideRun.streak}` : "âœ… OK");
      advancePractice();
    }else{
      // soft penalty: only count miss if clearly wrong
      if(okTime && !okNote){
        guideRun.miss++;
        guideRun.streak = 0;
        logLine(`MISS(wrong): expected ${STRINGS[awaiting.s].name} pos${awaiting.p} / got ${STRINGS[s].name} pos${p}`);
        toast("âš  ã¡ãŒã†å¼¦/å‹˜æ‰€");
        advancePractice();
      }
    }
  }

  // -----------------------------
  // Logging
  // -----------------------------
  const logEl = $("#log");
  function logLine(s){
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${s}\n` + logEl.textContent;
  }

  // -----------------------------
  // Wiring
  // -----------------------------
  buildMarkers();
  buildSongSelect();

  function applyTuningLabel(){
    const key = $("#selTuning").value;
    $("#tuningLabel").textContent = `${TUNINGS[key].name}`;
  }

  $("#btnUnlock").addEventListener("click", () => {
    warmupUnlock();
  });

  // Also unlock on first touch anywhere on stage
  $("#stage").addEventListener("pointerdown", (e) => {
    if(!unlocked){
      warmupUnlock();
    }
  }, {passive:true});

  $("#btnReset").addEventListener("click", () => {
    held[0]=0; held[1]=0; held[2]=0;
    updateMarkerHighlight();
    toast("æŠ¼ã•ãˆã‚’ãƒªã‚»ãƒƒãƒˆ");
  });

  $("#btnGuide").addEventListener("click", () => {
    guideMode = !guideMode;
    toast(guideMode ? "ã‚¬ã‚¤ãƒ‰ONï¼ˆå³ã§æ›²ã‚’é¸æŠï¼‰" : "ã‚¬ã‚¤ãƒ‰OFF");
  });

  $("#selTuning").addEventListener("change", () => {
    applyTuningLabel();
    updateMarkerHighlight();
    toast(`ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°: ${TUNINGS[$("#selTuning").value].name}`);
  });

  $("#rngTempo").addEventListener("input", () => {
    $("#tempoVal").textContent = $("#rngTempo").value;
  });
  $("#rngVol").addEventListener("input", () => {
    const v = parseFloat($("#rngVol").value);
    $("#volVal").textContent = v.toFixed(2);
    if(master) master.gain.value = v;
  });
  $("#rngRev").addEventListener("input", () => {
    const v = parseFloat($("#rngRev").value);
    $("#revVal").textContent = v.toFixed(2);
    if(revGain) revGain.gain.value = v;
  });

  $("#btnDemo").addEventListener("click", () => startDemo());
  $("#btnPractice").addEventListener("click", () => startPractice());

  selSong.addEventListener("change", () => {
    const song = getSong();
    logLine(`æ›²é¸æŠ: ${song.name} / ${song.desc}`);
    stopGuide();
    renderUpcoming();
  });

  // pluck zone pointer events
  pluckZone.addEventListener("pointerdown", (e) => {
    if(!unlocked){ warmupUnlock(); }
    dragActive = true;
    pluckZone.setPointerCapture(e.pointerId);
    handlePluckPointer(e);
  });
  pluckZone.addEventListener("pointermove", (e) => {
    if(!dragActive) return;
    handlePluckPointer(e);
  });
  pluckZone.addEventListener("pointerup", (e) => {
    dragActive = false;
    try{ pluckZone.releasePointerCapture(e.pointerId); }catch(_){}
  });
  pluckZone.addEventListener("pointercancel", () => { dragActive = false; });

  // fret zone pointer events
  fretZone.addEventListener("pointerdown", (e) => {
    if(!unlocked){ warmupUnlock(); }
    fretZone.setPointerCapture(e.pointerId);
    handleFretPointer(e);
  });
  fretZone.addEventListener("pointermove", (e) => {
    if(e.buttons) handleFretPointer(e);
  });
  fretZone.addEventListener("pointerup", (e) => {
    try{ fretZone.releasePointerCapture(e.pointerId); }catch(_){}
  });

  // init labels
  $("#tempoVal").textContent = $("#rngTempo").value;
  $("#volVal").textContent = parseFloat($("#rngVol").value).toFixed(2);
  $("#revVal").textContent = parseFloat($("#rngRev").value).toFixed(2);
  applyTuningLabel();
  updateMarkerHighlight();
  renderUpcoming();

  logLine("èµ·å‹•ã€‚ã¾ãšã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã¾ãŸã¯ç”»é¢ã‚¿ãƒƒãƒ—ã§éŸ³ã‚’è§£éŒ ã—ã¦ãã ã•ã„ã€‚");
})();
</script>
</body>
</html>
