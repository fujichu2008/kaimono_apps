<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Êï∞Â≠ó„ÅßÈ≠öÈá£„Çä</title>
<meta name="theme-color" content="#58a6ff" />
<style>
  :root{ --bg:#eaf6ff; --water:#cfeeff; --deep:#a8dcff; --text:#0f172a; --btn:#2563eb; --btn-t:#ffffff; --card:#ffffff; --line:#dbeafe; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif; color:var(--text); background:linear-gradient(#eaf6ff,#cfeeff)}
  .app{max-width:560px; margin:0 auto; padding:12px 12px 24px; min-height:100%; display:flex; flex-direction:column; gap:12px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px}
  h1{font-size:clamp(22px,5vw,28px); margin:0; letter-spacing:.02em}
  .score{font-size:clamp(16px,4.2vw,18px); background:var(--card); border:1px solid var(--line); padding:6px 10px; border-radius:999px}

  .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  button{appearance:none; border:0; border-radius:16px; padding:12px 14px; font-size:clamp(16px,4.2vw,18px); font-weight:700; background:var(--btn); color:var(--btn-t); box-shadow:0 6px 14px rgba(0,0,0,.08)}
  button.secondary{background:#0ea5e9}
  button.ghost{background:#ffffff; color:#0f172a; border:1px solid var(--line)}
  button.tab{background:#fff; color:#0f172a; border:1px solid var(--line); padding:8px 12px}
  button.tab.active{background:#2563eb; color:#fff; border-color:#2563eb}
  button:disabled{opacity:.55}
  .modeBadge{font-weight:800; font-size:14px; padding:6px 10px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; color:#312e81}

  .sea{flex:1; border:1px solid var(--line); border-radius:24px; overflow:hidden; position:relative; background:var(--deep)}
  .sky{height:120px; background:linear-gradient(#bfe5ff,#eaf6ff); position:relative; overflow:hidden}
  .sky .bird{position:absolute; top:18px; font-size:22px; filter:drop-shadow(0 1px 0 #ffffffaa); animation:bird-fly 6.5s linear forwards}
  @keyframes bird-fly{ from{ transform:translateX(-20%)} to{ transform:translateX(120%)} }

  .boat{position:absolute; left:16px; bottom:10px; width:150px; height:80px}
  .boat .hull{position:absolute; left:0; bottom:0; width:150px; height:40px; background:#0ea5e9; border-radius:0 0 18px 18px; box-shadow:0 5px 0 #0978a5 inset}
  .boat .person{position:absolute; left:18px; bottom:38px; font-size:26px; line-height:1; filter:drop-shadow(0 1px 0 #ffffffaa); user-select:none;}
  .captain-pop{ animation: cap-pop .26s ease-out; }
  @keyframes cap-pop{ 0%{transform:translateY(0) scale(1)} 50%{transform:translateY(-2px) scale(1.12)} 100%{transform:translateY(0) scale(1)} }

  .boat .rod{ position:absolute; left:68px; bottom:24px; width:180px; height:90px; border-top:3px solid #333; border-right:3px solid transparent; transform:skewY(-12deg) rotate(-3deg); }
  .boat .line{ position:absolute; left:228px; bottom:54px; width:2px; height:36px; background:#333; }

  .bucket{position:absolute; left:110px; bottom:10px; width:26px; height:28px; border:2px solid #1f2937; border-radius:4px 4px 10px 10px; background:#e5f3ff}
  .bucket::after{content:""; position:absolute; inset:3px; border-radius:2px 2px 8px 8px; background:#bfe5ff}

  .surface{height:12px; position:relative; z-index:1}
  .surface::before{content:""; position:absolute; inset:0; background:repeating-linear-gradient(90deg, #ffffffaa 0 24px, #ffffff66 24px 48px)}
  .island{ position:absolute; left:50%; transform:translateX(-50%); bottom:-2px; z-index:2; width:120px; height:28px; background:radial-gradient(120% 100% at 50% 0%, #fde68a, #f59e0b); border-top-left-radius:60% 90%; border-top-right-radius:60% 90%; box-shadow:0 -2px 0 #eab308 inset, 0 6px 12px rgba(0,0,0,.15); }
  .island::after{ content:"üå¥"; position:absolute; left:50%; transform:translateX(-50%); bottom:18px; font-size:20px; filter:drop-shadow(0 1px 0 #fff); }

  .undersea{position:absolute; inset:152px 0 0 0; padding:12px; background: radial-gradient(120% 80% at 50% 0%, var(--water), var(--deep)); overflow:hidden; min-height:420px; padding-bottom:max(16px, env(safe-area-inset-bottom) + 24px);}

  .prompt{position:absolute; top:156px; left:0; right:0; display:flex; justify-content:center; z-index:3}
  .prompt .bubble{background:#ffffffd8; border:1px solid var(--line); border-radius:999px; padding:8px 14px; font-size:clamp(16px,5vw,18px); font-weight:800}

  .grid{position:absolute; inset:0; min-height:360px; padding:0;}

  /* È≠ö */
  .fish{ position:absolute; width:120px; height:60px; border-radius:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent; outline:0; border:0; background:none; }
  .fish .hit{position:absolute; inset:-26px; border-radius:34px;}
  .fish .wrap{position:absolute; inset:0; display:block; transform-origin:center center;}
  .fish svg{width:100%; height:100%; display:block; filter:drop-shadow(0 6px 10px rgba(0,0,0,.12));}
  .fish .num{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; color:#083344; text-shadow:0 2px 8px #ffffffc0; pointer-events:none}
  .fish .num span{font-size:36px; line-height:1;}
  .fish:active .wrap{transform:scale(.98)}

  /* „Çµ„É° */
  .shark{ position:absolute; width:200px; height:100px; border-radius:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; outline:0; border:0; background:none; z-index:2; }
  .shark .hit{position:absolute; inset:-30px; border-radius:40px;}
  .shark .wrap{position:absolute; inset:0; display:block; transform-origin:center center; animation:shark-rock 1.1s ease-in-out infinite alternate;}
  .shark .num{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; color:#08131f; text-shadow:0 2px 8px #ffffffc0;}
  .shark .num span{font-size:48px; line-height:1;}
  @keyframes shark-rock{ 0%{ transform:translate(0,-2px) rotate(-2.2deg) scale(1.03)} 100%{ transform:translate(0,2px) rotate(2.2deg) scale(1.06)} }

  .gold{ filter: drop-shadow(0 0 10px #ffd54a) drop-shadow(0 0 18px #ffd54a); }

  .target .wrap{animation:pulse 1.2s ease-in-out infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  .hint .wrap{animation:hintshake .28s ease-in-out infinite}
  @keyframes hintshake{0%{transform:translateX(0)}25%{transform:translateX(-1.4px)}50%{transform:translateX(0)}75%{transform:translateX(1.4px)}100%{transform:translateX(0)}}

  .splash{position:absolute; inset:0; pointer-events:none}
  .splash::after{content:""; position:absolute; left:50%; top:50%; width:10vmin; height:10vmin; border:3px solid #fff; border-radius:50%; transform:translate(-50%,-50%) scale(.2); opacity:0; animation:ripple .6s ease-out}
  @keyframes ripple{to{transform:translate(-50%,-50%) scale(2.3); opacity:1}}

  .fish.fade,.shark.fade{visibility:hidden; pointer-events:none}
  .fly{position:absolute; will-change:transform; z-index:5}

  .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#000000cc; color:#fff; padding:10px 14px; border-radius:14px; font-weight:700; z-index:99; opacity:0; pointer-events:none}
  .toast.show{animation:toast .9s ease-out}
  @keyframes toast{0%{opacity:0; transform:translate(-50%,20px)}15%{opacity:1; transform:translate(-50%,0)}85%{opacity:1}100%{opacity:0; transform:translate(-50%,-8px)}}

  dialog{border:0; border-radius:16px; padding:16px; max-width:420px; width:calc(100% - 24px); box-shadow:0 24px 60px rgba(0,0,0,.2)}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  .row{display:flex; gap:8px; align-items:center}
  input[type="text"]{flex:1; font-size:18px; padding:10px 12px; border-radius:12px; border:1px solid var(--line)}
  .safe{padding-bottom: env(safe-area-inset-bottom)}

  .result{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:#00000055}
  .resultCard{background:#fff; border-radius:18px; border:1px solid var(--line); padding:16px; width:min(92%,480px); text-align:center}
  .result h2{margin:0 0 8px}
  .dots{display:flex; gap:6px; justify-content:center; margin-top:6px}
  .dot{width:10px; height:10px; border-radius:50%; background:#cfe2ff}
  .dot.on{background:#2563eb}

  .evt-fog .fish .num{opacity:.35}
  .evt-fog .fish.target .num{opacity:1; filter:drop-shadow(0 0 6px #fff)}
  .evt-freeze{ filter: hue-rotate(-10deg) saturate(0.9); }

  .guide{position:absolute; width:28px; height:28px; pointer-events:none; z-index:6; font-size:24px;}

  /* ÊàêÂäüÊôÇ„ÅÆ‚ÄúÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑ„ÅÆÊï∞Â≠ó‚Äù */
  .megaNum{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:7; }
  .megaNum span{
    font-weight:900; color:#05303a;
    text-shadow: 0 10px 35px #ffffff, 0 0 0 #0000;
    font-size: min(32vmin, 240px);
    transform:scale(.2); opacity:0;
  }
  .megaNum.show span{ animation: mega-pop 1200ms cubic-bezier(.2,.7,.2,1) forwards; }
  @keyframes mega-pop{
    0%{ transform:scale(.2); opacity:0 }
    18%{ opacity:1 }
    70%{ transform:scale(1.8) }
    100%{ transform:scale(2.4); opacity:0 }
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Êï∞Â≠ó„ÅßÈ≠öÈá£„Çä</h1>
      <div class="score" id="scoreBox">„Çπ„Ç≥„Ç¢ 0 / ÊÆã„Çä 5</div>
    </header>

    <div class="controls">
      <button class="tab active" id="easyTab">„Åã„Çì„Åü„Çì</button>
      <button class="tab" id="normalTab">„Åµ„Å§„ÅÜ</button>
      <span class="modeBadge" id="modeBadge">„Åã„Çì„Åü„Çì„É¢„Éº„Éâ</span>
      <button id="startBtn">‚ñ∂ „ÅØ„Åò„ÇÅ„Çã</button>
      <button class="secondary" id="repeatBtn" disabled>üîä „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
      <button class="ghost" id="muteBtn" aria-pressed="false">üîà Èü≥„ÅÇ„Çä</button>
      <button class="ghost" id="nameBtn">üôÇ „Å™„Åæ„Åà</button>
    </div>

    <div class="sea safe">
      <div class="sky" id="sky">
        <div class="boat">
          <div class="hull"></div>
          <div class="bucket" id="bucket"></div>
          <div class="person" id="captain" aria-live="polite" title="ËàπÈï∑">üòê</div>
          <div class="rod"></div>
          <div class="line" id="line"></div>
        </div>
      </div>
      <div class="surface" id="surface"></div>
      <div class="prompt"><div class="bubble" id="promptText">„Éú„Çø„É≥„Çí„Åä„Åó„Å¶ „ÅØ„Åò„ÇÅ„Çà„ÅÜ</div></div>
      <div class="undersea">
        <div class="grid" id="grid"></div>
        <div id="fx" style="position:absolute;inset:0;pointer-events:none;"></div>
      </div>
      <div class="result" id="result">
        <div class="resultCard">
          <h2 id="resTitle">„Åë„Å£„Åã</h2>
          <p id="resScore">„Çπ„Ç≥„Ç¢ 0 / 5</p>
          <p id="resComment">„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ</p>
          <div class="dots" id="roundDots"></div>
          <div style="margin-top:10px; display:flex; gap:8px; justify-content:center">
            <button id="againBtn">üîÅ „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
            <button class="ghost" id="closeBtn">„Å®„Åò„Çã</button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <dialog id="nameDlg">
    <form method="dialog">
      <h3 style="margin:0 0 8px">„Åä„Å™„Åæ„Åà„Çí „Åä„Åó„Åà„Å¶„Å≠</h3>
      <div class="row" style="margin-bottom:10px">
        <input id="nameInput" type="text" placeholder="„Å™„Åæ„Åà" maxlength="16" autocomplete="nickname" />
        <button id="saveNameBtn">OK</button>
      </div>
      <p style="margin:0; font-size:14px; color:#475569">‚Äª „Ç≥„É°„É≥„Éà„ÇÑ„Çà„Å≥„Åã„Åë„Åß„ÄÅ„Å™„Åæ„Åà„Çí„Å§„Åã„ÅÑ„Åæ„Åô</p>
    </form>
  </dialog>

  <div id="debugOverlay"></div>

<script>
if(!String.prototype.replaceAll){ String.prototype.replaceAll = function(s, r){ return this.split(s).join(r); }; }
window.addEventListener('error', (e)=>{ try{ const t=document.getElementById('toast'); if(t){ t.textContent='„Ç®„É©„Éº: '+(e.message||'‰∏çÊòé'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200);} }catch(_){} });

(function(){
  const grid = document.getElementById('grid');
  const gridRect = ()=> grid.getBoundingClientRect();
  const seaRect = ()=> document.querySelector('.undersea').getBoundingClientRect();
  const startBtn = document.getElementById('startBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const muteBtn = document.getElementById('muteBtn');
  const nameBtn = document.getElementById('nameBtn');
  const promptText = document.getElementById('promptText');
  const scoreBox = document.getElementById('scoreBox');
  const fx = document.getElementById('fx');
  const toast = document.getElementById('toast');
  const bucket = document.getElementById('bucket');
  const result = document.getElementById('result');
  const resScore = document.getElementById('resScore');
  const resComment = document.getElementById('resComment');
  const resTitle = document.getElementById('resTitle');
  const roundDots = document.getElementById('roundDots');
  const againBtn = document.getElementById('againBtn');
  const closeBtn = document.getElementById('closeBtn');
  const captain = document.getElementById('captain');
  const easyTab = document.getElementById('easyTab');
  const normalTab = document.getElementById('normalTab');
  const modeBadge = document.getElementById('modeBadge');
  const sky = document.getElementById('sky');

  const nameDlg = document.getElementById('nameDlg');
  const nameInput = document.getElementById('nameInput');
  const saveNameBtn = document.getElementById('saveNameBtn');

  /* ===== „É¢„Éº„Éâ„ÉªÁä∂ÊÖã ===== */
  let gameMode = 'easy';
  easyTab.addEventListener('click', ()=>{
    gameMode='easy'; easyTab.classList.add('active'); normalTab.classList.remove('active'); modeBadge.textContent='„Åã„Çì„Åü„Çì„É¢„Éº„Éâ';
  });
  normalTab.addEventListener('click', ()=>{
    gameMode='normal'; normalTab.classList.add('active'); easyTab.classList.remove('active'); modeBadge.textContent='„Åµ„Å§„ÅÜ„É¢„Éº„Éâ';
  });

  /* ‚ñº ‰øÆÊ≠£Ôºö„Çµ„É°„ÅåÂá∫„Å™„ÅÑ„Å®ÊÑü„Åò„Çã„Ç±„Éº„Çπ„Å∏„ÅÆÂØæÁ≠ñ
     - Âá∫ÁèæÁéá„Çí‰∏ä„Åí„ÇãÔºà1/4Ôºâ
     - Âº∑Âà∂Âá∫Áèæ„ÅÆ„Åó„Åç„ÅÑÂÄ§„Çí„ÄåÊÆã„Çä2„É©„Ç¶„É≥„Éâ‰ª•‰∏ã„Äç„Å´Êã°Â§ßÔºàÂæåÂçä„ÅÆ shouldForceShark „Å®ÂØæÔºâ
  */
  const SHARK_ROUND_PROB = 1/4;   // ‚Üê ‰ª•Ââç„ÅÆ 1/10 „Åã„ÇâÂºï„Åç‰∏ä„Åí
  const SHARK_FORCE_REMAIN_THRESH = 2; // ÂæåÂçä„Åß‰ΩøÁî®ÔºàshouldForceSharkÔºâ
  const SHARK_COUNT = 3;
  const EASY_FISH_COUNT = 3;

  const EVENT_PROB = 1/9;
  const ISLAND_PROB = 1/3;
  const BIRD_PROB = 1/3;

  let eventMode = null;
  let eventTimer = null;

  const NUM_READ_JA = ['„Çº„É≠','„ÅÑ„Å°','„Å´','„Åï„Çì','„Çà„Çì','„Åî','„Çç„Åè','„Å™„Å™','„ÅØ„Å°','„Åç„ÇÖ„ÅÜ'];
  let current = null;
  let playing = false;
  let score = 0;
  let round = 0;
  let muted = false;
  let voices = [];
  let preferVoice = null;
  let pausedMove = false;
  let fishStates = [];
  const FISH_W = 120, FISH_H = 60;
  const SHARK_W = 200, SHARK_H = 100;

  /* ËàπÈï∑Ë°®ÊÉÖ */
  let captainMoodToken = 0;
  function setCaptain(face, holdMs = 1600){
    captainMoodToken++; const myToken = captainMoodToken;
    if (captain){ captain.textContent = face; captain.classList.remove('captain-pop'); requestAnimationFrame(()=> captain.classList.add('captain-pop')); }
    if(holdMs>0){ setTimeout(()=>{ if(myToken===captainMoodToken && captain){ captain.textContent='üòê'; } }, holdMs); }
  }
  function resetCaptain(){ captainMoodToken++; if(captain){ captain.textContent='üòê'; captain.classList.remove('captain-pop'); } }

  /* ÂêçÂâç */
  function normalizeName(s){ return (s||'').toString().trim().replace(/[ „ÄÄ]/g,'').replace(/(„Å°„ÇÉ„Çì|„Åè„Çì|„Åï„Çì)+$/u,''); }
  let kidName = normalizeName(localStorage.getItem('kidName') || '„ÅÇ„ÇÑ„Åã');
  const nameRaw = () => normalizeName(kidName);
  const nameChan = () => { const n = nameRaw(); return n ? `${n}„Å°„ÇÉ„Çì` : ''; };

  /* „Ç≥„É°„É≥„Éà */
  const SOFT_MISS = [
    "${name}„ÄÅ„ÅÑ„ÅÑ„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ „ÇÇ„ÅÜ„ÅÑ„Å°„Å© „ÇÜ„Å£„Åè„Çä „Åà„Çâ„Åº„ÅÜ„ÄÇ",
    "${name}„ÄÅ„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂„ÄÇ„Åä„Å°„Å§„ÅÑ„Å¶ „ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ „ÇÑ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ",
    "${name}„ÄÅ„Åô„Åî„Åè „Å°„Åã„ÅÑ„ÇàÔºÅ „Çà„Éº„Åè „Åø„Åü„Çâ „Åç„Å£„Å® „Åß„Åç„ÇãÔºÅ",
    "${name}„ÄÅ„ÅÇ„Åõ„Çâ„Å™„Åè„Å¶ „ÅÑ„ÅÑ„Çà„ÄÇ„ÅÑ„Å£„Åó„Çá„Å´ „Åï„Åå„Åù„ÅÜÔºÅ",
    "${name}„ÄÅ„Åå„Çì„Å∞„Å£„Å¶„Çã„Å≠„ÄÇ„Éí„É≥„Éà„Çí „Åü„Çà„Çä„Å´ „ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ"
  ];
  const COMMENTS = {
    1: ["${name}„ÄÅ„Åç„Çá„ÅÜ„ÅØ „ÅÑ„ÅÑ „Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ Ê¨°„ÅØ „ÇÇ„Å£„Å® „Å§„Çå„Çã„ÇàÔºÅ","${name}„ÄÅ1„Å¶„Çì„ÇÇ „Åü„ÅÑ„Åõ„Å§ÔºÅ „Å§„Åé „ÅÑ„Åì„ÅÜÔºÅ"],
    2: ["${name}„ÄÅ2„Å¶„Çì „Ç≤„ÉÉ„ÉàÔºÅ „ÅÑ„ÅÑ„ÅÆ„ÇäÔºÅ","${name}„ÄÅ„Å†„Çì„Å†„Çì „Éó„É≠„Å£„ÅΩ„ÅÑÔºÅ"],
    3: ["${name}„ÄÅ3„Å¶„ÇìÔºÅ „ÅÆ„Å£„Å¶„ÇãÔºÅ","${name}„ÄÅ„Åï„Çì„Å≥„ÅçÔºÅ „Åä„Åø„Åî„Å®ÔºÅ"],
    4: ["${name}„ÄÅ4„Å¶„ÇìÔºÅ „ÇÇ„ÅÜ „Åô„Åì„Åó„Åß „Åã„Çì„Å∫„ÅçÔºÅ","${name}„ÄÅ„Çà„Åè „Åç„Åë„Å¶„ÇãÔºÅ"],
    5: ["${name}„ÄÅ„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ „Åô„Å∞„Çâ„Åó„ÅÑÔºÅ","${name}„ÄÅ5„Å¶„ÇìÔºÅ „Åç„Çá„ÅÜ„ÅÆ „Å§„Çä„Éû„Çπ„Çø„ÉºÔºÅ"]
  };
  const PRAISE = [
    "${name}„Å°„ÇÉ„Çì„ÄÅ„ÇÑ„Å£„Åü„Å≠ÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Åô„Åî„Éº„ÅÑÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Å∞„Å£„Å°„ÇäÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Éî„ÉÉ„Çø„É™„Åà„Çâ„Åπ„ÅüÔºÅ",
    "${name}„Å°„ÇÉ„Çì„ÄÅ„Åã„Å£„Åì„ÅÑ„ÅÑÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Å§„Çä„ÇÅ„ÅÑ„Åò„ÇìÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Éä„Ç§„Çπ„Ç≠„É£„ÉÉ„ÉÅÔºÅ","${name}„Å°„ÇÉ„Çì„ÄÅ„Åü„ÅÑ„Å∏„Çì„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ"
  ];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function childMsg(t){ return t.replaceAll('${name}', nameRaw()); }
  function showToast(msg){ toast.textContent = msg; toast.classList.remove('show'); void toast.offsetWidth; toast.classList.add('show'); }

  /* Èü≥Â£∞ÔºàJA TTSÔºâ */
  function pickVoice(){
    voices = speechSynthesis.getVoices();
    preferVoice = voices.find(v => v.lang && v.lang.startsWith('ja') && /Kyoko|Otoya|ja-JP/i.test(v.name))
                || voices.find(v => v.lang && v.lang.startsWith('ja'))
                || null;
  }
  if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = pickVoice; pickVoice(); }
  function speakJa(text, rate=1){
    if(muted || !('speechSynthesis' in window)) return Promise.resolve();
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang='ja-JP'; u.rate=rate; u.pitch=1.0; u.volume=1.0;
      if(preferVoice) u.voice=preferVoice;
      return new Promise((resolve)=>{ u.onend=resolve; u.onerror=resolve; speechSynthesis.speak(u); });
    }catch(e){ return Promise.resolve(); }
  }

  /* „Éì„Ç∏„É•„Ç¢„É´ÔºàÈ≠ö„Éª„Çµ„É°Ôºâ */
  function fishSvg(hue){
    const fill = `hsl(${hue} 70% 60%)`, fin = `hsl(${hue} 65% 48%)`;
    return `<svg viewBox="0 0 200 120" aria-hidden="true">
      <defs><linearGradient id="g${hue}" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="${fill}"/><stop offset="100%" stop-color="${fin}"/></linearGradient></defs>
      <ellipse cx="90" cy="60" rx="80" ry="45" fill="url(#g${hue})"/>
      <polygon points="160,60 195,85 195,35" fill="${fin}"/>
      <circle cx="55" cy="50" r="6" fill="#0f172a"/><circle cx="54" cy="49" r="2" fill="#fff"/>
    </svg>`;
  }
  function sharkSvg(){
    return `<svg viewBox="0 0 260 140" aria-hidden="true">
      <defs><linearGradient id="sg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#6b7280"/><stop offset="100%" stop-color="#374151"/></linearGradient></defs>
      <path d="M30,70 C80,20 180,20 230,70 C180,120 80,120 30,70 Z" fill="url(#sg)"/>
      <polygon points="200,70 250,100 250,40" fill="#374151"/>
      <path d="M85,88 c12,0 24,0 36,0 c0,0 -6,10 -12,10 c-6,0 -12,-10 -24,-10z" fill="#fff"/>
      <path d="M95,88 l6,10 M105,88 l6,10 M115,88 l6,10" stroke="#ef4444" stroke-width="3"/>
      <circle cx="70" cy="62" r="7" fill="#111"/><circle cx="69" cy="61" r="2" fill="#fff"/>
      <path d="M140,40 l20,-25 l10,25" fill="#6b7280"/>
    </svg>`;
  }

  function highlightTarget(n){
    grid.querySelectorAll('.fish,.shark').forEach(el=>el.classList.remove('target'));
    const t = grid.querySelector(`[data-n="${n}"]`);
    if(t){ t.classList.add('target'); }
  }

  function randDistinctNumbers(count, mustInclude=null){
    const pool = [...Array(10).keys()];
    if(mustInclude!=null){ pool.splice(pool.indexOf(mustInclude),1); }
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
    const picked = mustInclude!=null ? [mustInclude, ...pool.slice(0, count-1)] : pool.slice(0,count);
    for(let i=picked.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [picked[i],picked[j]]=[picked[j],picked[i]]; }
    return picked;
  }

  /* „Ç∞„É™„ÉÉ„ÉâÊßãÁØâ */
  function buildGrid(count=10){
    const r0 = gridRect(), rSea = seaRect();
    const w = Math.max(r0.width, rSea.width), h = Math.max(r0.height, rSea.height);
    if(w < 10 || h < 10){
      if(!buildGrid._retries) buildGrid._retries = 0;
      if(buildGrid._retries++ < 10){ setTimeout(()=>buildGrid(count), 50); return; }
    }
    grid.innerHTML=''; fishStates=[];
    let confettiL = document.getElementById('confetti');
    if(!confettiL){
      confettiL = document.createElement('div');
      confettiL.id='confetti';
      confettiL.style.cssText='position:absolute;inset:0;pointer-events:none;overflow:hidden;';
      fx.appendChild(confettiL);
    }
    const hues = [200, 20, 90, 330, 260, 140, 10, 300, 45, 180];
    const r = gridRect();
    function randPos(wi,hi){ const pad=12; return [Math.random()*(r.width-wi-pad*2)+pad, Math.random()*(r.height-hi-pad*2)+pad]; }
    function isOverlapping(x,y,size){ const minD=size; for(const s of fishStates){ if(Math.hypot(s.x-x,s.y-y)<minD) return true; } return false; }

    const nums = count===10 ? [...Array(10).keys()] : randDistinctNumbers(count, current);
    for(const n of nums){
      let [x,y]=randPos(FISH_W,FISH_H); let tries=0; while(isOverlapping(x,y,84) && tries++<200){ [x,y]=randPos(FISH_W,FISH_H); }
      const el = document.createElement('button');
      el.className='fish'; el.dataset.n=String(n); el.setAttribute('aria-label', String(n));
      el.innerHTML = `<div class="hit"></div><div class="wrap">${fishSvg(hues[n%hues.length])}<div class="num"><span>${n}</span></div></div>`;
      el.style.transform = `translate(${x}px, ${y}px)`;
      el.addEventListener('click', ()=> onTap(n, el)); // ÂæåÂçä„Åß onTap „ÇíÂÆöÁæ©
      grid.appendChild(el);
      const speed = 0.5 + Math.random()*0.7, dir = Math.random()*Math.PI*2;
      fishStates.push({n, x, y, vx: Math.cos(dir)*speed, vy: Math.sin(dir)*speed*0.5, el, type:'fish', w:FISH_W, h:FISH_H});
    }
  }

  /* „Çµ„É°Ôºà„Åµ„Å§„ÅÜÁî®Ôºâ */
  function buildSharks(){
    grid.innerHTML=''; fishStates=[];
    const r = gridRect();
    function randPos(){ const pad=16; return [Math.random()*(r.width-SHARK_W-pad*2)+pad, Math.random()*(r.height-SHARK_H-pad*2)+pad]; }
    function isOverlapping(x,y){ const minD=140; for(const s of fishStates){ if(Math.hypot(s.x-x,s.y-y)<minD) return true; } return false; }
    const sharkTargets = randDistinctNumbers(SHARK_COUNT);
    for(const n of sharkTargets){
      let [x,y]=randPos(); let tries=0; while(isOverlapping(x,y) && tries++<240){ [x,y]=randPos(); }
      const el = document.createElement('button');
      el.className='shark'; el.dataset.n=String(n); el.setAttribute('aria-label', '„Çµ„É° '+String(n));
      el.innerHTML = `<div class="hit"></div><div class="wrap">${sharkSvg()}<div class="num"><span>${n}</span></div></div>`;
      el.style.transform = `translate(${x}px, ${y}px)`;
      el.addEventListener('click', ()=> onTap(n, el)); // ÂæåÂçä„Åß onTap „ÇíÂÆöÁæ©
      grid.appendChild(el);
      const speed = 1.0 + Math.random()*1.4, dir = Math.random()*Math.PI*2;
      fishStates.push({n, x, y, vx: Math.cos(dir)*speed, vy: Math.sin(dir)*speed, el, type:'shark', w:SHARK_W, h:SHARK_H, dash:0});
    }
    return sharkTargets;
  }

  /* ÁßªÂãï„É´„Éº„Éó */
  let tickStarted=false;
  let globalSpeedScale = 1;
  let currentDriftBias = 0;
  function tick(){
    if(!pausedMove){
      const r = gridRect();
      for(let i=0;i<fishStates.length;i++){
        const a = fishStates[i]; let ax=0, ay=0;

        for(let j=0;j<fishStates.length;j++) if(i!==j){
          const b = fishStates[j]; const dx=a.x-b.x, dy=a.y-b.y; const d=Math.hypot(dx,dy);
          const min = a.type==='shark' ? 130 : 76;
          if(d>0 && d<min){ const f=(min-d)/min * (a.type==='shark'?0.18:0.08); ax += (dx/d)*f; ay += (dy/d)*f; }
        }

        const jitter = (a.type==='shark'? 0.06 : 0.02);
        ax += (Math.random()-0.5)*jitter; ay += (Math.random()-0.5)*jitter;

        if(a.type==='shark'){
          if(a.dash<=0 && Math.random()<0.02){ a.dash = 30 + Math.random()*40; ax += (Math.random()-0.5)*1.6; ay += (Math.random()-0.5)*1.6; }
          else if(a.dash>0){ a.dash -= 1; ax *= 2.2; ay *= 2.2; }
        }

        a.vx = (a.vx + ax); a.vy = (a.vy + ay);
        a.vx *= globalSpeedScale; a.vy *= globalSpeedScale;

        const max = (a.type==='shark'? 2.1 : 1.2);
        const sp = Math.hypot(a.vx, a.vy); if(sp>max){ a.vx = a.vx/sp*max; a.vy = a.vy/sp*max; }

        const margin=6;
        if(a.x < margin) a.vx = Math.abs(a.vx)*0.9;
        if(a.y < margin) a.vy = Math.abs(a.vy)*0.9;
        if(a.x > r.width - a.w - margin) a.vx = -Math.abs(a.vx)*0.9;
        if(a.y > r.height - a.h - margin) a.vy = -Math.abs(a.vy)*0.9;
      }
      for(const s of fishStates){ s.x += s.vx; s.y += s.vy; s.el.style.transform = `translate(${s.x}px, ${s.y}px)`; }
    }
    requestAnimationFrame(tick);
  }

  function setRoundDots(){ roundDots.innerHTML=''; for(let i=1;i<=5;i++){ const d=document.createElement('div'); d.className='dot'+(i<=round?' on':''); roundDots.appendChild(d);} }
  function resetBucket(){ bucket.innerHTML=''; }
  function addBucketStamp(n){
    const s=document.createElement('div');
    s.textContent=n; s.style.cssText='position:absolute; left:3px; right:3px; bottom:4px; height:18px; display:flex; align-items:center; justify-content:center; font-weight:900; background:#ffffffcc; border-radius:4px; border:1px solid #94c5ff';
    bucket.innerHTML=''; bucket.appendChild(s);
  }

  /* Áí∞Â¢É„Ç§„Éô„É≥„ÉàÔºàÂ≥∂„ÉªÈ≥•Ôºâ */
  function cleanupEnvironment(){ sky.querySelectorAll('.island,.bird').forEach(el=>el.remove()); }
  function maybeSpawnIsland(){
    if(Math.random() < ISLAND_PROB){
      const island = document.createElement('div');
      island.className='island';
      island.style.left = (30 + Math.random()*40) + '%';
      sky.appendChild(island);
    }
  }
  function maybeSpawnBird(){
    if(Math.random() < BIRD_PROB){
      const b = document.createElement('div');
      b.className='bird';
      const flock = ['üïäÔ∏è','ü¶Ö','üê¶','ü¶Ü'];
      b.textContent = flock[Math.floor(Math.random()*flock.length)];
      const fromLeft = Math.random()<0.5;
      b.style.top = (6 + Math.random()*32) + 'px';
      b.style.left = fromLeft ? '-20%' : '120%';
      b.style.animationDirection = fromLeft ? 'normal' : 'reverse';
      sky.appendChild(b);
      setTimeout(()=> b.remove(), 7000);
    }
  }
  function triggerEnvironment(){ cleanupEnvironment(); maybeSpawnIsland(); maybeSpawnBird(); }

  /* „Ç¨„Ç§„ÉâÔºà„Åã„Çì„Åü„ÇìÔºâ */
  const GUIDES = ['üê¨','üê¢','üê∏'];
  let guideEl=null, guideLoopId=null;
  function startGuideAssist(){
    if(guideEl) return;
    guideEl = document.createElement('div');
    guideEl.className='guide';
    guideEl.textContent = GUIDES[Math.floor(Math.random()*GUIDES.length)];
    grid.appendChild(guideEl);

    const start = performance.now();
    function loop(now){
      if(!guideEl) return;
      const t = grid.querySelector(`[data-n="${current}"]`);
      if(!t){ stopGuideAssist(); return; }
      const rect = t.getBoundingClientRect(), g = grid.getBoundingClientRect();
      const cx = rect.left - g.left + rect.width/2;
      const cy = rect.top - g.top + rect.height/2;
      const R = Math.max(rect.width, rect.height)/2 + 22;
      const dt = now - start;
      const ang = (dt/1000)*Math.PI*2;
      guideEl.style.left = (cx + R*Math.cos(ang) - 12) + 'px';
      guideEl.style.top  = (cy + R*Math.sin(ang) - 12) + 'px';
      guideLoopId = requestAnimationFrame(loop);
    }
    guideLoopId = requestAnimationFrame(loop);
  }
  function stopGuideAssist(){ if(guideLoopId){ cancelAnimationFrame(guideLoopId); guideLoopId=null; } if(guideEl){ guideEl.remove(); guideEl=null; } }

  /* ÊàêÂäüÊôÇÔºö‚ÄúÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑ„ÅÆÊï∞Â≠ó‚Äù„ÇíË°®Á§∫Ôºà„Éä„É¨„Éº„Ç∑„Éß„É≥„Å®‰∏¶ÂàóOKÔºâ */
  function showBigNumber(n){
    return new Promise((resolve)=>{
      const undersea = document.querySelector('.undersea') || grid.parentElement;
      if(!undersea){ resolve(); return; }

      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position:absolute; inset:0; display:flex; flex-direction:column;
        align-items:center; justify-content:center; pointer-events:none; z-index:8;
        backdrop-filter: blur(1px) saturate(1.05);
      `;
      const num = document.createElement('div');
      num.textContent = String(n);
      num.style.cssText = `
        font-weight:900; line-height:1; color:#042f2e;
        text-shadow: 0 4px 18px rgba(255,255,255,.85), 0 0 0 #0000;
        transform: scale(.2); opacity:.0; will-change: transform, opacity;
      `;
      const sub = document.createElement('div');
      const word = (typeof NUM_READ_JA!=='undefined' && NUM_READ_JA[n]) ? NUM_READ_JA[n] : '';
      sub.textContent = word ? `Ôºà${word}Ôºâ` : '';
      sub.style.cssText = `margin-top:10px; font-weight:800; color:#0c4a6e; opacity:0; will-change:opacity;`;

      overlay.appendChild(num); overlay.appendChild(sub);
      undersea.appendChild(overlay);

      const rect = undersea.getBoundingClientRect();
      const maxSize = Math.min(rect.width, rect.height) * 0.8;
      num.style.fontSize = `${maxSize}px`;
      sub.style.fontSize = `${Math.max(18, Math.min(36, maxSize*0.12))}px`;

      const a1 = num.animate(
        [
          { transform:'scale(.2)', opacity:.0 },
          { transform:'scale(1.02)', opacity:1, offset:.72 },
          { transform:'scale(1.0)', opacity:1 }
        ],
        { duration:1200, easing:'cubic-bezier(.2,.7,.2,1)'}
      );
      sub.animate([ { opacity:0 }, { opacity:1 } ], { duration:600, delay:420, easing:'ease-out', fill:'forwards' });

      a1.onfinish = ()=>{
        overlay.animate([ { opacity:1 }, { opacity:0 } ], { duration:500, delay:450, easing:'ease-in' })
          .onfinish = ()=>{ overlay.remove(); resolve(); };
      };
    });
  }

  /* ÂäπÊûúÈü≥ÔºÜÁ¥ôÂêπÈõ™ */
  let audioCtx;
  function ac(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } return audioCtx; }
  function playSplash(level=1){
    const ctx = ac(); if(!ctx || muted) return;
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(600, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(200, ctx.currentTime+0.18);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3*level, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.26);
  }
  function playFanfare(level=1){
    const ctx = ac(); if(!ctx || muted) return;
    const o1=ctx.createOscillator(), o2=ctx.createOscillator(), g=ctx.createGain();
    o1.type='square'; o2.type='sawtooth';
    o1.frequency.setValueAtTime(660, ctx.currentTime);
    o2.frequency.setValueAtTime(990, ctx.currentTime);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.25*level, ctx.currentTime+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);
    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    o1.start(); o2.start(); o1.stop(ctx.currentTime+0.36); o2.stop(ctx.currentTime+0.36);
  }
  function spawnConfetti(count=24, level=1){
    const layer = document.getElementById('confetti'); if(!layer) return;
    for(let i=0;i<count;i++){
      const d=document.createElement('div');
      const size = 4+Math.random()*6*level;
      d.style.position='absolute'; d.style.top='-10px'; d.style.left=Math.random()*100+'%';
      d.style.width=size+'px'; d.style.height=size+'px';
      d.style.background=`hsl(${Math.random()*360} 80% 60%)`;
      d.style.transform=`rotate(${Math.random()*360}deg)`;
      layer.appendChild(d);
      const x = (Math.random()*200-100);
      d.animate(
        [
          {transform:`translate(0,0) rotate(0deg)`},
          {transform:`translate(${x}px, 110vh) rotate(${360+Math.random()*360}deg)`}
        ],
        {duration:1800+Math.random()*600, easing:'cubic-bezier(.2,.7,.2,1)'}
      ).onfinish=()=>d.remove();
    }
  }

  /* ÂâçÂçä„Åì„Åì„Åæ„Åß„ÄÇÂæåÂçä„Å´ onTap / nextRound / celebrateCatchÔºà‰∏¶ÂàóÔºâ „Åª„Åã„ÇíÁ∂ö„Åë„Åæ„Åô„ÄÇ */

  /* ===== „Åì„Åì„Åã„ÇâÂæåÂçä ===== */

  /* „É©„É≥„ÉÄ„É†„Ç§„Éô„É≥„ÉàÔºàÁ∞°ÊòìÔºâ */
  function clearEvent(){
    eventMode = null;
    if(eventTimer) { clearTimeout(eventTimer); eventTimer = null; }
    grid.classList.remove('evt-fog','evt-freeze','evt-current');
    globalSpeedScale = 1; currentDriftBias = 0;
    grid.querySelectorAll('.treasure,.goldfish').forEach(e=>e.remove());
  }
  function triggerRandomEvent(){
    clearEvent();
    const pool = ['goldfish','treasure','whale'];
    eventMode = pool[Math.floor(Math.random()*pool.length)];
    if(eventMode==='goldfish'){ spawnGoldfishBonus(); speakJa('„Ç≠„É©„Åç„Çì„Åé„ÇáÁô∫Ë¶ãÔºÅ„ÉÄ„Éñ„É´„ÉÅ„É£„É≥„ÇπÔºÅ',1.03); eventTimer=setTimeout(()=>{ removeGoldfishBonus(); clearEvent(); },8000); }
    if(eventMode==='treasure'){ spawnTreasure(); speakJa('„Åü„Åã„Çâ„Å∞„Åì„Å†ÔºÅ „ÅÇ„Åë„Å¶„Åø„Çà„ÅÜÔºÅ'); }
    if(eventMode==='whale'){ gentleRepack(); speakJa('„ÇØ„Ç∏„É©„Åï„Çì„Åå „Åä„Å¶„Å§„Å†„ÅÑÔºÅ'); }
  }
  function spawnGoldfishBonus(){
    const t = grid.querySelector(`[data-n="${current}"] .wrap`);
    if(t){ t.classList.add('gold','goldfish'); }
  }
  function removeGoldfishBonus(){ grid.querySelectorAll('.goldfish').forEach(el=>el.classList.remove('gold','goldfish')); }
  function spawnTreasure(){
    const btn=document.createElement('button');
    btn.className='treasure'; btn.setAttribute('aria-label','„Åü„Åã„Çâ„Å∞„Åì');
    btn.style.cssText='position:absolute; right:10px; bottom:10px; width:48px; height:36px; border-radius:10px; border:2px solid #a16207; background:linear-gradient(#fef3c7,#fcd34d); box-shadow:0 4px 10px rgba(0,0,0,.15)';
    btn.innerHTML='üíé';
    btn.addEventListener('click', ()=>{
      showToast('„Éî„Ç´„ÉÉÔºÅ„Éú„Éº„Éä„ÇπÊºîÂá∫ÔºÅ');
      spawnConfetti(30,2);
      btn.remove(); clearEvent();
    });
    grid.appendChild(btn);
  }
  function gentleRepack(){
    const r=gridRect();
    fishStates.forEach(s=>{
      const cx = r.width/2, cy=r.height/2;
      s.x += (cx - (s.x+s.w/2))*0.25;
      s.y += (cy - (s.y+s.h/2))*0.25;
      s.el.style.transform=`translate(${s.x}px, ${s.y}px)`;
    });
  }

  /* „É©„Ç¶„É≥„ÉâÂà∂Âæ° */
  let sharkMode=false, sharkTargets=[], sharkShownThisGame=false;
  function shouldForceShark(){ return !sharkShownThisGame && (5 - round) <= SHARK_FORCE_REMAIN_THRESH; }

  async function nextRound(){
    stopGuideAssist();
    grid.querySelectorAll('.fish,.shark').forEach(el=>el.classList.remove('fade','hint','target'));
    pausedMove=false;
    clearEvent();
    triggerEnvironment();

    if(gameMode==='normal'){
      // „Åµ„Å§„ÅÜÔºö„Çµ„É°ÊäΩÈÅ∏ÔºàÂº∑Âà∂Âê´„ÇÄÔºâ
      sharkMode = (Math.random() < SHARK_ROUND_PROB) || shouldForceShark();
      if(sharkMode){
        sharkTargets = buildSharks();
        sharkShownThisGame = true;
        current = sharkTargets[Math.floor(Math.random()*sharkTargets.length)];
        highlightTarget(current);
        const namePart = kidName ? `${nameChan()}„ÄÅ` : '';
        promptText.textContent = `ü¶à „Çµ„É°„Åü„ÅÑ„ÅòÔºÅ „Äå${NUM_READ_JA[current]}„Äç„Çí „Åü„ÅÑ„Åò„Å†ÔºÅ`;
        await speakJa(`${namePart}„Çµ„É° „Åó„ÇÖ„Å§„Åí„ÇìÔºÅ „Å≠„Çâ„ÅÑ„ÅØ „Äå${NUM_READ_JA[current]}„ÄçÔºÅ`, 1.02);
      }else{
        // ‚òÖ„Åµ„Å§„ÅÜÔºöÈÄöÂ∏∏È≠ö„ÅØ10Âåπ
        if(grid.children.length < 10){ buildGrid(10); }
        round++; if(round>5){ endGame(); return; }
        setRoundDots();
        current = Math.floor(Math.random()*10);
        highlightTarget(current);
        const namePart = kidName ? `${nameChan()}„ÄÅ` : '';
        promptText.textContent = `${namePart}„Äå${NUM_READ_JA[current]}„Äç„Çí „Å§„Å£„Å¶„Åø„Çà„ÅÜÔºÅ`;
        await speakJa(`${namePart}„Äå${NUM_READ_JA[current]}„Äç„Çí „Å§„Å£„Å¶„Åø„Çà„ÅÜÔºÅ`, 1.0);
        if(Math.random()< EVENT_PROB) triggerRandomEvent();
      }
    }else{
      // „Åã„Çì„Åü„ÇìÔºö„Çµ„É°ÊäΩÈÅ∏„ÅÇ„Çä ‚Üí „Å™„Åë„Çå„Å∞3Âåπ
      round++; if(round>5){ endGame(); return; }
      setRoundDots();

      sharkMode = (Math.random() < SHARK_ROUND_PROB) || shouldForceShark();
      if(sharkMode){
        const targets = buildSharks();
        sharkShownThisGame = true;
        current = targets[Math.floor(Math.random()*targets.length)];
        highlightTarget(current);
        const namePart = kidName ? `${nameChan()}„ÄÅ` : '';
        promptText.textContent = `ü¶à „Çµ„É°„Åü„ÅÑ„ÅòÔºÅ „Äå${NUM_READ_JA[current]}„Äç„Çí „Åü„ÅÑ„Åò„Å†ÔºÅ`;
        await speakJa(`${namePart}„Çµ„É° „Åó„ÇÖ„Å§„Åí„ÇìÔºÅ „Å≠„Çâ„ÅÑ„ÅØ „Äå${NUM_READ_JA[current]}„ÄçÔºÅ`, 1.02);
      }else{
        current = Math.floor(Math.random()*10);
        buildGrid(EASY_FISH_COUNT);
        highlightTarget(current);
        const namePart = kidName ? `${nameChan()}„ÄÅ` : '';
        promptText.textContent = `${namePart}„Äå${NUM_READ_JA[current]}„Äç„Çí „Å§„Å£„Å¶„Åø„Çà„ÅÜÔºÅÔºà3„Å≥„ÅçÔºâ`;
        await speakJa(`${namePart}„Äå${NUM_READ_JA[current]}„Äç„Çí „Å§„Å£„Å¶„Åø„Çà„ÅÜÔºÅ`, 1.0);
        if(Math.random()< EVENT_PROB) triggerRandomEvent();
      }
    }

    repeatBtn.disabled = false;
    scoreBox.textContent = `„Çπ„Ç≥„Ç¢ ${score} / ÊÆã„Çä ${Math.max(0, 5-round+(sharkMode?0:1))}`;
  }

  function splashAt(el){
    const s = document.createElement('div'); s.className='splash';
    const r = el.getBoundingClientRect(); const g = grid.getBoundingClientRect();
    s.style.left = (r.left - g.left) + 'px'; s.style.top = (r.top - g.top) + 'px'; s.style.width=r.width+'px'; s.style.height=r.height+'px';
    fx.appendChild(s); setTimeout(()=>s.remove(), 620);
  }

  /* „Çø„ÉÉ„ÉóÂá¶ÁêÜÔºàÈ≠ö„Éª„Çµ„É°ÂÖ±ÈÄöÔºâ */
  async function onTap(n, el){
    if(!playing) return;

    if(sharkMode){
      if(n === current){
        score++; scoreBox.textContent = `„Çπ„Ç≥„Ç¢ ${score} / ÊÆã„Çä ${Math.max(0, 5-round)}`;
        showToast('ü¶à „Åü„ÅÑ„Åò „Åõ„ÅÑ„Åì„ÅÜÔºÅ'); setCaptain('üòä');

        // ‰∏¶ÂàóÊºîÂá∫
        celebrateCatch(el, n);

        sharkMode=false;
        await speakJa(`${nameChan()? nameChan()+'„ÄÅ':''}„ÇÑ„Å£„ÅüÔºÅ „Çµ„É°„Åü„ÅÑ„Åò „Åõ„ÅÑ„Åì„ÅÜÔºÅ`, 1.05);
        await nextRound();
      }else{
        setCaptain('üò¢');
        const t = grid.querySelector(`.shark[data-n="${current}"]`);
        if(t){
          t.classList.add('hint');
          t.animate([{transform:'translateY(0)'},{transform:'translateY(-28px)'},{transform:'translateY(0)'}], {duration:650, easing:'cubic-bezier(.2,.7,.2,1)'});
        }
        const msg = childMsg(pick(SOFT_MISS)) + ` „Å≠„Çâ„ÅÑ„ÅØ„Äå${NUM_READ_JA[current]}„Äç„Å†„Çà„ÄÇ`;
        await speakJa(msg, 1.02);
      }
      return;
    }

    if(gameMode==='easy'){
      if(n === current){
        score++; setCaptain('üòä');
        scoreBox.textContent = `„Çπ„Ç≥„Ç¢ ${score} / ÊÆã„Çä ${5-round+1}`;
        const msg = childMsg(pick(PRAISE));
        showToast(msg);
        stopGuideAssist();

        celebrateCatch(el, n);

        await speakJa(msg + ' „ÅÑ„Å£„Åó„Çá„Å´ „Å§„Çå„Åü„Å≠ÔºÅ', 1.0);
        await nextRound();
      }else{
        setCaptain('üò¢');
        startGuideAssist();
        const who = guideEl ? guideEl.textContent : '„Åä„Å®„ÇÇ„Å†„Å°';
        const soft = childMsg(pick(SOFT_MISS));
        const help = (who==='üê¨'?'„Ç§„É´„Ç´':(who==='üê¢'?'„Ç´„É°':'„Ç´„Ç®„É´'));
        showToast(`${soft}`);
        await speakJa(`${soft} „Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂„ÄÇ${help}„Åå „Äå${NUM_READ_JA[current]}„Äç„ÅÆ „Åæ„Çè„Çä„Çí „Åê„Çã„Åê„Çã „Å¶„Å§„Å†„Å£„Å¶„Åè„Çå„Å¶„Çã„Çà„ÄÇ`, 1.0);
      }
      return;
    }

    // „Åµ„Å§„ÅÜÔºöÈÄöÂ∏∏È≠ö
    if(n === current){
      score++; scoreBox.textContent = `„Çπ„Ç≥„Ç¢ ${score} / ÊÆã„Çä ${5-round+1}`;
      const msg = childMsg(pick(PRAISE));
      showToast(msg); setCaptain('üòä');

      celebrateCatch(el, n);

      await speakJa(msg, 1.0);
      await nextRound();
    }else{
      setCaptain('üò¢');
      grid.style.pointerEvents='none';
      const t = grid.querySelector(`.fish[data-n="${current}"]`);
      if(t){
        grid.querySelectorAll('.fish').forEach(f=>{ if(f!==t) f.classList.add('fade'); });
        t.animate([{transform:'translateY(0)'},{transform:'translateY(-22px)'},{transform:'translateY(0)'}], {duration:700, easing:'cubic-bezier(.2,.7,.2,1)'});
      }
      const soft = childMsg(pick(SOFT_MISS));
      await speakJa(`${soft} „Åõ„ÅÑ„Åã„ÅÑ„ÅØ „Äå${NUM_READ_JA[current]}„Äç„Å†„Çà„ÄÇ`, 1.0);
      grid.style.pointerEvents='';
      await nextRound();
    }
  }

  /* ÊàêÂäüÊºîÂá∫Ôºà‰∏¶ÂàóÁâàÔºâÔºöÊï∞Â≠ó„ÅÆÊã°Â§ß„Å®È≠öÊê¨ÈÄÅ„ÇíÂêåÊôÇÈÄ≤Ë°å */
  function celebrateCatch(el, n){
    grid.style.pointerEvents='none';
    grid.querySelectorAll('.fish,.shark').forEach(f=>{ if(f!==el) f.classList.add('fade'); });

    splashAt(el);
    const afterScore = score;
    const level = Math.max(1, Math.min(3, afterScore>=5?3: afterScore>=4?2:1));
    playSplash(level); spawnConfetti(22+level*12, level); playFanfare(level);

    // ‚ë† Êï∞Â≠ó„ÅÆÂÖ®ÁîªÈù¢Êã°Â§ß
    showBigNumber(n).catch(()=>{});

    // ‚ë° „Éê„Ç±„ÉÑÊê¨ÈÄÅ
    const r = el.getBoundingClientRect(), g = grid.getBoundingClientRect();
    const startX = r.left - g.left + r.width/2, startY = r.top - g.top + r.height/2;

    const fly = document.createElement('div');
    fly.className='fly';
    fly.style.left = (startX- r.width/2)+'px';
    fly.style.top = (startY- r.height/2)+'px';
    fly.style.width = r.width+'px';
    fly.style.height = r.height+'px';
    fly.innerHTML = el.innerHTML;
    fx.appendChild(fly);

    const sea = document.querySelector('.undersea');
    const bR = bucket.getBoundingClientRect(), g2 = sea.getBoundingClientRect();
    const endX = bR.left - g2.left + bR.width/2 - r.width/4;
    const endY = - (g2.top - bR.top) + 8;
    const midY = -90 - level*30;
    const midX = (endX - startX)/2 + startX + (Math.random()*40-20);

    pausedMove=true;
    fly.animate(
      [
        {transform:'translate(0,0) rotate(0deg)'},
        {transform:`translate(${midX-startX}px, ${midY}px) rotate(${20*level}deg)`, offset:0.45},
        {transform:`translate(${endX-startX}px, ${endY - startY}px) rotate(${360*level}deg)`}
      ],
      {duration:950+level*220, easing:'cubic-bezier(.2,.7,.2,1)'}
    ).finished.then(()=>{
      fly.remove();
      addBucketStamp(n);
      showToast('üéÜ „Å§„Çå„ÅüÔºÅ');
    }).catch(()=>{}).finally(()=>{
      grid.style.pointerEvents='';
      pausedMove=false;
    });
  }

  /* „Ç≤„Éº„É†ÈñãÂßã„ÉªÊìç‰ΩúÁ≥ª */
  async function startGame(){
    resetCaptain();
    stopGuideAssist();
    if(!kidName){ const opened = safeShowModal(nameDlg); if(!opened){ ensureNameFallback(); } }
    playing = true; score = 0; round = 0; sharkMode=false; sharkShownThisGame=false;
    resetBucket(); setRoundDots();
    startBtn.textContent = 'üîÅ „Å§„Å•„Åë„Çã';
    showToast('„Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ „Åú„Çì„Å∂„Åß 5„Åã„ÅÑ');
    if(gameMode==='easy'){ await nextRound(); } else { buildGrid(10); await nextRound(); }
  }

  function repeat(){
    if(!playing) return;
    if(sharkMode){
      speakJa(`„Çµ„É°„Åü„ÅÑ„ÅòÔºÅ „Å≠„Çâ„ÅÑ„ÅØ „Äå${NUM_READ_JA[current]}„ÄçÔºÅ`, 1.02);
    }else if(current!=null){
      const namePart = kidName ? `${nameChan()}„ÄÅ` : '';
      speakJa(`${namePart}„Äå${NUM_READ_JA[current]}„Äç„Çí „Å§„Å£„Å¶„Åø„Çà„ÅÜÔºÅ`, 1.0);
    }
  }

  function toggleMute(){ muted = !muted; muteBtn.setAttribute('aria-pressed', String(muted)); muteBtn.textContent = muted ? 'üîá Èü≥„Å™„Åó' : 'üîà Èü≥„ÅÇ„Çä'; if(!muted) repeat(); }

  function endGame(){
    playing = false;
    stopGuideAssist();
    const s = score;
    const bucketSet = COMMENTS[String(Math.max(1, Math.min(5, s)))] || COMMENTS[1];
    const raw = bucketSet[Math.floor(Math.random()*bucketSet.length)];
    const msg = raw.replaceAll('${name}', nameChan());
    resTitle.textContent = '„Åë„Å£„Åã';
    resScore.textContent = `„Çπ„Ç≥„Ç¢ ${s} / 5`;
    resComment.textContent = msg;
    result.style.display = 'flex';
    speakJa(`${nameChan()? nameChan() + '„ÄÅ':''}„Çπ„Ç≥„Ç¢„ÅØ ${s} „Å¶„Çì„ÄÇ ${msg}`);
  }

  // dialog helpers
  function safeShowModal(dlg){ try{ if(dlg && typeof dlg.showModal==='function'){ dlg.showModal(); return true; } } catch(e){} return false; }
  function ensureNameFallback(){
    if(!kidName){
      const v = window.prompt('„Åä„Å™„Åæ„Åà„Çí „Åä„Åó„Åà„Å¶„Å≠', kidName || '„ÅÇ„ÇÑ„Åã');
      if(v!==null){ kidName = normalizeName(v); localStorage.setItem('kidName', kidName); showToast(`${nameChan()} „Åß „Çà„Å≥„Åã„Åë„Çã„Å≠`); }
    }
  }

  // „É™„Çπ„Éä„Éº
  startBtn.addEventListener('click', startGame);
  repeatBtn.addEventListener('click', repeat);
  muteBtn.addEventListener('click', toggleMute);
  nameBtn.addEventListener('click', ()=>{ if(!safeShowModal(nameDlg)){ ensureNameFallback(); }});
  againBtn.addEventListener('click', ()=>{ result.style.display='none'; startGame(); });
  closeBtn.addEventListener('click', ()=>{ result.style.display='none'; });

  saveNameBtn.addEventListener('click', (e)=>{
    e.preventDefault(); const v = nameInput.value.trim();
    if(v){ kidName = normalizeName(v); localStorage.setItem('kidName', kidName); nameDlg.close(); showToast(`${nameChan()} „Åß „Çà„Å≥„Åã„Åë„Çã„Å≠`); }
  });

  if(!tickStarted){ tickStarted=true; requestAnimationFrame(tick); }
})(); // IIFE end
</script>
</body>
</html>
