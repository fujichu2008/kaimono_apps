<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>æ•°å­—ã‚’ã‚ã¦ã‚ï¼</title>
<meta name="theme-color" content="#2b8a3e">
<style>
:root{
  --bg:#f0f7ff; --card:#ffffff; --line:#d7e6ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b8a3e; --accent-2:#18753a; --warn:#ef4444; --ok:#16a34a; --gold:#f5c542;
}

/* ==== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±é€š ==== */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}

header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff 0%,#f7fbff 100%);border-bottom:1px solid var(--line)}
header .bar{max-width:880px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:10px;padding:8px 10px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button.ghost{background:#fff}
#gameWrap{max-width:880px;margin:10px auto;padding:10px}

/* ==== ãƒœãƒ¼ãƒ‰ï¼†èƒŒæ™¯ï¼ˆæ™‚é–“å¸¯ã§åˆ‡æ›¿ï¼‰ ==== */
.board{
  position:relative;margin:0 auto;border-radius:18px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(0,0,0,.06);
  overflow:hidden;touch-action:manipulation;height:64svh;min-height:400px;max-height:640px;
  background:linear-gradient(180deg,#cfe8ff 0%,#bfe0ff 50%,#dff4ff 100%);
}
@media (max-width:480px){ .board{height:66svh;min-height:380px} }

/* æœï¼šã‚„ã‚ã‚‰ã‹ã„ç©ºè‰² */
.theme-morning{ background:linear-gradient(180deg,#fff3cc 0%,#ffe9a8 40%,#d8f0ff 100%) !important; }
/* æ˜¼ï¼šé«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã®é’ç©º */
.theme-noon{ background:linear-gradient(180deg,#b3e5ff 0%,#87d2ff 55%,#dff8ff 100%) !important; }
/* å¤•ï¼šã‚ªãƒ¬ãƒ³ã‚¸ã€œè–„ç´« */
.theme-evening{ background:linear-gradient(180deg,#ffd6a8 0%,#ffb37a 40%,#f3a2c2 80%,#e6e9ff 100%) !important; }
/* å¤œï¼šæ·±ã„ç¾¤é’ã€œæ˜Ÿæ˜ã‚Š */
.theme-night{ background:radial-gradient(1200px 420px at 50% -10%,#364e72 0%,#1e2b44 60%,#0f172a 100%) !important; }

.hud{position:absolute;left:0;top:0;right:0;display:flex;justify-content:space-between;gap:8px;padding:8px 10px;font-weight:700;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.6));backdrop-filter:blur(2px);z-index:3}
.hud .pill{background:#fff;border:1px solid var(--line);padding:4px 10px;border-radius:999px}
.world{position:absolute;inset:0}

/* æ•°å­—ï¼šã‚³ã‚¤ãƒ³é¢¨ï¼ˆæ•°å­—ã‚µã‚¤ã‚ºã¯JSã§å¯å¤‰ï¼š0æœ€å¤§â†’9æœ€å°ï¼‰ */
.digit{
  position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#1f2937;border-radius:999px;border:2px solid #d4a025;
  background:radial-gradient(circle at 30% 30%, #fff8d6, #f9d879 45%, #e6b83d 60%, #c9972e 100%);
  box-shadow:0 4px 10px rgba(0,0,0,.18); padding:8px
}
.digit .num{line-height:1}

/* éšœå®³ç‰©ï¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ï¼ˆé›²ãƒ»æµã‚Œæ˜Ÿï¼‰ */
.obj{position:absolute;transform:translate(-50%,-50%);font-size:32px;line-height:1;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2))}
.obj.friendly{font-size:34px} /* ã¡ã‚‡ã„å¤§ãã‚è¦‹ã‚„ã™ã */

/* ãƒˆãƒ¼ã‚¹ãƒˆ/ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤/ç´™å¹é›ª */
.toast{position:absolute;left:50%;top:18%;transform:translate(-50%,0);background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none;z-index:7}
.toast.show{display:block}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:20px;z-index:6}
.overlay.show{display:flex}
.overlay .card{background:#ffffff; color:var(--text); border-radius:16px; padding:14px 16px; border:1px solid var(--line); min-width:260px}
.confetti{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.95;pointer-events:none;z-index:8}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">ğŸ”¢ æ•°å­—ã‚’ã‚ã¦ã‚ï¼ <span class="badge">v1.4</span></div>
      <div class="controls">
        <label>ãƒ¢ãƒ¼ãƒ‰
          <select id="modeSelect" title="ãƒ¢ãƒ¼ãƒ‰é¸æŠ">
            <option value="kids" selected>ã‚„ã•ã—ã„ï¼ˆå¹¼å…å‘ã‘ã‚¿ãƒƒãƒ—ï¼‰</option>
            <option value="normal">ãµã¤ã†ï¼ˆéšœå®³ç‰©ã‚ã‚Šï¼‰</option>
          </select>
        </label>
        <button id="btnStart" class="primary">â–¶ ã¯ã˜ã‚ã‚‹</button>
        <button id="btnPause" class="ghost">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="btnRestart" class="ghost">â†» ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>
  </header>

  <div id="gameWrap">
    <div id="board" class="board" role="application" aria-label="æ•°å­—ã‚’ã‚ã¦ã‚ï¼ ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢">
      <div class="hud">
        <div class="pill">ã‚¹ã‚³ã‚¢ <span id="sc">0</span></div>
        <div class="pill">ãƒ’ãƒƒãƒˆ <span id="hits">0</span></div>
        <div class="pill">ã‚¿ã‚¤ãƒãƒ¼ <span id="time">60.0</span>s</div>
      </div>
      <div id="world" class="world" aria-hidden="true"></div>
      <div id="toast" class="toast">+1</div>
      <div id="overlay" class="overlay" aria-live="polite">
        <div class="card">
          <h3 style="margin:6px 0 10px">ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼</h3>
          <p style="margin:0 0 10px">ã‚¹ã‚³ã‚¢ï¼š<b id="finalScore">0</b><br>ãƒ’ãƒƒãƒˆæ•°ï¼š<b id="finalHits">0</b><br>ãƒ©ãƒ³ã‚¯ï¼š<b id="finalRank">-</b></p>
          <button id="btnAgain" class="primary">ã‚‚ã†ä¸€åº¦</button>
        </div>
      </div>
    </div>
    <p style="opacity:.7;margin:10px 4px 0">
      æ“ä½œï¼šè½ã¡ã¦ãã‚‹<strong>æ•°å­—/é›²/æµã‚Œæ˜Ÿã‚’ã‚¿ãƒƒãƒ—</strong>ï¼ˆã‚„ã•ã—ã„ï¼šæ•°å­—ï¼‹æ™‚é–“å¸¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ãµã¤ã†ï¼šï¼‹éšœå®³ç‰©ã¯ã‚¿ãƒƒãƒ—ã§-5ï¼‰
    </p>
  </div>

<script>
(() => {
  /* ===== DOMå‚ç…§ ===== */
  const board = document.getElementById('board');
  const world = document.getElementById('world');
  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalHitsEl = document.getElementById('finalHits');
  const finalRankEl = document.getElementById('finalRank');
  const scEl = document.getElementById('sc');
  const timeEl = document.getElementById('time');
  const hitsEl = document.getElementById('hits');
  const toast = document.getElementById('toast');
  const modeSelect = document.getElementById('modeSelect');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnAgain = document.getElementById('btnAgain');

  /* ===== å®šæ•° ===== */
  const EMOJI = { cone:'ğŸš§', rock:'ğŸª¨', box:'ğŸ“¦', tree:'ğŸŒ³', cloud:'â˜ï¸', star:'ğŸŒ ' };
  const DIGIT_JA = ['ã‚¼ãƒ­','ã„ã¡','ã«','ã•ã‚“','ã‚ˆã‚“','ã”','ã‚ã','ãªãª','ã¯ã¡','ãã‚…ã†'];
  const TOTAL_TIME = 60.0;

  /* â˜… 10ç§’ã”ã¨åŠ é€Ÿï¼ˆ6æ®µï¼‰â˜… */
  const ACCEL_INTERVAL_SEC = 10;         // 0-10 / 10-20 / ... / 50-60
  const KIDS_ACCEL_FACTOR   = 1.10;      // æ®µã”ã¨å€ç‡ï¼ˆã‚„ã•ã—ã„ï¼‰
  const NORMAL_ACCEL_FACTOR = 1.15;      // æ®µã”ã¨å€ç‡ï¼ˆãµã¤ã†ï¼‰

  /* ã‚¹ã‚³ã‚¢â†’ãƒ©ãƒ³ã‚¯ */
  const RANK_THRESH = [
    { rank:'S', min:120 },
    { rank:'A', min:80  },
    { rank:'B', min:40  },
    { rank:'C', min:0   }
  ];

  /* ===== çŠ¶æ…‹ ===== */
  const state = {
    running:false, paused:false,
    lastT:0,
    timeLeft:TOTAL_TIME,
    mode:'kids',
    score:0, hits:0,
    objs:[],
    baseSpeedMin:90, baseSpeedMax:130,   // px/s
    baseSpawnMin:900, baseSpawnMax:1600, // ms
    spawnCd:0,
    obstacleRatio:0.0,
    friendlyRatio:0.15,
    daySegment:'noon',
    levelSeg:0                           // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«æ®µï¼ˆ0ã€œ5ï¼‰
  };

  /* ===== èƒŒæ™¯ãƒ†ãƒ¼ãƒï¼šæœ/æ˜¼/å¤•/å¤œ ===== */
  function getDaySegmentByHour(h){
    if(h>=5 && h<10) return 'morning';
    if(h>=10 && h<16) return 'noon';
    if(h>=16 && h<19) return 'evening';
    return 'night';
  }
  function applyDayTheme(){
    const h = new Date().getHours();
    state.daySegment = getDaySegmentByHour(h);
    board.classList.remove('theme-morning','theme-noon','theme-evening','theme-night');
    board.classList.add(
      state.daySegment==='morning' ? 'theme-morning' :
      state.daySegment==='noon'    ? 'theme-noon' :
      state.daySegment==='evening' ? 'theme-evening' : 'theme-night'
    );
  }

  /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function digitFontSize(d){ return clamp(88 - d*6, 28, 96); } // 0å¤§â†’9å°

  function place(o){
    const w = board.clientWidth;
    o.el.style.left = (o.xRatio*w) + 'px';
    o.el.style.top  = o.y + 'px';
  }

  /* ===== ãƒ¬ãƒ™ãƒ«ï¼ˆåŒºé–“ï¼‰ã¨åŠ é€Ÿä¿‚æ•° ===== */
  function getLevelSeg(){                    // 0..5
    const elapsed = TOTAL_TIME - state.timeLeft;
    return Math.floor(elapsed / ACCEL_INTERVAL_SEC);
  }
  function getAccelMultiplier(seg){
    const f = (state.mode==='normal') ? NORMAL_ACCEL_FACTOR : KIDS_ACCEL_FACTOR;
    return Math.pow(f, seg);
  }
  function currentSpeedRange(seg){
    const m = getAccelMultiplier(seg);
    return [state.baseSpeedMin*m, state.baseSpeedMax*m];
  }
  function currentSpawnRange(seg){
    const m = getAccelMultiplier(seg);
    return [state.baseSpawnMin/m, state.baseSpawnMax/m]; // é€Ÿã„ã»ã©å‡ºç¾çŸ­ç¸®
  }

  /* ===== å‡ºç¾ ===== */
  function pickFriendlyEmoji(){
    return (state.daySegment==='morning' || state.daySegment==='noon') ? EMOJI.cloud : EMOJI.star;
  }

  function spawn(){
    const xRatio = 0.06 + Math.random()*0.88;

    const friendlyRoll = Math.random() < state.friendlyRatio;
    const obstacleRoll = (state.mode==='normal') && (Math.random() < state.obstacleRatio);

    if(friendlyRoll){
      const el = document.createElement('div');
      el.className='obj friendly'; el.dataset.type='friendly';
      el.textContent = pickFriendlyEmoji();
      world.appendChild(el);
      const o = { el, type:'friendly', xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
      return;
    }

    if(obstacleRoll){
      const p = Math.random();
      const type = p<0.4 ? 'cone' : (p<0.7? 'box' : (p<0.88?'rock':'tree'));
      const el = document.createElement('div');
      el.className='obj'; el.dataset.type='obstacle';
      el.textContent = (type==='cone'? EMOJI.cone : type==='box'? EMOJI.box : type==='rock'? EMOJI.rock : EMOJI.tree);
      world.appendChild(el);
      const o = { el, type:'obstacle', xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
      return;
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼æ•°å­—
    const digit = Math.floor(Math.random()*10);
    const el = document.createElement('div');
    el.className='digit'; el.dataset.type='digit'; el.dataset.digit=String(digit);
    const num = document.createElement('div');
    num.className='num';
    num.textContent = String(digit);
    num.style.fontSize = digitFontSize(digit) + 'px';
    el.appendChild(num);
    world.appendChild(el);
    const o = { el, type:'digit', digit, xRatio, y:-30, _hit:false, _gone:false };
    place(o); attachTap(o); state.objs.push(o);
  }

  /* ===== Audioï¼ˆç°¡æ˜“SEï¼‰ ===== */
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    return !!audioCtx;
  }
  function beep({type='sine', f1=900, f2=1400, dur=0.12, gain=0.05}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type=type;
    o.frequency.setValueAtTime(f1, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+dur*0.7);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }
  function thud({f=140, dur=0.22, gain=0.085}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const n = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; n.type='triangle';
    o.frequency.setValueAtTime(f, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+dur);
    n.frequency.setValueAtTime(f*0.5, ctx.currentTime);
    n.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+dur);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); n.connect(g); g.connect(ctx.destination);
    o.start(); n.start(); o.stop(ctx.currentTime+dur); n.stop(ctx.currentTime+dur);
  }
  function playSnd(kind){
    if(kind==='ok'){
      beep({type:'sine',f1:1000,f2:1600,dur:0.11,gain:0.05});
      setTimeout(()=>beep({type:'triangle',f1:800,f2:1400,dur:0.10,gain:0.045}),60);
    }else if(kind==='bad'){
      thud();
    }else if(kind==='confetti'){
      beep({type:'square', f1:900, f2:1100, dur:0.08, gain:0.035});
    }else if(kind==='level'){
      beep({type:'square', f1:700, f2:1200, dur:0.12, gain:0.06});
    }
  }

  /* ===== ç´™å¹é›ª ===== */
  function confettiBurst(count=180){
    const rect = board.getBoundingClientRect();
    for(let i=0;i<count;i++){
      const s = document.createElement('div');
      s.className='confetti';
      const x = rand(0, rect.width);
      const y = rand(-20, 20);
      s.style.left = x + 'px';
      s.style.top  = y + 'px';
      const colors = ['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#1abc9c'];
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      s.style.transform = `rotate(${Math.floor(rand(-30,30))}deg)`;
      board.appendChild(s);
      const dy = rect.height + rand(80,160);
      const dx = rand(-80,80);
      const rot = rand(180, 720);
      s.animate(
        [{transform:`translate(0,0) rotate(0deg)`, opacity:1},
         {transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0.9}],
        {duration: rand(1200, 2200), easing:'cubic-bezier(.2,.6,.2,1)'}
      ).onfinish = ()=> s.remove();
    }
    playSnd('confetti');
  }

  /* ===== TTSï¼šç›´è¿‘ã ã‘èª­ã‚€ï¼ˆæ•°å­—ã®ã¿ï¼‰ ===== */
  let TTS_SEQ = 0;
  function cancelTTS(){ try{ speechSynthesis.cancel(); }catch(e){} }
  function speakTextJa(text){
    try{
      TTS_SEQ++;
      const seq = TTS_SEQ;
      cancelTTS();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP'; u.rate = 1.0;
      setTimeout(()=>{ if(seq===TTS_SEQ) try{ speechSynthesis.speak(u); }catch(e){} }, 0);
    }catch(e){}
  }
  function speakDigit(d){ speakTextJa(DIGIT_JA[d]||String(d)); }

  /* ===== ã‚¿ãƒƒãƒ—ä»˜ä¸ ===== */
  function attachTap(o){
    o.el.style.cursor='pointer';
    o.el.addEventListener('pointerdown',()=>{
      cancelTTS();
      if(o._hit) return;
      o._hit = true;
      if(o.type==='digit'){
        state.score += o.digit;
        state.hits++;
        showToast('+'+o.digit);
        speakDigit(o.digit);
        playSnd('ok');
      }else if(o.type==='friendly'){
        state.score += 1;
        state.hits++;
        showToast('+1');
        playSnd('ok');
      }else if(o.type==='obstacle' && state.mode==='normal'){
        state.score = Math.max(0, state.score - 5);
        showToast('-5');
        playSnd('bad');
      }
      o._gone = true;
      o.el.animate(
        [{transform:'translate(-50%,-50%) scale(1)',opacity:1},
         {transform:'translate(-50%,-60%) scale(1.15)',opacity:0}],
        {duration:220,easing:'ease-out'}
      ).onfinish=()=>o.el.remove();
      updateHUD();
    });
  }

  /* ===== UI ===== */
  function showToast(text='+1'){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 600);
  }
  function updateHUD(){
    scEl.textContent=state.score;
    hitsEl.textContent=state.hits;
    timeEl.textContent=state.timeLeft.toFixed(1);
  }

  /* ===== ãƒ©ãƒ³ã‚¯åˆ¤å®šï¼†TTSï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ ===== */
  const RANK_COMMENTS = {
    S:[ "æœ€é«˜ï¼ç¥ã‚¿ãƒƒãƒ—ï¼","å®Œç’§ï¼ä¿¡ã˜ã‚‰ã‚Œãªã„ç²¾åº¦ï¼","è¦‹äº‹ãªé›†ä¸­åŠ›ï¼","ã‚­ãƒ¬ãƒƒã‚­ãƒ¬ï¼","æ–‡å­—é€šã‚Šç„¡åŒï¼",
        "åœ§å·»ã®ã‚¹ã‚³ã‚¢ï¼","é³¥è‚Œã‚‚ã®ã®ä¸Šæ‰‹ã•ï¼","ã¾ã•ã«è·äººèŠ¸ï¼","åå¿œé€Ÿåº¦ãŒç¥åŸŸï¼","ç©¶æ¥µã®ã‚¿ãƒƒãƒï¼",
        "ä¼èª¬ç´šã®ãƒ—ãƒ¬ã‚¤ï¼","ç‹™ã„é€šã‚Šã®é€£ç™ºï¼","ãƒŸã‚¹ã®æ°—é…ã™ã‚‰ãªã„ï¼","å®Œç’§ãªãƒªã‚ºãƒ ï¼","ç¾ã—ã™ãã‚‹é€£æ‰“ï¼",
        "æ‰‹å…ƒãŒå†´ãˆæ¸¡ã£ã¦ã‚‹ï¼","é›†ä¸­ã®æ¥µã¿ï¼","é©šç•°çš„ãªå®‰å®šæ„Ÿï¼","ç›®ãŒè¿½ã„ã¤ã‹ãªã„ï¼","æ‰èƒ½ã€å¤§çˆ†ç™ºï¼",
        "ä»Šæ—¥ã‚¤ãƒã®å‡ºæ¥ï¼","ã‚‚ã†å„ªå‹ï¼","ãƒˆãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ ï¼","è¦‹ã¦ã¦æ°—æŒã¡ã„ã„ï¼","ãšã£ã¨è¦‹ã¦ã„ãŸã„ç²¾åº¦ï¼",
        "å‡„è…•ã¨ã¯ã“ã®ã“ã¨ï¼","å®Œå…¨ç„¡æ¬ ï¼","èŠ¸è¡“çš„ãªã‚¿ãƒƒãƒ—ï¼","ã‚­ãƒ¬å‘³MAXï¼","é»„é‡‘æ¯”ã®ãƒ†ãƒ³ãƒï¼",
        "æ­´ä»£ç´šã®ãƒã‚¤ã‚¹ã‚³ã‚¢æ„Ÿï¼","è¦šé†’ã—ã¦ã‚‹ï¼","èª°ã«ã‚‚æ­¢ã‚ã‚‰ã‚Œãªã„ï¼","æœ€é«˜é›£æ˜“åº¦ã‚‚ä½™è£•ï¼","æ¯ã‚’å‘‘ã‚€ã†ã¾ã•ï¼",
        "ç™¾ç™ºç™¾ä¸­ï¼","é›†ä¸­åŠ›ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼","åå°„ç¥çµŒãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ï¼","å®Œç’§ãªçµ‚ç›¤ï¼","çµ‚å§‹ãƒã‚¤ãƒšãƒ¼ã‚¹ï¼",
        "ç‹™ã„ãŒãƒ–ãƒ¬ãªã„ï¼","è¶…äººç´šã®å®‰å®šï¼","ãƒ—ãƒ¬ã‚¤ãŒæ´—ç·´ã•ã‚Œã¦ã‚‹ï¼","é€Ÿãã¦æ­£ç¢ºï¼","æƒšã‚Œæƒšã‚Œã™ã‚‹ç²¾åº¦ï¼",
        "ä¼èª¬æ›´æ–°ï¼","åœ§å€’çš„ï¼","æ¥µã‚ã¦ã‚‹ã­ï¼","è¦‹äº‹ã®ã²ã¨è¨€ï¼","ãƒ–ãƒ©ãƒœãƒ¼ï¼" ],
    A:[ "ã¨ã¦ã‚‚ä¸Šæ‰‹ï¼","ã„ã„ãƒšãƒ¼ã‚¹ï¼","å®‰å®šã—ã¦ã‚‹ï¼","åå¿œãŒé€Ÿã„ï¼","ã‚­ãƒ¬ãŒã‚ã‚‹ï¼",
        "ãƒãƒƒã¦ã‚‹ã­ï¼","ç‹™ã„é€šã‚Šï¼","é›†ä¸­ã§ãã¦ã‚‹ï¼","ã†ã¾ã„ï¼","ã‚¹ãƒ ãƒ¼ã‚ºã ã£ãŸï¼",
        "ãƒ†ãƒ³ãƒãŒè‰¯ã„ï¼","çµ‚ç›¤ä¼¸ã³ãŸï¼","è½ã¡ç€ã„ã¦ãŸï¼","ç²¾åº¦ãŒé«˜ã„ï¼","ã‚ã¨å°‘ã—ã§Sï¼",
        "é€£æ‰“ãŒç¾ã—ã„ï¼","æµã‚Œã‚’æ´ã‚“ã§ãŸï¼","ç‹™ã„ãŒæ­£ç¢ºï¼","è¦–ç·šã®é‹ã³ãŒè‰¯ã„ï¼","æœŸå¾…ä»¥ä¸Šï¼",
        "ã„ã„ç·Šå¼µæ„Ÿï¼","å®Œæˆåº¦ãŒé«˜ã„ï¼","æ…£ã‚Œã¦ããŸã­ï¼","æ‰‹å¿œãˆååˆ†ï¼","ç‹™ã„ç¶šã‘ã‚‰ã‚ŒãŸï¼",
        "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè‰¯ã„ï¼","å¼·ã„ãƒ¡ãƒ³ã‚¿ãƒ«ï¼","ãƒªã‚ºãƒ ãŒå–ã‚Œã¦ãŸï¼","çµ‚å§‹å®‰å®šï¼","åˆ¤æ–­ãŒé€Ÿã„ï¼",
        "è¦–é‡ãŒåºƒã„ï¼","ä¼¸ã³ã—ã‚ã—ã‹ãªã„ï¼","è‰¯ã„æŒ‘æˆ¦ï¼","ç©ã¿ä¸ŠãŒã£ã¦ã‚‹ï¼","ç´ æ™´ã‚‰ã—ã„ç²˜ã‚Šï¼",
        "æ¬¡ã¯SãŒè¦‹ãˆã‚‹ï¼","æœ€å¾Œã¾ã§é›†ä¸­ï¼","æ­£ç¢ºæ€§ãŒå…‰ã£ãŸï¼","æ“ä½œãŒä¸å¯§ï¼","è² ã‘ãªã„ç²¾åº¦ï¼",
        "ç¶ºéº—ãªã‚¿ãƒƒãƒ—ï¼","ã‚¯ãƒªãƒ¼ãƒ³ãƒ’ãƒƒãƒˆå¤šã‚ï¼","ä½™è£•ã‚’æ„Ÿã˜ãŸï¼","èª¿å­ãŒä¸ŠãŒã£ã¦ã‚‹ï¼","èŠ¯ã‚’æ‰ãˆã¦ãŸï¼",
        "ãƒ¡ãƒªãƒãƒªãŒè‰¯ã‹ã£ãŸï¼","éå»ä¸€ã‹ã‚‚ï¼","è‡ªä¿¡ã‚’æŒã£ã¦ï¼","å ‚ã€…ã®Aï¼","ãƒŠã‚¤ã‚¹ã‚²ãƒ¼ãƒ ï¼" ],
    B:[ "ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆï¼","è½ã¡ç€ã„ã¦ã¦è‰¯ã„ï¼","ã‚³ãƒ„ã‚’æ´ã‚“ã§ããŸï¼","æ¬¡ã¯ã‚‚ã£ã¨ã„ã‘ã‚‹ï¼","ç„¦ã‚‰ãšã„ã“ã†ï¼",
        "å®‰å®šæ„ŸãŒå‡ºã¦ããŸï¼","ã ã‚“ã ã‚“è‰¯ããªã£ã¦ã‚‹ï¼","ç€å®Ÿã«å‰é€²ï¼","ç‹™ã„ã¯æ‚ªããªã„ï¼","ä¼¸ã³ä»£ãŸã£ã·ã‚Šï¼",
        "ãƒŸã‚¹ã‚’æã‚Œãªã„ã§OKï¼","ãƒ†ãƒ³ãƒã®æ”¹å–„ãƒŠã‚¤ã‚¹ï¼","é€”ä¸­ã‹ã‚‰è‰¯ã‹ã£ãŸï¼","çµ‚ç›¤ã«å¸Œæœ›ã‚ã‚Šï¼","åŸºç¤ãŒã§ãã¦ã‚‹ï¼",
        "è¦–ç·šç§»å‹•ãŒä¸Šé”ï¼","æŒ‡ãŒæ¸©ã¾ã£ã¦ããŸï¼","è‰¯ã„çµŒé¨“å€¤ã«ãªã£ãŸï¼","ç©ã¿é‡ã­ãŒåŠ¹ãã‚ˆï¼","ã‚‚ã†ä¸€æ­©ï¼",
        "æ…£ã‚Œã‚Œã°ä¸€æ°—ã«ä¼¸ã³ã‚‹ï¼","ã‚¿ãƒƒãƒ—ãŒç´ ç›´ï¼","ç·´ç¿’ã®æˆæœãŒå‡ºã¦ã‚‹ï¼","è½ã¡ç€ããŒå¤§äº‹ï¼","ç„¦ç‚¹ã®åˆã‚ã›æ–¹ãŒè‰¯ã„ï¼",
        "æ¬¡å›ãŒæ¥½ã—ã¿ï¼","æˆåŠŸä½“é¨“ã‚’å¢—ã‚„ãã†ï¼","ãƒšãƒ¼ã‚¹é…åˆ†ã‚’æ„è­˜ï¼","ãƒªã‚ºãƒ ä½œã‚Šã«æŒ‘æˆ¦ï¼","è‰¯ã„è©¦è¡ŒéŒ¯èª¤ï¼",
        "ç€çœ¼ç‚¹ãŒè‰¯ã„ï¼","å®‰å®šåŒ–ã‚’ç›®æŒ‡ãã†ï¼","ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç·´åº¦ã‚¢ãƒƒãƒ—ä¸­ï¼","è¦–é‡ãŒåºƒãŒã£ã¦ã‚‹ï¼","æ‰‹å¿œãˆãŒå‡ºã¦ããŸï¼",
        "æµã‚Œã«ä¹—ã‚ŒãŸç¬é–“ã‚ã‚Šï¼","ãƒŸã‚¹ã‚’æã‚Œãšç¶šã‘ã‚ˆã†ï¼","æ¬¡ã®10ç§’ã‚’å¤§äº‹ã«ï¼","è‰¯ã„åçœã¨åç©«ï¼","ç¢ºå®Ÿã«æˆé•·ï¼",
        "åŸºæœ¬ãŒå›ºã¾ã£ã¦ããŸï¼","é›†ä¸­ã®å…¥ã‚ŠãŒè‰¯ããªã‚‹ï¼","å‘¼å¸ã‚’æ•´ãˆã‚‹ã¨â—ï¼","æ¬¡ã¯AãŒè¦‹ãˆã‚‹ï¼","è«¦ã‚ãªã„å§¿å‹¢ãŒç´ æ•µï¼",
        "çµŒé¨“å€¤ãŒè²¯ã¾ã£ã¦ã‚‹ï¼","ç¶™ç¶šã¯åŠ›ãªã‚Šï¼","ç€å®Ÿãªä¼¸ã³ï¼","ãƒŠã‚¤ã‚¹ãƒˆãƒ©ã‚¤ï¼","ã„ã„ç·´ç¿’ã«ãªã£ãŸï¼" ],
    C:[ "ã“ã“ã‹ã‚‰å§‹ã‚ã‚ˆã†ï¼","ã¾ãšã¯è½ã¡ç€ã„ã¦ï¼","æŒ‡æ…£ã‚‰ã—ã‚’ã—ã¦ã„ã“ã†ï¼","å¤§ä¸ˆå¤«ã€æ¬¡ã¯è‰¯ããªã‚‹ï¼","ã‚†ã£ãã‚Šã§OKï¼",
        "ç„¦ã‚‰ãªã„ã§ä¸€ã¤ãšã¤ï¼","ã‚¿ãƒƒãƒ—æ„Ÿè¦šã‚’æ´ã‚‚ã†ï¼","çŸ­æ™‚é–“ã®ç·´ç¿’ã‚’é‡ã­ã‚ˆã†ï¼","ç›®ã‚’æ…£ã‚‰ãã†ï¼","æ‰‹ã®æº–å‚™é‹å‹•ã‚’ï¼",
        "æœ€åˆã¯èª°ã§ã‚‚ã“ã“ã‹ã‚‰ï¼","ç¶šã‘ã‚Œã°å¿…ãšä¼¸ã³ã‚‹ï¼","ç‹™ã„ã‚’çµã£ã¦ã¿ã‚ˆã†ï¼","ãƒªã‚ºãƒ ã‚’æ„Ÿã˜ã¦ã„ã“ã†ï¼","å¤±æ•—ã¯æˆåŠŸã®ç¨®ï¼",
        "ç°¡å˜ãªæµã‚Œã‹ã‚‰ï¼","ãƒ†ãƒ³ãƒã‚’ä¸€å®šã«ï¼","è¦–ç·šã®ç§»å‹•ã‚’çŸ­ãï¼","æ‰‹å…ƒã‚’æ¸©ã‚ã¦å†æŒ‘æˆ¦ï¼","æ¬¡ã¯ä¸€æ­©å‰é€²ï¼",
        "æ·±å‘¼å¸ã—ã¦ã‹ã‚‰ï¼","10ç§’ã‚’åŒºåˆ‡ã‚Šã«é ‘å¼µã‚ã†ï¼","ç‹™ã„ã¯ä¸­å¤®ã‹ã‚‰ï¼","è¦–ç•Œã‚’ã‚¯ãƒªã‚¢ã«ï¼","ã¾ãšã¯ãƒ’ãƒƒãƒˆå›æ•°ã‚’å¢—ã‚„ãã†ï¼",
        "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«é›†ä¸­ï¼","éŸ³ã‚’ç›®å®‰ã«ï¼","æ…£ã‚Œã‚‹ã¨æ¥½ã—ããªã‚‹ã‚ˆï¼","ä»Šæ—¥ã¯è‚©æ…£ã‚‰ã—ï¼","æ¬¡ã«æœŸå¾…ï¼",
        "è‰¯ã„ãƒªã‚»ãƒƒãƒˆã ã£ãŸï¼","ç„¡ç†ã—ãªãã¦OKï¼","å°‘ã—ãšã¤æ­£ç¢ºã«ï¼","æ‰‹å¿œãˆã¯ã“ã‚Œã‹ã‚‰ï¼","è¦–ç·šã®å‹•ãã«æ…£ã‚Œã‚ˆã†ï¼",
        "çŸ­ã„ç·´ç¿’ã‚’ä½•åº¦ã‚‚ï¼","è¿·ã£ãŸã‚‰è¦‹é€ã‚Šã§OKï¼","æ•´ãˆã¦å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼","ã¾ãšã¯æˆåŠŸä½“é¨“ã‚’ï¼","æ°—æŒã¡ã‚’è»½ãï¼",
        "ã‚¿ãƒƒãƒ—ã‚’ä¸å¯§ã«ï¼","ç„¦ç‚¹ã‚’1ç‚¹ã«ï¼","æ¬¡ã¯ã‚‚ã†å°‘ã—ç²˜ã‚ã†ï¼","å°‘ã—ãšã¤ä¸Šã’ã¦ã„ã“ã†ï¼","ä¸€ç·’ã«æˆé•·ã—ã‚ˆã†ï¼",
        "æ°—è² ã‚ãšã„ã“ã†ï¼","å‰ã‚’å‘ã„ã¦OKï¼","æœ€åˆã®ä¸€æ­©ã¯åˆæ ¼ï¼","ç¶šã‘ã‚‹ã“ã¨ãŒå‹ã¡ï¼","ã“ã“ã‹ã‚‰å·»ãè¿”ãã†ï¼" ]
  };

  function getRank(score){
    for(const r of RANK_THRESH){ if(score>=r.min) return r.rank; }
    return 'C';
  }
  function speakFinishByRank(rank, score){
    const list = RANK_COMMENTS[rank] || ["ãŠã¤ã‹ã‚Œã•ã¾ï¼ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼"];
    const msg = list[Math.floor(Math.random()*list.length)];
    speakTextJa(`ãƒ©ãƒ³ã‚¯${rank}ã€‚ã‚¹ã‚³ã‚¢ã¯${score}ã€‚${msg}`);
  }

  /* ===== é€²è¡Œç®¡ç† ===== */
  function reset(){
    cancelTTS();
    state.running=false; state.paused=false; state.lastT=0;
    state.timeLeft = TOTAL_TIME;
    state.score = 0; state.hits = 0;
    state.objs.length=0; world.innerHTML='';
    state.levelSeg = 0;

    const m = modeSelect.value;
    state.mode = m;
    if(m==='kids'){
      state.baseSpeedMin = 100; state.baseSpeedMax = 150;
      state.baseSpawnMin = 900; state.baseSpawnMax = 1500;
      state.obstacleRatio = 0.0;
      state.friendlyRatio = 0.16;
    }else{
      state.baseSpeedMin = 150; state.baseSpeedMax = 260;
      state.baseSpawnMin = 520; state.baseSpawnMax = 900;
      state.obstacleRatio = 0.25;
      state.friendlyRatio = 0.12;
    }
    state.spawnCd = 0;

    overlay.classList.remove('show');
    applyDayTheme();
    updateHUD();
  }

  function start(){
    if(state.running) return;
    state.running = true;
    state.paused = false;
    state.lastT = performance.now();
    ensureAudio();
    state.spawnCd = 0;
    spawn();                 // å³æ™‚å‡ºç¾
    showToast('Start!');
    updateHUD();
    requestAnimationFrame(loop);
  }

  function pause(){
    state.paused=!state.paused;
    btnPause.textContent=state.paused?'â–¶ å†é–‹':'â¸ ä¸€æ™‚åœæ­¢';
    if(!state.paused){ state.lastT=performance.now(); requestAnimationFrame(loop); }
  }

  function endGame(){
    state.running=false;
    finalScoreEl.textContent=state.score;
    finalHitsEl.textContent=state.hits;
    const rank = getRank(state.score);
    finalRankEl.textContent = rank;
    overlay.classList.add('show');
    confettiBurst(180);
    speakFinishByRank(rank, state.score);
  }

  function loop(t){
    if(!state.running) return;
    if(state.paused){ requestAnimationFrame(loop); return; }
    const dtMs = state.lastT? Math.min(60, t - state.lastT) : 16; state.lastT = t;
    const dt = dtMs/1000;

    // æ™‚é–“
    state.timeLeft = Math.max(0, state.timeLeft - dt);
    if(state.timeLeft<=0){ updateHUD(); endGame(); return; }

    // â˜… ãƒ¬ãƒ™ãƒ«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨ˆç®—ï¼ˆ10ç§’ã”ã¨ï¼‰ï¼†ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡º
    const seg = getLevelSeg();
    if(seg > state.levelSeg){           // æ–°ã—ã„åŒºé–“ã«å…¥ã£ãŸ
      state.levelSeg = seg;
      if(seg > 0){ showToast('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ï¼'); playSnd('level'); }
    }

    // ç¾åœ¨ã®é€Ÿåº¦ï¼†å‡ºç¾é–“éš”ï¼ˆ10ç§’ã”ã¨ã«æ®µéšåŠ é€Ÿï¼‰
    const [vmin, vmax] = currentSpeedRange(seg);
    const speedNow = rand(vmin, vmax);
    state.spawnCd -= dtMs;
    if(state.spawnCd<=0){
      spawn();
      const [imin, imax] = currentSpawnRange(seg);
      state.spawnCd = rand(imin*0.7, imax*1.3);
    }

    // è½ä¸‹ï¼†æƒé™¤
    for(const o of state.objs){
      if(o._gone) continue;
      o.y += speedNow*dt;
      place(o);
    }
    state.objs = state.objs.filter(o=>{
      if(o._gone) return false;
      if(o.y > board.clientHeight + 60){ o.el.remove(); return false; }
      return true;
    });

    updateHUD();
    requestAnimationFrame(loop);
  }

  /* ===== æ“ä½œ ===== */
  function unlockAudioOnce(){ ensureAudio(); world.removeEventListener('pointerdown', unlockAudioOnce); }
  world.addEventListener('pointerdown', unlockAudioOnce);

  btnStart.addEventListener('click', ()=>{ reset(); start(); });
  btnPause.addEventListener('click', ()=> pause());
  btnRestart.addEventListener('click', ()=>{ reset(); start(); });
  btnAgain && btnAgain.addEventListener('click', ()=>{ reset(); start(); });
  modeSelect.addEventListener('change', ()=>{ reset(); });

  // åˆæœŸåŒ–
  reset();
})();
</script>
</body>
</html>

