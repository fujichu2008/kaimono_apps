<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>数字をあてろ！</title>
<meta name="theme-color" content="#2b8a3e">
<style>
:root{
  --bg:#f0f7ff; --card:#ffffff; --line:#d7e6ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b8a3e; --accent-2:#18753a; --warn:#ef4444; --ok:#16a34a; --gold:#f5c542;
}

/* ==== レイアウト共通 ==== */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}

header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff 0%,#f7fbff 100%);border-bottom:1px solid var(--line)}
header .bar{max-width:880px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:10px;padding:8px 10px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button.ghost{background:#fff}
#gameWrap{max-width:880px;margin:10px auto;padding:10px}

/* ==== ボード＆背景（時間帯で切替） ==== */
.board{
  position:relative;margin:0 auto;border-radius:18px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(0,0,0,.06);
  overflow:hidden;touch-action:manipulation;height:64svh;min-height:400px;max-height:640px;
  background:linear-gradient(180deg,#cfe8ff 0%,#bfe0ff 50%,#dff4ff 100%);
}
@media (max-width:480px){ .board{height:66svh;min-height:380px} }

/* 朝：やわらかい空色 */
.theme-morning{ background:linear-gradient(180deg,#fff3cc 0%,#ffe9a8 40%,#d8f0ff 100%) !important; }
/* 昼：高コントラストの青空 */
.theme-noon{ background:linear-gradient(180deg,#b3e5ff 0%,#87d2ff 55%,#dff8ff 100%) !important; }
/* 夕：オレンジ〜薄紫 */
.theme-evening{ background:linear-gradient(180deg,#ffd6a8 0%,#ffb37a 40%,#f3a2c2 80%,#e6e9ff 100%) !important; }
/* 夜：深い群青〜星明り */
.theme-night{ background:radial-gradient(1200px 420px at 50% -10%,#364e72 0%,#1e2b44 60%,#0f172a 100%) !important; }

.hud{position:absolute;left:0;top:0;right:0;display:flex;justify-content:space-between;gap:8px;padding:8px 10px;font-weight:700;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.6));backdrop-filter:blur(2px);z-index:3}
.hud .pill{background:#fff;border:1px solid var(--line);padding:4px 10px;border-radius:999px}
.world{position:absolute;inset:0}

/* 数字：コイン風（数字サイズはJSで可変：0最大→9最小） */
.digit{
  position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#1f2937;border-radius:999px;border:2px solid #d4a025;
  background:radial-gradient(circle at 30% 30%, #fff8d6, #f9d879 45%, #e6b83d 60%, #c9972e 100%);
  box-shadow:0 4px 10px rgba(0,0,0,.18); padding:8px
}
.digit .num{line-height:1}

/* 障害物／フレンドリー（雲・流れ星） */
.obj{position:absolute;transform:translate(-50%,-50%);font-size:32px;line-height:1;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2))}
.obj.friendly{font-size:34px} /* ちょい大きめ見やすく */

/* トースト/オーバーレイ/紙吹雪 */
.toast{position:absolute;left:50%;top:18%;transform:translate(-50%,0);background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none;z-index:7}
.toast.show{display:block}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:20px;z-index:6}
.overlay.show{display:flex}
.overlay .card{background:#ffffff; color:var(--text); border-radius:16px; padding:14px 16px; border:1px solid var(--line); min-width:260px}
.confetti{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.95;pointer-events:none;z-index:8}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">🔢 数字をあてろ！ <span class="badge">v1.4</span></div>
      <div class="controls">
        <label>モード
          <select id="modeSelect" title="モード選択">
            <option value="kids" selected>やさしい（幼児向けタップ）</option>
            <option value="normal">ふつう（障害物あり）</option>
          </select>
        </label>
        <button id="btnStart" class="primary">▶ はじめる</button>
        <button id="btnPause" class="ghost">⏸ 一時停止</button>
        <button id="btnRestart" class="ghost">↻ リスタート</button>
      </div>
    </div>
  </header>

  <div id="gameWrap">
    <div id="board" class="board" role="application" aria-label="数字をあてろ！ ゲームエリア">
      <div class="hud">
        <div class="pill">スコア <span id="sc">0</span></div>
        <div class="pill">ヒット <span id="hits">0</span></div>
        <div class="pill">タイマー <span id="time">60.0</span>s</div>
      </div>
      <div id="world" class="world" aria-hidden="true"></div>
      <div id="toast" class="toast">+1</div>
      <div id="overlay" class="overlay" aria-live="polite">
        <div class="card">
          <h3 style="margin:6px 0 10px">タイムアップ！</h3>
          <p style="margin:0 0 10px">スコア：<b id="finalScore">0</b><br>ヒット数：<b id="finalHits">0</b><br>ランク：<b id="finalRank">-</b></p>
          <button id="btnAgain" class="primary">もう一度</button>
        </div>
      </div>
    </div>
    <p style="opacity:.7;margin:10px 4px 0">
      操作：落ちてくる<strong>数字/雲/流れ星をタップ</strong>（やさしい：数字＋時間帯オブジェクト／ふつう：＋障害物はタップで-5）
    </p>
  </div>

<script>
(() => {
  /* ===== DOM参照 ===== */
  const board = document.getElementById('board');
  const world = document.getElementById('world');
  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalHitsEl = document.getElementById('finalHits');
  const finalRankEl = document.getElementById('finalRank');
  const scEl = document.getElementById('sc');
  const timeEl = document.getElementById('time');
  const hitsEl = document.getElementById('hits');
  const toast = document.getElementById('toast');
  const modeSelect = document.getElementById('modeSelect');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnAgain = document.getElementById('btnAgain');

  /* ===== 定数 ===== */
  const EMOJI = { cone:'🚧', rock:'🪨', box:'📦', tree:'🌳', cloud:'☁️', star:'🌠' };
  const DIGIT_JA = ['ゼロ','いち','に','さん','よん','ご','ろく','なな','はち','きゅう'];
  const TOTAL_TIME = 60.0;

  /* ★ 10秒ごと加速（6段）★ */
  const ACCEL_INTERVAL_SEC = 10;         // 0-10 / 10-20 / ... / 50-60
  const KIDS_ACCEL_FACTOR   = 1.10;      // 段ごと倍率（やさしい）
  const NORMAL_ACCEL_FACTOR = 1.15;      // 段ごと倍率（ふつう）

  /* スコア→ランク */
  const RANK_THRESH = [
    { rank:'S', min:120 },
    { rank:'A', min:80  },
    { rank:'B', min:40  },
    { rank:'C', min:0   }
  ];

  /* ===== 状態 ===== */
  const state = {
    running:false, paused:false,
    lastT:0,
    timeLeft:TOTAL_TIME,
    mode:'kids',
    score:0, hits:0,
    objs:[],
    baseSpeedMin:90, baseSpeedMax:130,   // px/s
    baseSpawnMin:900, baseSpawnMax:1600, // ms
    spawnCd:0,
    obstacleRatio:0.0,
    friendlyRatio:0.15,
    daySegment:'noon',
    levelSeg:0                           // 現在のレベル段（0〜5）
  };

  /* ===== 背景テーマ：朝/昼/夕/夜 ===== */
  function getDaySegmentByHour(h){
    if(h>=5 && h<10) return 'morning';
    if(h>=10 && h<16) return 'noon';
    if(h>=16 && h<19) return 'evening';
    return 'night';
  }
  function applyDayTheme(){
    const h = new Date().getHours();
    state.daySegment = getDaySegmentByHour(h);
    board.classList.remove('theme-morning','theme-noon','theme-evening','theme-night');
    board.classList.add(
      state.daySegment==='morning' ? 'theme-morning' :
      state.daySegment==='noon'    ? 'theme-noon' :
      state.daySegment==='evening' ? 'theme-evening' : 'theme-night'
    );
  }

  /* ===== ユーティリティ ===== */
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function digitFontSize(d){ return clamp(88 - d*6, 28, 96); } // 0大→9小

  function place(o){
    const w = board.clientWidth;
    o.el.style.left = (o.xRatio*w) + 'px';
    o.el.style.top  = o.y + 'px';
  }

  /* ===== レベル（区間）と加速係数 ===== */
  function getLevelSeg(){                    // 0..5
    const elapsed = TOTAL_TIME - state.timeLeft;
    return Math.floor(elapsed / ACCEL_INTERVAL_SEC);
  }
  function getAccelMultiplier(seg){
    const f = (state.mode==='normal') ? NORMAL_ACCEL_FACTOR : KIDS_ACCEL_FACTOR;
    return Math.pow(f, seg);
  }
  function currentSpeedRange(seg){
    const m = getAccelMultiplier(seg);
    return [state.baseSpeedMin*m, state.baseSpeedMax*m];
  }
  function currentSpawnRange(seg){
    const m = getAccelMultiplier(seg);
    return [state.baseSpawnMin/m, state.baseSpawnMax/m]; // 速いほど出現短縮
  }

  /* ===== 出現 ===== */
  function pickFriendlyEmoji(){
    return (state.daySegment==='morning' || state.daySegment==='noon') ? EMOJI.cloud : EMOJI.star;
  }

  function spawn(){
    const xRatio = 0.06 + Math.random()*0.88;

    const friendlyRoll = Math.random() < state.friendlyRatio;
    const obstacleRoll = (state.mode==='normal') && (Math.random() < state.obstacleRatio);

    if(friendlyRoll){
      const el = document.createElement('div');
      el.className='obj friendly'; el.dataset.type='friendly';
      el.textContent = pickFriendlyEmoji();
      world.appendChild(el);
      const o = { el, type:'friendly', xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
      return;
    }

    if(obstacleRoll){
      const p = Math.random();
      const type = p<0.4 ? 'cone' : (p<0.7? 'box' : (p<0.88?'rock':'tree'));
      const el = document.createElement('div');
      el.className='obj'; el.dataset.type='obstacle';
      el.textContent = (type==='cone'? EMOJI.cone : type==='box'? EMOJI.box : type==='rock'? EMOJI.rock : EMOJI.tree);
      world.appendChild(el);
      const o = { el, type:'obstacle', xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
      return;
    }

    // デフォルト＝数字
    const digit = Math.floor(Math.random()*10);
    const el = document.createElement('div');
    el.className='digit'; el.dataset.type='digit'; el.dataset.digit=String(digit);
    const num = document.createElement('div');
    num.className='num';
    num.textContent = String(digit);
    num.style.fontSize = digitFontSize(digit) + 'px';
    el.appendChild(num);
    world.appendChild(el);
    const o = { el, type:'digit', digit, xRatio, y:-30, _hit:false, _gone:false };
    place(o); attachTap(o); state.objs.push(o);
  }

  /* ===== Audio（簡易SE） ===== */
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    return !!audioCtx;
  }
  function beep({type='sine', f1=900, f2=1400, dur=0.12, gain=0.05}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type=type;
    o.frequency.setValueAtTime(f1, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+dur*0.7);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }
  function thud({f=140, dur=0.22, gain=0.085}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const n = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; n.type='triangle';
    o.frequency.setValueAtTime(f, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+dur);
    n.frequency.setValueAtTime(f*0.5, ctx.currentTime);
    n.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+dur);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); n.connect(g); g.connect(ctx.destination);
    o.start(); n.start(); o.stop(ctx.currentTime+dur); n.stop(ctx.currentTime+dur);
  }
  function playSnd(kind){
    if(kind==='ok'){
      beep({type:'sine',f1:1000,f2:1600,dur:0.11,gain:0.05});
      setTimeout(()=>beep({type:'triangle',f1:800,f2:1400,dur:0.10,gain:0.045}),60);
    }else if(kind==='bad'){
      thud();
    }else if(kind==='confetti'){
      beep({type:'square', f1:900, f2:1100, dur:0.08, gain:0.035});
    }else if(kind==='level'){
      beep({type:'square', f1:700, f2:1200, dur:0.12, gain:0.06});
    }
  }

  /* ===== 紙吹雪 ===== */
  function confettiBurst(count=180){
    const rect = board.getBoundingClientRect();
    for(let i=0;i<count;i++){
      const s = document.createElement('div');
      s.className='confetti';
      const x = rand(0, rect.width);
      const y = rand(-20, 20);
      s.style.left = x + 'px';
      s.style.top  = y + 'px';
      const colors = ['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#1abc9c'];
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      s.style.transform = `rotate(${Math.floor(rand(-30,30))}deg)`;
      board.appendChild(s);
      const dy = rect.height + rand(80,160);
      const dx = rand(-80,80);
      const rot = rand(180, 720);
      s.animate(
        [{transform:`translate(0,0) rotate(0deg)`, opacity:1},
         {transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0.9}],
        {duration: rand(1200, 2200), easing:'cubic-bezier(.2,.6,.2,1)'}
      ).onfinish = ()=> s.remove();
    }
    playSnd('confetti');
  }

  /* ===== TTS：直近だけ読む（数字のみ） ===== */
  let TTS_SEQ = 0;
  function cancelTTS(){ try{ speechSynthesis.cancel(); }catch(e){} }
  function speakTextJa(text){
    try{
      TTS_SEQ++;
      const seq = TTS_SEQ;
      cancelTTS();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP'; u.rate = 1.0;
      setTimeout(()=>{ if(seq===TTS_SEQ) try{ speechSynthesis.speak(u); }catch(e){} }, 0);
    }catch(e){}
  }
  function speakDigit(d){ speakTextJa(DIGIT_JA[d]||String(d)); }

  /* ===== タップ付与 ===== */
  function attachTap(o){
    o.el.style.cursor='pointer';
    o.el.addEventListener('pointerdown',()=>{
      cancelTTS();
      if(o._hit) return;
      o._hit = true;
      if(o.type==='digit'){
        state.score += o.digit;
        state.hits++;
        showToast('+'+o.digit);
        speakDigit(o.digit);
        playSnd('ok');
      }else if(o.type==='friendly'){
        state.score += 1;
        state.hits++;
        showToast('+1');
        playSnd('ok');
      }else if(o.type==='obstacle' && state.mode==='normal'){
        state.score = Math.max(0, state.score - 5);
        showToast('-5');
        playSnd('bad');
      }
      o._gone = true;
      o.el.animate(
        [{transform:'translate(-50%,-50%) scale(1)',opacity:1},
         {transform:'translate(-50%,-60%) scale(1.15)',opacity:0}],
        {duration:220,easing:'ease-out'}
      ).onfinish=()=>o.el.remove();
      updateHUD();
    });
  }

  /* ===== UI ===== */
  function showToast(text='+1'){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 600);
  }
  function updateHUD(){
    scEl.textContent=state.score;
    hitsEl.textContent=state.hits;
    timeEl.textContent=state.timeLeft.toFixed(1);
  }

  /* ===== ランク判定＆TTS（コメント） ===== */
  const RANK_COMMENTS = {
    S:[ "最高！神タップ！","完璧！信じられない精度！","見事な集中力！","キレッキレ！","文字通り無双！",
        "圧巻のスコア！","鳥肌ものの上手さ！","まさに職人芸！","反応速度が神域！","究極のタッチ！",
        "伝説級のプレイ！","狙い通りの連発！","ミスの気配すらない！","完璧なリズム！","美しすぎる連打！",
        "手元が冴え渡ってる！","集中の極み！","驚異的な安定感！","目が追いつかない！","才能、大爆発！",
        "今日イチの出来！","もう優勝！","トップフォーム！","見てて気持ちいい！","ずっと見ていたい精度！",
        "凄腕とはこのこと！","完全無欠！","芸術的なタップ！","キレ味MAX！","黄金比のテンポ！",
        "歴代級のハイスコア感！","覚醒してる！","誰にも止められない！","最高難易度も余裕！","息を呑むうまさ！",
        "百発百中！","集中力モンスター！","反射神経チャンピオン！","完璧な終盤！","終始ハイペース！",
        "狙いがブレない！","超人級の安定！","プレイが洗練されてる！","速くて正確！","惚れ惚れする精度！",
        "伝説更新！","圧倒的！","極めてるね！","見事のひと言！","ブラボー！" ],
    A:[ "とても上手！","いいペース！","安定してる！","反応が速い！","キレがある！",
        "ノッてるね！","狙い通り！","集中できてる！","うまい！","スムーズだった！",
        "テンポが良い！","終盤伸びた！","落ち着いてた！","精度が高い！","あと少しでS！",
        "連打が美しい！","流れを掴んでた！","狙いが正確！","視線の運びが良い！","期待以上！",
        "いい緊張感！","完成度が高い！","慣れてきたね！","手応え十分！","狙い続けられた！",
        "タイミングが良い！","強いメンタル！","リズムが取れてた！","終始安定！","判断が速い！",
        "視野が広い！","伸びしろしかない！","良い挑戦！","積み上がってる！","素晴らしい粘り！",
        "次はSが見える！","最後まで集中！","正確性が光った！","操作が丁寧！","負けない精度！",
        "綺麗なタップ！","クリーンヒット多め！","余裕を感じた！","調子が上がってる！","芯を捉えてた！",
        "メリハリが良かった！","過去一かも！","自信を持って！","堂々のA！","ナイスゲーム！" ],
    B:[ "いいスタート！","落ち着いてて良い！","コツを掴んできた！","次はもっといける！","焦らずいこう！",
        "安定感が出てきた！","だんだん良くなってる！","着実に前進！","狙いは悪くない！","伸び代たっぷり！",
        "ミスを恐れないでOK！","テンポの改善ナイス！","途中から良かった！","終盤に希望あり！","基礎ができてる！",
        "視線移動が上達！","指が温まってきた！","良い経験値になった！","積み重ねが効くよ！","もう一歩！",
        "慣れれば一気に伸びる！","タップが素直！","練習の成果が出てる！","落ち着きが大事！","焦点の合わせ方が良い！",
        "次回が楽しみ！","成功体験を増やそう！","ペース配分を意識！","リズム作りに挑戦！","良い試行錯誤！",
        "着眼点が良い！","安定化を目指そう！","タイミング練度アップ中！","視野が広がってる！","手応えが出てきた！",
        "流れに乗れた瞬間あり！","ミスを恐れず続けよう！","次の10秒を大事に！","良い反省と収穫！","確実に成長！",
        "基本が固まってきた！","集中の入りが良くなる！","呼吸を整えると◎！","次はAが見える！","諦めない姿勢が素敵！",
        "経験値が貯まってる！","継続は力なり！","着実な伸び！","ナイストライ！","いい練習になった！" ],
    C:[ "ここから始めよう！","まずは落ち着いて！","指慣らしをしていこう！","大丈夫、次は良くなる！","ゆっくりでOK！",
        "焦らないで一つずつ！","タップ感覚を掴もう！","短時間の練習を重ねよう！","目を慣らそう！","手の準備運動を！",
        "最初は誰でもここから！","続ければ必ず伸びる！","狙いを絞ってみよう！","リズムを感じていこう！","失敗は成功の種！",
        "簡単な流れから！","テンポを一定に！","視線の移動を短く！","手元を温めて再挑戦！","次は一歩前進！",
        "深呼吸してから！","10秒を区切りに頑張ろう！","狙いは中央から！","視界をクリアに！","まずはヒット回数を増やそう！",
        "タイミングに集中！","音を目安に！","慣れると楽しくなるよ！","今日は肩慣らし！","次に期待！",
        "良いリセットだった！","無理しなくてOK！","少しずつ正確に！","手応えはこれから！","視線の動きに慣れよう！",
        "短い練習を何度も！","迷ったら見送りでOK！","整えて再スタート！","まずは成功体験を！","気持ちを軽く！",
        "タップを丁寧に！","焦点を1点に！","次はもう少し粘ろう！","少しずつ上げていこう！","一緒に成長しよう！",
        "気負わずいこう！","前を向いてOK！","最初の一歩は合格！","続けることが勝ち！","ここから巻き返そう！" ]
  };

  function getRank(score){
    for(const r of RANK_THRESH){ if(score>=r.min) return r.rank; }
    return 'C';
  }
  function speakFinishByRank(rank, score){
    const list = RANK_COMMENTS[rank] || ["おつかれさま！よくがんばったね！"];
    const msg = list[Math.floor(Math.random()*list.length)];
    speakTextJa(`ランク${rank}。スコアは${score}。${msg}`);
  }

  /* ===== 進行管理 ===== */
  function reset(){
    cancelTTS();
    state.running=false; state.paused=false; state.lastT=0;
    state.timeLeft = TOTAL_TIME;
    state.score = 0; state.hits = 0;
    state.objs.length=0; world.innerHTML='';
    state.levelSeg = 0;

    const m = modeSelect.value;
    state.mode = m;
    if(m==='kids'){
      state.baseSpeedMin = 100; state.baseSpeedMax = 150;
      state.baseSpawnMin = 900; state.baseSpawnMax = 1500;
      state.obstacleRatio = 0.0;
      state.friendlyRatio = 0.16;
    }else{
      state.baseSpeedMin = 150; state.baseSpeedMax = 260;
      state.baseSpawnMin = 520; state.baseSpawnMax = 900;
      state.obstacleRatio = 0.25;
      state.friendlyRatio = 0.12;
    }
    state.spawnCd = 0;

    overlay.classList.remove('show');
    applyDayTheme();
    updateHUD();
  }

  function start(){
    if(state.running) return;
    state.running = true;
    state.paused = false;
    state.lastT = performance.now();
    ensureAudio();
    state.spawnCd = 0;
    spawn();                 // 即時出現
    showToast('Start!');
    updateHUD();
    requestAnimationFrame(loop);
  }

  function pause(){
    state.paused=!state.paused;
    btnPause.textContent=state.paused?'▶ 再開':'⏸ 一時停止';
    if(!state.paused){ state.lastT=performance.now(); requestAnimationFrame(loop); }
  }

  function endGame(){
    state.running=false;
    finalScoreEl.textContent=state.score;
    finalHitsEl.textContent=state.hits;
    const rank = getRank(state.score);
    finalRankEl.textContent = rank;
    overlay.classList.add('show');
    confettiBurst(180);
    speakFinishByRank(rank, state.score);
  }

  function loop(t){
    if(!state.running) return;
    if(state.paused){ requestAnimationFrame(loop); return; }
    const dtMs = state.lastT? Math.min(60, t - state.lastT) : 16; state.lastT = t;
    const dt = dtMs/1000;

    // 時間
    state.timeLeft = Math.max(0, state.timeLeft - dt);
    if(state.timeLeft<=0){ updateHUD(); endGame(); return; }

    // ★ レベルセグメント計算（10秒ごと）＆レベルアップ演出
    const seg = getLevelSeg();
    if(seg > state.levelSeg){           // 新しい区間に入った
      state.levelSeg = seg;
      if(seg > 0){ showToast('レベルアップ！！'); playSnd('level'); }
    }

    // 現在の速度＆出現間隔（10秒ごとに段階加速）
    const [vmin, vmax] = currentSpeedRange(seg);
    const speedNow = rand(vmin, vmax);
    state.spawnCd -= dtMs;
    if(state.spawnCd<=0){
      spawn();
      const [imin, imax] = currentSpawnRange(seg);
      state.spawnCd = rand(imin*0.7, imax*1.3);
    }

    // 落下＆掃除
    for(const o of state.objs){
      if(o._gone) continue;
      o.y += speedNow*dt;
      place(o);
    }
    state.objs = state.objs.filter(o=>{
      if(o._gone) return false;
      if(o.y > board.clientHeight + 60){ o.el.remove(); return false; }
      return true;
    });

    updateHUD();
    requestAnimationFrame(loop);
  }

  /* ===== 操作 ===== */
  function unlockAudioOnce(){ ensureAudio(); world.removeEventListener('pointerdown', unlockAudioOnce); }
  world.addEventListener('pointerdown', unlockAudioOnce);

  btnStart.addEventListener('click', ()=>{ reset(); start(); });
  btnPause.addEventListener('click', ()=> pause());
  btnRestart.addEventListener('click', ()=>{ reset(); start(); });
  btnAgain && btnAgain.addEventListener('click', ()=>{ reset(); start(); });
  modeSelect.addEventListener('change', ()=>{ reset(); });

  // 初期化
  reset();
})();
</script>
</body>
</html>

