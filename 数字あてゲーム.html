<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>数字をあてろ！</title>
<meta name="theme-color" content="#2b8a3e">
<style>
:root{
  --bg:#f0f7ff; --card:#ffffff; --line:#d7e6ff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b8a3e; --accent-2:#18753a; --warn:#ef4444; --ok:#16a34a; --gold:#f5c542;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#fff 0%,#f7fbff 100%);border-bottom:1px solid var(--line)}
header .bar{max-width:880px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.badge{font-size:12px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:10px;padding:8px 10px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:transparent}
button.ghost{background:#fff}
#gameWrap{max-width:880px;margin:10px auto;padding:10px}

/* スマホで収まるよう縦を控えめに（svhでアドレスバー考慮） */
.board{
  position:relative;margin:0 auto;background:linear-gradient(180deg,#cfe8ff 0%,#bfe0ff 50%,#dff4ff 100%);
  border-radius:18px;border:1px solid var(--line);box-shadow:0 6px 16px rgba(0,0,0,.06);
  overflow:hidden;touch-action:manipulation;height:64svh;min-height:400px;max-height:640px
}
@media (max-width:480px){ .board{height:66svh;min-height:380px} }

.hud{position:absolute;left:0;top:0;right:0;display:flex;justify-content:space-between;gap:8px;padding:8px 10px;font-weight:700;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.6));backdrop-filter:blur(2px);z-index:3}
.hud .pill{background:#fff;border:1px solid var(--line);padding:4px 10px;border-radius:999px}
.world{position:absolute;inset:0}

/* 数字：コイン風（数字サイズはJSで可変：0大→9小） */
.digit{
  position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#1f2937;border-radius:999px;border:2px solid #d4a025;
  background:radial-gradient(circle at 30% 30%, #fff8d6, #f9d879 45%, #e6b83d 60%, #c9972e 100%);
  box-shadow:0 4px 10px rgba(0,0,0,.18); padding:8px
}
.digit .num{line-height:1}

/* 障害物 */
.obj{position:absolute;transform:translate(-50%,-50%);font-size:32px;line-height:1;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2))}

/* トースト/オーバーレイ/紙吹雪 */
.toast{position:absolute;left:50%;top:18%;transform:translate(-50%,0);background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;box-shadow:0 10px 20px rgba(0,0,0,.1);display:none;z-index:7}
.toast.show{display:block}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:20px;z-index:6}
.overlay.show{display:flex}
.overlay .card{background:#ffffff; color:var(--text); border-radius:16px; padding:14px 16px; border:1px solid var(--line); min-width:260px}
.confetti{position:absolute;width:8px;height:12px;border-radius:2px;opacity:.95;pointer-events:none;z-index:8}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">🔢 数字をあてろ！ <span class="badge">v1.1</span></div>
      <div class="controls">
        <label>モード
          <select id="modeSelect" title="モード選択">
            <option value="kids" selected>やさしい（幼児向けタップ）</option>
            <option value="normal">ふつう（障害物あり）</option>
          </select>
        </label>
        <button id="btnStart" class="primary">▶ はじめる</button>
        <button id="btnPause" class="ghost">⏸ 一時停止</button>
        <button id="btnRestart" class="ghost">↻ リスタート</button>
      </div>
    </div>
  </header>

  <div id="gameWrap">
    <div id="board" class="board" role="application" aria-label="数字をあてろ！ ゲームエリア">
      <div class="hud">
        <div class="pill">スコア <span id="sc">0</span></div>
        <div class="pill">ヒット <span id="hits">0</span></div>
        <div class="pill">タイマー <span id="time">60.0</span>s</div>
      </div>
      <div id="world" class="world" aria-hidden="true"></div>
      <div id="toast" class="toast">+1</div>
      <div id="overlay" class="overlay" aria-live="polite">
        <div class="card">
          <h3 style="margin:6px 0 10px">タイムアップ！</h3>
        <p style="margin:0 0 10px">スコア：<b id="finalScore">0</b><br>ヒット数：<b id="finalHits">0</b></p>
          <button id="btnAgain" class="primary">もう一度</button>
        </div>
      </div>
    </div>
    <p style="opacity:.7;margin:10px 4px 0">操作：落ちてくる<strong>数字をタップ</strong>（やさしい：数字のみ／ふつう：障害物はタップで-5）</p>
  </div>

<script>
(() => {
  const board = document.getElementById('board');
  const world = document.getElementById('world');
  const overlay = document.getElementById('overlay');
  const finalScoreEl = document.getElementById('finalScore');
  const finalHitsEl = document.getElementById('finalHits');
  const scEl = document.getElementById('sc');
  const timeEl = document.getElementById('time');
  const hitsEl = document.getElementById('hits');
  const toast = document.getElementById('toast');
  const modeSelect = document.getElementById('modeSelect');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');
  const btnAgain = document.getElementById('btnAgain');

  const EMOJI = { cone:'🚧', rock:'🪨', box:'📦', tree:'🌳' };
  const DIGIT_JA = ['ゼロ','いち','に','さん','よん','ご','ろく','なな','はち','きゅう'];

  const TOTAL_TIME = 60.0;

  const state = {
    running:false, paused:false,
    lastT:0,
    timeLeft:TOTAL_TIME,
    mode:'kids',
    score:0, hits:0,
    objs:[],
    // スピード＆出現（モードで変える）: px/s と ms
    speedMin:90, speedMax:130,           // kidsデフォ
    spawnMin:900, spawnMax:1600,         // kidsデフォ（間隔大＝ゆっくり）
    spawnCd:0,
    obstacleRatio:0.0                    // kidsは0、normalは0.25前後
  };

  function reset(){
    cancelTTS(); // 読み上げ停止
    state.running=false; state.paused=false; state.lastT=0;
    state.timeLeft = TOTAL_TIME;
    state.score = 0; state.hits = 0;
    state.objs.length=0; world.innerHTML='';

    const m = modeSelect.value;
    state.mode = m;
    if(m==='kids'){
      state.speedMin = 90; state.speedMax = 130;
      state.spawnMin = 900; state.spawnMax = 1600;
      state.obstacleRatio = 0.0; // 障害物なし
    }else{
      state.speedMin = 140; state.speedMax = 260;
      state.spawnMin = 500; state.spawnMax = 900;
      state.obstacleRatio = 0.25; // 25%程度
    }
    state.spawnCd = 0;

    overlay.classList.remove('show');
    updateHUD();
  }

  function start(){
    if(state.running) return;
    state.running = true;
    state.paused = false;
    state.lastT = performance.now();
    ensureAudio();             // ボタン操作でのAudio解放を試みる（iOSは別途タップも必要）
    state.spawnCd = 0;
    spawn(0);                  // 進行度0で即スポーン
    showToast('Start!');
    updateHUD();
    requestAnimationFrame(loop);
  }

  function pause(){
    state.paused=!state.paused;
    btnPause.textContent=state.paused?'▶ 再開':'⏸ 一時停止';
    if(!state.paused){ state.lastT=performance.now(); requestAnimationFrame(loop); }
  }

  function updateHUD(){ scEl.textContent=state.score; hitsEl.textContent=state.hits; timeEl.textContent=state.timeLeft.toFixed(1); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

  // 「ゼロが大きく、9が小さい」
  function digitFontSize(d){
    // 0→64px … 9→37px（不自然にならない範囲）
    return 64 - d*3;
  }

  function place(o){ const w = board.clientWidth; o.el.style.left = (o.xRatio*w) + 'px'; o.el.style.top = o.y + 'px'; }

  // 出現（数字メイン、normalのみ障害物混在）
  function spawn(progress){ // progress: 0.0 → 1.0
    const isObstacle = (state.mode==='normal') && (Math.random() < state.obstacleRatio);
    const xRatio = 0.06 + Math.random()*0.88; // 左右6%マージン
    if(!isObstacle){
      const digit = Math.floor(Math.random()*10);
      const el = document.createElement('div');
      el.className='digit'; el.dataset.type='digit'; el.dataset.digit=String(digit);
      const num = document.createElement('div');
      num.className='num';
      num.textContent = String(digit);
      num.style.fontSize = digitFontSize(digit) + 'px'; // 0最大→9最小
      el.appendChild(num);
      world.appendChild(el);
      const o = { el, type:'digit', digit, xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
    }else{
      const p = Math.random();
      const type = p<0.4 ? 'cone' : (p<0.7? 'box' : (p<0.88?'rock':'tree'));
      const el = document.createElement('div');
      el.className='obj'; el.dataset.type='obstacle'; el.textContent = (type==='cone'? EMOJI.cone : type==='box'? EMOJI.box : type==='rock'? EMOJI.rock : EMOJI.tree);
      world.appendChild(el);
      const o = { el, type:'obstacle', xRatio, y:-30, _hit:false, _gone:false };
      place(o); attachTap(o); state.objs.push(o);
    }
  }

  /* ==== Audio（外部ファイル不要の簡易SE） ==== */
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    return !!audioCtx;
  }
  function beep({type='sine', f1=900, f2=1400, dur=0.12, gain=0.05}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type=type;
    o.frequency.setValueAtTime(f1, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+dur*0.7);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }
  function thud({f=140, dur=0.22, gain=0.085}={}){
    if(!ensureAudio()) return;
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const n = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; n.type='triangle';
    o.frequency.setValueAtTime(f, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+dur);
    n.frequency.setValueAtTime(f*0.5, ctx.currentTime);
    n.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+dur);
    g.gain.value=gain;
    g.gain.setValueAtTime(gain, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); n.connect(g); g.connect(ctx.destination);
    o.start(); n.start(); o.stop(ctx.currentTime+dur); n.stop(ctx.currentTime+dur);
  }
  function playSnd(kind){
    if(kind==='ok'){
      beep({type:'sine',f1:1000,f2:1600,dur:0.11,gain:0.05});
      setTimeout(()=>beep({type:'triangle',f1:800,f2:1400,dur:0.10,gain:0.045}),60);
    }else if(kind==='bad'){
      thud();
    }else if(kind==='confetti'){
      beep({type:'square', f1:900, f2:1100, dur:0.08, gain:0.035});
    }
  }

  /* ==== 紙吹雪（ゴール時） ==== */
  function rand(a,b){ return a + Math.random()*(b-a); }
  function confettiBurst(count=180){
    const rect = board.getBoundingClientRect();
    for(let i=0;i<count;i++){
      const s = document.createElement('div');
      s.className='confetti';
      const x = rand(0, rect.width);
      const y = rand(-20, 20);
      s.style.left = x + 'px';
      s.style.top  = y + 'px';
      const colors = ['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#1abc9c'];
      s.style.background = colors[Math.floor(Math.random()*colors.length)];
      s.style.transform = `rotate(${Math.floor(rand(-30,30))}deg)`;
      board.appendChild(s);
      const dy = rect.height + rand(80,160);
      const dx = rand(-80,80);
      const rot = rand(180, 720);
      s.animate([
        {transform:`translate(0,0) rotate(0deg)`, opacity:1},
        {transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0.9}
      ], {duration: rand(1200, 2200), easing:'cubic-bezier(.2,.6,.2,1)'}).onfinish = ()=> s.remove();
    }
    playSnd('confetti');
  }

  /* ==== TTS：常に最新タップのみ読み上げ ==== */
  let TTS_SEQ = 0;
  function cancelTTS(){
    try{ speechSynthesis.cancel(); }catch(e){}
  }
  function speakDigit(d){
    try{
      TTS_SEQ++;
      const seq = TTS_SEQ;
      cancelTTS(); // 先行読み上げを即キャンセル
      const u = new SpeechSynthesisUtterance(DIGIT_JA[d] || String(d));
      u.lang = 'ja-JP';
      u.rate = 1.0;
      // 直前cancelの反映を待ってから発声（Safari対策）
      setTimeout(()=>{
        if(seq !== TTS_SEQ) return; // さらに新しい入力が来ていたら無視
        try{ speechSynthesis.speak(u); }catch(e){}
      }, 0);
    }catch(e){}
  }

  /* ==== タップ処理を要素に付与 ==== */
  function attachTap(o){
    o.el.style.cursor='pointer';
    o.el.addEventListener('pointerdown',(e)=>{
      // 新しい入力が来たら、進行中の読み上げはキャンセル
      cancelTTS();

      if(o._hit) return;
      o._hit = true;
      if(o.type==='digit'){
        state.score += o.digit;
        state.hits++;
        showToast('+'+o.digit);
        speakDigit(o.digit);   // 常に最新だけ読む
        playSnd('ok');
      }else if(o.type==='obstacle' && state.mode==='normal'){
        state.score = Math.max(0, state.score - 5);
        showToast('-5');
        playSnd('bad');
      }
      o._gone = true;
      o.el.animate(
        [{transform:'translate(-50%,-50%) scale(1)',opacity:1},
         {transform:'translate(-50%,-60%) scale(1.15)',opacity:0}],
        {duration:220,easing:'ease-out'}
      ).onfinish=()=>o.el.remove();
      updateHUD();
    });
  }

  /* ==== UI/演出 ==== */
  function showToast(text='+1'){
    toast.textContent=text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 450);
  }

  /* ==== ゲームループ ==== */
  function endGame(){
    state.running=false;
    finalScoreEl.textContent=state.score;
    finalHitsEl.textContent=state.hits;
    overlay.classList.add('show');
    confettiBurst(180);
  }

  function loop(t){
    if(!state.running) return;
    if(state.paused){ requestAnimationFrame(loop); return; }
    const dtMs = state.lastT? Math.min(60, t - state.lastT) : 16; state.lastT = t;
    const dt = dtMs/1000;

    // 時間と進行度
    state.timeLeft = Math.max(0, state.timeLeft - dt);
    const progress = 1 - (state.timeLeft / TOTAL_TIME); // 0→1
    if(state.timeLeft<=0){ updateHUD(); endGame(); return; }

    // 落下速度（時間と共に加速）
    const speedNow = lerp(state.speedMin, state.speedMax, easeOutCubic(progress));

    // 出現間隔（時間と共に短く）
    state.spawnCd -= dtMs;
    if(state.spawnCd<=0){
      spawn(progress);
      const intervalNow = lerp(state.spawnMax, state.spawnMin, easeOutCubic(progress));
      state.spawnCd = rand(intervalNow*0.7, intervalNow*1.3);
    }

    // 落下＆掃除
    for(const o of state.objs){
      if(o._gone) continue;
      o.y += speedNow*dt;
      place(o);
    }
    state.objs = state.objs.filter(o=>{
      if(o._gone) return false;
      if(o.y > board.clientHeight + 60){ o.el.remove(); return false; }
      return true;
    });

    updateHUD();
    requestAnimationFrame(loop);
  }

  /* ==== ボタン/操作 ==== */
  // 初回タップでAudio解放（モバイル対策：世界領域のタップでも解放）
  function unlockAudioOnce(){ ensureAudio(); world.removeEventListener('pointerdown', unlockAudioOnce); }
  world.addEventListener('pointerdown', unlockAudioOnce);

  btnStart.addEventListener('click', ()=>{ reset(); start(); });
  btnPause.addEventListener('click', ()=> pause());
  btnRestart.addEventListener('click', ()=>{ reset(); start(); });
  btnAgain && btnAgain.addEventListener('click', ()=>{ reset(); start(); });
  modeSelect.addEventListener('change', ()=>{ reset(); });

  // 初期化
  reset();
})();
</script>
</body>
</html>


