<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CORPORATE QUEST â€” Real Company Battle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- canvas-confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1223;
      --panel:#0C152B;
      --line:#1E2B4F;
      --neon:#35F7FF;
      --neon2:#A78BFA;
      --warn:#FBBF24;
      --good:#34D399;
      --bad:#FB7185;
      --text:#D6E2FF;
      --muted:#93A4C8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%; background: radial-gradient(1200px 600px at 20% 10%, rgba(53,247,255,.08), transparent 55%),
                                 radial-gradient(900px 500px at 70% 20%, rgba(167,139,250,.10), transparent 60%),
                                 linear-gradient(180deg,var(--bg0),var(--bg1));
              color:var(--text);}
    .safe-pad{padding-bottom: max(16px, env(safe-area-inset-bottom)); padding-top: max(16px, env(safe-area-inset-top));}
    .panel{
      background: linear-gradient(180deg, rgba(12,21,43,.88), rgba(7,10,18,.72));
      border:1px solid rgba(53,247,255,.16);
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 24px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .panel2{
      background: linear-gradient(180deg, rgba(12,21,43,.80), rgba(11,18,35,.50));
      border:1px solid rgba(148,163,184,.18);
    }
    .scanline{
      position:absolute; inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.02) 0px,
        rgba(255,255,255,.02) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      mix-blend-mode: overlay;
      opacity:.35;
      border-radius: 18px;
    }
    .neon-border{
      border:1px solid rgba(53,247,255,.25);
      box-shadow: 0 0 0 1px rgba(53,247,255,.14), 0 0 24px rgba(53,247,255,.10);
    }
    .chip{
      font-family: var(--mono);
      letter-spacing:.02em;
      border:1px solid rgba(53,247,255,.22);
      background: rgba(53,247,255,.06);
      color: #CFFBFF;
    }
    .mono{font-family: var(--mono);}
    .ticker{
      position: relative;
      overflow:hidden;
      border-top:1px solid rgba(148,163,184,.12);
      border-bottom:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.55);
    }
    .ticker .track{
      display:flex; gap:32px;
      white-space:nowrap;
      will-change: transform;
      animation: scroll 22s linear infinite;
      padding: 10px 0;
      font-family: var(--mono);
      color: rgba(214,226,255,.85);
      text-shadow: 0 0 12px rgba(53,247,255,.12);
    }
    @keyframes scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .btn{
      border:1px solid rgba(53,247,255,.22);
      background: linear-gradient(180deg, rgba(53,247,255,.12), rgba(53,247,255,.04));
      box-shadow: 0 0 0 1px rgba(167,139,250,.10);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn:hover{filter: brightness(1.15); border-color: rgba(53,247,255,.40);}
    .btn:active{transform: translateY(1px) scale(.99);}

    .btn2{
      border:1px solid rgba(167,139,250,.26);
      background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.05));
      box-shadow: 0 0 0 1px rgba(53,247,255,.08);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn2:hover{filter: brightness(1.15); border-color: rgba(167,139,250,.42);}
    .btn2:active{transform: translateY(1px) scale(.99);}

    .btnDanger{
      border:1px solid rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.05));
    }

    .glowText{
      text-shadow: 0 0 18px rgba(53,247,255,.22), 0 0 32px rgba(167,139,250,.12);
    }

    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.18);
      overflow:hidden;
      position: relative;
    }
    .bar > .fill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(53,247,255,.95), rgba(167,139,250,.92));
      box-shadow: 0 0 20px rgba(53,247,255,.16);
      transition: width .45s cubic-bezier(.2,.9,.2,1);
    }
    .bar > .fill.hp{
      background: linear-gradient(90deg, rgba(52,211,153,.95), rgba(53,247,255,.80));
    }
    .bar > .fill.danger{
      background: linear-gradient(90deg, rgba(251,113,133,.95), rgba(245,158,11,.65));
    }

    .shake{ animation: shake .35s ease-in-out; }
    @keyframes shake{
      0%{transform: translate(0,0);}
      20%{transform: translate(-6px,2px);}
      40%{transform: translate(6px,-2px);}
      60%{transform: translate(-4px,-2px);}
      80%{transform: translate(4px,2px);}
      100%{transform: translate(0,0);}
    }

    .flash{
      position: relative;
    }
    .flash::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 18px;
      background: radial-gradient(700px 300px at 30% 20%, rgba(53,247,255,.28), transparent 60%),
                  radial-gradient(500px 300px at 70% 50%, rgba(167,139,250,.20), transparent 65%);
      opacity: 0;
      pointer-events:none;
      animation: flash .55s ease-out;
    }
    @keyframes flash{
      0%{opacity:.9;}
      100%{opacity:0;}
    }

    .crit{
      animation: pop .38s ease-out;
    }
    @keyframes pop{
      0%{transform: scale(.92); opacity:.75;}
      60%{transform: scale(1.04); opacity:1;}
      100%{transform: scale(1); opacity:1;}
    }

    .floatDmg{
      position:absolute;
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing:.02em;
      text-shadow: 0 0 18px rgba(53,247,255,.18);
      animation: floatUp .95s ease-out forwards;
      pointer-events:none;
      user-select:none;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) scale(.98); opacity: 0; }
      15%{ opacity: 1; }
      100%{ transform: translateY(-38px) scale(1.02); opacity: 0; }
    }

    .logoWrap{
      width: 96px; height: 96px;
      border-radius: 18px;
      border:1px solid rgba(53,247,255,.22);
      background: radial-gradient(220px 160px at 30% 20%, rgba(53,247,255,.12), transparent 55%),
                  radial-gradient(220px 160px at 70% 60%, rgba(167,139,250,.12), transparent 60%),
                  rgba(2,6,23,.65);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 18px 60px rgba(0,0,0,.35);
      position: relative;
    }
    .logoWrap img{width: 82%; height: 82%; object-fit: contain; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));}
    .logoFallback{
      width: 80px; height: 80px; border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      font-weight: 800;
      font-size: 30px;
      letter-spacing: .02em;
      color: rgba(207,251,255,.95);
      background: linear-gradient(180deg, rgba(53,247,255,.14), rgba(167,139,250,.10));
      border:1px solid rgba(53,247,255,.18);
      text-shadow: 0 0 18px rgba(53,247,255,.24);
    }

    .kbd{
      font-family: var(--mono);
      border:1px solid rgba(148,163,184,.22);
      background: rgba(148,163,184,.08);
      padding:.15rem .35rem;
      border-radius: .5rem;
      color: rgba(214,226,255,.92);
      font-size: 12px;
    }

    .tag{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(148,163,184,.06);
      color: rgba(214,226,255,.86);
      font-family: var(--mono);
      font-size: 12px;
      padding: .15rem .45rem;
      border-radius: 999px;
    }

    textarea{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(53,247,255,.35);
      box-shadow: 0 0 0 3px rgba(53,247,255,.08);
    }
    select,input{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
    Â  Â  select:focus,input:focus{
Â  Â  Â  border-color: rgba(53,247,255,.35);
Â  Â  Â  box-shadow: 0 0 0 3px rgba(53,247,255,.08);
Â  Â  }

Â  Â  .quake { animation: quake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
Â  Â  @keyframes quake {
Â  Â  Â  10%, 90% { transform: translate3d(-3px, 0, 0) rotate(1deg); }
Â  Â  Â  20%, 80% { transform: translate3d(5px, 0, 0) rotate(-1deg); }
Â  Â  Â  30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotate(2deg); }
Â  Â  Â  40%, 60% { transform: translate3d(8px, 0, 0) rotate(-2deg); }
Â  Â  }
Â  Â  .glitch-anim { animation: glitch-skew 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; }
Â  Â  @keyframes glitch-skew {
Â  Â  Â  0% { transform: skew(0deg); }
Â  Â  Â  20% { transform: skew(-2deg); }
Â  Â  Â  40% { transform: skew(2deg); }
Â  Â  Â  60% { transform: skew(-1deg); }
Â  Â  Â  80% { transform: skew(1deg); }
Â  Â  Â  100% { transform: skew(0deg); }
Â  Â  }

    .hidden{display:none;}

            /* --- POKEMON-STYLE BATTLE CSS --- */
    .battle-stage {
      position: relative;
      height: 380px;
      background: linear-gradient(180deg, #0f172a 0%, #020617 60%);
      perspective: 600px;
      overflow: hidden;
    }
    /* 3D Grid Floor Effect - Enhanced Visibility */
    .battle-stage::after {
      content:""; position:absolute; inset:-100%; top:35%;
      background:
        linear-gradient(180deg, rgba(2,6,23,0) 0%, rgba(2,6,23,1) 80%),
        repeating-linear-gradient(90deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px),
        repeating-linear-gradient(0deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px);
      transform: rotateX(75deg);
      z-index: 2;
      pointer-events: none;
      mask-image: linear-gradient(to bottom, transparent 0%, black 20%);
    }
    /* City Scape */
    .city-wrap {
      position: absolute; top: 0; left: 0; right: 0; height: 100%;
      pointer-events: none; z-index: 1;
      transform-style: preserve-3d;
    }
    .building {
      position: absolute; bottom: 35%; /* align with grid horizon */
      background: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(2,6,23,1) 100%);
      border-top: 1px solid rgba(53,247,255,0.3);
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
      transform-origin: bottom center;
    }
    .building::after {
      content:""; position:absolute; inset:0;
      background-image: radial-gradient(rgba(167,139,250,0.3) 1px, transparent 1px);
      background-size: 4px 6px;
      opacity: 0.6;
    }
    /* Ground Effects */
    .stage-ground-p {
      position: absolute; bottom: -30px; left: -10%; width: 320px; height: 100px;
      background: rgba(53,247,255,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(53,247,255,0.1); box-shadow: 0 0 30px rgba(53,247,255,0.05);
    }
    .stage-ground-c {
      position: absolute; top: 40px; right: -5%; width: 280px; height: 90px;
      background: rgba(167,139,250,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(167,139,250,0.1); box-shadow: 0 0 30px rgba(167,139,250,0.05);
    }
        /* Sprites - Centered */
    .sprite-wrap {
      position: absolute;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      filter: drop-shadow(0 24px 48px rgba(0,0,0,0.7));
      z-index: 10;
    }
    /* Move inward (30%) to avoid overlap with HUD and reduce emptiness */
    .pos-p { bottom: 60px; left: 30%; }
    .pos-c { top: 70px; right: 30%; z-index: 5; }
    
    /* HUDs - Corner Anchor */
    .hud-wrap {
      position: absolute; width: 260px; padding: 12px 16px;
      background: rgba(15,23,42,0.85); border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px; backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      pointer-events: none; /* click through */
      z-index: 30;
    }
    /* Player HUD: Left Bottom corner */
    .hud-p { bottom: 16px; left: 16px; border-left: 4px solid #35F7FF; transform: translateZ(20px); }
    /* CPU HUD: Right Top corner */
    .hud-c { top: 16px; right: 16px; border-right: 4px solid #A78BFA; transform: scale(0.95); opacity: 0.95; }

    /* Center Effect */
    .center-ring {
      position: absolute; top: 60%; left: 50%; width: 400px; height: 400px;
      transform: translate(-50%, -50%) rotateX(60deg);
      border: 2px dashed rgba(53,247,255,0.12);
      border-radius: 50%;
      animation: spin-slow 30s linear infinite;
      z-index: 2;
      pointer-events: none;
    }
    .center-ring::after {
      content:""; position:absolute; inset:40px; border: 1px solid rgba(167,139,250,0.15); border-radius: 50%;
    }

        /* Shadows - Aligned with Sprites */
    .shadow-marker {
      position: absolute; width: 100px; height: 24px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.7) 0%, transparent 70%);
      border-radius: 50%; z-index: 3;
      animation: shadow-scale 4s ease-in-out infinite;
    }
    /* Aligned with new sprite positions (30%) */
    .sh-p { bottom: 60px; left: 30%; margin-left: 10px; }
    .sh-c { top: 150px; right: 30%; margin-right: 10px; }

    /* Animations */
    @keyframes spin-slow { 0%{transform:translate(-50%, -50%) rotateX(60deg) rotate(0deg);} 100%{transform:translate(-50%, -50%) rotateX(60deg) rotate(360deg);} }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-14px);} }
    @keyframes shadow-scale { 0%,100%{transform:scale(1); opacity:0.6;} 50%{transform:scale(0.8); opacity:0.4;} }

        /* Direction Variables for Sprites (P: LeftBottom->RightTop, C: RightTop->LeftBottom) */
    .pos-p { --tx: 1; --ty: -1; }
    .pos-c { --tx: -1; --ty: 1; }

    /* Standard Attack */
    @keyframes lunge { 
      0%{transform:translate(0,0) scale(1);} 
      40%{transform:translate(calc(80px*var(--tx)), calc(80px*var(--ty))) scale(1.15);} 
      100%{transform:translate(0,0) scale(1);} 
    }
    .atk-anim { animation: lunge 0.5s ease-in-out !important; }

    /* --- 20 UNIQUE SKILL MOTIONS --- */
    .skill-anim { animation-duration: 1.8s !important; animation-timing-function: ease-in-out !important; z-index: 100; }

    /* 1. Smash: Power charge and heavy hit */
    @keyframes m-smash { 0%{transform:scale(1)} 30%{transform:translate(calc(-30px*var(--tx)),calc(-30px*var(--ty))) scale(0.8); filter:brightness(2) drop-shadow(0 0 20px white)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.6)} 100%{transform:scale(1)} }
    /* 2. Rush: Vibration and rapid dash */
    @keyframes m-rush { 0%{transform:scale(1)} 20%{transform:translate(calc(-10px*var(--tx)),0) skew(10deg)} 40%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty))) scale(1.1)} 45%{transform:translate(0,0)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 3. Sonic: Disappear and strike */
    @keyframes m-sonic { 0%{transform:scale(1); opacity:1} 30%{transform:scale(0.1); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5); opacity:1; filter:contrast(2)} 100%{transform:scale(1)} }
    /* 4. Snipe: Stationary charge and recoil */
    @keyframes m-snipe { 0%{transform:scale(1)} 40%{transform:scale(0.9); filter:brightness(3)} 45%{transform:translate(calc(-40px*var(--tx)),calc(-40px*var(--ty))) scale(1); filter:hue-rotate(90deg)} 100%{transform:scale(1)} }
    /* 5. Drill: Spin attack */
    @keyframes m-drill { 0%{transform:rotate(0)} 30%{transform:rotate(360deg) scale(0.5)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) rotate(1080deg) scale(1.3)} 100%{transform:rotate(0)} }
    /* 6. Jump: High arch */
    @keyframes m-jump { 0%{transform:scale(1)} 30%{transform:translateY(-150px) scale(1.2)} 60%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }
    /* 7. Zigzag */
    @keyframes m-zigzag { 0%{transform:translate(0,0)} 20%{transform:translate(calc(40px*var(--tx)),calc(-40px*var(--ty)))} 40%{transform:translate(calc(80px*var(--tx)),calc(40px*var(--ty)))} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.3)} 100%{transform:translate(0,0)} }
    /* 8. Tackle: Simple heavy charge */
    @keyframes m-tackle { 0%{transform:scale(1)} 25%{transform:rotate(calc(-15deg*var(--tx)))} 50%{transform:translate(calc(190px*var(--tx)),calc(190px*var(--ty))) scale(1.4)} 100%{transform:scale(1)} }
    /* 9. Uppercut */
    @keyframes m-uppercut { 0%{transform:translate(0,0)} 30%{transform:translate(0, 50px) scale(0.8)} 50%{transform:translate(calc(150px*var(--tx)), -150px) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 10. Meteor: From sky */
    @keyframes m-meteor { 0%{transform:translate(0,0)} 20%{transform:translateY(-200px) scale(0.5); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.6); opacity:1} 100%{transform:translate(0,0)} }
    /* 11. Shadow: Vibration blur */
    @keyframes m-shadow { 0%{transform:scale(1)} 30%{transform:translate(calc(10px*var(--tx)),0); filter:blur(4px)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.2); filter:blur(0)} 100%{transform:scale(1)} }
    /* 12. Giant: Giant growth */
    @keyframes m-giant { 0%{transform:scale(1)} 40%{transform:scale(2.2); filter:brightness(1.5); z-index:100} 60%{transform:translate(calc(80px*var(--tx)),calc(80px*var(--ty))) scale(2.2)} 100%{transform:scale(1)} }
    /* 13. Helix: Spiral */
    @keyframes m-helix { 0%{transform:rotate(0)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(calc(360deg*var(--tx)))} 100%{transform:translate(0,0)} }
    /* 14. Impact: Slow start fast hit */
    @keyframes m-impact { 0%{transform:scale(1)} 50%{transform:translate(calc(50px*var(--tx)),calc(50px*var(--ty))) scale(1)} 55%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.8); filter:invert(1)} 100%{transform:scale(1)} }
    /* 15. Wobble */
    @keyframes m-wobble { 0%{transform:rotate(0)} 25%{transform:rotate(20deg)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(-20deg) scale(1.4)} 100%{transform:rotate(0)} }
    /* 16. Charge: Long wait */
    @keyframes m-charge { 0%{transform:scale(1)} 40%{transform:scale(0.6); filter:brightness(0.5)} 45%{transform:scale(1.2); filter:brightness(2)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 17. Boomerang */
    @keyframes m-boomerang { 0%{transform:rotate(0)} 40%{transform:translate(calc(100px*var(--tx)), -100px) rotate(180deg)} 60%{transform:translate(calc(200px*var(--tx)),calc(100px*var(--ty))) rotate(360deg)} 100%{transform:rotate(0)} }
    /* 18. Frenzy: Random shake */
    @keyframes m-frenzy { 0%{transform:translate(0,0)} 20%{transform:translate(20px, -20px)} 40%{transform:translate(-20px, 20px)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 19. Stealth: Fade out in */
    @keyframes m-stealth { 0%{opacity:1} 20%{opacity:0.2; transform:scale(0.8)} 50%{opacity:1; transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.3)} 100%{opacity:1} }
    /* 20. Pulse */
    @keyframes m-pulse { 0%{transform:scale(1)} 20%{transform:scale(1.4)} 40%{transform:scale(0.8)} 60%{transform:translate(calc(170px*var(--tx)),calc(170px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }

    .dmg-anim { animation: shake 0.45s ease-in-out; filter: brightness(2.5) hue-rotate(180deg) !important; }
    .guard-anim { filter: brightness(1.3) drop-shadow(0 0 15px rgba(53,247,255,0.6)) !important; transform: scale(0.95); }

        /* Battle Toast Log */
    .battle-toast-wrap {
      position: absolute; top: 10px; left: 0; right: 0;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      pointer-events: none; z-index: 50;
    }
    .battle-toast {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(53, 247, 255, 0.3);
      color: #e2e8f0;
      padding: 6px 12px;
      border-radius: 99px;
      font-family: var(--mono);
      font-size: 11px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      animation: toast-in 0.3s ease-out forwards;
      max-width: 90%; text-align: center;
    }
    @keyframes toast-in { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    @keyframes toast-out { to{opacity:0; transform:translateY(-10px);} }

    /* --- OPENING CAMERA WORK --- */
    @keyframes stage-intro {
      0% { transform: scale(1.6) rotateX(45deg) rotateY(180deg); opacity: 0; filter:blur(4px); }
      100% { transform: scale(1) rotateX(0) rotateY(0); opacity: 1; filter:blur(0); }
    }
    /* Counter-rotate sprites so they always face camera during spin */
    @keyframes sprite-counter {
      0% { transform: rotateY(-180deg); }
      100% { transform: rotateY(0); }
    }
    @keyframes hud-fade-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

        .intro-camera-mode { animation: stage-intro 2.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .intro-sprite-mode { animation: sprite-counter 2.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .intro-hud-wait { opacity: 0; animation: hud-fade-in 0.8s ease-out 2.0s forwards; }

    /* Title Screen Animations */
    @keyframes shine { 100% { transform: translateX(100%); } }
    .animate-shine { animation: shine 1s; }
    .cursor-blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  </style>
</head>
<body class="safe-pad">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Header -->
    <header class="flex items-center justify-between gap-3 py-3">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl neon-border flex items-center justify-center relative overflow-hidden"
             style="background: radial-gradient(180px 120px at 30% 20%, rgba(53,247,255,.16), transparent 60%),
                            radial-gradient(180px 120px at 70% 60%, rgba(167,139,250,.16), transparent 60%),
                            rgba(2,6,23,.65);">
          <div class="scanline" style="border-radius:16px;"></div>
          <span class="mono font-black text-lg glowText">CQ</span>
        </div>
        <div>
          <div class="text-xl sm:text-2xl font-black tracking-tight glowText">CORPORATE QUEST</div>
          <div class="text-xs sm:text-sm text-slate-300/80 mono">Real Company Battle</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnGoStart" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="home" class="w-4 h-4"></i><span class="mono">START</span>
        </button>
        <button id="btnGoLab" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="sparkles" class="w-4 h-4"></i><span class="mono">AI FORGE</span>
        </button>
        <button id="btnGoTournament" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="trophy" class="w-4 h-4"></i><span class="mono">TOURNAMENT</span>
        </button>
      </div>
    </header>

    <!-- Ticker -->
    <div class="ticker rounded-2xl panel2 overflow-hidden mb-4">
      <div class="track" id="tickerTrack"></div>
    </div>

    <!-- Main -->
        
    <main class="grid grid-cols-1 gap-4">

      
      <section id="screenTitle" class="panel rounded-2xl relative overflow-hidden flex flex-col items-center justify-center min-h-[420px] cursor-pointer group">
        <div class="scanline"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(53,247,255,0.08),transparent_70%)]"></div>
        
        <div class="z-10 text-center space-y-8 animate-[float_6s_ease-in-out_infinite]">
          <div class="relative inline-block">
             <div class="absolute -inset-6 bg-cyan-500/20 blur-2xl rounded-full animate-pulse"></div>
             <div class="w-24 h-24 mx-auto rounded-2xl neon-border flex items-center justify-center bg-slate-900/80 relative">
               <i data-lucide="building-2" class="w-12 h-12 text-cyan-300 drop-shadow-[0_0_15px_rgba(53,247,255,0.8)]"></i>
             </div>
          </div>
          
          <div>
            <h1 class="text-5xl sm:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-cyan-300 drop-shadow-[0_0_20px_rgba(53,247,255,0.4)]">
              CORPORATE<br/>QUEST
            </h1>
            <div class="mt-3 text-sm sm:text-base text-cyan-200/70 tracking-[0.3em] mono font-bold">REAL COMPANY BATTLE</div>
          </div>

          <div class="pt-8">
            <div class="inline-flex items-center gap-2 px-8 py-3 rounded-full border border-cyan-500/30 bg-cyan-500/5 backdrop-blur-sm group-hover:bg-cyan-500/10 transition-colors">
              <span class="mono text-lg font-bold text-cyan-100 group-hover:text-white transition-colors">
                &gt; CLICK TO START<span class="cursor-blink">_</span>
              </span>
            </div>
          </div>
        </div>
        
        <div class="absolute bottom-4 text-[10px] text-slate-500/60 mono">
           POWERED BY APP STUDIO â€¢ FINANCIAL DATA BATTLE
        </div>
      </section>

      

      <!-- START SCREEN -->
            
      <section id="screenStart" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden">
        <div class="scanline"></div>

        <div class="flex flex-col gap-4">
          
          <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <span class="tag">MODE</span>
              <span class="mono text-sm text-slate-200/90">CPUå¯¾æˆ¦ / ä¼æ¥­é¸æŠ</span>
            </div>
            <div class="flex items-center gap-2">
               <button id="btnOpenLabFromStart" class="btn2 px-3 py-2 rounded-xl text-xs flex items-center gap-2">
                 <i data-lucide="sparkles" class="w-3 h-3"></i><span class="mono">AI FORGE</span>
               </button>
               <button id="btnResetSample" class="btnDanger px-3 py-2 rounded-xl text-xs flex items-center gap-2">
                 <i data-lucide="refresh-ccw" class="w-3 h-3"></i><span class="mono">RESET</span>
               </button>
            </div>
          </div>

          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            
            
                        
            <div class="panel2 rounded-2xl p-4 flex flex-col gap-3 relative group/panel">
              <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500/30"></div>
              
              <div class="flex items-center justify-between">
                <div class="mono text-sm text-cyan-300 font-bold">YOUR COMPANY</div>
                <span class="tag" id="tagYourSector">â€”</span>
              </div>
              
              <div class="flex gap-3 items-center">
                <div id="pLogoMenu" class="logoWrap w-14 h-14 rounded-xl border border-cyan-500/30 shrink-0 bg-slate-900/50 shadow-[0_0_15px_rgba(53,247,255,0.1)]"></div>
                <select id="selPlayer" class="flex-1 w-full rounded-xl px-3 py-2 mono text-sm bg-slate-900/50 border border-slate-700 focus:border-cyan-500 outline-none"></select>
              </div>
              
              
              
              
              <div id="pStatsArea" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1"></div>

              <div class="flex gap-2 mt-2">
                <button id="btnRandomPlayer" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                </button>
                <button id="btnInspectPlayer" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                </button>
              </div>
            </div>

            
                        
            <div class="panel2 rounded-2xl p-4 flex flex-col gap-3 relative">
              <div class="absolute top-0 right-0 w-1 h-full bg-rose-500/30"></div>

              <div class="flex items-center justify-between">
                <div class="mono text-sm text-rose-300 font-bold">ENEMY (CPU)</div>
                <span class="tag" id="tagCpuSector">â€”</span>
              </div>
              
              <div class="flex gap-3 items-center">
                <div id="cLogoMenu" class="logoWrap w-14 h-14 rounded-xl border border-rose-500/30 shrink-0 bg-slate-900/50 shadow-[0_0_15px_rgba(251,113,133,0.1)]"></div>
                <select id="selCPU" class="flex-1 w-full rounded-xl px-3 py-2 mono text-sm bg-slate-900/50 border border-slate-700 focus:border-rose-500 outline-none"></select>
              </div>
              
              
              
              
              <div id="cStatsArea" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1"></div>

              <div class="flex gap-2 mt-2">
                <button id="btnRandomCPU" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                </button>
                <button id="btnInspectCPU" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                </button>
              </div>
            </div>

          </div>

          
          <div class="mt-2 flex flex-col sm:flex-row gap-3">
            <button id="btnStartBattle" class="btn px-4 py-4 rounded-2xl text-lg flex items-center justify-center gap-3 flex-[2] shadow-[0_0_20px_rgba(53,247,255,0.15)] hover:shadow-[0_0_30px_rgba(53,247,255,0.25)] border-cyan-500/40">
              <i data-lucide="swords" class="w-6 h-6"></i>
              <span class="mono font-black">ENGAGE BATTLE</span>
            </button>
            <button id="btnStartTournamentFromStart" class="btn2 px-4 py-4 rounded-2xl text-base flex items-center justify-center gap-2 flex-1">
              <i data-lucide="trophy" class="w-5 h-5"></i>
              <span class="mono font-bold">TOURNAMENT</span>
            </button>
          </div>

        </div>
      </section>

      <!-- BATTLE SCREEN -->
      <section id="screenBattle" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2">
              <span class="tag">BATTLE</span>
              <span class="mono text-sm text-slate-200/90" id="battleSubtitle">â€”</span>
              <div id="marketBadge" class="hidden sm:flex items-center gap-1 px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-[10px] mono text-slate-300">
                <span id="marketIcon">ğŸ“Š</span>
                <span id="marketText">NORMAL</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnBattleToResult" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="flag" class="w-4 h-4"></i><span class="mono">FORCE END</span>
              </button>
              <button id="btnBattleBackStart" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="corner-down-left" class="w-4 h-4"></i><span class="mono">EXIT</span>
              </button>
            </div>
          </div>

          <!-- arena -->
          
          <div id="arena" class="panel2 rounded-2xl relative overflow-hidden bg-slate-900">
            <div class="scanline" style="opacity:.10"></div>
            
            
            <div id="battleToastAnchor" class="battle-toast-wrap"></div>
            
            <div class="battle-stage">
              
              <div id="cityScape" class="city-wrap"></div>
              
              
              <div class="center-ring"></div>

              
              <div class="stage-ground-c" style="z-index:3"></div>
              <div class="stage-ground-p" style="z-index:3"></div>
              
              
              <div class="shadow-marker sh-c"></div>
              <div class="shadow-marker sh-p"></div>

              
              
              <div class="hud-wrap hud-c">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="nameCPU">CPU</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdC">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-500" id="hpBarCPU" style="width:100%"></div>
                </div>
                <div class="flex justify-between text-[10px] mono text-slate-300">
                  <span id="hpTextCPU">HP --/--</span>
                  <span class="text-xs text-violet-300">R&amp;D <span id="skTextCPU">0</span>%</span>
                </div>
                <div class="hidden" id="sectorCPU"></div><div class="hidden" id="rawCPU"></div><div class="hidden" id="skBarCPU"></div>
                <div class="hidden" id="statAtkC"></div><div class="hidden" id="statDefC"></div>
              </div>
                            
              <div id="spriteCPU" class="sprite-wrap pos-c" style="animation: float 4s ease-in-out infinite reverse;">
                 <div class="logoWrap w-20 h-20 sm:w-28 sm:h-28 rounded-2xl border-2 border-white/10" id="logoWrapCPU"></div>
                 <div class="mt-2 flex justify-center flex-wrap gap-1" id="buffsCPU"></div>
              </div>

              
              
              <div id="spritePlayer" class="sprite-wrap pos-p" style="animation: float 4s ease-in-out infinite;">
                 <div class="mb-2 flex justify-center flex-wrap-reverse gap-1" id="buffsPlayer"></div>
                 <div class="logoWrap w-24 h-24 sm:w-36 sm:h-36 rounded-2xl border-2 border-cyan-400/30" id="logoWrapPlayer"></div>
              </div>
              <div class="hud-wrap hud-p">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="namePlayer">PLAYER</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdP">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500" id="hpBarPlayer" style="width:100%"></div>
                </div>
                <div class="flex justify-between text-[10px] mono text-slate-300 mb-1">
                  <span id="hpTextPlayer">HP --/--</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-[10px] font-bold text-violet-300">R&amp;D</div>
                  <div class="flex-1 bg-slate-800 h-1.5 rounded-full overflow-hidden border border-slate-600">
                    <div class="h-full bg-violet-500 shadow-[0_0_10px_#A78BFA] transition-all duration-300" id="skBarPlayer" style="width:0%"></div>
                  </div>
                  <div class="text-[10px] mono text-violet-200" id="skTextPlayer">0%</div>
                </div>
                <div class="mt-2 flex gap-3 text-[10px] mono text-slate-400 justify-end">
                  <div>ATK <span id="statAtkP" class="text-slate-200 font-bold">--</span></div>
                  <div>DEF <span id="statDefP" class="text-slate-200 font-bold">--</span></div>
                </div>
                <div class="hidden" id="sectorPlayer"></div><div class="hidden" id="rawPlayer"></div>
              </div>
            </div>
          </div>

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <!-- Commands -->
              <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
                <div class="scanline" style="opacity:.10"></div>
                <div class="flex items-center justify-between">
                  <div class="mono text-sm text-slate-200/90">COMMAND</div>
                  <span class="tag" id="turnTag">â€”</span>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <button id="cmdAttack" class="btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4"></i><span class="mono">Attack</span>
                  </button>
                  <button id="cmdGuard" class="btn2 px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="shield" class="w-4 h-4"></i><span class="mono">Guard</span>
                  </button>
                  <button id="cmdSkill" class="btn2 px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="flame" class="w-4 h-4"></i><span class="mono">Skill</span>
                  </button>
                  <button id="cmdPivot" class="btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="move-right" class="w-4 h-4"></i><span class="mono">Pivot</span>
                  </button>
                </div>

                <div class="mt-3 panel2 rounded-2xl p-3 text-xs text-slate-300/75 mono leading-relaxed">
                  <div>â€¢ Attack: å¸‚å ´æ”»å‹¢ï¼ˆå®‰å®šãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰</div>
                  <div>â€¢ Guard: è²¡å‹™å›ºã‚ï¼ˆè¢«ãƒ€ãƒ¡è»½æ¸›ï¼†DEFä¸Šæ˜‡ï¼‰</div>
                  <div>â€¢ Skill: çµŒå–¶è³‡æºæŠ•å…¥ï¼ˆR&amp;Dã‚²ãƒ¼ã‚¸æ¶ˆè²»ã§å¤§æŠ€ï¼‰</div>
                  <div>â€¢ Pivot: äº‹æ¥­è»¢æ›ï¼ˆATK/SPDã‚’ä¸€æ™‚å¼·åŒ–ãƒ»èª­ã¿æ›¿ãˆï¼‰</div>
                </div>

                <div class="mt-3 flex gap-2">
                  <button id="btnAuto" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="bot" class="w-4 h-4"></i><span class="mono">AUTO</span>
                  </button>
                  <button id="btnPause" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="pause" class="w-4 h-4"></i><span class="mono">PAUSE</span>
                  </button>
                </div>
              </div>

              <!-- Log -->
              <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
                <div class="scanline" style="opacity:.10"></div>
                <div class="flex items-center justify-between gap-2">
                  <div class="mono text-sm text-slate-200/90">BATTLE LOG</div>
                  <div class="flex items-center gap-2">
                    <span class="tag" id="logHint">LIVE</span>
                    <button id="btnClearLog" class="btn2 px-2.5 py-2 rounded-xl text-sm flex items-center gap-2">
                      <i data-lucide="trash-2" class="w-4 h-4"></i><span class="mono">CLEAR</span>
                    </button>
                  </div>
                </div>
                <div id="logBox" class="mt-3 h-[240px] sm:h-[280px] overflow-auto pr-1 space-y-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT SCREEN -->
            
      <section id="screenResult" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="max-w-4xl mx-auto w-full">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-sky-500/20 border border-emerald-500/30 flex items-center justify-center shadow-[0_0_15px_rgba(16,185,129,0.15)]">
                <i data-lucide="trophy" class="w-6 h-6 text-emerald-300"></i>
              </div>
              <div>
                <span class="tag mb-1">BATTLE RESULT</span>
                <div class="mono text-lg sm:text-xl text-slate-100 font-black glowText" id="resultTitle">â€”</div>
              </div>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
              <button id="btnRematch" class="btn px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="repeat" class="w-4 h-4"></i><span class="mono">REMATCH</span>
              </button>
              <button id="btnResultBack" class="btn2 px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            
            <div class="panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                <i data-lucide="activity" class="w-4 h-4 text-slate-400"></i>
                <div class="mono text-sm text-slate-200/90 font-bold">STATS LOG</div>
              </div>
              <div id="resultSnapshot" class="space-y-2 flex-1 text-sm"></div>
            </div>
            
            
            <div class="md:col-span-2 panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                 <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                 <div class="mono text-sm text-slate-200/90 font-bold">FINANCIAL ANALYSIS</div>
              </div>
              <div id="resultExplainer" class="text-slate-200/90 leading-relaxed text-sm space-y-4 flex-1"></div>
              <div class="mt-5 pt-3 border-t border-slate-700/50 text-[10px] text-slate-400/60 mono text-center">
                â€»ã“ã®åˆ†æã¯ã‚²ãƒ¼ãƒ å†…ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæ¶ç©ºã®ã‚‚ã®ã§ã™ã€‚å®Ÿéš›ã®æŠ•è³‡åˆ¤æ–­ã«ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TOURNAMENT SCREEN -->
      <section id="screenTournament" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="tag">TOURNAMENT</span>
            <div class="mono text-sm text-slate-200/90">8ç¤¾ã‚·ãƒ³ã‚°ãƒ«ã‚¨ãƒªãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnNewBracket" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="dice-5" class="w-4 h-4"></i><span class="mono">NEW BRACKET</span>
            </button>
            <button id="btnRunNextMatch" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="play" class="w-4 h-4"></i><span class="mono">PLAY NEXT</span>
            </button>
            <button id="btnAutoSim" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="fast-forward" class="w-4 h-4"></i><span class="mono">AUTO SIM</span>
            </button>
            <button id="btnTournamentBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">BRACKET</div>
            <div id="bracketBox" class="mt-3"></div>
          </div>
          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">TOURNAMENT LOG</div>
            <div id="tLog" class="mt-3 h-[320px] overflow-auto pr-1 space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- AI FORGE SCREEN -->
      <section id="screenLab" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="tag">AI FORGE</span>
            <div class="mono text-sm text-slate-200/90">ä¼æ¥­æƒ…å ±ã‚’â€œç„¡é™æ‹¡å¼µâ€ã™ã‚‹ã‚«ãƒƒã‚³ã„ã„è¿½åŠ æ©Ÿèƒ½</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLabBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="flex items-center justify-between">
              <div class="mono text-sm text-slate-200/90">â‘  PROMPT GENERATOR â€” â€œCORP INTEL FORGEâ€</div>
              <span class="tag">COPY</span>
            </div>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="mono text-xs text-slate-300/75">è¿½åŠ ä»¶æ•°</label>
                <input id="labCount" type="number" min="1" max="50" value="5" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1" />
              </div>
              <div>
                <label class="mono text-xs text-slate-300/75">åœ°åŸŸ</label>
                <select id="labRegion" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1">
                  <option value="JP" selected>æ—¥æœ¬ï¼ˆã§ãã‚Œã°æ—¥çµŒ400ç´šï¼‰</option>
                  <option value="GLOBAL">æµ·å¤–ï¼ˆå¤–è³‡ï¼‰</option>
                  <option value="MIX">ãƒŸãƒƒã‚¯ã‚¹</option>
                </select>
              </div>
              Â  Â  Â  Â  Â  Â  Â  <div class="sm:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="mono text-xs text-slate-300/75">æ¥­ç¨®ï¼ˆè¤‡æ•°é¸æŠOKï¼‰</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="sectorChoices" class="mt-2 flex flex-wrap gap-2"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="sm:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="mono text-xs text-slate-300/75">ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="labCustom" rows="2" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1" placeholder="ä¾‹: åŠå°ä½“é–¢é€£ã®ä¼æ¥­ã‚’ä¸­å¿ƒã«ã€æ™‚ä¾¡ç·é¡é«˜ã‚ã§ä½œã£ã¦ãã ã•ã„ã€‚"></textarea>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  

            <div class="mt-3">
              <button id="btnGeneratePrompt" class="btn px-4 py-3 rounded-2xl text-base w-full flex items-center justify-center gap-2">
                <i data-lucide="wand-2" class="w-5 h-5"></i><span class="mono font-bold">GENERATE PROMPT</span>
              </button>
            </div>

            <div class="mt-3">
              <textarea id="labPrompt" rows="10" class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" placeholder="ã“ã“ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã™â€¦"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="btnCopyPrompt" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="copy" class="w-4 h-4"></i><span class="mono">COPY PROMPT</span>
                </button>
                <button id="btnClearPrompt" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="eraser" class="w-4 h-4"></i><span class="mono">CLEAR</span>
                </button>
              </div>
            </div>
          </div>

          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="flex items-center justify-between">
              <div class="mono text-sm text-slate-200/90">â‘¡ JSON IMPORT â€” â€œDATA INJECTION PORTâ€</div>
              <span class="tag">PASTE</span>
            </div>

            <div class="mt-3 text-sm text-slate-200/80 leading-relaxed">
              AIã‹ã‚‰è¿”ã£ã¦ããŸ <span class="kbd">JSONé…åˆ—</span> ã‚’è²¼ã‚Šä»˜ã‘ã¦ <span class="kbd">IMPORT</span>ã€‚ä¼æ¥­ã‚’ç„¡é™ã«è¿½åŠ ã§ãã¾ã™ã€‚
            </div>

            <div class="mt-3">
              <textarea id="labJson" rows="12" class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" placeholder='ä¾‹:
[
  {
    "name":"Example Corp",
    "name_jp":"ä¾‹æ ªå¼ä¼šç¤¾",
    "domain":"example.com",
    "sector":"Tech",
    "currency":"JPY",
    "cash": 1200,
    "operating_margin": 18.5,
    "equity_ratio": 52.0,
    "market_cap": 18000,
    "employees": 12000,
    "rnd": 900
  }
]
â€»cash/market_cap/rnd ã¯ã€Œåå„„å††(=billion JPY)ã€å˜ä½æ¨å¥¨'></textarea>
            </div>

            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
              <button id="btnImportJson" class="btn px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2">
                <i data-lucide="download" class="w-5 h-5"></i><span class="mono font-bold">IMPORT</span>
              </button>
              <button id="btnExportJson" class="btn2 px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2">
                <i data-lucide="upload" class="w-5 h-5"></i><span class="mono font-bold">EXPORT ALL</span>
              </button>
            </div>

            <div class="mt-3 panel2 rounded-2xl p-3">
              <div class="mono text-xs text-slate-300/75">DATABASE</div>
              <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div class="panel2 rounded-xl p-2">
                  <div class="mono text-[10px] text-slate-300/75">COMPANIES</div>
                  <div class="mono font-black text-lg" id="dbCount">0</div>
                </div>
                <div class="panel2 rounded-xl p-2">
                  <div class="mono text-[10px] text-slate-300/75">STATUS</div>
                  <div class="mono font-black text-lg" id="dbStatus">OK</div>
                </div>
              </div>
              <div class="mt-2 flex gap-2">
                <button id="btnClearDb" class="btnDanger px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="trash" class="w-4 h-4"></i><span class="mono">CLEAR DB</span>
                </button>
                <button id="btnRestoreSample" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="refresh-ccw" class="w-4 h-4"></i><span class="mono">RESTORE SAMPLE</span>
                </button>
              </div>
            </div>

            <div class="mt-3 text-xs text-slate-300/65 mono">
              IndexedDBã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚ä¼æ¥­ãƒ—ãƒ¼ãƒ«ã¯æ®‹ã‚Šã¾ã™ã€‚
            </div>
          </div>
        </div>
      </section>

      <!-- MODAL -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center px-4 z-[80]">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative w-full max-w-2xl panel rounded-2xl p-4 sm:p-6 overflow-hidden">
          <div class="scanline"></div>
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="tag" id="modalTag">INFO</span>
              <div class="mono text-sm text-slate-200/90" id="modalTitle">â€”</div>
            </div>
            <button id="btnCloseModal" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="x" class="w-4 h-4"></i><span class="mono">CLOSE</span>
            </button>
          </div>
          <div id="modalBody" class="mt-3"></div>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[90] hidden">
        <div id="toastInner" class="panel2 rounded-2xl px-4 py-3 mono text-sm"></div>
      </div>

    </main>

    <footer class="py-6 text-xs text-slate-300/65 mono">
      
    </footer>
  </div>

    <script>
                    /* --- FANFARE ENGINE (Victory) --- */
    const FanfareEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 138, nextNoteTime = 0, noteIndex = 0;
      let timerID, masterGain = null;
      const introMelody = [{n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'G#4',d:2},{n:'A#4',d:2},{n:'C5',d:8}];
      const loopLength = 32;
      const loopMelody = ['C5',null,'G4',null, 'E4',null,'C4',null, 'A3','B3','C4','D4', 'E4',null,'C4',null, 'F4',null,'C4',null, 'A3',null,'F3',null, 'D3','E3','F3','G3', 'A3','B3','C4','D4'];
      const loopBass = ['C2',null,'G2',null, 'C2',null,'G2',null, 'A1',null,'E2',null, 'A1',null,'E2',null, 'F1',null,'C2',null, 'F1',null,'C2',null, 'G1',null,'D2',null, 'G1',null,'G2',null];
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function playTrumpet(t,f,d){const o=ctx.createOscillator(),o2=ctx.createOscillator(),fi=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=f;o2.type='sawtooth';o2.frequency.value=f*1.002;fi.type='lowpass';fi.Q.value=2;fi.frequency.setValueAtTime(800,t);fi.frequency.linearRampToValueAtTime(3000,t+0.05);fi.frequency.exponentialRampToValueAtTime(1500,t+d);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.4,t+0.02);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0,t+d);o.connect(fi);o2.connect(fi);fi.connect(g);g.connect(masterGain);o.start(t);o.stop(t+d+0.1);o2.start(t);o2.stop(t+d+0.1);}
      function playStrings(t,f,d){const o=ctx.createOscillator(),fi=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=f;fi.type='lowpass';fi.frequency.value=1000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.1,t+0.2);g.gain.linearRampToValueAtTime(0,t+d+0.2);o.connect(fi).connect(g).connect(masterGain);o.start(t);o.stop(t+d+0.3);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.1,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type='highpass';f.frequency.value=800;g.gain.setValueAtTime(0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playTimpani(t){const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(10,t+0.3);g.gain.setValueAtTime(0.8,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.5);}
      function playBass(t,f,d){const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.4);}
      function schedule(){let ct=ctx.currentTime+0.1; introMelody.forEach(n=>{const d=n.d*(60/tempo/4); playTrumpet(ct,noteToFreq(n.n),d); if(n.n==='G#4')playStrings(ct,noteToFreq('G#3'),2); if(n.n==='A#4')playStrings(ct,noteToFreq('A#3'),2); if(n.n==='C5'){playStrings(ct,noteToFreq('C3'),4);playStrings(ct,noteToFreq('E3'),4);playStrings(ct,noteToFreq('G3'),4);playTimpani(ct);} ct+=d;}); const loopStart=ct; function runLoop(st){if(!isPlaying)return; for(let i=0;i<loopLength;i++){const t=st+(i*(60/tempo/4)); const n=loopMelody[i]; if(n)playTrumpet(t,noteToFreq(n),0.2); const b=loopBass[i]; if(b)playBass(t,noteToFreq(b),0.2); if(i%4===0)playSnare(t); if(i%4===2){playSnare(t);playSnare(t+(60/tempo/4)*0.5);}} const next=st+(loopLength*(60/tempo/4)); timerID=setTimeout(()=>runLoop(next),(next-ctx.currentTime-0.5)*1000);} timerID=setTimeout(()=>runLoop(loopStart),(loopStart-ctx.currentTime-0.1)*1000);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.4;masterGain.connect(ctx.destination);} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; schedule();}catch(e){console.log(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

    /* --- REQUIEM ENGINE (Defeat) --- */
    const RequiemEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 68, nextNoteTime = 0, current16thNote = 0, timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 128, harpLine=[], bassLine=[], padLine=[], leadLine=[];
      function compose(){harpLine.length=0;bassLine.length=0;padLine.length=0;leadLine.length=0; for(let i=0;i<seqLength;i++){const bar=Math.floor(i/16),step=i%16; let ch=[],bn=null,pc=null; if(bar<2){ch=['A2','E3','A3','C4'];bn='A1';pc=['A2','C3','E3'];}else if(bar<4){ch=['F2','C3','F3','A3'];bn='F1';pc=['F2','A2','C3','E3'];}else if(bar<6){if(bar===4){ch=['D2','A2','D3','F3'];bn='D1';pc=['D2','F2','A2','C3'];}else{ch=['G2','D3','G3','B3'];bn='G1';pc=['G2','B2','D3','F3'];}}else{if(bar===6){ch=['E2','B2','E3','G#3'];bn='E1';pc=['E2','G#2','B2','D3'];}else{ch=['A2','E3','G3','C4'];bn='A1';pc=['A2','C3','E3','G3'];}} const ap=[0,1,2,3,2,1,0,1,2,3,2,1,0,1,2,3]; harpLine.push(ch[ap[step]]); if(step===0){bassLine.push(bn);padLine.push(pc);}else{bassLine.push(null);padLine.push(null);} let n=null; if(bar===0&&step===0)n={n:'E4',d:12}; if(bar===1&&step===0)n={n:'C4',d:8}; if(bar===1&&step===12)n={n:'A3',d:4}; if(bar===2&&step===0)n={n:'F4',d:12}; if(bar===3&&step===0)n={n:'E4',d:4}; if(bar===3&&step===4)n={n:'D4',d:4}; if(bar===3&&step===8)n={n:'C4',d:8}; if(bar===4&&step===0)n={n:'D4',d:10}; if(bar===5&&step===0)n={n:'B3',d:10}; if(bar===6&&step===0)n={n:'G#3',d:12}; if(bar===7&&step===0)n={n:'A3',d:16}; leadLine.push(n);}}
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,4*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playHarp(t,f){const o=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='sine';o.frequency.value=f;o2.type='triangle';o2.frequency.value=f*2;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.3,t+0.01);g.gain.exponentialRampToValueAtTime(0.001,t+1.5);p.pan.value=(current16thNote%2===0)?-0.2:0.2;o.connect(g);o2.connect(g);g.connect(p).connect(masterGain);o.start(t);o.stop(t+1.5);o2.start(t);o2.stop(t+1.5);}
      function playStrings(t,ns){const d=4.0; ns.forEach(n=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.08,t+1.0);g.gain.linearRampToValueAtTime(0,t+d);o.connect(g).connect(masterGain);o.start(t);o.stop(t+d);});}
      function playBass(t,n){const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.3,t+0.2);g.gain.linearRampToValueAtTime(0,t+4.0);o.connect(g).connect(masterGain);o.start(t);o.stop(t+4.0);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*(60/tempo/4),o=ctx.createOscillator(),l=ctx.createOscillator(),lg=ctx.createGain(),g=ctx.createGain(),rs=ctx.createGain(),c=ctx.createConvolver();o.type='triangle';o.frequency.value=f;l.frequency.value=5;lg.gain.setValueAtTime(0,t);lg.gain.linearRampToValueAtTime(2,t+0.5);l.connect(lg).connect(o.frequency);l.start(t);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.2,t+0.2);g.gain.setValueAtTime(0.2,t+d-0.2);g.gain.linearRampToValueAtTime(0,t+d+0.5);rs.gain.value=0.5;c.buffer=reverbBuffer;o.connect(g);g.connect(masterGain);g.connect(rs).connect(c).connect(masterGain);o.start(t);o.stop(t+d+1.0);}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength; if(harpLine[i])playHarp(nextNoteTime,noteToFreq(harpLine[i])); if(bassLine[i])playBass(nextNoteTime,bassLine[i]); if(padLine[i])playStrings(nextNoteTime,padLine[i]); if(leadLine[i])playLead(nextNoteTime,leadLine[i]); nextNoteTime+=0.25*(60.0/tempo); current16thNote++;} timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.5;masterGain.connect(ctx.destination);reverbBuffer=createReverb();compose();} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; current16thNote=0; nextNoteTime=ctx.currentTime+0.1; schedule();}catch(e){console.log(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

/* --- BOSS BATTLE BGM ENGINE (Nobuo Style / Epic) --- */
    const BossAudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 168, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];
      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const roots = ['E2','F2','E2','G#2', 'A2','B2','C3','B2', 'E2','C2','D2','G2', 'C2','D2','E2','E2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16, root = roots[bar%16];
          // Drums
          let k=0, s=0, h=0; if(step%2===0) k=1; if(step===4||step===12) s=1; if(i%2===0) h=1; else h=0.3; if(step>12 && (bar+1)%4===0) { k=1; s=1; h=0; }
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          // Bass
          if(step%2===0) bassLine.push(root); else bassLine.push(root);
          // Arp
          let arpNotes = ['E3','B3','E4','G4','B4','G4','E4','B3'];
          if(root.startsWith('F')) arpNotes=['F3','C4','F4','A4','C5','A4','F4','C4'];
          if(root.startsWith('G#')) arpNotes=['G#3','D4','F4','B4','D5','B4','F4','D4'];
          if(root.startsWith('A')) arpNotes=['A3','E4','A4','C5','E5','C5','A4','E4'];
          if(root.startsWith('C')) arpNotes=['C3','G3','C4','E4','G4','E4','C4','G3'];
          if(root.startsWith('D')) arpNotes=['D3','A3','D4','F#4','A4','F#4','D4','A3'];
          if(root.startsWith('B')) arpNotes=['B2','F#3','B3','D#4','F#4','D#4','B3','F#3'];
          arpLine.push(arpNotes[i%8]);
          // Pad
          if(step===0) {
            let chord=['E3','G3','B3'];
            if(root.startsWith('F')) chord=['F3','A3','C4']; if(root.startsWith('G#')) chord=['G#3','B3','D4']; if(root.startsWith('A')) chord=['A3','C4','E4']; if(root.startsWith('B')) chord=['B3','D#4','F#4']; if(root.startsWith('C')) chord=['C3','E3','G3']; if(root.startsWith('D')) chord=['D3','F#3','A3'];
            padChords.push(chord);
          } else padChords.push(null);
          // Lead
          let n=null, ls=i%64;
          if(bar%16<4) { if(step===0)n={n:root.replace('2','4'),d:4}; if(step===6)n={n:root.replace('2','4'),d:2}; }
          else if(bar%16<8) { if(ls===0)n={n:'A4',d:6}; if(ls===8)n={n:'B4',d:2}; if(ls===10)n={n:'C5',d:4}; if(ls===16)n={n:'B4',d:12}; if(ls===32)n={n:'G4',d:6}; if(ls===40)n={n:'E4',d:4}; if(ls===48)n={n:'F#4',d:12}; }
          else if(bar%16<12) { if(ls===0)n={n:'E5',d:10}; if(ls===12)n={n:'D5',d:6}; if(ls===16)n={n:'C5',d:12}; if(ls===32)n={n:'B4',d:4}; if(ls===36)n={n:'C5',d:4}; if(ls===40)n={n:'D5',d:8}; if(ls===48)n={n:'G5',d:12}; }
          else { if(ls===0)n={n:'C5',d:6}; if(ls===8)n={n:'D5',d:6}; if(ls===16)n={n:'E5',d:12}; if(ls===32)n={n:'B4',d:4}; if(ls===36)n={n:'A4',d:4}; if(ls===40)n={n:'G4',d:4}; if(ls===48)n={n:'E4',d:16}; }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,2*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(masterGain);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.2,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=1000;g.gain.setValueAtTime(0.7,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=5000;g.gain.setValueAtTime(v*0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f);f.connect(g);g.connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*0.25*(60/tempo),o=ctx.createOscillator(),g=ctx.createGain(),l=ctx.createOscillator(),lg=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='square';o.frequency.value=f;l.frequency.value=5;lg.gain.value=5;l.connect(lg);lg.connect(o.frequency);l.start(t);g.gain.setValueAtTime(0.4,t);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0.01,t+d);dl.delayTime.value=0.25;dg.gain.value=0.4;o.connect(g);g.connect(masterGain);g.connect(dl);dl.connect(dg);dg.connect(dl);dg.connect(masterGain);o.start(t);o.stop(t+d+0.5);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);p.pan.value=(current16thNote%2===0)?-0.3:0.3;o.connect(g);g.connect(p);p.connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){const d=16*0.25*(60/tempo);ns.forEach(n=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);o2.type='sawtooth';o2.frequency.value=noteToFreq(n)*1.002;f.type='lowpass';f.frequency.value=2000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.5);g.gain.setValueAtTime(0.15,t+d-0.5);g.gain.linearRampToValueAtTime(0.01,t+d);rg.gain.value=0.5;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g);g.connect(masterGain);g.connect(rg);rg.connect(c);c.connect(masterGain);o.start(t);o2.start(t);o.stop(t+d);o2.stop(t+d);});}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playSnare(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.6;masterGain.connect(ctx.destination);reverbBuffer=createReverb();compose();} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; current16thNote=0; nextNoteTime=ctx.currentTime+0.1; schedule();}catch(e){console.error(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

        /* --- OPENING BGM ENGINE (Field Style / Robust) --- */
    const MenuAudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 94, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], snarePat=[], cymbalPat=[], padChords=[], leadLine=[], arpLine=[];
      function compose() {
        bassLine.length=0; snarePat.length=0; cymbalPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const roots = ['G2','G2','G2','G2', 'G2','F#2','E2','B2', 'C2','B2','A2','D2', 'D#2','F2','G2','G2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16, root = roots[bar%16];
          // Snare
          let s=0; if(bar>=4){ if(step%4===0) s=0.6; else if(step%2===0) s=0.15; else if(Math.random()>0.5) s=0.05; if(step===15) s=0.3; }
          snarePat.push(s);
          // Cymbal
          let c=0; if(step===0 && bar%4===0 && bar>=4) c=1; cymbalPat.push(c);
          // Bass
          if(bar>=4) { if(step%4===0) bassLine.push(root); else bassLine.push(null); } else { if(step===0) bassLine.push(root); else bassLine.push(null); }
          // Arp
          let arpNotes=[]; if(root.startsWith('G')) arpNotes=['G3','B3','D4','G4']; else if(root.startsWith('F#')) arpNotes=['F#3','A3','D4','F#4']; else if(root.startsWith('E')) arpNotes=['E3','G3','B3','E4']; else if(root.startsWith('B')) arpNotes=['B3','D4','F#4','B4']; else if(root.startsWith('C')) arpNotes=['C3','E3','G3','C4']; else if(root.startsWith('A')) arpNotes=['A3','C4','E4','G4']; else if(root.startsWith('D#')) arpNotes=['D#3','G3','A#3','D#4']; else if(root.startsWith('F')) arpNotes=['F3','A3','C4','F4']; else arpNotes=['D3','F#3','A3','D4'];
          const ap=[0,1,2,3,2,1,0,1,2,3,2,1,0,1,2,3]; arpLine.push(arpNotes[ap[step]]);
          // Pad
          if(step===0) {
            let ch=[]; if(root.startsWith('G')) ch=['G3','B3','D4']; else if(root.startsWith('F#')) ch=['F#3','A3','D4']; else if(root.startsWith('E')) ch=['G3','B3','E4']; else if(root.startsWith('B')) ch=['F#3','B3','D4']; else if(root.startsWith('C')) ch=['G3','C4','E4']; else if(root.startsWith('A')) ch=['G3','C4','E4']; else if(root.startsWith('D#')) ch=['G3','A#3','D#4']; else if(root.startsWith('F')) ch=['A3','C4','F4']; else ch=['F#3','A3','D4'];
            padChords.push(ch);
          } else padChords.push(null);
          // Lead
          let n=null, ls=i%64;
          if(bar%16>=4 && bar%16<8) { if(ls===0)n={n:'B4',d:6}; if(ls===8)n={n:'A4',d:2}; if(ls===10)n={n:'G4',d:4}; if(ls===16)n={n:'D5',d:12}; if(ls===32)n={n:'C5',d:4}; if(ls===36)n={n:'B4',d:4}; if(ls===40)n={n:'A4',d:4}; if(ls===44)n={n:'G4',d:4}; if(ls===48)n={n:'F#4',d:12}; }
          else if(bar%16>=8 && bar%16<12) { if(ls===0)n={n:'E4',d:6}; if(ls===8)n={n:'F#4',d:2}; if(ls===10)n={n:'G4',d:4}; if(ls===16)n={n:'B4',d:12}; if(ls===32)n={n:'A4',d:4}; if(ls===36)n={n:'G4',d:4}; if(ls===40)n={n:'A4',d:8}; if(ls===48)n={n:'D5',d:12}; }
          else if(bar%16>=12) { if(ls===0)n={n:'G5',d:12}; if(ls===16)n={n:'A5',d:12}; if(ls===32)n={n:'B5',d:16}; if(ls===56)n={n:'G5',d:8}; }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,3*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,2); return b;}
      function playSnare(t,v){if(v<=0)return;const b=ctx.createBuffer(1,ctx.sampleRate*0.15,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="lowpass";f.frequency.value=800;g.gain.setValueAtTime(v*0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playCymbal(t){const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.5);}
      function playBass(t,n){const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.4,t);g.gain.linearRampToValueAtTime(0.3,t+0.2);g.gain.linearRampToValueAtTime(0,t+0.8);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.8);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.25,t+0.02);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);p.pan.value=(current16thNote%2===0)?-0.4:0.4;o.connect(g).connect(p).connect(masterGain);o.start(t);o.stop(t+0.4);}
      function playPad(t,ns){const d=16*0.25*(60/tempo); ns.forEach(n=>{const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.value=800;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.1,t+1.0);g.gain.setValueAtTime(0.1,t+d-0.5);g.gain.linearRampToValueAtTime(0,t+d);rg.gain.value=0.8;c.buffer=reverbBuffer;o.connect(f).connect(g);g.connect(masterGain);g.connect(rg).connect(c).connect(masterGain);o.start(t);o.stop(t+d);});}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*(60/tempo/4),o=ctx.createOscillator(),l=ctx.createOscillator(),lg=ctx.createGain(),no=ctx.createBufferSource(),nf=ctx.createBiquadFilter(),ng=ctx.createGain(),g=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='triangle';o.frequency.value=f;l.frequency.value=4.5;lg.gain.setValueAtTime(0,t);lg.gain.linearRampToValueAtTime(3,t+0.5);l.connect(lg).connect(o.frequency);l.start(t);const nb=ctx.createBuffer(1,ctx.sampleRate*d,ctx.sampleRate),nd=nb.getChannelData(0);for(let i=0;i<nd.length;i++)nd[i]=Math.random()*2-1;no.buffer=nb;nf.type="bandpass";nf.frequency.value=f*1.5;nf.Q.value=1;ng.gain.value=0.05;no.connect(nf).connect(ng).connect(masterGain);no.start(t);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.25,t+0.1);g.gain.setValueAtTime(0.25,t+d-0.1);g.gain.linearRampToValueAtTime(0,t+d);dl.delayTime.value=0.35;dg.gain.value=0.3;g.connect(dl).connect(dg).connect(dl).connect(masterGain);o.connect(g).connect(masterGain);o.start(t);o.stop(t+d+1.0);}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(snarePat[i])playSnare(nextNoteTime,snarePat[i]);if(cymbalPat[i])playCymbal(nextNoteTime);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      
            return {
        play: async () => {
          try {
            if(!ctx) {
              const AC = window.AudioContext || window.webkitAudioContext;
              ctx = new AC();
              masterGain = ctx.createGain();
              masterGain.gain.value = 0.5;
              masterGain.connect(ctx.destination);
              reverbBuffer = createReverb();
              compose();
            }
            if(ctx.state === 'suspended') await ctx.resume();
            if(isPlaying) return;
            
            // Reset timing
            isPlaying = true;
            current16thNote = 0;
            nextNoteTime = ctx.currentTime + 0.1;
            schedule();
            console.log("Menu BGM Started");
          } catch(e){ console.error("Menu BGM Play Error:", e); }
        },
        stop: () => {
          isPlaying = false;
          clearTimeout(timerID);
          if(masterGain) {
             try { masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.1); } catch(e){}
          }
          setTimeout(() => { if(ctx){ ctx.close(); ctx=null; } }, 200);
        }
      };
    })();

    /* --- BGM ENGINE (Nobuo Style / Robust Version) --- */
    const AudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 148, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];

      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const prog = ['E2','E2','E2','E2', 'E2','C2','D2','E2', 'C2','D2','E2','E2', 'A1','B1','C2','D2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16;
          // Drums
          let k=0, s=0, h=0;
          if(step===0||step===10) k=1; if(step===4||step===12) s=1; if(i%2===0) h=1; else if(i%4===3) h=0.6;
          if(step>12 && (bar+1)%4===0) { k=1; s=1; h=0; }
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          // Bass
          const root = prog[bar%16];
          if(step%4!==1) bassLine.push(root); else bassLine.push(null);
          // Arp
          let arpNotes = ['E3','G3','B3','D4', 'B3','G3'];
          if(root==='C2') arpNotes=['C3','E3','G3','B3','G3','E3'];
          if(root==='D2') arpNotes=['D3','F#3','A3','C#4','A3','F#3'];
          if(root==='A1') arpNotes=['A2','C3','E3','G3','E3','C3'];
          arpLine.push(arpNotes[i%6]);
          // Pad
          if(step===0) {
            if(root==='E2') padChords.push(['E3','G3','B3']); else if(root==='C2') padChords.push(['C3','E3','G3']);
            else if(root==='D2') padChords.push(['D3','F#3','A3']); else if(root==='A1') padChords.push(['A2','C3','E3']);
            else if(root==='B1') padChords.push(['B2','D#3','F#3']); else padChords.push(['E3','G3','B3']);
          } else padChords.push(null);
          // Lead
          let n = null, ls = i%64;
          if(bar%16>=4 && bar%16<8) { if(ls===0)n={n:'E4',d:6}; if(ls===8)n={n:'G4',d:2}; if(ls===10)n={n:'F#4',d:4}; if(ls===16)n={n:'E4',d:12}; if(ls===32)n={n:'D4',d:4}; if(ls===36)n={n:'F#4',d:4}; if(ls===40)n={n:'A4',d:4}; if(ls===48)n={n:'B4',d:12}; }
          else if(bar%16>=8 && bar%16<12) { if(ls===0)n={n:'C5',d:10}; if(ls===12)n={n:'B4',d:4}; if(ls===16)n={n:'A4',d:12}; if(ls===32)n={n:'D5',d:10}; if(ls===44)n={n:'C5',d:4}; if(ls===48)n={n:'B4',d:12}; }
          else if(bar%16>=12) { if(ls===0)n={n:'C5',d:4}; if(ls===4)n={n:'D5',d:4}; if(ls===8)n={n:'E5',d:8}; if(ls===16)n={n:'D5',d:4}; if(ls===20)n={n:'E5',d:4}; if(ls===24)n={n:'F#5',d:8}; if(ls===32)n={n:'G5',d:12}; if(ls===48)n={n:'A5',d:16}; }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,2*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(masterGain);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.2,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=1000;g.gain.setValueAtTime(0.7,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=5000;g.gain.setValueAtTime(v*0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f);f.connect(g);g.connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*0.25*(60/tempo),o=ctx.createOscillator(),g=ctx.createGain(),l=ctx.createOscillator(),lg=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='square';o.frequency.value=f;l.frequency.value=5;lg.gain.value=5;l.connect(lg);lg.connect(o.frequency);l.start(t);g.gain.setValueAtTime(0.4,t);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0.01,t+d);dl.delayTime.value=0.25;dg.gain.value=0.4;o.connect(g);g.connect(masterGain);g.connect(dl);dl.connect(dg);dg.connect(dl);dg.connect(masterGain);o.start(t);o.stop(t+d+0.5);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);p.pan.value=(current16thNote%2===0)?-0.3:0.3;o.connect(g);g.connect(p);p.connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){const d=16*0.25*(60/tempo);ns.forEach(n=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);o2.type='sawtooth';o2.frequency.value=noteToFreq(n)*1.002;f.type='lowpass';f.frequency.value=2000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.5);g.gain.setValueAtTime(0.15,t+d-0.5);g.gain.linearRampToValueAtTime(0.01,t+d);rg.gain.value=0.5;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g);g.connect(masterGain);g.connect(rg);rg.connect(c);c.connect(masterGain);o.start(t);o2.start(t);o.stop(t+d);o2.stop(t+d);});}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playSnare(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play: async () => {
          try {
            if(!ctx) {
              const AC = window.AudioContext || window.webkitAudioContext;
              ctx = new AC();
              masterGain = ctx.createGain();
              masterGain.gain.value = 0.6; // Volume Up
              masterGain.connect(ctx.destination);
              reverbBuffer = createReverb();
              compose();
            }
            if(ctx.state === 'suspended') await ctx.resume();
            if(isPlaying) return;
            isPlaying = true;
            current16thNote = 0;
            nextNoteTime = ctx.currentTime + 0.1;
            schedule();
          } catch(e) { console.error('BGM Error:', e); }
        },
        stop: () => {
          isPlaying = false;
          clearTimeout(timerID);
          if(masterGain) masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.1);
          setTimeout(() => { if(ctx){ ctx.close(); ctx=null; } }, 200);
        }
      };
    })();

    /********************
     * UTIL
     ********************/
    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const rnd = (min,max)=>Math.random()*(max-min)+min;
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const fmt = (n, d=0)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const nowIso = ()=>new Date().toISOString();

    function hashStr(s){
      let h=2166136261>>>0;
      for(let i=0;i<s.length;i++){
        h^=s.charCodeAt(i);
        h = Math.imul(h,16777619);
      }
      return h>>>0;
    }
    function seededRand(seed){
      // xorshift32
      let x = seed>>>0;
      return ()=> {
        x ^= x << 13; x >>>= 0;
        x ^= x >> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x>>>0) / 4294967296;
      };
    }

    function toast(msg, kind="info"){
      const el = $("toast");
      const inner = $("toastInner");
      inner.textContent = msg;
      inner.style.borderColor = kind==="bad" ? "rgba(251,113,133,.35)" : kind==="good" ? "rgba(52,211,153,.30)" : "rgba(53,247,255,.22)";
      el.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.add("hidden"), 2100);
    }

    function copyToClipboard(text){
      return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false);
    }

    /********************
     * SECTORS & SKILLS
     ********************/
        const MOTIONS = [
      "m-smash", "m-rush", "m-sonic", "m-snipe", "m-drill",
      "m-jump", "m-zigzag", "m-tackle", "m-uppercut", "m-meteor",
      "m-shadow", "m-giant", "m-helix", "m-impact", "m-wobble",
      "m-charge", "m-boomerang", "m-frenzy", "m-stealth", "m-pulse"
    ];

    const SECTORS = [
      {key:"Tech", label:"Tech / Electronics"},
      {key:"Auto", label:"Automotive"},
      {key:"Finance", label:"Finance"},
      {key:"Retail", label:"Retail"},
      {key:"Telecom", label:"Telecom"},
      {key:"Industrial", label:"Industrial / Manufacturing"},
      {key:"Pharma", label:"Pharma / Healthcare"},
      {key:"Energy", label:"Energy / Utilities"},
    ];

        /* --- MARKET CYCLES --- */
    const MARKET_CYCLES = {
      NORMAL: { name: "NORMAL", desc: "é€šå¸¸ç›¸å ´", color: "text-slate-300" },
      BULL:   { name: "BULL",   desc: "å¥½æ³: æ™¯æ°—æ•æ„Ÿæ ª(Tech/Auto/Ind/Ene)ãŒæ´»æ³ (ATK x1.5)", color: "text-emerald-300" },
      BEAR:   { name: "BEAR",   desc: "ä¸æ³: å…¨ä½“ä½è¿· (ATK x0.7)ã€‚ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–æ ªã¯å …èª¿", color: "text-rose-300" },
      TIGHT:  { name: "TIGHT",  desc: "å¼•ãç· ã‚: é‡‘åˆ©ä¸Šæ˜‡ã€‚ä½è‡ªå·±è³‡æœ¬ä¼æ¥­ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚éŠ€è¡Œ(Fin)æœ‰åˆ©", color: "text-amber-300" }
    };

    /* ã‚¹ã‚­ãƒ«ã®åŠ¹æœãƒ­ã‚¸ãƒƒã‚¯å®šç¾© (Archetypes) */
    const SKILL_ARCHETYPES = {
      "BURST": { mult: 1.8, pierce: 0.15, fx: "NEON", desc:"é«˜ç«åŠ›ãƒ»è²«é€šæ”»æ’ƒ" },
      "GUARD": { mult: 1.2, buff:{key:"guard", val:0.6}, fx:"AURA", desc:"æ”»æ’ƒï¼‹å¼·åŠ›ãªé˜²å¾¡" },
      "SPEED": { mult: 1.4, buff:{key:"spd_up", val:0.25}, fx:"SPARK", desc:"æ”»æ’ƒï¼‹SPDå¤§å¹…ä¸Šæ˜‡" },
      "DRAIN": { mult: 1.3, drain:0.4, fx:"GLITCH", desc:"HPå¸åæ”»æ’ƒ" },
      "DOT":   { mult: 1.3, debuff:{key:"bleed", val:0.04}, fx:"STORM", desc:"æ”»æ’ƒï¼‹ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸" },
      "JAM":   { mult: 1.3, debuff:{key:"spd_down", val:-0.25}, fx:"GLITCH", desc:"æ”»æ’ƒï¼‹æ•µSPDä½ä¸‹" },
      "BUFF":  { mult: 1.4, buff:{key:"atk_up", val:0.2}, fx:"WAVE", desc:"æ”»æ’ƒï¼‹ATKä¸Šæ˜‡" },
    };

        /* --- NEW: COMBO SKILLS & MARKET EVENTS --- */
    const COMBO_SKILLS = {
      "Industrial_Auto": { name: "Steel Price Shock", desc: "é‹¼æä¾¡æ ¼ã®å¼·åˆ¶å€¤ä¸Šã’ï¼ˆç‰¹å¤§ãƒ€ãƒ¡ï¼‹æ•µDEFâ†“ï¼‰", mult: 1.9, fx: "IMPACT", debuff: {key:"def_down", val:-0.25} },
      "Tech_Finance": { name: "DeFi Hack", desc: "åˆ†æ•£å‹é‡‘èãƒãƒƒã‚¯ï¼ˆHPå¸åï¼‰", mult: 1.5, fx: "GLITCH", drain: 0.3 },
      "Energy_Industrial": { name: "Power Crunch", desc: "é›»åŠ›ä¾›çµ¦çµã‚Šè¾¼ã¿ï¼ˆæ•µSPDâ†“ï¼‰", mult: 1.7, fx: "ARC", debuff: {key:"spd_down", val:-0.3} },
      "Retail_Tech": { name: "Direct-to-Consumer", desc: "ä¸­æŠœãæˆ¦ç•¥ï¼ˆã‚²ãƒ¼ã‚¸å›åï¼‰", mult: 1.5, fx: "WAVE", gauge: 25 },
      "Telecom_Tech": { name: "Infrastructure Tax", desc: "ã‚¤ãƒ³ãƒ•ãƒ©åˆ©ç”¨æ–™å¾´åï¼ˆæ•µã‚²ãƒ¼ã‚¸æ²¡åï¼‰", mult: 1.6, fx: "GLITCH", gaugeEnemy: -25 },
      "Auto_Energy": { name: "EV Shift", desc: "è„±ç‚­ç´ ã‚·ãƒ•ãƒˆï¼ˆæ”»å‹¢ãƒãƒ•ï¼‰", mult: 1.6, fx: "SPARK", buff: {key:"atk_up", val:0.25} },
      "Pharma_Finance": { name: "M&A Defense", desc: "è²·åé˜²è¡›ç­–ï¼ˆå¼·å›ºãªå®ˆã‚Šï¼‰", mult: 1.2, fx: "STORM", buff: {key:"guard", val:0.5} },
      "Finance_Retail": { name: "Credit Crunch", desc: "è²¸ã—æ¸‹ã‚Šï¼ˆæ•µæ”»æ’ƒâ†“ï¼‰", mult: 1.5, fx: "AURA", debuff: {key:"atk_down", val:-0.2} }
    };

    Â  Â  Â  Â  const MARKET_EVENTS = [
Â  Â  Â  { name: "Bull Market", text: "å¥½æ™¯æ°—åˆ°æ¥ï¼å¸‚å ´å¿ƒç†ãŒæ”¹å–„", type:"good", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "MONEY"); b.fx(null, "FLASH_GREEN");
Â  Â  Â  Â  b.gainSkill(b.P, 20); b.gainSkill(b.C, 20); return "ä¸¡ç¤¾ã®R&Dã‚²ãƒ¼ã‚¸å¢—åŠ  (+20)";
Â  Â  Â  }},
Â  Â  Â  { name: "Recession", text: "æ™¯æ°—å¾Œé€€â€¦éœ€è¦æ¸›é€€", type:"bad", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "CRASH"); b.fx(null, "FLASH_RED");
Â  Â  Â  Â  b.damage(b.P, Math.floor(b.P.maxHP*0.08), {isDot:true}); b.damage(b.C, Math.floor(b.C.maxHP*0.08), {isDot:true}); return "ä¸¡ç¤¾ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ (8%)";
Â  Â  Â  }},
Â  Â  Â  { name: "Tech Bubble Burst", text: "ãƒ†ãƒƒã‚¯ãƒãƒ–ãƒ«å´©å£Š", type:"bad", func:(b)=>{Â 
Â  Â  Â  Â  Â  b.fx(null, "GLITCH"); b.fx(null, "CRASH");
Â  Â  Â  Â  Â  [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Telecom") b.spendSkill(u, 40); });
Â  Â  Â  Â  Â  return "Tech/Telecomä¼æ¥­ã®ã‚²ãƒ¼ã‚¸æ¸›å°‘ (-40)";Â 
Â  Â  Â  }},
Â  Â  Â  { name: "Supply Chain Crisis", text: "ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³æ··ä¹±", type:"bad", func:(b)=>{
Â  Â  Â  Â  Â  b.fx(null, "QUAKE");
Â  Â  Â  Â  Â  [b.P, b.C].forEach(u=>{ if(u.company.sector==="Auto"||u.company.sector==="Industrial"||u.company.sector==="Retail") b.addBuff(u, {key:"spd_down", name:"CRISIS", turns:2, meta:{spd:-0.3}}); });
Â  Â  Â  Â  Â  return "Auto/Ind/Retailã®SPDå¤§å¹…ä½ä¸‹";
Â  Â  Â  }},
Â  Â  Â  { name: "Geopolitical Tension", text: "åœ°æ”¿å­¦ãƒªã‚¹ã‚¯å¢—å¤§", type:"bad", func:(b)=>{
Â  Â  Â  Â  Â  b.fx(null, "QUAKE"); b.fx(null, "FLASH_RED");
Â  Â  Â  Â  Â  [b.P, b.C].forEach(u=>{ if(u.company.sector==="Energy"||u.company.sector==="Finance") b.addBuff(u, {key:"def_up", name:"HEDGE", turns:3, meta:{def:0.3}}); });
Â  Â  Â  Â  Â  return "Energy/FinanceãŒé˜²å¾¡æ…‹å‹¢ (DEFâ†‘)";
Â  Â  Â  }},
Â  Â  Â  { name: "AI Innovation Wave", text: "AIã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®æ³¢", type:"good", func:(b)=>{
Â  Â  Â  Â  Â  b.fx(null, "NEON"); b.fx(null, "FLASH_NEON");
Â  Â  Â  Â  Â  [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Pharma") b.addBuff(u, {key:"crit_up", name:"AI", turns:3, meta:{crit:0.25}}); });
Â  Â  Â  Â  Â  return "Tech/Pharmaã®ã‚¯ãƒªç‡ä¸Šæ˜‡";
Â  Â  Â  }},
Â  Â  Â  { name: "Subcontract Act Inspection", text: "ä¸­å°ä¼æ¥­åºãŒä¸‹è«‹æ³•æ¤œæŸ»ã‚’å®Ÿæ–½ï¼", type:"bad", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "GLITCH"); b.fx(null, "FLASH_RED");
Â  Â  Â  Â  let msg = "";
Â  Â  Â  Â  [b.P, b.C].forEach(u=>{
Â  Â  Â  Â  Â  if(["Auto","Industrial","Retail","Tech","Telecom"].includes(u.company.sector)){
Â  Â  Â  Â  Â  Â  if(Math.random() < 0.4){
Â  Â  Â  Â  Â  Â  Â  b.addBuff(u, {key:"stun", name:"STOP", turns:1, meta:{}});
Â  Â  Â  Â  Â  Â  Â  msg += `${b.nameOf(u)}ã¯å–¶æ¥­åœæ­¢å‡¦åˆ†(1ã‚¿ãƒ¼ãƒ³)ï¼ `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return msg || "æŒ‡æ‘˜äº‹é …ãªã—ã€‚";
Â  Â  Â  }},
Â  Â  Â  { name: "Tariff War", text: "ãƒˆãƒ©ãƒ³ãƒ—å‰å¤§çµ±é ˜(?)ãŒé–¢ç¨æ³•ã‚’ç™ºå‹•ï¼", type:"bad", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "CRASH"); b.fx(null, "QUAKE");
Â  Â  Â  Â  let msg = "";
Â  Â  Â  Â  [b.P, b.C].forEach(u=>{
Â  Â  Â  Â  Â  if(["Auto","Industrial","Tech"].includes(u.company.sector)){
Â  Â  Â  Â  Â  Â  if(Math.random() < 0.3){
Â  Â  Â  Â  Â  Â  Â  msg += `${b.nameOf(u)}ã¯TACO(Tuesday Taco?)ã§å›é¿ï¼ `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  const dmg = Math.floor(u.maxHP * 0.12);
Â  Â  Â  Â  Â  Â  Â  b.damage(u, dmg, {fx:"IMPACT"});
Â  Â  Â  Â  Â  Â  Â  msg += `${b.nameOf(u)}ã«é–¢ç¨ãƒ€ãƒ¡ãƒ¼ã‚¸(-${dmg}) `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return msg || "å½±éŸ¿ãªã—ã€‚";
Â  Â  Â  }},
Â  Â  Â  { name: "Embezzlement Scandal", text: "å·¨é¡æ¨ªé ˜äº‹ä»¶ãŒç™ºç”Ÿï¼", type:"bad", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "FLASH_RED"); b.fx(null, "STORM");
Â  Â  Â  Â  let msg = "";
Â  Â  Â  Â  [b.P, b.C].forEach(u=>{
Â  Â  Â  Â  Â  let chance = u.company.sector==="Finance" ? 0.5 : 0.1;
Â  Â  Â  Â  Â  if(Math.random() < chance){
Â  Â  Â  Â  Â  Â  const dmg = Math.floor(u.maxHP * 0.15);
Â  Â  Â  Â  Â  Â  b.damage(u, dmg, {isDot:true});
Â  Â  Â  Â  Â  Â  b.addBuff(u, {key:"def_down", name:"SCANDAL", turns:3, meta:{def:-0.25}});
Â  Â  Â  Â  Â  Â  msg += `${b.nameOf(u)}ã§ä¸ç¥¥äº‹ç™ºè¦šï¼ä¿¡ç”¨å¤±å¢œ(-${dmg}, DEFâ†“) `;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return msg || "å†…éƒ¨çµ±åˆ¶ã¯æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã€‚";
Â  Â  Â  }},
Â  Â  Â  { name: "China Shock", text: "ä¸­å›½å¸‚å ´ã‹ã‚‰ã®ä½™å‰°æãŒæµå…¥ï¼", type:"bad", func:(b)=>{
Â  Â  Â  Â  b.fx(null, "WAVE"); b.fx(null, "QUAKE");
Â  Â  Â  Â  let msg = "";
Â  Â  Â  Â  [b.P, b.C].forEach(u=>{
Â  Â  Â  Â  Â  if(["Industrial","Auto","Tech"].includes(u.company.sector)){
Â  Â  Â  Â  Â  Â  b.addBuff(u, {key:"atk_down", name:"DUMPING", turns:3, meta:{atk:-0.2}});
Â  Â  Â  Â  Â  Â  const dmg = Math.floor(u.maxHP * 0.05);
Â  Â  Â  Â  Â  Â  b.damage(u, dmg);
Â  Â  Â  Â  Â  Â  msg += `${b.nameOf(u)}ã¯ä¾¡æ ¼ç«¶äº‰ã«å·»ãè¾¼ã¾ã‚ŒãŸ(-${dmg}, ATKâ†“) `;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return msg || "å¸‚å ´ã¸ã®å½±éŸ¿ã¯è»½å¾®ã€‚";
Â  Â  Â  }}
Â  Â  ];

    const SECTOR_SKILLS = {
      Tech: {
        name: "Quantum Launch",
        desc: "AI/æ–°è£½å“ã§å¸‚å ´ã‚’ç„¼ãå°½ãã™ï¼ˆå¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹ã‚¯ãƒªç‡UPï¼‰",
        fx: "NEON",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"crit_up", name:"CRITâ†‘", turns:2, meta:{crit:0.14}});
          return {mult: 1.75, pierce: 0.10};
        }
      },
      Auto: {
        name: "Supply Chain Blitz",
        desc: "ä¾›çµ¦ç¶²æœ€é©åŒ–ï¼ˆä¸­ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹è‡ªå·±å›å¾©ï¼‰",
        fx: "SPARK",
        apply: (ctx)=> {
          const heal = Math.floor(ctx.user.maxHP * 0.08);
          ctx.heal(ctx.user, heal, "SC BLITZ");
          return {mult: 1.45, pierce: 0.05};
        }
      },
      Finance: {
        name: "Capital Shield",
        desc: "è³‡æœ¬æ”¿ç­–ï¼ˆå°ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹å¼·Guardï¼‰",
        fx: "AURA",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"guard", name:"GUARD+", turns:2, meta:{dr:0.55, def:0.18}});
          return {mult: 1.10, pierce: 0.00};
        }
      },
      Retail: {
        name: "Brand Surge",
        desc: "ãƒ–ãƒ©ãƒ³ãƒ‰æ—‹é¢¨ï¼ˆä¸­ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹SPDä¸Šæ˜‡ï¼‰",
        fx: "WAVE",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"spd_up", name:"SPDâ†‘", turns:3, meta:{spd:0.18}});
          return {mult: 1.35, pierce: 0.02};
        }
      },
      Telecom: {
        name: "Network Jam",
        desc: "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¦¨å®³ï¼ˆä¸­ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹æ•µSPDä½ä¸‹ï¼‰",
        fx: "GLITCH",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"spd_down", name:"SPDâ†“", turns:2, meta:{spd:-0.20}});
          return {mult: 1.30, pierce: 0.06};
        }
      },
      Industrial: {
        name: "Lean Strike",
        desc: "æ”¹å–„æ´»å‹•ï¼ˆä¸­ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹DEFä¸Šæ˜‡ï¼‰",
        fx: "IMPACT",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"def_up", name:"DEFâ†‘", turns:3, meta:{def:0.20}});
          return {mult: 1.30, pierce: 0.04};
        }
      },
      Pharma: {
        name: "Patent Storm",
        desc: "ç‰¹è¨±ãƒ»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆå¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹ç¶™ç¶šåœ§åŠ›ï¼‰",
        fx: "STORM",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"bleed", name:"PIPELINE", turns:3, meta:{dot:0.035}});
          return {mult: 1.60, pierce: 0.08};
        }
      },
      Energy: {
        name: "Grid Overload",
        desc: "ã‚¤ãƒ³ãƒ•ãƒ©å¼·åˆ¶ï¼ˆä¸­ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹æ•µDEFä½ä¸‹ï¼‰",
        fx: "ARC",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"def_down", name:"DEFâ†“", turns:2, meta:{def:-0.18}});
          return {mult: 1.35, pierce: 0.06};
        }
      }
    };

    /********************
     * SAMPLE DATA (approx; billion JPY)
     * cash / market_cap / rnd are in "billion JPY"
     ********************/
const SAMPLE_COMPANIES = [
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-toyota",
Â  Â  Â  Â  name:"Toyota Motor", name_jp:"ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š", domain:"toyota.co.jp", sector:"Auto", currency:"JPY",
Â  Â  Â  Â  cash: 8500, operating_margin: 10.0, equity_ratio: 40.0, market_cap: 45000, employees: 375000, rnd: 1200,
Â  Â  Â  Â  skill_name: "KAIZEN Flow", skill_desc: "ã€æ”¹å–„ã€ã®é€£é–ã«ã‚ˆã‚‹ç¥é€Ÿã®ä¾›çµ¦ç¶²", skill_type: "SPEED",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Just-in-Time", desc:"åœ¨åº«ã‚¼ãƒ­ã®è¶…åŠ¹ç‡ä¾›çµ¦"},
Â  Â  Â  Â  Â  {name:"Hybrid Drive", desc:"å…¨æ–¹ä½æˆ¦ç•¥ã®ã‚·ãƒŠã‚¸ãƒ¼"},
Â  Â  Â  Â  Â  {name:"Andon Cord", desc:"å“è³ªç•°å¸¸ã‚’å³åº§ã«æ¤œçŸ¥"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-sony",
Â  Â  Â  Â  name:"Sony Group", name_jp:"ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—", domain:"sony.com", sector:"Tech", currency:"JPY",
Â  Â  Â  Â  cash: 3200, operating_margin: 12.0, equity_ratio: 35.0, market_cap: 18000, employees: 110000, rnd: 900,
Â  Â  Â  Â  skill_name: "Kando Resonance", skill_desc: "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã¨æ„Ÿå‹•ã®èåˆã§å¸‚å ´ã‚’å¸­å·»", skill_type: "BURST",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"CMOS Sensor", desc:"ä¸–ç•ŒNo.1ã‚·ã‚§ã‚¢ã®çœ¼"},
Â  Â  Â  Â  Â  {name:"Content IP", desc:"ã‚²ãƒ¼ãƒ ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ»éŸ³æ¥½ã®è¤‡åˆåŠ›"},
Â  Â  Â  Â  Â  {name:"Hardware Design", desc:"æ´—ç·´ã•ã‚ŒãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-keyence",
Â  Â  Â  Â  name:"KEYENCE", name_jp:"ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹", domain:"keyence.co.jp", sector:"Industrial", currency:"JPY",
Â  Â  Â  Â  cash: 2400, operating_margin: 52.0, equity_ratio: 88.0, market_cap: 17000, employees: 9000, rnd: 120,
Â  Â  Â  Â  skill_name: "Super High Margin", skill_desc: "åœ§å€’çš„ä»˜åŠ ä¾¡å€¤ã§åˆ©ç›Šã‚’å¸ã„ä¸Šã’ã‚‹", skill_type: "DRAIN",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Direct Sales", desc:"ä»£ç†åº—ã‚’é€šã•ãªã„ç›´è²©ä½“åˆ¶"},
Â  Â  Â  Â  Â  {name:"Consultative", desc:"æ½œåœ¨ãƒ‹ãƒ¼ã‚ºã‚’æ˜ã‚Šèµ·ã“ã™ææ¡ˆ"},
Â  Â  Â  Â  Â  {name:"Same Day Ship", desc:"å³ç´ä½“åˆ¶ã«ã‚ˆã‚‹æ©Ÿä¼šæå¤±ã‚¼ãƒ­"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-fastretailing",
Â  Â  Â  Â  name:"Fast Retailing", name_jp:"ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°", domain:"fastretailing.com", sector:"Retail", currency:"JPY",
Â  Â  Â  Â  cash: 1100, operating_margin: 16.0, equity_ratio: 55.0, market_cap: 12000, employees: 60000, rnd: 80,
Â  Â  Â  Â  skill_name: "LifeWear Platform", skill_desc: "ã‚ã‚‰ã‚†ã‚‹ç”Ÿæ´»ã«æµ¸é€ã™ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©åŒ–", skill_type: "BUFF",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"SPA Model", desc:"ä¼ç”»ã‹ã‚‰è²©å£²ã¾ã§ä¸€æ°—é€šè²«"},
Â  Â  Â  Â  Â  {name:"Global Flagship", desc:"ä¸–ç•Œä¸»è¦éƒ½å¸‚ã¸ã®å‡ºåº—æ”»å‹¢"},
Â  Â  Â  Â  Â  {name:"Functional Fabric", desc:"ãƒ’ãƒ¼ãƒˆãƒ†ãƒƒã‚¯ç­‰ã®ç´ æé©æ–°"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-softbank",
Â  Â  Â  Â  name:"SoftBank Group", name_jp:"ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—", domain:"softbank.jp", sector:"Telecom", currency:"JPY",
Â  Â  Â  Â  cash: 4200, operating_margin: 9.0, equity_ratio: 24.0, market_cap: 9000, employees: 65000, rnd: 300,
Â  Â  Â  Â  skill_name: "Unicorn Bet", skill_desc: "ç¾¤é›†å¿ƒç†ã‚’æ“ã‚‹ãƒã‚¤ãƒªã‚¹ã‚¯æŠ•è³‡", skill_type: "BURST",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Vision Fund", desc:"å·¨é¡è³‡æœ¬ã«ã‚ˆã‚‹å¸‚å ´ãƒ¬ãƒãƒ¬ãƒƒã‚¸"},
Â  Â  Â  Â  Â  {name:"Arm Chip", desc:"åŠå°ä½“è¨­è¨ˆã®ç‹¬å çš„åœ°ä½"},
Â  Â  Â  Â  Â  {name:"Debt Leverage", desc:"å€Ÿå…¥ã‚’æœ€å¤§æ´»ç”¨ã—ãŸæ‹¡å¤§"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-recruit",
Â  Â  Â  Â  name:"Recruit Holdings", name_jp:"ãƒªã‚¯ãƒ«ãƒ¼ãƒˆãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹", domain:"recruit.co.jp", sector:"Tech", currency:"JPY",
Â  Â  Â  Â  cash: 1400, operating_margin: 18.0, equity_ratio: 50.0, market_cap: 10000, employees: 51000, rnd: 250,
Â  Â  Â  Â  skill_name: "Ribbon Matching", skill_desc: "ãƒªãƒœãƒ³ãƒ¢ãƒ‡ãƒ«ã§å¸‚å ´ã®è‡ªç”±åº¦ã‚’æ”¯é…", skill_type: "JAM",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Ribbon Model", desc:"ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å›²ã„è¾¼ã¿"},
Â  Â  Â  Â  Â  {name:"Global HR", desc:"Indeedç­‰ã«ã‚ˆã‚‹ä¸–ç•Œçš„æ±‚äººç¶²"},
Â  Â  Â  Â  Â  {name:"Entrepreneurship", desc:"ç¤¾å†…èµ·æ¥­å®¶ã«ã‚ˆã‚‹æ–°è¦äº‹æ¥­"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-ntt",
Â  Â  Â  Â  name:"NTT", name_jp:"æ—¥æœ¬é›»ä¿¡é›»è©±ï¼ˆNTTï¼‰", domain:"ntt.co.jp", sector:"Telecom", currency:"JPY",
Â  Â  Â  Â  cash: 1700, operating_margin: 16.0, equity_ratio: 28.0, market_cap: 14000, employees: 320000, rnd: 500,
Â  Â  Â  Â  skill_name: "Optical Shield", skill_desc: "å…‰æ§‹æƒ³(IOWN)ã«ã‚ˆã‚‹é‰„å£ã®é€šä¿¡è¦å¡", skill_type: "GUARD",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"IOWN Concept", desc:"æ¬¡ä¸–ä»£å…‰é€šä¿¡åŸºç›¤"},
Â  Â  Â  Â  Â  {name:"Real Estate", desc:"è†¨å¤§ãªä¿æœ‰ä¸å‹•ç”£ã®æ´»ç”¨"},
Â  Â  Â  Â  Â  {name:"Stable Dividend", desc:"å®‰å®šé…å½“ã«ã‚ˆã‚‹æ ªä¸»æ±‚å¿ƒåŠ›"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-mufg",
Â  Â  Â  Â  name:"MUFG", name_jp:"ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—", domain:"mufg.jp", sector:"Finance", currency:"JPY",
Â  Â  Â  Â  cash: 6000, operating_margin: 6.0, equity_ratio: 6.0, market_cap: 16000, employees: 160000, rnd: 90,
Â  Â  Â  Â  skill_name: "Red Bank Vault", skill_desc: "ç›¤çŸ³ãªè³‡æœ¬åŸºç›¤ã«ã‚ˆã‚‹å®Œå…¨é˜²å¾¡", skill_type: "GUARD",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Global Network", desc:"æµ·å¤–éŠ€è¡Œè²·åã«ã‚ˆã‚‹å¤šè§’åŒ–"},
Â  Â  Â  Â  Â  {name:"Main Bank", desc:"åœ§å€’çš„ãªæ³•äººé¡§å®¢åŸºç›¤"},
Â  Â  Â  Â  Â  {name:"Cross-Selling", desc:"ã‚°ãƒ«ãƒ¼ãƒ—ç·åˆåŠ›ã«ã‚ˆã‚‹ææ¡ˆ"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-hitachi",
Â  Â  Â  Â  name:"Hitachi", name_jp:"æ—¥ç«‹è£½ä½œæ‰€", domain:"hitachi.com", sector:"Industrial", currency:"JPY",
Â  Â  Â  Â  cash: 1500, operating_margin: 9.5, equity_ratio: 32.0, market_cap: 12000, employees: 320000, rnd: 450,
Â  Â  Â  Â  skill_name: "Lumada Grid", skill_desc: "ç¤¾ä¼šã‚¤ãƒ³ãƒ•ãƒ©DXã§ã˜ã‚ã˜ã‚ä¾µé£Ÿ", skill_type: "DOT",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Lumada", desc:"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¾¡å€¤ã«å¤‰ãˆã‚‹DX"},
Â  Â  Â  Â  Â  {name:"Portfolio Shuffle", desc:"äº‹æ¥­ã®é¸æŠã¨é›†ä¸­"},
Â  Â  Â  Â  Â  {name:"Green Energy", desc:"é€é›»ãƒ»é‰„é“ãªã©ã®ç’°å¢ƒã‚¤ãƒ³ãƒ•ãƒ©"}
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  id:"jp-takeda",
Â  Â  Â  Â  name:"Takeda", name_jp:"æ­¦ç”°è–¬å“å·¥æ¥­", domain:"takeda.com", sector:"Pharma", currency:"JPY",
Â  Â  Â  Â  cash: 900, operating_margin: 14.0, equity_ratio: 28.0, market_cap: 6000, employees: 50000, rnd: 480,
Â  Â  Â  Â  skill_name: "Shonan Pipeline", skill_desc: "å‰µè–¬ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã§æ´»åŠ›ã‚’å¸å", skill_type: "DRAIN",
Â  Â  Â  Â  attacks: [
Â  Â  Â  Â  Â  {name:"Mega M&A", desc:"å·¨é¡è²·åã«ã‚ˆã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç²å¾—"},
Â  Â  Â  Â  Â  {name:"Rare Disease", desc:"å¸Œå°‘ç–¾æ‚£é ˜åŸŸã¸ã®é›†ä¸­"},
Â  Â  Â  Â  Â            {name:"Global Trials", desc:"ä¸–ç•Œè¦æ¨¡ã®æ²»é¨“ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"}
        ]
      },
      /* --- è¿½åŠ : é‰„é‹¼ (Steel / Industrial) --- */
      {
        id:"jp-nipponsteel",
        name:"Nippon Steel", name_jp:"æ—¥æœ¬è£½é‰„", domain:"nipponsteel.com", sector:"Industrial", currency:"JPY",
        cash: 900, operating_margin: 10.5, equity_ratio: 45.0, market_cap: 3500, employees: 100000, rnd: 100,
        skill_name: "Blast Furnace", skill_desc: "é«˜ç‚‰ã®åœ§å€’çš„ç†±é‡ã§å…¨ã¦ã‚’æº¶ã‹ã™", skill_type: "BURST",
        attacks: [{name:"Green Steel", desc:"è„±ç‚­ç´ é‹¼æ"}, {name:"US Steel Buy", desc:"å·¨é¡è²·å"}, {name:"Seamless Pipe", desc:"ç¶™ç›®ç„¡é‹¼ç®¡"}]
      },
      {
        id:"jp-jfe",
        name:"JFE Holdings", name_jp:"JFEãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹", domain:"jfe-holdings.co.jp", sector:"Industrial", currency:"JPY",
        cash: 300, operating_margin: 7.0, equity_ratio: 38.0, market_cap: 1400, employees: 64000, rnd: 80,
        skill_name: "Only One Tech", skill_desc: "ç‹¬è‡ªæŠ€è¡“ã«ã‚ˆã‚‹é«˜ä»˜åŠ ä¾¡å€¤è£½å“", skill_type: "BUFF",
        attacks: [{name:"JGreeX", desc:"ã‚°ãƒªãƒ¼ãƒ³é‹¼æ"}, {name:"Engineering", desc:"ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°åŠ›"}, {name:"Plate Mill", desc:"åšæ¿åœ§å»¶"}]
      },
      {
        id:"jp-kobelco",
        name:"Kobe Steel", name_jp:"ç¥æˆ¸è£½é‹¼æ‰€", domain:"kobelco.co.jp", sector:"Industrial", currency:"JPY",
        cash: 250, operating_margin: 6.0, equity_ratio: 35.0, market_cap: 700, employees: 40000, rnd: 60,
        skill_name: "Hybrid Material", skill_desc: "é‰„ãƒ»ã‚¢ãƒ«ãƒŸãƒ»éŠ…ã®è¤‡åˆç´ æåŠ›", skill_type: "GUARD",
        attacks: [{name:"Aluminum", desc:"è‡ªå‹•è»Šç”¨ã‚¢ãƒ«ãƒŸ"}, {name:"Compressor", desc:"éæ±ç”¨åœ§ç¸®æ©Ÿ"}, {name:"Electric Power", desc:"é›»åŠ›å¸ä¾›çµ¦"}]
      },
      {
        id:"jp-yamatokogyo",
        name:"Yamato Kogyo", name_jp:"å¤§å’Œå·¥æ¥­", domain:"yamatokogyo.co.jp", sector:"Industrial", currency:"JPY",
        cash: 150, operating_margin: 20.0, equity_ratio: 80.0, market_cap: 500, employees: 2000, rnd: 10,
        skill_name: "H-Beam Profit", skill_desc: "Hå½¢é‹¼ã«ç‰¹åŒ–ã—ãŸé«˜åç›Šä½“è³ª", skill_type: "DRAIN",
        attacks: [{name:"EAF Eco", desc:"é›»ç‚‰ã«ã‚ˆã‚‹ãƒªã‚µã‚¤ã‚¯ãƒ«"}, {name:"Global Niche", desc:"æµ·å¤–åˆå¼æˆ¦ç•¥"}, {name:"Debt Free", desc:"ç„¡å€Ÿé‡‘çµŒå–¶"}]
      },
      {
        id:"jp-tokyosteel",
        name:"Tokyo Steel", name_jp:"æ±äº¬è£½éµ", domain:"tokyosteel.co.jp", sector:"Industrial", currency:"JPY",
        cash: 80, operating_margin: 12.0, equity_ratio: 75.0, market_cap: 200, employees: 1000, rnd: 5,
        skill_name: "Scrap Recycle", skill_desc: "è³‡æºå¾ªç’°ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆç«¶äº‰åŠ›", skill_type: "SPEED",
        attacks: [{name:"Electric Arc", desc:"å›½å†…æœ€å¤§ç´šã®é›»ç‚‰"}, {name:"Green Pricing", desc:"ç’°å¢ƒä¾¡å€¤ã®æä¾›"}, {name:"Low Cost", desc:"å¾¹åº•ã—ãŸã‚³ã‚¹ãƒˆç®¡ç†"}]
      },
      /* --- è¿½åŠ : å°å£² (Retail) --- */
      {
        id:"jp-seven",
        name:"Seven & i", name_jp:"ã‚»ãƒ–ãƒ³ï¼†ã‚¢ã‚¤", domain:"7andi.com", sector:"Retail", currency:"JPY",
        cash: 1800, operating_margin: 5.0, equity_ratio: 35.0, market_cap: 5500, employees: 80000, rnd: 50,
        skill_name: "Global Franchise", skill_desc: "ä¸–ç•Œæœ€å¼·ã®CVSç¶²ã«ã‚ˆã‚‹æ”¯é…", skill_type: "BUFF",
        attacks: [{name:"Premium PB", desc:"ã‚»ãƒ–ãƒ³ãƒ—ãƒ¬ãƒŸã‚¢ãƒ "}, {name:"Speedway", desc:"åŒ—ç±³ã‚³ãƒ³ãƒ“ãƒ‹è²·å"}, {name:"Otsuka", desc:"ãƒ‡ãƒ‘åœ°ä¸‹æƒ£èœ"}]
      },
      {
        id:"jp-aeon",
        name:"AEON", name_jp:"ã‚¤ã‚ªãƒ³", domain:"aeon.info", sector:"Retail", currency:"JPY",
        cash: 1500, operating_margin: 3.0, equity_ratio: 10.0, market_cap: 3000, employees: 160000, rnd: 120,
        skill_name: "Mall Domination", skill_desc: "ç”Ÿæ´»åœã‚’å¡—ã‚Šæ›¿ãˆã‚‹å·¨å¤§ãƒ¢ãƒ¼ãƒ«", skill_type: "GUARD",
        attacks: [{name:"Top Valu", desc:"åœ§å€’çš„å®‰ã•ã®PB"}, {name:"Financial Svc", desc:"ã‚¤ã‚ªãƒ³éŠ€è¡Œãƒ»ã‚«ãƒ¼ãƒ‰"}, {name:"WAON", desc:"é›»å­ãƒãƒãƒ¼å›²ã„è¾¼ã¿"}]
      },
      {
        id:"jp-nitori",
        name:"Nitori", name_jp:"ãƒ‹ãƒˆãƒªHD", domain:"nitori.co.jp", sector:"Retail", currency:"JPY",
        cash: 300, operating_margin: 15.0, equity_ratio: 80.0, market_cap: 2000, employees: 18000, rnd: 20,
        skill_name: "Oteidan Price", skill_desc: "ãŠã€ã­ã ã‚“ä»¥ä¸Šã€‚ã®ç ´å£ŠåŠ›", skill_type: "DOT",
        attacks: [{name:"Vertical Integration", desc:"è£½é€ ç‰©æµå°å£²æ¥­"}, {name:"Global Sourcing", desc:"æµ·å¤–é–‹ç™ºè¼¸å…¥"}, {name:"M&A Shimachu", desc:"ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼çµ±åˆ"}]
      },
      {
        id:"jp-panpac",
        name:"PPIH", name_jp:"ãƒ‘ãƒ³ãƒ»ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯(ãƒ‰ãƒ³ã‚­)", domain:"ppih.co.jp", sector:"Retail", currency:"JPY",
        cash: 200, operating_margin: 6.0, equity_ratio: 30.0, market_cap: 2200, employees: 18000, rnd: 10,
        skill_name: "Jungle Display", skill_desc: "åœ§ç¸®é™³åˆ—ã«ã‚ˆã‚‹è³¼è²·æ„æ¬²åˆºæ¿€", skill_type: "JAM",
        attacks: [{name:"Majica", desc:"ä¼šå“¡ã‚¢ãƒ—ãƒªæˆ¦ç•¥"}, {name:"Inbound", desc:"è¨ªæ—¥å®¢éœ€è¦çˆ†ç™º"}, {name:"Giga Pearl", desc:"æµ·å¤–å±•é–‹"}]
      },
      {
        id:"jp-matsukiyo",
        name:"MatsukiyoCocokara", name_jp:"ãƒãƒ„ã‚­ãƒ¨ã‚³ã‚³ã‚«ãƒ©", domain:"matsukiyococokara.com", sector:"Retail", currency:"JPY",
        cash: 150, operating_margin: 6.5, equity_ratio: 60.0, market_cap: 1100, employees: 20000, rnd: 5,
        skill_name: "Digital Makeup", skill_desc: "ãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚ˆã‚‹åŒ–ç²§å“è²©å£²", skill_type: "SPEED",
        attacks: [{name:"High Profit PB", desc:"é«˜åˆ©ç›Šç‡PBå•†å“"}, {name:"App Marketing", desc:"ã‚¢ãƒ—ãƒªä¼šå“¡åŸºç›¤"}, {name:"Urban Dominance", desc:"é§…å‰ç«‹åœ°åˆ¶åœ§"}]
      },
      /* --- è¿½åŠ : é‰„é“ (Industrial / Infra) --- */
      {
        id:"jp-jreast",
        name:"JR East", name_jp:"JRæ±æ—¥æœ¬", domain:"jreast.co.jp", sector:"Industrial", currency:"JPY",
        cash: 400, operating_margin: 12.0, equity_ratio: 35.0, market_cap: 3200, employees: 70000, rnd: 60,
        skill_name: "Suica Network", skill_desc: "äº¤é€šç³»ICã«ã‚ˆã‚‹ç”Ÿæ´»åœæ”¯é…", skill_type: "SPEED",
        attacks: [{name:"Shinkansen", desc:"é«˜é€Ÿé‰„é“ç¶²"}, {name:"Ekinaka", desc:"é§…ãƒŠã‚«ä¸å‹•ç”£äº‹æ¥­"}, {name:"JRE Point", desc:"ãƒã‚¤ãƒ³ãƒˆçµŒæ¸ˆåœ"}]
      },
      {
        id:"jp-jrcentral",
        name:"JR Central", name_jp:"JRæ±æµ·", domain:"jr-central.co.jp", sector:"Industrial", currency:"JPY",
        cash: 600, operating_margin: 35.0, equity_ratio: 40.0, market_cap: 3500, employees: 18000, rnd: 30,
        skill_name: "Linear Motor", skill_desc: "è¶…é›»å°ãƒªãƒ‹ã‚¢ã«ã‚ˆã‚‹æœªæ¥ã¸ã®æŠ•è³‡", skill_type: "BURST",
        attacks: [{name:"Tokaido", desc:"ãƒ‰ãƒ«ç®±ãƒ»æ±æµ·é“æ–°å¹¹ç·š"}, {name:"Express Res", desc:"EXäºˆç´„ã‚·ã‚¹ãƒ†ãƒ "}, {name:"Cash Cow", desc:"åœ§å€’çš„åˆ©ç›Šç‡"}]
      },
      {
        id:"jp-jrwest",
        name:"JR West", name_jp:"JRè¥¿æ—¥æœ¬", domain:"westjr.co.jp", sector:"Industrial", currency:"JPY",
        cash: 250, operating_margin: 10.0, equity_ratio: 30.0, market_cap: 1400, employees: 45000, rnd: 20,
        skill_name: "Rapid Network", skill_desc: "äº¬é˜ªç¥ã‚¢ãƒ¼ãƒãƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", skill_type: "SPEED",
        attacks: [{name:"Sanyo Shinkansen", desc:"å±±é™½æ–°å¹¹ç·š"}, {name:"Inbound Kansai", desc:"é–¢è¥¿è¦³å…‰éœ€è¦"}, {name:"Real Estate", desc:"å¤§é˜ªé§…é–‹ç™º"}]
      },
      {
        id:"jp-tokyu",
        name:"Tokyu", name_jp:"æ±æ€¥", domain:"tokyu.co.jp", sector:"Industrial", currency:"JPY",
        cash: 100, operating_margin: 8.0, equity_ratio: 25.0, market_cap: 1100, employees: 5000, rnd: 10,
        skill_name: "Transit Oriented", skill_desc: "é‰„é“Ã—éƒ½å¸‚é–‹ç™ºã®ç›¸ä¹—åŠ¹æœ", skill_type: "BUFF",
        attacks: [{name:"Shibuya Dev", desc:"æ¸‹è°·å†é–‹ç™º"}, {name:"Den-en-toshi", desc:"æ²¿ç·šä¾¡å€¤å‘ä¸Š"}, {name:"Hotels", desc:"ãƒ›ãƒ†ãƒ«äº‹æ¥­"}]
      },
      {
        id:"jp-hankyu",
        name:"Hankyu Hanshin", name_jp:"é˜ªæ€¥é˜ªç¥HD", domain:"hankyu-hanshin.co.jp", sector:"Industrial", currency:"JPY",
        cash: 120, operating_margin: 11.0, equity_ratio: 30.0, market_cap: 1200, employees: 22000, rnd: 5,
        skill_name: "Entertainment City", skill_desc: "å®å¡šãƒ»è™ãƒ»éƒ½å¸‚ã®ã‚¨ãƒ³ã‚¿ãƒ¡è¤‡åˆ", skill_type: "JAM",
        attacks: [{name:"Takarazuka", desc:"å®å¡šæ­ŒåŠ‡å›£"}, {name:"Tigers", desc:"é˜ªç¥ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¹"}, {name:"Umeda", desc:"æ¢…ç”°ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ"}]
      },
      /* --- è¿½åŠ : ã‚¨ãƒãƒ«ã‚®ãƒ¼ (Energy) --- */
      {
        id:"jp-eneos",
        name:"ENEOS", name_jp:"ENEOS HD", domain:"eneos.co.jp", sector:"Energy", currency:"JPY",
        cash: 600, operating_margin: 3.5, equity_ratio: 30.0, market_cap: 2200, employees: 40000, rnd: 50,
        skill_name: "Energy Flow", skill_desc: "å›½å†…æœ€å¤§ã‚·ã‚§ã‚¢ã®ç‡ƒæ–™ä¾›çµ¦ç¶²", skill_type: "BUFF",
        attacks: [{name:"SS Network", desc:"ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"}, {name:"Hydrogen", desc:"æ°´ç´ ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³"}, {name:"Copper", desc:"éŠ…é‰±å±±é–‹ç™º"}]
      },
      {
        id:"jp-inpex",
        name:"INPEX", name_jp:"INPEX", domain:"inpex.co.jp", sector:"Energy", currency:"JPY",
        cash: 400, operating_margin: 45.0, equity_ratio: 60.0, market_cap: 2800, employees: 3000, rnd: 20,
        skill_name: "Ichthys LNG", skill_desc: "è±ªå·å·¨å¤§ã‚¬ã‚¹ç”°ã‹ã‚‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥", skill_type: "BURST",
        attacks: [{name:"Upstream", desc:"è³‡æºé–‹ç™ºæ¨©ç›Š"}, {name:"Net Zero", desc:"CCS/CCUSæŠ€è¡“"}, {name:"Dividends", desc:"é«˜é…å½“é‚„å…ƒ"}]
      },
      {
        id:"jp-idemitsu",
        name:"Idemitsu", name_jp:"å‡ºå…‰èˆˆç”£", domain:"idemitsu.com", sector:"Energy", currency:"JPY",
        cash: 200, operating_margin: 4.0, equity_ratio: 35.0, market_cap: 1100, employees: 14000, rnd: 30,
        skill_name: "Apollo Station", skill_desc: "åœ°åŸŸå¯†ç€ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼æ‹ ç‚¹", skill_type: "SPEED",
        attacks: [{name:"Solid Battery", desc:"å…¨å›ºä½“é›»æ± ç´ æ"}, {name:"OLED", desc:"æœ‰æ©ŸELææ–™"}, {name:"Refining", desc:"è£½æ²¹æ‰€æœ€é©åŒ–"}]
      },
      {
        id:"jp-kanden",
        name:"Kansai Electric", name_jp:"é–¢è¥¿é›»åŠ›", domain:"kepco.co.jp", sector:"Energy", currency:"JPY",
        cash: 300, operating_margin: 10.0, equity_ratio: 20.0, market_cap: 2000, employees: 30000, rnd: 15,
        skill_name: "Base Load Power", skill_desc: "åŸå­åŠ›ç™ºé›»ã«ã‚ˆã‚‹å®‰å®šä¾›çµ¦", skill_type: "GUARD",
        attacks: [{name:"Nuclear", desc:"åŸç™ºå†ç¨¼åƒ"}, {name:"Optiage", desc:"eoå…‰é€šä¿¡äº‹æ¥­"}, {name:"Real Estate", desc:"é–¢é›»ä¸å‹•ç”£"}]
      },
      {
        id:"jp-tokyogas",
        name:"Tokyo Gas", name_jp:"æ±äº¬ã‚¬ã‚¹", domain:"tokyo-gas.co.jp", sector:"Energy", currency:"JPY",
        cash: 150, operating_margin: 8.0, equity_ratio: 40.0, market_cap: 1600, employees: 16000, rnd: 10,
        skill_name: "Smart Energy", skill_desc: "é¦–éƒ½åœã‚’æ”¯ãˆã‚‹ã‚¬ã‚¹å°ç®¡ç¶²", skill_type: "DOT",
        attacks: [{name:"LNG Trading", desc:"LNGèª¿é”åŠ›"}, {name:"Compass", desc:"æ–°äº‹æ¥­å‰µé€ "}, {name:"Decarbon", desc:"ãƒ¡ã‚¿ãƒãƒ¼ã‚·ãƒ§ãƒ³æŠ€è¡“"}]
      },
      /* --- è¿½åŠ : ãƒ™ãƒ³ãƒãƒ£ãƒ¼ (Venture / Mixed) --- */
      {
        id:"jp-akari",
        name:"Akari", name_jp:"ç‡ˆ (Akari)", domain:"akariinc.co.jp", sector:"Tech", currency:"JPY",
        cash: 5, operating_margin: 25.0, equity_ratio: 80.0, market_cap: 30, employees: 100, rnd: 10,
        skill_name: "DX Construction", skill_desc: "å»ºè¨­æ¥­ç‰¹åŒ–ã®æ±å¤§ç™ºAI", skill_type: "JAM",
        attacks: [{name:"Deep Learning", desc:"é«˜åº¦ç”»åƒèªè­˜"}, {name:"Consulting", desc:"DXã‚³ãƒ³ã‚µãƒ«"}, {name:"Speed Dev", desc:"é«˜é€Ÿé–‹ç™º"}]
      },
      {
        id:"jp-hikari",
        name:"Hikari Tsushin", name_jp:"å…‰é€šä¿¡", domain:"hikari.co.jp", sector:"Telecom", currency:"JPY",
        cash: 400, operating_margin: 18.0, equity_ratio: 40.0, market_cap: 1200, employees: 5000, rnd: 5,
        skill_name: "Recurring Rev", skill_desc: "æœ€å¼·ã®å–¶æ¥­éƒ¨éšŠã¨ã‚¹ãƒˆãƒƒã‚¯åç›Š", skill_type: "DOT",
        attacks: [{name:"Cold Calling", desc:"é›»è©±å–¶æ¥­éƒ¨éšŠ"}, {name:"Stock Portfolio", desc:"ä¸Šå ´æ ªæŠ•è³‡"}, {name:"Insurance", desc:"ä¿é™ºä»£ç†åº—"}]
      },
      {
        id:"jp-openhouse",
        name:"Open House", name_jp:"ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¦ã‚¹", domain:"openhouse-group.co.jp", sector:"Retail", currency:"JPY",
        cash: 300, operating_margin: 11.0, equity_ratio: 40.0, market_cap: 600, employees: 5000, rnd: 5,
        skill_name: "Ready-built Home", skill_desc: "éƒ½å¿ƒå¥½ç«‹åœ°ãƒ»ä½ä¾¡æ ¼ã®ç ´å£ŠåŠ›", skill_type: "SPEED",
        attacks: [{name:"Sales Power", desc:"æºæ³‰å–¶æ¥­"}, {name:"Tochinika", desc:"è¡Œã“ã†ãœã€è¡—ã¸ã€‚"}, {name:"US Real Estate", desc:"ç±³å›½ä¸å‹•ç”£"}]
      },
      {
        id:"jp-gmo",
        name:"GMO Internet", name_jp:"GMOã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", domain:"gmo.jp", sector:"Tech", currency:"JPY",
        cash: 250, operating_margin: 12.0, equity_ratio: 10.0, market_cap: 300, employees: 7000, rnd: 20,
        skill_name: "Mining Hash", skill_desc: "ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»é‡‘èãƒ»æš—å·è³‡ç”£ã®ã‚³ãƒ³ã‚°ãƒ­ãƒãƒªãƒƒãƒˆ", skill_type: "BURST",
        attacks: [{name:"Domain/Host", desc:"å›½å†…No.1ã‚¤ãƒ³ãƒ•ãƒ©"}, {name:"FX Trading", desc:"ä¸–ç•Œä¸€ã®FXå–å¼•é«˜"}, {name:"Crypto", desc:"ãƒã‚¤ãƒ‹ãƒ³ã‚°ãƒ»å–å¼•æ‰€"}]
      },
      {
        id:"jp-mercari",
        name:"Mercari", name_jp:"ãƒ¡ãƒ«ã‚«ãƒª", domain:"mercari.com", sector:"Tech", currency:"JPY",
        cash: 180, operating_margin: 8.0, equity_ratio: 25.0, market_cap: 350, employees: 2000, rnd: 40,
        skill_name: "Circular Economy", skill_desc: "å¾ªç’°å‹ç¤¾ä¼šã‚’ä½œã‚‹C2Cãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ", skill_type: "SPEED",
        attacks: [{name:"Listing", desc:"æœˆé–“2000ä¸‡äººåˆ©ç”¨"}, {name:"Merpay", desc:"é‡‘èã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ "}, {name:"US Expansion", desc:"ç±³å›½äº‹æ¥­"}]
      }
    ];

    /********************
     * IndexedDB
     ********************/
    const DB_NAME = "corporate_quest_db";
    const DB_VER = 1;
    const STORE_COMP = "companies";
    const STORE_META = "meta";

    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = (e)=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE_COMP)){
            db.createObjectStore(STORE_COMP, {keyPath:"id"});
          }
          if(!db.objectStoreNames.contains(STORE_META)){
            db.createObjectStore(STORE_META, {keyPath:"key"});
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function dbGetAll(store){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readonly");
        const st = tx.objectStore(store);
        const req = st.getAll();
        req.onsuccess = ()=>resolve(req.result||[]);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function dbPut(store, obj){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
        tx.objectStore(store).put(obj);
      });
    }

    async function dbPutMany(store, arr){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        const st = tx.objectStore(store);
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
        for(const x of arr) st.put(x);
      });
    }

    async function dbClear(store){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        const st = tx.objectStore(store);
        const req = st.clear();
        req.onsuccess = ()=>resolve(true);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function metaGet(key){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE_META,"readonly");
        const st = tx.objectStore(STORE_META);
        const req = st.get(key);
        req.onsuccess = ()=>resolve(req.result?.value);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function metaSet(key, value){
      return dbPut(STORE_META, {key, value, updatedAt: nowIso()});
    }

    /********************
     * GAME STATE
     ********************/
        const Screens = {
      Title: "screenTitle",
      Start: "screenStart",
      Battle: "screenBattle",
      Result: "screenResult",
      Tournament: "screenTournament",
      Lab: "screenLab",
    };

    const state = {
      companies: [],
      playerId: null,
      cpuId: null,

      // battle runtime
      battle: null,

      // tournament
      tournament: null,

      // settings
      fx: {USD:150, EUR:165, GBP:190}
    };

    function showScreen(key){
      for(const k of Object.values(Screens)){
        const el = $(k);
        if(el) el.classList.add("hidden");
      }
      $(key).classList.remove("hidden");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function getCompany(id){
      return state.companies.find(c=>c.id===id);
    }

    function companyLabel(c){
      return `${c.name_jp || c.name} / ${c.name}`;
    }

    function initialsFor(c){
      const s = (c.name_jp || c.name || "CO").trim();
      const letters = s.replace(/æ ªå¼ä¼šç¤¾/g,"").replace(/\s+/g," ").trim();
      // prefer roman initials if available
      if(/[A-Za-z]/.test(c.name||"")){
        const words = (c.name||"").split(/\s+/).filter(Boolean);
        const init = words.slice(0,2).map(w=>w[0].toUpperCase()).join("");
        return init || (c.name||"C")[0].toUpperCase();
      }
      // Japanese: take first 2 characters excluding symbols
      const jp = letters.replace(/[^\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}A-Za-z0-9]/gu,"");
      return jp.slice(0,2) || "CQ";
    }

        function makeLogo(el, c){
      el.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "w-full h-full flex items-center justify-center relative";
      const img = document.createElement("img");
      img.alt = c.name;
      /* unavatar.io ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚´å–å¾—ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ */
      img.src = `https://unavatar.io/${c.domain}?fallback=false`;
      img.onerror = ()=>{
        img.remove();
        const fb = document.createElement("div");
        fb.className = "logoFallback";
        fb.textContent = initialsFor(c);
        wrap.appendChild(fb);
      };
      wrap.appendChild(img);
      el.appendChild(wrap);
    }

    /********************
     * FINANCIAL -> GAME STAT
     *
     * Inputs: cash, market_cap, rnd (billion JPY); margins/ratios (%)
     * Output: hp/atk/def/spd, skillMax, gaugeGain
     ********************/
    function buildScaler(companies){
      // Build normalization ranges from current pool.
      const cash = companies.map(c=>+c.cash||0);
      const mcap = companies.map(c=>+c.market_cap||0);
      const rndv = companies.map(c=>+c.rnd||0);
      const om = companies.map(c=>+c.operating_margin||0);
      const eq = companies.map(c=>+c.equity_ratio||0);

      const minmax = (arr)=>({min: Math.min(...arr), max: Math.max(...arr)});
      const aCash = minmax(cash);
      const aMcap = minmax(mcap);
      const aRnd  = minmax(rndv);
      const aOm   = minmax(om);
      const aEq   = minmax(eq);

      // avoid zero-range
      function norm(v, a){
        if(!isFinite(v)) v = 0;
        const d = (a.max - a.min);
        if(d <= 1e-9) return 0.5;
        return clamp((v - a.min) / d, 0, 1);
      }

      return {aCash,aMcap,aRnd,aOm,aEq,norm};
    }

    function deriveStats(c, scaler){
      // compress huge values with log
      const cash = Math.log10((+c.cash||1) + 1);
      const mcap = Math.log10((+c.market_cap||1) + 1);
      const rndv = Math.log10((+c.rnd||1) + 1);

      const cashN = scaler.norm(cash, {min: Math.log10(scaler.aCash.min+1), max: Math.log10(scaler.aCash.max+1)});
      const mcapN = scaler.norm(mcap, {min: Math.log10(scaler.aMcap.min+1), max: Math.log10(scaler.aMcap.max+1)});
      const rndN  = scaler.norm(rndv, {min: Math.log10(scaler.aRnd.min+1),  max: Math.log10(scaler.aRnd.max+1)});

      const omN = scaler.norm(+c.operating_margin||0, scaler.aOm);
      const eqN = scaler.norm(+c.equity_ratio||0, scaler.aEq);

      // HP: 180..420
      const hp = Math.round(lerp(190, 420, cashN));
      // ATK: 40..120 (om matters; keyence etc will be strong)
      const atk = Math.round(lerp(45, 125, Math.pow(omN, 0.80)));
      // DEF: 35..120
      const def = Math.round(lerp(38, 120, Math.pow(eqN, 0.85)));
      // SPD: 40..120 (market cap / employees proxy)
      const spd = Math.round(lerp(45, 120, Math.pow(mcapN, 0.78)));

      // Skill Gauge max: 100 fixed; fill speed depends on rnd and spd
      const skillMax = 100;
      const gaugeGain = Math.round(lerp(8, 20, (rndN*0.70 + mcapN*0.30)));

      // extra: employee used in tooltip only (or later)
      return {hp, atk, def, spd, skillMax, gaugeGain, cashN, mcapN, rndN, omN, eqN};
    }

    /********************
     * BATTLE ENGINE
     ********************/
        function makeFighter(c, scaler){
      const st = deriveStats(c, scaler);
      // Assign random motion deterministically based on ID if not present
      if(!c.motion) c.motion = MOTIONS[hashStr(c.id || c.name) % MOTIONS.length];
      
      return {
        company: c,
        base: st,
        maxHP: st.hp,
        hp: st.hp,
        atk: st.atk,
        def: st.def,
        spd: st.spd,
        skillMax: st.skillMax,
        skill: Math.round(st.gaugeGain * 2), // start with some gauge
        gaugeGain: st.gaugeGain,
        buffs: []
      };
    }

    function addBuff(target, buff){
      // if same key exists, refresh stronger / longer
      const ex = target.buffs.find(b=>b.key===buff.key);
      if(ex){
        ex.turns = Math.max(ex.turns, buff.turns);
        ex.meta = {...ex.meta, ...buff.meta};
        ex.name = buff.name;
      } else {
        target.buffs.push({...buff});
      }
    }

    function tickBuffs(target){
      for(const b of target.buffs){
        b.turns -= 1;
      }
      target.buffs = target.buffs.filter(b=>b.turns>0);
    }

    function getBuffValue(target, key, field, defVal=0){
      const b = target.buffs.find(x=>x.key===key);
      if(!b) return defVal;
      return (b.meta && b.meta[field] != null) ? b.meta[field] : defVal;
    }

    function computeMods(target){
      // aggregate multiplicative-ish modifiers
      let atkM = 1, defM = 1, spdM = 1, critAdd = 0, dr = 0;
      for(const b of target.buffs){
        if(b.meta?.atk) atkM += b.meta.atk;
        if(b.meta?.def) defM += b.meta.def;
        if(b.meta?.spd) spdM += b.meta.spd;
        if(b.meta?.crit) critAdd += b.meta.crit;
        if(b.meta?.dr) dr = Math.max(dr, b.meta.dr);
      }
      return {atkM, defM, spdM, critAdd, dr};
    }

        function damageFormula(attacker, defender, opts={}){
      const modsA = computeMods(attacker);
      const modsD = computeMods(defender);

      // Market Multiplier
      let mktM = 1.0;
      const mkt = state.battle?.market?.cycle || "NORMAL";
      const sec = attacker.company.sector;

      if(mkt === "BULL"){
        if(["Tech","Auto","Industrial","Energy"].includes(sec)) mktM = 1.5;
      } else if(mkt === "BEAR"){
        if(["Pharma","Retail","Telecom"].includes(sec)) mktM = 1.0; // å½±éŸ¿è»½æ¸›
        else mktM = 0.7;
      } else if(mkt === "TIGHT"){
        if(sec === "Finance") mktM = 1.4;
      }

      const atk = attacker.atk * modsA.atkM * mktM;
      const def = defender.def * modsD.defM;

      const base = atk * rnd(0.85, 1.15);
      const pierce = opts.pierce ?? 0.0;

      // reduction by DEF; keep it bounded
      const reducedDef = def * (1 - pierce);
      const mitigation = clamp(reducedDef / (reducedDef + 120), 0.10, 0.70); // 10%..70% reduction
      let dmg = base * (1 - mitigation);

      // guard damage reduction
      const dr = Math.max(modsD.dr, opts.forceDR ?? 0);
      dmg = dmg * (1 - clamp(dr, 0, 0.75));

      // skill multiplier
      if(opts.mult) dmg *= opts.mult;

      // crit chance based on SPD advantage + buffs
      const spdA = attacker.spd * modsA.spdM;
      const spdD = defender.spd * modsD.spdM;
      const adv = clamp((spdA - spdD) / 160, -0.10, 0.18);
      const critChance = clamp(0.06 + adv + modsA.critAdd, 0.03, 0.35);
      const isCrit = Math.random() < critChance;

      if(isCrit) dmg *= rnd(1.35, 1.60);

      dmg = Math.round(clamp(dmg, 6, 260));
      return {dmg, isCrit, critChance};
    }

        function applyDot(battle){
      const mkt = battle.market?.cycle || "NORMAL";
      
      for(const side of ["P","C"]){
        const t = side==="P" ? battle.P : battle.C;

        // 1. Market Effects
        if(mkt === "BEAR"){
          // Defensive sectors heal
          if(["Pharma","Retail","Telecom"].includes(t.company.sector)){
            const heal = Math.floor(t.maxHP * 0.05);
            battle.heal(t, heal, "BEAR MKT");
            battle.log(`${battle.nameOf(t)} ã¯ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–éŠ˜æŸ„ã¨ã—ã¦è³‡é‡‘é€€é¿ï¼ <span class="text-emerald-300">+${heal}</span>`);
          }
        } else if(mkt === "TIGHT"){
          // Low Equity Ratio (<30%) takes damage (interest rate burden)
          if(t.company.equity_ratio < 30.0){
            const dmg = Math.floor(t.maxHP * 0.05);
            battle.damage(t, dmg, {isDot:true, fx:"GLITCH"});
            battle.log(`${battle.nameOf(t)} ã¯é‡‘åˆ©è² æ‹…ãŒå¢—åŠ ï¼(è‡ªå·±è³‡æœ¬æ¯”ç‡ä½) <span class="text-amber-300">-${dmg}</span>`);
          }
        }

        // 2. Buff/Debuff DOTs
        const bleed = t.buffs.find(b=>b.key==="bleed");
        if(bleed){
          const dot = bleed.meta?.dot ?? 0.03;
          const amount = Math.max(6, Math.round(t.maxHP * dot));
          battle.damage(t, amount, {label:"PIPELINE DOT", isDot:true});
          battle.log(`${battle.nameOf(t)} ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åœ§åŠ›ãŒç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ <span class="text-rose-300">-${amount}</span>`);
        }
      }
    }

    function battleCreate(playerCompany, cpuCompany){
      const scaler = buildScaler(state.companies);
      const P = makeFighter(playerCompany, scaler);
      const C = makeFighter(cpuCompany, scaler);

      const battle = {
        scaler,
        P, C,
                turn: 1,
        market: { cycle: "NORMAL", count: 0 },
        paused: false,
        auto: false,
        finished: false,
        winner: null,
        lastAction: null,
        logs: [],
        seed: hashStr(playerCompany.id + "|" + cpuCompany.id + "|" + nowIso()),
        nameOf: (f)=> f.company.name_jp || f.company.name,
        enemyOf: (f)=> (f===P ? C : P),

        addBuff: (t,b)=>addBuff(t,b),

        heal: (t, amount, label="HEAL")=>{
          const prev = t.hp;
          t.hp = clamp(t.hp + amount, 0, t.maxHP);
          const real = t.hp - prev;
          if(real>0){
            battle.showFloat(t, `+${real}`, "good");
            battle.fx(t===P ? "P":"C", "AURA");
            battle.log(`${battle.nameOf(t)} ãŒè³‡é‡‘ã‚’ç¢ºä¿ï¼ˆ${label}ï¼‰ <span class="text-emerald-300">+${real}</span>`);
          }
        },

        damage: (t, amount, meta={})=>{
          const prev = t.hp;
          t.hp = clamp(t.hp - amount, 0, t.maxHP);
          const real = prev - t.hp;
          battle.showFloat(t, `-${real}`, meta.isDot ? "bad" : "bad");
          if(!meta.isDot) battle.fx(t===P ? "P":"C", meta.fx || "IMPACT");
          return real;
        },

        spendSkill: (t, cost)=>{ t.skill = clamp(t.skill - cost, 0, t.skillMax); },
        gainSkill: (t, g)=>{ t.skill = clamp(t.skill + g, 0, t.skillMax); },

                log: (html)=>{
          battle.logs.push({t:Date.now(), html});
          renderLog();
          showBattleToast(html);
        },

        showFloat: (t, text, tone)=>{
          const arena = $("arena");
          const box = document.createElement("div");
          box.className = "floatDmg";
          box.style.color = tone==="good" ? "rgba(52,211,153,.95)" : "rgba(251,113,133,.95)";
          const side = (t===P) ? "P" : "C";
          const rect = arena.getBoundingClientRect();
          // place near logo
          const target = side==="P" ? $("logoWrapPlayer") : $("logoWrapCPU");
          const tr = target.getBoundingClientRect();
          const x = (tr.left - rect.left) + tr.width*0.55 + rnd(-10, 18);
          const y = (tr.top - rect.top) + tr.height*0.18 + rnd(-6, 8);
          box.style.left = x + "px";
          box.style.top = y + "px";
          box.textContent = text;
          arena.appendChild(box);
          setTimeout(()=>box.remove(), 980);
        },

        Â  Â  Â  Â  fx: (side, type)=>{
Â  Â  Â  Â  Â  const arena = $("arena");
Â  Â  Â  Â  Â  // Reset anims
Â  Â  Â  Â  Â  arena.classList.remove("flash", "shake", "quake", "glitch-anim");
Â  Â  Â  Â  Â  void arena.offsetWidth; // trigger reflow

Â  Â  Â  Â  Â  // --- 1. Screen Animations ---
Â  Â  Â  Â  Â  if(type==="IMPACT") arena.classList.add("shake");
Â  Â  Â  Â  Â  if(type==="QUAKE") arena.classList.add("quake");
Â  Â  Â  Â  Â  if(type==="GLITCH" || type==="ARC"){
Â  Â  Â  Â  Â  Â  arena.classList.add("glitch-anim");
Â  Â  Â  Â  Â  Â  setTimeout(()=>arena.classList.remove("glitch-anim"), 600);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // --- 2. Color Flash Overlays ---
Â  Â  Â  Â  Â  let flashColor = null;
Â  Â  Â  Â  Â  if(type==="NEON" || type==="FLASH_NEON" || type==="ARC") flashColor = "rgba(53,247,255,0.35)";
Â  Â  Â  Â  Â  if(type==="FLASH_RED") flashColor = "rgba(251,113,133,0.35)";
Â  Â  Â  Â  Â  if(type==="FLASH_GREEN") flashColor = "rgba(52,211,153,0.3)";

Â  Â  Â  Â  Â  if(flashColor){
Â  Â  Â  Â  Â  Â  const overlay = document.createElement("div");
Â  Â  Â  Â  Â  Â  overlay.className = "absolute inset-0 z-20 pointer-events-none transition-opacity duration-500 ease-out opacity-0";
Â  Â  Â  Â  Â  Â  overlay.style.background = `radial-gradient(circle, ${flashColor}, transparent)`;
Â  Â  Â  Â  Â  Â  arena.appendChild(overlay);
Â  Â  Â  Â  Â  Â  requestAnimationFrame(()=>{
Â  Â  Â  Â  Â  Â  Â  overlay.classList.remove("opacity-0"); overlay.classList.add("opacity-100");
Â  Â  Â  Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  Â  Â  overlay.classList.remove("opacity-100"); overlay.classList.add("opacity-0");
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(()=>overlay.remove(), 500);
Â  Â  Â  Â  Â  Â  Â  }, 200);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } else if(type!=="QUAKE" && type!=="GLITCH" && !type.startsWith("FLASH")) {
Â  Â  Â  Â  Â  Â  // default flash
Â  Â  Â  Â  Â  Â  arena.classList.add("flash");
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // --- 3. Particles (Confetti) ---
Â  Â  Â  Â  Â  const x = side==="P" ? 0.28 : side==="C" ? 0.72 : 0.5;
Â  Â  Â  Â  Â  const y = 0.4;

Â  Â  Â  Â  Â  if(type==="NEON" || type==="ARC" || type==="GLITCH" || type==="FLASH_NEON"){
Â  Â  Â  Â  Â  Â  confetti({particleCount: 65, spread: 60, startVelocity: 35, colors:['#35F7FF', '#A78BFA', '#FFFFFF'], origin: {x,y}});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else if(type==="STORM"){
Â  Â  Â  Â  Â  Â  confetti({particleCount: 60, spread: 90, startVelocity: 25, gravity:1.5, colors:['#94A3B8', '#475569'], origin: {x,y:0.2}});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else if(type==="SPARK" || type==="WAVE"){
Â  Â  Â  Â  Â  Â  confetti({particleCount: 45, spread: 45, startVelocity: 30, decay:0.9, colors:['#FBBF24', '#FFFFFF'], origin: {x,y}});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else if(type==="MONEY"){
Â  Â  Â  Â  Â  Â  confetti({particleCount: 50, spread: 60, startVelocity: 25, gravity:0.8, shapes:['square'], colors:['#34D399'], origin: {x:0.5,y:0.2}});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  else if(type==="CRASH"){
Â  Â  Â  Â  Â  Â  confetti({particleCount: 40, spread: 100, startVelocity: 20, gravity:1.8, colors:['#000000', '#FB7185'], origin: {x:0.5,y:0.2}});
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
      };

      return battle;
    }

    function renderBuffChips(f, el){
      el.innerHTML = "";
      const mods = computeMods(f);
      // show a tiny derived view; but keep chips for active buffs
      for(const b of f.buffs){
        const chip = document.createElement("div");
        chip.className = "tag";
        chip.textContent = `${b.name}Ã—${b.turns}`;
        el.appendChild(chip);
      }
      // show hidden baseline? no.
    }

    function renderBattleUI(){
      const b = state.battle;
      if(!b) return;

      const P = b.P, C = b.C;

            $("battleSubtitle").textContent = `${b.nameOf(P)} vs ${b.nameOf(C)} â€¢ TURN ${b.turn}`;
      $("turnTag").textContent = b.paused ? "PAUSED" : (b.auto ? "AUTO" : "MANUAL");

            // Market Badge & Tooltip
      const mkt = b.market?.cycle || "NORMAL";
      const mDef = MARKET_CYCLES[mkt];
      
      // Helper to determine effect text
      const getEff = (u) => {
        const s = u.company.sector, e = u.company.equity_ratio;
        if(mkt==="BULL") return ["Tech","Auto","Industrial","Energy"].includes(s) ? "<span class='text-emerald-300'>ATK x1.5 (å¥½æ³æ©æµ)</span>" : "<span class='text-slate-500'>å½±éŸ¿ãªã—</span>";
        if(mkt==="BEAR") return ["Pharma","Retail","Telecom"].includes(s) ? "<span class='text-emerald-300'>å½±éŸ¿å›é¿ &amp; å›å¾©</span>" : "<span class='text-rose-300'>ATK x0.7 (ä¸æ³æ‰“æ’ƒ)</span>";
        if(mkt==="TIGHT") {
          let t=[]; 
          if(s==="Finance") t.push("<span class='text-emerald-300'>ATK x1.4</span>");
          if(e<30) t.push("<span class='text-rose-300'>é‡‘åˆ©ãƒ€ãƒ¡ãƒ¼ã‚¸</span>");
          return t.length ? t.join(" & ") : "<span class='text-slate-500'>å½±éŸ¿ãªã—</span>";
        }
        return "<span class='text-slate-500'>-</span>";
      };

      const badge = $("marketBadge");
      // Add group/relative for tooltip, cursor-help
      badge.className = `hidden sm:flex group relative items-center gap-1 px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-[10px] mono ${mDef.color} cursor-help`;
      // Inject HTML with Tooltip
      badge.innerHTML = `
        <span>${mkt==="BULL"?"ğŸ“ˆ":mkt==="BEAR"?"ğŸ“‰":mkt==="TIGHT"?"ğŸ¦":"ğŸ“Š"}</span>
        <span>${mDef.name} (${5 - (b.market.count||0)}T)</span>
        
        <div class="absolute top-full left-0 mt-2 w-64 p-3 bg-slate-900/95 backdrop-blur border border-slate-600 rounded-xl shadow-2xl z-50 hidden group-hover:block text-xs text-left">
          <div class="mb-2 border-b border-slate-700 pb-1 font-bold ${mDef.color}">${mDef.desc}</div>
          <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1">
            <div class="text-sky-300 font-bold">YOU</div><div>${getEff(P)}</div>
            <div class="text-rose-300 font-bold">CPU</div><div>${getEff(C)}</div>
          </div>
        </div>
      `;

      // Simple Names
      $("namePlayer").textContent = b.nameOf(P);
      $("nameCPU").textContent = b.nameOf(C);

      // Logos - Check emptiness to avoid flickering reload
      if(!$(`logoWrapPlayer`).hasChildNodes()) makeLogo($(`logoWrapPlayer`), P.company);
      if(!$(`logoWrapCPU`).hasChildNodes()) makeLogo($(`logoWrapCPU`), C.company);

      // HP Bars
      const pHpPct = clamp((P.hp / P.maxHP) * 100, 0, 100);
      const cHpPct = clamp((C.hp / C.maxHP) * 100, 0, 100);
      $("hpBarPlayer").style.width = `${pHpPct}%`;
      $("hpBarCPU").style.width = `${cHpPct}%`;

      $("hpTextPlayer").textContent = `${P.hp}/${P.maxHP}`;
      $("hpTextCPU").textContent = `${C.hp}/${C.maxHP}`;
      
      // Danger colors logic
      const dangerCol = "linear-gradient(90deg, #FB7185, #F59E0B)";
      const okColP = "linear-gradient(90deg, #06B6D4, #3B82F6)";
      const okColC = "linear-gradient(90deg, #F43F5E, #F59E0B)";
      
      $("hpBarPlayer").style.background = pHpPct < 25 ? dangerCol : okColP;
      $("hpBarCPU").style.background = cHpPct < 25 ? dangerCol : okColC;

      // Skill Bars
      const pSkPct = clamp((P.skill / P.skillMax) * 100, 0, 100);
      const cSkPct = clamp((C.skill / C.skillMax) * 100, 0, 100);
      
      // Player HUD
      $("skBarPlayer").style.width = `${pSkPct}%`;
      $("skTextPlayer").textContent = `${Math.floor(pSkPct)}%`;
      
      // CPU HUD (Simplified)
      $("skTextCPU").textContent = `${Math.floor(cSkPct)}`;

      // Stats
      $("statAtkP").textContent = P.atk;
      $("statDefP").textContent = P.def;
      $("statSpdP").textContent = P.spd;
      $("statSpdC").textContent = C.spd;

      renderBuffChips(P, $("buffsPlayer"));
      renderBuffChips(C, $("buffsCPU"));

      // Commands
      const canAct = !b.finished && !b.paused && !b.auto;
      $("cmdAttack").disabled = !canAct;
      $("cmdGuard").disabled = !canAct;
            $("cmdPivot").disabled = !canAct;
      $("cmdSkill").disabled = !canAct || (P.skill < 60);
      $("cmdSkill").classList.toggle("opacity-50", P.skill < 60);

      // --- TOB Button State ---
      const btnPiv = $("cmdPivot");
      if(P.skill >= 100){
        // Calc displayed chance
        let chance = 30;
        if((P.company.market_cap||0) < (C.company.market_cap||0)) chance += 25;
        chance -= (C.def * 0.2);
        chance = Math.floor(clamp(chance, 5, 40));

        btnPiv.innerHTML = `<i data-lucide="gavel" class="w-4 h-4"></i><span class="mono font-bold text-amber-300">TOB (${chance}%)</span>`;
        btnPiv.className = "btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2 border-amber-500/50 bg-amber-500/10 shadow-[0_0_10px_rgba(245,158,11,0.2)]";
        if(window.lucide) window.lucide.createIcons();
      } else {
        if(btnPiv.innerHTML.includes("TOB")){
           btnPiv.innerHTML = `<i data-lucide="move-right" class="w-4 h-4"></i><span class="mono">Pivot</span>`;
           btnPiv.className = "btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2";
           if(window.lucide) window.lucide.createIcons();
        }
      }
    }

    function renderLog(){
      const box = $("logBox");
      const b = state.battle;
      if(!b) return;
      box.innerHTML = "";
      const frag = document.createDocumentFragment();
      const logs = b.logs.slice(-120); // keep last
      for(const L of logs){
        const row = document.createElement("div");
        row.className = "panel2 rounded-2xl p-3 text-sm leading-relaxed";
        row.innerHTML = `<div class="mono text-[10px] text-slate-300/70">${new Date(L.t).toLocaleTimeString()}</div>
                         <div class="text-slate-100/90">${L.html}</div>`;
        frag.appendChild(row);
      }
      box.appendChild(frag);
            box.scrollTop = box.scrollHeight;
    }

    function showBattleToast(html){
      const anchor = $("battleToastAnchor");
      if(!anchor) return;
      const el = document.createElement("div");
      el.className = "battle-toast";
      el.innerHTML = html;
      anchor.appendChild(el);
      // Keep only recent toasts
      if(anchor.children.length > 3) anchor.removeChild(anchor.firstChild);
      
      setTimeout(()=>{
        el.style.animation = "toast-out 0.4s ease-in forwards";
        setTimeout(()=>el.remove(), 400);
      }, 3500);
    }

    function cpuChooseAction(b){
      const cpu = b.C;
      const pl = b.P;

      const cpuHpPct = cpu.hp / cpu.maxHP;
      const plHpPct = pl.hp / pl.maxHP;

      const cpuMods = computeMods(cpu);
      const plMods = computeMods(pl);

      // Heuristics
      const canSkill = cpu.skill >= 60;
      const wantGuard = cpuHpPct < 0.35 || (cpuHpPct < 0.5 && pl.skill >= 70);
      const wantSkill = canSkill && (plHpPct < 0.55 || cpuHpPct < 0.55);
      const wantPivot = cpuHpPct >= 0.45 && (cpuMods.atkM < 1.12) && (Math.random() < 0.40);

      // If under DOT or debuffs, sometimes pivot
      const underPressure = cpu.buffs.some(x=>x.key==="bleed" || x.key==="def_down" || x.key==="spd_down");
      if(underPressure && Math.random() < 0.30) return "Pivot";

      if(wantSkill && Math.random() < 0.75) return "Skill";
      if(wantGuard && Math.random() < 0.70) return "Guard";
      if(wantPivot) return "Pivot";

      // default attack with a little randomness
      return (Math.random() < 0.12 && canSkill) ? "Skill" : "Attack";
    }

        async function runTurn(playerAction){
      const b = state.battle;
      if(!b || b.finished || b.paused) return;

            const P = b.P, C = b.C;

      // --- MARKET CYCLE UPDATE ---
      b.market.count++;
      if(b.market.count >= 5){
        b.market.count = 0;
        const keys = Object.keys(MARKET_CYCLES);
        // exclude current if possible, or just random
        const next = pick(keys);
        b.market.cycle = next;
        const info = MARKET_CYCLES[next];
        
                b.log(`<div class="border-y border-slate-600 py-1 my-1 text-center"><span class="tag">MARKET SHIFT</span> <span class="${info.color} font-black">${info.name}</span><br/><span class="text-xs text-slate-300/80">${info.desc}</span></div>`);
        b.fx(null, "WAVE");
        renderBattleUI();
        await sleep(2500);
      }

      // --- MARKET EVENT (Random Occurrence) ---
      if(b.turn > 1 && !b.finished && Math.random() < 0.25){
        const evt = pick(MARKET_EVENTS);
        const effectText = evt.func(b);
        const color = evt.type==="good" ? "text-emerald-300" : "text-rose-300";
                b.log(`<span class="tag">NEWS</span> <span class="${color}">${evt.name}</span>: ${evt.text}<br/><span class="text-xs text-slate-300/60">â¥ ${effectText}</span>`);
        renderBattleUI();
        await sleep(2500);
      }

      // apply dots at start of turn
      applyDot(b);

      // if someone died by DOT
      if(P.hp<=0 || C.hp<=0){
        return finishBattle();
      }

      // auto-gain gauge each turn
      b.gainSkill(P, P.gaugeGain);
      b.gainSkill(C, C.gaugeGain);

      // Decide order: SPD + small randomness
      const mP = computeMods(P), mC = computeMods(C);
      const spP = P.spd * mP.spdM + rnd(-6, 6);
      const spC = C.spd * mC.spdM + rnd(-6, 6);

      const first = spP >= spC ? "P" : "C";
      const second = first==="P" ? "C" : "P";

      const cpuAction = cpuChooseAction(b);

      b.log(`<span class="mono text-slate-300/75">TURN ${b.turn}</span> â€¢ å…ˆæ‰‹: <b>${first==="P" ? b.nameOf(P) : b.nameOf(C)}</b>`);

      // execute two actions
      const actMap = {P: playerAction, C: cpuAction};

      Â  Â  Â  async function exec(side){
Â  Â  Â  Â  if(b.finished) return;
Â  Â  Â  Â  const user = side==="P" ? P : C;
Â  Â  Â  Â  const enemy = side==="P" ? C : P;
Â  Â  Â  Â  const action = actMap[side];

Â  Â  Â  Â          // Check Stun
        const isStunned = user.buffs.some(x=>x.key==="stun");
        if(isStunned){
          b.log(`${b.nameOf(user)} ã¯<span class="text-rose-300 font-bold">å–¶æ¥­åœæ­¢ä¸­</span>ã§å‹•ã‘ãªã„ï¼`);
          await sleep(800);
          return;
        }

                // apply action
        await performAction(b, user, enemy, action, side);
        renderBattleUI();
        await sleep(1500);

Â  Â  Â  Â  if(enemy.hp<=0 || user.hp<=0){
Â  Â  Â  Â  Â  finishBattle();
Â  Â  Â  Â  }
Â  Â  Â  }

      await exec(first);
      await exec(second);

      // tick buffs at end of turn
      if(!b.finished){
        tickBuffs(P);
        tickBuffs(C);
        b.turn += 1;
        renderBattleUI();
      }
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function performAction(b, user, enemy, action, side){
      const userName = b.nameOf(user);
      const enemyName = b.nameOf(enemy);

            // --- ANIMATION SEQUENCE ---
      const spriteUser = side==="P" ? $("spritePlayer") : $("spriteCPU");
      const spriteEnemy = side==="P" ? $("spriteCPU") : $("spritePlayer");
      
      if(action==="Skill"){
        // Special Motion
        const motion = user.company.motion || "m-smash";
        spriteUser.style.animationName = motion;
        spriteUser.classList.add("skill-anim");
        
        // Wait for impact point (approx 50-60% of 1.8s)
        await sleep(1000);
        
        spriteUser.style.animationName = "";
        spriteUser.classList.remove("skill-anim");
      }
      else if(action==="Attack" || action==="Pivot"){
        // Standard Attack
        spriteUser.classList.add("atk-anim");
        await sleep(500);
        spriteUser.classList.remove("atk-anim");
      }
      else if(action==="Guard"){
        // Guard Shield
        spriteUser.classList.add("guard-anim");
        setTimeout(()=>spriteUser.classList.remove("guard-anim"), 600);
      }

      const sector = user.company.sector;
      const skillDef = SECTOR_SKILLS[sector] || SECTOR_SKILLS.Tech;
      
      // Helper to trigger hit anim
      const hitEnemy = () => {
         spriteEnemy.classList.add("dmg-anim");
         setTimeout(()=>spriteEnemy.classList.remove("dmg-anim"), 450);
      };

      Â  Â  Â  if(action==="Attack"){
Â  Â  Â  Â  const {dmg, isCrit} = damageFormula(user, enemy, {});
        hitEnemy(); // VISUAL
        b.damage(enemy, dmg, {fx:"IMPACT"});

        // Determine attack name/desc
Â  Â  Â  Â  let atkName = "å¸‚å ´æ”»å‹¢";
Â  Â  Â  Â  let atkDesc = "";
Â  Â  Â  Â  const c = user.company;
Â  Â  Â  Â  if(c.attacks && Array.isArray(c.attacks) && c.attacks.length > 0){
Â  Â  Â  Â  Â  Â  const a = pick(c.attacks);
Â  Â  Â  Â  Â  Â  atkName = a.name;
Â  Â  Â  Â  Â  Â  atkDesc = a.desc;
Â  Â  Â  Â  }

Â  Â  Â  Â  let msg = `${userName} ã® <b>${atkName}</b>ï¼`;
Â  Â  Â  Â  if(atkDesc) msg += ` <span class="text-[10px] text-slate-300/60">(${atkDesc})</span>`;
Â  Â  Â  Â  if(isCrit) msg = `<span class="text-violet-300 mono font-black">CRIT</span> ` + msg;
Â  Â  Â  Â  msg += `<br/><span class="text-rose-300 font-bold text-lg">-${dmg}</span>`;

Â  Â  Â  Â  b.log(msg);
Â  Â  Â  Â  if(isCrit) b.fx(side, "NEON");
Â  Â  Â  }
      else if(action==="Guard"){
        // add guard buff + slight skill gain
        b.addBuff(user, {key:"guard", name:"GUARD", turns:1, meta:{dr:0.45, def:0.12}});
        b.gainSkill(user, 10);
        b.log(`${userName} ãŒè²¡å‹™å›ºã‚ï¼ <span class="text-emerald-300">è¢«ãƒ€ãƒ¡è»½æ¸›</span> &amp; <span class="text-sky-300">DEFâ†‘</span>`);
        b.fx(side, "AURA");
      }
            else if(action==="Pivot"){
        // --- M&A GAMBLE (TOB) ---
        if(user.skill >= 100){
          b.spendSkill(user, 100);
          
          // 1. Cost: 20% Current HP (Acquisition Cost)
          const cost = Math.floor(user.hp * 0.20);
          b.damage(user, cost, {fx:"CRASH"});
          b.log(`${userName} ãŒè²·åå·¥ä½œè³‡é‡‘ã‚’æŠ•å…¥ï¼ <span class="text-rose-300">-${cost}</span>`);

          // 2. Probability Calc
          let chance = 30; // Base
          // Underdog Bonus: Market Cap < Enemy
          if((user.company.market_cap||0) < (enemy.company.market_cap||0)) chance += 25;
          // Defense Penalty: Enemy DEF * 0.2
          chance -= (enemy.def * 0.2);
          // Cap & Floor
          chance = Math.floor(clamp(chance, 5, 40));

          b.log(`${userName} ãŒ <span class="text-amber-300 font-black">TOB (æ•µå¯¾çš„è²·å)</span> ã‚’å®£è¨€ï¼<br/><span class="text-xs text-slate-300">æˆåŠŸç‡: ${chance}% (æ•µDEF:${enemy.def} å¯¾ç­–æ¸ˆ)</span>`);
          
          await sleep(1500);

          // 3. Roll
          const roll = Math.random() * 100;
                              if(roll < chance){
            // SUCCESS: Instant Win

            // --- æ¼”å‡ºå¼·åŒ–: æˆåŠŸç¢ºå®šæ¼”å‡º ---
            // ã¾ãšé–“ã‚’ä½œã‚‹
            await sleep(400);
            b.fx(side, "QUAKE"); // è¡æ’ƒ
            await sleep(400);

            // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼†ã‚°ãƒªãƒƒãƒé€£æ‰“
            b.fx(side, "FLASH_NEON");
            b.fx(side, "GLITCH");
            confetti({particleCount: 150, spread: 160, startVelocity: 40, colors:['#FBBF24', '#FFFFFF'], origin: { y: 0.6 }});
            
            // ãƒãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé€£æ‰“
            for(let i=0; i<6; i++) setTimeout(()=>b.fx(side, "MONEY"), i*120);

            // --- ACQUISITION VISUALS ---
            // 1. Icon Overwrite (Winner takes all)
            const enemyLogoId = side==="P" ? "logoWrapCPU" : "logoWrapPlayer";
            makeLogo($(enemyLogoId), user.company);

            // 2. Name Change (Merged Entity)
            const enemyNameId = side==="P" ? "nameCPU" : "namePlayer";
            const newName = `${userName}${enemyName}`;
            const elName = $(enemyNameId);
            if(elName) {
              elName.textContent = newName;
              elName.classList.add("text-emerald-300", "shake", "glowText"); // Glowè¿½åŠ 
              elName.style.transform = "scale(1.25)"; 
              elName.style.transition = "transform 0.3s ease-out";
              setTimeout(()=>elName.style.transform = "scale(1)", 600);
            }

            // 3. BIG OVERLAY VISUAL (ãƒ‰æ´¾æ‰‹æ¼”å‡ºã®æœ¬ä¸¸)
            const arena = $("arena");
            const overlay = document.createElement("div");
            overlay.className = "absolute inset-0 z-50 flex items-center justify-center flex-col bg-slate-900/60 backdrop-blur-[2px] pointer-events-none overflow-hidden";
            overlay.innerHTML = `
                <div class="relative z-10 text-center">
                    <div class="text-7xl sm:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 via-amber-400 to-amber-600 drop-shadow-[0_0_35px_rgba(245,158,11,0.8)] animate-[pop_0.4s_cubic-bezier(0.34,1.56,0.64,1)_forwards]" style="text-shadow: 0 4px 0 #78350f;">
                        M&A
                    </div>
                    <div class="text-4xl sm:text-5xl font-black text-white mt-2 tracking-widest drop-shadow-[0_0_20px_rgba(53,247,255,0.6)] animate-[pop_0.4s_cubic-bezier(0.34,1.56,0.64,1)_0.15s_both]">
                        COMPLETE
                    </div>
                </div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(245,158,11,0.3),transparent_70%)] animate-pulse"></div>
            `;
            arena.appendChild(overlay);
            setTimeout(()=>overlay.remove(), 2800);

            b.damage(enemy, enemy.maxHP + 99999, {fx:"NEON"}); // Overkill
            
            b.log(`<span class="text-emerald-300 font-black text-xl border-b border-emerald-500/50 pb-1 mb-1 block">TOBæˆç«‹ï¼å®Œå…¨å‹åˆ©ï¼</span>${b.nameOf(enemy)} ã‚’å®Œå…¨å­ä¼šç¤¾åŒ–ã€‚<br/><span class="text-xs text-slate-300">æ–°ç¤¾åã€Œ${newName}ã€ã¨ã—ã¦ãƒ–ãƒ©ãƒ³ãƒ‰çµ±åˆå®Œäº†ã€‚</span>`);
            
            // ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ã®ç´™å¹é›ª (é…å»¶ã•ã›ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨åˆã‚ã›ã‚‹)
            setTimeout(()=>{
                confetti({particleCount: 300, spread: 100, startVelocity: 55, gravity: 0.8, colors:['#FBBF24', '#34D399', '#35F7FF'], origin:{y:0.55}});
            }, 300);

            // æ¼”å‡ºå¾…ã¡
            await sleep(2800);

          } else {
            // FAIL: Poison Pill Damage
            b.fx(side, "CRASH"); b.fx(side, "FLASH_RED");
            const penalty = Math.floor(user.maxHP * 0.5);
            b.damage(user, penalty, {fx:"QUAKE"});
            user.skill = 0; // Gauge Lost
            b.log(`<span class="text-rose-300 font-black text-xl">TOBå¤±æ•—â€¦</span><br/>ãƒã‚¤ã‚ºãƒ³ãƒ”ãƒ«ç™ºå‹•ï¼ ${userName} ã¯å¤§æ‰“æ’ƒã‚’å—ã‘ãŸã€‚<span class="text-rose-300">-${penalty}</span>`);
          }
        } else {
          // Normal Pivot
          b.addBuff(user, {key:"pivot", name:"PIVOT", turns:3, meta:{atk:0.18, spd:0.16, def:-0.08}});
          b.gainSkill(user, 14);
          b.log(`${userName} ãŒäº‹æ¥­è»¢æ›ï¼ <span class="text-sky-300">ATKâ†‘ SPDâ†‘</span>ï¼ˆçŸ­æœŸï¼‰`);
          b.fx(side, "GLITCH");
        }
      }
      else       if(action==="Skill"){
        const cost = 60;
        if(user.skill < cost){
          // fallback attack
          const {dmg} = damageFormula(user, enemy, {});
          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx:"IMPACT"});
          b.log(`${userName} ã¯è³‡æºä¸è¶³â€¦ä»£ã‚ã‚Šã«æ”»å‹¢ï¼ <span class="text-rose-300">-${dmg}</span>`);
          return;
        }
        b.spendSkill(user, cost);

        // CHECK COMBO SKILL FIRST
        const comboKey = `${user.company.sector}_${enemy.company.sector}`;
        const combo = COMBO_SKILLS[comboKey];

        if(combo){
          // Combo Execution
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: combo.mult, pierce: 0.1});
          let extraMsg = "";
          
          // Drain
          if(combo.drain){
             const absorb = Math.round(dmg * combo.drain);
             b.heal(user, absorb, "DRAIN");
             extraMsg += ` / å¸å+${absorb}`;
          }
          // Gauge Gain
          if(combo.gauge) b.gainSkill(user, combo.gauge);
          // Gauge Drain
          if(combo.gaugeEnemy) b.gainSkill(enemy, combo.gaugeEnemy);
          // Buff/Debuff
          if(combo.buff) b.addBuff(user, {key:combo.buff.key, name:"COMBO+", turns:3, meta:{[combo.buff.key.replace("_up","")]: combo.buff.val}});
          if(combo.debuff) b.addBuff(enemy, {key:combo.debuff.key, name:"COMBO-", turns:3, meta:{[combo.debuff.key.replace("_down","")]: combo.debuff.val}});

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: combo.fx || "NEON"});
          b.log(`${userName} ã®<span class="text-amber-300 font-bold">æ¥­ç•Œã‚³ãƒ³ãƒœæŠ€</span>ï¼ <b>${combo.name}</b>ï¼<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${combo.desc}${extraMsg})</span>`);
          b.fx(side, combo.fx || "NEON");

        } else {
          // --- COMPANY UNIQUE SKILL ---
          // Load skill data from company object, fallback to archetype default
          const sType = user.company.skill_type || "BURST";
          const arch = SKILL_ARCHETYPES[sType] || SKILL_ARCHETYPES["BURST"];
          const sName = user.company.skill_name || "Corporate Strike";
          const sDesc = user.company.skill_desc || arch.desc;

          // Execute Logic based on Archetype
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: arch.mult, pierce: arch.pierce||0});
          let extra = "";

          if(arch.drain){
            const healAmt = Math.floor(dmg * arch.drain);
            b.heal(user, healAmt, "DRAIN");
            extra = " / å¸å";
          }
          if(arch.buff){
            b.addBuff(user, {key:arch.buff.key, name:"SKILL+", turns:3, meta:{[arch.buff.key.replace("_up","")]: arch.buff.val}});
            extra = " / å¼·åŒ–";
          }
          if(arch.debuff){
            b.addBuff(enemy, {key:arch.debuff.key, name:"SKILL-", turns:3, meta:{[arch.debuff.key.replace("_down","")]: arch.debuff.val}});
            extra = " / å¼±ä½“åŒ–";
          }

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: arch.fx});
          b.log(`${userName} ã®å¿…æ®ºæŠ€ï¼ <b>${sName}</b>ï¼<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${sDesc})</span>`);
          b.fx(side, arch.fx);
        }
      }

      // immediate finish check
      if(enemy.hp<=0 || user.hp<=0){
        // handled in caller
      }
    }

        async function finishBattle(){
      // Stop Battle BGM (Both)
      try { AudioEngine.stop(); } catch(e){}
      try { BossAudioEngine.stop(); } catch(e){}
      
      const b = state.battle;
      if(!b || b.finished) return;
      b.finished = true;
      const P = b.P, C = b.C;
      b.winner = (P.hp > C.hp) ? "P" : (C.hp > P.hp) ? "C" : "DRAW";
      
      if(b.winner==="P"){
        b.log(`<span class="mono font-black text-emerald-300">VICTORY</span> â€” ${b.nameOf(P)} ãŒå¸‚å ´ã‚’åˆ¶åœ§ï¼`);
        confetti({particleCount: 160, spread: 70, startVelocity: 42, scalar: 0.95, origin:{x:0.28, y:0.35}});
      } else if(b.winner==="C"){
        b.log(`<span class="mono font-black text-rose-300">DEFEAT</span> â€” ${b.nameOf(C)} ãŒä¸»å°æ¨©ã‚’æŒæ¡â€¦`);
        confetti({particleCount: 120, spread: 55, startVelocity: 32, scalar: 0.9, origin:{x:0.72, y:0.35}});
      } else {
        b.log(`<span class="mono font-black text-amber-300">DRAW</span> â€” å¸‚å ´ã¯è† ç€ã€‚`);
      }
      renderBattleUI();
      await sleep(2200);
      
            // --- RESULT MUSIC ---
      try { AudioEngine.stop(); } catch(e){}
      try { BossAudioEngine.stop(); } catch(e){}
      
      if(b.winner==="P") FanfareEngine.play();
      else if(b.winner==="C") RequiemEngine.play();
      
      buildResult();
      showScreen(Screens.Result);
    }

    /********************
     * RESULT EXPLAINER
     ********************/
    function buildResult(){
      const b = state.battle;
      if(!b) return;
      const P = b.P, C = b.C;

      const win = b.winner;
      const winner = win==="P" ? P : win==="C" ? C : null;
      const loser  = win==="P" ? C : win==="C" ? P : null;

      $("resultTitle").textContent = win==="DRAW"
        ? `DRAW â€” ${b.nameOf(P)} vs ${b.nameOf(C)}`
        : `${win==="P" ? "YOU WIN" : "YOU LOSE"} â€” ${b.nameOf(P)} vs ${b.nameOf(C)}`;

      // snapshot
      const snap = $("resultSnapshot");
      snap.innerHTML = "";
      const rows = [
        {k:"HP (Cash)", p:`${P.maxHP}â†’${P.hp}`, c:`${C.maxHP}â†’${C.hp}`},
        {k:"ATK (OM)", p:`${P.atk}`, c:`${C.atk}`},
        {k:"DEF (Equity)", p:`${P.def}`, c:`${C.def}`},
        {k:"SPD (Scale)", p:`${P.spd}`, c:`${C.spd}`},
        {k:"R&D Gauge", p:`${P.gaugeGain}/turn`, c:`${C.gaugeGain}/turn`},
      ];
      for(const r of rows){
        const card = document.createElement("div");
        card.className = "panel2 rounded-2xl p-3";
        card.innerHTML = `
          <div class="mono text-[10px] text-slate-300/75">${r.k}</div>
          <div class="mt-1 grid grid-cols-2 gap-2">
            <div class="mono text-sm"><span class="text-sky-300">YOU</span> ${r.p}</div>
            <div class="mono text-sm text-right"><span class="text-violet-300">CPU</span> ${r.c}</div>
          </div>
        `;
        snap.appendChild(card);
      }

      // explainer
      const exp = $("resultExplainer");
      if(win==="DRAW"){
        exp.innerHTML = `
          <div class="text-base font-bold glowText">æ‹®æŠ—ï¼ˆDRAWï¼‰</div>
          <div class="mt-2">
            ä¸¡ç¤¾ã®<strong>Cash(HP)</strong>ã¨<strong>Operating Margin(ATK)</strong>ãŒè¿‘ã„ãƒ¬ãƒ³ã‚¸ã«åã¾ã‚Šã€æ±ºå®šæ‰“ãŒå‡ºã«ãã„å±•é–‹ã§ã—ãŸã€‚<br/>
            æ¬¡ã¯ <span class="kbd">Skill</span> ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆR&amp;Dã‚²ãƒ¼ã‚¸ï¼‰ã‚’å…ˆèª­ã¿ã—ã¦ã€<strong>Guardâ†’Skill</strong> ã®æµã‚Œã‚’ä½œã‚‹ã¨å‹ã¡ã‚„ã™ããªã‚Šã¾ã™ã€‚
          </div>
        `;
        return;
      }

      // Key causes (finance perspective)
      const causes = [];
      const dAtk = (winner.atk - loser.atk);
      const dDef = (winner.def - loser.def);
      const dHp  = (winner.maxHP - loser.maxHP);
      const dSk  = (winner.gaugeGain - loser.gaugeGain);
      const dSpd = (winner.spd - loser.spd);

      // choose top 3 by impact heuristic
      const impact = [
        {k:"ATK", v: Math.abs(dAtk), text: dAtk>=0
          ? `å–¶æ¥­åˆ©ç›Šç‡ãŒé«˜ãã€æ”»å‹¢ï¼ˆATKï¼‰ãŒå„ªä½ã€‚ãƒ€ãƒ¡ãƒ¼ã‚¸æœŸå¾…å€¤ãŒç©ã¿ä¸ŠãŒã‚Šã¾ã—ãŸã€‚`
          : `å–¶æ¥­åˆ©ç›Šç‡ã§åŠ£ã‚Šã€é€šå¸¸æ”»æ’ƒã§æŠ¼ã—åˆ‡ã‚Œãªã„å±€é¢ãŒå¤šç™ºã€‚`},
        {k:"DEF", v: Math.abs(dDef), text: dDef>=0
          ? `è‡ªå·±è³‡æœ¬æ¯”ç‡ãŒé«˜ãã€å®ˆã‚Šï¼ˆDEFï¼‰ãŒç¡¬ã„ã€‚Guardã¨ã®ç›¸æ€§ã‚‚è‰¯ãã€è¢«å¼¾ã‚’æŠ‘åˆ¶ã€‚`
          : `è‡ªå·±è³‡æœ¬æ¯”ç‡ã§åŠ£ã‚Šã€Guardã—ã¦ã‚‚ç„¼ã‘çŸ³ã«æ°´ã«ãªã‚ŠãŒã¡ã€‚`},
        {k:"HP", v: Math.abs(dHp), text: dHp>=0
          ? `ç¾é é‡‘ï¼ˆCashï¼‰ãŒåšãã€HPãŒé«˜ã„ã€‚é•·æœŸæˆ¦ã§å„ªä½ã€‚`
          : `ç¾é é‡‘ï¼ˆCashï¼‰ãŒè–„ãã€äº‹æ•…ï¼ˆCRIT/Skillï¼‰ã§å´©ã‚Œã‚„ã™ã„ã€‚`},
        {k:"SKILL", v: Math.abs(dSk), text: dSk>=0
          ? `R&amp;DãŒåšãã‚²ãƒ¼ã‚¸å›åãŒé€Ÿã„ã€‚Skillå›æ•°ã§ä¸»å°æ¨©ã‚’æ¡ã‚Šã¾ã—ãŸã€‚`
          : `R&amp;DãŒè–„ãã‚²ãƒ¼ã‚¸ãŒæºœã¾ã‚Šã«ãã„ã€‚Skillå·®ãŒã˜ã‚ã˜ã‚éŸ¿ãã¾ã—ãŸã€‚`},
        {k:"SPD", v: Math.abs(dSpd), text: dSpd>=0
          ? `è¦æ¨¡ï¼ˆSPDï¼‰ãŒä¸Šã§å…ˆæ‰‹ã‚’å–ã‚Šã‚„ã™ã„ã€‚ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ã«ã‚‚å¯„ä¸ã€‚`
          : `è¦æ¨¡ï¼ˆSPDï¼‰ã§åŠ£ã‚Šã€å…ˆæ‰‹ã‚’å–ã‚‰ã‚Œã¦å±•é–‹ãŒå¾Œæ‰‹ã«ãªã‚Šã‚„ã™ã„ã€‚`},
      ].sort((a,b)=>b.v-a.v).slice(0,3);

      for(const it of impact){
        causes.push(`<li class="mt-1">${it.text}</li>`);
      }

      const winnerName = b.nameOf(winner);
      const loserName = b.nameOf(loser);

      const sectorSkill = winner.company.skill_name || "Skill";
      const sectorLabel = winner.company.sector;

      exp.innerHTML = `
        <div class="text-base font-bold glowText">${winnerName} ã®å‹å› ï¼ˆè²¡å‹™Ã—æˆ¦ç•¥ï¼‰</div>
        <div class="mt-2">
          ã“ã®ãƒãƒˆãƒ«ã§ã¯ã€<strong>${winnerName}</strong> ãŒ <span class="tag">${sectorLabel}</span> ã®ç‰¹æ€§ã‚’æ´»ã‹ã—ã€
          <strong>${sectorSkill}</strong> ã‚’è»¸ã«å„ªä½ã‚’ä½œã‚Šã¾ã—ãŸã€‚
        </div>
        <div class="mt-3 panel2 rounded-2xl p-3">
          <div class="mono text-xs text-slate-300/75 mb-2">TOP CAUSES</div>
          <ul class="list-disc pl-5">
            ${causes.join("")}
          </ul>
        </div>
        <div class="mt-3">
          <span class="mono text-slate-300/75">æ¬¡ã®æ”¹å–„æ¡ˆï¼š</span><br/>
          ${win==="P"
            ? `å‹ã£ãŸå´ã¯ <strong>Guardã§äº‹æ•…ã‚’å›é¿ â†’ Skillã§æ±ºã‚ã‚‹</strong> ã‚’å¾¹åº•ã™ã‚‹ã¨å®‰å®šã—ã¾ã™ã€‚`
            : `è² ã‘ãŸå´ã¯ <strong>åºç›¤Guardã§è€ãˆã¦ã‚²ãƒ¼ã‚¸ã‚’è²¯ã‚ã€Skillå›æ•°ã‚’å¢—ã‚„ã™</strong> ã¨é€†è»¢ã—ã‚„ã™ã„ã§ã™ã€‚`
          }
        </div>
      `;
    }

        /********************
     * START / INSPECT
     ********************/
    // Tooltip dictionary
    const STAT_TIPS = {
      HP: "ã€ç¾é é‡‘ (Cash)ã€‘\nä¼æ¥­ã®ä½“åŠ›ã€‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã¨æ¸›å°‘ã—ã€0ã«ãªã‚‹ã¨å€’ç”£ï¼ˆæ•—åŒ—ï¼‰ã€‚",
      ATK: "ã€å–¶æ¥­åˆ©ç›Šç‡ (Operating Margin)ã€‘\næœ¬æ¥­ã®ç¨¼ãåŠ›ã€‚é«˜ã„ã»ã©æ”»æ’ƒåŠ›ãŒä¸ŠãŒã‚Šã€ç›¸æ‰‹ã®ã‚·ã‚§ã‚¢ã‚’å¥ªã„ã‚„ã™ã„ã€‚",
      DEF: "ã€è‡ªå·±è³‡æœ¬æ¯”ç‡ (Equity Ratio)ã€‘\nè²¡å‹™ã®å¥å…¨æ€§ã€‚é«˜ã„ã»ã©æ‰“ãŸã‚Œå¼·ãã€ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã™ã‚‹ã€‚",
      SPD: "ã€æ™‚ä¾¡ç·é¡/å¾“æ¥­å“¡ (Scale)ã€‘\nä¼æ¥­ã®è¦æ¨¡ã¨å½±éŸ¿åŠ›ã€‚é«˜ã„ã»ã©å…ˆæ‰‹ã‚’å–ã‚Šã‚„ã™ãã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚‚å‡ºã‚„ã™ã„ã€‚",
      GAUGE: "ã€ç ”ç©¶é–‹ç™ºè²» (R&D)ã€‘\nå°†æ¥ã¸ã®æŠ•è³‡ã€‚é«˜ã„ã»ã©ã‚¹ã‚­ãƒ«ã‚²ãƒ¼ã‚¸ãŒæ—©ãæºœã¾ã‚Šã€å¿…æ®ºæŠ€ã‚’é€£ç™ºã§ãã‚‹ã€‚"
    };

    function renderStatCard(containerId, c){
      const el = $(containerId);
      if(!el || !c) return;
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      
      const items = [
        {k:"HP", v:st.hp},
        {k:"ATK", v:st.atk},
        {k:"DEF", v:st.def},
        {k:"SPD", v:st.spd},
        {k:"GAUGE", v:"+"+st.gaugeGain},
      ];

      el.innerHTML = items.map(i=>`
        <div class="panel2 rounded-lg p-2 relative group cursor-help">
          <div class="mono text-[9px] text-slate-400/80">${i.k}</div>
          <div class="mono font-black text-base text-slate-200">${i.v}</div>
          
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-lg shadow-xl z-50 hidden group-hover:block text-[10px] text-slate-300 whitespace-pre-wrap leading-tight pointer-events-none">
            ${STAT_TIPS[i.k] || ""}
          </div>
        </div>
      `).join("");
    }

        function updateMenuStats(){
      const p = getCompany($("selPlayer").value);
      const c = getCompany($("selCPU").value);
      renderStatCard("pStatsArea", p);
      renderStatCard("cStatsArea", c);
      
      if(p) makeLogo($("pLogoMenu"), p);
      if(c) makeLogo($("cLogoMenu"), c);
    }
    

    function modalShow(title, tag, html){
      $("modalTitle").textContent = title;
      $("modalTag").textContent = tag;
      $("modalBody").innerHTML = html;
      $("modal").classList.remove("hidden");
      $("modal").classList.add("flex");
    }
    function modalHide(){
      $("modal").classList.add("hidden");
      $("modal").classList.remove("flex");
    }

    function openInspectModal(c){
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      const sName = c.skill_name || "Unknown";
      const sDesc = c.skill_desc || "-";
      const sType = c.skill_type || "BURST";
      const html = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="panel2 rounded-2xl p-4">
            <div class="flex items-center gap-3">
              <div class="logoWrap" style="width:84px;height:84px" id="mLogo"></div>
              <div class="min-w-0">
                <div class="font-black text-xl glowText truncate">${c.name_jp || c.name}</div>
                <div class="mono text-xs text-slate-300/75">${c.name} â€¢ ${c.domain}</div>
                <div class="mt-1"><span class="tag">${c.sector}</span></div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">CASH (B JPY)</div><div class="mono font-black text-lg">Â¥${fmt(c.cash,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">R&amp;D (B JPY)</div><div class="mono font-black text-lg">Â¥${fmt(c.rnd,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">OP MARGIN</div><div class="mono font-black text-lg">${fmt(c.operating_margin,1)}%</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">EQUITY</div><div class="mono font-black text-lg">${fmt(c.equity_ratio,1)}%</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">MKT CAP (B JPY)</div><div class="mono font-black text-lg">Â¥${fmt(c.market_cap,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">EMPLOYEES</div><div class="mono font-black text-lg">${fmt(c.employees,0)}</div></div>
            </div>
          </div>

          <div class="panel2 rounded-2xl p-4">
            <div class="mono text-sm text-slate-200/90">GAME STATS</div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">HP</div><div class="mono font-black text-lg">${st.hp}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">ATK</div><div class="mono font-black text-lg">${st.atk}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">DEF</div><div class="mono font-black text-lg">${st.def}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">SPD</div><div class="mono font-black text-lg">${st.spd}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">GAUGE</div><div class="mono font-black text-lg">+${st.gaugeGain}</div></div>
              <div class="panel2 rounded-xl p-2 col-span-3 mt-1 bg-slate-800/50"><div class="mono text-[10px] text-slate-300/75">UNIQUE SKILL</div><div class="mono font-bold text-base text-sky-200">${c.skill_name || sName}</div><div class="text-[10px] text-slate-400 truncate">${c.skill_desc || "-"}</div></div>
          </div>

            Â  Â  Â  Â  Â  Â  <div class="mt-3 panel2 rounded-2xl p-3 text-sm text-slate-200/85 leading-relaxed">
Â  Â  Â  Â  Â  Â  Â  <div class="mono text-xs text-slate-300/75 mb-1">SKILL PROFILE</div>
Â  Â  Â  Â  Â  Â  Â  <b>${sName}</b>ï¼š${sDesc}
Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 text-xs text-slate-300/70 mono">
                â€»Cash/MarketCap/R&amp;Dã¯å¯¾æ•°åœ§ç¸®ã—ã¦HP/SPD/ã‚²ãƒ¼ã‚¸é€Ÿåº¦ã«åæ˜ ã—ã¦ã„ã¾ã™ï¼ˆæ¥µç«¯ãªå·®ã‚’æŠ‘ãˆã‚‹ãŸã‚ï¼‰ã€‚
              </div>
            </div>
          </div>
        </div>
      `;
      modalShow("CORPORATE INTEL", "INSPECT", html);
      setTimeout(()=>makeLogo($("mLogo"), c), 0);
    }

    /********************
     * TOURNAMENT
     ********************/
    function tournamentCreate(){
      const pool = [...state.companies];
      if(pool.length < 8){
        toast("ä¼æ¥­ãŒ8ç¤¾æœªæº€ã§ã™ã€‚AI FORGEã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚", "bad");
        return null;
      }
      // pick 8 unique
      const s = seededRand(Date.now() ^ (pool.length<<8));
      pool.sort(()=>s()-0.5);
      const eight = pool.slice(0,8).map(c=>c.id);

      // bracket: qf (4), sf (2), f(1)
      const t = {
        ids: eight,
        qf: [
          {a:eight[0], b:eight[1], w:null},
          {a:eight[2], b:eight[3], w:null},
          {a:eight[4], b:eight[5], w:null},
          {a:eight[6], b:eight[7], w:null},
        ],
        sf: [
          {a:null, b:null, w:null},
          {a:null, b:null, w:null},
        ],
        f: [{a:null, b:null, w:null}],
        champion: null,
        log: []
      };
      return t;
    }

    function bracketHtmlMatch(m, label){
      const a = m.a ? (getCompany(m.a)?.name_jp || getCompany(m.a)?.name) : "â€”";
      const b = m.b ? (getCompany(m.b)?.name_jp || getCompany(m.b)?.name) : "â€”";
      const w = m.w ? (getCompany(m.w)?.name_jp || getCompany(m.w)?.name) : null;

      return `
        <div class="panel2 rounded-2xl p-3">
          <div class="mono text-[10px] text-slate-300/75">${label}</div>
          <div class="mt-2 grid grid-cols-[1fr_auto_1fr] items-center gap-2">
            <div class="mono text-sm ${w===m.a ? 'text-emerald-300 font-black':''} truncate">${a}</div>
            <div class="mono text-xs text-slate-300/80">vs</div>
            <div class="mono text-sm text-right ${w===m.b ? 'text-emerald-300 font-black':''} truncate">${b}</div>
          </div>
          <div class="mt-2 mono text-xs text-slate-300/70">${w ? `WINNER: <span class="text-emerald-300">${w}</span>` : `PENDING`}</div>
        </div>
      `;
    }

    function renderTournament(){
      const t = state.tournament;
      if(!t){ $("bracketBox").innerHTML = ""; return; }

      // feed forward
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;

      t.f[0].a = t.sf[0].w;
      t.f[0].b = t.sf[1].w;

      t.champion = t.f[0].w;

      const box = $("bracketBox");
      box.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Quarterfinals</div>
            ${t.qf.map((m,i)=>bracketHtmlMatch(m, `QF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Semifinals</div>
            ${t.sf.map((m,i)=>bracketHtmlMatch(m, `SF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Final</div>
            ${bracketHtmlMatch(t.f[0], "FINAL")}
            <div class="panel2 rounded-2xl p-3">
              <div class="mono text-[10px] text-slate-300/75">CHAMPION</div>
              <div class="mt-2 font-black text-xl glowText">${t.champion ? (getCompany(t.champion)?.name_jp || getCompany(t.champion)?.name) : "â€”"}</div>
              <div class="mono text-xs text-slate-300/70 mt-1">${t.champion ? "å¸‚å ´ã®è¦‡è€…ãŒç¢ºå®šã€‚" : "ã¾ã æœªç¢ºå®šã€‚"}</div>
            </div>
          </div>
        </div>
      `;

      // tournament log
      $("tLog").innerHTML = t.log.slice(-80).map(x=>`
        <div class="panel2 rounded-2xl p-3 text-sm">
          <div class="mono text-[10px] text-slate-300/70">${x.time}</div>
          <div class="text-slate-100/90">${x.msg}</div>
        </div>
      `).join("");
      $("tLog").scrollTop = $("tLog").scrollHeight;
    }

    function tlog(msg){
      const t = state.tournament;
      if(!t) return;
      t.log.push({time:new Date().toLocaleTimeString(), msg});
      renderTournament();
    }

    function getNextMatch(){
      const t = state.tournament;
      if(!t) return null;

      // QF pending
      for(const m of t.qf){
        if(!m.w) return {round:"qf", m};
      }
      // SF pending if both sides ready
      for(const m of t.sf){
        if(!m.w && m.a && m.b) return {round:"sf", m};
      }
      // Final
      if(!t.f[0].w && t.f[0].a && t.f[0].b) return {round:"f", m:t.f[0]};
      return null;
    }

    function simulateMatch(aId, bId){
      // quick simulation using derived stats and random
      const scaler = buildScaler(state.companies);
      const A = makeFighter(getCompany(aId), scaler);
      const B = makeFighter(getCompany(bId), scaler);

      // simulate up to 30 turns
      for(let t=1;t<=30;t++){
        // dot-like but simplified
        A.skill = clamp(A.skill + A.gaugeGain, 0, 100);
        B.skill = clamp(B.skill + B.gaugeGain, 0, 100);

        const order = (A.spd + rnd(-5,5) >= B.spd + rnd(-5,5)) ? [A,B] : [B,A];
        for(const u of order){
          const e = (u===A)?B:A;
          if(e.hp<=0 || u.hp<=0) break;

          // choose action
          const hpPct = u.hp/u.maxHP;
          let act = "Attack";
          if(u.skill>=60 && (e.hp/e.maxHP<0.6 || hpPct<0.6) && Math.random()<0.7) act="Skill";
          else if(hpPct<0.35 && Math.random()<0.7) act="Guard";
          else if(Math.random()<0.18) act="Pivot";

          if(act==="Guard"){
            addBuff(u,{key:"guard",name:"GUARD",turns:1,meta:{dr:0.45,def:0.12}});
            u.skill = clamp(u.skill+10,0,100);
          } else if(act==="Pivot"){
            addBuff(u,{key:"pivot",name:"PIVOT",turns:3,meta:{atk:0.18, spd:0.16, def:-0.08}});
            u.skill = clamp(u.skill+14,0,100);
          } else if(act==="Skill"){
            u.skill -= 60;
            const {dmg} = damageFormula(u,e,{mult:1.45,pierce:0.05});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          } else {
            const {dmg} = damageFormula(u,e,{});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          }

          // tick at end of each action? keep simple
          tickBuffs(u); tickBuffs(e);
        }
        if(A.hp<=0 || B.hp<=0) break;
      }
      if(A.hp===B.hp) return (Math.random()<0.5)?aId:bId;
      return (A.hp > B.hp) ? aId : bId;
    }

    async function playNextMatchInteractive(){
      const next = getNextMatch();
      if(!next){
        toast("æ¬¡ã®è©¦åˆã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆçµ‚äº†ï¼‰ã€‚", "good");
        return;
      }
      const {m} = next;
      if(!m.a || !m.b){
        toast("å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ãŒæƒã£ã¦ã„ã¾ã›ã‚“ã€‚", "bad");
        return;
      }

      // Start interactive battle: player controls left side automatically? In tournament, we let AUTO run as spectator.
      const A = getCompany(m.a);
      const B = getCompany(m.b);

      // Set battle with A as "player" side but auto
      state.playerId = A.id;
      state.cpuId = B.id;
      startBattle({auto:true, tournamentCtx: {match: m, round: next.round}});
    }

    async function autoSimTournament(){
      const t = state.tournament;
      if(!t) return;

      // QF
      for(const m of t.qf){
        if(!m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`QF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> â†’ <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // SF
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;
      for(const m of t.sf){
        if(m.a && m.b && !m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`SF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> â†’ <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // Final
      t.f[0].a = t.sf[0].w; t.f[0].b = t.sf[1].w;
      if(t.f[0].a && t.f[0].b && !t.f[0].w){
        t.f[0].w = simulateMatch(t.f[0].a, t.f[0].b);
        tlog(`FINAL: <b>${getCompany(t.f[0].a).name_jp || getCompany(t.f[0].a).name}</b> vs <b>${getCompany(t.f[0].b).name_jp || getCompany(t.f[0].b).name}</b> â†’ <span class="text-emerald-300">CHAMPION: ${getCompany(t.f[0].w).name_jp || getCompany(t.f[0].w).name}</span>`);
        confetti({particleCount: 220, spread: 80, startVelocity: 44, scalar: 1.0, origin:{x:0.5, y:0.32}});
      }
      renderTournament();
    }

    /********************
     * LAB (AI FORGE)
     ********************/
    function renderSectorChoices(){
      const box = $("sectorChoices");
      box.innerHTML = "";
      for(const s of SECTORS){
        const b = document.createElement("button");
        b.className = "tag";
        b.textContent = s.key;
        b.dataset.key = s.key;
        b.dataset.on = "1";
        b.style.cursor = "pointer";
        b.onclick = ()=>{
          const on = b.dataset.on === "1";
          b.dataset.on = on ? "0" : "1";
          b.style.borderColor = on ? "rgba(148,163,184,.20)" : "rgba(53,247,255,.35)";
          b.style.background = on ? "rgba(148,163,184,.06)" : "rgba(53,247,255,.08)";
          b.style.color = on ? "rgba(214,226,255,.86)" : "#CFFBFF";
        };
        // default: on
        b.style.borderColor = "rgba(53,247,255,.35)";
        b.style.background = "rgba(53,247,255,.08)";
        b.style.color = "#CFFBFF";
        box.appendChild(b);
      }
    }

    function selectedSectors(){
      return [...$("sectorChoices").querySelectorAll("button")].filter(b=>b.dataset.on==="1").map(b=>b.dataset.key);
    }

    Â  Â  Â  Â  function generatePrompt(){
Â  Â  Â  const count = clamp(parseInt($("labCount").value||"5",10),1,50);
Â  Â  Â  const region = $("labRegion").value;
Â  Â  Â  const custom = $("labCustom").value.trim();
Â  Â  Â  const secs = selectedSectors();

Â  Â  Â        const fields = [
        `"name" (è‹±èªç¤¾å)`,
        `"name_jp" (æ—¥æœ¬èªç¤¾å)`,
        `"domain" (ä¼æ¥­ãƒ‰ãƒ¡ã‚¤ãƒ³)`,
        `"sector" (ä»¥ä¸‹ã‹ã‚‰é¸æŠ: ${SECTORS.map(s=>s.key).join(", ")})`,
        `"currency" (å›ºå®šã§ "JPY" ã¨ã™ã‚‹)`,
        `"cash" (ç¾é é‡‘ billion JPY)`,
        `"operating_margin" (å–¶æ¥­åˆ©ç›Šç‡ %)`,
        `"equity_ratio" (è‡ªå·±è³‡æœ¬æ¯”ç‡ %)`,
        `"market_cap" (æ™‚ä¾¡ç·é¡ billion JPY)`,
        `"employees" (å¾“æ¥­å“¡æ•°)`,
        `"rnd" (ç ”ç©¶é–‹ç™ºè²» billion JPY)`,
        `"skill_name" (ãã®ä¼æ¥­ã®å®Ÿéš›ã®è£½å“ãƒ»æŠ€è¡“ãƒ»çµŒå–¶ç”¨èªã‚’ç”¨ã„ãŸã€ãƒ•ã‚¡ãƒ³ãŒãƒ‹ãƒ¤ãƒªã¨ã™ã‚‹å¿…æ®ºæŠ€å)`,
        `"skill_desc" (ãã®æŠ€ãŒãªãœå¼·ã„ã®ã‹ã€ä¼æ¥­ã®å®šæ€§çš„ãªå¼·ã¿ã‚„æ­´å²èƒŒæ™¯ã‚’çµ¡ã‚ãŸè§£èª¬)`,
        `"skill_type" (ä»¥ä¸‹ã‹ã‚‰é¸æŠ: BURST, GUARD, SPEED, DRAIN, DOT, JAM, BUFF)`,
        `"attacks": [ {"name":"æ”»æ’ƒæŠ€å", "desc":"ãã®æ”»æ’ƒã®ãƒ“ã‚¸ãƒã‚¹çš„èƒŒæ™¯"} ] (ãã®ä¼æ¥­ã®äº‹æ¥­ã‚„ç‰¹å¾´ã‚’è¡¨ã™é€šå¸¸æ”»æ’ƒã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨æ„ã™ã‚‹)`
      ];

Â  Â  Â  const sectorClause = secs.length ? `æ¥­ç¨®ã¯å¯èƒ½ãªã‚‰æ¬¡ã‹ã‚‰å„ªå…ˆã—ã¦é¸ã¶: ${secs.join(", ")}` : "æ¥­ç¨®ã¯ãƒãƒ©ãƒ³ã‚¹ã‚ˆãé¸ã¶";
Â  Â  Â  const regionClause = region==="JP"
Â  Â  Â  Â  ? "æ—¥æœ¬ä¼æ¥­ã‚’ä¸­å¿ƒã«ï¼ˆã§ãã‚Œã°æ—¥çµŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹400ç´šã®å®Ÿåœ¨ä¼æ¥­ã‹ã‚‰ï¼‰"
Â  Â  Â  Â  : region==="GLOBAL"
Â  Â  Â  Â  Â  ? "æµ·å¤–ã®å®Ÿåœ¨ä¼æ¥­ã‚’ä¸­å¿ƒã«"
Â  Â  Â  Â  Â  : "æ—¥æœ¬ä¼æ¥­ã¨æµ·å¤–ä¼æ¥­ã‚’æ··ãœã¦";

Â  Â  Â  const customClause = custom ? `\nã€è¿½åŠ æŒ‡ç¤ºã€‘\n${custom}\n` : "";

Â  Â  Â  const prompt = `
ã‚ãªãŸã¯è²¡å‹™ãƒ‡ãƒ¼ã‚¿ä½œæˆã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®ä»•æ§˜ã§ã€å®Ÿåœ¨ä¼æ¥­ã®ã‚µãƒ³ãƒ—ãƒ«è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦ãã ã•ã„ã€‚
${customClause}
ã€å‡ºåŠ›æ¡ä»¶ã€‘
- å‡ºåŠ›ã¯ã€Œç´”ç²‹ãªJSONé…åˆ—ã®ã¿ã€ï¼ˆMarkdownãƒ»ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹ã¯ç¦æ­¢ï¼‰
- ä¼æ¥­æ•°: ${count}ç¤¾
- å¯¾è±¡: ${regionClause}
- ${sectorClause}
- ãã‚Œãã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…ãšå«ã‚ã‚‹:
Â  ${fields.map(f=>"Â  - "+f).join("\n")}

ã€é‡è¦ï¼šé€šè²¨ã¨é‡‘é¡ã«ã¤ã„ã¦ã€‘
- å¯¾è±¡ãŒã©ã®å›½ã®ä¼æ¥­ã§ã‚ã£ã¦ã‚‚ï¼ˆä¸­å›½ã€ç±³å›½ã€æ¬§å·ãªã©ï¼‰ã€é‡‘é¡(cash, market_cap, rnd)ã¯å…¨ã¦**ã€Œæ—¥æœ¬å††ï¼ˆ10å„„å††å˜ä½/billion JPYï¼‰ã€ã«ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆã§æ›ç®—**ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
- currency ã¯å¿…ãš "JPY" ã¨ã—ã¦ãã ã•ã„ã€‚

ã€æ³¨æ„ã€‘
- domain ã¯ logo.clearbit.com ã§ãƒ­ã‚´å–å¾—ã«ä½¿ã„ã¾ã™ã€‚å…¬å¼ã‚µã‚¤ãƒˆã«è¿‘ã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
`.trim();

Â  Â  Â  return prompt;
Â  Â  }

    Â  Â  function normalizeImportedCompany(x){
Â  Â  Â  // Accept flexible keys; ensure required.
Â  Â  Â  const name = (x.name || x.name_en || "").toString().trim();
Â  Â  Â  const name_jp = (x.name_jp || x.jp || x.nameJa || "").toString().trim();
Â  Â  Â  const domain = (x.domain || "").toString().trim().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
Â  Â  Â  const sector = (x.sector || "").toString().trim();

Â  Â  Â  function num(v, def=0){
Â  Â  Â  Â  const n = Number(v);
Â  Â  Â  Â  return isFinite(n) ? n : def;
Â  Â  Â  }

Â  Â  Â  let cash = num(x.cash);
Â  Â  Â  let market_cap = num(x.market_cap);
Â  Â  Â  let rndv = num(x.rnd);

Â  Â  Â  const obj = {
        id: x.id ? String(x.id) : `imp-${hashStr(name+"|"+domain+"|"+Date.now()).toString(16)}`,
        name: name || (domain ? domain.split(".")[0].toUpperCase() : "Company"),
        name_jp: name_jp || "",
        domain: domain || "example.com",
        sector: SECTORS.some(s=>s.key===sector) ? sector : "Tech",
        currency: "JPY",
        cash: Math.max(0, cash),
        operating_margin: clamp(num(x.operating_margin, 8), 0, 70),
        equity_ratio: clamp(num(x.equity_ratio, 30), 0, 95),
        market_cap: Math.max(0, market_cap),
        employees: Math.max(0, Math.round(num(x.employees, 10000))),
        rnd: Math.max(0, rndv),
        Â  Â  Â  Â  // Skill Import
Â  Â  Â  Â  skill_name: (x.skill_name || "Corporate Impact").toString().trim(),
Â  Â  Â  Â  skill_desc: (x.skill_desc || "Standard strategic move.").toString().trim(),
Â  Â  Â  Â  skill_type: ["BURST","GUARD","SPEED","DRAIN","DOT","JAM","BUFF"].includes(x.skill_type) ? x.skill_type : "BURST",
Â  Â  Â  Â  // Attacks Import
Â  Â  Â  Â  attacks: Array.isArray(x.attacks) ? x.attacks.map(a=>({
Â  Â  Â  Â  Â  Â  name: (a.name||"Attack").toString().trim(),
Â  Â  Â  Â  Â  Â  desc: (a.desc||"").toString().trim()
Â  Â  Â  Â  })).slice(0,3) : []
Â  Â  Â  };

      return obj;
    }

    async function importJson(){
      const text = $("labJson").value.trim();
      if(!text){
        toast("JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚", "bad");
        return;
      }
      let arr;
      try{
        arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error("not array");
      }catch(e){
        toast("JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚é…åˆ—ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ", "bad");
        $("dbStatus").textContent = "JSON ERR";
        return;
      }

      Â  Â  Â  const normalized = arr.map(x=>normalizeImportedCompany(x));

      // merge by id (put)
      await dbPutMany(STORE_COMP, normalized);
      await loadCompanies();
      $("dbStatus").textContent = "IMPORTED";
      toast(`IMPORTå®Œäº†: ${normalized.length}ç¤¾`, "good");
      $("labJson").value = "";
    }

    async function exportAll(){
      const arr = state.companies;
      const json = JSON.stringify(arr, null, 2);
      // show in modal for copy
      modalShow("EXPORT ALL", "JSON", `
        <div class="text-sm text-slate-200/85 mb-2">ç¾åœ¨ã®ä¼æ¥­ãƒ—ãƒ¼ãƒ«ï¼ˆIndexedDBï¼‰ã‚’JSONã§å‡ºåŠ›ã—ã¾ã—ãŸã€‚</div>
        <textarea class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" rows="14">${json.replace(/</g,"&lt;")}</textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2" id="btnCopyExport">
            <i data-lucide="copy" class="w-4 h-4"></i><span class="mono">COPY</span>
          </button>
        </div>
      `);
      lucide.createIcons();
      setTimeout(()=>{
        const btn = $("btnCopyExport");
        if(btn){
          btn.onclick = async ()=>{
            const ok = await copyToClipboard(json);
            toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", ok?"good":"bad");
          };
        }
      },0);
    }

    /********************
     * LOAD / INIT
     ********************/
        async function seedIfEmpty(){
      // ã‚³ãƒ¼ãƒ‰ä¸Šã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’DBã¸å¼·åˆ¶åŒæœŸï¼ˆè¿½åŠ ã—ãŸä¼æ¥­ã‚’å³åº§ã«åæ˜ ã•ã›ã‚‹ãŸã‚ï¼‰
      await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);

      // load settings
      const fx = await metaGet("fx");
      if(fx && typeof fx==="object"){
        state.fx = {...state.fx, ...fx};
      } else {
        await metaSet("fx", state.fx);
      }
    }

    async function loadCompanies(){
      const all = await dbGetAll(STORE_COMP);
      // stable sort by name
      all.sort((a,b)=> (a.name_jp||a.name).localeCompare((b.name_jp||b.name), "ja"));
      state.companies = all;
      $("dbCount").textContent = all.length;
      renderSelects();
      buildTicker();
    }

    function renderSelects(){
      const selP = $("selPlayer");
      const selC = $("selCPU");
      selP.innerHTML = "";
      selC.innerHTML = "";
      for(const c of state.companies){
        const opt1 = document.createElement("option");
        opt1.value = c.id;
        opt1.textContent = companyLabel(c);
        const opt2 = opt1.cloneNode(true);
        selP.appendChild(opt1);
        selC.appendChild(opt2);
      }

      // default picks
      if(!state.playerId || !getCompany(state.playerId)){
        state.playerId = state.companies[0]?.id || null;
      }
      if(!state.cpuId || !getCompany(state.cpuId)){
        state.cpuId = state.companies[1]?.id || state.companies[0]?.id || null;
      }
            selP.value = state.playerId;
      selC.value = state.cpuId;

      updateSectorTags();
      updateMenuStats();
    }

    function updateSectorTags(){
      const p = getCompany($("selPlayer").value);
      const c = getCompany($("selCPU").value);
      $("tagYourSector").textContent = p?.sector || "â€”";
      $("tagCpuSector").textContent = c?.sector || "â€”";
    }

    function buildTicker(){
      const msgs = [];
      const s = seededRand(Date.now());
      // Make a pseudo Bloomberg tape from pool
      const pool = [...state.companies];
      pool.sort(()=>s()-0.5);
      for(let i=0;i<Math.min(10,pool.length);i++){
        const c = pool[i];
        const bias = (c.operating_margin - 10) * 0.18 + (c.equity_ratio - 30) * 0.06;
        const change = clamp(rnd(-2.0, 2.8) + bias*0.12, -4.9, 6.2);
        const col = change>=0 ? "text-emerald-300" : "text-rose-300";
        msgs.push(`<span class="${col}">${(c.name||"").slice(0,10).toUpperCase()}</span> <span class="text-slate-200/80">Î”</span> <span class="${col}">${change>=0?"+":""}${change.toFixed(2)}%</span>`);
      }
      // duplicate for seamless scroll
      const track = $("tickerTrack");
      track.innerHTML = (msgs.concat(msgs)).map(m=>`<span class="mx-2">${m}</span>`).join("");
    }

    /********************
     * ACTIONS
     ********************/
        function randomPickDifferent(currentId){
      const ids = state.companies.map(c=>c.id).filter(id=>id!==currentId);
      return ids.length ? pick(ids) : currentId;
    }

    function generateCityScape(){
      const wrap = $("cityScape");
      if(!wrap) return;
      wrap.innerHTML = "";
      // Generate random buildings
      const count = 40;
      for(let i=0; i<count; i++){
        const b = document.createElement("div");
        b.className = "building";
        // Random properties
        const h = rnd(60, 240); // height
        const w = rnd(20, 70);  // width
        const l = rnd(-10, 110); // left position %
        const dist = rnd(0.5, 1.0); // distance scale factor
        
        b.style.height = `${h * dist}px`;
        b.style.width = `${w * dist}px`;
        b.style.left = `${l}%`;
        b.style.zIndex = Math.floor(dist * 100);
        b.style.opacity = dist * 0.8;
        b.style.filter = `blur(${(1-dist)*2}px)`;
        
        // Random window lights color
        if(Math.random() > 0.7) {
           b.style.borderTopColor = "rgba(167,139,250,0.6)";
        }
        wrap.appendChild(b);
      }
    }

function startBattle({auto=false, tournamentCtx=null}={}){
      MenuAudioEngine.stop(); // Menu BGM Stop
      
      const p = getCompany(state.playerId);
      const c = getCompany(state.cpuId);
      if(!p || !c){
        toast("ä¼æ¥­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "bad");
        return;
      }
      if(p.id === c.id){
        toast("åŒã˜ä¼æ¥­åŒå£«ã¯é¸ã¹ã¾ã›ã‚“ã€‚", "bad");
        return;
      }
      
      // --- BGM SELECTION (Boss vs Normal) ---
      // If CPU is 3x bigger (Market Cap) OR is in strong sectors (Finance/Energy), play Boss Theme
      const pVal = p.market_cap || 0;
      const cVal = c.market_cap || 0;
      const isBoss = (cVal > pVal * 3) || ['Finance','Energy'].includes(c.sector);
      
      if(isBoss) BossAudioEngine.play();
      else AudioEngine.play();
      
      // Store boss state for stop
      state.isBossBattle = isBoss;

      state.battle = battleCreate(p, c);
      state.battle.logs = [];
      state.battle.turn = 1;
      state.battle.auto = !!auto;
      state.battle.paused = false;
      state.battle.tournamentCtx = tournamentCtx;

      // initial log
      state.battle.log(`<span class="tag">OPENING</span> <b>${p.name_jp || p.name}</b> ãŒå‡ºæ’ƒã€‚æ•µã¯ <b>${c.name_jp || c.name}</b>ã€‚`);
      state.battle.log(`<div class="mt-1 text-xs grid grid-cols-2 gap-2"><div class="text-sky-300">[P] ${p.skill_name}</div><div class="text-rose-300 text-right">[C] ${c.skill_name}</div></div>`);
      
      generateCityScape(); // Draw background city
      
      // --- APPLY INTRO ANIMATION ---
      const stage = $("arena").querySelector(".battle-stage");
      const spP = $("spritePlayer");
      const spC = $("spriteCPU");
      const huds = $("arena").querySelectorAll(".hud-wrap");

      if(stage) stage.classList.add("intro-camera-mode");
      if(spP) spP.classList.add("intro-sprite-mode");
      if(spC) spC.classList.add("intro-sprite-mode");
      huds.forEach(h => h.classList.add("intro-hud-wait"));

      renderBattleUI();
      showScreen(Screens.Battle);

      // Cleanup classes after animation
      setTimeout(()=>{
        if(stage) stage.classList.remove("intro-camera-mode");
        if(spP) spP.classList.remove("intro-sprite-mode");
        if(spC) spC.classList.remove("intro-sprite-mode");
        huds.forEach(h => h.classList.remove("intro-hud-wait"));
        
        // Landing Impact
        if(state.battle && !state.battle.finished) state.battle.fx(null, "IMPACT");
      }, 2500);

      if(auto){
        toast("AUTOè¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰", "good");
        runAutoLoop();
      }
    }

        async function runAutoLoop(){
      const b = state.battle;
      if(!b) return;
      while(state.battle === b && !b.finished){
        if(b.paused){ await sleep(200); continue; }
        const act = cpuChooseAction(b); // for player side too, in auto
        await runTurn(act);
        await sleep(600);
      }
      // if tournament context, commit winner to bracket
      if(b?.tournamentCtx && b.finished){
        const {match, round} = b.tournamentCtx;
        const wId = (b.winner==="P") ? state.playerId : (b.winner==="C") ? state.cpuId : (Math.random()<0.5 ? state.playerId : state.cpuId);
        match.w = wId;

        const wn = getCompany(wId)?.name_jp || getCompany(wId)?.name;
        tlog(`${round.toUpperCase()}: <b>${getCompany(match.a).name_jp || getCompany(match.a).name}</b> vs <b>${getCompany(match.b).name_jp || getCompany(match.b).name}</b> â†’ <span class="text-emerald-300">WIN: ${wn}</span>`);
        renderTournament();

        // if champion decided
        if(state.tournament?.f?.[0]?.w){
          confetti({particleCount: 240, spread: 85, startVelocity: 44, scalar: 1.05, origin:{x:0.5, y:0.32}});
          tlog(`<span class="mono font-black text-emerald-300">CHAMPION</span> â€” ${getCompany(state.tournament.f[0].w).name_jp || getCompany(state.tournament.f[0].w).name}`);
        }
      }
    }

    /********************
     * RESET / RESTORE
     ********************/
    async function restoreSample(){
      await dbClear(STORE_COMP);
      await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);
      await loadCompanies();
      toast("ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«å¾©å…ƒã—ã¾ã—ãŸã€‚", "good");
    }

    async function clearDb(){
      await dbClear(STORE_COMP);
      await loadCompanies();
      toast("DBã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", "bad");
    }

    /********************
     * HOOKS
     ********************/
    function wire(){
      // nav
      $("btnGoStart").onclick = ()=>showScreen(Screens.Start);
      $("btnGoLab").onclick = ()=>showScreen(Screens.Lab);
            $("btnGoTournament").onclick = ()=>showScreen(Screens.Tournament);

      // Old button removed, wire new one
      const btnLab = $("btnOpenLabFromStart");
      if(btnLab) btnLab.onclick = ()=>showScreen(Screens.Lab);

      $("btnLabBack").onclick = ()=>showScreen(Screens.Start);
      $("btnTournamentBack").onclick = ()=>showScreen(Screens.Start);

      // modal
      $("btnCloseModal").onclick = modalHide;
      $("modal").addEventListener("click",(e)=>{
        if(e.target === $("modal").querySelector(".absolute")) modalHide();
      });

            // selects
      $("selPlayer").onchange = ()=>{
        state.playerId = $("selPlayer").value;
        updateSectorTags();
        updateMenuStats();
      };
      $("selCPU").onchange = ()=>{
        state.cpuId = $("selCPU").value;
        updateSectorTags();
        updateMenuStats();
      };

      $("btnRandomPlayer").onclick = ()=>{
        state.playerId = randomPickDifferent(state.playerId);
        $("selPlayer").value = state.playerId;
        updateSectorTags();
        updateMenuStats();
        toast("YOUR COMPANY ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ", "good");
      };
      $("btnRandomCPU").onclick = ()=>{
        state.cpuId = randomPickDifferent(state.cpuId);
        $("selCPU").value = state.cpuId;
        updateSectorTags();
        updateMenuStats();
        toast("ENEMY ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ", "good");
      };

      $("btnInspectPlayer").onclick = ()=>{
        const c = getCompany(state.playerId);
        if(c) openInspectModal(c);
      };
      $("btnInspectCPU").onclick = ()=>{
        const c = getCompany(state.cpuId);
        if(c) openInspectModal(c);
      };

      // start battle
      $("btnStartBattle").onclick = ()=>startBattle({auto:false});
      $("btnStartTournamentFromStart").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          showScreen(Screens.Tournament);
          toast("ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç”Ÿæˆå®Œäº†", "good");
        }
      };

                        // battle nav
// battle nav
      $("btnBattleBackStart").onclick = ()=>{
        AudioEngine.stop();
        BossAudioEngine.stop();
        MenuAudioEngine.play(); // Resume Menu BGM
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnBattleToResult").onclick = ()=>{
        finishBattle();
      };

      // commands
      $("cmdAttack").onclick = ()=>runTurn("Attack");
      $("cmdGuard").onclick = ()=>runTurn("Guard");
      $("cmdPivot").onclick = ()=>runTurn("Pivot");
      $("cmdSkill").onclick = ()=>runTurn("Skill");

      $("btnClearLog").onclick = ()=>{
        if(state.battle){
          state.battle.logs = [];
          renderLog();
          toast("ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢", "good");
        }
      };

      $("btnAuto").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.auto = !b.auto;
        toast(b.auto ? "AUTO ON" : "AUTO OFF", b.auto ? "good":"info");
        renderBattleUI();
        if(b.auto) runAutoLoopManualMode();
      };

          async function runAutoLoopManualMode(){
      const b = state.battle;
      while(state.battle === b && b.auto && !b.finished){
        if(b.paused){ await sleep(220); continue; }
        const act = cpuChooseAction(b); // for player side too
        await runTurn(act);
        await sleep(600);
      }
    }

      $("btnPause").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.paused = !b.paused;
        toast(b.paused ? "PAUSED" : "RESUMED", b.paused ? "bad":"good");
        renderBattleUI();
      };

// result
      $("btnResultBack").onclick = ()=>{
        FanfareEngine.stop();
        RequiemEngine.stop();
        MenuAudioEngine.play(); // Resume Menu BGM
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnRematch").onclick = ()=>{
        FanfareEngine.stop();
        RequiemEngine.stop();
        if(!state.battle) return;
        // Stop any lingering
        AudioEngine.stop();
        BossAudioEngine.stop();
        const p = state.battle.P.company.id;
        const c = state.battle.C.company.id;
        state.playerId = p; state.cpuId = c;
        startBattle({auto:false});
      };

      // tournament
      $("btnNewBracket").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          toast("æ–°ã—ã„ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚’ç”Ÿæˆ", "good");
        }
      };
      $("btnRunNextMatch").onclick = ()=>playNextMatchInteractive();
      $("btnAutoSim").onclick = ()=>autoSimTournament();

      // lab
      $("btnGeneratePrompt").onclick = ()=>{
        const p = generatePrompt();
        $("labPrompt").value = p;
        toast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå®Œäº†", "good");
      };
      $("btnCopyPrompt").onclick = async ()=>{
        const t = $("labPrompt").value.trim();
        if(!t){ toast("å…ˆã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚","bad"); return; }
        const ok = await copyToClipboard(t);
        toast(ok ? "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚" : "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", ok?"good":"bad");
      };
      $("btnClearPrompt").onclick = ()=>{$("labPrompt").value=""; toast("ã‚¯ãƒªã‚¢","good");};

      $("btnImportJson").onclick = ()=>importJson();
      $("btnExportJson").onclick = ()=>exportAll();

      $("btnClearDb").onclick = async ()=>{
        if(!confirm("DBã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await clearDb();
      };
      $("btnRestoreSample").onclick = async ()=>{
        if(!confirm("ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«å¾©å…ƒã—ã¾ã™ï¼ˆè¿½åŠ ä¼æ¥­ã¯æ¶ˆãˆã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await restoreSample();
      };

      // start screen reset
      $("btnResetSample").onclick = async ()=>{
        if(!confirm("åˆæœŸã‚µãƒ³ãƒ—ãƒ«ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆè¿½åŠ ä¼æ¥­ã¯æ¶ˆãˆã¾ã™ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await restoreSample();
      };

      
    }

    /********************
     * INIT
     ********************/
    (async function init(){
      lucide.createIcons();
      renderSectorChoices();
      await seedIfEmpty();
      await loadCompanies();

      

            wire();
      
      // Show Title Screen First
      showScreen(Screens.Title);

      // Setup Title Interaction
      const titleScreen = $("screenTitle");
      if(titleScreen) {
        const onStartGame = async () => {
          // Remove listener to prevent double trigger
          titleScreen.onclick = null;
          
          // Play Menu BGM
          console.log("Game Start: Playing Menu BGM");
          await MenuAudioEngine.play();
          
          // Move to Menu
          showScreen(Screens.Start);
          toast("WELCOME, CEO.", "good");
        };
        titleScreen.onclick = onStartGame;
      } else {
        // Fallback if title missing
        showScreen(Screens.Start);
      }

            // default tournament object placeholder
      state.tournament = null;

      // initial stats
      updateMenuStats();

      $("dbStatus").textContent = "OK";
    })();
  </script>





























<script id="lfs-meta" type="application/json">
{
  "appId": "ea644a3fa162beb269314f429c0dec93",
  "createdAt": "2026-02-02T16:25:29.642Z",
  "schema": 2,
  "title": "CORPORATE QUEST â€” Real Company Battle",
  "savedAt": "2026-02-03T18:37:39.660Z",
  "aiInstruction": "æ•µå¯¾çš„è²·åã‚’ã—ã‹ã‘ãŸã¨ãã€ãƒ‰æ´¾æ‰‹ãªæ¼”å‡ºã‚’åŠ ãˆã‚‹ã€‚",
  "comment": "æ•µå¯¾çš„è²·åã‚’ã—ã‹ã‘ãŸã¨ãã€ãƒ‰æ´¾æ‰‹ãªæ¼”å‡ºã‚’åŠ ãˆã‚‹ã€‚",
  "sourceMode": "project",
  "runId": "dc386dc4e21fa6525c9638c3f20c79e0"
}
</script>
</body>
</html>
