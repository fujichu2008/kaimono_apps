<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CORPORATE QUEST ‚Äî Real Company Battle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- canvas-confetti -->
    
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
        .summon-emoji { 
      position: absolute; font-size: 48px; bottom: 0; 
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6)); 
      z-index: 25; pointer-events: none;
      animation: floatSummon 2s ease-in-out infinite;
    }
    @keyframes floatSummon { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }

    /* ÈªíÂ°ó„Çä„Éè„Ç§„É§„ÉºÁôªÂ†¥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .summon-car-enter {
      position: absolute; font-size: 64px; bottom: 0; z-index: 30; pointer-events: none;
      filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.8));
      animation: carSlideIn 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    @keyframes carSlideIn {
      0% { transform: translateX(var(--startX)) scaleX(var(--dir)); opacity: 0; }
      100% { transform: translateX(0) scaleX(var(--dir)); opacity: 1; }
    }
        /* ÊüªÂØüÂÆò„ÅÆË°åÈÄ≤ */
    .summon-mob-march {
      position: absolute; bottom: 0; display:flex; gap:-10px; z-index: 30; pointer-events: none;
      animation: mobMarch 2s ease-out forwards;
    }
    @keyframes mobMarch {
      0% { transform: translateX(var(--startX)); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    /* „Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„ÉºÁôªÂ†¥ */
    .summon-influencer-spin {
      position: absolute; bottom: 10%; z-index: 30; pointer-events: none; font-size: 56px;
      filter: drop-shadow(0 0 15px #d946ef);
      animation: spinSelfie 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite alternate;
    }
        @keyframes spinSelfie {
      0% { transform: rotate(-15deg) scale(0.9); }
      100% { transform: rotate(15deg) scale(1.1); }
    }
        /* ÊïóÂåóÊôÇ„ÅÆÂ¥©Â£ä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .collapse-anim {
      animation: collapseDown 2.8s cubic-bezier(0.36, 0, 0.66, -0.56) forwards !important;
      filter: grayscale(100%) brightness(0.3) !important;
      pointer-events: none;
    }
    @keyframes collapseDown {
      0% { transform: translate(0,0) scale(1); }
      10% { transform: translate(-6px, 6px) scale(1); }
      20% { transform: translate(6px, -6px) scale(1); }
      30% { transform: translate(-6px, 6px) scale(0.98); }
      40% { transform: translate(6px, -6px) scale(0.95); opacity: 1; }
      100% { transform: translate(0, 180px) scaleY(0.1) scaleX(1.4); opacity: 0; }
    }

    /* Á•û„ÄÖ„Åó„ÅÑÊîøÊ≤ªÂÆ∂„Ç™„Éº„É© */
    .summon-god-aura {
      z-index: 40 !important;
      animation: godPulse 1.5s ease-in-out infinite alternate !important;
    }
    @keyframes godPulse {
      0% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 15px #fbbf24); }
      100% { transform: translateY(-10px) scale(1.2); filter: drop-shadow(0 0 50px #fcd34d) brightness(1.3); }
    }
    :root{
      --bg0:#070A12;
      --bg1:#0B1223;
      --panel:#0C152B;
      --line:#1E2B4F;
      --neon:#35F7FF;
      --neon2:#A78BFA;
      --warn:#FBBF24;
      --good:#34D399;
      --bad:#FB7185;
      --text:#D6E2FF;
      --muted:#93A4C8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%; background: radial-gradient(1200px 600px at 20% 10%, rgba(53,247,255,.08), transparent 55%),
                                 radial-gradient(900px 500px at 70% 20%, rgba(167,139,250,.10), transparent 60%),
                                 linear-gradient(180deg,var(--bg0),var(--bg1));
              color:var(--text);}
    .safe-pad{padding-bottom: max(16px, env(safe-area-inset-bottom)); padding-top: max(16px, env(safe-area-inset-top));}
    .panel{
      background: linear-gradient(180deg, rgba(12,21,43,.88), rgba(7,10,18,.72));
      border:1px solid rgba(53,247,255,.16);
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 24px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .panel2{
      background: linear-gradient(180deg, rgba(12,21,43,.80), rgba(11,18,35,.50));
      border:1px solid rgba(148,163,184,.18);
    }
    .scanline{
      position:absolute; inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.02) 0px,
        rgba(255,255,255,.02) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      mix-blend-mode: overlay;
      opacity:.35;
      border-radius: 18px;
    }
    .neon-border{
      border:1px solid rgba(53,247,255,.25);
      box-shadow: 0 0 0 1px rgba(53,247,255,.14), 0 0 24px rgba(53,247,255,.10);
    }
    .chip{
      font-family: var(--mono);
      letter-spacing:.02em;
      border:1px solid rgba(53,247,255,.22);
      background: rgba(53,247,255,.06);
      color: #CFFBFF;
    }
    .mono{font-family: var(--mono);}
    .ticker{
      position: relative;
      overflow:hidden;
      border-top:1px solid rgba(148,163,184,.12);
      border-bottom:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.55);
    }
    .ticker .track{
      display:flex; gap:32px;
      white-space:nowrap;
      will-change: transform;
      animation: scroll 22s linear infinite;
      padding: 10px 0;
      font-family: var(--mono);
      color: rgba(214,226,255,.85);
      text-shadow: 0 0 12px rgba(53,247,255,.12);
    }
    @keyframes scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .btn{
      border:1px solid rgba(53,247,255,.22);
      background: linear-gradient(180deg, rgba(53,247,255,.12), rgba(53,247,255,.04));
      box-shadow: 0 0 0 1px rgba(167,139,250,.10);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn:hover{filter: brightness(1.15); border-color: rgba(53,247,255,.40);}
    .btn:active{transform: translateY(1px) scale(.99);}

    .btn2{
      border:1px solid rgba(167,139,250,.26);
      background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.05));
      box-shadow: 0 0 0 1px rgba(53,247,255,.08);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn2:hover{filter: brightness(1.15); border-color: rgba(167,139,250,.42);}
    .btn2:active{transform: translateY(1px) scale(.99);}

    .btnDanger{
      border:1px solid rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.05));
    }

    .glowText{
      text-shadow: 0 0 18px rgba(53,247,255,.22), 0 0 32px rgba(167,139,250,.12);
    }

    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.18);
      overflow:hidden;
      position: relative;
    }
    .bar > .fill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(53,247,255,.95), rgba(167,139,250,.92));
      box-shadow: 0 0 20px rgba(53,247,255,.16);
      transition: width .45s cubic-bezier(.2,.9,.2,1);
    }
    .bar > .fill.hp{
      background: linear-gradient(90deg, rgba(52,211,153,.95), rgba(53,247,255,.80));
    }
    .bar > .fill.danger{
      background: linear-gradient(90deg, rgba(251,113,133,.95), rgba(245,158,11,.65));
    }

    .shake{ animation: shake .35s ease-in-out; }
    @keyframes shake{
      0%{transform: translate(0,0);}
      20%{transform: translate(-6px,2px);}
      40%{transform: translate(6px,-2px);}
      60%{transform: translate(-4px,-2px);}
      80%{transform: translate(4px,2px);}
      100%{transform: translate(0,0);}
    }

    .flash{
      position: relative;
    }
    .flash::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 18px;
      background: radial-gradient(700px 300px at 30% 20%, rgba(53,247,255,.28), transparent 60%),
                  radial-gradient(500px 300px at 70% 50%, rgba(167,139,250,.20), transparent 65%);
      opacity: 0;
      pointer-events:none;
      animation: flash .55s ease-out;
    }
    @keyframes flash{
      0%{opacity:.9;}
      100%{opacity:0;}
    }

    .crit{
      animation: pop .38s ease-out;
    }
    @keyframes pop{
      0%{transform: scale(.92); opacity:.75;}
      60%{transform: scale(1.04); opacity:1;}
      100%{transform: scale(1); opacity:1;}
    }

    .floatDmg{
      position:absolute;
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing:.02em;
      text-shadow: 0 0 18px rgba(53,247,255,.18);
      animation: floatUp .95s ease-out forwards;
      pointer-events:none;
      user-select:none;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) scale(.98); opacity: 0; }
      15%{ opacity: 1; }
      100%{ transform: translateY(-38px) scale(1.02); opacity: 0; }
    }

    .logoWrap{
      width: 96px; height: 96px;
      border-radius: 18px;
      border:1px solid rgba(53,247,255,.22);
      background: radial-gradient(220px 160px at 30% 20%, rgba(53,247,255,.12), transparent 55%),
                  radial-gradient(220px 160px at 70% 60%, rgba(167,139,250,.12), transparent 60%),
                  rgba(2,6,23,.65);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 18px 60px rgba(0,0,0,.35);
      position: relative;
    }
    .logoWrap img{width: 82%; height: 82%; object-fit: contain; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));}
    .logoFallback{
      width: 80px; height: 80px; border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      font-weight: 800;
      font-size: 30px;
      letter-spacing: .02em;
      color: rgba(207,251,255,.95);
      background: linear-gradient(180deg, rgba(53,247,255,.14), rgba(167,139,250,.10));
      border:1px solid rgba(53,247,255,.18);
      text-shadow: 0 0 18px rgba(53,247,255,.24);
    }

    .kbd{
      font-family: var(--mono);
      border:1px solid rgba(148,163,184,.22);
      background: rgba(148,163,184,.08);
      padding:.15rem .35rem;
      border-radius: .5rem;
      color: rgba(214,226,255,.92);
      font-size: 12px;
    }

    .tag{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(148,163,184,.06);
      color: rgba(214,226,255,.86);
      font-family: var(--mono);
      font-size: 12px;
      padding: .15rem .45rem;
      border-radius: 999px;
    }

    textarea{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(53,247,255,.35);
      box-shadow: 0 0 0 3px rgba(53,247,255,.08);
    }
    select,input{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
    ¬† ¬† select:focus,input:focus{
¬† ¬† ¬† border-color: rgba(53,247,255,.35);
¬† ¬† ¬† box-shadow: 0 0 0 3px rgba(53,247,255,.08);
¬† ¬† }

¬† ¬† .quake { animation: quake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
¬† ¬† @keyframes quake {
¬† ¬† ¬† 10%, 90% { transform: translate3d(-3px, 0, 0) rotate(1deg); }
¬† ¬† ¬† 20%, 80% { transform: translate3d(5px, 0, 0) rotate(-1deg); }
¬† ¬† ¬† 30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotate(2deg); }
¬† ¬† ¬† 40%, 60% { transform: translate3d(8px, 0, 0) rotate(-2deg); }
¬† ¬† }
¬† ¬† .glitch-anim { animation: glitch-skew 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; }
¬† ¬† @keyframes glitch-skew {
¬† ¬† ¬† 0% { transform: skew(0deg); }
¬† ¬† ¬† 20% { transform: skew(-2deg); }
¬† ¬† ¬† 40% { transform: skew(2deg); }
¬† ¬† ¬† 60% { transform: skew(-1deg); }
¬† ¬† ¬† 80% { transform: skew(1deg); }
¬† ¬† ¬† 100% { transform: skew(0deg); }
¬† ¬† }

    .hidden{display:none;}

            /* --- POKEMON-STYLE BATTLE CSS --- */
    .battle-stage {
      position: relative;
      height: 380px;
      background: linear-gradient(180deg, #0f172a 0%, #020617 60%);
      perspective: 600px;
      overflow: hidden;
    }
    /* 3D Grid Floor Effect - Enhanced Visibility */
    .battle-stage::after {
      content:""; position:absolute; inset:-100%; top:35%;
      background:
        linear-gradient(180deg, rgba(2,6,23,0) 0%, rgba(2,6,23,1) 80%),
        repeating-linear-gradient(90deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px),
        repeating-linear-gradient(0deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px);
      transform: rotateX(75deg);
      z-index: 2;
      pointer-events: none;
      mask-image: linear-gradient(to bottom, transparent 0%, black 20%);
    }
    /* City Scape */
    .city-wrap {
      position: absolute; top: 0; left: 0; right: 0; height: 100%;
      pointer-events: none; z-index: 1;
      transform-style: preserve-3d;
    }
    .building {
      position: absolute; bottom: 35%; /* align with grid horizon */
      background: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(2,6,23,1) 100%);
      border-top: 1px solid rgba(53,247,255,0.3);
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
      transform-origin: bottom center;
    }
    .building::after {
      content:""; position:absolute; inset:0;
      background-image: radial-gradient(rgba(167,139,250,0.3) 1px, transparent 1px);
      background-size: 4px 6px;
      opacity: 0.6;
    }
    /* Ground Effects */
    .stage-ground-p {
      position: absolute; bottom: -30px; left: -10%; width: 320px; height: 100px;
      background: rgba(53,247,255,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(53,247,255,0.1); box-shadow: 0 0 30px rgba(53,247,255,0.05);
    }
    .stage-ground-c {
      position: absolute; top: 40px; right: -5%; width: 280px; height: 90px;
      background: rgba(167,139,250,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(167,139,250,0.1); box-shadow: 0 0 30px rgba(167,139,250,0.05);
    }
        /* Sprites - Centered */
    .sprite-wrap {
      position: absolute;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      filter: drop-shadow(0 24px 48px rgba(0,0,0,0.7));
      z-index: 10;
    }
    /* Move inward (30%) to avoid overlap with HUD and reduce emptiness */
    .pos-p { bottom: 60px; left: 30%; }
    .pos-c { top: 70px; right: 30%; z-index: 5; }
    
    /* HUDs - Corner Anchor */
    .hud-wrap {
      position: absolute; width: 260px; padding: 12px 16px;
      background: rgba(15,23,42,0.85); border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px; backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      pointer-events: none; /* click through */
      z-index: 30;
    }
    /* Player HUD: Left Bottom corner */
    .hud-p { bottom: 16px; left: 16px; border-left: 4px solid #35F7FF; transform: translateZ(20px); }
    /* CPU HUD: Right Top corner */
    .hud-c { top: 16px; right: 16px; border-right: 4px solid #A78BFA; transform: scale(0.95); opacity: 0.95; }

    /* Center Effect */
    .center-ring {
      position: absolute; top: 60%; left: 50%; width: 400px; height: 400px;
      transform: translate(-50%, -50%) rotateX(60deg);
      border: 2px dashed rgba(53,247,255,0.12);
      border-radius: 50%;
      animation: spin-slow 30s linear infinite;
      z-index: 2;
      pointer-events: none;
    }
    .center-ring::after {
      content:""; position:absolute; inset:40px; border: 1px solid rgba(167,139,250,0.15); border-radius: 50%;
    }

        /* Shadows - Aligned with Sprites */
    .shadow-marker {
      position: absolute; width: 100px; height: 24px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.7) 0%, transparent 70%);
      border-radius: 50%; z-index: 3;
      animation: shadow-scale 4s ease-in-out infinite;
    }
    /* Aligned with new sprite positions (30%) */
    .sh-p { bottom: 60px; left: 30%; margin-left: 10px; }
    .sh-c { top: 150px; right: 30%; margin-right: 10px; }

    /* Animations */
    @keyframes spin-slow { 0%{transform:translate(-50%, -50%) rotateX(60deg) rotate(0deg);} 100%{transform:translate(-50%, -50%) rotateX(60deg) rotate(360deg);} }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-14px);} }
    @keyframes shadow-scale { 0%,100%{transform:scale(1); opacity:0.6;} 50%{transform:scale(0.8); opacity:0.4;} }

        /* Direction Variables for Sprites (P: LeftBottom->RightTop, C: RightTop->LeftBottom) */
    .pos-p { --tx: 1; --ty: -1; }
    .pos-c { --tx: -1; --ty: 1; }

    /* Standard Attack */
    @keyframes lunge { 
      0%{transform:translate(0,0) scale(1);} 
      40%{transform:translate(calc(80px*var(--tx)), calc(80px*var(--ty))) scale(1.15);} 
      100%{transform:translate(0,0) scale(1);} 
    }
    .atk-anim { animation: lunge 0.5s ease-in-out !important; }

    /* --- 20 UNIQUE SKILL MOTIONS --- */
    .skill-anim { animation-duration: 1.8s !important; animation-timing-function: ease-in-out !important; z-index: 100; }

    /* 1. Smash: Power charge and heavy hit */
    @keyframes m-smash { 0%{transform:scale(1)} 30%{transform:translate(calc(-30px*var(--tx)),calc(-30px*var(--ty))) scale(0.8); filter:brightness(2) drop-shadow(0 0 20px white)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.6)} 100%{transform:scale(1)} }
    /* 2. Rush: Vibration and rapid dash */
    @keyframes m-rush { 0%{transform:scale(1)} 20%{transform:translate(calc(-10px*var(--tx)),0) skew(10deg)} 40%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty))) scale(1.1)} 45%{transform:translate(0,0)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 3. Sonic: Disappear and strike */
    @keyframes m-sonic { 0%{transform:scale(1); opacity:1} 30%{transform:scale(0.1); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5); opacity:1; filter:contrast(2)} 100%{transform:scale(1)} }
    /* 4. Snipe: Stationary charge and recoil */
    @keyframes m-snipe { 0%{transform:scale(1)} 40%{transform:scale(0.9); filter:brightness(3)} 45%{transform:translate(calc(-40px*var(--tx)),calc(-40px*var(--ty))) scale(1); filter:hue-rotate(90deg)} 100%{transform:scale(1)} }
    /* 5. Drill: Spin attack */
    @keyframes m-drill { 0%{transform:rotate(0)} 30%{transform:rotate(360deg) scale(0.5)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) rotate(1080deg) scale(1.3)} 100%{transform:rotate(0)} }
    /* 6. Jump: High arch */
    @keyframes m-jump { 0%{transform:scale(1)} 30%{transform:translateY(-150px) scale(1.2)} 60%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }
    /* 7. Zigzag */
    @keyframes m-zigzag { 0%{transform:translate(0,0)} 20%{transform:translate(calc(40px*var(--tx)),calc(-40px*var(--ty)))} 40%{transform:translate(calc(80px*var(--tx)),calc(40px*var(--ty)))} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.3)} 100%{transform:translate(0,0)} }
    /* 8. Tackle: Simple heavy charge */
    @keyframes m-tackle { 0%{transform:scale(1)} 25%{transform:rotate(calc(-15deg*var(--tx)))} 50%{transform:translate(calc(190px*var(--tx)),calc(190px*var(--ty))) scale(1.4)} 100%{transform:scale(1)} }
    /* 9. Uppercut */
    @keyframes m-uppercut { 0%{transform:translate(0,0)} 30%{transform:translate(0, 50px) scale(0.8)} 50%{transform:translate(calc(150px*var(--tx)), -150px) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 10. Meteor: From sky */
    @keyframes m-meteor { 0%{transform:translate(0,0)} 20%{transform:translateY(-200px) scale(0.5); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.6); opacity:1} 100%{transform:translate(0,0)} }
    /* 11. Shadow: Vibration blur */
    @keyframes m-shadow { 0%{transform:scale(1)} 30%{transform:translate(calc(10px*var(--tx)),0); filter:blur(4px)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.2); filter:blur(0)} 100%{transform:scale(1)} }
    /* 12. Giant: Giant growth */
    @keyframes m-giant { 0%{transform:scale(1)} 40%{transform:scale(2.2); filter:brightness(1.5); z-index:100} 60%{transform:translate(calc(80px*var(--tx)),calc(80px*var(--ty))) scale(2.2)} 100%{transform:scale(1)} }
    /* 13. Helix: Spiral */
    @keyframes m-helix { 0%{transform:rotate(0)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(calc(360deg*var(--tx)))} 100%{transform:translate(0,0)} }
    /* 14. Impact: Slow start fast hit */
    @keyframes m-impact { 0%{transform:scale(1)} 50%{transform:translate(calc(50px*var(--tx)),calc(50px*var(--ty))) scale(1)} 55%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.8); filter:invert(1)} 100%{transform:scale(1)} }
    /* 15. Wobble */
    @keyframes m-wobble { 0%{transform:rotate(0)} 25%{transform:rotate(20deg)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(-20deg) scale(1.4)} 100%{transform:rotate(0)} }
    /* 16. Charge: Long wait */
    @keyframes m-charge { 0%{transform:scale(1)} 40%{transform:scale(0.6); filter:brightness(0.5)} 45%{transform:scale(1.2); filter:brightness(2)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 17. Boomerang */
    @keyframes m-boomerang { 0%{transform:rotate(0)} 40%{transform:translate(calc(100px*var(--tx)), -100px) rotate(180deg)} 60%{transform:translate(calc(200px*var(--tx)),calc(100px*var(--ty))) rotate(360deg)} 100%{transform:rotate(0)} }
    /* 18. Frenzy: Random shake */
    @keyframes m-frenzy { 0%{transform:translate(0,0)} 20%{transform:translate(20px, -20px)} 40%{transform:translate(-20px, 20px)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 19. Stealth: Fade out in */
    @keyframes m-stealth { 0%{opacity:1} 20%{opacity:0.2; transform:scale(0.8)} 50%{opacity:1; transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.3)} 100%{opacity:1} }
    /* 20. Pulse */
    @keyframes m-pulse { 0%{transform:scale(1)} 20%{transform:scale(1.4)} 40%{transform:scale(0.8)} 60%{transform:translate(calc(170px*var(--tx)),calc(170px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }

    .dmg-anim { animation: shake 0.45s ease-in-out; filter: brightness(2.5) hue-rotate(180deg) !important; }
    .guard-anim { filter: brightness(1.3) drop-shadow(0 0 15px rgba(53,247,255,0.6)) !important; transform: scale(0.95); }

        /* Battle Toast Log */
    .battle-toast-wrap {
      position: absolute; top: 10px; left: 0; right: 0;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      pointer-events: none; z-index: 50;
    }
    .battle-toast {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(53, 247, 255, 0.3);
      color: #e2e8f0;
      padding: 6px 12px;
      border-radius: 99px;
      font-family: var(--mono);
      font-size: 11px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      animation: toast-in 0.3s ease-out forwards;
      max-width: 90%; text-align: center;
    }
    @keyframes toast-in { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    @keyframes toast-out { to{opacity:0; transform:translateY(-10px);} }

    /* --- OPENING CAMERA WORK --- */
    @keyframes stage-intro {
      0% { transform: scale(1.6) rotateX(45deg) rotateY(180deg); opacity: 0; filter:blur(4px); }
      100% { transform: scale(1) rotateX(0) rotateY(0); opacity: 1; filter:blur(0); }
    }
    /* Counter-rotate sprites so they always face camera during spin */
    @keyframes sprite-counter {
      0% { transform: rotateY(-180deg); }
      100% { transform: rotateY(0); }
    }
    @keyframes hud-fade-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

        .intro-camera-mode { animation: stage-intro 2.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .intro-sprite-mode { animation: sprite-counter 2.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .intro-hud-wait { opacity: 0; animation: hud-fade-in 0.8s ease-out 2.0s forwards; }

    /* Protest Mob Animation */
    .protest-bob { animation: protestBob 0.8s infinite alternate ease-in-out; }
    @keyframes protestBob { 0%{transform:translateY(0);} 100%{transform:translateY(-12px);} }

        /* Title Screen Animations */
    @keyframes shine { 100% { transform: translateX(100%); } }
    
        /* Cyber Grid for Start Screen */
    .cyber-grid-bg {
      position: absolute; inset: -50%; width: 200%; height: 200%;
      background-image:
        linear-gradient(rgba(53, 247, 255, 0.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(53, 247, 255, 0.15) 1px, transparent 1px);
      background-size: 80px 80px;
      transform: perspective(500px) rotateX(60deg) translateY(-100px);
      animation: cyberGrid 6s linear infinite;
      z-index: 0; pointer-events: none;
      mask-image: radial-gradient(circle at center, black 30%, transparent 70%);
    }
    @keyframes cyberGrid { from { background-position: 0 0; } to { background-position: 0 80px; } }
    
    /* Radar Chart Animation */
    .poly-anim { 
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: dash 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    @keyframes dash { to { stroke-dashoffset: 0; } }
    
    /* Hover Tooltip Fade */
    .stat-tooltip { transition: all 0.2s ease; transform: translateY(5px); opacity: 0; pointer-events: none; }
    .group:hover .stat-tooltip { transform: translateY(0); opacity: 1; }
    .animate-shine { animation: shine 1s; }
        .cursor-blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* Comet Warp Effect */
    .comet-container { position:absolute; inset:0; overflow:hidden; pointer-events:none; z-index:1; }
    .comet-trail {
      position: absolute; top: 50%; left: 50%;
      width: 2px; height: 120px;
      background: linear-gradient(to bottom, transparent 0%, rgba(53,247,255,0.4) 40%, #fff 100%);
      transform-origin: top center;
      opacity: 0;
      border-radius: 99px;
      mix-blend-mode: screen;
      animation: comet-fall ease-in infinite;
    }
        @keyframes comet-fall {
      0% { transform: rotate(var(--deg)) translateY(20px) scaleY(0); opacity: 0; }
      10% { opacity: 0.8; }
      100% { transform: rotate(var(--deg)) translateY(120vmax) scaleY(2); opacity: 0; }
    }

    /* Battle Sky Effects */
    .sky-layer { position: absolute; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
    .star {
      position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%;
      opacity: 0; animation: twinkle var(--dur) ease-in-out infinite;
      top: var(--y); left: var(--x);
    }
    @keyframes twinkle { 0%,100%{opacity:0.2; transform:scale(0.8);} 50%{opacity:1; transform:scale(1.2);} }

    .cloud {
      position: absolute; background: radial-gradient(closest-side, rgba(255,255,255,0.05), transparent);
      width: var(--w); height: var(--h); top: var(--y); left: -20%;
      opacity: 0.6; animation: drift var(--dur) linear infinite;
    }
    @keyframes drift { to { transform: translateX(120vw); } }

        .shooting-star {
      position: absolute; width: 100px; height: 1px;
      background: linear-gradient(90deg, white, transparent);
      top: var(--y); left: var(--x);
      opacity: 0; animation: shoot 7s ease-in-out infinite;
      animation-delay: var(--del);
      transform: rotate(-25deg);
    }
    @keyframes shoot {
      0% { transform: translate(0,0) rotate(-25deg) scaleX(0); opacity:0; }
      5% { transform: translate(-40px,20px) rotate(-25deg) scaleX(1); opacity:1; }
      15% { transform: translate(-300px,150px) rotate(-25deg) scaleX(1); opacity:0; }
      100% { opacity:0; }
    }

    /* --- NEW: VISUAL FX --- */
    /* News Ticker Mode */
    .ticker.news-mode {
      background: linear-gradient(90deg, rgba(127,29,29,0.9), rgba(69,10,10,0.9));
      border-top: 1px solid #ef4444;
      border-bottom: 1px solid #ef4444;
    }
    .ticker.news-mode .track {
      animation: none;
      justify-content: center;
      font-weight: 800;
      color: #fecaca;
      text-shadow: 0 0 10px rgba(239,68,68,0.8);
      letter-spacing: 0.05em;
    }

    /* Cut-In Overlay */
    .cut-in-overlay {
      position: absolute; inset: 0; z-index: 60;
      background: rgba(2,6,23,0.85);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      pointer-events: none; overflow: hidden;
      animation: cutInFade 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      backdrop-filter: blur(4px);
    }
    @keyframes cutInFade {
      0% { opacity: 0; transform: scale(1.1); }
      10% { opacity: 1; transform: scale(1); }
      85% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.15); }
    }
    .cut-in-line {
      position: absolute; width: 150%; height: 2px;
      background: rgba(255,255,255,0.1);
      transform: rotate(-15deg);
      animation: speedLine 0.1s linear infinite;
    }
    @keyframes speedLine { 0% { transform: rotate(-15deg) translateX(-100%); } 100% { transform: rotate(-15deg) translateX(100%); } }

    ¬† ¬† /* Camera Shake */
¬† ¬† .camera-impact {
¬† ¬† ¬† animation: camShake 0.5s cubic-bezier(.36,.07,.19,.97) both;
¬† ¬† }

        /* --- INFLUENCER MODE THEME (High Contrast) --- */
    body.influencer-mode {
      --bg0: #fff0f5 !important;
      --bg1: #ffe4e1 !important;
      --panel: rgba(255, 255, 255, 0.95) !important;
      --text: #be185d !important;
      --neon: #ff69b4 !important;
      --line: #fbcfe8 !important;
      --muted: #db2777 !important;
    }
    body.influencer-mode .panel, 
    body.influencer-mode .panel2 {
      background: linear-gradient(180deg, #fff0f5, #ffe4e1) !important;
      border-color: #f472b6 !important;
      box-shadow: 0 0 25px rgba(255,105,180,0.3) !important;
      color: #9d174d !important;
    }
    /* Force text color override for readability on light bg */
    body.influencer-mode .text-slate-100,
    body.influencer-mode .text-slate-200,
    body.influencer-mode .text-slate-300,
    body.influencer-mode .text-slate-400,
    body.influencer-mode .text-slate-500,
    body.influencer-mode .text-white {
      color: #831843 !important; /* Pink-900 */
    }
    /* Darken neon colors for visibility */
    body.influencer-mode .text-sky-300, 
    body.influencer-mode .text-emerald-300,
    body.influencer-mode .text-rose-300,
    body.influencer-mode .text-amber-300,
    body.influencer-mode .text-violet-300 {
       filter: brightness(0.6) saturate(1.5);
    }
    
    body.influencer-mode .scanline {
      background: repeating-linear-gradient(180deg, rgba(255,105,180,0.05) 0px, rgba(255,105,180,0.05) 1px, transparent 1px, transparent 4px) !important;
    }
    body.influencer-mode .ticker { background: rgba(255,240,245,0.9) !important; border-color: #f9a8d4 !important; }
    body.influencer-mode .ticker .track { color: #831843 !important; text-shadow: none !important; }
    body.influencer-mode .btn, body.influencer-mode .btn2 { border-color: #ec4899 !important; background: rgba(255,255,255,0.6) !important; color:#9d174d !important; }
@keyframes camShake {
      0% { transform: scale(1); }
      10% { transform: scale(1.03) translate(-3px, -3px); }
      30% { transform: scale(1.03) translate(3px, 3px); }
      50% { transform: scale(1.03) translate(-3px, 2px); }
      70% { transform: scale(1.03) translate(2px, -3px); }
      100% { transform: scale(1); translate(0,0); }
    }

    /* --- SPACE BOSS MODE --- */
    .battle-stage.space-mode {
      background: radial-gradient(circle at 50% 40%, #2e1065 0%, #000000 90%) !important;
    }
    /* Space Grid Override */
    .battle-stage.space-mode::after {
      background:
        linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(88,28,135,0.8) 100%),
        repeating-linear-gradient(90deg, rgba(216,180,254,0.15) 0px, rgba(216,180,254,0.15) 1px, transparent 1px, transparent 60px),
        repeating-linear-gradient(0deg, rgba(216,180,254,0.15) 0px, rgba(216,180,254,0.15) 1px, transparent 1px, transparent 60px) !important;
    }
    .warp-star {
      position: absolute; left: 50%; top: 40%;
      width: 2px; height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff, rgba(255,255,255,0));
      transform-origin: center top;
      opacity: 0;
      animation: warp 1.5s ease-in infinite;
    }
    @keyframes warp {
      0% { transform: rotate(var(--rot)) translateY(20px) scaleY(0.2); opacity: 0; }
      30% { opacity: 1; }
      100% { transform: rotate(var(--rot)) translateY(600px) scaleY(4); opacity: 0; }
    }


    /* --- SPACE BOSS MODE --- */
    .battle-stage.space-mode {
      background: radial-gradient(circle at 50% 40%, #2e1065 0%, #000000 90%) !important;
    }
    /* Space Grid Override */
    .battle-stage.space-mode::after {
      background:
        linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(88,28,135,0.8) 100%),
        repeating-linear-gradient(90deg, rgba(216,180,254,0.15) 0px, rgba(216,180,254,0.15) 1px, transparent 1px, transparent 60px),
        repeating-linear-gradient(0deg, rgba(216,180,254,0.15) 0px, rgba(216,180,254,0.15) 1px, transparent 1px, transparent 60px) !important;
    }
    .warp-star {
      position: absolute; left: 50%; top: 40%;
      width: 2px; height: 100px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), #fff, rgba(255,255,255,0));
      transform-origin: center top;
      opacity: 0;
      animation: warp 1.5s ease-in infinite;
    }
    @keyframes warp {
      0% { transform: rotate(var(--rot)) translateY(20px) scaleY(0.2); opacity: 0; }
      30% { opacity: 1; }
      100% { transform: rotate(var(--rot)) translateY(600px) scaleY(4); opacity: 0; }
    }
  </style>
</head>
<body class="safe-pad">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Header -->
    <header class="flex items-center justify-between gap-3 py-3">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl neon-border flex items-center justify-center relative overflow-hidden"
             style="background: radial-gradient(180px 120px at 30% 20%, rgba(53,247,255,.16), transparent 60%),
                            radial-gradient(180px 120px at 70% 60%, rgba(167,139,250,.16), transparent 60%),
                            rgba(2,6,23,.65);">
          <div class="scanline" style="border-radius:16px; z-index:5;"></div>
          <canvas id="vizCanvas" class="absolute inset-0 w-full h-full opacity-80 pointer-events-none" style="mix-blend-mode:screen; z-index:1;"></canvas>
          <span class="mono font-black text-lg glowText relative" style="z-index:10;">CQ</span>
        </div>
        <div>
          <div class="text-xl sm:text-2xl font-black tracking-tight glowText">CORPORATE QUEST</div>
          <div class="text-xs sm:text-sm text-slate-300/80 mono">Real Company Battle</div>
        </div>
      </div>
            <div class="flex items-center gap-2">
        <button id="btnScreenshot" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center justify-center" title="Take Screenshot">
          <i data-lucide="camera" class="w-4 h-4"></i>
        </button>
        <button id="btnHelp" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="help-circle" class="w-4 h-4"></i><span class="mono">HELP</span>
        </button>
        <button id="btnGoLab" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="sparkles" class="w-4 h-4"></i><span class="mono">AI FORGE</span>
        </button>
        <button id="btnGoTournament" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="trophy" class="w-4 h-4"></i><span class="mono">TOURNAMENT</span>
        </button>
      </div>
    </header>

    <!-- Ticker -->
    <div class="ticker rounded-2xl panel2 overflow-hidden mb-4">
      <div class="track" id="tickerTrack"></div>
    </div>

    <!-- Main -->
        
    <main class="grid grid-cols-1 gap-4">

      
      <section id="screenTitle" class="panel rounded-2xl relative overflow-hidden flex flex-col items-center justify-center min-h-[420px] cursor-pointer group">
        <div class="scanline"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(53,247,255,0.08),transparent_70%)]"></div>
        
        <div class="z-10 text-center space-y-8 animate-[float_6s_ease-in-out_infinite]">
          <div class="relative inline-block">
             <div class="absolute -inset-6 bg-cyan-500/20 blur-2xl rounded-full animate-pulse"></div>
             <div class="w-24 h-24 mx-auto rounded-2xl neon-border flex items-center justify-center bg-slate-900/80 relative">
               <i data-lucide="building-2" class="w-12 h-12 text-cyan-300 drop-shadow-[0_0_15px_rgba(53,247,255,0.8)]"></i>
             </div>
          </div>
          
          <div>
            <h1 class="text-5xl sm:text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-cyan-300 drop-shadow-[0_0_20px_rgba(53,247,255,0.4)]">
              CORPORATE<br/>QUEST
            </h1>
            <div class="mt-3 text-sm sm:text-base text-cyan-200/70 tracking-[0.3em] mono font-bold">REAL COMPANY BATTLE</div>
          </div>

                    <div class="pt-8 pb-16">
            <div class="inline-flex items-center gap-2 px-8 py-3 rounded-full border border-cyan-500/30 bg-cyan-500/5 backdrop-blur-sm group-hover:bg-cyan-500/10 transition-colors">
              <span class="mono text-lg font-bold text-cyan-100 group-hover:text-white transition-colors">
                &gt; CLICK TO START<span class="cursor-blink">_</span>
              </span>
            </div>
          </div>
        </div>
        
                <div class="absolute bottom-4 text-[10px] text-slate-500/60 mono text-center">
           POWERED BY APP STUDIO ‚Ä¢ FINANCIAL DATA BATTLE<br/>
           &copy; 2026 Hisa
        </div>
      </section>

      

      <!-- START SCREEN -->
            
            <section id="screenStart" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden">
        <div class="cyber-grid-bg"></div>
        <div class="scanline" style="z-index:10;"></div>

        <div class="flex flex-col gap-4">
          
          <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <span class="tag">MODE</span>
              <span class="mono text-sm text-slate-200/90">CPUÂØæÊà¶ / ‰ºÅÊ•≠ÈÅ∏Êäû</span>
            </div>
            <div class="flex items-center gap-2">
               <button id="btnOpenLabFromStart" class="btn2 px-3 py-2 rounded-xl text-xs flex items-center gap-2">
                 <i data-lucide="sparkles" class="w-3 h-3"></i><span class="mono">AI FORGE</span>
               </button>
               <button id="btnResetSample" class="btnDanger px-3 py-2 rounded-xl text-xs flex items-center gap-2">
                 <i data-lucide="refresh-ccw" class="w-3 h-3"></i><span class="mono">RESET</span>
               </button>
            </div>
          </div>

          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            
            
                        
            <div class="panel2 rounded-2xl p-4 flex flex-col gap-3 relative group/panel">
              <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500/30"></div>
              
              <div class="flex items-center justify-between">
                <div class="mono text-sm text-cyan-300 font-bold">YOUR COMPANY</div>
                <span class="tag" id="tagYourSector">‚Äî</span>
              </div>
              
              <div class="flex gap-3 items-center">
                <div id="pLogoMenu" class="logoWrap w-14 h-14 rounded-xl border border-cyan-500/30 shrink-0 bg-slate-900/50 shadow-[0_0_15px_rgba(53,247,255,0.1)]"></div>
                <select id="selPlayer" class="flex-1 w-full rounded-xl px-3 py-2 mono text-sm bg-slate-900/50 border border-slate-700 focus:border-cyan-500 outline-none"></select>
              </div>
              
              
              
              
                      <div id="pDesc" class="text-[10px] text-slate-400 mono leading-tight min-h-[2.5em] mt-2"></div>
        <div id="pStatsArea" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1"></div>

              <div class="flex gap-2 mt-2">
                <button id="btnRandomPlayer" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                </button>
                <button id="btnInspectPlayer" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                </button>
              </div>
            </div>

            
                        
            <div class="panel2 rounded-2xl p-4 flex flex-col gap-3 relative">
              <div class="absolute top-0 right-0 w-1 h-full bg-rose-500/30"></div>

              <div class="flex items-center justify-between">
                <div class="mono text-sm text-rose-300 font-bold">ENEMY (CPU)</div>
                <span class="tag" id="tagCpuSector">‚Äî</span>
              </div>
              
              <div class="flex gap-3 items-center">
                <div id="cLogoMenu" class="logoWrap w-14 h-14 rounded-xl border border-rose-500/30 shrink-0 bg-slate-900/50 shadow-[0_0_15px_rgba(251,113,133,0.1)]"></div>
                <select id="selCPU" class="flex-1 w-full rounded-xl px-3 py-2 mono text-sm bg-slate-900/50 border border-slate-700 focus:border-rose-500 outline-none"></select>
              </div>
              
              
              
              
                      <div id="cDesc" class="text-[10px] text-slate-400 mono leading-tight min-h-[2.5em] mt-2"></div>
        <div id="cStatsArea" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1"></div>

              <div class="flex gap-2 mt-2">
                <button id="btnRandomCPU" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                </button>
                <button id="btnInspectCPU" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                </button>
              </div>
            </div>

          </div>

          
          <div class="mt-2 flex flex-col sm:flex-row gap-3">
            <button id="btnStartBattle" class="btn px-4 py-4 rounded-2xl text-lg flex items-center justify-center gap-3 flex-[2] shadow-[0_0_20px_rgba(53,247,255,0.15)] hover:shadow-[0_0_30px_rgba(53,247,255,0.25)] border-cyan-500/40">
              <i data-lucide="swords" class="w-6 h-6"></i>
              <span class="mono font-black">ENGAGE BATTLE</span>
            </button>
                        <button id="btnStartTournamentFromStart" class="btn2 px-4 py-4 rounded-2xl text-base flex items-center justify-center gap-2 flex-1">
              <i data-lucide="trophy" class="w-5 h-5"></i>
              <span class="mono font-bold">TOURNAMENT</span>
            </button>
          </div>

          <div class="mt-4 text-[10px] text-slate-500/60 text-center leading-relaxed">
             ‚ÄªÊú¨„Ç¢„Éó„É™„ÅØ„Éï„Ç£„ÇØ„Ç∑„Éß„É≥„Åß„Åô„ÄÇÂÆüÂú®„ÅÆ‰ºÅÊ•≠Âêç„Çí‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅË≤°Âãô„Éá„Éº„Çø„ÅØAIÁîüÊàê„Å´„Çà„ÇãÊé®ÂÆöÂÄ§„ÇíÂê´„Åø„ÄÅÊ≠£Á¢∫ÊÄß„Çí‰øùË®º„Åó„Åæ„Åõ„Çì„ÄÇ<br>
             „Ç≤„Éº„É†„ÇíÊ•Ω„Åó„ÇÄÁõÆÁöÑ‰ª•Â§ñÔºàÂÆüÈöõ„ÅÆÊäïË≥áÂà§Êñ≠Á≠âÔºâ„Å´„ÅØ‰∏ÄÂàáÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
          </div>

        </div>
      </section>

      <!-- BATTLE SCREEN -->
      <section id="screenBattle" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2">
              <span class="tag">BATTLE</span>
              <span class="mono text-sm text-slate-200/90" id="battleSubtitle">‚Äî</span>
              <div id="marketBadge" class="hidden sm:flex items-center gap-1 px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-[10px] mono text-slate-300">
                <span id="marketIcon">üìä</span>
                <span id="marketText">NORMAL</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnBattleToResult" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="flag" class="w-4 h-4"></i><span class="mono">FORCE END</span>
              </button>
              <button id="btnBattleBackStart" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="corner-down-left" class="w-4 h-4"></i><span class="mono">EXIT</span>
              </button>
            </div>
          </div>

          <!-- arena -->
          
          <div id="arena" class="panel2 rounded-2xl relative overflow-hidden bg-slate-900">
            <div class="scanline" style="opacity:.10"></div>
            
            
            <div id="battleToastAnchor" class="battle-toast-wrap"></div>
            
            <div class="battle-stage">
              
              <div id="cityScape" class="city-wrap"></div>
              
              
              <div class="center-ring"></div>

              
              <div class="stage-ground-c" style="z-index:3"></div>
              <div class="stage-ground-p" style="z-index:3"></div>
              
              
              <div class="shadow-marker sh-c"></div>
              <div class="shadow-marker sh-p"></div>

              
              
              <div class="hud-wrap hud-c">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="nameCPU">CPU</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdC">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-500" id="hpBarCPU" style="width:100%"></div>
                </div>
<div class="flex justify-between text-[10px] mono text-slate-300 mb-1">
                  <span id="hpTextCPU">HP --/--</span>
                </div>
                <div class="flex items-center gap-2 mb-1">
                  <div class="text-[10px] font-bold text-violet-300">R&D</div>
                  <div class="flex-1 bg-slate-800 h-1.5 rounded-full overflow-hidden border border-slate-600">
                    <div class="h-full bg-violet-500 shadow-[0_0_10px_#A78BFA] transition-all duration-300" id="skBarCPU" style="width:0%"></div>
                  </div>
                  <div class="text-[10px] mono text-violet-200" id="skTextCPU">0%</div>
                </div>
                <div class="flex gap-3 text-[10px] mono text-slate-400 justify-end">
                  <div>ATK <span id="statAtkC" class="text-slate-200 font-bold">--</span></div>
                  <div>DEF <span id="statDefC" class="text-slate-200 font-bold">--</span></div>
                </div>
                <div class="hidden" id="sectorCPU"></div><div class="hidden" id="rawCPU"></div>
              </div>
                            
              <div id="spriteCPU" class="sprite-wrap pos-c" style="animation: float 4s ease-in-out infinite reverse;">
                 <div class="logoWrap w-20 h-20 sm:w-28 sm:h-28 rounded-2xl border-2 border-white/10" id="logoWrapCPU"></div>
                 <div class="mt-2 flex justify-center flex-wrap gap-1" id="buffsCPU"></div>
              </div>

              
              
              <div id="spritePlayer" class="sprite-wrap pos-p" style="animation: float 4s ease-in-out infinite;">
                 <div class="mb-2 flex justify-center flex-wrap-reverse gap-1" id="buffsPlayer"></div>
                 <div class="logoWrap w-24 h-24 sm:w-36 sm:h-36 rounded-2xl border-2 border-cyan-400/30" id="logoWrapPlayer"></div>
              </div>
              <div class="hud-wrap hud-p">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="namePlayer">PLAYER</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdP">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500" id="hpBarPlayer" style="width:100%"></div>
                </div>
                <div class="flex justify-between text-[10px] mono text-slate-300 mb-1">
                  <span id="hpTextPlayer">HP --/--</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-[10px] font-bold text-violet-300">R&amp;D</div>
                  <div class="flex-1 bg-slate-800 h-1.5 rounded-full overflow-hidden border border-slate-600">
                    <div class="h-full bg-violet-500 shadow-[0_0_10px_#A78BFA] transition-all duration-300" id="skBarPlayer" style="width:0%"></div>
                  </div>
                  <div class="text-[10px] mono text-violet-200" id="skTextPlayer">0%</div>
                </div>
                <div class="mt-2 flex gap-3 text-[10px] mono text-slate-400 justify-end">
                  <div>ATK <span id="statAtkP" class="text-slate-200 font-bold">--</span></div>
                  <div>DEF <span id="statDefP" class="text-slate-200 font-bold">--</span></div>
                </div>
                <div class="hidden" id="sectorPlayer"></div><div class="hidden" id="rawPlayer"></div>
              </div>
            </div>
          </div>

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <!-- Commands -->
              <div class="panel2 rounded-2xl p-4 relative overflow-visible z-40">
                <div class="scanline rounded-2xl" style="opacity:.10"></div>
                <div class="flex items-center justify-between">
                  <div class="mono text-sm text-slate-200/90">COMMAND</div>
                  <span class="tag" id="turnTag">‚Äî</span>
                </div>

                                <div class="mt-3 flex flex-col gap-2 relative">
                  
                  <div class="relative group">
                    <button id="cmdAttack" class="btn w-full px-4 py-3 rounded-2xl text-left flex items-center gap-3">
                      <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center"><i data-lucide="zap" class="w-5 h-5 text-cyan-300"></i></div>
                      <div class="flex-1">
                        <div class="mono text-sm font-bold text-slate-100">Attack</div>
                        <div class="text-[10px] text-slate-400">Â∏ÇÂ†¥ÊîªÂã¢</div>
                      </div>
                    </button>
                    <div class="absolute left-full top-0 ml-2 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-lg shadow-xl z-50 hidden group-hover:block text-[10px] text-slate-300 pointer-events-none">
                      ÂÆâÂÆö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÄÅÂ∏ÇÂ†¥„Ç∑„Çß„Ç¢„ÇíÂ•™„ÅÜÂü∫Êú¨Ë°åÂãï„ÄÇ
                    </div>
                  </div>

                  
                  <div class="relative group">
                    <button id="cmdGuard" class="btn2 w-full px-4 py-3 rounded-2xl text-left flex items-center gap-3">
                      <div class="w-8 h-8 rounded-lg bg-violet-500/20 flex items-center justify-center"><i data-lucide="shield" class="w-5 h-5 text-violet-300"></i></div>
                      <div class="flex-1">
                        <div class="mono text-sm font-bold text-slate-100">Guard</div>
                        <div class="text-[10px] text-slate-400">Ë≤°ÂãôÈò≤Ë°õ</div>
                      </div>
                    </button>
                    <div class="absolute left-full top-0 ml-2 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-lg shadow-xl z-50 hidden group-hover:block text-[10px] text-slate-300 pointer-events-none">
                      Ë¢´„ÉÄ„É°„Éº„Ç∏„ÇíÂ§ßÂπÖËªΩÊ∏õ„Åó„ÄÅDEF„Çí‰∏äÊòá„Åï„Åõ„Çã„ÄÇ„Ç≤„Éº„Ç∏„ÇÇÂ∞ë„ÅóÊ∫ú„Åæ„Çã„ÄÇ
                    </div>
                  </div>

                  
                                    
                  <div class="relative">
                      <button id="cmdStrategy" class="btn2 w-full px-4 py-3 rounded-2xl text-left flex items-center gap-3 border-slate-600/50 transition-colors duration-300">
                       <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center"><i data-lucide="layers" class="w-5 h-5 text-emerald-300"></i></div>
                       <div class="flex-1">
                         <div class="mono text-sm font-bold text-slate-100">Strategy</div>
                         <div class="text-[10px] text-slate-400">ÁµåÂñ∂Êà¶Áï• (Skill / Summon / Invest)</div>
                       </div>
                       <i id="iconStratChev" data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform duration-200"></i>
                     </button>

                     
                     <div id="subStrat" class="hidden mt-2 ml-4 flex flex-col gap-2 border-l-2 border-slate-700/50 pl-2">
                         
                         <button id="cmdSkill" class="btn2 w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-violet-500/30">
                           <i data-lucide="flame" class="w-4 h-4 text-violet-400"></i>
                           <div>
                             <div class="mono text-xs font-bold">Skill</div>
                             <div class="text-[9px] text-slate-400">ÂøÖÊÆ∫ÊäÄ (60%)</div>
                           </div>
                         </button>
                        
                                                 <button id="cmdSummon" class="btn2 w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-amber-500/30">
                           <i data-lucide="megaphone" class="w-4 h-4 text-amber-400"></i>
                           <div>
                             <div class="mono text-xs font-bold">Summon</div>
                             <div class="text-[9px] text-slate-400">Â§ñÈÉ®ÂúßÂäõ (50/100%)</div>
                           </div>
                         </button>
                         
                                                  <button id="cmdInvest" class="btn w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-emerald-500/30">
                             <i data-lucide="briefcase" class="w-4 h-4 text-emerald-400"></i>
                             <div>
                               <div class="mono text-xs font-bold">Invest</div>
                               <div class="text-[9px] text-slate-400">ÊäïË≥á (40% + HP)</div>
                             </div>
                           </button>
                           
                           <button id="cmdRestructure" class="btnDanger w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-rose-500/30">
                             <i data-lucide="scissors" class="w-4 h-4 text-rose-400"></i>
                             <div>
                               <div class="mono text-xs font-bold">Restructure</div>
                               <div class="text-[9px] text-slate-400">„É™„Çπ„Éà„É© (HP+30%)</div>
                             </div>
                           </button>

                           <button id="cmdSubsidy" class="btn2 w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-sky-500/30">
                             <i data-lucide="landmark" class="w-4 h-4 text-sky-400"></i>
                             <div>
                                                           <div class="mono text-xs font-bold">Subsidy</div>
                            <div class="text-[9px] text-slate-400">Ë£úÂä©Èáë (20%/Wait)</div>
                           </div>
                         </button>

                         <button id="cmdBunshun" class="btn2 w-full px-3 py-2 rounded-xl text-left flex items-center gap-2 bg-slate-900/40 border-slate-500/30">
                           <i data-lucide="camera" class="w-4 h-4 text-slate-400"></i>
                           <div>
                             <div class="mono text-xs font-bold">Bunshun</div>
                             <div class="text-[9px] text-slate-400">ÊñáÊò•Á†≤ (25%/Risk +20%)</div>
                           </div>
                         </button>
                      </div>
                    </div>

                  
                                    <div class="relative group">
                    <button id="cmdPivot" class="btn w-full px-4 py-3 rounded-2xl text-left flex items-center gap-3">
                      <div class="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center"><i data-lucide="move-right" class="w-5 h-5 text-sky-300"></i></div>
                      <div class="flex-1">
                        <div class="mono text-sm font-bold text-slate-100">Pivot</div>
                        <div class="text-[10px] text-slate-400">‰∫ãÊ•≠Ëª¢Êèõ</div>
                      </div>
                    </button>
                    <div class="absolute left-full top-0 ml-2 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-lg shadow-xl z-50 hidden group-hover:block text-[10px] text-slate-300 pointer-events-none">
                      ATK„Å®SPD„Çí‰∏ÄÊôÇÁöÑ„Å´Âº∑Âåñ„Åô„Çã„Åå„ÄÅDEF„Åå‰∏ã„Åå„ÇãÊîªÊíÉÁöÑ„Ç∑„Éï„Éà„ÄÇ
                    </div>
                  </div>
                </div>

                <div class="mt-3 flex gap-2">
                  <button id="btnAuto" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="bot" class="w-4 h-4"></i><span class="mono">AUTO</span>
                  </button>
                  <button id="btnPause" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="pause" class="w-4 h-4"></i><span class="mono">PAUSE</span>
                  </button>
                </div>
              </div>

              <!-- Log -->
              <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
                <div class="scanline" style="opacity:.10"></div>
                <div class="flex items-center justify-between gap-2">
                  <div class="mono text-sm text-slate-200/90">BATTLE LOG</div>
                  <div class="flex items-center gap-2">
                    <span class="tag" id="logHint">LIVE</span>
                    <button id="btnClearLog" class="btn2 px-2.5 py-2 rounded-xl text-sm flex items-center gap-2">
                      <i data-lucide="trash-2" class="w-4 h-4"></i><span class="mono">CLEAR</span>
                    </button>
                  </div>
                </div>
                <div id="logBox" class="mt-3 h-[240px] sm:h-[280px] overflow-auto pr-1 space-y-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT SCREEN -->
            
      <section id="screenResult" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="max-w-4xl mx-auto w-full">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-sky-500/20 border border-emerald-500/30 flex items-center justify-center shadow-[0_0_15px_rgba(16,185,129,0.15)]">
                <i data-lucide="trophy" class="w-6 h-6 text-emerald-300"></i>
              </div>
              <div>
                <span class="tag mb-1">BATTLE RESULT</span>
                <div class="mono text-lg sm:text-xl text-slate-100 font-black glowText" id="resultTitle">‚Äî</div>
              </div>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
              <button id="btnRematch" class="btn px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="repeat" class="w-4 h-4"></i><span class="mono">REMATCH</span>
              </button>
              <button id="btnResultBack" class="btn2 px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            
            <div class="panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                <i data-lucide="activity" class="w-4 h-4 text-slate-400"></i>
                <div class="mono text-sm text-slate-200/90 font-bold">STATS LOG</div>
              </div>
              <div id="resultSnapshot" class="space-y-2 flex-1 text-sm"></div>
            </div>
            
            
            <div class="md:col-span-2 panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                 <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                 <div class="mono text-sm text-slate-200/90 font-bold">FINANCIAL ANALYSIS</div>
              </div>
              <div id="resultExplainer" class="text-slate-200/90 leading-relaxed text-sm space-y-4 flex-1"></div>
              <div class="mt-5 pt-3 border-t border-slate-700/50 text-[10px] text-slate-400/60 mono text-center">
                ‚Äª„Åì„ÅÆÂàÜÊûê„ÅØ„Ç≤„Éº„É†ÂÜÖ„ÅÆ„Éë„É©„É°„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÊû∂Á©∫„ÅÆ„ÇÇ„ÅÆ„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆÊäïË≥áÂà§Êñ≠„Å´„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TOURNAMENT SCREEN -->
      <section id="screenTournament" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="tag">TOURNAMENT</span>
            <div class="mono text-sm text-slate-200/90">8Á§æ„Ç∑„É≥„Ç∞„É´„Ç®„É™„Éü„Éç„Éº„Ç∑„Éß„É≥</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnNewBracket" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="dice-5" class="w-4 h-4"></i><span class="mono">NEW BRACKET</span>
            </button>
            <button id="btnRunNextMatch" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="play" class="w-4 h-4"></i><span class="mono">PLAY NEXT</span>
            </button>
            <button id="btnAutoSim" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="fast-forward" class="w-4 h-4"></i><span class="mono">AUTO SIM</span>
            </button>
            <button id="btnTournamentBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">BRACKET</div>
            <div id="bracketBox" class="mt-3"></div>
          </div>
          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">TOURNAMENT LOG</div>
            <div id="tLog" class="mt-3 h-[320px] overflow-auto pr-1 space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- AI FORGE SCREEN -->
            
            
            <section id="screenLab" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>
        
        <div class="max-w-xl mx-auto w-full">
        <div class="flex items-center justify-between gap-2 mb-6">
          <div class="flex items-center gap-2">
            <span class="tag">AI FORGE</span>
            <div class="mono text-sm text-slate-200/90">‰ºÅÊ•≠„Éá„Éº„ÇøÁîüÊàê„ÉªÁÆ°ÁêÜ„É©„Éú</div>
          </div>
          <button id="btnLabBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
            <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
          </button>
        </div>

        
        <div class="flex p-1 bg-slate-900/50 rounded-xl mb-6 border border-slate-700/50">
          <button id="tabBtnGen" class="flex-1 py-2 rounded-lg text-xs sm:text-sm mono font-bold transition-all text-cyan-300 bg-slate-800 shadow-[0_0_10px_rgba(53,247,255,0.2)] border border-cyan-500/30">1. GENERATE</button>
          <button id="tabBtnMna" class="flex-1 py-2 rounded-lg text-xs sm:text-sm mono font-bold transition-all text-slate-500 hover:text-slate-300 border border-transparent">2. M&A</button>
                    <button id="tabBtnImp" class="flex-1 py-2 rounded-lg text-xs sm:text-sm mono font-bold transition-all text-slate-500 hover:text-slate-300 border border-transparent">3. IMPORT / DB</button>
        </div>

        <div class="w-full">
          
          <div id="tabContentGen" class="space-y-4 animate-[fadeIn_0.3s_ease-out]">
            <div class="panel2 rounded-2xl p-5 relative overflow-visible">
               <div class="flex items-center justify-between mb-2">
                 <div class="mono text-sm text-slate-200/90 font-bold flex items-center gap-2"><i data-lucide="wand-2" class="w-4 h-4 text-cyan-300"></i> PROMPT GENERATOR</div>
               </div>
               <div class="text-xs text-slate-400 mb-4 leading-relaxed">
                 Êñ∞„Åó„ÅÑ‰ºÅÊ•≠„ÇíÁîüÊàê„Åô„Çã„Åü„ÇÅ„ÅÆ„ÄåAI„Å∏„ÅÆÊåáÁ§∫Êõ∏Ôºà„Éó„É≠„É≥„Éó„ÉàÔºâ„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ<br>
                 Êù°‰ª∂„ÇíË®≠ÂÆö„Åó„Å¶ÁîüÊàê„Éú„Çø„É≥„ÇíÊäº„Åó„ÄÅ„Ç≥„Éî„Éº„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà„ÇíAI„ÉÅ„É£„ÉÉ„Éà„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
               </div>
               
               <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                 <div>
                   <label class="mono text-xs text-slate-400 block mb-1">COUNT</label>
                   <input id="labCount" type="number" min="1" max="50" value="5" class="w-full rounded-xl px-3 py-2 mono text-sm bg-slate-800 border border-slate-700 focus:border-cyan-500 outline-none" />
                 </div>
                 <div>
                   <label class="mono text-xs text-slate-400 block mb-1">REGION</label>
                   <select id="labRegion" class="w-full rounded-xl px-3 py-2 mono text-sm bg-slate-800 border border-slate-700 focus:border-cyan-500 outline-none">
                     <option value="JP" selected>Êó•Êú¨ (Japan)</option>
                     <option value="GLOBAL">Êµ∑Â§ñ (Global)</option>
                     <option value="MIX">„Éü„ÉÉ„ÇØ„Çπ (Mixed)</option>
                   </select>
                 </div>
                 <div class="sm:col-span-2">
                   <label class="mono text-xs text-slate-400 block mb-1">SECTORS</label>
                   <div id="sectorChoices" class="flex flex-wrap gap-2"></div>
                 </div>
                 <div class="sm:col-span-2">
                   <label class="mono text-xs text-slate-400 block mb-1">CUSTOM INSTRUCTION</label>
                   <textarea id="labCustom" rows="2" class="w-full rounded-xl px-3 py-2 mono text-sm bg-slate-800 border border-slate-700 focus:border-cyan-500 outline-none" placeholder="‰æã: ÂçäÂ∞é‰ΩìÈñ¢ÈÄ£„ÅÆ‰ºÅÊ•≠„Çí‰∏≠ÂøÉ„Å´„ÄÅÊôÇ‰æ°Á∑èÈ°çÈ´ò„ÇÅ„Åß‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"></textarea>
                 </div>
               </div>

               <button id="btnGeneratePrompt" class="btn w-full px-4 py-3 rounded-xl text-base flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(53,247,255,0.25)] border-cyan-500/50 hover:bg-cyan-500/10 transition-all">
                 <i data-lucide="copy" class="w-5 h-5"></i><span class="mono font-bold">GENERATE & COPY PROMPT</span>
               </button>
            </div>
          </div>

          
          <div id="tabContentMna" class="hidden space-y-4 animate-[fadeIn_0.3s_ease-out]">
            <div class="panel2 rounded-2xl p-5 relative overflow-visible">
               <div class="flex items-center justify-between mb-2">
                 <div class="mono text-sm text-slate-200/90 font-bold flex items-center gap-2"><i data-lucide="network" class="w-4 h-4 text-violet-300"></i> M&A STRATEGY</div>
               </div>
               <div class="text-xs text-slate-400 mb-4 leading-relaxed">
                 Êó¢Â≠ò„ÅÆ2Á§æ„ÇíÁµåÂñ∂Áµ±ÂêàÔºàÂêà‰Ωµ„ÉªË≤∑ÂèéÔºâ„Åï„Åõ„ÄÅ‰∏°Á§æ„ÅÆÂº∑„Åø„Çí‰Ωµ„ÅõÊåÅ„Å§Êñ∞‰ºÅÊ•≠„ÇíË™ïÁîü„Åï„Åõ„Åæ„Åô„ÄÇ<br>
                 „ÄåAcquirerÔºàË≤∑ÂèéÂÅ¥Ôºâ„Äç„Å®„ÄåTargetÔºàË¢´Ë≤∑ÂèéÂÅ¥Ôºâ„Äç„ÇíÈÅ∏„Å≥„ÄÅÂêà‰ΩµÁî®„Éó„É≠„É≥„Éó„Éà„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
               </div>
               
               <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                 <div>
                   <label class="mono text-xs text-slate-400 block mb-1">COMPANY A (Acquirer)</label>
                   <select id="selMergeA" class="w-full rounded-xl px-3 py-2 mono text-sm bg-slate-800 border border-slate-700 outline-none focus:border-cyan-500"></select>
                 </div>
                 <div>
                   <label class="mono text-xs text-slate-400 block mb-1">COMPANY B (Target)</label>
                   <select id="selMergeB" class="w-full rounded-xl px-3 py-2 mono text-sm bg-slate-800 border border-slate-700 outline-none focus:border-rose-500"></select>
                 </div>
               </div>

               <button id="btnGenMergePrompt" class="btn w-full px-4 py-3 rounded-xl text-base flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(167,139,250,0.25)] border-violet-500/50 hover:bg-violet-500/10 transition-all">
                 <i data-lucide="sparkles" class="w-5 h-5"></i><span class="mono font-bold">GENERATE MERGE PROMPT</span>
               </button>
            </div>
          </div>

          
          <div id="tabContentImp" class="hidden space-y-4 animate-[fadeIn_0.3s_ease-out]">
            <div class="panel2 rounded-2xl p-5">
               <div class="flex items-center justify-between mb-2">
                 <div class="mono text-sm text-slate-200/90 font-bold flex items-center gap-2"><i data-lucide="download" class="w-4 h-4 text-emerald-300"></i> JSON IMPORT</div>
               </div>
               <div class="text-xs text-slate-400 mb-4 leading-relaxed">
                 AI„ÅåÁîüÊàê„Åó„ÅüJSON„Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÄåIMPORT„Äç„ÇíÊäº„Åô„Å®„ÄÅ„Ç≤„Éº„É†ÂÜÖ„Å´‰ºÅÊ•≠„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ<br>
                 ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„ÉªÂæ©ÂÖÉ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄåEXPORT„Äç„ÇíÂà©Áî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
               </div>
               
               <div class="relative">
                 <textarea id="labJson" rows="8" class="w-full rounded-xl p-3 mono text-xs leading-relaxed bg-slate-800 border border-slate-700 focus:border-emerald-500 outline-none" placeholder='[ { "name": "Example", ... } ]'></textarea>
                 <div class="absolute top-2 right-2 flex gap-1">
                   <button id="btnPasteJson" class="p-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors" title="Paste"><i data-lucide="clipboard" class="w-3 h-3"></i></button>
                   <button id="btnClearJson" class="p-1.5 rounded-lg bg-slate-700 hover:bg-rose-500/50 text-slate-300 transition-colors" title="Clear"><i data-lucide="x" class="w-3 h-3"></i></button>
                 </div>
               </div>
               
               <div class="mt-3 grid grid-cols-2 gap-3">
                 <button id="btnImportJson" class="btn px-4 py-2 rounded-xl text-sm flex items-center justify-center gap-2">
                   <i data-lucide="check" class="w-4 h-4"></i><span class="mono font-bold">IMPORT</span>
                 </button>
                 <button id="btnExportJson" class="btn2 px-4 py-2 rounded-xl text-sm flex items-center justify-center gap-2">
                   <i data-lucide="upload" class="w-4 h-4"></i><span class="mono font-bold">EXPORT ALL</span>
                 </button>
               </div>
            </div>

            <div class="panel2 rounded-2xl p-5">
              <div class="mono text-xs text-slate-300/75 mb-3 font-bold">DATABASE STATUS</div>
              <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                  <div class="mono text-[10px] text-slate-400">COMPANIES</div>
                  <div class="mono font-black text-xl text-slate-200" id="dbCount">0</div>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700">
                  <div class="mono text-[10px] text-slate-400">STATUS</div>
                  <div class="mono font-black text-xl text-emerald-400" id="dbStatus">OK</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button id="btnClearDb" class="btnDanger px-3 py-2 rounded-xl text-xs flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="trash" class="w-3 h-3"></i><span class="mono">CLEAR DB</span>
                </button>
                                <button id="btnRestoreSample" class="btn2 px-3 py-2 rounded-xl text-xs flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="refresh-ccw" class="w-3 h-3"></i><span class="mono">RESTORE SAMPLE</span>
                </button>
              </div>
            </div>
          </div>
          </div>
        </div>
      </section>

<section id="screenHelp" class="panel rounded-2xl p-0 relative overflow-hidden hidden flex flex-col h-[85vh] max-w-4xl mx-auto">
        <div class="scanline"></div>
        
        
        <div class="p-6 border-b border-slate-700/50 bg-slate-900/50 flex justify-between items-center shrink-0">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center border border-cyan-500/30">
              <i data-lucide="book-open" class="w-5 h-5 text-cyan-300"></i>
            </div>
            <div>
              <div class="text-[10px] text-cyan-300 font-bold tracking-widest">MANUAL</div>
              <div class="text-xl text-white font-black glowText">HOW TO PLAY</div>
            </div>
          </div>
                    <div class="flex items-center gap-2">
            <button id="btnTechSpecs" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2 border-slate-600/50">
              <i data-lucide="code" class="w-4 h-4 text-slate-400"></i><span class="mono text-slate-300">SPECS</span>
            </button>
            <button id="btnHelpBack" class="btn px-4 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="x" class="w-4 h-4"></i><span class="mono">CLOSE</span>
            </button>
          </div>
        </div>

        
        <div class="overflow-y-auto p-6 space-y-8">
          
          
          <div class="bg-gradient-to-r from-slate-800/50 to-transparent p-5 rounded-2xl border-l-4 border-cyan-500">
            <h3 class="font-bold text-lg text-white mb-2 flex items-center gap-2">
              <i data-lucide="zap" class="w-5 h-5 text-cyan-400"></i> Ë≤°Âãô„Éá„Éº„Çø √ó RPG„Éê„Éà„É´
            </h3>
                        <p class="text-sm text-slate-300 leading-relaxed">
              ÂÆüÂú®‰ºÅÊ•≠„ÅÆ<strong class="text-white">„ÄåÊúÄÊñ∞Ë≤°ÂãôË´∏Ë°®„Äç</strong>„Åã„ÇâÊà¶ÈóòËÉΩÂäõ„ÇíÁÆóÂá∫„Åó„ÄÅCPU„Å®Êà¶„ÅÜÁµåÂñ∂„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Éê„Éà„É´„Åß„Åô„ÄÇ<br/>
              „ÄåÁèæÈáë„ÅåÂ§ö„Åë„Çå„Å∞Êâì„Åü„ÇåÂº∑„ÅÑ„Äç„ÄåÂà©ÁõäÁéá„ÅåÈ´ò„Åë„Çå„Å∞ÊîªÊíÉÂäõ„ÅåÈ´ò„ÅÑ„Äç„Å™„Å©„ÄÅ„É™„Ç¢„É´„Å™ÁµåÂñ∂‰ΩìË≥™„Åå„Åù„ÅÆ„Åæ„Åæ„Éê„Éà„É´„ÅÆÂÄãÊÄß„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ
              <br/><br/>
              „Åæ„Åü„ÄÅ<strong class="text-amber-400">„ÄåÊîøÊ≤ªÂÆ∂„Äç</strong>„ÇÑ<strong class="text-sky-400">„ÄåÂÖ¨ÂèñÂßî„Äç</strong>„ÇíÂè¨Âñö„Åó„Å¶Áõ§Èù¢„Çí„Å≤„Å£„Åè„ÇäËøî„Åô„ÄÅ<strong class="text-white">ÁèæÂÆüÁöÑ„ÅßÁêÜ‰∏çÂ∞Ω„Å™„ÄåÂ§ßÈÄÜËª¢Ë¶ÅÁ¥†„Äç</strong>„ÇÇÊê≠Ëºâ„ÄÇÁ∂∫È∫ó„Å™Ë≤°Âãô„Å†„Åë„Åß„Å™„Åè„ÄÅÊ≥•Ëá≠„ÅÑÊîøÊ≤ªÂäõ„ÇÇË©¶„Åï„Çå„Åæ„Åô„ÄÇ
            </p>
          </div>

          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            
            <div class="panel2 rounded-2xl p-5">
              <h3 class="font-bold text-base text-sky-300 mb-4 flex items-center gap-2">
                <i data-lucide="triangle" class="w-4 h-4"></i> Â±ûÊÄßÁõ∏ÊÄß (Market Trinity)
              </h3>
              <div class="relative py-4 px-2">
                  <div class="flex justify-center gap-4 text-[10px] mono font-bold text-center">
                    <div class="p-2 border border-cyan-500/30 bg-cyan-500/10 rounded-lg text-cyan-300 w-24">DIGITAL<br/>(Tech/Fin)</div>
                    <div class="self-center text-slate-500">‚Üí</div>
                    <div class="p-2 border border-amber-500/30 bg-amber-500/10 rounded-lg text-amber-300 w-24">REAL<br/>(Auto/Ind)</div>
                  </div>
                  <div class="text-center text-slate-500 my-1">‚Üñ &nbsp; &nbsp; &nbsp; &nbsp; ‚Üô</div>
                  <div class="flex justify-center">
                    <div class="p-2 border border-emerald-500/30 bg-emerald-500/10 rounded-lg text-emerald-300 w-24 text-center">HUMAN<br/>(Retail)</div>
                  </div>
              </div>
              <p class="text-xs text-slate-400 mt-2 text-center">
                ÊúâÂà©„Å™Â±ûÊÄß„Å∏„ÅØ„ÉÄ„É°„Éº„Ç∏ <span class="text-white">1.1ÂÄç</span><br>
                ‰∏çÂà©„Å™Â±ûÊÄß„Å∏„ÅØ„ÉÄ„É°„Éº„Ç∏ <span class="text-white">0.9ÂÄç</span>
              </p>
            </div>

            
                      <div class="panel2 rounded-2xl p-5">
            <h3 class="font-bold text-base text-emerald-300 mb-4 flex items-center gap-2">
              <i data-lucide="activity" class="w-4 h-4"></i> „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ‰ªïÁµÑ„ÅøÔºàË≤°ÂãôÊåáÊ®ô„Å®„ÅÆÈñ¢‰øÇÔºâ
            </h3>
            <div class="space-y-4 text-xs">
              <div class="flex gap-3">
                <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-lg shrink-0">üíö</div>
                <div>
                  <div class="font-bold text-slate-200">HP <span class="text-slate-500">‚Üê ÁèæÈ†êÈáë (Cash)</span></div>
                  <div class="text-slate-400 leading-relaxed">‰ºÅÊ•≠„ÅÆÂü∫Á§é‰ΩìÂäõ„ÄÇÁèæÈ†êÈáë„ÅåÊΩ§Ê≤¢„Å™„Åª„Å©HP„ÅåÈ´ò„Åè„ÄÅÈï∑ÊúüÊà¶„Å´ËÄê„Åà„Çâ„Çå„Çã„ÄÇ<br/>HP„Åå0„Å´„Å™„Çã„Å®Ë≥áÈáë„Ç∑„Éß„Éº„ÉàÔºùÂÄíÁî£ÔºàÊïóÂåóÔºâ„ÄÇ</div>
                </div>
              </div>
              <div class="flex gap-3">
                <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-lg shrink-0">‚öîÔ∏è</div>
                <div>
                  <div class="font-bold text-slate-200">ATK <span class="text-slate-500">‚Üê Âñ∂Ê•≠Âà©ÁõäÁéá (Op.Margin)</span></div>
                  <div class="text-slate-400 leading-relaxed">Êú¨Ê•≠„ÅßÁ®º„ÅêÂäπÁéáÊÄß„ÄÇÂà©ÁõäÁéá„ÅåÈ´ò„ÅÑ„Åª„Å©ÊîªÊíÉÂäõ„ÅåÈ´ò„Åè„Å™„Çä„ÄÅÁõ∏Êâã„ÅÆ„Ç∑„Çß„Ç¢„Çí‰∏ÄÊ∞ó„Å´Â•™„Åà„Çã„ÄÇ</div>
                </div>
              </div>
              <div class="flex gap-3">
                  <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-lg shrink-0">üõ°Ô∏è</div>
                  <div>
                    <div class="font-bold text-slate-200">DEF <span class="text-slate-500">‚Üê Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá (Equity Ratio)</span></div>
                    <div class="text-slate-400 leading-relaxed">Ë≤°Âãô„ÅÆÂÆâÂÖ®ÊÄß„ÄÇËá™Â∑±Ë≥áÊú¨ÊØîÁéá„ÅåÈ´ò„ÅÑ„Åª„Å©Èò≤Âæ°Âäõ„ÅåÈ´ò„Åè„ÄÅ„ÉÄ„É°„Éº„Ç∏„ÇíËªΩÊ∏õ„Åô„Çã„ÄÇ</div>
                  </div>
              </div>
              <div class="flex gap-3">
                  <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-lg shrink-0">‚ö°</div>
                  <div>
                    <div class="font-bold text-slate-200">SPD <span class="text-slate-500">‚Üê ÊôÇ‰æ°Á∑èÈ°ç (Market Cap)</span></div>
                    <div class="text-slate-400 leading-relaxed">‰ºÅÊ•≠„ÅÆË¶èÊ®°„Å®Â∏ÇÂ†¥ÂΩ±ÈüøÂäõ„ÄÇÊôÇ‰æ°Á∑èÈ°ç„ÅåÂ§ß„Åç„ÅÑ„Åª„Å©ÂÖàÊâã„ÇíÂèñ„Çä„ÇÑ„Åô„Åè„ÄÅ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Éí„ÉÉ„Éà„ÇÇÁô∫Áîü„Åó„ÇÑ„Åô„ÅÑ„ÄÇ</div>
                  </div>
              </div>
              <div class="flex gap-3">
                  <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-lg shrink-0">üß™</div>
                  <div>
                    <div class="font-bold text-slate-200">GAUGE <span class="text-slate-500">‚Üê Á†îÁ©∂ÈñãÁô∫Ë≤ª (R&D)</span></div>
                    <div class="text-slate-400 leading-relaxed">Êú™Êù•„Å∏„ÅÆÊäïË≥áÈ°ç„ÄÇR&DË≤ªÁî®„ÅåÂ§ö„ÅÑ„Åª„Å©„Çπ„Ç≠„É´„Ç≤„Éº„Ç∏„ÅåÊó©„ÅèÊ∫ú„Åæ„Çä„ÄÅÂøÖÊÆ∫ÊäÄ„ÇíÈÄ£Áô∫„Åß„Åç„Çã„ÄÇ</div>
                  </div>
              </div>
            </div>
          </div>
          </div>

          
          <div>
            <h3 class="font-bold text-base text-amber-300 mb-4 flex items-center gap-2">
              <i data-lucide="swords" class="w-4 h-4"></i> ÁµåÂñ∂„Ç≥„Éû„É≥„Éâ
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
               
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-cyan-300"><i data-lucide="zap" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">Attack</div><div class="text-[10px] text-slate-400">Âü∫Êú¨ÊîªÊíÉ„ÄÇATK‰æùÂ≠ò„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÄÇ</div></div>
               </div>
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-violet-300"><i data-lucide="shield" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">Guard</div><div class="text-[10px] text-slate-400">Èò≤Âæ°„ÄÇË¢´„ÉÄ„É°Ê∏õÔºÜDEF‰∏äÊòá„ÄÇ„Ç≤„Éº„Ç∏ËìÑÁ©ç„ÄÇ</div></div>
               </div>
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-emerald-300"><i data-lucide="briefcase" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">Invest (40%)</div><div class="text-[10px] text-slate-400">HP„ÇíÁä†Áâ≤„Å´Áõ∏ÊâãÊ†™„ÇíÂèñÂæó„ÄÇÊØé„Çø„Éº„É≥ÈÖçÂΩìÂõûÂæ©„ÄÇ</div></div>
               </div>
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-sky-300"><i data-lucide="gavel" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">TOB (100%)</div><div class="text-[10px] text-slate-400">‰∏ÄÁô∫ÈÄÜËª¢„ÅÆÊïµÂØæÁöÑË≤∑Âèé„ÄÇÊàêÂäü„Åô„Çå„Å∞Âç≥ÂãùÂà©„ÄÇ</div></div>
               </div>
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-amber-300"><i data-lucide="megaphone" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">Summon (50/100%)</div><div class="text-[10px] text-slate-400">ÊîøÊ≤ªÂÆ∂„ÇÑÂÖ¨ÂèñÂßî„ÇíÂè¨Âñö„ÄÇÂ§ß‰ºÅÊ•≠„ÅØ„É™„Çπ„ÇØ„ÅÇ„Çä„ÄÇ</div></div>
               </div>
               <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700 flex gap-3">
                 <div class="text-rose-300"><i data-lucide="scissors" class="w-5 h-5"></i></div>
                 <div><div class="font-bold text-sm text-slate-200">Restructure</div><div class="text-[10px] text-slate-400">„É™„Çπ„Éà„É©Êñ≠Ë°å„ÄÇHPÂõûÂæ©„Å†„ÅåËÉΩÂäõÂ§ßÂπÖ„ÉÄ„Ç¶„É≥„ÄÇ</div></div>
               </div>
            </div>
          </div>

          
                              <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700">
            <h3 class="font-bold text-sm text-pink-300 mb-3 flex items-center gap-2">
              <i data-lucide="lightbulb" class="w-4 h-4"></i> ÊîªÁï•„ÅÆ„Éí„É≥„Éà
            </h3>
            <ul class="space-y-2 text-xs text-slate-300 list-disc pl-4 leading-relaxed">
              <li><strong class="text-white">Ê•≠Áïå„Ç≥„É≥„Éú:</strong> „ÄåËá™ÂãïËªä vs ÈâÑÈãº„Äç„ÄåÂ∞èÂ£≤ vs „ÉÜ„ÉÉ„ÇØ„Äç„Å™„Å©„ÄÅÁâπÂÆö„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅßSkill„Çí‰Ωø„ÅÜ„Å®Âº∑Âäõ„Å™„Ç≥„É≥„ÉúÊäÄ„ÅåÁô∫Âãï„Åó„Åæ„Åô„ÄÇ</li>
              <li><strong class="text-white">Áõ∏Â†¥„Çµ„Ç§„ÇØ„É´:</strong> „ÄåÂ•ΩÊ≥Å(Bull)„Äç„Åß„ÅØ„ÉÜ„ÉÉ„ÇØ/Ë£ΩÈÄ†„ÅåÂº∑„Åè„ÄÅ„Äå‰∏çÊ≥Å(Bear)„Äç„Åß„ÅØÂ∞èÂ£≤/Ë£ΩËñ¨„ÅåÂÆâÂÆö„Åó„Åæ„Åô„ÄÇ„Çø„Éº„É≥ÁµåÈÅé„ÅßÂ§âÂåñ„Åó„Åæ„Åô„ÄÇ</li>
              <li><strong class="text-white">AI Forge:</strong> „ÄåAI FORGE„ÄçÊ©üËÉΩ„Çí‰Ωø„Åà„Å∞„ÄÅ‰∏ñÁïå‰∏≠„ÅÆ„ÅÇ„Çâ„ÇÜ„Çã‰ºÅÊ•≠„Çí„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åï„Åõ„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
            </ul>
          </div>

          
          <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700 mt-6">
            <h3 class="font-bold text-sm text-violet-300 mb-3 flex items-center gap-2">
              <i data-lucide="network" class="w-4 h-4"></i> AI FORGE: M&AÊà¶Áï•
            </h3>
            <p class="text-xs text-slate-300 leading-relaxed mb-4">
              „ÄåAI FORGE„Äç„ÅÆ<span class="text-white font-bold">M&A„Çø„Éñ</span>„Åß„ÅØ„ÄÅÊó¢Â≠ò„ÅÆ2Á§æ„ÇíÈÅ∏Êäû„Åó„Å¶ÁµåÂñ∂Áµ±ÂêàÔºàÂêà‰ΩµÔºâ„Åï„Åõ„ÄÅÊúÄÂº∑„ÅÆÊñ∞‰ºÅÊ•≠„ÇíÁîü„ÅøÂá∫„Åô„Éó„É≠„É≥„Éó„Éà„ÇíÁîüÊàê„Åß„Åç„Åæ„Åô„ÄÇ
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs">
              <div class="panel2 rounded-xl p-3 border border-slate-600/50">
                <div class="font-bold text-white mb-1">üìà „Ç∑„Éä„Ç∏„ÉºÂäπÊûú</div>
                <div class="text-slate-400">‰∏°Á§æ„ÅÆË≤°Âãô„Éá„Éº„ÇøÔºàCash, R&D„Å™„Å©Ôºâ„ÅåÂêàÁÆó„Åï„Çå„ÄÅ„Åï„Çâ„Å´Áµ±Âêà„Éú„Éº„Éä„Çπ„Å®„Åó„Å¶<span class="text-emerald-300">10„Äú20%„ÅÆ‰∏ä‰πó„Åõ</span>„ÅåÁô∫Áîü„Åó„Åæ„Åô„ÄÇ</div>
              </div>
              <div class="panel2 rounded-xl p-3 border border-slate-600/50">
                <div class="font-bold text-white mb-1">‚ö° Áµ±Âêà„Çπ„Ç≠„É´</div>
                <div class="text-slate-400">‰∏°Á§æ„ÅÆÂº∑„Åø„ÇíÊéõ„ÅëÂêà„Çè„Åõ„Åü„ÄÅ„Ç™„É™„Ç∏„Éä„É´„ÅÆ<span class="text-amber-300">„ÄåÊñ∞„ÉªÂøÖÊÆ∫ÊäÄ„Äç</span>„ÅåAI„Å´„Çà„Å£„Å¶ÁîüÊàê„Åï„Çå„Åæ„Åô„ÄÇ</div>
              </div>
            </div>
          </div>

          
                    <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700 mt-6">
            <h3 class="font-bold text-sm text-cyan-300 mb-3 flex items-center gap-2">
              <i data-lucide="music" class="w-4 h-4"></i> SOUND ROOM
            </h3>
            <p class="text-xs text-slate-400 leading-relaxed mb-4">
              ‚ÄªÊú¨„Ç≤„Éº„É†„ÅÆBGM„ÅØ„Åô„Åπ„Å¶„ÄÅAI„ÅåË®òËø∞„Åó„Åü„Éó„É≠„Ç∞„É©„É†„Å´„Çà„Çä<strong>„Éñ„É©„Ç¶„Ç∂‰∏ä„Åß„É™„Ç¢„É´„Çø„Ç§„É†„Å´Ëá™ÂãïÊºîÂ•è</strong>„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºàWeb Audio APIÔºâ„ÄÇ<br>
              Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åõ„Åö„ÄÅ„Ç≥„Éº„Éâ„Åã„ÇâÁîü„ÅøÂá∫„Åï„Çå„Çã„ÄåAI„Éó„É≠„Ç∑„Éº„Ç∏„É£„É´Èü≥Ê•Ω„Äç„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ
            </p>
            <div class="space-y-4">
              <div>
                <div class="mono text-[10px] text-slate-400 mb-2">BGM TRACKS</div>
                <div class="flex flex-wrap gap-2" id="bgmControls">
                  <button data-track="Menu" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">MENU</button>
                  <button data-track="Battle" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">BATTLE</button>
                  <button data-track="Boss" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">BOSS</button>
                                    <button data-track="Victory" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">VICTORY</button>
                  <button data-track="Defeat" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">DEFEAT</button>
                  <button data-track="Summon" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">SUMMON</button>
                  <button data-track="Influencer" class="btn2 px-3 py-1.5 rounded-lg text-xs mono transition-colors">INFLUENCER</button>
                  <button data-track="Stop" class="btnDanger px-3 py-1.5 rounded-lg text-xs mono transition-colors border-rose-500/50">STOP</button>
                </div>
              </div>
              <div>
                <div class="mono text-[10px] text-slate-400 mb-2">SOUND FX</div>
                <div class="flex flex-wrap gap-2">
                  <button id="btnSeAtk" class="btn2 px-3 py-1.5 rounded-lg text-xs mono hover:text-white">ATTACK</button>
                  <button id="btnSeCrit" class="btn2 px-3 py-1.5 rounded-lg text-xs mono hover:text-white">CRIT</button>
                  <button id="btnSeSummon" class="btn2 px-3 py-1.5 rounded-lg text-xs mono hover:text-white">SUMMON</button>
                  <button id="btnSePivot" class="btn2 px-3 py-1.5 rounded-lg text-xs mono hover:text-white">PIVOT</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="h-8"></div>
        </div>
      </section>

    <div id="modal" class="fixed inset-0 hidden items-center justify-center px-4 z-[80]">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative w-full max-w-2xl panel rounded-2xl p-4 sm:p-6 overflow-hidden">
          <div class="scanline"></div>
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="tag" id="modalTag">INFO</span>
              <div class="mono text-sm text-slate-200/90" id="modalTitle">‚Äî</div>
            </div>
            <button id="btnCloseModal" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="x" class="w-4 h-4"></i><span class="mono">CLOSE</span>
            </button>
          </div>
          <div id="modalBody" class="mt-3"></div>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[90] hidden">
        <div id="toastInner" class="panel2 rounded-2xl px-4 py-3 mono text-sm"></div>
      </div>

    </main>

    <footer class="py-6 text-xs text-slate-300/65 mono">
      
    </footer>
  </div>

    <script>
                    /* --- VISUALIZER ENGINE --- */
    const Visualizer = (() => {
      let cv, cx, an, da;
      const init = () => {
        cv = document.getElementById('vizCanvas');
        if (cv) {
          cv.width = cv.offsetWidth;
          cv.height = cv.offsetHeight;
          cx = cv.getContext('2d');
          loop();
        }
      };
      const connect = (ac, src) => {
        if (!cv) init();
        if (!cx) return;
        try {
          an = ac.createAnalyser();
          an.fftSize = 64;
          an.smoothingTimeConstant = 0.6;
          src.connect(an);
          da = new Uint8Array(an.frequencyBinCount);
        } catch(e){}
      };
      const loop = () => {
        requestAnimationFrame(loop);
        if (!cx || !an || !da) return;
        if (an.context.state !== 'running') {
          cx.clearRect(0, 0, cv.width, cv.height);
          return;
        }
        an.getByteFrequencyData(da);
        cx.clearRect(0, 0, cv.width, cv.height);
        
        // Glitch
        if (Math.random() < 0.03) {
          cx.fillStyle = 'rgba(53,247,255,0.1)';
          cx.fillRect(0, 0, cv.width, cv.height);
          cx.setTransform(1, 0, 0, 1, (Math.random()-0.5)*4, 0);
        } else {
          cx.setTransform(1, 0, 0, 1, 0, 0);
        }

        const barCount = da.length * 0.7;
        const barW = cv.width / barCount;
        cx.fillStyle = '#35F7FF';
        
        for (let i = 0; i < barCount; i++) {
          const v = da[i];
          const h = (v / 255) * cv.height * 0.9;
          if (h > 1) {
            cx.globalAlpha = 0.4 + Math.random() * 0.6;
            cx.fillRect(i * barW, cv.height - h, barW - 1, h);
          }
        }
        cx.globalAlpha = 1.0;
        cx.setTransform(1, 0, 0, 1, 0, 0);
      };
      return { connect };
    })();

    /* --- FANFARE ENGINE (Victory) --- */
    const FanfareEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 138, nextNoteTime = 0, noteIndex = 0;
      let timerID, masterGain = null;
      const introMelody = [{n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'C5',d:0.66},{n:'C5',d:0.66},{n:'C5',d:0.66}, {n:'G#4',d:2},{n:'A#4',d:2},{n:'C5',d:8}];
      const loopLength = 32;
      const loopMelody = ['C5',null,'G4',null, 'E4',null,'C4',null, 'A3','B3','C4','D4', 'E4',null,'C4',null, 'F4',null,'C4',null, 'A3',null,'F3',null, 'D3','E3','F3','G3', 'A3','B3','C4','D4'];
      const loopBass = ['C2',null,'G2',null, 'C2',null,'G2',null, 'A1',null,'E2',null, 'A1',null,'E2',null, 'F1',null,'C2',null, 'F1',null,'C2',null, 'G1',null,'D2',null, 'G1',null,'G2',null];
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function playTrumpet(t,f,d){const o=ctx.createOscillator(),o2=ctx.createOscillator(),fi=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=f;o2.type='sawtooth';o2.frequency.value=f*1.002;fi.type='lowpass';fi.Q.value=2;fi.frequency.setValueAtTime(800,t);fi.frequency.linearRampToValueAtTime(3000,t+0.05);fi.frequency.exponentialRampToValueAtTime(1500,t+d);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.4,t+0.02);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0,t+d);o.connect(fi);o2.connect(fi);fi.connect(g);g.connect(masterGain);o.start(t);o.stop(t+d+0.1);o2.start(t);o2.stop(t+d+0.1);}
      function playStrings(t,f,d){const o=ctx.createOscillator(),fi=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=f;fi.type='lowpass';fi.frequency.value=1000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.1,t+0.2);g.gain.linearRampToValueAtTime(0,t+d+0.2);o.connect(fi).connect(g).connect(masterGain);o.start(t);o.stop(t+d+0.3);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.1,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type='highpass';f.frequency.value=800;g.gain.setValueAtTime(0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playTimpani(t){const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(10,t+0.3);g.gain.setValueAtTime(0.8,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.5);}
      function playBass(t,f,d){const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.4);}
      function schedule(){let ct=ctx.currentTime+0.1; introMelody.forEach(n=>{const d=n.d*(60/tempo/4); playTrumpet(ct,noteToFreq(n.n),d); if(n.n==='G#4')playStrings(ct,noteToFreq('G#3'),2); if(n.n==='A#4')playStrings(ct,noteToFreq('A#3'),2); if(n.n==='C5'){playStrings(ct,noteToFreq('C3'),4);playStrings(ct,noteToFreq('E3'),4);playStrings(ct,noteToFreq('G3'),4);playTimpani(ct);} ct+=d;}); const loopStart=ct; function runLoop(st){if(!isPlaying)return; for(let i=0;i<loopLength;i++){const t=st+(i*(60/tempo/4)); const n=loopMelody[i]; if(n)playTrumpet(t,noteToFreq(n),0.2); const b=loopBass[i]; if(b)playBass(t,noteToFreq(b),0.2); if(i%4===0)playSnare(t); if(i%4===2){playSnare(t);playSnare(t+(60/tempo/4)*0.5);}} const next=st+(loopLength*(60/tempo/4)); timerID=setTimeout(()=>runLoop(next),(next-ctx.currentTime-0.5)*1000);} timerID=setTimeout(()=>runLoop(loopStart),(loopStart-ctx.currentTime-0.1)*1000);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.4;masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; schedule();}catch(e){console.log(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

    /* --- REQUIEM ENGINE (Defeat) --- */
    const RequiemEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 68, nextNoteTime = 0, current16thNote = 0, timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 128, harpLine=[], bassLine=[], padLine=[], leadLine=[];
      function compose(){harpLine.length=0;bassLine.length=0;padLine.length=0;leadLine.length=0; for(let i=0;i<seqLength;i++){const bar=Math.floor(i/16),step=i%16; let ch=[],bn=null,pc=null; if(bar<2){ch=['A2','E3','A3','C4'];bn='A1';pc=['A2','C3','E3'];}else if(bar<4){ch=['F2','C3','F3','A3'];bn='F1';pc=['F2','A2','C3','E3'];}else if(bar<6){if(bar===4){ch=['D2','A2','D3','F3'];bn='D1';pc=['D2','F2','A2','C3'];}else{ch=['G2','D3','G3','B3'];bn='G1';pc=['G2','B2','D3','F3'];}}else{if(bar===6){ch=['E2','B2','E3','G#3'];bn='E1';pc=['E2','G#2','B2','D3'];}else{ch=['A2','E3','G3','C4'];bn='A1';pc=['A2','C3','E3','G3'];}} const ap=[0,1,2,3,2,1,0,1,2,3,2,1,0,1,2,3]; harpLine.push(ch[ap[step]]); if(step===0){bassLine.push(bn);padLine.push(pc);}else{bassLine.push(null);padLine.push(null);} let n=null; if(bar===0&&step===0)n={n:'E4',d:12}; if(bar===1&&step===0)n={n:'C4',d:8}; if(bar===1&&step===12)n={n:'A3',d:4}; if(bar===2&&step===0)n={n:'F4',d:12}; if(bar===3&&step===0)n={n:'E4',d:4}; if(bar===3&&step===4)n={n:'D4',d:4}; if(bar===3&&step===8)n={n:'C4',d:8}; if(bar===4&&step===0)n={n:'D4',d:10}; if(bar===5&&step===0)n={n:'B3',d:10}; if(bar===6&&step===0)n={n:'G#3',d:12}; if(bar===7&&step===0)n={n:'A3',d:16}; leadLine.push(n);}}
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,4*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playHarp(t,f){const o=ctx.createOscillator(),o2=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='sine';o.frequency.value=f;o2.type='triangle';o2.frequency.value=f*2;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.3,t+0.01);g.gain.exponentialRampToValueAtTime(0.001,t+1.5);p.pan.value=(current16thNote%2===0)?-0.2:0.2;o.connect(g);o2.connect(g);g.connect(p).connect(masterGain);o.start(t);o.stop(t+1.5);o2.start(t);o2.stop(t+1.5);}
      function playStrings(t,ns){const d=4.0; ns.forEach(n=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.08,t+1.0);g.gain.linearRampToValueAtTime(0,t+d);o.connect(g).connect(masterGain);o.start(t);o.stop(t+d);});}
      function playBass(t,n){const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.3,t+0.2);g.gain.linearRampToValueAtTime(0,t+4.0);o.connect(g).connect(masterGain);o.start(t);o.stop(t+4.0);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*(60/tempo/4),o=ctx.createOscillator(),l=ctx.createOscillator(),lg=ctx.createGain(),g=ctx.createGain(),rs=ctx.createGain(),c=ctx.createConvolver();o.type='triangle';o.frequency.value=f;l.frequency.value=5;lg.gain.setValueAtTime(0,t);lg.gain.linearRampToValueAtTime(2,t+0.5);l.connect(lg).connect(o.frequency);l.start(t);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.2,t+0.2);g.gain.setValueAtTime(0.2,t+d-0.2);g.gain.linearRampToValueAtTime(0,t+d+0.5);rs.gain.value=0.5;c.buffer=reverbBuffer;o.connect(g);g.connect(masterGain);g.connect(rs).connect(c).connect(masterGain);o.start(t);o.stop(t+d+1.0);}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength; if(harpLine[i])playHarp(nextNoteTime,noteToFreq(harpLine[i])); if(bassLine[i])playBass(nextNoteTime,bassLine[i]); if(padLine[i])playStrings(nextNoteTime,padLine[i]); if(leadLine[i])playLead(nextNoteTime,leadLine[i]); nextNoteTime+=0.25*(60.0/tempo); current16thNote++;} timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.5;masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);reverbBuffer=createReverb();compose();} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; current16thNote=0; nextNoteTime=ctx.currentTime+0.1; schedule();}catch(e){console.log(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

/* --- BOSS BATTLE BGM ENGINE (Nobuo Style / Epic) --- */
    const BossAudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 168, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];
      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const roots = ['E2','F2','E2','G#2', 'A2','B2','C3','B2', 'E2','C2','D2','G2', 'C2','D2','E2','E2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16, root = roots[bar%16];
          // Drums
          let k=0, s=0, h=0; if(step%2===0) k=1; if(step===4||step===12) s=1; if(i%2===0) h=1; else h=0.3; if(step>12 && (bar+1)%4===0) { k=1; s=1; h=0; }
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          // Bass
          if(step%2===0) bassLine.push(root); else bassLine.push(root);
          // Arp
          let arpNotes = ['E3','B3','E4','G4','B4','G4','E4','B3'];
          if(root.startsWith('F')) arpNotes=['F3','C4','F4','A4','C5','A4','F4','C4'];
          if(root.startsWith('G#')) arpNotes=['G#3','D4','F4','B4','D5','B4','F4','D4'];
          if(root.startsWith('A')) arpNotes=['A3','E4','A4','C5','E5','C5','A4','E4'];
          if(root.startsWith('C')) arpNotes=['C3','G3','C4','E4','G4','E4','C4','G3'];
          if(root.startsWith('D')) arpNotes=['D3','A3','D4','F#4','A4','F#4','D4','A3'];
          if(root.startsWith('B')) arpNotes=['B2','F#3','B3','D#4','F#4','D#4','B3','F#3'];
          arpLine.push(arpNotes[i%8]);
          // Pad
          if(step===0) {
            let chord=['E3','G3','B3'];
            if(root.startsWith('F')) chord=['F3','A3','C4']; if(root.startsWith('G#')) chord=['G#3','B3','D4']; if(root.startsWith('A')) chord=['A3','C4','E4']; if(root.startsWith('B')) chord=['B3','D#4','F#4']; if(root.startsWith('C')) chord=['C3','E3','G3']; if(root.startsWith('D')) chord=['D3','F#3','A3'];
            padChords.push(chord);
          } else padChords.push(null);
          // Lead
          let n=null, ls=i%64;
          if(bar%16<4) { if(step===0)n={n:root.replace('2','4'),d:4}; if(step===6)n={n:root.replace('2','4'),d:2}; }
          else if(bar%16<8) { if(ls===0)n={n:'A4',d:6}; if(ls===8)n={n:'B4',d:2}; if(ls===10)n={n:'C5',d:4}; if(ls===16)n={n:'B4',d:12}; if(ls===32)n={n:'G4',d:6}; if(ls===40)n={n:'E4',d:4}; if(ls===48)n={n:'F#4',d:12}; }
          else if(bar%16<12) { if(ls===0)n={n:'E5',d:10}; if(ls===12)n={n:'D5',d:6}; if(ls===16)n={n:'C5',d:12}; if(ls===32)n={n:'B4',d:4}; if(ls===36)n={n:'C5',d:4}; if(ls===40)n={n:'D5',d:8}; if(ls===48)n={n:'G5',d:12}; }
          else { if(ls===0)n={n:'C5',d:6}; if(ls===8)n={n:'D5',d:6}; if(ls===16)n={n:'E5',d:12}; if(ls===32)n={n:'B4',d:4}; if(ls===36)n={n:'A4',d:4}; if(ls===40)n={n:'G4',d:4}; if(ls===48)n={n:'E4',d:16}; }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,2*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(masterGain);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.2,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=1000;g.gain.setValueAtTime(0.7,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=5000;g.gain.setValueAtTime(v*0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f);f.connect(g);g.connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*0.25*(60/tempo),o=ctx.createOscillator(),g=ctx.createGain(),l=ctx.createOscillator(),lg=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='square';o.frequency.value=f;l.frequency.value=5;lg.gain.value=5;l.connect(lg);lg.connect(o.frequency);l.start(t);g.gain.setValueAtTime(0.4,t);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0.01,t+d);dl.delayTime.value=0.25;dg.gain.value=0.4;o.connect(g);g.connect(masterGain);g.connect(dl);dl.connect(dg);dg.connect(dl);dg.connect(masterGain);o.start(t);o.stop(t+d+0.5);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);p.pan.value=(current16thNote%2===0)?-0.3:0.3;o.connect(g);g.connect(p);p.connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){const d=16*0.25*(60/tempo);ns.forEach(n=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);o2.type='sawtooth';o2.frequency.value=noteToFreq(n)*1.002;f.type='lowpass';f.frequency.value=2000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.5);g.gain.setValueAtTime(0.15,t+d-0.5);g.gain.linearRampToValueAtTime(0.01,t+d);rg.gain.value=0.5;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g);g.connect(masterGain);g.connect(rg);rg.connect(c);c.connect(masterGain);o.start(t);o2.start(t);o.stop(t+d);o2.stop(t+d);});}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playSnare(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.6;masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);reverbBuffer=createReverb();compose();} if(ctx.state==='suspended')await ctx.resume(); if(isPlaying)return; isPlaying=true; current16thNote=0; nextNoteTime=ctx.currentTime+0.1; schedule();}catch(e){console.error(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
            };
    })();

        /* --- INFLUENCER BGM ENGINE (Kawaii Pop) --- */
    const InfluencerBgmEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 136, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];
      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const progRoots = ['A#1', 'C2', 'A1', 'D2']; // Bb, C, Am, Dm (shifted for synth)
        const scale = ['F3','G3','A3','A#3','C4','D4','E4','F4','G4','A4'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16, phraseStep = bar%4;
          let k=0, s=0, h=0;
          if(step===0||step===10) k=1; if((bar+1)%4===0 && step>12) k=1;
          if(step===4||step===12) s=1;
          if(step%2===0) h=0.8; else h=0.3; if((bar+1)%4===0 && step>12){s=1;h=0;k=0;}
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          let root = progRoots[phraseStep];
          if(step===0||step===3||step===8||step===11) bassLine.push(root); else bassLine.push(null);
          if(bar>=4) arpLine.push(scale[(i%8)+(phraseStep)]); else arpLine.push(null);
          if(step===0) {
            if(phraseStep===0) padChords.push(['A#3','D4','F4','A4']);
            if(phraseStep===1) padChords.push(['C4','E4','G4','A#4']);
            if(phraseStep===2) padChords.push(['A3','C4','E4','G4']);
            if(phraseStep===3) padChords.push(['D4','F4','A4','C5']);
          } else padChords.push(null);
          let n = null; const localStep = i%64;
          if(bar>=4) {
            if(localStep===0) n={n:'A4',l:3}; if(localStep===3) n={n:'G4',l:1}; if(localStep===4) n={n:'F4',l:2}; if(localStep===6) n={n:'G4',l:2}; if(localStep===8) n={n:'A4',l:4};
            if(localStep===16) n={n:'G4',l:3}; if(localStep===19) n={n:'F4',l:1}; if(localStep===20) n={n:'E4',l:4};
            if(localStep===32) n={n:'D4',l:3}; if(localStep===35) n={n:'E4',l:1}; if(localStep===36) n={n:'F4',l:2}; if(localStep===38) n={n:'G4',l:2}; if(localStep===40) n={n:'A4',l:2}; if(localStep===42) n={n:'A#4',l:2}; if(localStep===44) n={n:'C5',l:4};
          }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,1.5*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,2.5); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.4);g.gain.setValueAtTime(0.8,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);o.connect(g).connect(masterGain);o.start(t);o.stop(t+0.4);}
      function playClap(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.15,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="bandpass";f.frequency.value=1200;g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=7000;g.gain.setValueAtTime(v*0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.03);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='square';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(600,t);f.frequency.linearRampToValueAtTime(100,t+0.2);g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f).connect(g).connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='sine';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);p.pan.value=Math.sin(t*10)*0.8;o.connect(g).connect(p).connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){ns.forEach(n=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);o2.type='sawtooth';o2.frequency.value=noteToFreq(n)*1.004;f.type='lowpass';f.frequency.value=2500;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.08,t+0.1);g.gain.setValueAtTime(0.08,t+1.5);g.gain.linearRampToValueAtTime(0.01,t+1.8);rg.gain.value=0.4;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g).connect(masterGain);g.connect(rg).connect(c).connect(masterGain);o.start(t);o2.start(t);o.stop(t+2.0);o2.stop(t+2.0);});}
      function playLead(t,no){const f=noteToFreq(no.n),d=no.l*0.25*(60/tempo),o=ctx.createOscillator(),l=ctx.createOscillator(),lg=ctx.createGain(),g=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='square';o.frequency.setValueAtTime(f*0.9,t);o.frequency.linearRampToValueAtTime(f,t+0.05);l.frequency.value=6;lg.gain.value=f*0.02;l.connect(lg).connect(o.frequency);l.start(t);g.gain.setValueAtTime(0.15,t);g.gain.linearRampToValueAtTime(0.15,t+d*0.8);g.gain.linearRampToValueAtTime(0.01,t+d);dl.delayTime.value=60/tempo*0.5;dg.gain.value=0.3;o.connect(g).connect(masterGain);g.connect(dl).connect(dg).connect(dl).connect(masterGain);o.start(t);o.stop(t+d+1.0);}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playClap(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.4;masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);reverbBuffer=createReverb();compose();}if(ctx.state==='suspended')await ctx.resume();if(isPlaying)return;isPlaying=true;current16thNote=0;nextNoteTime=ctx.currentTime+0.1;schedule();}catch(e){console.error(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},250);}
      };
    })();

    /* --- SUMMON BGM ENGINE (Final Boss Style) --- */
    const SummonBgmEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 175, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];
      function compose() {
        bassLine.length = 0; kickPat.length = 0; snarePat.length = 0; hatPat.length = 0;
        padChords.length = 0; leadLine.length = 0; arpLine.length = 0;
        const roots = ['C#2','C#2','D2','C#2', 'F#2','D2','E2','C#2', 'A2','G#2','F#2','E2', 'F2','G2','A2','B2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16, root = roots[bar%16];
          let k=0, s=0, h=0;
          if (bar < 4) {
            if(step===0) { k=1; s=1; h=1; } if(step===12) k=1; if(step%4===0) h=0.2;
          } else {
            if(step===0 || step===8) k=1;
            if(step===10 || step===11 || step===2 || step===3) k=0.7;
            if(step===4 || step===12) s=1;
            if(i%2===0) h=0.8; else h=0.3;
            if((bar+1)%4===0 && step > 8) { k=1; s=1; h=0; }
          }
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          if(bar < 4) { if(step%8===0) bassLine.push(root); else bassLine.push(null); }
          else { if(step%2===0) bassLine.push(root); else if(step===1 || step===3) bassLine.push(root.replace('2','3')); else bassLine.push(null); }
          let arpArr = ['C#4','E4','G4','C#5', 'E5', 'C#5', 'G4', 'E4'];
          if(root.startsWith('F#')) arpArr = ['F#4','A4','C#5','F#5','A5','F#5','C#5','A4'];
          if(root.startsWith('A')) arpArr = ['A4','C#5','E5','A5','E5','C#5','E5','A5'];
          if(root.startsWith('D')) arpArr = ['D4','F#4','A4','D5','A4','F#4','D4','A3'];
          if(root.startsWith('E')) arpArr = ['E4','G#4','B4','E5','B4','G#4','E4','B3'];
          arpLine.push(arpArr[i % 8]);
          if(step === 0 || (bar < 4 && step === 8)) {
            let chord = ['C#3','E3','G#3','C#4'];
            if(root.startsWith('D')) chord = ['D3','F#3','A3','D4'];
            if(root.startsWith('F#')) chord = ['F#3','A3','C#4','F#4'];
            if(root.startsWith('E')) chord = ['E3','G#3','B3','E4'];
            if(root.startsWith('A')) chord = ['A3','C#4','E4','A4'];
            if(root.startsWith('G#')) chord = ['G#3','B#3','D#4','G#4'];
            if(root.startsWith('B')) chord = ['B3','D#4','F#4','B4'];
            if(root.startsWith('F')) chord = ['F3','A3','C4','F4'];
            if(root.startsWith('G')) chord = ['G3','B3','D4','G4'];
            padChords.push(chord); 
          } else padChords.push(null);
          let n = null; const localStep = i % 64;
          if(bar < 4) { if(step===0) n={n:root.replace('2','5'), d:4}; }
          else if(bar < 8) {
            if(localStep===0) n={n:'C#5', d:6}; if(localStep===8) n={n:'B4', d:2}; if(localStep===10) n={n:'A4', d:4};
            if(localStep===16) n={n:'G#4', d:12}; if(localStep===32) n={n:'F#4', d:6}; if(localStep===40) n={n:'G#4', d:6};
            if(localStep===48) n={n:'A4', d:16};
          } else if(bar < 12) {
            if(localStep===0) n={n:'E5', d:10}; if(localStep===12) n={n:'D#5', d:6}; if(localStep===16) n={n:'C#5', d:12};
            if(localStep===32) n={n:'B4', d:4}; if(localStep===36) n={n:'C#5', d:4}; if(localStep===40) n={n:'E5', d:8};
            if(localStep===48) n={n:'A5', d:12};
          } else {
            if(step%4===0) { const chaos = ['F5','E5','D5','C5','B4','A4','G4','F4','E4','D4','C4','B3']; n={n:chaos[bar%4], d:4}; }
          }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,2*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g).connect(masterGain);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.2,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=1000;g.gain.setValueAtTime(0.7,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=5000;g.gain.setValueAtTime(v*0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);s.connect(f).connect(g).connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f).connect(g).connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*0.25*(60/tempo),o=ctx.createOscillator(),g=ctx.createGain(),fi=ctx.createBiquadFilter(),l=ctx.createOscillator(),lg=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();
        o.type='sawtooth';o.frequency.value=f;fi.type='lowpass';fi.frequency.setValueAtTime(f*2,t);fi.frequency.linearRampToValueAtTime(f*4,t+0.1);fi.Q.value=2;l.frequency.value=6;lg.gain.setValueAtTime(0,t);lg.gain.linearRampToValueAtTime(8,t+0.5);l.connect(lg).connect(o.frequency);l.start(t);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.35,t+0.05);g.gain.setValueAtTime(0.35,t+d-0.1);g.gain.linearRampToValueAtTime(0.01,t+d+0.2);dl.delayTime.value=60/tempo*0.75;dg.gain.value=0.35;o.connect(fi).connect(g).connect(masterGain);g.connect(dl).connect(dg).connect(dl).connect(masterGain);o.start(t);o.stop(t+d+1.0);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);p.pan.value=(current16thNote%2===0)?-0.3:0.3;o.connect(g).connect(p).connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){const dur=16*0.25*(60/tempo);ns.forEach((n,idx)=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type=idx%2===0?'triangle':'sawtooth';o.frequency.value=noteToFreq(n);o2.type='square';o2.frequency.value=noteToFreq(n)*0.5;f.type='bandpass';f.frequency.value=800;f.Q.value=0.5;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.2,t+0.8);g.gain.setValueAtTime(0.2,t+dur-0.5);g.gain.linearRampToValueAtTime(0.01,t+dur+0.5);rg.gain.value=0.8;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g).connect(masterGain);g.connect(rg).connect(c).connect(masterGain);o.start(t);o2.start(t);o.stop(t+dur+1);o2.stop(t+dur+1);});}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playSnare(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play:async()=>{try{if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;ctx=new AC();masterGain=ctx.createGain();masterGain.gain.value=0.6;masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);reverbBuffer=createReverb();compose();}if(ctx.state==='suspended')await ctx.resume();if(isPlaying)return;isPlaying=true;current16thNote=0;nextNoteTime=ctx.currentTime+0.1;schedule();}catch(e){console.error(e);}},
        stop:()=>{isPlaying=false;clearTimeout(timerID);if(masterGain)try{masterGain.gain.setTargetAtTime(0,ctx.currentTime,0.1);}catch(e){} setTimeout(()=>{if(ctx){ctx.close();ctx=null;}},200);}
      };
    })();

    /* --- SOUND EFFECTS ENGINE --- */
    const SoundEffects = (() => {
      let ctx = null;
      const getCtx = () => {
        if(!ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          ctx = new AC();
        }
        if(ctx.state === 'suspended') ctx.resume();
        return ctx;
      };
      const osc = (type, freq, dur, vol=0.3, slide=null) => {
        try {
          const c = getCtx();
          const o = c.createOscillator();
          const g = c.createGain();
          o.type = type;
          o.frequency.setValueAtTime(freq, c.currentTime);
          if(slide) o.frequency.linearRampToValueAtTime(slide, c.currentTime + dur);
          g.gain.setValueAtTime(vol, c.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + dur);
          o.connect(g).connect(c.destination);
          o.start(); o.stop(c.currentTime + dur);
        } catch(e){}
      };
      const noise = (dur, vol=0.5, type='lowpass', freq=1000) => {
        try {
          const c = getCtx();
          const b = c.createBuffer(1, c.sampleRate * dur, c.sampleRate);
          const d = b.getChannelData(0);
          for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
          const src = c.createBufferSource();
          src.buffer = b;
          const f = c.createBiquadFilter(); f.type=type; f.frequency.value=freq;
          const g = c.createGain();
          g.gain.setValueAtTime(vol, c.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, c.currentTime + dur);
          src.connect(f).connect(g).connect(c.destination);
          src.start();
        } catch(e){}
      };
            return {
        attack: () => { noise(0.1, 0.5, 'lowpass', 600); osc('triangle', 100, 0.1, 0.4, 50); },
        crit:   () => { osc('square', 660, 0.15, 0.3, 880); noise(0.2, 0.6, 'highpass', 1000); },
        guard:  () => { osc('sine', 800, 0.15, 0.2); osc('triangle', 1200, 0.3, 0.1); },
        skill:  () => { osc('sawtooth', 220, 0.5, 0.2, 880); setTimeout(()=>noise(0.4, 0.5), 300); },
        heal:   () => { osc('sine', 523, 0.4, 0.1); setTimeout(()=>osc('sine', 659, 0.4, 0.1), 100); setTimeout(()=>osc('sine', 784, 0.6, 0.1), 200); },
        summon: () => { osc('sawtooth', 110, 0.8, 0.4); osc('sawtooth', 164, 0.8, 0.4); },
        pivot:  () => { osc('square', 440, 0.1, 0.2); setTimeout(()=>osc('square', 880, 0.1, 0.2), 80); },
        invest: () => { osc('sine', 1567, 0.1, 0.3); setTimeout(()=>osc('sine', 2093, 0.1, 0.3), 80); setTimeout(()=>osc('sine', 2637, 0.2, 0.3), 160); },
        damage: () => { noise(0.2, 0.4, 'lowpass', 500); },
        crumble: () => {
          // „Ç¥„Ç¥„Ç¥„Ç¥Èü≥ (‰ΩéÂë®Ê≥¢„Éé„Ç§„Ç∫„ÅÆÈáç„Å≠Êéõ„Åë)
          noise(2.5, 0.8, 'lowpass', 80);
          setTimeout(()=>noise(2.0, 0.6, 'lowpass', 60), 200);
          setTimeout(()=>noise(1.5, 0.5, 'lowpass', 100), 500);
          setTimeout(()=>noise(1.0, 0.4, 'lowpass', 50), 900);
        }
      };
    })();

    /* --- OPENING BGM ENGINE (Cyberpunk / Corporate Ambient) --- */
    const MenuAudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 100, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 64; 
      const bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], arpLine=[];

      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; arpLine.length=0;
        // Progression: Dm -> Bb -> F -> C (Dark & Heroic)
        const roots = ['D2','D2','A#1','A#1', 'F2','F2','C2','C2']; 
        
        for(let i=0; i<seqLength; i++) {
          const step = i%16;
          const rootIdx = Math.floor(i/8) % 8;
          const root = roots[rootIdx];

          // Kick
          let k=0; if(step===0 || step===8 || (step===14 && Math.random()>0.7)) k=0.9;
          kickPat.push(k);
          // Snare
          let s=0; if(step===4 || step===12) s=0.8;
          snarePat.push(s);
          // Hat
          hatPat.push(step%2===0 ? 0.3 : 0.1); // subtle 8ths

          // Bass: 8th note pump
          if(i%2===0) bassLine.push(root); else bassLine.push(null);

          // Pad
          if(step===0 && i%8===0) {
            if(root==='D2') padChords.push(['D3','F3','A3','C4']);
            else if(root==='A#1') padChords.push(['A#2','D3','F3','A3']);
            else if(root==='F2') padChords.push(['F3','A3','C4','E4']);
            else if(root==='C2') padChords.push(['C3','E3','G3','B3']);
          } else padChords.push(null);

          // Arp (Pluck)
          const arpScale = ['D4','F4','G4','A4','C5','D5'];
          if(i%2===0 && Math.random()>0.3) arpLine.push(arpScale[Math.floor(Math.random()*arpScale.length)]);
          else arpLine.push(null);
        }
      }

      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      
      // Impulse Response for Reverb
      function createReverb(){
        const len = 3 * ctx.sampleRate;
        const b = ctx.createBuffer(2, len, ctx.sampleRate);
        for(let c=0;c<2;c++){
           const d = b.getChannelData(c);
           for(let i=0;i<len;i++) d[i] = (Math.random()*2-1) * Math.pow(1-i/len, 3);
        }
        return b;
      }

      // Instruments
      function playKick(t){
         const o = ctx.createOscillator();
         const g = ctx.createGain();
         o.frequency.setValueAtTime(120, t);
         o.frequency.exponentialRampToValueAtTime(0.01, t+0.5);
         g.gain.setValueAtTime(0.8, t);
         g.gain.exponentialRampToValueAtTime(0.01, t+0.5);
         o.connect(g).connect(masterGain);
         o.start(t); o.stop(t+0.5);
      }
      function playSnare(t){
         const n = ctx.createBufferSource();
         const b = ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate);
         const d = b.getChannelData(0);
         for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
         n.buffer=b;
         const f = ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=1200;
         const g = ctx.createGain();
         g.gain.setValueAtTime(0.6, t);
         g.gain.exponentialRampToValueAtTime(0.01, t+0.25);
         // Add reverb send
         const rG = ctx.createGain(); rG.gain.value=0.4;
         const c = ctx.createConvolver(); c.buffer=reverbBuffer;
         n.connect(f).connect(g).connect(masterGain);
         g.connect(rG).connect(c).connect(masterGain);
         n.start(t);
      }
      function playHihat(t, vol){
         const n = ctx.createBufferSource();
         const b = ctx.createBuffer(1, ctx.sampleRate*0.05, ctx.sampleRate);
         const d = b.getChannelData(0);
         for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
         n.buffer=b;
         const f = ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=6000;
         const g = ctx.createGain();
         g.gain.setValueAtTime(vol*0.3, t);
         g.gain.exponentialRampToValueAtTime(0.01, t+0.05);
         n.connect(f).connect(g).connect(masterGain);
         n.start(t);
      }
      function playBass(t, n){
         const o = ctx.createOscillator(); o.type='sawtooth';
         o.frequency.value = noteToFreq(n);
         const f = ctx.createBiquadFilter(); f.type='lowpass';
         f.frequency.setValueAtTime(100, t);
         f.frequency.linearRampToValueAtTime(800, t+0.1);
         f.frequency.exponentialRampToValueAtTime(100, t+0.4);
         const g = ctx.createGain();
         g.gain.setValueAtTime(0.5, t);
         g.gain.linearRampToValueAtTime(0, t+0.5);
         o.connect(f).connect(g).connect(masterGain);
         o.start(t); o.stop(t+0.5);
      }
      function playPad(t, chord){
         const dur = 8 * 0.25 * (60/tempo); // 2 beats
         chord.forEach((n,i)=>{
            const o = ctx.createOscillator(); o.type='triangle';
            o.frequency.value = noteToFreq(n);
            const o2 = ctx.createOscillator(); o2.type='sawtooth';
            o2.frequency.value = noteToFreq(n) * 1.002; // detune
            const f = ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=800;
            const g = ctx.createGain();
            g.gain.setValueAtTime(0, t);
            g.gain.linearRampToValueAtTime(0.08, t+1);
            g.gain.setValueAtTime(0.08, t+dur-1);
            g.gain.linearRampToValueAtTime(0, t+dur);
            // reverb
            const c = ctx.createConvolver(); c.buffer=reverbBuffer;
            const rg = ctx.createGain(); rg.gain.value=0.5;
            o.connect(f); o2.connect(f);
            f.connect(g).connect(masterGain);
            g.connect(rg).connect(c).connect(masterGain);
            o.start(t); o.stop(t+dur+1);
            o2.start(t); o2.stop(t+dur+1);
         });
      }
      function playArp(t, n){
         const o = ctx.createOscillator(); o.type='sine';
         o.frequency.value = noteToFreq(n);
         const g = ctx.createGain();
         g.gain.setValueAtTime(0.15, t);
         g.gain.exponentialRampToValueAtTime(0.001, t+0.3);
         const d = ctx.createDelay(); d.delayTime.value = 0.25; // echo
         const dg = ctx.createGain(); dg.gain.value = 0.4;
         o.connect(g).connect(masterGain);
         g.connect(d).connect(dg).connect(d).connect(masterGain); // feedback loop
         o.start(t); o.stop(t+0.3);
      }

      function schedule(){
         const lookahead = 0.1;
         while(nextNoteTime < ctx.currentTime + lookahead){
             const i = current16thNote % seqLength;
             if(kickPat[i]) playKick(nextNoteTime);
             if(snarePat[i]) playSnare(nextNoteTime);
             if(hatPat[i]) playHihat(nextNoteTime, hatPat[i]); // hatPat[i] is vol
             if(bassLine[i]) playBass(nextNoteTime, bassLine[i]);
             if(padChords[i]) playPad(nextNoteTime, padChords[i]);
             if(arpLine[i]) playArp(nextNoteTime, arpLine[i]);
             
             nextNoteTime += 0.25 * (60.0 / tempo);
             current16thNote++;
         }
         timerID = setTimeout(schedule, 25);
      }

      return {
        play: async()=>{
          try{
            if(!ctx){
               const AC = window.AudioContext||window.webkitAudioContext;
               ctx = new AC();
               masterGain = ctx.createGain();
               masterGain.gain.value = 0.5;
               masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);
               reverbBuffer = createReverb();
               compose();
            }
            if(ctx.state==='suspended') await ctx.resume();
            if(isPlaying) return;
            isPlaying = true;
            current16thNote = 0;
            nextNoteTime = ctx.currentTime + 0.1;
            schedule();
          }catch(e){console.error(e);}
        },
        stop: ()=>{
          isPlaying = false; 
          clearTimeout(timerID);
          if(masterGain){
             try{ masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.2); }catch(e){}
          }
          setTimeout(()=>{ if(ctx){ ctx.close(); ctx=null; } }, 250);
        }
      };
    })();

    /* --- BGM ENGINE (Nobuo Style / Robust Version) --- */
    const AudioEngine = (() => {
      let ctx = null, isPlaying = false, tempo = 148, nextNoteTime = 0, current16thNote = 0;
      let timerID, masterGain = null, reverbBuffer = null;
      const seqLength = 256, bassLine=[], kickPat=[], snarePat=[], hatPat=[], padChords=[], leadLine=[], arpLine=[];

      function compose() {
        bassLine.length=0; kickPat.length=0; snarePat.length=0; hatPat.length=0; padChords.length=0; leadLine.length=0; arpLine.length=0;
        const prog = ['E2','E2','E2','E2', 'E2','C2','D2','E2', 'C2','D2','E2','E2', 'A1','B1','C2','D2'];
        for(let i=0; i<seqLength; i++) {
          const bar = Math.floor(i/16), step = i%16;
          // Drums
          let k=0, s=0, h=0;
          if(step===0||step===10) k=1; if(step===4||step===12) s=1; if(i%2===0) h=1; else if(i%4===3) h=0.6;
          if(step>12 && (bar+1)%4===0) { k=1; s=1; h=0; }
          kickPat.push(k); snarePat.push(s); hatPat.push(h);
          // Bass
          const root = prog[bar%16];
          if(step%4!==1) bassLine.push(root); else bassLine.push(null);
          // Arp
          let arpNotes = ['E3','G3','B3','D4', 'B3','G3'];
          if(root==='C2') arpNotes=['C3','E3','G3','B3','G3','E3'];
          if(root==='D2') arpNotes=['D3','F#3','A3','C#4','A3','F#3'];
          if(root==='A1') arpNotes=['A2','C3','E3','G3','E3','C3'];
          arpLine.push(arpNotes[i%6]);
          // Pad
          if(step===0) {
            if(root==='E2') padChords.push(['E3','G3','B3']); else if(root==='C2') padChords.push(['C3','E3','G3']);
            else if(root==='D2') padChords.push(['D3','F#3','A3']); else if(root==='A1') padChords.push(['A2','C3','E3']);
            else if(root==='B1') padChords.push(['B2','D#3','F#3']); else padChords.push(['E3','G3','B3']);
          } else padChords.push(null);
          // Lead
          let n = null, ls = i%64;
          if(bar%16>=4 && bar%16<8) { if(ls===0)n={n:'E4',d:6}; if(ls===8)n={n:'G4',d:2}; if(ls===10)n={n:'F#4',d:4}; if(ls===16)n={n:'E4',d:12}; if(ls===32)n={n:'D4',d:4}; if(ls===36)n={n:'F#4',d:4}; if(ls===40)n={n:'A4',d:4}; if(ls===48)n={n:'B4',d:12}; }
          else if(bar%16>=8 && bar%16<12) { if(ls===0)n={n:'C5',d:10}; if(ls===12)n={n:'B4',d:4}; if(ls===16)n={n:'A4',d:12}; if(ls===32)n={n:'D5',d:10}; if(ls===44)n={n:'C5',d:4}; if(ls===48)n={n:'B4',d:12}; }
          else if(bar%16>=12) { if(ls===0)n={n:'C5',d:4}; if(ls===4)n={n:'D5',d:4}; if(ls===8)n={n:'E5',d:8}; if(ls===16)n={n:'D5',d:4}; if(ls===20)n={n:'E5',d:4}; if(ls===24)n={n:'F#5',d:8}; if(ls===32)n={n:'G5',d:12}; if(ls===48)n={n:'A5',d:16}; }
          leadLine.push(n);
        }
      }
      const noteToFreq=(n)=>{if(!n)return 0; const ns=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return 440*Math.pow(2,((ns.indexOf(n.slice(0,-1))+(parseInt(n.slice(-1))*12))-57)/12);};
      function createReverb(){const b=ctx.createBuffer(2,2*ctx.sampleRate,ctx.sampleRate); for(let c=0;c<2;c++)for(let i=0;i<b.length;i++)b.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/b.length,4); return b;}
      function playKick(t){const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(masterGain);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(0.01,t+0.5);g.gain.setValueAtTime(1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start(t);o.stop(t+0.5);}
      function playSnare(t){const b=ctx.createBuffer(1,ctx.sampleRate*0.2,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=1000;g.gain.setValueAtTime(0.7,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playHihat(t,v){const b=ctx.createBuffer(1,ctx.sampleRate*0.05,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=ctx.createBufferSource(),f=ctx.createBiquadFilter(),g=ctx.createGain();s.buffer=b;f.type="highpass";f.frequency.value=5000;g.gain.setValueAtTime(v*0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);s.connect(f);f.connect(g);g.connect(masterGain);s.start(t);}
      function playBass(t,n){const o=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain();o.type='sawtooth';o.frequency.value=noteToFreq(n);f.type='lowpass';f.frequency.setValueAtTime(800,t);f.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.6,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.connect(f);f.connect(g);g.connect(masterGain);o.start(t);o.stop(t+0.3);}
      function playLead(t,n){const f=noteToFreq(n.n),d=n.d*0.25*(60/tempo),o=ctx.createOscillator(),g=ctx.createGain(),l=ctx.createOscillator(),lg=ctx.createGain(),dl=ctx.createDelay(),dg=ctx.createGain();o.type='square';o.frequency.value=f;l.frequency.value=5;lg.gain.value=5;l.connect(lg);lg.connect(o.frequency);l.start(t);g.gain.setValueAtTime(0.4,t);g.gain.setValueAtTime(0.4,t+d-0.05);g.gain.linearRampToValueAtTime(0.01,t+d);dl.delayTime.value=0.25;dg.gain.value=0.4;o.connect(g);g.connect(masterGain);g.connect(dl);dl.connect(dg);dg.connect(dl);dg.connect(masterGain);o.start(t);o.stop(t+d+0.5);}
      function playArp(t,n){const o=ctx.createOscillator(),g=ctx.createGain(),p=ctx.createStereoPanner();o.type='triangle';o.frequency.value=noteToFreq(n);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);p.pan.value=(current16thNote%2===0)?-0.3:0.3;o.connect(g);g.connect(p);p.connect(masterGain);o.start(t);o.stop(t+0.2);}
      function playPad(t,ns){const d=16*0.25*(60/tempo);ns.forEach(n=>{const o=ctx.createOscillator(),o2=ctx.createOscillator(),f=ctx.createBiquadFilter(),g=ctx.createGain(),rg=ctx.createGain(),c=ctx.createConvolver();o.type='sawtooth';o.frequency.value=noteToFreq(n);o2.type='sawtooth';o2.frequency.value=noteToFreq(n)*1.002;f.type='lowpass';f.frequency.value=2000;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.5);g.gain.setValueAtTime(0.15,t+d-0.5);g.gain.linearRampToValueAtTime(0.01,t+d);rg.gain.value=0.5;c.buffer=reverbBuffer;o.connect(f);o2.connect(f);f.connect(g);g.connect(masterGain);g.connect(rg);rg.connect(c);c.connect(masterGain);o.start(t);o2.start(t);o.stop(t+d);o2.stop(t+d);});}
      function schedule(){while(nextNoteTime<ctx.currentTime+0.1){const i=current16thNote%seqLength;if(kickPat[i])playKick(nextNoteTime);if(snarePat[i])playSnare(nextNoteTime);if(hatPat[i])playHihat(nextNoteTime,hatPat[i]);if(bassLine[i])playBass(nextNoteTime,bassLine[i]);if(arpLine[i])playArp(nextNoteTime,arpLine[i]);if(leadLine[i])playLead(nextNoteTime,leadLine[i]);if(padChords[i])playPad(nextNoteTime,padChords[i]);nextNoteTime+=0.25*(60.0/tempo);current16thNote++;}timerID=setTimeout(schedule,25);}
      return {
        play: async () => {
          try {
            if(!ctx) {
              const AC = window.AudioContext || window.webkitAudioContext;
              ctx = new AC();
              masterGain = ctx.createGain();
              masterGain.gain.value = 0.6; // Volume Up
              masterGain.connect(ctx.destination); Visualizer.connect(ctx, masterGain);
              reverbBuffer = createReverb();
              compose();
            }
            if(ctx.state === 'suspended') await ctx.resume();
            if(isPlaying) return;
            isPlaying = true;
            current16thNote = 0;
            nextNoteTime = ctx.currentTime + 0.1;
            schedule();
          } catch(e) { console.error('BGM Error:', e); }
        },
        stop: () => {
          isPlaying = false;
          clearTimeout(timerID);
          if(masterGain) masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.1);
          setTimeout(() => { if(ctx){ ctx.close(); ctx=null; } }, 200);
        }
      };
    })();

    /********************
     * UTIL
     ********************/
    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const rnd = (min,max)=>Math.random()*(max-min)+min;
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const fmt = (n, d=0)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const nowIso = ()=>new Date().toISOString();

    function hashStr(s){
      let h=2166136261>>>0;
      for(let i=0;i<s.length;i++){
        h^=s.charCodeAt(i);
        h = Math.imul(h,16777619);
      }
      return h>>>0;
    }
    function seededRand(seed){
      // xorshift32
      let x = seed>>>0;
      return ()=> {
        x ^= x << 13; x >>>= 0;
        x ^= x >> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x>>>0) / 4294967296;
      };
    }

    function toast(msg, kind="info"){
      const el = $("toast");
      const inner = $("toastInner");
      inner.textContent = msg;
      inner.style.borderColor = kind==="bad" ? "rgba(251,113,133,.35)" : kind==="good" ? "rgba(52,211,153,.30)" : "rgba(53,247,255,.22)";
      el.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.add("hidden"), 2100);
    }

    function copyToClipboard(text){
      return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false);
    }

    /********************
     * SECTORS & SKILLS
     ********************/
        const MOTIONS = [
      "m-smash", "m-rush", "m-sonic", "m-snipe", "m-drill",
      "m-jump", "m-zigzag", "m-tackle", "m-uppercut", "m-meteor",
      "m-shadow", "m-giant", "m-helix", "m-impact", "m-wobble",
      "m-charge", "m-boomerang", "m-frenzy", "m-stealth", "m-pulse"
    ];

        const SECTORS = [
      {key:"Tech", label:"Tech / Electronics"},
      {key:"Auto", label:"Automotive"},
      {key:"Finance", label:"Finance"},
      {key:"Retail", label:"Retail"},
      {key:"Telecom", label:"Telecom"},
      {key:"Industrial", label:"Industrial / Manufacturing"},
      {key:"Pharma", label:"Pharma / Healthcare"},
      {key:"Energy", label:"Energy / Utilities"},
    ];

    /* --- NEW: ELEMENT SYSTEM --- */
    const SECTOR_ELEMENTS = {
      Tech: "DIGITAL", Telecom: "DIGITAL", Finance: "DIGITAL",
      Auto: "REAL", Industrial: "REAL", Energy: "REAL",
      Retail: "HUMAN", Pharma: "HUMAN"
    };
    const ELEMENT_ICONS = {
      DIGITAL: {icon:"cpu", color:"text-cyan-400"},
      REAL:    {icon:"factory", color:"text-amber-400"},
      HUMAN:   {icon:"users", color:"text-emerald-400"}
    };
    function getElementMult(atkSec, defSec){
      const a = SECTOR_ELEMENTS[atkSec] || "DIGITAL";
      const d = SECTOR_ELEMENTS[defSec] || "DIGITAL";
      if(a===d) return {mult:1.0, eff:"normal"};
      if(
        (a==="DIGITAL" && d==="REAL") ||
        (a==="REAL" && d==="HUMAN") ||
        (a==="HUMAN" && d==="DIGITAL")
      ) return {mult:1.1, eff:"great"};
      return {mult:0.9, eff:"bad"};
    }

        /* --- MARKET CYCLES --- */
    const MARKET_CYCLES = {
      NORMAL: { name: "NORMAL", desc: "ÈÄöÂ∏∏Áõ∏Â†¥", color: "text-slate-300" },
      BULL:   { name: "BULL",   desc: "Â•ΩÊ≥Å: ÊôØÊ∞óÊïèÊÑüÊ†™(Tech/Auto/Ind/Ene)„ÅåÊ¥ªÊ≥Å (ATK x1.5)", color: "text-emerald-300" },
      BEAR:   { name: "BEAR",   desc: "‰∏çÊ≥Å: ÂÖ®‰Ωì‰ΩéËø∑ (ATK x0.7)„ÄÇ„Éá„Ç£„Éï„Çß„É≥„Ç∑„ÉñÊ†™„ÅØÂ†ÖË™ø", color: "text-rose-300" },
      TIGHT:  { name: "TIGHT",  desc: "Âºï„ÅçÁ∑†„ÇÅ: ÈáëÂà©‰∏äÊòá„ÄÇ‰ΩéËá™Â∑±Ë≥áÊú¨‰ºÅÊ•≠„Å´„ÉÄ„É°„Éº„Ç∏„ÄÇÈäÄË°å(Fin)ÊúâÂà©", color: "text-amber-300" }
    };

    /* „Çπ„Ç≠„É´„ÅÆÂäπÊûú„É≠„Ç∏„ÉÉ„ÇØÂÆöÁæ© (Archetypes) */
    const SKILL_ARCHETYPES = {
      "BURST": { mult: 1.8, pierce: 0.15, fx: "NEON", desc:"È´òÁÅ´Âäõ„ÉªË≤´ÈÄöÊîªÊíÉ" },
      "GUARD": { mult: 1.2, buff:{key:"guard", val:0.6}, fx:"AURA", desc:"ÊîªÊíÉÔºãÂº∑Âäõ„Å™Èò≤Âæ°" },
      "SPEED": { mult: 1.4, buff:{key:"spd_up", val:0.25}, fx:"SPARK", desc:"ÊîªÊíÉÔºãSPDÂ§ßÂπÖ‰∏äÊòá" },
      "DRAIN": { mult: 1.3, drain:0.4, fx:"GLITCH", desc:"HPÂê∏ÂèéÊîªÊíÉ" },
      "DOT":   { mult: 1.3, debuff:{key:"bleed", val:0.04}, fx:"STORM", desc:"ÊîªÊíÉÔºãÁ∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏" },
      "JAM":   { mult: 1.3, debuff:{key:"spd_down", val:-0.25}, fx:"GLITCH", desc:"ÊîªÊíÉÔºãÊïµSPD‰Ωé‰∏ã" },
      "BUFF":  { mult: 1.4, buff:{key:"atk_up", val:0.2}, fx:"WAVE", desc:"ÊîªÊíÉÔºãATK‰∏äÊòá" },
    };

        /* --- NEW: COMBO SKILLS & MARKET EVENTS --- */
    const COMBO_SKILLS = {
      "Industrial_Auto": { name: "Steel Price Shock", desc: "ÈãºÊùê‰æ°Ê†º„ÅÆÂº∑Âà∂ÂÄ§‰∏ä„ÅíÔºàÁâπÂ§ß„ÉÄ„É°ÔºãÊïµDEF‚ÜìÔºâ", mult: 1.9, fx: "IMPACT", debuff: {key:"def_down", val:-0.25} },
      "Tech_Finance": { name: "DeFi Hack", desc: "ÂàÜÊï£ÂûãÈáëËûç„Éè„ÉÉ„ÇØÔºàHPÂê∏ÂèéÔºâ", mult: 1.5, fx: "GLITCH", drain: 0.3 },
      "Energy_Industrial": { name: "Power Crunch", desc: "ÈõªÂäõ‰æõÁµ¶Áµû„ÇäËæº„ÅøÔºàÊïµSPD‚ÜìÔºâ", mult: 1.7, fx: "ARC", debuff: {key:"spd_down", val:-0.3} },
      "Retail_Tech": { name: "Direct-to-Consumer", desc: "‰∏≠Êäú„ÅçÊà¶Áï•Ôºà„Ç≤„Éº„Ç∏ÂõûÂèéÔºâ", mult: 1.5, fx: "WAVE", gauge: 25 },
      "Telecom_Tech": { name: "Infrastructure Tax", desc: "„Ç§„É≥„Éï„É©Âà©Áî®ÊñôÂæ¥ÂèéÔºàÊïµ„Ç≤„Éº„Ç∏Ê≤°ÂèéÔºâ", mult: 1.6, fx: "GLITCH", gaugeEnemy: -25 },
      "Auto_Energy": { name: "EV Shift", desc: "ËÑ±ÁÇ≠Á¥†„Ç∑„Éï„ÉàÔºàÊîªÂã¢„Éê„ÉïÔºâ", mult: 1.6, fx: "SPARK", buff: {key:"atk_up", val:0.25} },
      "Pharma_Finance": { name: "M&A Defense", desc: "Ë≤∑ÂèéÈò≤Ë°õÁ≠ñÔºàÂº∑Âõ∫„Å™ÂÆà„ÇäÔºâ", mult: 1.2, fx: "STORM", buff: {key:"guard", val:0.5} },
      "Finance_Retail": { name: "Credit Crunch", desc: "Ë≤∏„ÅóÊ∏ã„ÇäÔºàÊïµÊîªÊíÉ‚ÜìÔºâ", mult: 1.5, fx: "AURA", debuff: {key:"atk_down", val:-0.2} }
    };

    ¬† ¬† ¬† ¬† const MARKET_EVENTS = [
¬† ¬† ¬† { name: "Bull Market", text: "Â•ΩÊôØÊ∞óÂà∞Êù•ÔºÅÂ∏ÇÂ†¥ÂøÉÁêÜ„ÅåÊîπÂñÑ", type:"good", func:(b)=>{
¬† ¬† ¬† ¬† b.fx(null, "MONEY"); b.fx(null, "FLASH_GREEN");
¬† ¬† ¬† ¬† b.gainSkill(b.P, 20); b.gainSkill(b.C, 20); return "‰∏°Á§æ„ÅÆR&D„Ç≤„Éº„Ç∏Â¢óÂä† (+20)";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Recession", text: "ÊôØÊ∞óÂæåÈÄÄ‚Ä¶ÈúÄË¶ÅÊ∏õÈÄÄ", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† b.fx(null, "CRASH"); b.fx(null, "FLASH_RED");
¬† ¬† ¬† ¬† b.damage(b.P, Math.floor(b.P.maxHP*0.08), {isDot:true}); b.damage(b.C, Math.floor(b.C.maxHP*0.08), {isDot:true}); return "‰∏°Á§æ„Å´„ÉÄ„É°„Éº„Ç∏ (8%)";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Tech Bubble Burst", text: "„ÉÜ„ÉÉ„ÇØ„Éê„Éñ„É´Â¥©Â£ä", type:"bad", func:(b)=>{¬†
¬† ¬† ¬† ¬† ¬† b.fx(null, "GLITCH"); b.fx(null, "CRASH");
¬† ¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Telecom") b.spendSkill(u, 40); });
¬† ¬† ¬† ¬† ¬† return "Tech/Telecom‰ºÅÊ•≠„ÅÆ„Ç≤„Éº„Ç∏Ê∏õÂ∞ë (-40)";¬†
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Supply Chain Crisis", text: "„Çµ„Éó„É©„Ç§„ÉÅ„Çß„Éº„É≥Ê∑∑‰π±", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† ¬† b.fx(null, "QUAKE");
¬† ¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{ if(u.company.sector==="Auto"||u.company.sector==="Industrial"||u.company.sector==="Retail") b.addBuff(u, {key:"spd_down", name:"CRISIS", turns:2, meta:{spd:-0.3}}); });
¬† ¬† ¬† ¬† ¬† return "Auto/Ind/Retail„ÅÆSPDÂ§ßÂπÖ‰Ωé‰∏ã";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Geopolitical Tension", text: "Âú∞ÊîøÂ≠¶„É™„Çπ„ÇØÂ¢óÂ§ß", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† ¬† b.fx(null, "QUAKE"); b.fx(null, "FLASH_RED");
¬† ¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{ if(u.company.sector==="Energy"||u.company.sector==="Finance") b.addBuff(u, {key:"def_up", name:"HEDGE", turns:3, meta:{def:0.3}}); });
¬† ¬† ¬† ¬† ¬† return "Energy/Finance„ÅåÈò≤Âæ°ÊÖãÂã¢ (DEF‚Üë)";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "AI Innovation Wave", text: "AI„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥„ÅÆÊ≥¢", type:"good", func:(b)=>{
¬† ¬† ¬† ¬† ¬† b.fx(null, "NEON"); b.fx(null, "FLASH_NEON");
¬† ¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Pharma") b.addBuff(u, {key:"crit_up", name:"AI", turns:3, meta:{crit:0.25}}); });
¬† ¬† ¬† ¬† ¬† return "Tech/Pharma„ÅÆ„ÇØ„É™Áéá‰∏äÊòá";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Subcontract Act Inspection", text: "‰∏≠Â∞è‰ºÅÊ•≠Â∫Å„Åå‰∏ãË´ãÊ≥ïÊ§úÊüª„ÇíÂÆüÊñΩÔºÅ", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† b.fx(null, "GLITCH"); b.fx(null, "FLASH_RED");
¬† ¬† ¬† ¬† let msg = "";
¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{
¬† ¬† ¬† ¬† ¬† if(["Auto","Industrial","Retail","Tech","Telecom"].includes(u.company.sector)){
¬† ¬† ¬† ¬† ¬† ¬† if(Math.random() < 0.4){
¬† ¬† ¬† ¬† ¬† ¬† ¬† b.addBuff(u, {key:"stun", name:"STOP", turns:1, meta:{}});
¬† ¬† ¬† ¬† ¬† ¬† ¬† msg += `${b.nameOf(u)}„ÅØÂñ∂Ê•≠ÂÅúÊ≠¢Âá¶ÂàÜ(1„Çø„Éº„É≥)ÔºÅ `;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return msg || "ÊåáÊëò‰∫ãÈ†Ö„Å™„Åó„ÄÇ";
¬† ¬† ¬† }},
¬† ¬† ¬† { name: "Tariff War", text: "„Éà„É©„É≥„ÉóÂ§ßÁµ±È†ò„ÅåÊÄí„Çä„Å´„Åæ„Åã„Åõ„Å¶È´òÈñ¢Á®é„ÇíÁô∫ÂãïÔºÅ", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† b.fx(null, "CRASH"); b.fx(null, "QUAKE");
¬† ¬† ¬† ¬† let msg = "";
¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{
¬† ¬† ¬† ¬† ¬† if(["Auto","Industrial","Tech"].includes(u.company.sector)){
¬† ¬† ¬† ¬† ¬† ¬† if(Math.random() < 0.3){
¬† ¬† ¬† ¬† ¬† ¬† ¬† msg += `${b.nameOf(u)}„ÅØTACO(Tuesday Taco?)„ÅßÂõûÈÅøÔºÅ `;
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† const dmg = Math.floor(u.maxHP * 0.12);
¬† ¬† ¬† ¬† ¬† ¬† ¬† b.damage(u, dmg, {fx:"IMPACT"});
¬† ¬† ¬† ¬† ¬† ¬† ¬† msg += `${b.nameOf(u)}„Å´Èñ¢Á®é„ÉÄ„É°„Éº„Ç∏(-${dmg}) `;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return msg || "ÂΩ±Èüø„Å™„Åó„ÄÇ";
¬† ¬† ¬† }},
¬† ¬† ¬†       { name: "Embezzlement Scandal", text: "Â∑®È°çÊ®™È†ò‰∫ã‰ª∂„ÅåÁô∫ÁîüÔºÅ", type:"bad", func:(b)=>{
        b.fx(null, "FLASH_RED"); b.fx(null, "STORM");
        let msg = "";
        [b.P, b.C].forEach(u=>{
          // FinanceÁ¢∫Áéá: 50% -> 20%
          let chance = u.company.sector==="Finance" ? 0.2 : 0.1;
          // Èò≤Âæ°(Guard)‰∏≠„ÅØÂÜÖÈÉ®Áµ±Âà∂Âº∑Âåñ„Å®„Åø„Å™„ÅóÁ¢∫ÁéáÂçäÊ∏õ
          if(u.buffs.some(x=>x.key==="guard")) chance *= 0.5;

          if(Math.random() < chance){
            const dmg = Math.floor(u.maxHP * 0.15);
            b.damage(u, dmg, {isDot:true});
            b.addBuff(u, {key:"def_down", name:"SCANDAL", turns:3, meta:{def:-0.25}});
            msg += `${b.nameOf(u)}„Åß‰∏çÁ••‰∫ãÁô∫Ë¶öÔºÅ‰ø°Áî®Â§±Â¢ú(-${dmg}, DEF‚Üì) `;
          }
        });
        return msg || "ÂÜÖÈÉ®Áµ±Âà∂„ÅØÊ©üËÉΩ„Åó„Å¶„ÅÑ„Çã„ÄÇ";
      }},
¬† ¬† ¬† { name: "China Shock", text: "‰∏≠ÂõΩÂ∏ÇÂ†¥„Åã„Çâ„ÅÆ‰ΩôÂâ∞Êùê„ÅåÊµÅÂÖ•ÔºÅ", type:"bad", func:(b)=>{
¬† ¬† ¬† ¬† b.fx(null, "WAVE"); b.fx(null, "QUAKE");
¬† ¬† ¬† ¬† let msg = "";
¬† ¬† ¬† ¬† [b.P, b.C].forEach(u=>{
¬† ¬† ¬† ¬† ¬† if(["Industrial","Auto","Tech"].includes(u.company.sector)){
¬† ¬† ¬† ¬† ¬† ¬† b.addBuff(u, {key:"atk_down", name:"DUMPING", turns:3, meta:{atk:-0.2}});
¬† ¬† ¬† ¬† ¬† ¬† const dmg = Math.floor(u.maxHP * 0.05);
¬† ¬† ¬† ¬† ¬† ¬† b.damage(u, dmg);
¬† ¬† ¬† ¬† ¬† ¬† msg += `${b.nameOf(u)}„ÅØ‰æ°Ê†ºÁ´∂‰∫â„Å´Â∑ª„ÅçËæº„Åæ„Çå„Åü(-${dmg}, ATK‚Üì) `;
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† return msg || "Â∏ÇÂ†¥„Å∏„ÅÆÂΩ±Èüø„ÅØËªΩÂæÆ„ÄÇ";
¬† ¬† ¬† }}
¬† ¬† ];
    /* --- RISK CALCULATOR --- */
    function calcSummonRisk(attacker, defender){
      // Â§ß‰ºÅÊ•≠Êú™Ê∫Ä„ÅØ„É™„Çπ„ÇØ„Å™„Åó
      if((attacker.company.capital||0) < 3.0) return 0;
      
      // 1. Ê†ºÂ∑ÆÂÄçÁéá (Ratio)
      const mcapA = attacker.company.market_cap || 1;
      const mcapD = defender.company.market_cap || 1;
      const ratio = mcapA / mcapD;
      
      let base = 0;
      if(ratio >= 1.5) base = (ratio - 1.5) * 20;
      base = Math.min(60, base);

      // 2. Âà§ÂÆòË¥îÂ±ì (Sympathy) - ÊïµHP„Åå‰Ωé„ÅÑ„Åª„Å©„É™„Çπ„ÇØÂ¢ó
            const hpRate = defender.hp / defender.maxHP;
      const sympathy = (1.0 - hpRate) * 30;

      let totalRisk = (base + sympathy) * 0.5;

      // ÊñáÊò•Á†≤„Éá„Éê„Éï„Åå„ÅÇ„Çå„Å∞„É™„Çπ„ÇØ+20%Âä†ÁÆó
      if(attacker.buffs.some(b=>b.key==="bunshun_target")){
        totalRisk += 20; 
      }

      return Math.floor(clamp(totalRisk, 0, 95));
    }

        /* --- VISUAL HELPER --- */
    function showSummonVisual(side, emoji, opts={}){
      const parent = side==="P" ? $("spritePlayer") : $("spriteCPU");
      const el = document.createElement("div");
      
      if(opts.customClass){
        el.className = opts.customClass;
        // ÊñπÂêëÂà∂Âæ°
        const startX = side==="P" ? "-150%" : "150%";
        const dir = side==="P" ? "1" : "-1";
        el.style.setProperty("--startX", startX);
        el.style.setProperty("--dir", dir);
        // ‰ΩçÁΩÆ
        if(side==="P") el.style.right = "-20px";
        else el.style.left = "-20px";
      } else {
        el.className = "summon-emoji";
        // ÈÖçÁΩÆË™øÊï¥
        if(side==="P"){
           el.style.right = opts.isCounter ? "110%" : "-50%";
           if(opts.isCounter) el.style.transform = "scaleX(-1)"; 
        } else {
           el.style.left = opts.isCounter ? "110%" : "-50%";
           if(!opts.isCounter) el.style.transform = "scaleX(-1)";
        }
      }

      if(opts.html){
        el.innerHTML = opts.html;
      } else {
        el.textContent = emoji;
      }
      parent.appendChild(el);
      return el;
    }

    /* --- SECTOR_SKILLS --- */
    const SECTOR_SKILLS = {
      Tech: {
        name: "Quantum Launch",
        desc: "AI/Êñ∞Ë£ΩÂìÅ„ÅßÂ∏ÇÂ†¥„ÇíÁÑº„ÅçÂ∞Ω„Åè„ÅôÔºàÂ§ß„ÉÄ„É°„Éº„Ç∏Ôºã„ÇØ„É™ÁéáUPÔºâ",
        fx: "NEON",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"crit_up", name:"CRIT‚Üë", turns:2, meta:{crit:0.14}});
          return {mult: 1.75, pierce: 0.10};
        }
      },
      Auto: {
        name: "Supply Chain Blitz",
        desc: "‰æõÁµ¶Á∂≤ÊúÄÈÅ©ÂåñÔºà‰∏≠„ÉÄ„É°„Éº„Ç∏ÔºãËá™Â∑±ÂõûÂæ©Ôºâ",
        fx: "SPARK",
        apply: (ctx)=> {
          const heal = Math.floor(ctx.user.maxHP * 0.08);
          ctx.heal(ctx.user, heal, "SC BLITZ");
          return {mult: 1.45, pierce: 0.05};
        }
      },
      Finance: {
        name: "Capital Shield",
        desc: "Ë≥áÊú¨ÊîøÁ≠ñÔºàÂ∞è„ÉÄ„É°„Éº„Ç∏ÔºãÂº∑GuardÔºâ",
        fx: "AURA",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"guard", name:"GUARD+", turns:2, meta:{dr:0.55, def:0.18}});
          return {mult: 1.10, pierce: 0.00};
        }
      },
      Retail: {
        name: "Brand Surge",
        desc: "„Éñ„É©„É≥„ÉâÊóãÈ¢®Ôºà‰∏≠„ÉÄ„É°„Éº„Ç∏ÔºãSPD‰∏äÊòáÔºâ",
        fx: "WAVE",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"spd_up", name:"SPD‚Üë", turns:3, meta:{spd:0.18}});
          return {mult: 1.35, pierce: 0.02};
        }
      },
      Telecom: {
        name: "Network Jam",
        desc: "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂ¶®ÂÆ≥Ôºà‰∏≠„ÉÄ„É°„Éº„Ç∏ÔºãÊïµSPD‰Ωé‰∏ãÔºâ",
        fx: "GLITCH",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"spd_down", name:"SPD‚Üì", turns:2, meta:{spd:-0.20}});
          return {mult: 1.30, pierce: 0.06};
        }
      },
      Industrial: {
        name: "Lean Strike",
        desc: "ÊîπÂñÑÊ¥ªÂãïÔºà‰∏≠„ÉÄ„É°„Éº„Ç∏ÔºãDEF‰∏äÊòáÔºâ",
        fx: "IMPACT",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"def_up", name:"DEF‚Üë", turns:3, meta:{def:0.20}});
          return {mult: 1.30, pierce: 0.04};
        }
      },
      Pharma: {
        name: "Patent Storm",
        desc: "ÁâπË®±„Éª„Éë„Ç§„Éó„É©„Ç§„É≥ÔºàÂ§ß„ÉÄ„É°„Éº„Ç∏ÔºãÁ∂ôÁ∂öÂúßÂäõÔºâ",
        fx: "STORM",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"bleed", name:"PIPELINE", turns:3, meta:{dot:0.035}});
          return {mult: 1.60, pierce: 0.08};
        }
      },
      Energy: {
        name: "Grid Overload",
        desc: "„Ç§„É≥„Éï„É©Âº∑Âà∂Ôºà‰∏≠„ÉÄ„É°„Éº„Ç∏ÔºãÊïµDEF‰Ωé‰∏ãÔºâ",
        fx: "ARC",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"def_down", name:"DEF‚Üì", turns:2, meta:{def:-0.18}});
          return {mult: 1.35, pierce: 0.06};
        }
      }
    };

    /********************
     * SAMPLE DATA (approx; billion JPY)
     * cash / market_cap / rnd are in "billion JPY"
     ********************/
const SAMPLE_COMPANIES = [
      /* --- US: BIG TECH (GAFAM) --- */
      {
        id: "us-apple", capital: 1000, description: "„Éá„Ç∂„Ç§„É≥„Å®„Ç®„Ç≥„Ç∑„Çπ„ÉÜ„É†„Åß‰∏ñÁïå„ÇíÈ≠Ö‰∫Ü„Åô„Çã„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅÆÂ∑®‰∫∫„ÄÇ",
        name: "Apple", name_jp: "Apple", domain: "apple.com", sector: "Tech", currency: "JPY",
        cash: 24000, operating_margin: 30.0, equity_ratio: 45.0, market_cap: 510000, employees: 160000, rnd: 4500,
        skill_name: "Reality Distortion", skill_desc: "ÂúßÂÄíÁöÑ„Éñ„É©„É≥„ÉâÂäõ„ÅßÂ∏ÇÂ†¥„ÅÆÂ∏∏Ë≠ò„ÇíÊ≠™„ÇÅ„Çã", skill_type: "BURST",
        attacks: [{name:"iPhone Launch", desc:"‰∏ñÁïåÁöÑÁÜ±ÁãÇ"}, {name:"App Store Tax", desc:"30%„ÅÆÊâãÊï∞ÊñôÂæ¥Âèé"}, {name:"Vision Pro", desc:"Á©∫Èñì„Ç≥„É≥„Éî„É•„Éº„Çø"}]
      },
      {
        id: "us-microsoft", capital: 1000, description: "Windows„Å®Azure„ÄÅAI„Åß‰∏ñÁïå„ÅÆÁîüÁî£ÊÄß„ÇíÊîØ„Åà„ÇãÁéãËÄÖ„ÄÇ",
        name: "Microsoft", name_jp: "Microsoft", domain: "microsoft.com", sector: "Tech", currency: "JPY",
        cash: 16500, operating_margin: 42.0, equity_ratio: 50.0, market_cap: 465000, employees: 220000, rnd: 4050,
        skill_name: "Copilot Core", skill_desc: "ÂÖ®Ë£ΩÂìÅ„Å∏„ÅÆAIÁµ±Âêà„Å´„Çà„ÇãÁîüÁî£ÊÄßÊîØÈÖç", skill_type: "BUFF",
        attacks: [{name:"Azure Cloud", desc:"„ÇØ„É©„Ç¶„ÉâÂü∫Áõ§"}, {name:"Office 365", desc:"„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥"}, {name:"Game Pass", desc:"„Ç≤„Éº„É†„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†"}]
      },
      {
        id: "us-google", capital: 1000, description: "Ê§úÁ¥¢„Ç®„É≥„Ç∏„É≥„Å®Â∫ÉÂëä„ÄÅAIÊäÄË°ì„ÅßÊÉÖÂ†±„ÇíÊîØÈÖç„Åô„Çã„ÄÇ",
        name: "Alphabet (Google)", name_jp: "Google", domain: "google.com", sector: "Tech", currency: "JPY",
        cash: 16500, operating_margin: 28.0, equity_ratio: 60.0, market_cap: 330000, employees: 180000, rnd: 6750,
        skill_name: "Search Monopoly", skill_desc: "‰∏ñÁïå‰∏≠„ÅÆÊÉÖÂ†±„ÇíÊï¥ÁêÜ„Åó„ÄÅÂ∫ÉÂëäÂèéÁõä„ÇíÁã¨Âç†", skill_type: "JAM",
        attacks: [{name:"PageRank", desc:"Ê§úÁ¥¢„Ç¢„É´„Ç¥„É™„Ç∫„É†"}, {name:"YouTube Ads", desc:"ÂãïÁîªÂ∫ÉÂëä"}, {name:"DeepMind", desc:"ÊúÄÂº∑„ÅÆAIÁ†îÁ©∂"}]
      },
      {
        id: "us-amazon", capital: 1000, description: "EC„Å®„ÇØ„É©„Ç¶„Éâ(AWS)„Åß‰∏ñÁïå„ÇíË¶Ü„ÅÜÂ∑®Â§ß„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„Éû„Éº„ÄÇ",
        name: "Amazon", name_jp: "Amazon", domain: "amazon.com", sector: "Retail", currency: "JPY",
        cash: 12750, operating_margin: 8.0, equity_ratio: 25.0, market_cap: 300000, employees: 1500000, rnd: 12750,
        skill_name: "Prime Ecosystem", skill_desc: "Áâ©ÊµÅ„Å®„ÇØ„É©„Ç¶„Éâ„ÅÆÊúÄÂº∑„Éï„É©„Ç§„Éõ„Ç§„Éº„É´", skill_type: "SPEED",
        attacks: [{name:"AWS", desc:"„ÇØ„É©„Ç¶„Éâ„ÅÆÁ®º„ÅéÈ†≠"}, {name:"One Click", desc:"Á©∂Ê•µ„ÅÆË≥ºË≤∑‰ΩìÈ®ì"}, {name:"Logistics", desc:"Ëá™Á§æÁâ©ÊµÅÁ∂≤"}]
      },
      {
        id: "us-meta", capital: 1000, description: "SNS„Å®„É°„Çø„Éê„Éº„Çπ„Åß‰∏ñÁïå‰∏≠„ÅÆ‰∫∫„ÄÖ„Çí„Å§„Å™„Åê„ÄÇ",
        name: "Meta", name_jp: "Meta", domain: "meta.com", sector: "Tech", currency: "JPY",
        cash: 9750, operating_margin: 35.0, equity_ratio: 55.0, market_cap: 180000, employees: 70000, rnd: 5700,
        skill_name: "Social Graph", skill_desc: "30ÂÑÑ‰∫∫„ÅÆ„Å§„Å™„Åå„Çä„ÇíÊîØÈÖç„Åô„Çã„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂäπÊûú", skill_type: "DRAIN",
        attacks: [{name:"Target Ads", desc:"Á≤æÂØÜ„Çø„Éº„Ç≤„ÉÜ„Ç£„É≥„Ç∞"}, {name:"Instagram", desc:"Ë¶ñË¶öÁöÑ„Éâ„Éº„Éë„Éü„É≥"}, {name:"Metaverse", desc:"Ê¨°‰∏ñ‰ª£„Å∏„ÅÆÊäïË≥á"}]
      },
      /* --- JAPANESE COMPANIES --- */
      {
        id:"jp-toyota", capital: 635, description: "„Ç´„Ç§„Çº„É≥„Å®„Éè„Ç§„Éñ„É™„ÉÉ„ÉâÊäÄË°ì„Åß‰∏ñÁïå„ÇíËµ∞„ÇãËá™ÂãïËªä„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Toyota Motor", name_jp:"„Éà„É®„ÇøËá™ÂãïËªä", domain:"toyota.co.jp", sector:"Auto", currency:"JPY",
        cash: 8500, operating_margin: 10.0, equity_ratio: 40.0, market_cap: 45000, employees: 375000, rnd: 1200,
        skill_name: "KAIZEN Flow", skill_desc: "„ÄéÊîπÂñÑ„Äè„ÅÆÈÄ£Èéñ„Å´„Çà„ÇãÁ•ûÈÄü„ÅÆ‰æõÁµ¶Á∂≤", skill_type: "SPEED",
        attacks: [
          {name:"Just-in-Time", desc:"Âú®Â∫´„Çº„É≠„ÅÆË∂ÖÂäπÁéá‰æõÁµ¶"},
          {name:"Hybrid Drive", desc:"ÂÖ®Êñπ‰ΩçÊà¶Áï•„ÅÆ„Ç∑„Éä„Ç∏„Éº"},
          {name:"Andon Cord", desc:"ÂìÅË≥™Áï∞Â∏∏„ÇíÂç≥Â∫ß„Å´Ê§úÁü•"}
        ]
      },
      {
        id:"jp-sony", capital: 880, description: "„Ç®„É¨„Ç≠„ÄÅ„Ç®„É≥„Çø„É°„ÄÅÈáëËûç„ÇíËûçÂêà„Åó„Åü„Ç≥„É≥„Ç∞„É≠„Éû„É™„ÉÉ„Éà„ÄÇ",
        name:"Sony Group", name_jp:"„ÇΩ„Éã„Éº„Ç∞„É´„Éº„Éó", domain:"sony.com", sector:"Tech", currency:"JPY",
        cash: 3200, operating_margin: 12.0, equity_ratio: 35.0, market_cap: 18000, employees: 110000, rnd: 900,
        skill_name: "Kando Resonance", skill_desc: "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Å®ÊÑüÂãï„ÅÆËûçÂêà„ÅßÂ∏ÇÂ†¥„ÇíÂ∏≠Â∑ª", skill_type: "BURST",
        attacks: [
          {name:"CMOS Sensor", desc:"‰∏ñÁïåNo.1„Ç∑„Çß„Ç¢„ÅÆÁúº"},
          {name:"Content IP", desc:"„Ç≤„Éº„É†„Éª„Ç¢„Éã„É°„ÉªÈü≥Ê•Ω„ÅÆË§áÂêàÂäõ"},
          {name:"Hardware Design", desc:"Ê¥óÁ∑¥„Åï„Çå„Åü„Éó„É≠„ÉÄ„ÇØ„Éà"}
        ]
      },
      {
        id:"jp-keyence", capital: 30, description: "Ë∂ÖÈ´òÂèéÁõä„Å®Áõ¥Ë≤©‰ΩìÂà∂„ÇíË™á„Çã„Éï„Ç°„ÇØ„Éà„É™„Éº„Ç™„Éº„Éà„É°„Éº„Ç∑„Éß„É≥„ÅÆÈõÑ„ÄÇ",
        name:"KEYENCE", name_jp:"„Ç≠„Éº„Ç®„É≥„Çπ", domain:"keyence.co.jp", sector:"Industrial", currency:"JPY",
        cash: 2400, operating_margin: 52.0, equity_ratio: 88.0, market_cap: 17000, employees: 9000, rnd: 120,
        skill_name: "Super High Margin", skill_desc: "ÂúßÂÄíÁöÑ‰ªòÂä†‰æ°ÂÄ§„ÅßÂà©Áõä„ÇíÂê∏„ÅÑ‰∏ä„Åí„Çã", skill_type: "DRAIN",
        attacks: [
          {name:"Direct Sales", desc:"‰ª£ÁêÜÂ∫ó„ÇíÈÄö„Åï„Å™„ÅÑÁõ¥Ë≤©‰ΩìÂà∂"},
          {name:"Consultative", desc:"ÊΩúÂú®„Éã„Éº„Ç∫„ÇíÊéò„ÇäËµ∑„Åì„ÅôÊèêÊ°à"},
          {name:"Same Day Ship", desc:"Âç≥Á¥ç‰ΩìÂà∂„Å´„Çà„ÇãÊ©ü‰ºöÊêçÂ§±„Çº„É≠"}
        ]
      },
      {
        id:"jp-fastretailing", capital: 10, description: "„É¶„Éã„ÇØ„É≠„ÇíÂ±ïÈñã„Åó„ÄÅLifeWear„Çí‰∏ñÁïå„Å´Â±ä„Åë„Çã„ÄÇ",
        name:"Fast Retailing", name_jp:"„Éï„Ç°„Éº„Çπ„Éà„É™„ÉÜ„Ç§„É™„É≥„Ç∞", domain:"fastretailing.com", sector:"Retail", currency:"JPY",
        cash: 1100, operating_margin: 16.0, equity_ratio: 55.0, market_cap: 12000, employees: 60000, rnd: 80,
        skill_name: "LifeWear Platform", skill_desc: "„ÅÇ„Çâ„ÇÜ„ÇãÁîüÊ¥ª„Å´Êµ∏ÈÄè„Åô„Çã„Ç§„É≥„Éï„É©Âåñ", skill_type: "BUFF",
        attacks: [
          {name:"SPA Model", desc:"‰ºÅÁîª„Åã„ÇâË≤©Â£≤„Åæ„Åß‰∏ÄÊ∞óÈÄöË≤´"},
          {name:"Global Flagship", desc:"‰∏ñÁïå‰∏ªË¶ÅÈÉΩÂ∏Ç„Å∏„ÅÆÂá∫Â∫óÊîªÂã¢"},
          {name:"Functional Fabric", desc:"„Éí„Éº„Éà„ÉÜ„ÉÉ„ÇØÁ≠â„ÅÆÁ¥†ÊùêÈù©Êñ∞"}
        ]
      },
      {
        id:"jp-softbank", capital: 238, description: "AIÁæ§Êà¶Áï•„ÅßÊú™Êù•„Å´ÊäïË≥á„Åô„ÇãÊäïË≥á‰ºöÁ§æ„ÄÇ",
        name:"SoftBank Group", name_jp:"„ÇΩ„Éï„Éà„Éê„É≥„ÇØ„Ç∞„É´„Éº„Éó", domain:"softbank.jp", sector:"Telecom", currency:"JPY",
        cash: 4200, operating_margin: 9.0, equity_ratio: 24.0, market_cap: 9000, employees: 65000, rnd: 300,
        skill_name: "Unicorn Bet", skill_desc: "Áæ§ÈõÜÂøÉÁêÜ„ÇíÊìç„Çã„Éè„Ç§„É™„Çπ„ÇØÊäïË≥á", skill_type: "BURST",
        attacks: [
          {name:"Vision Fund", desc:"Â∑®È°çË≥áÊú¨„Å´„Çà„ÇãÂ∏ÇÂ†¥„É¨„Éê„É¨„ÉÉ„Ç∏"},
          {name:"Arm Chip", desc:"ÂçäÂ∞é‰ΩìË®≠Ë®à„ÅÆÁã¨Âç†ÁöÑÂú∞‰Ωç"},
          {name:"Debt Leverage", desc:"ÂÄüÂÖ•„ÇíÊúÄÂ§ßÊ¥ªÁî®„Åó„ÅüÊã°Â§ß"}
        ]
      },
      {
        id:"jp-recruit", capital: 40, description: "„É™„Éú„É≥„É¢„Éá„É´„Åß‰∫∫„Å®ÊÉÖÂ†±„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíÂâµÈÄ†„Åô„Çã„ÄÇ",
        name:"Recruit Holdings", name_jp:"„É™„ÇØ„É´„Éº„Éà„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ", domain:"recruit.co.jp", sector:"Tech", currency:"JPY",
        cash: 1400, operating_margin: 18.0, equity_ratio: 50.0, market_cap: 10000, employees: 51000, rnd: 250,
        skill_name: "Ribbon Matching", skill_desc: "„É™„Éú„É≥„É¢„Éá„É´„ÅßÂ∏ÇÂ†¥„ÅÆËá™Áî±Â∫¶„ÇíÊîØÈÖç", skill_type: "JAM",
        attacks: [
          {name:"Ribbon Model", desc:"„É¶„Éº„Ç∂„Éº„Å®„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂõ≤„ÅÑËæº„Åø"},
          {name:"Global HR", desc:"IndeedÁ≠â„Å´„Çà„Çã‰∏ñÁïåÁöÑÊ±Ç‰∫∫Á∂≤"},
          {name:"Entrepreneurship", desc:"Á§æÂÜÖËµ∑Ê•≠ÂÆ∂„Å´„Çà„ÇãÊñ∞Ë¶è‰∫ãÊ•≠"}
        ]
      },
      {
        id:"jp-ntt", capital: 938, description: "IOWNÊßãÊÉ≥„ÅßÊ¨°‰∏ñ‰ª£ÈÄö‰ø°Âü∫Áõ§„ÇíÁØâ„ÅèÈÄö‰ø°„ÅÆÂ∑®‰∫∫„ÄÇ",
        name:"NTT", name_jp:"Êó•Êú¨Èõª‰ø°ÈõªË©±ÔºàNTTÔºâ", domain:"ntt.co.jp", sector:"Telecom", currency:"JPY",
        cash: 1700, operating_margin: 16.0, equity_ratio: 28.0, market_cap: 14000, employees: 320000, rnd: 500,
        skill_name: "Optical Shield", skill_desc: "ÂÖâÊßãÊÉ≥(IOWN)„Å´„Çà„ÇãÈâÑÂ£Å„ÅÆÈÄö‰ø°Ë¶ÅÂ°û", skill_type: "GUARD",
        attacks: [
          {name:"IOWN Concept", desc:"Ê¨°‰∏ñ‰ª£ÂÖâÈÄö‰ø°Âü∫Áõ§"},
          {name:"Real Estate", desc:"ËÜ®Â§ß„Å™‰øùÊúâ‰∏çÂãïÁî£„ÅÆÊ¥ªÁî®"},
          {name:"Stable Dividend", desc:"ÂÆâÂÆöÈÖçÂΩì„Å´„Çà„ÇãÊ†™‰∏ªÊ±ÇÂøÉÂäõ"}
        ]
      },
      {
        id:"jp-mufg", capital: 2141, description: "ÂõΩÂÜÖÊúÄÂ§ßÁ¥ö„ÅÆÈ°ßÂÆ¢Âü∫Áõ§„Å®„Ç∞„É≠„Éº„Éê„É´Â±ïÈñã„ÇíÊåÅ„Å§„É°„Ç¨„Éê„É≥„ÇØ„ÄÇ",
        name:"MUFG", name_jp:"‰∏âËè±UFJ„Éï„Ç£„Éä„É≥„Ç∑„É£„É´„Éª„Ç∞„É´„Éº„Éó", domain:"mufg.jp", sector:"Finance", currency:"JPY",
        cash: 6000, operating_margin: 6.0, equity_ratio: 6.0, market_cap: 16000, employees: 160000, rnd: 90,
        skill_name: "Red Bank Vault", skill_desc: "Áõ§Áü≥„Å™Ë≥áÊú¨Âü∫Áõ§„Å´„Çà„ÇãÂÆåÂÖ®Èò≤Âæ°", skill_type: "GUARD",
        attacks: [
          {name:"Global Network", desc:"Êµ∑Â§ñÈäÄË°åË≤∑Âèé„Å´„Çà„ÇãÂ§öËßíÂåñ"},
          {name:"Main Bank", desc:"ÂúßÂÄíÁöÑ„Å™Ê≥ï‰∫∫È°ßÂÆ¢Âü∫Áõ§"},
          {name:"Cross-Selling", desc:"„Ç∞„É´„Éº„ÉóÁ∑èÂêàÂäõ„Å´„Çà„ÇãÊèêÊ°à"}
        ]
      },
      {
        id:"jp-hitachi", capital: 461, description: "IT„Å®Á§æ‰ºö„Ç§„É≥„Éï„É©„ÅÆËûçÂêà(Lumada)„ÅßDX„ÇíÊé®ÈÄ≤„ÄÇ",
        name:"Hitachi", name_jp:"Êó•Á´ãË£Ω‰ΩúÊâÄ", domain:"hitachi.com", sector:"Industrial", currency:"JPY",
        cash: 1500, operating_margin: 9.5, equity_ratio: 32.0, market_cap: 12000, employees: 320000, rnd: 450,
        skill_name: "Lumada Grid", skill_desc: "Á§æ‰ºö„Ç§„É≥„Éï„É©DX„Åß„Åò„Çè„Åò„Çè‰æµÈ£ü", skill_type: "DOT",
        attacks: [
          {name:"Lumada", desc:"È°ßÂÆ¢„Éá„Éº„Çø„Çí‰æ°ÂÄ§„Å´Â§â„Åà„ÇãDX"},
          {name:"Portfolio Shuffle", desc:"‰∫ãÊ•≠„ÅÆÈÅ∏Êäû„Å®ÈõÜ‰∏≠"},
          {name:"Green Energy", desc:"ÈÄÅÈõª„ÉªÈâÑÈÅì„Å™„Å©„ÅÆÁí∞Â¢É„Ç§„É≥„Éï„É©"}
        ]
      },
      {
        id:"jp-takeda", capital: 1668, description: "„Ç∞„É≠„Éº„Éê„É´„Å™Êñ∞Ëñ¨ÈñãÁô∫Âäõ„ÇíÊåÅ„Å§ÂõΩÂÜÖË£ΩËñ¨„Éà„ÉÉ„Éó„ÄÇ",
        name:"Takeda", name_jp:"Ê≠¶Áî∞Ëñ¨ÂìÅÂ∑•Ê•≠", domain:"takeda.com", sector:"Pharma", currency:"JPY",
        cash: 900, operating_margin: 14.0, equity_ratio: 28.0, market_cap: 6000, employees: 50000, rnd: 480,
        skill_name: "Shonan Pipeline", skill_desc: "ÂâµËñ¨„Ç§„Éé„Éô„Éº„Ç∑„Éß„É≥„ÅßÊ¥ªÂäõ„ÇíÂê∏Âèé", skill_type: "DRAIN",
        attacks: [
          {name:"Mega M&A", desc:"Â∑®È°çË≤∑Âèé„Å´„Çà„Çã„Éë„Ç§„Éó„É©„Ç§„É≥Áç≤Âæó"},
          {name:"Rare Disease", desc:"Â∏åÂ∞ëÁñæÊÇ£È†òÂüü„Å∏„ÅÆÈõÜ‰∏≠"},
          {name:"Global Trials", desc:"‰∏ñÁïåË¶èÊ®°„ÅÆÊ≤ªÈ®ì„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ"}
        ]
      },
      /* --- ËøΩÂä†: ÈâÑÈãº (Steel / Industrial) --- */
      {
        id:"jp-nipponsteel", capital: 419, description: "ÊäÄË°ìÂäõ„Åß‰∏ñÁïå„Å®Êà¶„ÅÜ„ÄÅÊó•Êú¨ÊúÄÂ§ß„ÅÆÈâÑÈãº„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Nippon Steel", name_jp:"Êó•Êú¨Ë£ΩÈâÑ", domain:"nipponsteel.com", sector:"Industrial", currency:"JPY",
        cash: 900, operating_margin: 10.5, equity_ratio: 45.0, market_cap: 3500, employees: 100000, rnd: 100,
        skill_name: "Blast Furnace", skill_desc: "È´òÁÇâ„ÅÆÂúßÂÄíÁöÑÁÜ±Èáè„ÅßÂÖ®„Å¶„ÇíÊ∫∂„Åã„Åô", skill_type: "BURST",
        attacks: [{name:"Green Steel", desc:"ËÑ±ÁÇ≠Á¥†ÈãºÊùê"}, {name:"US Steel Buy", desc:"Â∑®È°çË≤∑Âèé"}, {name:"Seamless Pipe", desc:"Á∂ôÁõÆÁÑ°ÈãºÁÆ°"}]
      },
      {
        id:"jp-jfe", capital: 147, description: "Áã¨Ëá™ÊäÄË°ì„Å®„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞Âäõ„ÇíÊåÅ„Å§È´òÁÇâ„É°„Éº„Ç´„Éº„ÄÇ",
        name:"JFE Holdings", name_jp:"JFE„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ", domain:"jfe-holdings.co.jp", sector:"Industrial", currency:"JPY",
        cash: 300, operating_margin: 7.0, equity_ratio: 38.0, market_cap: 1400, employees: 64000, rnd: 80,
        skill_name: "Only One Tech", skill_desc: "Áã¨Ëá™ÊäÄË°ì„Å´„Çà„ÇãÈ´ò‰ªòÂä†‰æ°ÂÄ§Ë£ΩÂìÅ", skill_type: "BUFF",
        attacks: [{name:"JGreeX", desc:"„Ç∞„É™„Éº„É≥ÈãºÊùê"}, {name:"Engineering", desc:"„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞Âäõ"}, {name:"Plate Mill", desc:"ÂéöÊùøÂúßÂª∂"}]
      },
      {
        id:"jp-kobelco", capital: 250, description: "ÈâÑ„Éª„Ç¢„É´„Éü„ÉªÈäÖ„ÉªÊ©üÊ¢∞„ÇíÊâ±„ÅÜË§áÂêàÁµåÂñ∂„ÄÇ",
        name:"Kobe Steel", name_jp:"Á•ûÊà∏Ë£ΩÈãºÊâÄ", domain:"kobelco.co.jp", sector:"Industrial", currency:"JPY",
        cash: 250, operating_margin: 6.0, equity_ratio: 35.0, market_cap: 700, employees: 40000, rnd: 60,
        skill_name: "Hybrid Material", skill_desc: "ÈâÑ„Éª„Ç¢„É´„Éü„ÉªÈäÖ„ÅÆË§áÂêàÁ¥†ÊùêÂäõ", skill_type: "GUARD",
        attacks: [{name:"Aluminum", desc:"Ëá™ÂãïËªäÁî®„Ç¢„É´„Éü"}, {name:"Compressor", desc:"ÈùûÊ±éÁî®ÂúßÁ∏ÆÊ©ü"}, {name:"Electric Power", desc:"ÈõªÂäõÂç∏‰æõÁµ¶"}]
      },
      {
        id:"jp-yamatokogyo", capital: 13, description: "HÂΩ¢Èãº„Å´ÁâπÂåñ„Åó„ÄÅ‰∏ñÁïåÂ±àÊåá„ÅÆÈ´òÂèéÁõä„ÇíË™á„ÇãÈõªÁÇâ„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Yamato Kogyo", name_jp:"Â§ßÂíåÂ∑•Ê•≠", domain:"yamatokogyo.co.jp", sector:"Industrial", currency:"JPY",
        cash: 150, operating_margin: 20.0, equity_ratio: 80.0, market_cap: 500, employees: 2000, rnd: 10,
        skill_name: "H-Beam Profit", skill_desc: "HÂΩ¢Èãº„Å´ÁâπÂåñ„Åó„ÅüÈ´òÂèéÁõä‰ΩìË≥™", skill_type: "DRAIN",
        attacks: [{name:"EAF Eco", desc:"ÈõªÁÇâ„Å´„Çà„Çã„É™„Çµ„Ç§„ÇØ„É´"}, {name:"Global Niche", desc:"Êµ∑Â§ñÂêàÂºÅÊà¶Áï•"}, {name:"Debt Free", desc:"ÁÑ°ÂÄüÈáëÁµåÂñ∂"}]
      },
      {
        id:"jp-tokyosteel", capital: 30, description: "Ë≥áÊ∫êÂæ™Áí∞ÂûãÁ§æ‰ºö„ÇíÁâΩÂºï„Åô„ÇãÈõªÁÇâ„ÅÆ„Éà„ÉÉ„Éó„É©„É≥„Éä„Éº„ÄÇ",
        name:"Tokyo Steel", name_jp:"Êù±‰∫¨Ë£ΩÈêµ", domain:"tokyosteel.co.jp", sector:"Industrial", currency:"JPY",
        cash: 80, operating_margin: 12.0, equity_ratio: 75.0, market_cap: 200, employees: 1000, rnd: 5,
        skill_name: "Scrap Recycle", skill_desc: "Ë≥áÊ∫êÂæ™Áí∞„Å´„Çà„Çã„Ç≥„Çπ„ÉàÁ´∂‰∫âÂäõ", skill_type: "SPEED",
        attacks: [{name:"Electric Arc", desc:"ÂõΩÂÜÖÊúÄÂ§ßÁ¥ö„ÅÆÈõªÁÇâ"}, {name:"Green Pricing", desc:"Áí∞Â¢É‰æ°ÂÄ§„ÅÆÊèê‰æõ"}, {name:"Low Cost", desc:"ÂæπÂ∫ï„Åó„Åü„Ç≥„Çπ„ÉàÁÆ°ÁêÜ"}]
      },
      /* --- ËøΩÂä†: Â∞èÂ£≤ (Retail) --- */
      {
        id:"jp-seven", capital: 50, description: "‰∏ñÁïåÊúÄÂ§ß„ÅÆ„Ç≥„É≥„Éì„ÉãÁ∂≤„ÇíÊåÅ„Å§ÊµÅÈÄö„Ç∞„É´„Éº„Éó„ÄÇ",
        name:"Seven & i", name_jp:"„Çª„Éñ„É≥ÔºÜ„Ç¢„Ç§", domain:"7andi.com", sector:"Retail", currency:"JPY",
        cash: 1800, operating_margin: 5.0, equity_ratio: 35.0, market_cap: 5500, employees: 80000, rnd: 50,
        skill_name: "Global Franchise", skill_desc: "‰∏ñÁïåÊúÄÂº∑„ÅÆCVSÁ∂≤„Å´„Çà„ÇãÊîØÈÖç", skill_type: "BUFF",
        attacks: [{name:"Premium PB", desc:"„Çª„Éñ„É≥„Éó„É¨„Éü„Ç¢„É†"}, {name:"Speedway", desc:"ÂåóÁ±≥„Ç≥„É≥„Éì„ÉãË≤∑Âèé"}, {name:"Otsuka", desc:"„Éá„ÉëÂú∞‰∏ãÊÉ£Ëèú"}]
      },
      {
        id:"jp-aeon", capital: 220, description: "„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„É´„ÅßÂú∞ÂüüÁîüÊ¥ª„ÇíÊîØ„Åà„ÇãÊµÅÈÄö„ÅÆÂ∑®‰∫∫„ÄÇ",
        name:"AEON", name_jp:"„Ç§„Ç™„É≥", domain:"aeon.info", sector:"Retail", currency:"JPY",
        cash: 1500, operating_margin: 3.0, equity_ratio: 10.0, market_cap: 3000, employees: 160000, rnd: 120,
        skill_name: "Mall Domination", skill_desc: "ÁîüÊ¥ªÂúè„ÇíÂ°ó„ÇäÊõø„Åà„ÇãÂ∑®Â§ß„É¢„Éº„É´", skill_type: "GUARD",
        attacks: [{name:"Top Valu", desc:"ÂúßÂÄíÁöÑÂÆâ„Åï„ÅÆPB"}, {name:"Financial Svc", desc:"„Ç§„Ç™„É≥ÈäÄË°å„Éª„Ç´„Éº„Éâ"}, {name:"WAON", desc:"ÈõªÂ≠ê„Éû„Éç„ÉºÂõ≤„ÅÑËæº„Åø"}]
      },
      {
        id:"jp-nitori", capital: 13, description: "„Äå„Åä„ÄÅ„Å≠„Å†„Çì‰ª•‰∏ä„ÄÇ„Äç„ÇíÂÆüÁèæ„Åô„ÇãË£ΩÈÄ†Áâ©ÊµÅÂ∞èÂ£≤Ê•≠„ÄÇ",
        name:"Nitori", name_jp:"„Éã„Éà„É™HD", domain:"nitori.co.jp", sector:"Retail", currency:"JPY",
        cash: 300, operating_margin: 15.0, equity_ratio: 80.0, market_cap: 2000, employees: 18000, rnd: 20,
        skill_name: "Oteidan Price", skill_desc: "„Åä„ÄÅ„Å≠„Å†„Çì‰ª•‰∏ä„ÄÇ„ÅÆÁ†¥Â£äÂäõ", skill_type: "DOT",
        attacks: [{name:"Vertical Integration", desc:"Ë£ΩÈÄ†Áâ©ÊµÅÂ∞èÂ£≤Ê•≠"}, {name:"Global Sourcing", desc:"Êµ∑Â§ñÈñãÁô∫Ëº∏ÂÖ•"}, {name:"M&A Shimachu", desc:"„Éõ„Éº„É†„Çª„É≥„Çø„ÉºÁµ±Âêà"}]
      },
      {
        id:"jp-panpac", capital: 23, description: "„Äå„Éâ„É≥„Éª„Ç≠„Éõ„Éº„ÉÜ„Äç„Å™„Å©„ÅßÈ©öÂÆâ„ÅÆÊÆøÂ†Ç„ÇíÁØâ„Åè„ÄÇ",
        name:"PPIH", name_jp:"„Éë„É≥„Éª„Éë„Ç∑„Éï„Ç£„ÉÉ„ÇØ(„Éâ„É≥„Ç≠)", domain:"ppih.co.jp", sector:"Retail", currency:"JPY",
        cash: 200, operating_margin: 6.0, equity_ratio: 30.0, market_cap: 2200, employees: 18000, rnd: 10,
        skill_name: "Jungle Display", skill_desc: "ÂúßÁ∏ÆÈô≥Âàó„Å´„Çà„ÇãË≥ºË≤∑ÊÑèÊ¨≤Âà∫ÊøÄ", skill_type: "JAM",
        attacks: [{name:"Majica", desc:"‰ºöÂì°„Ç¢„Éó„É™Êà¶Áï•"}, {name:"Inbound", desc:"Ë®™Êó•ÂÆ¢ÈúÄË¶ÅÁàÜÁô∫"}, {name:"Giga Pearl", desc:"Êµ∑Â§ñÂ±ïÈñã"}]
      },
      {
        id:"jp-matsukiyo", capital: 22, description: "„Éá„Éº„ÇøÂàÜÊûê„Å®PBÂïÜÂìÅ„Å´Âº∑„ÅÑ„Éâ„É©„ÉÉ„Ç∞„Çπ„Éà„Ç¢Â§ßÊâã„ÄÇ",
        name:"MatsukiyoCocokara", name_jp:"„Éû„ÉÑ„Ç≠„É®„Ç≥„Ç≥„Ç´„É©", domain:"matsukiyococokara.com", sector:"Retail", currency:"JPY",
        cash: 150, operating_margin: 6.5, equity_ratio: 60.0, market_cap: 1100, employees: 20000, rnd: 5,
        skill_name: "Digital Makeup", skill_desc: "„Éá„Éº„ÇøÂàÜÊûê„Å´„Çà„ÇãÂåñÁ≤ßÂìÅË≤©Â£≤", skill_type: "SPEED",
        attacks: [{name:"High Profit PB", desc:"È´òÂà©ÁõäÁéáPBÂïÜÂìÅ"}, {name:"App Marketing", desc:"„Ç¢„Éó„É™‰ºöÂì°Âü∫Áõ§"}, {name:"Urban Dominance", desc:"ÈßÖÂâçÁ´ãÂú∞Âà∂Âúß"}]
      },
      /* --- ËøΩÂä†: ÈâÑÈÅì (Industrial / Infra) --- */
      {
        id:"jp-jreast", capital: 200, description: "È¶ñÈÉΩÂúè„ÅÆÈâÑÈÅìÁ∂≤„Å®ÈßÖ„Éä„Ç´„Éì„Ç∏„Éç„Çπ„ÇíÂ±ïÈñã„ÄÇ",
        name:"JR East", name_jp:"JRÊù±Êó•Êú¨", domain:"jreast.co.jp", sector:"Industrial", currency:"JPY",
        cash: 400, operating_margin: 12.0, equity_ratio: 35.0, market_cap: 3200, employees: 70000, rnd: 60,
        skill_name: "Suica Network", skill_desc: "‰∫§ÈÄöÁ≥ªIC„Å´„Çà„ÇãÁîüÊ¥ªÂúèÊîØÈÖç", skill_type: "SPEED",
        attacks: [{name:"Shinkansen", desc:"È´òÈÄüÈâÑÈÅìÁ∂≤"}, {name:"Ekinaka", desc:"ÈßÖ„Éä„Ç´‰∏çÂãïÁî£‰∫ãÊ•≠"}, {name:"JRE Point", desc:"„Éù„Ç§„É≥„ÉàÁµåÊ∏àÂúè"}]
      },
      {
        id:"jp-jrcentral", capital: 112, description: "Êù±Êµ∑ÈÅìÊñ∞ÂππÁ∑ö„ÇíËª∏„Å´ÂúßÂÄíÁöÑ„Å™ÂèéÁõäÂäõ„ÇíË™á„Çã„ÄÇ",
        name:"JR Central", name_jp:"JRÊù±Êµ∑", domain:"jr-central.co.jp", sector:"Industrial", currency:"JPY",
        cash: 600, operating_margin: 35.0, equity_ratio: 40.0, market_cap: 3500, employees: 18000, rnd: 30,
        skill_name: "Linear Motor", skill_desc: "Ë∂ÖÈõªÂ∞é„É™„Éã„Ç¢„Å´„Çà„ÇãÊú™Êù•„Å∏„ÅÆÊäïË≥á", skill_type: "BURST",
        attacks: [{name:"Tokaido", desc:"„Éâ„É´ÁÆ±„ÉªÊù±Êµ∑ÈÅìÊñ∞ÂππÁ∑ö"}, {name:"Express Res", desc:"EX‰∫àÁ¥Ñ„Ç∑„Çπ„ÉÜ„É†"}, {name:"Cash Cow", desc:"ÂúßÂÄíÁöÑÂà©ÁõäÁéá"}]
      },
      {
        id:"jp-jrwest", capital: 100, description: "Ë•øÊó•Êú¨„ÅÆÈâÑÈÅìÁ∂≤„Å®Ë¶≥ÂÖâ„ÄÅ‰∏çÂãïÁî£ÈñãÁô∫„ÇíÊãÖ„ÅÜ„ÄÇ",
        name:"JR West", name_jp:"JRË•øÊó•Êú¨", domain:"westjr.co.jp", sector:"Industrial", currency:"JPY",
        cash: 250, operating_margin: 10.0, equity_ratio: 30.0, market_cap: 1400, employees: 45000, rnd: 20,
        skill_name: "Rapid Network", skill_desc: "‰∫¨Èò™Á•û„Ç¢„Éº„Éê„É≥„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ", skill_type: "SPEED",
        attacks: [{name:"Sanyo Shinkansen", desc:"Â±±ÈôΩÊñ∞ÂππÁ∑ö"}, {name:"Inbound Kansai", desc:"Èñ¢Ë•øË¶≥ÂÖâÈúÄË¶Å"}, {name:"Real Estate", desc:"Â§ßÈò™ÈßÖÈñãÁô∫"}]
      },
      {
        id:"jp-tokyu", capital: 121, description: "Ê∏ãË∞∑ÂÜçÈñãÁô∫„Å®Ê≤øÁ∑ö‰æ°ÂÄ§Âêë‰∏ä„ÇíÈÄ≤„ÇÅ„ÇãÁßÅÈâÑ„ÅÆÈõÑ„ÄÇ",
        name:"Tokyu", name_jp:"Êù±ÊÄ•", domain:"tokyu.co.jp", sector:"Industrial", currency:"JPY",
        cash: 100, operating_margin: 8.0, equity_ratio: 25.0, market_cap: 1100, employees: 5000, rnd: 10,
        skill_name: "Transit Oriented", skill_desc: "ÈâÑÈÅì√óÈÉΩÂ∏ÇÈñãÁô∫„ÅÆÁõ∏‰πóÂäπÊûú", skill_type: "BUFF",
        attacks: [{name:"Shibuya Dev", desc:"Ê∏ãË∞∑ÂÜçÈñãÁô∫"}, {name:"Den-en-toshi", desc:"Ê≤øÁ∑ö‰æ°ÂÄ§Âêë‰∏ä"}, {name:"Hotels", desc:"„Éõ„ÉÜ„É´‰∫ãÊ•≠"}]
      },
      {
        id:"jp-hankyu", capital: 99, description: "ÂÆùÂ°öÊ≠åÂäá„ÇÑÈò™Á•û„Çø„Ç§„Ç¨„Éº„Çπ„ÇÇÊä±„Åà„ÇãÈñ¢Ë•ø„ÅÆ„Éñ„É©„É≥„Éâ‰ºÅÊ•≠„ÄÇ",
        name:"Hankyu Hanshin", name_jp:"Èò™ÊÄ•Èò™Á•ûHD", domain:"hankyu-hanshin.co.jp", sector:"Industrial", currency:"JPY",
        cash: 120, operating_margin: 11.0, equity_ratio: 30.0, market_cap: 1200, employees: 22000, rnd: 5,
        skill_name: "Entertainment City", skill_desc: "ÂÆùÂ°ö„ÉªËôé„ÉªÈÉΩÂ∏Ç„ÅÆ„Ç®„É≥„Çø„É°Ë§áÂêà", skill_type: "JAM",
        attacks: [{name:"Takarazuka", desc:"ÂÆùÂ°öÊ≠åÂäáÂõ£"}, {name:"Tigers", desc:"Èò™Á•û„Çø„Ç§„Ç¨„Éº„Çπ"}, {name:"Umeda", desc:"Ê¢ÖÁî∞„Éâ„Éü„Éä„É≥„Éà"}]
      },
      /* --- ËøΩÂä†: „Ç®„Éç„É´„ÇÆ„Éº (Energy) --- */
      {
        id:"jp-eneos", capital: 100, description: "ÂõΩÂÜÖ„Ç∑„Çß„Ç¢No.1„ÅÆÁáÉÊñô‰æõÁµ¶Á∂≤„ÇíÊåÅ„Å§„Ç®„Éç„É´„ÇÆ„Éº‰ºÅÊ•≠„ÄÇ",
        name:"ENEOS", name_jp:"ENEOS HD", domain:"eneos.co.jp", sector:"Energy", currency:"JPY",
        cash: 600, operating_margin: 3.5, equity_ratio: 30.0, market_cap: 2200, employees: 40000, rnd: 50,
        skill_name: "Energy Flow", skill_desc: "ÂõΩÂÜÖÊúÄÂ§ß„Ç∑„Çß„Ç¢„ÅÆÁáÉÊñô‰æõÁµ¶Á∂≤", skill_type: "BUFF",
        attacks: [{name:"SS Network", desc:"„Çµ„Éº„Éì„Çπ„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥"}, {name:"Hydrogen", desc:"Ê∞¥Á¥†„Çµ„Éó„É©„Ç§„ÉÅ„Çß„Éº„É≥"}, {name:"Copper", desc:"ÈäÖÈâ±Â±±ÈñãÁô∫"}]
      },
      {
        id:"jp-inpex", capital: 290, description: "‰∏ñÁïåË¶èÊ®°„ÅßÁü≥Ê≤π„ÉªÂ§©ÁÑ∂„Ç¨„ÇπÈñãÁô∫„ÇíË°å„ÅÜÂõΩÂÜÖÊúÄÂ§ßÊâã„ÄÇ",
        name:"INPEX", name_jp:"INPEX", domain:"inpex.co.jp", sector:"Energy", currency:"JPY",
        cash: 400, operating_margin: 45.0, equity_ratio: 60.0, market_cap: 2800, employees: 3000, rnd: 20,
        skill_name: "Ichthys LNG", skill_desc: "Ë±™Â∑ûÂ∑®Â§ß„Ç¨„ÇπÁî∞„Åã„Çâ„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•", skill_type: "BURST",
        attacks: [{name:"Upstream", desc:"Ë≥áÊ∫êÈñãÁô∫Ê®©Áõä"}, {name:"Net Zero", desc:"CCS/CCUSÊäÄË°ì"}, {name:"Dividends", desc:"È´òÈÖçÂΩìÈÇÑÂÖÉ"}]
      },
      {
        id:"jp-idemitsu", capital: 168, description: "„Äå„Ç¢„Éù„É≠„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥„Äç„ÇíÂ±ïÈñã„Åó„ÄÅÁ¥†ÊùêÈñãÁô∫„Å´„ÇÇÊ≥®Âäõ„ÄÇ",
        name:"Idemitsu", name_jp:"Âá∫ÂÖâËààÁî£", domain:"idemitsu.com", sector:"Energy", currency:"JPY",
        cash: 200, operating_margin: 4.0, equity_ratio: 35.0, market_cap: 1100, employees: 14000, rnd: 30,
        skill_name: "Apollo Station", skill_desc: "Âú∞ÂüüÂØÜÁùÄ„ÅÆ„Ç®„Éç„É´„ÇÆ„ÉºÊã†ÁÇπ", skill_type: "SPEED",
        attacks: [{name:"Solid Battery", desc:"ÂÖ®Âõ∫‰ΩìÈõªÊ±†Á¥†Êùê"}, {name:"OLED", desc:"ÊúâÊ©üELÊùêÊñô"}, {name:"Refining", desc:"Ë£ΩÊ≤πÊâÄÊúÄÈÅ©Âåñ"}]
      },
      {
        id:"jp-kanden", capital: 489, description: "ÂéüÂ≠êÂäõÁô∫Èõª„Çí‰∏ªÂäõ„Å´ÂÆâÂÆö‰æõÁµ¶„ÇíÊîØ„Åà„ÇãÈõªÂäõ‰ºöÁ§æ„ÄÇ",
        name:"Kansai Electric", name_jp:"Èñ¢Ë•øÈõªÂäõ", domain:"kepco.co.jp", sector:"Energy", currency:"JPY",
        cash: 300, operating_margin: 10.0, equity_ratio: 20.0, market_cap: 2000, employees: 30000, rnd: 15,
        skill_name: "Base Load Power", skill_desc: "ÂéüÂ≠êÂäõÁô∫Èõª„Å´„Çà„ÇãÂÆâÂÆö‰æõÁµ¶", skill_type: "GUARD",
        attacks: [{name:"Nuclear", desc:"ÂéüÁô∫ÂÜçÁ®ºÂÉç"}, {name:"Optiage", desc:"eoÂÖâÈÄö‰ø°‰∫ãÊ•≠"}, {name:"Real Estate", desc:"Èñ¢Èõª‰∏çÂãïÁî£"}]
      },
      {
        id:"jp-tokyogas", capital: 141, description: "È¶ñÈÉΩÂúè„ÅÆ„Ç¨„Çπ‰æõÁµ¶„Å®Êñ∞„Ç®„Éç„É´„ÇÆ„Éº‰∫ãÊ•≠„ÇíÂ±ïÈñã„ÄÇ",
        name:"Tokyo Gas", name_jp:"Êù±‰∫¨„Ç¨„Çπ", domain:"tokyo-gas.co.jp", sector:"Energy", currency:"JPY",
        cash: 150, operating_margin: 8.0, equity_ratio: 40.0, market_cap: 1600, employees: 16000, rnd: 10,
        skill_name: "Smart Energy", skill_desc: "È¶ñÈÉΩÂúè„ÇíÊîØ„Åà„Çã„Ç¨„ÇπÂ∞éÁÆ°Á∂≤", skill_type: "DOT",
        attacks: [{name:"LNG Trading", desc:"LNGË™øÈÅîÂäõ"}, {name:"Compass", desc:"Êñ∞‰∫ãÊ•≠ÂâµÈÄ†"}, {name:"Decarbon", desc:"„É°„Çø„Éç„Éº„Ç∑„Éß„É≥ÊäÄË°ì"}]
      },
      /* --- ËøΩÂä†: „Éô„É≥„ÉÅ„É£„Éº (Venture / Mixed) --- */
      {
        id:"jp-akari", capital: 0.1, description: "Âª∫Ë®≠Ê•≠Áïå„ÅÆDX„ÇíÊé®ÈÄ≤„Åô„ÇãÊù±Â§ßÁô∫AI„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó„ÄÇ",
        name:"Akari", name_jp:"Ááà (Akari)", domain:"akariinc.co.jp", sector:"Tech", currency:"JPY",
        cash: 5, operating_margin: 25.0, equity_ratio: 80.0, market_cap: 30, employees: 100, rnd: 10,
        skill_name: "DX Construction", skill_desc: "Âª∫Ë®≠Ê•≠ÁâπÂåñ„ÅÆÊù±Â§ßÁô∫AI", skill_type: "JAM",
        attacks: [{name:"Deep Learning", desc:"È´òÂ∫¶ÁîªÂÉèË™çË≠ò"}, {name:"Consulting", desc:"DX„Ç≥„É≥„Çµ„É´"}, {name:"Speed Dev", desc:"È´òÈÄüÈñãÁô∫"}]
      },
      {
        id:"jp-openhouse", capital: 20, description: "ÈÉΩÂøÉÂ•ΩÁ´ãÂú∞„ÅÆÊà∏Âª∫„Å¶Ë≤©Â£≤„ÅßÊÄ•ÊàêÈï∑„Åô„Çã‰∏çÂãïÁî£‰ºöÁ§æ„ÄÇ",
        name:"Open House", name_jp:"„Ç™„Éº„Éó„É≥„Éè„Ç¶„Çπ", domain:"openhouse-group.co.jp", sector:"Retail", currency:"JPY",
        cash: 300, operating_margin: 11.0, equity_ratio: 40.0, market_cap: 600, employees: 5000, rnd: 5,
        skill_name: "Ready-built Home", skill_desc: "ÈÉΩÂøÉÂ•ΩÁ´ãÂú∞„Éª‰Ωé‰æ°Ê†º„ÅÆÁ†¥Â£äÂäõ", skill_type: "SPEED",
        attacks: [{name:"Sales Power", desc:"Ê∫êÊ≥âÂñ∂Ê•≠"}, {name:"Tochinika", desc:"Ë°å„Åì„ÅÜ„Åú„ÄÅË°ó„Å∏„ÄÇ"}, {name:"US Real Estate", desc:"Á±≥ÂõΩ‰∏çÂãïÁî£"}]
      },
      {
        id:"jp-gmo", capital: 5, description: "„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà„Ç§„É≥„Éï„É©„Å®ÈáëËûç„ÉªÊöóÂè∑Ë≥áÁî£„ÅÆË§áÂêà‰Ωì„ÄÇ",
        name:"GMO Internet", name_jp:"GMO„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà", domain:"gmo.jp", sector:"Tech", currency:"JPY",
        cash: 250, operating_margin: 12.0, equity_ratio: 10.0, market_cap: 300, employees: 7000, rnd: 20,
        skill_name: "Mining Hash", skill_desc: "„Ç§„É≥„Éï„É©„ÉªÈáëËûç„ÉªÊöóÂè∑Ë≥áÁî£„ÅÆ„Ç≥„É≥„Ç∞„É≠„Éû„É™„ÉÉ„Éà", skill_type: "BURST",
        attacks: [{name:"Domain/Host", desc:"ÂõΩÂÜÖNo.1„Ç§„É≥„Éï„É©"}, {name:"FX Trading", desc:"‰∏ñÁïå‰∏Ä„ÅÆFXÂèñÂºïÈ´ò"}, {name:"Crypto", desc:"„Éû„Ç§„Éã„É≥„Ç∞„ÉªÂèñÂºïÊâÄ"}]
      },
            {
        id:"jp-mercari", capital: 45, description: "Âæ™Áí∞ÂûãÁ§æ‰ºö„ÇíÁõÆÊåá„ÅôÊó•Êú¨ÊúÄÂ§ß„ÅÆ„Éï„É™„Éû„Ç¢„Éó„É™„ÄÇ",
        name:"Mercari", name_jp:"„É°„É´„Ç´„É™", domain:"mercari.com", sector:"Tech", currency:"JPY",
        cash: 180, operating_margin: 8.0, equity_ratio: 25.0, market_cap: 350, employees: 2000, rnd: 40,
        skill_name: "Circular Economy", skill_desc: "Âæ™Áí∞ÂûãÁ§æ‰ºö„Çí‰Ωú„ÇãC2C„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†", skill_type: "SPEED",
        attacks: [{name:"Listing", desc:"ÊúàÈñì2000‰∏á‰∫∫Âà©Áî®"}, {name:"Merpay", desc:"ÈáëËûç„Ç®„Ç≥„Ç∑„Çπ„ÉÜ„É†"}, {name:"US Expansion", desc:"Á±≥ÂõΩ‰∫ãÊ•≠"}]
      },
      /* --- ËøΩÂä†: ÊúâÂêç‰∏≠Â∞è‰ºÅÊ•≠ & ÂÄãÊÄßÊ¥æ‰ºÅÊ•≠ (SME / Local Heroes) --- */
      {
        id:"jp-akagi", capital: 1.0, description: "„Äå„Ç¨„É™„Ç¨„É™Âêõ„Äç„ÅßÁü•„Çâ„Çå„Çã„ÄÅÈÅä„Å≥ÂøÉÊ∫ÄËºâ„ÅÆ„Ç¢„Ç§„Çπ„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Akagi Nyugyo", name_jp:"Ëµ§Âüé‰π≥Ê•≠", domain:"akagi.com", sector:"Retail", currency:"JPY",
        cash: 20, operating_margin: 6.0, equity_ratio: 50.0, market_cap: 50, employees: 400, rnd: 2,
        skill_name: "GariGari Spirit", skill_desc: "ÂÄ§‰∏ä„Åí„Åô„ÇâCM„Éç„Çø„Å´„Åô„ÇãÊÑõ„Åï„ÇåÂäõ", skill_type: "BUFF",
        attacks: [{name:"Soda Flavor", desc:"ÂõΩÊ∞ëÁöÑ„Ç¢„Ç§„Çπ„Ç≠„É£„É≥„Éá„Ç£„Éº"}, {name:"Playful Ad", desc:"Ëá™Ëôê„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞"}, {name:"Cost Cut", desc:"ÂæπÂ∫ï„Åó„ÅüÂäπÁéáÂåñ"}]
      },
      {
        id:"jp-choshi", capital: 0.1, description: "„Å¨„ÇåÁÖéÈ§Ö„ÇÑ„Ç§„Éô„É≥„Éà„ÅßÁîü„ÅçÊÆã„Çä„Çí„Åã„Åë„Çã„É≠„Éº„Ç´„É´ÈâÑÈÅì„ÄÇ",
        name:"Choshi Electric", name_jp:"ÈäöÂ≠êÈõªÈâÑ", domain:"choshi-dentetsu.jp", sector:"Industrial", currency:"JPY",
        cash: 2, operating_margin: -5.0, equity_ratio: 10.0, market_cap: 5, employees: 24, rnd: 0.5,
        skill_name: "Survival Snack", skill_desc: "Êú¨Ê•≠„ÅØ„Å¨„ÇåÁÖéÈ§ÖÔºüÁµ∂ÂØæ„Å´„ÅÇ„Åç„Çâ„ÇÅ„Å™„ÅÑÁîüÂ≠òÊú¨ËÉΩ", skill_type: "DRAIN",
        attacks: [{name:"Nure Senbei", desc:"ÈâÑÈÅìÂèéÂÖ•„Çí‰∏äÂõû„ÇãÂâØÊ•≠"}, {name:"Mazui Bou", desc:"ÁµåÂñ∂Áä∂Ê≥Å„Çí„Éç„Çø„Å´"}, {name:"Crowdfunding", desc:"„Éï„Ç°„É≥„ÅÆÊîØÊè¥"}]
      },
      {
        id:"jp-dassai", capital: 0.01, description: "„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÈÖíÈÄ†„Çä„Åß„ÄåÁç∫Á•≠„Äç„Çí‰∏ñÁïå„Éñ„É©„É≥„Éâ„Å´„ÄÇ",
        name:"Asahi Shuzo", name_jp:"Êó≠ÈÖíÈÄ† (Áç∫Á•≠)", domain:"asahishuzo.ne.jp", sector:"Industrial", currency:"JPY",
        cash: 30, operating_margin: 20.0, equity_ratio: 60.0, market_cap: 100, employees: 200, rnd: 1,
        skill_name: "Data Brewing", skill_desc: "ÊùúÊ∞è„ÅÆÂãò„Çí„Éá„Éº„ÇøÂåñ„Åó„ÄÅÊúÄÈ´òÂìÅË≥™„ÇíÈáèÁî£", skill_type: "BURST",
        attacks: [{name:"Migaki 23", desc:"Ê•µÈôê„Åæ„ÅßÁ£®„ÅÑ„ÅüÂ±±Áî∞Èå¶"}, {name:"Global Brand", desc:"Êµ∑Â§ñÂ£≤‰∏äÊØîÁéá„ÅÆÈ´ò„Åï"}, {name:"No Toji", desc:"Á§æÂì°„Å´„Çà„ÇãÈÖíÈÄ†„Çä"}]
      },
      {
        id:"jp-tanita", capital: 0.05, description: "ÂÅ•Â∫∑Ë®àÊ∏¨Ê©üÂô®„Å®Á§æÂì°È£üÂ†Ç„ÅßÂÅ•Â∫∑„Å•„Åè„Çä„Çí„Çµ„Éù„Éº„Éà„ÄÇ",
        name:"Tanita", name_jp:"„Çø„Éã„Çø", domain:"tanita.co.jp", sector:"Tech", currency:"JPY",
        cash: 15, operating_margin: 8.0, equity_ratio: 55.0, market_cap: 40, employees: 1200, rnd: 3,
        skill_name: "Health Monitor", skill_desc: "Á§æÂì°„ÅÆÂÅ•Â∫∑„ÇíÁÆ°ÁêÜ„Åó„ÄÅÁîüÁî£ÊÄß„ÇíÊúÄÂ§ßÂåñ", skill_type: "GUARD",
        attacks: [{name:"Body Comp", desc:"‰ΩìÁµÑÊàêË®à„Ç∑„Çß„Ç¢No.1"}, {name:"Shokudo", desc:"„Éò„É´„Ç∑„ÉºÁ§æÂì°È£üÂ†Ç"}, {name:"Twitter", desc:"Âàá„ÇåÂë≥Èã≠„ÅÑÂÖ¨Âºè"}]
      },
      {
        id:"jp-mirai", capital: 2.9, description: "„ÄåÂ∏∏„Å´ËÄÉ„Åà„Çã„Äç„Çí„É¢„ÉÉ„Éà„Éº„Å´„ÄÅÊÆãÊ•≠„Çº„É≠„ÅßÈ´òÂèéÁõä„ÇíÂÆüÁèæ„ÄÇ",
        name:"Mirai Industry", name_jp:"Êú™Êù•Â∑•Ê•≠", domain:"mirai.co.jp", sector:"Industrial", currency:"JPY",
        cash: 40, operating_margin: 14.0, equity_ratio: 75.0, market_cap: 80, employees: 800, rnd: 5,
        skill_name: "Utopia Work", skill_desc: "ÊÆãÊ•≠„Çº„É≠„Éª„Éõ„Ç¶„É¨„É≥„ÇΩ„Ç¶Á¶ÅÊ≠¢„ÅßÊúÄÈ´òÁõä", skill_type: "BUFF",
        attacks: [{name:"Suggestion", desc:"ÊîπÂñÑÊèêÊ°àÂà∂Â∫¶"}, {name:"Niche Top", desc:"ÈõªË®≠Ë≥áÊùê„ÅÆÂúßÂÄíÁöÑ„Ç∑„Çß„Ç¢"}, {name:"Long Vacation", desc:"Êó•Êú¨‰∏Ä„ÅÆÂπ¥Èñì‰ºëÊó•"}]
      },
      {
        id:"jp-balmuda", capital: 0.3, description: "ÊÑüÂãïÁöÑ„Å™‰ΩìÈ®ì„ÇíÊèê‰æõ„Åô„ÇãÂÆ∂Èõª„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Balmuda", name_jp:"„Éê„É´„Éü„É•„Éº„ÉÄ", domain:"balmuda.com", sector:"Tech", currency:"JPY",
        cash: 10, operating_margin: 7.0, equity_ratio: 40.0, market_cap: 25, employees: 150, rnd: 8,
        skill_name: "Experience Design", skill_desc: "Ê©üËÉΩ„Çà„Çä„Äé‰ΩìÈ®ì„Äè„ÇíÂ£≤„Çã„Éá„Ç∂„Ç§„É≥Âäõ", skill_type: "SPEED",
        attacks: [{name:"Steam Toast", desc:"ÊÑüÂãï„ÅÆ„Éà„Éº„Çπ„Çø„Éº"}, {name:"Storytelling", desc:"ÊÉÖÁ∑íÁöÑ‰æ°ÂÄ§„ÅÆË®¥Ê±Ç"}, {name:"Premium Price", desc:"È´òÂçò‰æ°Êà¶Áï•"}]
      },
      {
        id:"jp-snowpeak", capital: 2.0, description: "„ÄåÈáéÈÅä„Å≥„Äç„ÇíÊèêÊ°à„Åô„Çã„Éè„Ç§„Ç®„É≥„Éâ„Éª„Ç¢„Ç¶„Éà„Éâ„Ç¢„Éñ„É©„É≥„Éâ„ÄÇ",
        name:"Snow Peak", name_jp:"„Çπ„Éé„Éº„Éî„Éº„ÇØ", domain:"snowpeak.co.jp", sector:"Retail", currency:"JPY",
        cash: 15, operating_margin: 9.0, equity_ratio: 30.0, market_cap: 60, employees: 700, rnd: 4,
        skill_name: "Noasobi", skill_desc: "ÈáéÈÅä„Å≥„ÇíÈÄö„Åò„Å¶‰∫∫ÈñìÊÄß„ÇíÂõûÂæ©„Åô„Çã", skill_type: "BUFF",
        attacks: [{name:"Lifetime Warranty", desc:"Ê∞∏‰πÖ‰øùË®º"}, {name:"Community", desc:"ÁÜ±ÁãÇÁöÑ„Å™„Éï„Ç°„É≥Âü∫Áõ§"}, {name:"Camping Gear", desc:"„Éè„Ç§„Ç®„É≥„ÉâÈáéÂ§ñÈÅìÂÖ∑"}]
      },
      {
        id:"jp-otafuku", capital: 0.1, description: "„ÅäÂ•Ω„ÅøÁÑº„ÅçÊñáÂåñ„Çí‰∏ñÁïå„Å´Â∫É„ÇÅ„Çã„ÇΩ„Éº„Çπ„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Otafuku Sauce", name_jp:"„Ç™„Çø„Éï„ÇØ„ÇΩ„Éº„Çπ", domain:"otafuku.co.jp", sector:"Retail", currency:"JPY",
        cash: 12, operating_margin: 10.0, equity_ratio: 65.0, market_cap: 40, employees: 700, rnd: 2,
        skill_name: "Okonomi Culture", skill_desc: "„ÅäÂ•Ω„ÅøÁÑº„ÅçÊñáÂåñ„Çí‰∏ñÁïå„Å∏Â∫É„ÇÅ„Çã", skill_type: "DOT",
        attacks: [{name:"Secret Sauce", desc:"ÈñÄÂ§ñ‰∏çÂá∫„ÅÆ„Éñ„É¨„É≥„Éâ"}, {name:"Okonomi Kentei", desc:"ÊñáÂåñÊôÆÂèäÊ¥ªÂãï"}, {name:"Date Vinegar", desc:"ÂâµÊ•≠„ÅØ„ÅäÈÖ¢Â±ã"}]
      },
      {
        id:"jp-kiyoken", capital: 0.1, description: "Ê®™ÊµúÂêçÁâ©„Äå„Ç∑„Ç¶„Éû„Ç§ÂºÅÂΩì„Äç„ÅßÊÑõ„Åï„Çå„Çã„É≠„Éº„Ç´„É´‰ºÅÊ•≠„ÄÇ",
        name:"Kiyoken", name_jp:"Â¥éÈôΩËªí", domain:"kiyoken.com", sector:"Retail", currency:"JPY",
        cash: 18, operating_margin: 5.0, equity_ratio: 50.0, market_cap: 35, employees: 2000, rnd: 1,
        skill_name: "Jet Box", skill_desc: "ÂÜ∑„ÇÅ„Å¶„ÇÇÁæéÂë≥„Åó„ÅÑ„ÄÅÊ®™Êµú„ÅÆ„ÇΩ„Ç¶„É´„Éï„Éº„Éâ", skill_type: "GUARD",
        attacks: [{name:"Shiumai Bento", desc:"1Êó•2‰∏á7000ÂÄãË≤©Â£≤"}, {name:"Hyo-Chan", desc:"ÈÜ§Ê≤πÂÖ•„Çå„Ç≥„É¨„ÇØ„Çø„Éº"}, {name:"Local Brand", desc:"Ê®™ÊµúÂú∞ÂüüÂØÜÁùÄ"}]
      },
      {
        id:"jp-iwatsuka", capital: 1.6, description: "ÂõΩÁî£Á±≥100%„Å´„Åì„Å†„Çè„Çä„ÄÅÊµ∑Â§ñÊäïË≥á„Åß„ÇÇÊàêÂäü„Åó„ÅüÁ±≥Ëèì„É°„Éº„Ç´„Éº„ÄÇ",
        name:"Iwatsuka Seika", name_jp:"Â≤©Â°öË£ΩËèì", domain:"iwatsukaseika.co.jp", sector:"Retail", currency:"JPY",
        cash: 30, operating_margin: 4.0, equity_ratio: 60.0, market_cap: 50, employees: 800, rnd: 1,
        skill_name: "Rice Partnership", skill_desc: "Âè∞Êπæ‰ºÅÊ•≠„Å∏„ÅÆÊäïË≥á„ÅåÁîü„Çì„Å†Â∑®È°ç„ÅÆÂê´„ÅøÁõä", skill_type: "BURST",
        attacks: [{name:"100% Domestic", desc:"ÂõΩÁî£Á±≥„Å∏„ÅÆ„Åì„Å†„Çè„Çä"}, {name:"Want Want", desc:"Êó∫Êó∫ÈõÜÂõ£„Å®„ÅÆÊèêÊê∫"}, {name:"Financial Asset", desc:"Êú¨Ê•≠„ÇíË∂Ö„Åà„ÇãÈÅãÁî®Áõä"}]
      }
    ];

    /* --- MISSING CONSTANTS & DB HELPERS (FIX) --- */
    const Screens = { 
      Title: "screenTitle", 
      Start: "screenStart", 
      Battle: "screenBattle", 
      Result: "screenResult", 
      Tournament: "screenTournament", 
      Lab: "screenLab",
      Help: "screenHelp"
    };

    const DB_NAME = "CQ_DB_v2";
    const STORE_COMP = "companies";
    const STORE_META = "meta";

    function openDb(){
      return new Promise((res,rej)=>{
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE_COMP)) db.createObjectStore(STORE_COMP, {keyPath:"id"});
          if(!db.objectStoreNames.contains(STORE_META)) db.createObjectStore(STORE_META);
        };
        r.onsuccess = ()=>res(r.result);
        r.onerror = ()=>rej(r.error);
      });
    }
    async function dbPutMany(storeName, items){
      const db = await openDb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName, "readwrite");
        const st = tx.objectStore(storeName);
        items.forEach(i=>st.put(i));
        tx.oncomplete = ()=>res();
        tx.onerror = ()=>rej(tx.error);
      });
    }
    async function dbGetAll(storeName){
      const db = await openDb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName, "readonly");
        const req = tx.objectStore(storeName).getAll();
        req.onsuccess = ()=>res(req.result);
        req.onerror = ()=>rej(req.error);
      });
    }
    async function dbClear(storeName){
      const db = await openDb();
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName, "readwrite");
        tx.objectStore(storeName).clear();
        tx.oncomplete = ()=>res();
      });
    }
    async function metaGet(key){
      const db = await openDb();
      return new Promise((res)=>{
        const tx = db.transaction(STORE_META, "readonly");
        const req = tx.objectStore(STORE_META).get(key);
        req.onsuccess = ()=>res(req.result);
        req.onerror = ()=>res(null);
      });
    }
    async function metaSet(key, val){
      const db = await openDb();
      return new Promise((res)=>{
        const tx = db.transaction(STORE_META, "readwrite");
        tx.objectStore(STORE_META).put(val, key);
        tx.oncomplete = ()=>res();
      });
    }

    const state = {
      companies: [],
      playerId: null,
      cpuId: null,

      // battle runtime
      battle: null,

      // tournament
      tournament: null,

      // settings
      fx: {USD:150, EUR:165, GBP:190}
    };

    function showScreen(key){
      for(const k of Object.values(Screens)){
        const el = $(k);
        if(el) el.classList.add("hidden");
      }
      $(key).classList.remove("hidden");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function getCompany(id){
      return state.companies.find(c=>c.id===id);
    }

    function companyLabel(c){
      return `${c.name_jp || c.name} / ${c.name}`;
    }

    function initialsFor(c){
      const s = (c.name_jp || c.name || "CO").trim();
      const letters = s.replace(/Ê†™Âºè‰ºöÁ§æ/g,"").replace(/\s+/g," ").trim();
      // prefer roman initials if available
      if(/[A-Za-z]/.test(c.name||"")){
        const words = (c.name||"").split(/\s+/).filter(Boolean);
        const init = words.slice(0,2).map(w=>w[0].toUpperCase()).join("");
        return init || (c.name||"C")[0].toUpperCase();
      }
      // Japanese: take first 2 characters excluding symbols
      const jp = letters.replace(/[^\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}A-Za-z0-9]/gu,"");
      return jp.slice(0,2) || "CQ";
    }

        function makeLogo(el, c){
      el.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "w-full h-full flex items-center justify-center relative";
      const img = document.createElement("img");
      img.alt = c.name;
      /* unavatar.io „Çí‰ΩøÁî®„Åó„Å¶„É≠„Ç¥ÂèñÂæóÁéá„ÇíÂêë‰∏ä„Åï„Åõ„Åæ„Åô */
      img.src = `https://unavatar.io/${c.domain}?fallback=false`;
      img.onerror = ()=>{
        img.remove();
        const fb = document.createElement("div");
        fb.className = "logoFallback";
        fb.textContent = initialsFor(c);
        wrap.appendChild(fb);
      };
      wrap.appendChild(img);
      el.appendChild(wrap);
    }

    /********************
     * FINANCIAL -> GAME STAT
     *
     * Inputs: cash, market_cap, rnd (billion JPY); margins/ratios (%)
     * Output: hp/atk/def/spd, skillMax, gaugeGain
     ********************/
    function buildScaler(companies){
      // Build normalization ranges from current pool.
      const cash = companies.map(c=>+c.cash||0);
      const mcap = companies.map(c=>+c.market_cap||0);
      const rndv = companies.map(c=>+c.rnd||0);
      const om = companies.map(c=>+c.operating_margin||0);
      const eq = companies.map(c=>+c.equity_ratio||0);

      const minmax = (arr)=>({min: Math.min(...arr), max: Math.max(...arr)});
      const aCash = minmax(cash);
      const aMcap = minmax(mcap);
      const aRnd  = minmax(rndv);
      const aOm   = minmax(om);
      const aEq   = minmax(eq);

      // avoid zero-range
      function norm(v, a){
        if(!isFinite(v)) v = 0;
        const d = (a.max - a.min);
        if(d <= 1e-9) return 0.5;
        return clamp((v - a.min) / d, 0, 1);
      }

      return {aCash,aMcap,aRnd,aOm,aEq,norm};
    }

    function deriveStats(c, scaler){
      // compress huge values with log
      const cash = Math.log10((+c.cash||1) + 1);
      const mcap = Math.log10((+c.market_cap||1) + 1);
      const rndv = Math.log10((+c.rnd||1) + 1);

      const cashN = scaler.norm(cash, {min: Math.log10(scaler.aCash.min+1), max: Math.log10(scaler.aCash.max+1)});
      const mcapN = scaler.norm(mcap, {min: Math.log10(scaler.aMcap.min+1), max: Math.log10(scaler.aMcap.max+1)});
      const rndN  = scaler.norm(rndv, {min: Math.log10(scaler.aRnd.min+1),  max: Math.log10(scaler.aRnd.max+1)});

      const omN = scaler.norm(+c.operating_margin||0, scaler.aOm);
      const eqN = scaler.norm(+c.equity_ratio||0, scaler.aEq);

      // HP: 180..420
      const hp = Math.round(lerp(190, 420, cashN));
      // ATK: 40..120 (om matters; keyence etc will be strong)
      const atk = Math.round(lerp(45, 125, Math.pow(omN, 0.80)));
      // DEF: 35..120
      const def = Math.round(lerp(38, 120, Math.pow(eqN, 0.85)));
      // SPD: 40..120 (market cap / employees proxy)
      const spd = Math.round(lerp(45, 120, Math.pow(mcapN, 0.78)));

      // Skill Gauge max: 100 fixed; fill speed depends on rnd and spd
      const skillMax = 100;
      const gaugeGain = Math.round(lerp(8, 20, (rndN*0.70 + mcapN*0.30)));

      // extra: employee used in tooltip only (or later)
      return {hp, atk, def, spd, skillMax, gaugeGain, cashN, mcapN, rndN, omN, eqN};
    }

    /********************
     * BATTLE ENGINE
     ********************/
        function makeFighter(c, scaler){
      const st = deriveStats(c, scaler);
      // Assign random motion deterministically based on ID if not present
      if(!c.motion) c.motion = MOTIONS[hashStr(c.id || c.name) % MOTIONS.length];
      
      return {
        company: c,
        base: st,
        maxHP: st.hp,
        hp: st.hp,
        atk: st.atk,
        def: st.def,
        spd: st.spd,
        skillMax: st.skillMax,
                skill: Math.round(st.gaugeGain * 2), // start with some gauge
        gaugeGain: st.gaugeGain,
        buffs: [],
        counts: { subsidy: 0, restructure: 0 } // Action counters
      };
    }

    function addBuff(target, buff){
      // if same key exists, refresh stronger / longer
      const ex = target.buffs.find(b=>b.key===buff.key);
      if(ex){
        ex.turns = Math.max(ex.turns, buff.turns);
        ex.meta = {...ex.meta, ...buff.meta};
        ex.name = buff.name;
      } else {
        target.buffs.push({...buff});
      }
    }

    function tickBuffs(target){
      for(const b of target.buffs){
        b.turns -= 1;
      }
      target.buffs = target.buffs.filter(b=>b.turns>0);
    }

    function getBuffValue(target, key, field, defVal=0){
      const b = target.buffs.find(x=>x.key===key);
      if(!b) return defVal;
      return (b.meta && b.meta[field] != null) ? b.meta[field] : defVal;
    }

    function computeMods(target){
      // aggregate multiplicative-ish modifiers
      let atkM = 1, defM = 1, spdM = 1, critAdd = 0, dr = 0;
      for(const b of target.buffs){
        if(b.meta?.atk) atkM += b.meta.atk;
        if(b.meta?.def) defM += b.meta.def;
        if(b.meta?.spd) spdM += b.meta.spd;
        if(b.meta?.crit) critAdd += b.meta.crit;
        if(b.meta?.dr) dr = Math.max(dr, b.meta.dr);
      }
      return {atkM, defM, spdM, critAdd, dr};
    }

        function damageFormula(attacker, defender, opts={}){
      const modsA = computeMods(attacker);
      const modsD = computeMods(defender);

      // Market Multiplier
      let mktM = 1.0;
      const mkt = state.battle?.market?.cycle || "NORMAL";
      const sec = attacker.company.sector;

      if(mkt === "BULL"){
        if(["Tech","Auto","Industrial","Energy"].includes(sec)) mktM = 1.5;
      } else if(mkt === "BEAR"){
        if(["Pharma","Retail","Telecom"].includes(sec)) mktM = 1.0; // ÂΩ±ÈüøËªΩÊ∏õ
        else mktM = 0.7;
      } else       if(mkt === "TIGHT"){
        if(sec === "Finance") mktM = 1.4;
      }

      // Element Multiplier
      const {mult: eleM, eff} = getElementMult(attacker.company.sector, defender.company.sector);
      const atk = attacker.atk * modsA.atkM * mktM * eleM;
      const def = defender.def * modsD.defM;

      const base = atk * rnd(0.85, 1.15);
      const pierce = opts.pierce ?? 0.0;

      // reduction by DEF; keep it bounded
      const reducedDef = def * (1 - pierce);
      const mitigation = clamp(reducedDef / (reducedDef + 120), 0.10, 0.70); // 10%..70% reduction
      let dmg = base * (1 - mitigation);

      // guard damage reduction
      const dr = Math.max(modsD.dr, opts.forceDR ?? 0);
      dmg = dmg * (1 - clamp(dr, 0, 0.75));

      // skill multiplier
      if(opts.mult) dmg *= opts.mult;

      // crit chance based on SPD advantage + buffs
      const spdA = attacker.spd * modsA.spdM;
      const spdD = defender.spd * modsD.spdM;
      const adv = clamp((spdA - spdD) / 160, -0.10, 0.18);
      const critChance = clamp(0.06 + adv + modsA.critAdd, 0.03, 0.35);
      const isCrit = Math.random() < critChance;

      if(isCrit) dmg *= rnd(1.35, 1.60);

            dmg = Math.round(clamp(dmg, 6, 260));
      return {dmg, isCrit, critChance, eff};
    }

        function applyDot(battle){
      const mkt = battle.market?.cycle || "NORMAL";
      
      for(const side of ["P","C"]){
        const t = side==="P" ? battle.P : battle.C;

        // 1. Market Effects
        if(mkt === "BEAR"){
          // Defensive sectors heal
          if(["Pharma","Retail","Telecom"].includes(t.company.sector)){
            const heal = Math.floor(t.maxHP * 0.05);
            battle.heal(t, heal, "BEAR MKT");
            battle.log(`${battle.nameOf(t)} „ÅØ„Éá„Ç£„Éï„Çß„É≥„Ç∑„ÉñÈäòÊüÑ„Å®„Åó„Å¶Ë≥áÈáëÈÄÄÈÅøÔºÅ <span class="text-emerald-300">+${heal}</span>`);
          }
        } else if(mkt === "TIGHT"){
          // Low Equity Ratio (<30%) takes damage (interest rate burden)
          if(t.company.equity_ratio < 30.0){
            const dmg = Math.floor(t.maxHP * 0.05);
            battle.damage(t, dmg, {isDot:true, fx:"GLITCH"});
            battle.log(`${battle.nameOf(t)} „ÅØÈáëÂà©Ë≤†ÊãÖ„ÅåÂ¢óÂä†ÔºÅ(Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá‰Ωé) <span class="text-amber-300">-${dmg}</span>`);
          }
        }

        // 2. Buff/Debuff DOTs
        const bleed = t.buffs.find(b=>b.key==="bleed");
        if(bleed){
          const dot = bleed.meta?.dot ?? 0.03;
          const amount = Math.max(6, Math.round(t.maxHP * dot));
          battle.damage(t, amount, {label:"PIPELINE DOT", isDot:true});
                    battle.log(`${battle.nameOf(t)} „ÅÆ„Éë„Ç§„Éó„É©„Ç§„É≥ÂúßÂäõ„ÅåÁ∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏ÔºÅ <span class="text-rose-300">-${amount}</span>`);
        }
        // Dividend Logic
        const div = t.buffs.find(b=>b.key==="dividend");
        if(div){
           const gain = Math.floor(t.maxHP * 0.06);
           battle.heal(t, gain, "DIVIDEND");
        }
      }
    }

    function battleCreate(playerCompany, cpuCompany){
      const scaler = buildScaler(state.companies);
      const P = makeFighter(playerCompany, scaler);
      const C = makeFighter(cpuCompany, scaler);

      const battle = {
        scaler,
        P, C,
                turn: 1,
        market: { cycle: "NORMAL", count: 0 },
        paused: false,
        auto: false,
        finished: false,
        winner: null,
        lastAction: null,
                logs: [],
                summons: [],
        hpHistory: [{t:0, p:P.hp, c:C.hp}], // Initial HP
        seed: hashStr(playerCompany.id + "|" + cpuCompany.id + "|" + nowIso()),
        nameOf: (f)=> f.company.name_jp || f.company.name,
        enemyOf: (f)=> (f===P ? C : P),

        addBuff: (t,b)=>addBuff(t,b),

                heal: (t, amount, label="HEAL")=>{
          const prev = t.hp;
          t.hp = clamp(t.hp + amount, 0, t.maxHP);
          const real = t.hp - prev;
          if(real>0){
            battle.showFloat(t, `+${real}`, "good");
            battle.fx(t===P ? "P":"C", "AURA");
            SoundEffects.heal();
            battle.log(`${battle.nameOf(t)} „ÅåË≥áÈáë„ÇíÁ¢∫‰øùÔºà${label}Ôºâ <span class="text-emerald-300">+${real}</span>`);
          }
        },

                damage: (t, amount, meta={})=>{
          const prev = t.hp;
          t.hp = clamp(t.hp - amount, 0, t.maxHP);
          const real = prev - t.hp;
          battle.showFloat(t, `-${real}`, meta.isDot ? "bad" : "bad");
          if(!meta.isDot) battle.fx(t===P ? "P":"C", meta.fx || "IMPACT");
          
          // Camera Shake on heavy damage (>20% maxHP)
          if(real > t.maxHP * 0.20) cameraShake();
          return real;
        },

        spendSkill: (t, cost)=>{ t.skill = clamp(t.skill - cost, 0, t.skillMax); },
        gainSkill: (t, g)=>{ t.skill = clamp(t.skill + g, 0, t.skillMax); },

                        log: (html)=>{
          battle.logs.push({t:Date.now(), html});
          renderLog();
          showBattleToast(html);

          // Ticker News Hook
          // Extract plain text for ticker
          const div = document.createElement("div"); div.innerHTML = html;
          const text = div.textContent || div.innerText || "";
          
          // Keywords to trigger news
          if(html.includes("MARKET SHIFT") || html.includes("NEWS") || html.includes("TOB") || html.includes("VICTORY")){
             showTickerNews(text, 5000);
          }
          else if(html.includes("CRIT") || html.includes("ÂøÖÊÆ∫ÊäÄ") || html.includes("Summon")){
             showTickerNews(text, 3500);
          }
        },

        showFloat: (t, text, tone)=>{
          const arena = $("arena");
          const box = document.createElement("div");
          box.className = "floatDmg";
          box.style.color = tone==="good" ? "rgba(52,211,153,.95)" : "rgba(251,113,133,.95)";
          const side = (t===P) ? "P" : "C";
          const rect = arena.getBoundingClientRect();
          // place near logo
          const target = side==="P" ? $("logoWrapPlayer") : $("logoWrapCPU");
          const tr = target.getBoundingClientRect();
          const x = (tr.left - rect.left) + tr.width*0.55 + rnd(-10, 18);
          const y = (tr.top - rect.top) + tr.height*0.18 + rnd(-6, 8);
          box.style.left = x + "px";
          box.style.top = y + "px";
          box.textContent = text;
          arena.appendChild(box);
          setTimeout(()=>box.remove(), 980);
        },

        ¬† ¬† ¬† ¬† fx: (side, type)=>{
¬† ¬† ¬† ¬† ¬† const arena = $("arena");
¬† ¬† ¬† ¬† ¬† // Reset anims
¬† ¬† ¬† ¬† ¬† arena.classList.remove("flash", "shake", "quake", "glitch-anim");
¬† ¬† ¬† ¬† ¬† void arena.offsetWidth; // trigger reflow

¬† ¬† ¬† ¬† ¬† // --- 1. Screen Animations ---
¬† ¬† ¬† ¬† ¬† if(type==="IMPACT") arena.classList.add("shake");
¬† ¬† ¬† ¬† ¬† if(type==="QUAKE") arena.classList.add("quake");
¬† ¬† ¬† ¬† ¬† if(type==="GLITCH" || type==="ARC"){
¬† ¬† ¬† ¬† ¬† ¬† arena.classList.add("glitch-anim");
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(()=>arena.classList.remove("glitch-anim"), 600);
¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† // --- 2. Color Flash Overlays ---
¬† ¬† ¬† ¬† ¬† let flashColor = null;
¬† ¬† ¬† ¬† ¬† if(type==="NEON" || type==="FLASH_NEON" || type==="ARC") flashColor = "rgba(53,247,255,0.35)";
¬† ¬† ¬† ¬† ¬† if(type==="FLASH_RED") flashColor = "rgba(251,113,133,0.35)";
¬† ¬† ¬† ¬† ¬† if(type==="FLASH_GREEN") flashColor = "rgba(52,211,153,0.3)";

¬† ¬† ¬† ¬† ¬† if(flashColor){
¬† ¬† ¬† ¬† ¬† ¬† const overlay = document.createElement("div");
¬† ¬† ¬† ¬† ¬† ¬† overlay.className = "absolute inset-0 z-20 pointer-events-none transition-opacity duration-500 ease-out opacity-0";
¬† ¬† ¬† ¬† ¬† ¬† overlay.style.background = `radial-gradient(circle, ${flashColor}, transparent)`;
¬† ¬† ¬† ¬† ¬† ¬† arena.appendChild(overlay);
¬† ¬† ¬† ¬† ¬† ¬† requestAnimationFrame(()=>{
¬† ¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.remove("opacity-0"); overlay.classList.add("opacity-100");
¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(()=>{
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.remove("opacity-100"); overlay.classList.add("opacity-0");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(()=>overlay.remove(), 500);
¬† ¬† ¬† ¬† ¬† ¬† ¬† }, 200);
¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† } else if(type!=="QUAKE" && type!=="GLITCH" && !type.startsWith("FLASH")) {
¬† ¬† ¬† ¬† ¬† ¬† // default flash
¬† ¬† ¬† ¬† ¬† ¬† arena.classList.add("flash");
¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† // --- 3. Particles (Confetti) ---
¬† ¬† ¬† ¬† ¬† const x = side==="P" ? 0.28 : side==="C" ? 0.72 : 0.5;
¬† ¬† ¬† ¬† ¬† const y = 0.4;

¬† ¬† ¬† ¬† ¬† if(type==="NEON" || type==="ARC" || type==="GLITCH" || type==="FLASH_NEON"){
¬† ¬† ¬† ¬† ¬† ¬† confetti({particleCount: 65, spread: 60, startVelocity: 35, colors:['#35F7FF', '#A78BFA', '#FFFFFF'], origin: {x,y}});
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† else if(type==="STORM"){
¬† ¬† ¬† ¬† ¬† ¬† confetti({particleCount: 60, spread: 90, startVelocity: 25, gravity:1.5, colors:['#94A3B8', '#475569'], origin: {x,y:0.2}});
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† else if(type==="SPARK" || type==="WAVE"){
¬† ¬† ¬† ¬† ¬† ¬† confetti({particleCount: 45, spread: 45, startVelocity: 30, decay:0.9, colors:['#FBBF24', '#FFFFFF'], origin: {x,y}});
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† else if(type==="MONEY"){
¬† ¬† ¬† ¬† ¬† ¬† confetti({particleCount: 50, spread: 60, startVelocity: 25, gravity:0.8, shapes:['square'], colors:['#34D399'], origin: {x:0.5,y:0.2}});
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† else if(type==="CRASH"){
¬† ¬† ¬† ¬† ¬† ¬† confetti({particleCount: 40, spread: 100, startVelocity: 20, gravity:1.8, colors:['#000000', '#FB7185'], origin: {x:0.5,y:0.2}});
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }
      };

      return battle;
    }

    function renderBuffChips(f, el){
      el.innerHTML = "";
      const mods = computeMods(f);
      // show a tiny derived view; but keep chips for active buffs
      for(const b of f.buffs){
        const chip = document.createElement("div");
        chip.className = "tag";
        chip.textContent = `${b.name}√ó${b.turns}`;
        el.appendChild(chip);
      }
      // show hidden baseline? no.
    }

    function renderBattleUI(){
      const b = state.battle;
      if(!b) return;

      const P = b.P, C = b.C;

            $("battleSubtitle").textContent = `${b.nameOf(P)} vs ${b.nameOf(C)} ‚Ä¢ TURN ${b.turn}`;
      $("turnTag").textContent = b.paused ? "PAUSED" : (b.auto ? "AUTO" : "MANUAL");

            // Market Badge & Tooltip
      const mkt = b.market?.cycle || "NORMAL";
      const mDef = MARKET_CYCLES[mkt];
      
      // Helper to determine effect text
      const getEff = (u) => {
        const s = u.company.sector, e = u.company.equity_ratio;
        if(mkt==="BULL") return ["Tech","Auto","Industrial","Energy"].includes(s) ? "<span class='text-emerald-300'>ATK x1.5 (Â•ΩÊ≥ÅÊÅ©ÊÅµ)</span>" : "<span class='text-slate-500'>ÂΩ±Èüø„Å™„Åó</span>";
        if(mkt==="BEAR") return ["Pharma","Retail","Telecom"].includes(s) ? "<span class='text-emerald-300'>ÂΩ±ÈüøÂõûÈÅø &amp; ÂõûÂæ©</span>" : "<span class='text-rose-300'>ATK x0.7 (‰∏çÊ≥ÅÊâìÊíÉ)</span>";
        if(mkt==="TIGHT") {
          let t=[]; 
          if(s==="Finance") t.push("<span class='text-emerald-300'>ATK x1.4</span>");
          if(e<30) t.push("<span class='text-rose-300'>ÈáëÂà©„ÉÄ„É°„Éº„Ç∏</span>");
          return t.length ? t.join(" & ") : "<span class='text-slate-500'>ÂΩ±Èüø„Å™„Åó</span>";
        }
        return "<span class='text-slate-500'>-</span>";
      };

      const badge = $("marketBadge");
      // Add group/relative for tooltip, cursor-help
      badge.className = `hidden sm:flex group relative items-center gap-1 px-2 py-0.5 rounded border border-slate-600 bg-slate-800 text-[10px] mono ${mDef.color} cursor-help`;
      // Inject HTML with Tooltip
      badge.innerHTML = `
        <span>${mkt==="BULL"?"üìà":mkt==="BEAR"?"üìâ":mkt==="TIGHT"?"üè¶":"üìä"}</span>
        <span>${mDef.name} (${5 - (b.market.count||0)}T)</span>
        
        <div class="absolute top-full left-0 mt-2 w-64 p-3 bg-slate-900/95 backdrop-blur border border-slate-600 rounded-xl shadow-2xl z-50 hidden group-hover:block text-xs text-left">
          <div class="mb-2 border-b border-slate-700 pb-1 font-bold ${mDef.color}">${mDef.desc}</div>
          <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1">
            <div class="text-sky-300 font-bold">YOU</div><div>${getEff(P)}</div>
            <div class="text-rose-300 font-bold">CPU</div><div>${getEff(C)}</div>
          </div>
        </div>
      `;

            // Simple Names with Icons
      const getElIcon = (u) => {
        const el = SECTOR_ELEMENTS[u.company.sector] || "DIGITAL";
        const inf = ELEMENT_ICONS[el];
        return `<i data-lucide="${inf.icon}" class="w-3 h-3 ${inf.color} inline-block mr-1 align-middle"></i>`;
      };
      $("namePlayer").innerHTML = getElIcon(P) + b.nameOf(P);
      $("nameCPU").innerHTML = getElIcon(C) + b.nameOf(C);

      // Logos - Check emptiness to avoid flickering reload
      if(!$(`logoWrapPlayer`).hasChildNodes()) makeLogo($(`logoWrapPlayer`), P.company);
      if(!$(`logoWrapCPU`).hasChildNodes()) makeLogo($(`logoWrapCPU`), C.company);

      // HP Bars
      const pHpPct = clamp((P.hp / P.maxHP) * 100, 0, 100);
      const cHpPct = clamp((C.hp / C.maxHP) * 100, 0, 100);
      $("hpBarPlayer").style.width = `${pHpPct}%`;
      $("hpBarCPU").style.width = `${cHpPct}%`;

      $("hpTextPlayer").textContent = `${P.hp}/${P.maxHP}`;
      $("hpTextCPU").textContent = `${C.hp}/${C.maxHP}`;
      
      // Danger colors logic
      const dangerCol = "linear-gradient(90deg, #FB7185, #F59E0B)";
      const okColP = "linear-gradient(90deg, #06B6D4, #3B82F6)";
      const okColC = "linear-gradient(90deg, #F43F5E, #F59E0B)";
      
      $("hpBarPlayer").style.background = pHpPct < 25 ? dangerCol : okColP;
      $("hpBarCPU").style.background = cHpPct < 25 ? dangerCol : okColC;

      // Skill Bars
      const pSkPct = clamp((P.skill / P.skillMax) * 100, 0, 100);
      const cSkPct = clamp((C.skill / C.skillMax) * 100, 0, 100);
      
      // Player HUD
      $("skBarPlayer").style.width = `${pSkPct}%`;
      $("skTextPlayer").textContent = `${Math.floor(pSkPct)}%`;
      
      // CPU HUD
      $("skBarCPU").style.width = `${cSkPct}%`;
      $("skTextCPU").textContent = `${Math.floor(cSkPct)}%`;

      // Stats
      $("statAtkP").textContent = P.atk;
      $("statDefP").textContent = P.def;
      $("statSpdP").textContent = P.spd;

      $("statAtkC").textContent = C.atk;
      $("statDefC").textContent = C.def;
      $("statSpdC").textContent = C.spd;

      renderBuffChips(P, $("buffsPlayer"));
      renderBuffChips(C, $("buffsCPU"));

            // Commands
      const canAct = !b.finished && !b.paused && !b.auto;
      $("cmdAttack").disabled = !canAct;
      $("cmdGuard").disabled = !canAct;
      $("cmdPivot").disabled = !canAct;

      // --- Strategy Submenu State ---
      const summonCost = (P.company.capital||0) < 3.0 ? 50 : 100;
      const canSkill = canAct && (P.skill >= 60);
      const canSummon = canAct && (P.skill >= summonCost);
      const hasDiv = P.buffs.some(b=>b.key==="dividend");
      const canInvest = canAct && (P.skill >= 40) && !hasDiv;

      // Parent Button Visual
      const stratBtn = $("cmdStrategy");
      if(canSkill || canSummon || canInvest) {
        stratBtn.classList.add("border-emerald-500", "bg-emerald-500/10");
        stratBtn.classList.remove("border-slate-600/50");
      } else {
        stratBtn.classList.remove("border-emerald-500", "bg-emerald-500/10");
        stratBtn.classList.add("border-slate-600/50");
      }
      
      // Sub Buttons
      $("cmdSkill").disabled = !canSkill;
      $("cmdSkill").classList.toggle("opacity-50", !canSkill);

      const btnSummon = $("cmdSummon");
      btnSummon.disabled = !canSummon;
      btnSummon.classList.toggle("opacity-50", !canSummon);

            // Reconstruct Summon Button Content to ensure layout consistency
      let summonSubText = "";
      if(P.company.capital >= 3.0){
        const risk = calcSummonRisk(P, C);
        const riskColor = risk > 40 ? "text-rose-400" : "text-slate-400";
        summonSubText = `<span class="${riskColor}">RISK: ${risk}%</span>`;
      } else {
        summonSubText = `COST: ${summonCost}%`;
      }

      btnSummon.innerHTML = `
        <i data-lucide="megaphone" class="w-4 h-4 text-amber-400"></i>
        <div>
          <div class="mono text-xs font-bold">Summon</div>
          <div class="text-[9px] text-slate-400">${summonSubText}</div>
        </div>
      `;

            const btnInvest = $("cmdInvest");
      btnInvest.disabled = !canInvest;
      btnInvest.classList.toggle("opacity-50", !canInvest);

      const btnRestruct = $("cmdRestructure");
      if(btnRestruct){
        btnRestruct.disabled = !canAct;
        btnRestruct.classList.toggle("opacity-50", !canAct);
      }

            const btnSubsidy = $("cmdSubsidy");
      if(btnSubsidy){
        const used = P.counts.subsidy > 0;
        const canSub = canAct && (P.skill >= 20) && !used;
        btnSubsidy.disabled = !canSub;
        btnSubsidy.classList.toggle("opacity-50", !canSub);
                if(used) btnSubsidy.querySelector(".mono.text-xs").textContent = "Subsidy (Ê∏à)";
        else btnSubsidy.querySelector(".mono.text-xs").textContent = "Subsidy";
      }

      const btnBunshun = $("cmdBunshun");
      if(btnBunshun){
        const canBun = canAct && (P.skill >= 25);
        btnBunshun.disabled = !canBun;
        btnBunshun.classList.toggle("opacity-50", !canBun);
      }

                        // --- TOB Button State ---
      const btnPiv = $("cmdPivot");
      // Reset visual first (basic structure)
      btnPiv.innerHTML = `
        <div class="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center"><i data-lucide="move-right" class="w-5 h-5 text-sky-300"></i></div>
        <div class="flex-1">
          <div class="mono text-sm font-bold text-slate-100">Pivot</div>
          <div class="text-[10px] text-slate-400">‰∫ãÊ•≠Ëª¢Êèõ</div>
        </div>
      `;
      btnPiv.classList.remove("border-amber-500/50", "bg-amber-500/10", "shadow-[0_0_10px_rgba(245,158,11,0.2)]");
      btnPiv.classList.add("w-full"); // Ensure width full on reset

      if(P.skill >= 100){
        // Action Override: TOB
        btnPiv.onclick = () => runTurn("TOB");
        
        // Calc displayed chance
        let chance = 30;
        if((P.company.market_cap||0) < (C.company.market_cap||0)) chance += 25;
        chance -= (C.def * 0.2);
        chance = Math.floor(clamp(chance, 5, 40));

        // Override Visual
        btnPiv.innerHTML = `
          <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center"><i data-lucide="gavel" class="w-5 h-5 text-amber-300"></i></div>
          <div class="flex-1">
            <div class="mono text-sm font-black text-amber-300">TOB CHANCE</div>
            <div class="text-[10px] text-amber-100">ÊàêÂäüÁéá: ${chance}%</div>
          </div>
        `;
        btnPiv.classList.add("border-amber-500/50", "bg-amber-500/10", "shadow-[0_0_10px_rgba(245,158,11,0.2)]");
      } else {
        // Normal Pivot
        btnPiv.onclick = () => runTurn("Pivot");
      }
      if(window.lucide) window.lucide.createIcons();
    }

    function renderLog(){
      const box = $("logBox");
      const b = state.battle;
      if(!b) return;
      box.innerHTML = "";
      const frag = document.createDocumentFragment();
      const logs = b.logs.slice(-120); // keep last
      for(const L of logs){
        const row = document.createElement("div");
        row.className = "panel2 rounded-2xl p-3 text-sm leading-relaxed";
        row.innerHTML = `<div class="mono text-[10px] text-slate-300/70">${new Date(L.t).toLocaleTimeString()}</div>
                         <div class="text-slate-100/90">${L.html}</div>`;
        frag.appendChild(row);
      }
      box.appendChild(frag);
            box.scrollTop = box.scrollHeight;
    }

    function showBattleToast(html){
      const anchor = $("battleToastAnchor");
      if(!anchor) return;
      const el = document.createElement("div");
      el.className = "battle-toast";
      el.innerHTML = html;
      anchor.appendChild(el);
      // Keep only recent toasts
      if(anchor.children.length > 3) anchor.removeChild(anchor.firstChild);
      
      setTimeout(()=>{
        el.style.animation = "toast-out 0.4s ease-in forwards";
        setTimeout(()=>el.remove(), 400);
      }, 3500);
    }

    function cpuChooseAction(b){
      const cpu = b.C;
      const pl = b.P;

      const cpuHpPct = cpu.hp / cpu.maxHP;
      const plHpPct = pl.hp / pl.maxHP;

      const cpuMods = computeMods(cpu);
      const plMods = computeMods(pl);

      // Heuristics
      const canSkill = cpu.skill >= 60;
      const wantGuard = cpuHpPct < 0.35 || (cpuHpPct < 0.5 && pl.skill >= 70);
      const wantSkill = canSkill && (plHpPct < 0.55 || cpuHpPct < 0.55);
      const wantPivot = cpuHpPct >= 0.45 && (cpuMods.atkM < 1.12) && (Math.random() < 0.40);
      
                  // Recovery Logic
      if(cpuHpPct < 0.30 && !cpu.buffs.some(b=>b.key==="morale_down")){
         // „Éî„É≥„ÉÅ„Åã„Å§„Éá„Éê„Éï„Å™„Åó„Å™„Çâ„É™„Çπ„Éà„É©Ê§úË®é
         if(Math.random() < 0.6) return "Restructure";
      }
            if(cpuHpPct < 0.50 && cpu.skill >= 20 && cpu.counts.subsidy === 0){
        // Ê∏õ„Å£„Å¶„Åç„Åü„ÇâË£úÂä©ÈáëÊ§úË®éÔºàÊú™ÂÆüÊñΩ„Å™„ÇâÔºâ
        if(Math.random() < 0.3) return "Subsidy";
      }

      // Invest Logic
      const canInvest = cpu.skill >= 40 && !cpu.buffs.some(b=>b.key==="dividend");
      if(canInvest){
        // HP„Å´‰ΩôË£ï„ÅÇ„Çä(>40%) or R&D‰Ωô„Çä(>80)
        if((cpuHpPct > 0.4 || cpu.skill > 80) && Math.random() < 0.20){
          return "Invest";
        }
      }

            // Summon Logic
      const canSummon = cpu.skill >= 100;
      if(canSummon){
         const isBig = (cpu.company.capital||0) >= 3.0;
         if(isBig){
            // Â§ß‰ºÅÊ•≠: „É™„Çπ„ÇØË®àÁÆó
            const risk = calcSummonRisk(cpu, pl);
            // „É™„Çπ„ÇØ40%‰ª•‰∏ã„Å™„ÇâÁãô„ÅÜ„ÄÅ„Éî„É≥„ÉÅ„Å™„Çâ„Ç§„ÉÅ„Åã„Éê„ÉÅ„Åã
            if(risk <= 40 || (cpuHpPct < 0.2 && Math.random() < 0.6)){
               if(Math.random() < 0.3) return "Summon";
            }
         } else {
            // ‰∏≠Â∞è: Á©çÊ•µÁöÑ„Å´‰Ωø„ÅÜ
            if(Math.random() < 0.35) return "Summon";
         }
      }

            // TOB Logic (CPU)
      if(cpu.skill >= 100){
        let chance = 30;
        if((cpu.company.market_cap||0) < (pl.company.market_cap||0)) chance += 25;
        chance -= (pl.def * 0.2);
        // ÊàêÂäüÁéáÈ´ò„ÇÅ or ËøΩ„ÅÑ„Å§„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„Å™„ÇâÁãô„ÅÜ
        if(chance > 45 || cpuHpPct < 0.25){
           if(Math.random() < 0.4) return "TOB";
        }
      }

      // If under DOT or debuffs, sometimes pivot
      const underPressure = cpu.buffs.some(x=>x.key==="bleed" || x.key==="def_down" || x.key==="spd_down");
      if(underPressure && Math.random() < 0.30) return "Pivot";

      if(wantSkill && Math.random() < 0.75) return "Skill";
      if(wantGuard && Math.random() < 0.70) return "Guard";
      if(wantPivot) return "Pivot";

      // default attack with a little randomness
      return (Math.random() < 0.12 && canSkill) ? "Skill" : "Attack";
    }

            async function runTurn(playerAction){
      const b = state.battle;
      if(!b || b.finished || b.paused) return;

      // --- CLEANUP STRAY VISUALS ---
      // Ââç„Çø„Éº„É≥„ÅÆÊºîÂá∫„ÅßÊ∂à„ÅàÊÆã„Å£„ÅüÂè¨ÂñöË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞ÂâäÈô§ÔºàÁ∂ôÁ∂ö‰∏≠„ÅÆÂè¨ÂñöÁç£„ÅØÈô§„ÅèÔºâ
      const activeEls = (b.summons || []).map(s => s.el);
      const visualSelectors = [
        ".summon-emoji", 
        ".summon-car-enter", 
        ".summon-mob-march", 
        ".summon-influencer-spin",
        ".mob-layer"
      ];
      document.querySelectorAll(visualSelectors.join(",")).forEach(el => {
        if(!activeEls.includes(el)) el.remove();
      });

            const P = b.P, C = b.C;

      // --- MARKET CYCLE UPDATE ---
      b.market.count++;
      if(b.market.count >= 5){
        b.market.count = 0;
        const keys = Object.keys(MARKET_CYCLES);
        // exclude current if possible, or just random
        const next = pick(keys);
        b.market.cycle = next;
        const info = MARKET_CYCLES[next];
        
                        b.log(`<div class="border-y border-slate-600 py-1 my-1 text-center"><span class="tag">MARKET SHIFT</span> <span class="${info.color} font-black">${info.name}</span><br/><span class="text-xs text-slate-300/80">${info.desc}</span></div>`);
        b.fx(null, "WAVE");
        renderBattleUI();
        await sleep(3500);
      }

      // --- MARKET EVENT (Random Occurrence) ---
      if(b.turn > 1 && !b.finished && Math.random() < 0.25){
        const evt = pick(MARKET_EVENTS);
        const effectText = evt.func(b);
        const color = evt.type==="good" ? "text-emerald-300" : "text-rose-300";
                        b.log(`<span class="tag">NEWS</span> <span class="${color}">${evt.name}</span>: ${evt.text}<br/><span class="text-xs text-slate-300/60">‚û• ${effectText}</span>`);
        renderBattleUI();
        await sleep(3500);
      }

      // apply dots at start of turn
      applyDot(b);

      // if someone died by DOT
      if(P.hp<=0 || C.hp<=0){
        return finishBattle();
      }

      // auto-gain gauge each turn
      b.gainSkill(P, P.gaugeGain);
      b.gainSkill(C, C.gaugeGain);

      // Decide order: SPD + small randomness
      const mP = computeMods(P), mC = computeMods(C);
      const spP = P.spd * mP.spdM + rnd(-6, 6);
      const spC = C.spd * mC.spdM + rnd(-6, 6);

      const first = spP >= spC ? "P" : "C";
      const second = first==="P" ? "C" : "P";

      const cpuAction = cpuChooseAction(b);

      b.log(`<span class="mono text-slate-300/75">TURN ${b.turn}</span> ‚Ä¢ ÂÖàÊâã: <b>${first==="P" ? b.nameOf(P) : b.nameOf(C)}</b>`);

      // execute two actions
      const actMap = {P: playerAction, C: cpuAction};

      ¬† ¬† ¬† async function exec(side){
¬† ¬† ¬† ¬† if(b.finished) return;
¬† ¬† ¬† ¬† const user = side==="P" ? P : C;
¬† ¬† ¬† ¬† const enemy = side==="P" ? C : P;
¬† ¬† ¬† ¬† const action = actMap[side];

¬† ¬† ¬† ¬†         // Check Stun
        const isStunned = user.buffs.some(x=>x.key==="stun");
        if(isStunned){
          b.log(`${b.nameOf(user)} „ÅØ<span class="text-rose-300 font-bold">Âñ∂Ê•≠ÂÅúÊ≠¢‰∏≠</span>„ÅßÂãï„Åë„Å™„ÅÑÔºÅ`);
          await sleep(800);
          return;
        }

                        // apply action
        await performAction(b, user, enemy, action, side);
        renderBattleUI();
        await sleep(2800);

¬† ¬† ¬† ¬† if(enemy.hp<=0 || user.hp<=0){
¬† ¬† ¬† ¬† ¬† finishBattle();
¬† ¬† ¬† ¬† }
¬† ¬† ¬† }

      await exec(first);
      await exec(second);

            // tick buffs at end of turn
      if(!b.finished){
        tickBuffs(P);
        tickBuffs(C);
        
                // Update Summons & Minion Attacks
        if(b.summons && b.summons.length > 0){
          const activeSummons = [];
          
          for(const s of b.summons){
            // --- ËøΩÊíÉÂá¶ÁêÜ (Minion Attack) ---
            if(s.turns > 1 && s.owner && s.enemy && s.enemy.hp > 0){
              let dmg = 0;
              let msg = "";
              let color = "text-slate-300";
              
              if(s.type === "POLITICIAN"){
                // ÊîøÊ≤ªÂÆ∂: 1/2 ~ 2/3 „ÅÆÂ®ÅÂäõ
                dmg = Math.floor(s.owner.atk * rnd(0.5, 0.66));
                const attacks = ["‰∫àÁÆóÂßîÂì°‰ºö„ÅÆÁÑ°ÈßÑË©±", "Êñô‰∫≠„Åß„ÅÆÂØÜË´á„Ç¢„Çø„ÉÉ„ÇØ", "Ë£èÈáë„Ç≠„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ", "ÂøñÂ∫¶Âº∑Ë¶Å„Éì„Éº„É†", "Ë®òÊÜ∂„Å´„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„Ç¨„Éº„ÉâÂ¥©„Åó"];
                msg = `Â§ßÁâ©ÊîøÊ≤ªÂÆ∂„ÅÆ ${pick(attacks)}ÔºÅ`;
                color = "text-amber-300";
              }
              else if(s.type === "JFTC"){
                // ÂÖ¨ÂèñÂßî(Êú¨Ê∞ó): 1.1 ~ 1.2ÂÄç „ÅÆÂ®ÅÂäõ
                dmg = Math.floor(s.owner.atk * rnd(1.1, 1.2));
                const attacks = ["‰∏ãË´ãÊ≥ïÁâπÂà•Áõ£Êüª„Åß„ÅÆ„Å§„Çã„Åó„ÅÇ„Åí", "Á´ã„Å°ÂÖ•„ÇäÊ§úÊüª„Åß„ÅÆÂ∞ãÂïè", "ÂÑ™Ë∂äÁöÑÂú∞‰Ωç„ÅÆ‰π±Áî®Ë™çÂÆö", "ÊòØÊ≠£ÂãßÂëä„Çπ„Éû„ÉÉ„Ç∑„É•"];
                msg = `ÂÖ¨Ê≠£ÂèñÂºïÂßîÂì°‰ºö„ÅÆ ${pick(attacks)}ÔºÅ`;
                color = "text-sky-300";
              }
                            else if(s.type === "JFTC_LAZY"){
                // ÂÖ¨ÂèñÂßî(„ÇÑ„ÇãÊ∞ó„Å™„Åó): 0.4ÂÄç‰ª•‰∏ã
                dmg = Math.max(1, Math.floor(s.owner.atk * rnd(0.2, 0.4)));
                const attacks = ["ÂΩ¢ÂºèÁöÑ„Å™Êõ∏È°û„ÉÅ„Çß„ÉÉ„ÇØ", "Áú†„Åù„ÅÜ„Å™„Éí„Ç¢„É™„É≥„Ç∞", "„ÅäÂΩπÊâÄ‰ªï‰∫ã„Ç¢„Çø„ÉÉ„ÇØ"];
                msg = `ÂÖ¨Ê≠£ÂèñÂºïÂßîÂì°‰ºö„ÅÆ ${pick(attacks)}‚Ä¶`;
                color = "text-slate-400";
              }
              else if(s.type === "INFLUENCER"){
                // „Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº: Â∞èÂõûÂæ© Ôºã Â∞è„ÉÄ„É°„Éº„Ç∏
                const actions = [
                  {t:"TikTok„ÅßË¨é„ÉÄ„É≥„ÇπÊ°à‰ª∂", h:0.05, d:0},
                  {t:"„Ç§„É≥„Çπ„Çø„É©„Ç§„Éñ„ÅßÂïÜÂìÅÁ¥π‰ªã", h:0.08, d:0},
                  {t:"‰ªñÁ§æÊØîËºÉÂãïÁîª„ÅßÁÇé‰∏ä„Éû„Éº„Ç±", h:0.04, d:0.15},
                  {t:"„Äå„Åì„Çå„Éû„Ç∏Á•ûÔºÅ„ÄçÈÄ£Âëº", h:0.06, d:0}
                ];
                const act = pick(actions);
                
                // ÂõûÂæ©
                if(act.h > 0){
                   const healVal = Math.floor(s.owner.maxHP * act.h);
                   b.heal(s.owner, healVal, "Êäï„ÅíÈä≠");
                }
                // „ÉÄ„É°„Éº„Ç∏
                if(act.d > 0){
                   dmg = Math.floor(s.owner.atk * act.d);
                }
                msg = `„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº„ÅÆ ${act.t}ÔºÅ`;
                color = "text-fuchsia-300";
              }

              if(dmg > 0){
                b.damage(s.enemy, dmg, {fx: "WAVE"});
                b.log(`<span class="${color} font-bold">‚óÜËøΩÊíÉ</span> ${msg} <span class="text-rose-300">-${dmg}</span>`);
                await sleep(600);
              }
            }

            // --- „Çø„Éº„É≥ÁµåÈÅé & Âéª„ÇäÈöõÂà§ÂÆö ---
            s.turns--;
            if(s.turns <= 0){
              // Âéª„ÇäÈöõ„ÅÆÂ§ßÊäÄ (Finisher)
              let finisher = false;
              
              if(s.type === "POLITICIAN" || s.type === "JFTC"){
                // Á¢∫ÁéáË®àÁÆó: Âü∫Êú¨10% + ÊôÇ‰æ°Á∑èÈ°çÂ∑Æ„Éú„Éº„Éä„Çπ(ÊúÄÂ§ß+20%) = MAX 30%
                const capDiff = Math.abs((s.enemy.company.market_cap||0) - (s.owner.company.market_cap||0));
                const chance = 0.10 + Math.min(0.20, capDiff / 50000);
                
                                if(Math.random() < chance){
                  finisher = true;
                  if(s.type === "POLITICIAN"){
                    // Fix: ÊîøÊ≤ªÂÆ∂Ëá™Ë∫´„Å´ÊîªÊíÉ„É¢„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®
                    const isP = s.owner === b.P;
                    if(s.el){
                      // ÊîªÊíÉÊñπÂêë„Çª„ÉÉ„Éà
                      s.el.style.setProperty("--tx", isP ? "1" : "-1");
                      s.el.style.setProperty("--ty", isP ? "-1" : "1");
                      s.el.style.zIndex = "100"; // ÊúÄÂâçÈù¢„Å∏
                      s.el.style.animation = "none"; // ÊµÆÈÅäÂÅúÊ≠¢
                      void s.el.offsetHeight; // „É™„Éï„É≠„Éº
                      // Á™ÅÈÄ≤„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅ©Áî®
                      s.el.style.animation = "lunge 0.6s ease-in-out";
                    }
                    await sleep(250); // „Éí„ÉÉ„Éà„Çø„Ç§„Éü„É≥„Ç∞Ë™øÊï¥

                    const dmg = Math.floor(s.enemy.maxHP * 0.25);
                    b.fx(null, "CRASH"); b.fx(null, "FLASH_RED");
                    b.damage(s.enemy, dmg, {fx: "QUAKE"});
                    b.log(`<span class="text-amber-300 font-black text-lg">„ÄêÂõΩ‰ºöÊãõËá¥„Äë</span> ÊîøÊ≤ªÂÆ∂„ÅØÂéª„ÇäÈöõ„Å´Áõ∏Êâã„ÇíÊÆ¥„Çä„Å§„Åë„ÄÅÂèÇËÄÉ‰∫∫ÊãõËá¥„Åó„ÅüÔºÅ ÂæπÂ∫ïËøΩÂèä„ÉÄ„É°„Éº„Ç∏ÔºÅ <span class="text-rose-300 font-black">-${dmg}</span>`);
                    
                    await sleep(350); // ‰ΩôÈüª
                  }
                  else if(s.type === "JFTC"){
                    const dmg = Math.floor(s.enemy.maxHP * 0.30);
                    b.fx(null, "GLITCH"); b.fx(null, "FLASH_NEON");
                    b.damage(s.enemy, dmg, {fx: "IMPACT"});
                    b.log(`<span class="text-sky-300 font-black text-lg">„ÄêÂÖ¨Ë°®„Äë</span> ÂßîÂì°‰ºö„ÅØÂéª„ÇäÈöõ„Å´„ÄåÊÇ™Ë≥™„Å™ÈÅïÂèç‰∫ãÂÆü„Äç„ÇíÂÖ¨Ë°®„Åó„ÅüÔºÅ Ê†™‰æ°Êö¥ËêΩ„ÉÄ„É°„Éº„Ç∏ÔºÅ <span class="text-rose-300 font-black">-${dmg}</span>`);
                  }
                  await sleep(1500);
                }
              }

                            if(!finisher && s.type !== "JFTC_LAZY" && s.type !== "INFLUENCER"){
                 b.log(s.type==="POLITICIAN" ? "ÊîøÊ≤ªÂÆ∂„ÅØÈ´òÁ¥öËªä„ÅßÂéª„Å£„Å¶„ÅÑ„Å£„Åü‚Ä¶" : "ÂßîÂì°‰ºö„ÅØË™øÊüª„ÇíÁµÇ„Åà„Å¶Â∏∞Â∫Å„Åó„Åü„ÄÇ");
              }
              if(s.type === "JFTC_LAZY"){
                 b.log("ÂßîÂì°‰ºö„ÅØÂÆöÊôÇ„Å™„ÅÆ„ÅßÂ∏∞„Å£„Åü„ÄÇ");
              }
                        if(s.type === "INFLUENCER"){
             b.log("Â•ëÁ¥ÑÊúüÈñìÁµÇ‰∫Ü„ÄÇ„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº„ÅØÊ¨°„ÅÆÊ°à‰ª∂„Å∏Âêë„Åã„Å£„Åü„ÄÇ");
             document.body.classList.remove("influencer-mode");
             InfluencerBgmEngine.stop();
          }

          // ÂâäÈô§
          if(s.el && s.el.parentNode) s.el.remove();
        } else {
          activeSummons.push(s);
        }
      }
      b.summons = activeSummons;

      // Âè¨Âñö„Åå„Åô„Åπ„Å¶„Å™„Åè„Å™„Å£„ÅüÁû¨Èñì„Å´BGMÊàª„Åô
¬† ¬† ¬† ¬† ¬† if(b.summons.length === 0){
¬† ¬† ¬† ¬† ¬† ¬† ¬†SummonBgmEngine.stop();
             InfluencerBgmEngine.stop();
             document.body.classList.remove("influencer-mode");
¬† ¬† ¬† ¬† ¬† ¬† ¬†             // Fix: iOSÂØæÁ≠ñ„ÅÆ„Åü„ÇÅÂç≥ÊôÇÂæ©Â∏∞
             if(state.isBossBattle) BossAudioEngine.play();
             else AudioEngine.play();
¬† ¬† ¬† ¬† ¬† }
        }

        // Record HP History
        b.hpHistory.push({t:b.turn, p:b.P.hp, c:b.C.hp});

        b.turn += 1;
        renderBattleUI();
      }
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function performAction(b, user, enemy, action, side){
      const userName = b.nameOf(user);
      const enemyName = b.nameOf(enemy);

            // --- ANIMATION SEQUENCE ---
      const spriteUser = side==="P" ? $("spritePlayer") : $("spriteCPU");
      const spriteEnemy = side==="P" ? $("spriteCPU") : $("spritePlayer");
      
      // Summon Visual Cleanup Holder
      let summonEl = null, counterEl = null;

                                                if(action==="Skill"){
        // CUT-IN
        const sName = user.company.skill_name || "Skill";
        showCutIn(side, sName, "ACTIVATING SKILL");
        await sleep(900); // Wait for cut-in
        
        SoundEffects.skill();
        const motion = user.company.motion || "m-smash";
        spriteUser.style.animationName = motion;
        spriteUser.classList.add("skill-anim");
        await sleep(1000);
        spriteUser.style.animationName = "";
        spriteUser.classList.remove("skill-anim");
      } else if(action==="Summon"){
        // CUT-IN
        showCutIn(side, "SUMMON", "CALLING SUPPORT");
        await sleep(900); // Wait for cut-in

        // Âè¨Âñö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÁôªÂ†¥Ôºâ
        SoundEffects.summon();
        b.fx(side, "WAVE");
        await sleep(400);
      }
      else if(action==="Attack" || action==="Pivot"){
        // Standard Attack
        SoundEffects.attack();
        spriteUser.classList.add("atk-anim");
        await sleep(500);
        spriteUser.classList.remove("atk-anim");
      }
            else if(action==="Guard"){
        // Guard Shield
        SoundEffects.guard();
        spriteUser.classList.add("guard-anim");
        setTimeout(()=>spriteUser.classList.remove("guard-anim"), 600);
      }
      else if(action==="Invest"){
        SoundEffects.invest();
        b.spendSkill(user, 40);
        const cost = Math.floor(user.hp * 0.15);
        b.damage(user, cost, {fx:"MONEY"}); // Cost treated as damage visual
        b.addBuff(user, {key:"dividend", name:"DIVIDEND", turns:99, meta:{}});
                b.log(`${userName} „ÅØÊà¶Áï•ÁöÑÊäïË≥á„ÇíÂÆüË°åÔºÅ ${enemyName} „ÅÆÊ†™Âºè„ÇíÂèñÂæó„ÄÇ<br/><span class="text-xs text-slate-400">‰ª£ÂÑü: Ë≥áÈáëÊµÅÂá∫(-${cost}) ‚û° ÂäπÊûú: ÊØé„Çø„Éº„É≥ÈÖçÂΩìÂèéÂÖ•</span>`);
        b.fx(side, "MONEY");
      }
            else if(action==="Restructure"){
        SoundEffects.damage();
        // Increment counter
        user.counts.restructure = (user.counts.restructure || 0) + 1;
        const count = user.counts.restructure;
        
        // Penalties increase significantly: 1st:-20%, 2nd:-50%, 3rd:-80%
        const penalty = Math.min(0.9, 0.2 + (count - 1) * 0.3);
        const penaltyPct = Math.round(penalty * 100);

        const healAmt = Math.floor(user.maxHP * 0.30);
        b.heal(user, healAmt, "RESTRUCT");
        
        b.addBuff(user, {key:"morale_down", name:`MORALE‚Üì${count}`, turns:5, meta:{atk:-penalty, spd:-penalty}});
        b.log(`<span class="text-rose-400 font-bold">„ÄêÊñ≠Ë°å„Äë</span> ${userName} „ÅØ„É™„Çπ„Éà„É©(${count}ÂõûÁõÆ)„ÇíÊï¢Ë°åÔºÅ<br/>Âõ∫ÂÆöË≤ªÂâäÊ∏õ„Åß <span class="text-emerald-300">HP+${healAmt}</span>„ÄÅÁèæÂ†¥„ÅÆÂ£´Ê∞ó„ÅØ<span class="text-rose-300">Ëëó„Åó„Åè‰Ωé‰∏ã(${penaltyPct}%)</span>„Åó„Åü‚Ä¶`);
        b.fx(side, "STORM");
      }
            else if(action==="Subsidy"){
        SoundEffects.invest();
        b.spendSkill(user, 20);
        user.counts.subsidy = 1; // Mark as used
        if(Math.random() < 0.95){
           const healAmt = Math.floor(user.maxHP * 0.20);
           b.heal(user, healAmt, "SUBSIDY");
           b.log(`${userName} „ÅØË£úÂä©Èáë„ÅÆÁî≥Ë´ãÊâãÁ∂ö„Åç„Å´Â•îËµ∞ÔºÅ <span class="text-emerald-300">Ë≥áÈáëË™øÈÅî(+${healAmt})</span><br/><span class="text-xs text-slate-400">ÁÖ©Èõë„Å™Êõ∏È°û‰ΩúÊàê„Å´„Çà„ÇäÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ‚Ä¶</span>`);
           b.addBuff(user, {key:"stun", name:"PAPERWORK", turns:1, meta:{}});
           b.fx(side, "MONEY");
        } else {
           b.log(`${userName} „ÅØË£úÂä©Èáë„ÇíÁî≥Ë´ã„Åó„Åü„Åå‚Ä¶ <span class="text-rose-300">Êõ∏È°û‰∏çÂÇô„Å´„Çà„ÇäÂç¥‰∏ãÔºÅ</span><br/>ÂæíÂä¥„Å´ÁµÇ„Çè„Å£„Åü‚Ä¶(„Ç≤„Éº„Ç∏Ê∂àË≤ª„ÅÆ„Åø)`);
                     b.fx(side, "GLITCH");
        }
      }
      else if(action==="Bunshun"){
        SoundEffects.skill(); // „Ç∑„É£„ÉÉ„Çø„ÉºÈü≥‰ª£„Çè„Çä
        b.spendSkill(user, 25);
        
        // Êïµ„Å´ÊñáÊò•„Çø„Éº„Ç≤„ÉÉ„Éà„Éá„Éê„Éï„Çí‰ªò‰∏é(6„Çø„Éº„É≥)
        b.addBuff(enemy, {key:"bunshun_target", name:"SCOOP", turns:6, meta:{}});
        
        b.log(`${userName} „ÅØ <span class="text-slate-200 font-bold">ÈÄ±ÂàäÊñáÊò•</span> „Å´„Çø„É¨„Ç≥„ÉüÊÉÖÂ†±„Çí„É™„Éº„ÇØÔºÅ<br/><span class="text-xs text-slate-400">Êïµ„ÅÆÊîøÊ≤ªÂÆ∂Âè¨Âñö„É™„Çπ„ÇØ„ÅåÂ¢óÂ§ß(6T)</span>`);
        b.fx(side, "FLASH_NEON");
      }

      const sector = user.company.sector;
      const skillDef = SECTOR_SKILLS[sector] || SECTOR_SKILLS.Tech;
      
      // Helper to trigger hit anim
      const hitEnemy = () => {
         spriteEnemy.classList.add("dmg-anim");
         setTimeout(()=>spriteEnemy.classList.remove("dmg-anim"), 450);
      };

if(action==="Summon"){
        // „Ç≥„Çπ„ÉàÂà§ÂÆö: ‰∏≠Â∞è(Capital<3.0)„ÅØ50„ÄÅÂ§ß‰ºÅÊ•≠„ÅØ100
        const isSmall = (user.company.capital||0) < 3.0;
        b.spendSkill(user, isSmall ? 50 : 100);
        
        // BGMÂàá„ÇäÊõø„Åà („Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„ÉºÂà§ÂÆö)
        const enemyCap = (enemy.company.capital||0);
        const isInfluencer = isSmall && enemyCap < 3.0; // ‰∏≠Â∞è vs ‰∏≠Â∞è = „Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„ÉºÂè¨Âñö

                try {
          AudioEngine.stop();
          BossAudioEngine.stop();
          // iOSÂØæÁ≠ñ: „É¶„Éº„Ç∂„ÉºÊìç‰ΩúÊ®©ÈôêÁ∂≠ÊåÅ„ÅÆ„Åü„ÇÅÂç≥ÊôÇÂàá„ÇäÊõø„Åà
          if(isInfluencer){
            InfluencerBgmEngine.play();
            document.body.classList.add("influencer-mode");
          } else {
            SummonBgmEngine.play();
          }
        } catch(e){}

        const cap = user.company.capital || 0;
        
                        // A. ‰∏≠Â∞è‰ºÅÊ•≠ (Capital < 3.0)
        if(cap < 3.0){
          const oppCap = enemy.company.capital || 0;

          // A-1. ÂØæ Â§ß‰ºÅÊ•≠ (ÂÖ¨Ê≠£ÂèñÂºïÂßîÂì°‰ºö)
          if(oppCap >= 3.0){
            // ÊüªÂØüÂÆò„ÅÆÁæ§„ÇåÊºîÂá∫
            const mobHtml = `
              <div class="text-4xl filter drop-shadow-md animate-bounce" style="animation-delay:0s">üëÆ</div>
              <div class="text-4xl filter drop-shadow-md animate-bounce" style="animation-delay:0.1s">üìã</div>
              <div class="text-4xl filter drop-shadow-md animate-bounce" style="animation-delay:0.2s">üëÆ‚Äç‚ôÄÔ∏è</div>
              <div class="text-4xl filter drop-shadow-md animate-bounce" style="animation-delay:0.3s">üîç</div>
            `;
            summonEl = showSummonVisual(side, "", {customClass:"summon-mob-march", html:mobHtml});
            
            b.log(`${userName} „ÅØ <span class="text-sky-300 font-bold">ÂÖ¨Ê≠£ÂèñÂºïÂßîÂì°‰ºö</span> „ÇíÂè¨ÂñöÔºÅ Â§ßÈáè„ÅÆÊüªÂØüÂÆò„ÅåÂà∞ÁùÄÔºÅ`);
            await sleep(2200);

            // ÂäπÊûú: ‰∏ãË´ãÊ≥ïÁõ£Êüª (STUN)
            let turns = 1 + Math.floor(Math.random() * 2);
            const diff = (enemy.company.market_cap||0) - (user.company.market_cap||0);
            if(diff > 10000) turns += 1;
            if(diff > 50000) turns += 1;
            turns = Math.min(turns, 5);

            b.addBuff(enemy, {key:"stun", name:"AUDIT", turns: turns, meta:{}});
            const dmg = Math.floor(enemy.maxHP * 0.08);
            b.damage(enemy, dmg, {fx:"GLITCH"});
            b.log(`„Äå‰∏ãË´ãÊ≥ïÈÅïÂèç„ÅÆÁñë„ÅÑ„Äç„Å´„Çà„Çä ${b.nameOf(enemy)} „Å´Áõ£Êüª„ÅåÂÖ•„ÇãÔºÅ<br/><span class="text-rose-300">${turns}„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ</span> & „ÉÄ„É°„Éº„Ç∏${dmg}`);
            
            if(Math.random() < 0.4){
              b.addBuff(enemy, {key:"def_down", name:"BAD REP", turns:3, meta:{def:-0.3}});
              b.log(`„Åï„Çâ„Å´ÊÇ™Ë≥™„Å™ÈÅïÂèç„ÇíÂÖ¨Ë°®ÔºÅ ${b.nameOf(enemy)} „ÅÆË©ïÂà§„Ç¨„ÇøËêΩ„Å°(DEF‚Üì)`);
            }

            // Á∂ôÁ∂öË°®Á§∫ÁôªÈå≤ (ÂÖ¨ÂèñÂßî„Çø„Ç§„Éó„ÉªÂØæÂ§ß‰ºÅÊ•≠)
            if(b.summons) b.summons.push({
              el: summonEl, 
              turns: turns + 1, 
              type: "JFTC", 
              owner: user, 
              enemy: enemy
            });
            summonEl = null;

          } 
                    // A-2. ÂØæ ‰∏≠Â∞è‰ºÅÊ•≠ („Éà„ÉÉ„Éó„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº)
          else {
            // „Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„ÉºÊºîÂá∫
            // üíÖ: „Éç„Ç§„É´, üíÉ: „ÉÄ„É≥„Çµ„Éº, üíÑ: „É™„ÉÉ„Éó, ü§≥: Ëá™ÊíÆ„Çä
            const infHtml = `<div class="relative">
              <div class="absolute -top-4 -left-4 text-3xl animate-bounce">‚ú®</div>
              <div class="text-6xl">üíÉ</div>
              <div class="absolute bottom-0 -right-2 text-3xl">ü§≥</div>
            </div>`;
            summonEl = showSummonVisual(side, "", {customClass:"summon-influencer-spin", html:infHtml});
            
            b.fx(side, "FLASH_NEON");
            b.fx(side, "MONEY");
            b.log(`${userName} „ÅØ <span class="text-fuchsia-300 font-bold">„Éà„ÉÉ„Éó„Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº</span> „ÇíÂè¨ÂñöÔºÅ<br/>„ÄåÊ°à‰ª∂ÂãïÁîª„Äç„ÅåSNS„ÅßÊã°Êï£ÈñãÂßãÔºÅ`);
            await sleep(2000);

            // ÂäπÊûú: Viral Buzz (SPD+ATK UP)
            const turns = 3;
            b.addBuff(user, {key:"spd_up", name:"BUZZ", turns: turns, meta:{spd:0.25, atk:0.15}});
            
            ¬† ¬† ¬† ¬† ¬† ¬† // Á∂ôÁ∂öË°®Á§∫ÁôªÈå≤ („Ç§„É≥„Éï„É´„Ç®„É≥„Çµ„Éº„Çø„Ç§„Éó)
¬† ¬† ¬† ¬† ¬† ¬† if(b.summons) b.summons.push({
¬† ¬† ¬† ¬† ¬† ¬† ¬† el: summonEl,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† turns: turns,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: "INFLUENCER",¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† owner: user,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† enemy: enemy
¬† ¬† ¬† ¬† ¬† ¬† });
            // ÊºîÂá∫„É¢„Éº„ÉâÈÅ©Áî®ÂøµÊäº„Åó
            document.body.classList.add("influencer-mode");
            summonEl = null;
          }
        }
                // B. Â§ß‰ºÅÊ•≠ (Capital >= 3.0)
        else {
          // ÈªíÂ°ó„Çä„Éè„Ç§„É§„ÉºÊºîÂá∫
          summonEl = showSummonVisual(side, "üöó", {customClass:"summon-car-enter"});
          const risk = calcSummonRisk(user, enemy);
          b.log(`‰∏ÄÂè∞„ÅÆÈªíÂ°ó„ÇäÈ´òÁ¥öËªä„ÅåÁåõ„Çπ„Éî„Éº„Éâ„Åß‰ºöÂ†¥„Å´Âà∞ÁùÄ‚Ä¶ÔºÅ`);
          await sleep(1600);
          
                    // Ëªä„Åã„ÇâÊîøÊ≤ªÂÆ∂ÁôªÂ†¥ÔºàË¶ÅÁ¥†„ÇíÁΩÆ„ÅçÊèõ„ÅàÔºâ
          summonEl.textContent = "üë¥";
          summonEl.className = "summon-emoji summon-god-aura"; // „ÇØ„É©„Çπ„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊµÆÈÅäÔºÜÁ•û„ÄÖ„É¢„Éº„Éâ„Å∏
          summonEl.style.transform = ""; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Â§âÊï∞„ÇíÊ∂àÂéª
          
          b.log(`${userName} „ÅØËªä„Åã„ÇâÈôç„Çä„Å¶„Åç„Åü <span class="text-amber-300 font-bold">Â§ßÁâ©ÊîøÊ≤ªÂÆ∂</span> „ÇíÊé•ÂæÖÔºÅ<br/><span class="text-xs text-slate-400">(ÁÇé‰∏ä„É™„Çπ„ÇØ: ${risk}%)</span>`);
          await sleep(1200);

          const roll = Math.random() * 100;
          if(roll >= risk){
            // ÊàêÂäü
            b.fx(side, "MONEY");
            const duration = 3 + Math.floor(Math.random()*2);
            b.addBuff(user, {key:"atk_up", name:"DEREG", turns:duration, meta:{atk:0.5}});
            b.addBuff(user, {key:"bleed", name:"DONATION", turns:duration, meta:{dot:0.05}});
            
            let extra = "";
            if(Math.random() < 0.2){
              b.addBuff(enemy, {key:"stun", name:"PRESSURE", turns:1, meta:{}});
              extra = "ÔºÜ Êïµ„ÇíÊÅ´Âñù(1TÂÅúÊ≠¢)ÔºÅ";
            }
            b.log(`ÊîøÊ≤ªÂ∑•‰ΩúÊàêÂäüÔºÅ <span class="text-emerald-300">Ë¶èÂà∂Á∑©ÂíåÊé™ÁΩÆ</span>„ÇíÁç≤ÂæóÔºÅ(ATK1.5ÂÄç)${extra}<br/><span class="text-xs text-slate-400">‰ª£ÂÑü: ÊîøÊ≤ªÁåÆÈáë(ÊØé„Çø„Éº„É≥HP5%Ê∏õ)</span>`);
            
            // Á∂ôÁ∂öË°®Á§∫ÁôªÈå≤ (ÊîøÊ≤ªÂÆ∂„Çø„Ç§„Éó)
            if(b.summons) b.summons.push({
              el: summonEl, 
              turns: duration + 1, 
              type: "POLITICIAN", 
              owner: user, 
              enemy: enemy
            });
            summonEl = null;
          } else {
            // Â§±ÊïóÔºàÁÇé‰∏äÔºâ
            b.fx(side, "CRASH");
            b.fx(side, "FLASH_RED");
            b.log(`<span class="text-rose-400 font-black text-lg">„ÄêÁÇé‰∏ä„Äë</span> ÊîøÊ≤ªÂà©Áî®„ÅåÈú≤Ë¶ãÔºÅSNS„ÅßÊã°Êï£ÔºÅ`);
            await sleep(2000);

            // Â∏ÇÊ∞ëÂõ£‰Ωì„Å´„Çà„ÇãÂåÖÂõ≤ÔºàÁß©Â∫è„ÅÇ„ÇãÊäóË≠∞„Éá„É¢Ôºâ
            const mobContainer = document.createElement("div");
            mobContainer.className = "absolute inset-0 z-50 pointer-events-none mob-layer flex flex-wrap justify-center items-end content-end gap-1 pb-2";
            
            const protesters = ["üë©‚Äçüíº", "üë®‚Äçüíº", "üßë‚Äçüíº"];
            const signs = ["üö´", "üì¢", "üí¢", "üìâ"];
            
            // 3Âàó„Åè„Çâ„ÅÑ„ÅÆÈõÜÂõ£„Çí‰Ωú„Çã
            for(let i=0; i<12; i++){
                const span = document.createElement("div");
                const person = pick(protesters);
                const sign = Math.random() < 0.6 ? pick(signs) : "";
                span.textContent = sign + person;
                span.style.fontSize = rnd(24, 32) + "px";
                span.style.filter = "drop-shadow(0 4px 6px rgba(0,0,0,0.9))";
                // Áß©Â∫è„ÅÇ„Çã„Ç∑„É•„Éó„É¨„Éí„Ç≥„Éº„É´ÔºàÂêåÊúü„Åó„Åü‰∏ä‰∏ãÂãïÔºâ
                span.className = "protest-bob";
                span.style.animationDelay = (i * 0.05) + "s"; // „Çè„Åö„Åã„Å™„Ç¶„Çß„Éº„Éñ
                mobContainer.appendChild(span);
            }
            
            // Ë¶™Ë¶ÅÁ¥†„Å´ËøΩÂä†
            const parent = side==="P" ? $("spritePlayer") : $("spriteCPU");
            parent.appendChild(mobContainer);

            b.log(`Â∏ÇÊ∞ëÂõ£‰Ωì„ÅåÊú¨Á§æÂâç„Å´Êï¥ÂàóÔºÅ Áß©Â∫è„ÅÇ„ÇãÊäóË≠∞„Éá„É¢„ÅåÊ¥ªÂãï„ÇíÈòªÂÆ≥ÔºÅ`);
            
            // „Éö„Éä„É´„ÉÜ„Ç£Âº∑Âåñ
            b.addBuff(user, {key:"atk_down", name:"BOYCOTT", turns:3, meta:{atk:-0.5}});
            b.addBuff(user, {key:"bleed", name:"FIRE", turns:3, meta:{dot:0.12}});
            b.addBuff(user, {key:"spd_down", name:"STUCK", turns:3, meta:{spd:-0.4}});

            if(Math.random() < 0.5){
              b.addBuff(user, {key:"def_down", name:"FLAME", turns:3, meta:{def:-0.3}});
              b.log(`${userName} „ÅÆË¨ùÁΩ™‰ºöË¶ã„ÅåÂ§ßÁÇé‰∏äÔºÅ(DEF‚Üì)`);
            }
            b.log(`${userName} „Å´‰∏çË≤∑ÈÅãÂãï„Å®ÊäóË≠∞„Éá„É¢„ÅåÁô∫ÁîüÔºÅ(ÂÖ®„Çπ„ÉÜ„Éº„Çø„ÇπÂ§ßÂπÖ„ÉÄ„Ç¶„É≥)`);
            
            // Á∂ôÁ∂öË°®Á§∫ÁôªÈå≤
            if(b.summons) b.summons.push({el: mobContainer, turns: 4});
            
            // Â§±ÊïóÊôÇ„ÅÆÊîøÊ≤ªÂÆ∂„ÅØÊ∂à„Åô
            if(summonEl) summonEl.remove();
            summonEl = null;
          }
        }
        await sleep(2000);
        if(summonEl) summonEl.remove();
        if(counterEl) counterEl.remove();
      }
                        else if(action==="Attack"){
        const {dmg, isCrit, eff} = damageFormula(user, enemy, {});
        hitEnemy(); // VISUAL
        if(isCrit) SoundEffects.crit();
        b.damage(enemy, dmg, {fx:"IMPACT"});

        // Determine attack name/desc
        let atkName = "Â∏ÇÂ†¥ÊîªÂã¢";
        let atkDesc = "";
        const c = user.company;
        if(c.attacks && Array.isArray(c.attacks) && c.attacks.length > 0){
            const a = pick(c.attacks);
            atkName = a.name;
            atkDesc = a.desc;
        }

        let effBadge = "";
        if(eff==="great") effBadge = `<span class="text-[10px] px-1 rounded border border-emerald-400 text-emerald-300 mr-1">Effective!</span>`;
        if(eff==="bad") effBadge = `<span class="text-[10px] px-1 rounded border border-slate-500 text-slate-400 mr-1">Resist...</span>`;

        let msg = `${effBadge}${userName} „ÅÆ <b>${atkName}</b>ÔºÅ`;
¬† ¬† ¬† ¬† if(atkDesc) msg += ` <span class="text-[10px] text-slate-300/60">(${atkDesc})</span>`;
¬† ¬† ¬† ¬† if(isCrit) msg = `<span class="text-violet-300 mono font-black">CRIT</span> ` + msg;
¬† ¬† ¬† ¬† msg += `<br/><span class="text-rose-300 font-bold text-lg">-${dmg}</span>`;

¬† ¬† ¬† ¬† b.log(msg);
¬† ¬† ¬† ¬† if(isCrit) b.fx(side, "NEON");
¬† ¬† ¬† }
      else if(action==="Guard"){
        // add guard buff + slight skill gain
        b.addBuff(user, {key:"guard", name:"GUARD", turns:1, meta:{dr:0.45, def:0.12}});
        b.gainSkill(user, 10);
        b.log(`${userName} „ÅåË≤°ÂãôÂõ∫„ÇÅÔºÅ <span class="text-emerald-300">Ë¢´„ÉÄ„É°ËªΩÊ∏õ</span> &amp; <span class="text-sky-300">DEF‚Üë</span>`);
        b.fx(side, "AURA");
      }
                                                      else if(action==="TOB"){
        // --- M&A GAMBLE (TOB) ---
        showCutIn(side, "T.O.B.", "HOSTILE TAKEOVER");
        await sleep(900); // Wait for cut-in
        SoundEffects.pivot();
        if(user.skill >= 100){
          b.spendSkill(user, 100);
          
          // 1. Cost: 20% Current HP (Acquisition Cost)
          const cost = Math.floor(user.hp * 0.20);
          b.damage(user, cost, {fx:"CRASH"});
          b.log(`${userName} „ÅåË≤∑ÂèéÂ∑•‰ΩúË≥áÈáë„ÇíÊäïÂÖ•ÔºÅ <span class="text-rose-300">-${cost}</span>`);

          // 2. Probability Calc
          let chance = 30; // Base
          // Underdog Bonus: Market Cap < Enemy
          if((user.company.market_cap||0) < (enemy.company.market_cap||0)) chance += 25;
          // Defense Penalty: Enemy DEF * 0.2
          chance -= (enemy.def * 0.2);
          // Cap & Floor
          chance = Math.floor(clamp(chance, 5, 40));

          b.log(`${userName} „Åå <span class="text-amber-300 font-black">TOB (ÊïµÂØæÁöÑË≤∑Âèé)</span> „ÇíÂÆ£Ë®ÄÔºÅ<br/><span class="text-xs text-slate-300">ÊàêÂäüÁéá: ${chance}% (ÊïµDEF:${enemy.def} ÂØæÁ≠ñÊ∏à)</span>`);
          
          await sleep(1500);

          // 3. Roll
          const roll = Math.random() * 100;
                              if(roll < chance){
            // SUCCESS: Instant Win

            // --- ÊºîÂá∫Âº∑Âåñ: ÊàêÂäüÁ¢∫ÂÆöÊºîÂá∫ ---
            // „Åæ„ÅöÈñì„Çí‰Ωú„Çã
            await sleep(400);
            b.fx(side, "QUAKE"); // Ë°ùÊíÉ
            await sleep(400);

            // „Éï„É©„ÉÉ„Ç∑„É•ÔºÜ„Ç∞„É™„ÉÉ„ÉÅÈÄ£Êâì
            b.fx(side, "FLASH_NEON");
            b.fx(side, "GLITCH");
            confetti({particleCount: 150, spread: 160, startVelocity: 40, colors:['#FBBF24', '#FFFFFF'], origin: { y: 0.6 }});
            
            // „Éû„Éç„Éº„Ç®„Éï„Çß„ÇØ„ÉàÈÄ£Êâì
            for(let i=0; i<6; i++) setTimeout(()=>b.fx(side, "MONEY"), i*120);

            // --- ACQUISITION VISUALS ---
            // 1. Icon Overwrite (Winner takes all)
            const enemyLogoId = side==="P" ? "logoWrapCPU" : "logoWrapPlayer";
            makeLogo($(enemyLogoId), user.company);

            // 2. Name Change (Merged Entity)
            const enemyNameId = side==="P" ? "nameCPU" : "namePlayer";
            const newName = `${userName}${enemyName}`;
            const elName = $(enemyNameId);
            if(elName) {
              elName.textContent = newName;
              elName.classList.add("text-emerald-300", "shake", "glowText"); // GlowËøΩÂä†
              elName.style.transform = "scale(1.25)"; 
              elName.style.transition = "transform 0.3s ease-out";
              setTimeout(()=>elName.style.transform = "scale(1)", 600);
            }

            // 3. BIG OVERLAY VISUAL („ÉâÊ¥æÊâãÊºîÂá∫„ÅÆÊú¨‰∏∏)
            const arena = $("arena");
            const overlay = document.createElement("div");
            overlay.className = "absolute inset-0 z-50 flex items-center justify-center flex-col bg-slate-900/60 backdrop-blur-[2px] pointer-events-none overflow-hidden";
                        overlay.innerHTML = `
                <div class="relative z-10 text-center">
                    <div class="text-7xl sm:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 via-amber-400 to-amber-600 drop-shadow-[0_0_35px_rgba(245,158,11,0.8)] animate-[pop_0.4s_cubic-bezier(0.34,1.56,0.64,1)_forwards]" style="text-shadow: 0 4px 0 #78350f;">
                        M&A
                    </div>
                    <div class="text-4xl sm:text-5xl font-black text-white mt-2 tracking-widest drop-shadow-[0_0_20px_rgba(53,247,255,0.6)] animate-[pop_0.4s_cubic-bezier(0.34,1.56,0.64,1)_0.15s_both]">
                        COMPLETE
                    </div>
                </div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(245,158,11,0.3),transparent_70%)] animate-pulse"></div>
            `;
            arena.appendChild(overlay);
            setTimeout(()=>overlay.remove(), 5000);

            b.damage(enemy, enemy.maxHP + 99999, {fx:"NEON"}); // Overkill
            
            b.log(`<span class="text-emerald-300 font-black text-xl border-b border-emerald-500/50 pb-1 mb-1 block">TOBÊàêÁ´ãÔºÅÂÆåÂÖ®ÂãùÂà©ÔºÅ</span>${b.nameOf(enemy)} „ÇíÂÆåÂÖ®Â≠ê‰ºöÁ§æÂåñ„ÄÇ<br/><span class="text-xs text-slate-300">Êñ∞Á§æÂêç„Äå${newName}„Äç„Å®„Åó„Å¶„Éñ„É©„É≥„ÉâÁµ±ÂêàÂÆå‰∫Ü„ÄÇ</span>`);
            
                        // „Éï„Ç£„Éä„Éº„É¨„ÅÆÁ¥ôÂêπÈõ™ (ÈÅÖÂª∂„Åï„Åõ„Å¶„Ç™„Éº„Éê„Éº„É¨„Ç§„Å®Âêà„Çè„Åõ„Çã)
            setTimeout(()=>{
                confetti({particleCount: 300, spread: 100, startVelocity: 55, gravity: 0.8, colors:['#FBBF24', '#34D399', '#35F7FF'], origin:{y:0.55}});
            }, 300);

                        // ÊºîÂá∫ÂæÖ„Å° („Éà„Éº„Çπ„Éà„Çí„Åò„Å£„Åè„ÇäË™≠„Åæ„Åõ„Çã„Åü„ÇÅÂ§ßÂπÖÂª∂Èï∑)
            await sleep(7000);

          } else {
            // FAIL: Poison Pill Damage
            b.fx(side, "CRASH"); b.fx(side, "FLASH_RED");
            const penalty = Math.floor(user.maxHP * 0.5);
            b.damage(user, penalty, {fx:"QUAKE"});
            user.skill = 0; // Gauge Lost
            b.log(`<span class="text-rose-300 font-black text-xl">TOBÂ§±Êïó‚Ä¶</span><br/>„Éù„Ç§„Ç∫„É≥„Éî„É´Áô∫ÂãïÔºÅ ${userName} „ÅØÂ§ßÊâìÊíÉ„ÇíÂèó„Åë„Åü„ÄÇ<span class="text-rose-300">-${penalty}</span>`);
          }
                } else {
          b.log(`${userName} „ÅØTOB„ÇíË©¶„Åø„Åü„Åå„ÄÅÁõ¥Ââç„ÅßË≥áÈáë(R&D)„Åå‰∏çË∂≥„Åó„Åü‚Ä¶`);
        }
      }
      else if(action==="Pivot"){
          // Normal Pivot (Always)
          SoundEffects.pivot();
          b.addBuff(user, {key:"pivot", name:"PIVOT", turns:3, meta:{atk:0.18, spd:0.16, def:-0.08}});
          b.gainSkill(user, 14);
          b.log(`${userName} „Åå‰∫ãÊ•≠Ëª¢ÊèõÔºÅ <span class="text-sky-300">ATK‚Üë SPD‚Üë</span>ÔºàÁü≠ÊúüÔºâ`);
          b.fx(side, "GLITCH");
      }
      else       if(action==="Skill"){
        const cost = 60;
        if(user.skill < cost){
          // fallback attack
          const {dmg} = damageFormula(user, enemy, {});
          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx:"IMPACT"});
          b.log(`${userName} „ÅØË≥áÊ∫ê‰∏çË∂≥‚Ä¶‰ª£„Çè„Çä„Å´ÊîªÂã¢ÔºÅ <span class="text-rose-300">-${dmg}</span>`);
          return;
        }
        b.spendSkill(user, cost);

        // CHECK COMBO SKILL FIRST
        const comboKey = `${user.company.sector}_${enemy.company.sector}`;
        const combo = COMBO_SKILLS[comboKey];

        if(combo){
          // Combo Execution
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: combo.mult, pierce: 0.1});
          let extraMsg = "";
          
          // Drain
          if(combo.drain){
             const absorb = Math.round(dmg * combo.drain);
             b.heal(user, absorb, "DRAIN");
             extraMsg += ` / Âê∏Âèé+${absorb}`;
          }
          // Gauge Gain
          if(combo.gauge) b.gainSkill(user, combo.gauge);
          // Gauge Drain
          if(combo.gaugeEnemy) b.gainSkill(enemy, combo.gaugeEnemy);
          // Buff/Debuff
          if(combo.buff) b.addBuff(user, {key:combo.buff.key, name:"COMBO+", turns:3, meta:{[combo.buff.key.replace("_up","")]: combo.buff.val}});
          if(combo.debuff) b.addBuff(enemy, {key:combo.debuff.key, name:"COMBO-", turns:3, meta:{[combo.debuff.key.replace("_down","")]: combo.debuff.val}});

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: combo.fx || "NEON"});
          b.log(`${userName} „ÅÆ<span class="text-amber-300 font-bold">Ê•≠Áïå„Ç≥„É≥„ÉúÊäÄ</span>ÔºÅ <b>${combo.name}</b>ÔºÅ<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${combo.desc}${extraMsg})</span>`);
          b.fx(side, combo.fx || "NEON");

        } else {
          // --- COMPANY UNIQUE SKILL ---
          // Load skill data from company object, fallback to archetype default
          const sType = user.company.skill_type || "BURST";
          const arch = SKILL_ARCHETYPES[sType] || SKILL_ARCHETYPES["BURST"];
          const sName = user.company.skill_name || "Corporate Strike";
          const sDesc = user.company.skill_desc || arch.desc;

          // Execute Logic based on Archetype
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: arch.mult, pierce: arch.pierce||0});
          let extra = "";

          if(arch.drain){
            const healAmt = Math.floor(dmg * arch.drain);
            b.heal(user, healAmt, "DRAIN");
            extra = " / Âê∏Âèé";
          }
          if(arch.buff){
            b.addBuff(user, {key:arch.buff.key, name:"SKILL+", turns:3, meta:{[arch.buff.key.replace("_up","")]: arch.buff.val}});
            extra = " / Âº∑Âåñ";
          }
          if(arch.debuff){
            b.addBuff(enemy, {key:arch.debuff.key, name:"SKILL-", turns:3, meta:{[arch.debuff.key.replace("_down","")]: arch.debuff.val}});
            extra = " / Âº±‰ΩìÂåñ";
          }

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: arch.fx});
          b.log(`${userName} „ÅÆÂøÖÊÆ∫ÊäÄÔºÅ <b>${sName}</b>ÔºÅ<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${sDesc})</span>`);
          b.fx(side, arch.fx);
        }
      }

      // immediate finish check
      if(enemy.hp<=0 || user.hp<=0){
        // handled in caller
      }
    }

        ¬† ¬† ¬† ¬†     async function finishBattle(){
      // Stop Battle BGM (Both)
      document.body.classList.remove("influencer-mode");
      try { AudioEngine.stop(); } catch(e){}
      try { BossAudioEngine.stop(); } catch(e){}
      try { SummonBgmEngine.stop(); } catch(e){}
      try { InfluencerBgmEngine.stop(); } catch(e){}
      
      const b = state.battle;
      if(!b || b.finished) return;
      b.finished = true;
      const P = b.P, C = b.C;
      b.winner = (P.hp > C.hp) ? "P" : (C.hp > P.hp) ? "C" : "DRAW";
      
      // --- ÊïóÂåóÊºîÂá∫ (Â¥©Â£ä) ---
      if(b.winner !== "DRAW"){
         const loserSprite = b.winner==="P" ? $("spriteCPU") : $("spritePlayer");
         if(loserSprite){
           b.log(`<span class="text-slate-400 font-bold text-lg">ËΩüÈü≥</span> „Å®ÂÖ±„Å´ ${b.winner==="P" ? b.nameOf(C) : b.nameOf(P)} „ÅåÂ¥©„ÇåËêΩ„Å°„Çã‚Ä¶`);
           // „Ç¥„Ç¥„Ç¥„Ç¥Èü≥
           SoundEffects.crumble();
           // ÁîªÈù¢Êè∫„Çå (Èï∑„ÇÅ)
           b.fx(null, "QUAKE");
           setTimeout(()=>b.fx(null, "QUAKE"), 600);
           setTimeout(()=>b.fx(null, "QUAKE"), 1200);
           // Â¥©Â£ä„Ç¢„Éã„É°
           loserSprite.classList.add("collapse-anim");
           // Á†ÇÁÖô„Ç®„Éï„Çß„ÇØ„Éà (Confetti„Åß‰ª£Áî®: ÁÅ∞Ëâ≤)
           const originX = b.winner==="P" ? 0.72 : 0.28;
           confetti({particleCount: 120, spread: 100, startVelocity: 15, gravity: 0.2, colors:['#334155', '#64748b', '#94a3b8', '#000000'], origin: {x:originX, y:0.6}});
           await sleep(2800); // ÊºîÂá∫„ÇíË¶ã„Åõ„Çã
         }
      }

      if(b.winner==="P"){
        b.log(`<span class="mono font-black text-emerald-300">VICTORY</span> ‚Äî ${b.nameOf(P)} „ÅåÂ∏ÇÂ†¥„ÇíÂà∂ÂúßÔºÅ`);
        confetti({particleCount: 160, spread: 70, startVelocity: 42, scalar: 0.95, origin:{x:0.28, y:0.35}});
      } else if(b.winner==="C"){
        b.log(`<span class="mono font-black text-rose-300">DEFEAT</span> ‚Äî ${b.nameOf(C)} „Åå‰∏ªÂ∞éÊ®©„ÇíÊéåÊè°‚Ä¶`);
        confetti({particleCount: 120, spread: 55, startVelocity: 32, scalar: 0.9, origin:{x:0.72, y:0.35}});
      } else {
        b.log(`<span class="mono font-black text-amber-300">DRAW</span> ‚Äî Â∏ÇÂ†¥„ÅØËÜ†ÁùÄ„ÄÇ`);
      }
      renderBattleUI();
      await sleep(2000);
      
      // --- RESULT MUSIC ---
      try { AudioEngine.stop(); } catch(e){}
      try { BossAudioEngine.stop(); } catch(e){}
      
      if(b.winner==="P") FanfareEngine.play();
      else if(b.winner==="C") RequiemEngine.play();
      
      buildResult();
      showScreen(Screens.Result);
    }

    /********************
     * RESULT EXPLAINER
     ********************/
    function buildResult(){
      const b = state.battle;
      if(!b) return;
      const P = b.P, C = b.C;

      const win = b.winner;
      const winner = win==="P" ? P : win==="C" ? C : null;
      const loser  = win==="P" ? C : win==="C" ? P : null;

      $("resultTitle").textContent = win==="DRAW"
        ? `DRAW ‚Äî ${b.nameOf(P)} vs ${b.nameOf(C)}`
        : `${win==="P" ? "YOU WIN" : "YOU LOSE"} ‚Äî ${b.nameOf(P)} vs ${b.nameOf(C)}`;

            // --- HP CHART (Stock Style) ---
      const chartDiv = document.createElement("div");
      chartDiv.className = "md:col-span-3 panel2 rounded-2xl p-4 mb-4 relative overflow-hidden h-[180px] bg-slate-900/50 border border-slate-700/50";
      
      // Generate SVG
      const hist = b.hpHistory;
      const maxVal = Math.max(P.maxHP, C.maxHP) * 1.1;
      const w = 100, h = 100;
      const len = hist.length - 1 || 1;
      
      const pointsP = hist.map((d,i) => `${(i/len)*w},${100 - (d.p/maxVal)*h}`).join(" ");
      const pointsC = hist.map((d,i) => `${(i/len)*w},${100 - (d.c/maxVal)*h}`).join(" ");

      chartDiv.innerHTML = `
        <div class="absolute top-2 left-3 mono text-[10px] text-slate-400 z-10 font-bold">STOCK PRICE (HP) CHART</div>
        <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full opacity-90">
          
          <line x1="0" y1="25" x2="100" y2="25" stroke="rgba(148,163,184,0.1)" stroke-width="0.5" />
          <line x1="0" y1="50" x2="100" y2="50" stroke="rgba(148,163,184,0.1)" stroke-width="0.5" />
          <line x1="0" y1="75" x2="100" y2="75" stroke="rgba(148,163,184,0.1)" stroke-width="0.5" />
          
          <polyline points="${pointsP}" fill="none" stroke="#35F7FF" stroke-width="2" vector-effect="non-scaling-stroke" stroke-linejoin="round" filter="drop-shadow(0 0 4px rgba(53,247,255,0.6))" />
          <polyline points="${pointsC}" fill="none" stroke="#FB7185" stroke-width="2" vector-effect="non-scaling-stroke" stroke-linejoin="round" filter="drop-shadow(0 0 4px rgba(251,113,133,0.6))" />
        </svg>
      `;

      // snapshot
      const snap = $("resultSnapshot");
      snap.innerHTML = "";
      // Insert Chart before snapshot (or after? Layout says snap is col-1, chart should be full width)
      // Let's modify the grid layout dynamically or just append chart to a new container
      // Actually, let's put chart inside resultSnapshot's parent, above the grid.
      const parent = snap.parentElement;
      // Remove old chart if any (re-run safety)
      const oldChart = parent.querySelector(".chart-container");
      if(oldChart) oldChart.remove();
      
      chartDiv.classList.add("chart-container");
      parent.insertBefore(chartDiv, parent.firstChild);

      const rows = [
        {k:"HP (Cash)", p:`${P.maxHP}‚Üí${P.hp}`, c:`${C.maxHP}‚Üí${C.hp}`},
        {k:"ATK (OM)", p:`${P.atk}`, c:`${C.atk}`},
        {k:"DEF (Equity)", p:`${P.def}`, c:`${C.def}`},
        {k:"SPD (Scale)", p:`${P.spd}`, c:`${C.spd}`},
        {k:"R&D Gauge", p:`${P.gaugeGain}/turn`, c:`${C.gaugeGain}/turn`},
      ];
      for(const r of rows){
        const card = document.createElement("div");
        card.className = "panel2 rounded-2xl p-3";
        card.innerHTML = `
          <div class="mono text-[10px] text-slate-300/75">${r.k}</div>
          <div class="mt-1 grid grid-cols-2 gap-2">
            <div class="mono text-sm"><span class="text-sky-300">YOU</span> ${r.p}</div>
            <div class="mono text-sm text-right"><span class="text-violet-300">CPU</span> ${r.c}</div>
          </div>
        `;
        snap.appendChild(card);
      }

      // explainer
      const exp = $("resultExplainer");
      if(win==="DRAW"){
        exp.innerHTML = `
          <div class="text-base font-bold glowText">ÊãÆÊäóÔºàDRAWÔºâ</div>
          <div class="mt-2">
            ‰∏°Á§æ„ÅÆ<strong>Cash(HP)</strong>„Å®<strong>Operating Margin(ATK)</strong>„ÅåËøë„ÅÑ„É¨„É≥„Ç∏„Å´Âèé„Åæ„Çä„ÄÅÊ±∫ÂÆöÊâì„ÅåÂá∫„Å´„Åè„ÅÑÂ±ïÈñã„Åß„Åó„Åü„ÄÇ<br/>
            Ê¨°„ÅØ <span class="kbd">Skill</span> „ÅÆ„Çø„Ç§„Éü„É≥„Ç∞ÔºàR&amp;D„Ç≤„Éº„Ç∏Ôºâ„ÇíÂÖàË™≠„Åø„Åó„Å¶„ÄÅ<strong>Guard‚ÜíSkill</strong> „ÅÆÊµÅ„Çå„Çí‰Ωú„Çã„Å®Âãù„Å°„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ
          </div>
        `;
        return;
      }

      // Key causes (finance perspective)
      const causes = [];
      const dAtk = (winner.atk - loser.atk);
      const dDef = (winner.def - loser.def);
      const dHp  = (winner.maxHP - loser.maxHP);
      const dSk  = (winner.gaugeGain - loser.gaugeGain);
      const dSpd = (winner.spd - loser.spd);

      // choose top 3 by impact heuristic
      const impact = [
        {k:"ATK", v: Math.abs(dAtk), text: dAtk>=0
          ? `Âñ∂Ê•≠Âà©ÁõäÁéá„ÅåÈ´ò„Åè„ÄÅÊîªÂã¢ÔºàATKÔºâ„ÅåÂÑ™‰Ωç„ÄÇ„ÉÄ„É°„Éº„Ç∏ÊúüÂæÖÂÄ§„ÅåÁ©ç„Åø‰∏ä„Åå„Çä„Åæ„Åó„Åü„ÄÇ`
          : `Âñ∂Ê•≠Âà©ÁõäÁéá„ÅßÂä£„Çä„ÄÅÈÄöÂ∏∏ÊîªÊíÉ„ÅßÊäº„ÅóÂàá„Çå„Å™„ÅÑÂ±ÄÈù¢„ÅåÂ§öÁô∫„ÄÇ`},
        {k:"DEF", v: Math.abs(dDef), text: dDef>=0
          ? `Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá„ÅåÈ´ò„Åè„ÄÅÂÆà„ÇäÔºàDEFÔºâ„ÅåÁ°¨„ÅÑ„ÄÇGuard„Å®„ÅÆÁõ∏ÊÄß„ÇÇËâØ„Åè„ÄÅË¢´Âºæ„ÇíÊäëÂà∂„ÄÇ`
          : `Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá„ÅßÂä£„Çä„ÄÅGuard„Åó„Å¶„ÇÇÁÑº„ÅëÁü≥„Å´Ê∞¥„Å´„Å™„Çä„Åå„Å°„ÄÇ`},
        {k:"HP", v: Math.abs(dHp), text: dHp>=0
          ? `ÁèæÈ†êÈáëÔºàCashÔºâ„ÅåÂéö„Åè„ÄÅHP„ÅåÈ´ò„ÅÑ„ÄÇÈï∑ÊúüÊà¶„ÅßÂÑ™‰Ωç„ÄÇ`
          : `ÁèæÈ†êÈáëÔºàCashÔºâ„ÅåËñÑ„Åè„ÄÅ‰∫ãÊïÖÔºàCRIT/SkillÔºâ„ÅßÂ¥©„Çå„ÇÑ„Åô„ÅÑ„ÄÇ`},
        {k:"SKILL", v: Math.abs(dSk), text: dSk>=0
          ? `R&amp;D„ÅåÂéö„Åè„Ç≤„Éº„Ç∏ÂõûÂèé„ÅåÈÄü„ÅÑ„ÄÇSkillÂõûÊï∞„Åß‰∏ªÂ∞éÊ®©„ÇíÊè°„Çä„Åæ„Åó„Åü„ÄÇ`
          : `R&amp;D„ÅåËñÑ„Åè„Ç≤„Éº„Ç∏„ÅåÊ∫ú„Åæ„Çä„Å´„Åè„ÅÑ„ÄÇSkillÂ∑Æ„Åå„Åò„Çè„Åò„ÇèÈüø„Åç„Åæ„Åó„Åü„ÄÇ`},
        {k:"SPD", v: Math.abs(dSpd), text: dSpd>=0
          ? `Ë¶èÊ®°ÔºàSPDÔºâ„Åå‰∏ä„ÅßÂÖàÊâã„ÇíÂèñ„Çä„ÇÑ„Åô„ÅÑ„ÄÇ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Áéá„Å´„ÇÇÂØÑ‰∏é„ÄÇ`
          : `Ë¶èÊ®°ÔºàSPDÔºâ„ÅßÂä£„Çä„ÄÅÂÖàÊâã„ÇíÂèñ„Çâ„Çå„Å¶Â±ïÈñã„ÅåÂæåÊâã„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ„ÄÇ`},
      ].sort((a,b)=>b.v-a.v).slice(0,3);

      for(const it of impact){
        causes.push(`<li class="mt-1">${it.text}</li>`);
      }

      const winnerName = b.nameOf(winner);
      const loserName = b.nameOf(loser);

      const sectorSkill = winner.company.skill_name || "Skill";
      const sectorLabel = winner.company.sector;

      exp.innerHTML = `
        <div class="text-base font-bold glowText">${winnerName} „ÅÆÂãùÂõ†ÔºàË≤°Âãô√óÊà¶Áï•Ôºâ</div>
        <div class="mt-2">
          „Åì„ÅÆ„Éê„Éà„É´„Åß„ÅØ„ÄÅ<strong>${winnerName}</strong> „Åå <span class="tag">${sectorLabel}</span> „ÅÆÁâπÊÄß„ÇíÊ¥ª„Åã„Åó„ÄÅ
          <strong>${sectorSkill}</strong> „ÇíËª∏„Å´ÂÑ™‰Ωç„Çí‰Ωú„Çä„Åæ„Åó„Åü„ÄÇ
        </div>
        <div class="mt-3 panel2 rounded-2xl p-3">
          <div class="mono text-xs text-slate-300/75 mb-2">TOP CAUSES</div>
          <ul class="list-disc pl-5">
            ${causes.join("")}
          </ul>
        </div>
        <div class="mt-3">
          <span class="mono text-slate-300/75">Ê¨°„ÅÆÊîπÂñÑÊ°àÔºö</span><br/>
          ${win==="P"
            ? `Âãù„Å£„ÅüÂÅ¥„ÅØ <strong>Guard„Åß‰∫ãÊïÖ„ÇíÂõûÈÅø ‚Üí Skill„ÅßÊ±∫„ÇÅ„Çã</strong> „ÇíÂæπÂ∫ï„Åô„Çã„Å®ÂÆâÂÆö„Åó„Åæ„Åô„ÄÇ`
            : `Ë≤†„Åë„ÅüÂÅ¥„ÅØ <strong>Â∫èÁõ§Guard„ÅßËÄê„Åà„Å¶„Ç≤„Éº„Ç∏„ÇíË≤Ø„ÇÅ„ÄÅSkillÂõûÊï∞„ÇíÂ¢ó„ÇÑ„Åô</strong> „Å®ÈÄÜËª¢„Åó„ÇÑ„Åô„ÅÑ„Åß„Åô„ÄÇ`
          }
        </div>
      `;
    }

        /********************
     * START / INSPECT
     ********************/
    // Tooltip dictionary
    const STAT_TIPS = {
      HP: "„ÄêÁèæÈ†êÈáë (Cash)„Äë\n‰ºÅÊ•≠„ÅÆ‰ΩìÂäõ„ÄÇ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Çã„Å®Ê∏õÂ∞ë„Åó„ÄÅ0„Å´„Å™„Çã„Å®ÂÄíÁî£ÔºàÊïóÂåóÔºâ„ÄÇ",
      ATK: "„ÄêÂñ∂Ê•≠Âà©ÁõäÁéá (Operating Margin)„Äë\nÊú¨Ê•≠„ÅÆÁ®º„ÅêÂäõ„ÄÇÈ´ò„ÅÑ„Åª„Å©ÊîªÊíÉÂäõ„Åå‰∏ä„Åå„Çä„ÄÅÁõ∏Êâã„ÅÆ„Ç∑„Çß„Ç¢„ÇíÂ•™„ÅÑ„ÇÑ„Åô„ÅÑ„ÄÇ",
      DEF: "„ÄêËá™Â∑±Ë≥áÊú¨ÊØîÁéá (Equity Ratio)„Äë\nË≤°Âãô„ÅÆÂÅ•ÂÖ®ÊÄß„ÄÇÈ´ò„ÅÑ„Åª„Å©Êâì„Åü„ÇåÂº∑„Åè„ÄÅ„ÉÄ„É°„Éº„Ç∏„ÇíËªΩÊ∏õ„Åô„Çã„ÄÇ",
      SPD: "„ÄêÊôÇ‰æ°Á∑èÈ°ç/ÂæìÊ•≠Âì° (Scale)„Äë\n‰ºÅÊ•≠„ÅÆË¶èÊ®°„Å®ÂΩ±ÈüøÂäõ„ÄÇÈ´ò„ÅÑ„Åª„Å©ÂÖàÊâã„ÇíÂèñ„Çä„ÇÑ„Åô„Åè„ÄÅ„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÇÇÂá∫„ÇÑ„Åô„ÅÑ„ÄÇ",
      GAUGE: "„ÄêÁ†îÁ©∂ÈñãÁô∫Ë≤ª (R&D)„Äë\nÂ∞ÜÊù•„Å∏„ÅÆÊäïË≥á„ÄÇÈ´ò„ÅÑ„Åª„Å©„Çπ„Ç≠„É´„Ç≤„Éº„Ç∏„ÅåÊó©„ÅèÊ∫ú„Åæ„Çä„ÄÅÂøÖÊÆ∫ÊäÄ„ÇíÈÄ£Áô∫„Åß„Åç„Çã„ÄÇ"
    };

    function renderStatCard(containerId, c){
      const el = $(containerId);
      if(!el || !c) return;
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      
      const items = [
        {k:"HP", v:st.hp},
        {k:"ATK", v:st.atk},
        {k:"DEF", v:st.def},
        {k:"SPD", v:st.spd},
        {k:"GAUGE", v:"+"+st.gaugeGain},
      ];

      el.innerHTML = items.map(i=>`
        <div class="panel2 rounded-lg p-2 relative group cursor-help">
          <div class="mono text-[9px] text-slate-400/80">${i.k}</div>
          <div class="mono font-black text-base text-slate-200">${i.v}</div>
          
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-lg shadow-xl z-50 hidden group-hover:block text-[10px] text-slate-300 whitespace-pre-wrap leading-tight pointer-events-none">
            ${STAT_TIPS[i.k] || ""}
          </div>
        </div>
      `).join("");
    }

            function updateMenuStats(){
      const p = getCompany($("selPlayer").value);
      const c = getCompany($("selCPU").value);
      renderStatCard("pStatsArea", p);
      renderStatCard("cStatsArea", c);
      
      if($("pDesc")) $("pDesc").textContent = p ? (p.description || "") : "";
      if($("cDesc")) $("cDesc").textContent = c ? (c.description || "") : "";
      
      if(p) makeLogo($("pLogoMenu"), p);
      if(c) makeLogo($("cLogoMenu"), c);
    }
    
            // Render Radar Chart with Tooltips & Animation
    function renderStatCard(containerId, c){
      const el = $(containerId);
      if(!el || !c) return;
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);

      // Size Badge
      const cap = c.capital >= 3.0 ? `<span class="text-amber-300">Â§ß</span>` : `<span class="text-sky-300">Â∞è</span>`;

      // Radar Data
      const stats = [
        {k:"HP", v:st.hp, max:450},
        {k:"ATK", v:st.atk, max:140},
        {k:"DEF", v:st.def, max:140},
        {k:"SPD", v:st.spd, max:140},
        {k:"GAUGE", v:st.gaugeGain, max:25}
      ];
      
      const size = 260; 
      const cx = size/2, cy = size/2 + 5;
      const r = 85;
      
      let polyPoints = "";
      let bgPoints = "";
      const labels = [];
      const tooltips = [];
      
      stats.forEach((s, i) => {
        const angle = (Math.PI * 2 * i / 5) - (Math.PI / 2);
        // Background (Pentagon)
        const bx = cx + r * Math.cos(angle);
        const by = cy + r * Math.sin(angle);
        bgPoints += `${bx},${by} `;

        // Value
        const valR = (Math.min(s.v, s.max) / s.max) * r;
        const px = cx + valR * Math.cos(angle);
        const py = cy + valR * Math.sin(angle);
        polyPoints += `${px},${py} `;
        
        // Label Coords
        const lx = cx + (r + 20) * Math.cos(angle);
        const ly = cy + (r + 14) * Math.sin(angle);
        const anchor = Math.abs(lx - cx) < 5 ? "middle" : (lx > cx ? "start" : "end");

        // SVG Text
        labels.push(`<text x="${lx}" y="${ly}" text-anchor="${anchor}" fill="#94a3b8" font-size="9" font-family="var(--mono)" font-weight="bold" style="pointer-events:none">
          <tspan x="${lx}" dy="-4" fill="#cbd5e1">${s.k}</tspan>
          <tspan x="${lx}" dy="10" fill="#fff" font-weight="800">${s.v}</tspan>
        </text>`);

        // HTML Tooltip overlay (Absolute position based on chart percent)
        const topPct = (ly / size) * 100;
        const leftPct = (lx / size) * 100;
        
        // Tooltip Content
        const tipText = STAT_TIPS[s.k] || "";
        
        tooltips.push(`
          <div class="absolute group z-10 w-16 h-8 flex justify-center items-center cursor-help"
               style="top:${topPct}%; left:${leftPct}%; transform:translate(-50%, -50%);">
             <div class="stat-tooltip absolute bottom-full mb-1 w-48 p-2 bg-slate-900/95 border border-slate-600 rounded-xl shadow-2xl text-[10px] text-slate-300 whitespace-pre-wrap leading-tight z-50 text-left">
               <div class="font-bold text-sky-300 mb-1">${s.k} : ${s.v}</div>${tipText}
             </div>
          </div>
        `);
      });

      el.innerHTML = `
        <div class="col-span-2 sm:col-span-3 flex justify-center items-center py-2 relative h-[240px]">
           
           <div class="absolute inset-0 pointer-events-none">
              <div class="relative w-full h-full" style="width:${size}px; height:${size}px; margin:0 auto; pointer-events:auto;">
                ${tooltips.join("")}
              </div>
           </div>

           <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="overflow-visible" style="filter: drop-shadow(0 0 8px rgba(53,247,255,0.2));">
             <polygon points="${bgPoints}" fill="rgba(30, 41, 59, 0.4)" stroke="rgba(148, 163, 184, 0.2)" stroke-width="1"/>
             <circle cx="${cx}" cy="${cy}" r="${r*0.5}" fill="none" stroke="rgba(148, 163, 184, 0.1)" stroke-width="1"/>
             <polygon points="${polyPoints}" fill="rgba(53, 247, 255, 0.15)" stroke="#35F7FF" stroke-width="2" 
                      class="poly-anim drop-shadow-[0_0_6px_rgba(53,247,255,0.5)]"/>
             ${labels.join("")}
           </svg>

           <div class="absolute top-0 right-0 panel2 rounded-lg p-2 flex flex-col items-center justify-center border border-slate-700/50">
             <div class="mono text-[9px] text-slate-400/80">SIZE</div>
             <div class="mono font-black text-sm">${cap}</div>
           </div>
        </div>
      `;
    }

    function modalShow(title, tag, html){
      $("modalTitle").textContent = title;
      $("modalTag").textContent = tag;
      $("modalBody").innerHTML = html;
      $("modal").classList.remove("hidden");
      $("modal").classList.add("flex");
    }
    function modalHide(){
      $("modal").classList.add("hidden");
      $("modal").classList.remove("flex");
    }

    function openInspectModal(c){
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      const sName = c.skill_name || "Unknown";
      const sDesc = c.skill_desc || "-";
      const sType = c.skill_type || "BURST";
      const html = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="panel2 rounded-2xl p-4">
            <div class="flex items-center gap-3">
              <div class="logoWrap" style="width:84px;height:84px" id="mLogo"></div>
              <div class="min-w-0">
                <div class="font-black text-xl glowText truncate">${c.name_jp || c.name}</div>
                <div class="mono text-xs text-slate-300/75">${c.name} ‚Ä¢ ${c.domain}</div>
                                <div class="mt-1"><span class="tag">${c.sector}</span></div>
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-300 leading-relaxed">${c.description || ""}</div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">CAPITAL (B JPY)</div><div class="mono font-black text-lg">¬•${fmt(c.capital,1)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">CASH (B JPY)</div><div class="mono font-black text-lg">¬•${fmt(c.cash,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">MKT CAP (B JPY)</div><div class="mono font-black text-lg">¬•${fmt(c.market_cap,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">R&amp;D (B JPY)</div><div class="mono font-black text-lg">¬•${fmt(c.rnd,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">OP MARGIN</div><div class="mono font-black text-lg">${fmt(c.operating_margin,1)}%</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">EQUITY</div><div class="mono font-black text-lg">${fmt(c.equity_ratio,1)}%</div></div>
              <div class="panel2 rounded-xl p-2 col-span-2"><div class="mono text-[10px] text-slate-300/75">EMPLOYEES</div><div class="mono font-black text-lg">${fmt(c.employees,0)}</div></div>
            </div>
          </div>

          <div class="panel2 rounded-2xl p-4">
            <div class="mono text-sm text-slate-200/90">GAME STATS</div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">HP</div><div class="mono font-black text-lg">${st.hp}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">ATK</div><div class="mono font-black text-lg">${st.atk}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">DEF</div><div class="mono font-black text-lg">${st.def}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">SPD</div><div class="mono font-black text-lg">${st.spd}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">GAUGE</div><div class="mono font-black text-lg">+${st.gaugeGain}</div></div>
              <div class="panel2 rounded-xl p-2 col-span-3 mt-1 bg-slate-800/50"><div class="mono text-[10px] text-slate-300/75">UNIQUE SKILL</div><div class="mono font-bold text-base text-sky-200">${c.skill_name || sName}</div><div class="text-[10px] text-slate-400 truncate">${c.skill_desc || "-"}</div></div>
          </div>

            ¬† ¬† ¬† ¬† ¬† ¬† <div class="mt-3 panel2 rounded-2xl p-3 text-sm text-slate-200/85 leading-relaxed">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="mono text-xs text-slate-300/75 mb-1">SKILL PROFILE</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† <b>${sName}</b>Ôºö${sDesc}
¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="mt-2 text-xs text-slate-300/70 mono">
                ‚ÄªCash/MarketCap/R&amp;D„ÅØÂØæÊï∞ÂúßÁ∏Æ„Åó„Å¶HP/SPD/„Ç≤„Éº„Ç∏ÈÄüÂ∫¶„Å´ÂèçÊò†„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÊ•µÁ´Ø„Å™Â∑Æ„ÇíÊäë„Åà„Çã„Åü„ÇÅÔºâ„ÄÇ
              </div>
            </div>
          </div>
        </div>
      `;
      modalShow("CORPORATE INTEL", "INSPECT", html);
      setTimeout(()=>makeLogo($("mLogo"), c), 0);
    }

    /********************
     * TOURNAMENT
     ********************/
    function tournamentCreate(){
      const pool = [...state.companies];
      if(pool.length < 8){
        toast("‰ºÅÊ•≠„Åå8Á§æÊú™Ê∫Ä„Åß„Åô„ÄÇAI FORGE„ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "bad");
        return null;
      }
      // pick 8 unique
      const s = seededRand(Date.now() ^ (pool.length<<8));
      pool.sort(()=>s()-0.5);
      const eight = pool.slice(0,8).map(c=>c.id);

      // bracket: qf (4), sf (2), f(1)
      const t = {
        ids: eight,
        qf: [
          {a:eight[0], b:eight[1], w:null},
          {a:eight[2], b:eight[3], w:null},
          {a:eight[4], b:eight[5], w:null},
          {a:eight[6], b:eight[7], w:null},
        ],
        sf: [
          {a:null, b:null, w:null},
          {a:null, b:null, w:null},
        ],
        f: [{a:null, b:null, w:null}],
        champion: null,
        log: []
      };
      return t;
    }

    function bracketHtmlMatch(m, label){
      const a = m.a ? (getCompany(m.a)?.name_jp || getCompany(m.a)?.name) : "‚Äî";
      const b = m.b ? (getCompany(m.b)?.name_jp || getCompany(m.b)?.name) : "‚Äî";
      const w = m.w ? (getCompany(m.w)?.name_jp || getCompany(m.w)?.name) : null;

      return `
        <div class="panel2 rounded-2xl p-3">
          <div class="mono text-[10px] text-slate-300/75">${label}</div>
          <div class="mt-2 grid grid-cols-[1fr_auto_1fr] items-center gap-2">
            <div class="mono text-sm ${w===m.a ? 'text-emerald-300 font-black':''} truncate">${a}</div>
            <div class="mono text-xs text-slate-300/80">vs</div>
            <div class="mono text-sm text-right ${w===m.b ? 'text-emerald-300 font-black':''} truncate">${b}</div>
          </div>
          <div class="mt-2 mono text-xs text-slate-300/70">${w ? `WINNER: <span class="text-emerald-300">${w}</span>` : `PENDING`}</div>
        </div>
      `;
    }

    function renderTournament(){
      const t = state.tournament;
      if(!t){ $("bracketBox").innerHTML = ""; return; }

      // feed forward
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;

      t.f[0].a = t.sf[0].w;
      t.f[0].b = t.sf[1].w;

      t.champion = t.f[0].w;

      const box = $("bracketBox");
      box.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Quarterfinals</div>
            ${t.qf.map((m,i)=>bracketHtmlMatch(m, `QF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Semifinals</div>
            ${t.sf.map((m,i)=>bracketHtmlMatch(m, `SF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Final</div>
            ${bracketHtmlMatch(t.f[0], "FINAL")}
            <div class="panel2 rounded-2xl p-3">
              <div class="mono text-[10px] text-slate-300/75">CHAMPION</div>
              <div class="mt-2 font-black text-xl glowText">${t.champion ? (getCompany(t.champion)?.name_jp || getCompany(t.champion)?.name) : "‚Äî"}</div>
              <div class="mono text-xs text-slate-300/70 mt-1">${t.champion ? "Â∏ÇÂ†¥„ÅÆË¶áËÄÖ„ÅåÁ¢∫ÂÆö„ÄÇ" : "„Åæ„Å†Êú™Á¢∫ÂÆö„ÄÇ"}</div>
            </div>
          </div>
        </div>
      `;

      // tournament log
      $("tLog").innerHTML = t.log.slice(-80).map(x=>`
        <div class="panel2 rounded-2xl p-3 text-sm">
          <div class="mono text-[10px] text-slate-300/70">${x.time}</div>
          <div class="text-slate-100/90">${x.msg}</div>
        </div>
      `).join("");
      $("tLog").scrollTop = $("tLog").scrollHeight;
    }

    function tlog(msg){
      const t = state.tournament;
      if(!t) return;
      t.log.push({time:new Date().toLocaleTimeString(), msg});
      renderTournament();
    }

    function getNextMatch(){
      const t = state.tournament;
      if(!t) return null;

      // QF pending
      for(const m of t.qf){
        if(!m.w) return {round:"qf", m};
      }
      // SF pending if both sides ready
      for(const m of t.sf){
        if(!m.w && m.a && m.b) return {round:"sf", m};
      }
      // Final
      if(!t.f[0].w && t.f[0].a && t.f[0].b) return {round:"f", m:t.f[0]};
      return null;
    }

    function simulateMatch(aId, bId){
      // quick simulation using derived stats and random
      const scaler = buildScaler(state.companies);
      const A = makeFighter(getCompany(aId), scaler);
      const B = makeFighter(getCompany(bId), scaler);

      // simulate up to 30 turns
      for(let t=1;t<=30;t++){
        // dot-like but simplified
        A.skill = clamp(A.skill + A.gaugeGain, 0, 100);
        B.skill = clamp(B.skill + B.gaugeGain, 0, 100);

        const order = (A.spd + rnd(-5,5) >= B.spd + rnd(-5,5)) ? [A,B] : [B,A];
        for(const u of order){
          const e = (u===A)?B:A;
          if(e.hp<=0 || u.hp<=0) break;

          // choose action
          const hpPct = u.hp/u.maxHP;
          let act = "Attack";
          if(u.skill>=60 && (e.hp/e.maxHP<0.6 || hpPct<0.6) && Math.random()<0.7) act="Skill";
          else if(hpPct<0.35 && Math.random()<0.7) act="Guard";
          else if(Math.random()<0.18) act="Pivot";

          if(act==="Guard"){
            addBuff(u,{key:"guard",name:"GUARD",turns:1,meta:{dr:0.45,def:0.12}});
            u.skill = clamp(u.skill+10,0,100);
          } else if(act==="Pivot"){
            addBuff(u,{key:"pivot",name:"PIVOT",turns:3,meta:{atk:0.18, spd:0.16, def:-0.08}});
            u.skill = clamp(u.skill+14,0,100);
          } else if(act==="Skill"){
            u.skill -= 60;
            const {dmg} = damageFormula(u,e,{mult:1.45,pierce:0.05});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          } else {
            const {dmg} = damageFormula(u,e,{});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          }

          // tick at end of each action? keep simple
          tickBuffs(u); tickBuffs(e);
        }
        if(A.hp<=0 || B.hp<=0) break;
      }
      if(A.hp===B.hp) return (Math.random()<0.5)?aId:bId;
      return (A.hp > B.hp) ? aId : bId;
    }

    async function playNextMatchInteractive(){
      const next = getNextMatch();
      if(!next){
        toast("Ê¨°„ÅÆË©¶Âêà„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàÁµÇ‰∫ÜÔºâ„ÄÇ", "good");
        return;
      }
      const {m} = next;
      if(!m.a || !m.b){
        toast("ÂØæÊà¶„Ç´„Éº„Éâ„ÅåÊèÉ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ", "bad");
        return;
      }

      // Start interactive battle: player controls left side automatically? In tournament, we let AUTO run as spectator.
      const A = getCompany(m.a);
      const B = getCompany(m.b);

      // Set battle with A as "player" side but auto
      state.playerId = A.id;
      state.cpuId = B.id;
      startBattle({auto:true, tournamentCtx: {match: m, round: next.round}});
    }

    async function autoSimTournament(){
      const t = state.tournament;
      if(!t) return;

      // QF
      for(const m of t.qf){
        if(!m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`QF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> ‚Üí <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // SF
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;
      for(const m of t.sf){
        if(m.a && m.b && !m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`SF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> ‚Üí <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // Final
      t.f[0].a = t.sf[0].w; t.f[0].b = t.sf[1].w;
      if(t.f[0].a && t.f[0].b && !t.f[0].w){
        t.f[0].w = simulateMatch(t.f[0].a, t.f[0].b);
        tlog(`FINAL: <b>${getCompany(t.f[0].a).name_jp || getCompany(t.f[0].a).name}</b> vs <b>${getCompany(t.f[0].b).name_jp || getCompany(t.f[0].b).name}</b> ‚Üí <span class="text-emerald-300">CHAMPION: ${getCompany(t.f[0].w).name_jp || getCompany(t.f[0].w).name}</span>`);
        confetti({particleCount: 220, spread: 80, startVelocity: 44, scalar: 1.0, origin:{x:0.5, y:0.32}});
      }
      renderTournament();
    }

    /********************
     * LAB (AI FORGE)
     ********************/
    function renderSectorChoices(){
      const box = $("sectorChoices");
      box.innerHTML = "";
      for(const s of SECTORS){
        const b = document.createElement("button");
        b.className = "tag";
        b.textContent = s.key;
        b.dataset.key = s.key;
        b.dataset.on = "1";
        b.style.cursor = "pointer";
        b.onclick = ()=>{
          const on = b.dataset.on === "1";
          b.dataset.on = on ? "0" : "1";
          b.style.borderColor = on ? "rgba(148,163,184,.20)" : "rgba(53,247,255,.35)";
          b.style.background = on ? "rgba(148,163,184,.06)" : "rgba(53,247,255,.08)";
          b.style.color = on ? "rgba(214,226,255,.86)" : "#CFFBFF";
        };
        // default: on
        b.style.borderColor = "rgba(53,247,255,.35)";
        b.style.background = "rgba(53,247,255,.08)";
        b.style.color = "#CFFBFF";
        box.appendChild(b);
      }
    }

    function selectedSectors(){
      return [...$("sectorChoices").querySelectorAll("button")].filter(b=>b.dataset.on==="1").map(b=>b.dataset.key);
    }

    ¬† ¬† ¬† ¬† function generatePrompt(){
¬† ¬† ¬† const count = clamp(parseInt($("labCount").value||"5",10),1,50);
¬† ¬† ¬† const region = $("labRegion").value;
¬† ¬† ¬† const custom = $("labCustom").value.trim();
¬† ¬† ¬† const secs = selectedSectors();

¬† ¬† ¬†                                           const fields = [
        `"name" (Ëã±Ë™ûÁ§æÂêç)`,
        `"name_jp" (Êó•Êú¨Ë™ûÁ§æÂêç)`,
        `"domain" (‰ºÅÊ•≠„Éâ„É°„Ç§„É≥)`,
        `"sector" (‰ª•‰∏ã„Åã„ÇâÈÅ∏Êäû: ${SECTORS.map(s=>s.key).join(", ")})`,
        `"currency" (Âõ∫ÂÆö„Åß "JPY" „Å®„Åô„Çã)`,
        `"capital" (Ë≥áÊú¨Èáë billion JPY)`,
        `"cash" (ÁèæÈ†êÈáë billion JPY)`,
        `"operating_margin" (Âñ∂Ê•≠Âà©ÁõäÁéá %)`,
        `"equity_ratio" (Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá %)`,
        `"market_cap" (ÊôÇ‰æ°Á∑èÈ°ç billion JPY)`,
        `"employees" (ÂæìÊ•≠Âì°Êï∞)`,
        `"rnd" (Á†îÁ©∂ÈñãÁô∫Ë≤ª billion JPY)`,
        `"description" („Åù„ÅÆ‰ºÅÊ•≠„Çí100ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË™¨Êòé)`,
        `"skill_name" („Åù„ÅÆ‰ºÅÊ•≠„ÅÆÂÆüÈöõ„ÅÆË£ΩÂìÅ„ÉªÊäÄË°ì„ÉªÁµåÂñ∂Áî®Ë™û„ÇíÁî®„ÅÑ„Åü„ÄÅ„Éï„Ç°„É≥„Åå„Éã„É§„É™„Å®„Åô„ÇãÂøÖÊÆ∫ÊäÄÂêç)`,
        `"skill_desc" („Åù„ÅÆÊäÄ„Åå„Å™„ÅúÂº∑„ÅÑ„ÅÆ„Åã„ÄÅ‰ºÅÊ•≠„ÅÆÂÆöÊÄßÁöÑ„Å™Âº∑„Åø„ÇÑÊ≠¥Âè≤ËÉåÊôØ„ÇíÁµ°„ÇÅ„ÅüËß£Ë™¨)`,
        `"skill_type" (‰ª•‰∏ã„Åã„ÇâÈÅ∏Êäû: BURST, GUARD, SPEED, DRAIN, DOT, JAM, BUFF)`,
        `"attacks": [ {"name":"ÊîªÊíÉÊäÄÂêç", "desc":"„Åù„ÅÆÊîªÊíÉ„ÅÆ„Éì„Ç∏„Éç„ÇπÁöÑËÉåÊôØ"} ] („Åù„ÅÆ‰ºÅÊ•≠„ÅÆ‰∫ãÊ•≠„ÇÑÁâπÂæ¥„ÇíË°®„ÅôÈÄöÂ∏∏ÊîªÊíÉ„Çí3„Éë„Çø„Éº„É≥Áî®ÊÑè„Åô„Çã)`
      ];

¬† ¬† ¬† const sectorClause = secs.length ? `Ê•≠Á®Æ„ÅØÂèØËÉΩ„Å™„ÇâÊ¨°„Åã„ÇâÂÑ™ÂÖà„Åó„Å¶ÈÅ∏„Å∂: ${secs.join(", ")}` : "Ê•≠Á®Æ„ÅØ„Éê„É©„É≥„Çπ„Çà„ÅèÈÅ∏„Å∂";
¬† ¬† ¬† const regionClause = region==="JP"
¬† ¬† ¬† ¬† ? "Êó•Êú¨‰ºÅÊ•≠„Çí‰∏≠ÂøÉ„Å´"
¬† ¬† ¬† ¬† : region==="GLOBAL"
¬† ¬† ¬† ¬† ¬† ? "Êµ∑Â§ñ„ÅÆÂÆüÂú®‰ºÅÊ•≠„Çí‰∏≠ÂøÉ„Å´"
¬† ¬† ¬† ¬† ¬† : "Êó•Êú¨‰ºÅÊ•≠„Å®Êµ∑Â§ñ‰ºÅÊ•≠„ÇíÊ∑∑„Åú„Å¶";

¬† ¬† ¬† const customClause = custom ? `\n„ÄêËøΩÂä†ÊåáÁ§∫„Äë\n${custom}\n` : "";

¬† ¬† ¬† const prompt = `
„ÅÇ„Å™„Åü„ÅØË≤°Âãô„Éá„Éº„Çø‰ΩúÊàê„ÅÆ„Éó„É≠„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ‰ªïÊßò„Åß„ÄÅÂÆüÂú®‰ºÅÊ•≠„ÅÆ„Çµ„É≥„Éó„É´Ë≤°Âãô„Éá„Éº„Çø„Çí‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
${customClause}
„ÄêÂá∫ÂäõÊù°‰ª∂„Äë
- Âá∫Âäõ„ÅØ„ÄåÁ¥îÁ≤ã„Å™JSONÈÖçÂàó„ÅÆ„Åø„ÄçÔºàMarkdown„Éª„Ç≥„Éº„Éâ„Éï„Çß„É≥„Çπ„ÅØÁ¶ÅÊ≠¢ÔºâÔºàÈáçË¶ÅÔºõ„Çπ„Éû„Éº„Éà„ÇØ„Ç™„Éº„Éà„ÇíÁµ∂ÂØæ„Å´‰Ωø„Çè„Å™„ÅÑÔºâ
- ‰ºÅÊ•≠Êï∞: ${count}Á§æ
- ÂØæË±°: ${regionClause}
- ${sectorClause}
- „Åù„Çå„Åû„Çå„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅØ‰ª•‰∏ã„Éï„Ç£„Éº„É´„Éâ„ÇíÂøÖ„ÅöÂê´„ÇÅ„Çã:
¬† ${fields.map(f=>"¬† - "+f).join("\n")}

„ÄêÈáçË¶ÅÔºöÈÄöË≤®„Å®ÈáëÈ°ç„Å´„Å§„ÅÑ„Å¶„Äë
- ÂØæË±°„Åå„Å©„ÅÆÂõΩ„ÅÆ‰ºÅÊ•≠„Åß„ÅÇ„Å£„Å¶„ÇÇÔºà‰∏≠ÂõΩ„ÄÅÁ±≥ÂõΩ„ÄÅÊ¨ßÂ∑û„Å™„Å©Ôºâ„ÄÅÈáëÈ°ç(cash, market_cap, rnd)„ÅØÂÖ®„Å¶**„ÄåÊó•Êú¨ÂÜÜÔºà10ÂÑÑÂÜÜÂçò‰Ωç/billion JPYÔºâ„Äç„Å´ÁèæÂú®„ÅÆ„É¨„Éº„Éà„ÅßÊèõÁÆó**„Åó„Å¶Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
- currency „ÅØÂøÖ„Åö "JPY" „Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ≥®ÊÑè„Äë
- domain „ÅØ logo.clearbit.com „Åß„É≠„Ç¥ÂèñÂæó„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇÂÖ¨Âºè„Çµ„Ç§„Éà„Å´Ëøë„ÅÑ„Éâ„É°„Ç§„É≥„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
`.trim();

¬† ¬† ¬† return prompt;
¬† ¬† }

    ¬† ¬† function normalizeImportedCompany(x){
¬† ¬† ¬† // Accept flexible keys; ensure required.
¬† ¬† ¬† const name = (x.name || x.name_en || "").toString().trim();
¬† ¬† ¬† const name_jp = (x.name_jp || x.jp || x.nameJa || "").toString().trim();
¬† ¬† ¬† const domain = (x.domain || "").toString().trim().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
¬† ¬† ¬† const sector = (x.sector || "").toString().trim();

¬† ¬† ¬†       function num(v, def=0){
        const n = Number(v);
        return isFinite(n) ? n : def;
      }

      let capital = num(x.capital);
      let cash = num(x.cash);
      let market_cap = num(x.market_cap);

      // CapitalË£úÊ≠£: „ÇÇ„Åócapital„Åå0„Å™„Çâ„ÄÅÊôÇ‰æ°Á∑èÈ°ç„ÅÆ1/100Á®ãÂ∫¶„Çí‰ªÆÁΩÆ„Åç„Åô„Çã(Â§ß‰ºÅÊ•≠Âà§ÂÆö„ÅÆ„Åü„ÇÅ)
      if(capital <= 0 && market_cap > 100) capital = market_cap * 0.01;
¬† ¬† ¬† let rndv = num(x.rnd);

¬† ¬† ¬† const obj = {
        id: x.id ? String(x.id) : `imp-${hashStr(name+"|"+domain+"|"+Date.now()).toString(16)}`,
        name: name || (domain ? domain.split(".")[0].toUpperCase() : "Company"),
        name_jp: name_jp || "",
        domain: domain || "example.com",
                sector: SECTORS.some(s=>s.key===sector) ? sector : "Tech",
        currency: "JPY",
        capital: Math.max(0, capital),
        cash: Math.max(0, cash),
        operating_margin: clamp(num(x.operating_margin, 8), 0, 70),
                equity_ratio: clamp(num(x.equity_ratio, 30), 0, 95),
        market_cap: Math.max(0, market_cap),
        employees: Math.max(0, Math.round(num(x.employees, 10000))),
        rnd: Math.max(0, rndv),
        description: (x.description || "").toString().trim().slice(0, 100),
        
        // Skill Import
¬† ¬† ¬† ¬† skill_name: (x.skill_name || "Corporate Impact").toString().trim(),
¬† ¬† ¬† ¬† skill_desc: (x.skill_desc || "Standard strategic move.").toString().trim(),
¬† ¬† ¬† ¬† skill_type: ["BURST","GUARD","SPEED","DRAIN","DOT","JAM","BUFF"].includes(x.skill_type) ? x.skill_type : "BURST",
¬† ¬† ¬† ¬† // Attacks Import
¬† ¬† ¬† ¬† attacks: Array.isArray(x.attacks) ? x.attacks.map(a=>({
¬† ¬† ¬† ¬† ¬† ¬† name: (a.name||"Attack").toString().trim(),
¬† ¬† ¬† ¬† ¬† ¬† desc: (a.desc||"").toString().trim()
¬† ¬† ¬† ¬† })).slice(0,3) : []
¬† ¬† ¬† };

      return obj;
    }

        async function importJson(){
      let text = $("labJson").value.trim();
      if(!text){
        toast("JSON„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "bad");
        return;
      }

      // AI Artifact Cleaning
      // Remove Markdown code fences if present (```json ... ```)
      text = text.replace(/```json\s*/gi, "").replace(/```\s*/g, "");
      // Replace Smart Quotes (‚Äú ‚Äù) with normal quotes (")
      text = text.replace(/[\u201C\u201D]/g, '"');

      let arr;
      try{
        arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error("not array");
      }catch(e){
        console.error(e);
        toast("JSON„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çπ„Éû„Éº„Éà„ÇØ„Ç™„Éº„ÉàÁ≠â„ÅØËá™ÂãïË£úÊ≠£„Åó„Åæ„Åó„Åü„Åå„ÄÅÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "bad");
        $("dbStatus").textContent = "JSON ERR";
        return;
      }

      ¬† ¬† ¬† const normalized = arr.map(x=>normalizeImportedCompany(x));

      // merge by id (put)
      await dbPutMany(STORE_COMP, normalized);
      await loadCompanies();
      $("dbStatus").textContent = "IMPORTED";
      toast(`IMPORTÂÆå‰∫Ü: ${normalized.length}Á§æ`, "good");
      $("labJson").value = "";
    }

    async function exportAll(){
      const arr = state.companies;
      const json = JSON.stringify(arr, null, 2);
      // show in modal for copy
      modalShow("EXPORT ALL", "JSON", `
        <div class="text-sm text-slate-200/85 mb-2">ÁèæÂú®„ÅÆ‰ºÅÊ•≠„Éó„Éº„É´ÔºàIndexedDBÔºâ„ÇíJSON„ÅßÂá∫Âäõ„Åó„Åæ„Åó„Åü„ÄÇ</div>
        <textarea class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" rows="14">${json.replace(/</g,"&lt;")}</textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2" id="btnCopyExport">
            <i data-lucide="copy" class="w-4 h-4"></i><span class="mono">COPY</span>
          </button>
        </div>
      `);
      lucide.createIcons();
      setTimeout(()=>{
        const btn = $("btnCopyExport");
        if(btn){
          btn.onclick = async ()=>{
            const ok = await copyToClipboard(json);
            toast(ok ? "„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ" : "„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", ok?"good":"bad");
          };
        }
      },0);
    }

    /********************
     * LOAD / INIT
     ********************/
        async function seedIfEmpty(){
      // „Ç≥„Éº„Éâ‰∏ä„ÅÆ‰ºÅÊ•≠„Éá„Éº„Çø„ÇíDB„Å∏Âº∑Âà∂ÂêåÊúüÔºàËøΩÂä†„Åó„Åü‰ºÅÊ•≠„ÇíÂç≥Â∫ß„Å´ÂèçÊò†„Åï„Åõ„Çã„Åü„ÇÅÔºâ
      await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);

      // load settings
      const fx = await metaGet("fx");
      if(fx && typeof fx==="object"){
        state.fx = {...state.fx, ...fx};
      } else {
        await metaSet("fx", state.fx);
      }
    }

    async function loadCompanies(){
      const all = await dbGetAll(STORE_COMP);
      // stable sort by name
      all.sort((a,b)=> (a.name_jp||a.name).localeCompare((b.name_jp||b.name), "ja"));
      state.companies = all;
      $("dbCount").textContent = all.length;
      renderSelects();
      buildTicker();
    }

    function renderSelects(){
      const selP = $("selPlayer");
      const selC = $("selCPU");
      selP.innerHTML = "";
      selC.innerHTML = "";
      for(const c of state.companies){
        const opt1 = document.createElement("option");
        opt1.value = c.id;
        opt1.textContent = companyLabel(c);
        const opt2 = opt1.cloneNode(true);
        selP.appendChild(opt1);
        selC.appendChild(opt2);
      }

      // M&A Selects Update
      const maA = $("selMergeA");
      const maB = $("selMergeB");
      if(maA && maB){
        maA.innerHTML = selP.innerHTML;
        maB.innerHTML = selP.innerHTML;
        if(state.companies.length > 1) maB.selectedIndex = 1;
      }

      // default picks
      if(!state.playerId || !getCompany(state.playerId)){
        state.playerId = state.companies[0]?.id || null;
      }
      if(!state.cpuId || !getCompany(state.cpuId)){
        state.cpuId = state.companies[1]?.id || state.companies[0]?.id || null;
      }
            selP.value = state.playerId;
      selC.value = state.cpuId;

      updateSectorTags();
      updateMenuStats();
    }

    function updateSectorTags(){
      const p = getCompany($("selPlayer").value);
      const c = getCompany($("selCPU").value);
      $("tagYourSector").textContent = p?.sector || "‚Äî";
      $("tagCpuSector").textContent = c?.sector || "‚Äî";
    }

        // Global var for ticker restore
    let _defaultTickerHtml = "";
    let _newsTimer = null;

    function buildTicker(){
      const msgs = [];
      const s = seededRand(Date.now());
      const pool = [...state.companies];
      pool.sort(()=>s()-0.5);
      for(let i=0;i<Math.min(10,pool.length);i++){
        const c = pool[i];
        const bias = (c.operating_margin - 10) * 0.18 + (c.equity_ratio - 30) * 0.06;
        const change = clamp(rnd(-2.0, 2.8) + bias*0.12, -4.9, 6.2);
        const col = change>=0 ? "text-emerald-300" : "text-rose-300";
        msgs.push(`<span class="${col}">${(c.name||"").slice(0,10).toUpperCase()}</span> <span class="text-slate-200/80">Œî</span> <span class="${col}">${change>=0?"+":""}${change.toFixed(2)}%</span>`);
      }
      const track = $("tickerTrack");
      _defaultTickerHtml = (msgs.concat(msgs)).map(m=>`<span class="mx-2">${m}</span>`).join("");
      track.innerHTML = _defaultTickerHtml;
    }

    function showTickerNews(text, duration=3500){
      const box = $("tickerTrack").parentElement;
      const track = $("tickerTrack");
      // Mode Change
      box.classList.add("news-mode");
      track.innerHTML = `<span class="flex items-center gap-3 animate-pulse">üî¥ BREAKING NEWS: ${text}</span>`;
      
      if(_newsTimer) clearTimeout(_newsTimer);
      _newsTimer = setTimeout(()=>{
        box.classList.remove("news-mode");
        track.innerHTML = _defaultTickerHtml;
      }, duration);
    }

    function showCutIn(side, title, subtitle=""){
      const arena = $("arena");
      if(!arena) return;
      const overlay = document.createElement("div");
      overlay.className = "cut-in-overlay";
      
      // Speed lines
      for(let i=0; i<5; i++){
        const line = document.createElement("div");
        line.className = "cut-in-line";
        line.style.top = rnd(0,100)+"%";
        line.style.height = rnd(2,20)+"px";
        line.style.animationDelay = rnd(0,0.2)+"s";
        overlay.appendChild(line);
      }

      // Content
      const content = document.createElement("div");
      content.className = "z-10 text-center transform skew-x-[-10deg]";
      content.innerHTML = `
        <div class="text-xs sm:text-sm text-cyan-200 tracking-[0.3em] font-bold mb-1 opacity-80">${subtitle}</div>
        <div class="text-4xl sm:text-6xl font-black text-white glowText uppercase" style="-webkit-text-stroke:1px rgba(53,247,255,0.5);">${title}</div>
      `;
      overlay.appendChild(content);
      arena.appendChild(overlay);
      setTimeout(()=>overlay.remove(), 900);
    }

    function cameraShake(){
      const arena = $("arena");
      if(!arena) return;
      arena.classList.remove("camera-impact");
      void arena.offsetWidth;
      arena.classList.add("camera-impact");
    }

    /********************
     * ACTIONS
     ********************/
        function randomPickDifferent(currentId){
      const ids = state.companies.map(c=>c.id).filter(id=>id!==currentId);
      return ids.length ? pick(ids) : currentId;
    }

            function generateCityScape(mode='city'){
      const wrap = $("cityScape");
      if(!wrap) return;
      wrap.innerHTML = "";
      const stage = $("arena").querySelector(".battle-stage");
      
      // Reset special classes
      if(stage) stage.classList.remove("space-mode");

      // SPACE MODE (Big Tech Boss)
      if(mode === 'space' && stage){
        stage.classList.add("space-mode");
        // Create Warp Stars
        for(let i=0; i<60; i++){
          const s = document.createElement("div");
          s.className = "warp-star";
          s.style.setProperty("--rot", Math.floor(Math.random()*360)+"deg");
          s.style.animationDelay = (Math.random()*2)+"s";
          s.style.animationDuration = (0.5 + Math.random()*0.8)+"s";
          // Random Colors (Pink/Teal hints)
          const r = Math.random();
          if(r > 0.8) s.style.background = "linear-gradient(to bottom, transparent, #d946ef, transparent)";
          else if(r > 0.6) s.style.background = "linear-gradient(to bottom, transparent, #2dd4bf, transparent)";
          
          wrap.appendChild(s);
        }
        return;
      }

      // --- 1. Generate Dynamic Sky ---
      const sky = document.createElement("div");
      sky.className = "sky-layer";
      const weather = Math.random();
      
      // Type A: Starry Night (50%)
      if(weather < 0.5) {
        for(let i=0; i<70; i++){
          const s = document.createElement("div");
          s.className = "star";
          s.style.setProperty("--x", rnd(0,100)+"%");
          s.style.setProperty("--y", rnd(0,65)+"%");
          s.style.setProperty("--dur", rnd(2,5)+"s");
          s.style.animationDelay = rnd(0,5)+"s";
          sky.appendChild(s);
        }
        // Shooting star
        if(Math.random()<0.6){
           const ss = document.createElement("div");
           ss.className = "shooting-star";
           ss.style.setProperty("--x", rnd(50,90)+"%");
           ss.style.setProperty("--y", rnd(5,30)+"%");
           ss.style.setProperty("--del", rnd(2,10)+"s");
           sky.appendChild(ss);
        }
      }
      // Type B: Cloudy / Foggy (30%)
      else if(weather < 0.8) {
         for(let i=0; i<6; i++){
          const c = document.createElement("div");
          c.className = "cloud";
          c.style.setProperty("--w", rnd(300,600)+"px");
          c.style.setProperty("--h", rnd(150,300)+"px");
          c.style.setProperty("--y", rnd(0,40)+"%");
          c.style.setProperty("--dur", rnd(30,60)+"s");
          c.style.animationDelay = -rnd(0,60)+"s";
          sky.appendChild(c);
        }
        // Faint stars
        for(let i=0; i<20; i++){
          const s = document.createElement("div");
          s.className = "star";
          s.style.setProperty("--x", rnd(0,100)+"%");
          s.style.setProperty("--y", rnd(0,60)+"%");
          s.style.setProperty("--dur", rnd(3,7)+"s");
          s.style.opacity = 0.3;
          sky.appendChild(s);
        }
      }
      // Type C: Cyber Aurora (20%)
      else {
         for(let i=0; i<5; i++){
          const c = document.createElement("div");
          c.className = "cloud";
          // Colorized clouds
          c.style.background = `radial-gradient(closest-side, ${pick(['rgba(53,247,255,0.06)', 'rgba(167,139,250,0.06)'])} , transparent)`;
          c.style.setProperty("--w", rnd(400,800)+"px");
          c.style.setProperty("--h", rnd(100,250)+"px");
          c.style.setProperty("--y", rnd(0,30)+"%");
          c.style.setProperty("--dur", rnd(20,45)+"s");
          c.style.animationDelay = -rnd(0,40)+"s";
          sky.appendChild(c);
        }
        // Glitter
        for(let i=0; i<40; i++){
          const s = document.createElement("div");
          s.className = "star";
          s.style.background = "#35F7FF";
          s.style.boxShadow = "0 0 4px #35F7FF";
          s.style.setProperty("--x", rnd(0,100)+"%");
          s.style.setProperty("--y", rnd(0,60)+"%");
          s.style.setProperty("--dur", rnd(0.5,2)+"s");
          sky.appendChild(s);
        }
      }
      wrap.appendChild(sky);

      // --- 2. Generate Buildings ---
      const count = 45;
      for(let i=0; i<count; i++){
        const b = document.createElement("div");
        b.className = "building";
        // Random properties
        const h = rnd(60, 260); // height
        const w = rnd(20, 80);  // width
        const l = rnd(-15, 115); // left position %
        const dist = rnd(0.5, 1.0); // distance scale factor
        
        b.style.height = `${h * dist}px`;
        b.style.width = `${w * dist}px`;
        b.style.left = `${l}%`;
        b.style.zIndex = Math.floor(dist * 100); // 50-100
        b.style.opacity = dist * 0.85;
        b.style.filter = `blur(${(1-dist)*2.5}px)`;
        
        // Random window lights color
        if(Math.random() > 0.65) {
           b.style.borderTopColor = Math.random()>0.5 ? "rgba(167,139,250,0.5)" : "rgba(53,247,255,0.4)";
        }
        wrap.appendChild(b);
      }
    }

function startBattle({auto=false, tournamentCtx=null}={}){
      MenuAudioEngine.stop(); // Menu BGM Stop
      
      // Clear previous summons if any
      document.querySelectorAll(".summon-emoji").forEach(el => el.remove());
      document.querySelectorAll(".mob-layer").forEach(el => el.remove());

      const p = getCompany(state.playerId);
      const c = getCompany(state.cpuId);
      if(!p || !c){
        toast("‰ºÅÊ•≠„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ", "bad");
        return;
      }
            if(p.id === c.id){
        toast("Âêå„Åò‰ºÅÊ•≠ÂêåÂ£´„ÅØÈÅ∏„Åπ„Åæ„Åõ„Çì„ÄÇ", "bad");
        return;
      }
      
      // Reset Logos to ensure update
      $("logoWrapPlayer").innerHTML = "";
      $("logoWrapCPU").innerHTML = "";
      
      // --- BGM SELECTION (Boss vs Normal) ---
      // If CPU is 3x bigger (Market Cap) OR is in strong sectors (Finance/Energy), play Boss Theme
      const pVal = p.market_cap || 0;
      const cVal = c.market_cap || 0;
      const isBoss = (cVal > pVal * 3) || ['Finance','Energy'].includes(c.sector);
      
      if(isBoss) BossAudioEngine.play();
      else AudioEngine.play();
      
      // Store boss state for stop
      state.isBossBattle = isBoss;

      state.battle = battleCreate(p, c);
      state.battle.logs = [];
      state.battle.turn = 1;
      state.battle.auto = !!auto;
      state.battle.paused = false;
      state.battle.tournamentCtx = tournamentCtx;

            // initial log
      state.battle.log(`<span class="tag">OPENING</span> <b>${p.name_jp || p.name}</b> „ÅåÂá∫ÊíÉ„ÄÇÊïµ„ÅØ <b>${c.name_jp || c.name}</b>„ÄÇ`);
      state.battle.log(`<div class="mt-1 text-xs grid grid-cols-2 gap-2"><div class="text-sky-300">[P] ${p.skill_name}</div><div class="text-rose-300 text-right">[C] ${c.skill_name}</div></div>`);
      
      // Big Tech Boss Battle (Space Background)
      // Google(us-google), Amazon(us-amazon), Meta/FB(us-meta), Apple(us-apple)
      const bigTech = ['us-google', 'us-amazon', 'us-meta', 'us-apple'];
      const isSpace = bigTech.includes(c.id);
      generateCityScape(isSpace ? 'space' : 'city');
      
      // --- APPLY INTRO ANIMATION ---
      const stage = $("arena").querySelector(".battle-stage");
      const spP = $("spritePlayer");
      const spC = $("spriteCPU");
      const huds = $("arena").querySelectorAll(".hud-wrap");

      if(stage) stage.classList.add("intro-camera-mode");
      if(spP) spP.classList.add("intro-sprite-mode");
      if(spC) spC.classList.add("intro-sprite-mode");
      huds.forEach(h => h.classList.add("intro-hud-wait"));

      renderBattleUI();
      showScreen(Screens.Battle);

      // Cleanup classes after animation
      setTimeout(()=>{
        if(stage) stage.classList.remove("intro-camera-mode");
        if(spP) spP.classList.remove("intro-sprite-mode");
        if(spC) spC.classList.remove("intro-sprite-mode");
        huds.forEach(h => h.classList.remove("intro-hud-wait"));
        
        // Landing Impact
        if(state.battle && !state.battle.finished) state.battle.fx(null, "IMPACT");
      }, 2500);

      if(auto){
        toast("AUTOË¶≥Êà¶„É¢„Éº„Éâ", "good");
        runAutoLoop();
      }
    }

        async function runAutoLoop(){
      const b = state.battle;
      if(!b) return;
      while(state.battle === b && !b.finished){
        if(b.paused){ await sleep(200); continue; }
        const act = cpuChooseAction(b); // for player side too, in auto
        await runTurn(act);
        await sleep(600);
      }
      // if tournament context, commit winner to bracket
      if(b?.tournamentCtx && b.finished){
        const {match, round} = b.tournamentCtx;
        const wId = (b.winner==="P") ? state.playerId : (b.winner==="C") ? state.cpuId : (Math.random()<0.5 ? state.playerId : state.cpuId);
        match.w = wId;

        const wn = getCompany(wId)?.name_jp || getCompany(wId)?.name;
        tlog(`${round.toUpperCase()}: <b>${getCompany(match.a).name_jp || getCompany(match.a).name}</b> vs <b>${getCompany(match.b).name_jp || getCompany(match.b).name}</b> ‚Üí <span class="text-emerald-300">WIN: ${wn}</span>`);
        renderTournament();

        // if champion decided
        if(state.tournament?.f?.[0]?.w){
          confetti({particleCount: 240, spread: 85, startVelocity: 44, scalar: 1.05, origin:{x:0.5, y:0.32}});
          tlog(`<span class="mono font-black text-emerald-300">CHAMPION</span> ‚Äî ${getCompany(state.tournament.f[0].w).name_jp || getCompany(state.tournament.f[0].w).name}`);
        }
      }
    }

    /********************
     * RESET / RESTORE
     ********************/
    async function restoreSample(){
      await dbClear(STORE_COMP);
      await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);
      await loadCompanies();
      toast("„Çµ„É≥„Éó„É´„Éá„Éº„Çø„Å´Âæ©ÂÖÉ„Åó„Åæ„Åó„Åü„ÄÇ", "good");
    }

    async function clearDb(){
      await dbClear(STORE_COMP);
      await loadCompanies();
      toast("DB„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ", "bad");
    }

    /********************
     * HOOKS
     ********************/
            function switchLabTab(target){
      ['Gen','Mna','Imp'].forEach(k=>{
        const isT = k===target;
        const btn = $(`tabBtn${k}`);
        const div = $(`tabContent${k}`);
        if(isT){
          div.classList.remove('hidden');
          let color = "text-cyan-300 border-cyan-500/30 shadow-[0_0_10px_rgba(53,247,255,0.2)]";
          if(k==='Mna') color = "text-violet-300 border-violet-500/30 shadow-[0_0_10px_rgba(167,139,250,0.2)]";
          if(k==='Imp') color = "text-emerald-300 border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.2)]";
          btn.className = `flex-1 py-2 rounded-lg text-xs sm:text-sm mono font-bold transition-all bg-slate-800 border ${color}`;
        } else {
          div.classList.add('hidden');
          btn.className = "flex-1 py-2 rounded-lg text-xs sm:text-sm mono font-bold transition-all text-slate-500 hover:text-slate-300 border border-transparent";
        }
      });
    }

    function wire(){
      // Lab Tabs
      if($("tabBtnGen")) $("tabBtnGen").onclick = ()=>switchLabTab('Gen');
      if($("tabBtnMna")) $("tabBtnMna").onclick = ()=>switchLabTab('Mna');
      if($("tabBtnImp")) $("tabBtnImp").onclick = ()=>switchLabTab('Imp');

      // Paste / Clear JSON
      if($("btnPasteJson")){
        $("btnPasteJson").onclick = async ()=>{
          try{
            const text = await navigator.clipboard.readText();
            if(text) $("labJson").value = text;
            else toast("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅåÁ©∫„Åß„Åô","bad");
          }catch(e){ toast("Ë≤º„Çä‰ªò„Åë„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","bad"); }
        };
      }
      if($("btnClearJson")) $("btnClearJson").onclick = ()=> $("labJson").value = "";

            // nav
      // Screenshot
      if($("btnScreenshot")) $("btnScreenshot").onclick = async ()=>{
        const btn = $("btnScreenshot");
        btn.style.opacity = "0.5";
        // toast("ÊíÆÂΩ±‰∏≠...", "info");
        try {
          await new Promise(r=>requestAnimationFrame(r)); // UIÊõ¥Êñ∞ÂæÖ„Å°
          const canvas = await html2canvas(document.body, {
            backgroundColor: "#070A12",
            scale: 2, // È´òÁîªË≥™
            useCORS: true,
            logging: false
          });
          const link = document.createElement("a");
          link.download = `CQ_SHOT_${Date.now()}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();
          toast("‰øùÂ≠ò„Åó„Åæ„Åó„Åü", "good");
        } catch(e){
          console.error(e);
          toast("ÊíÆÂΩ±Â§±Êïó", "bad");
        }
        btn.style.opacity = "1";
      };

      // $("btnGoStart") removed
            if($("btnHelp")) $("btnHelp").onclick = ()=>showScreen(Screens.Help);
      if($("btnHelpBack")) $("btnHelpBack").onclick = ()=>showScreen(Screens.Start);

            if($("btnTechSpecs")) $("btnTechSpecs").onclick = ()=>{
        const specs = `
          <div class="space-y-5 text-xs leading-relaxed text-slate-300 h-[60vh] overflow-y-auto pr-2">
            
            
            <div class="p-4 rounded-xl bg-slate-800/60 border border-slate-700">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="box" class="w-4 h-4 text-sky-400"></i>
                <div class="font-bold text-sky-300 text-sm">ARCHITECTURE & STACK</div>
              </div>
              <p class="mb-2 text-slate-400">Êú¨„Ç¢„Éó„É™„ÅØ„Éì„É´„Éâ„Éó„É≠„Çª„Çπ‰∏çË¶Å„ÅÆ„ÄåÂçò‰∏ÄHTML„Éï„Ç°„Ç§„É´„Äç„Å®„Åó„Å¶Âãï‰Ωú„Åó„Åæ„Åô„ÄÇ„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÂá¶ÁêÜ„ÇíÊåÅ„Åü„Åö„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆÊ©üËÉΩ„ÅÆ„Åø„ÅßÂÆåÁµê„Åô„ÇãPWA(Progressive Web App)„É©„Ç§„ÇØ„Å™Ë®≠Ë®à„Åß„Åô„ÄÇ</p>
              <ul class="list-disc pl-4 space-y-1 text-slate-300 mono text-[11px]">
                <li><span class="text-sky-200">Core:</span> Vanilla JavaScript (ES2020+)</li>
                <li><span class="text-sky-200">Styling:</span> Tailwind CSS (via CDN)</li>
                <li><span class="text-sky-200">Icons:</span> Lucide Icons</li>
                <li><span class="text-sky-200">Persistence:</span> IndexedDB (Local DB)</li>
                <li><span class="text-sky-200">Effects:</span> canvas-confetti, html2canvas</li>
              </ul>
            </div>

            
            <div class="p-4 rounded-xl bg-slate-800/60 border border-slate-700">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="music" class="w-4 h-4 text-rose-400"></i>
                <div class="font-bold text-rose-300 text-sm">PROCEDURAL AUDIO ENGINE</div>
              </div>
              <p class="mb-2 text-slate-400">mp3„ÇÑwav„Å™„Å©„ÅÆÈü≥Â£∞„Ç¢„Çª„ÉÉ„Éà„ÅØ‰∏ÄÂàá‰ΩøÁî®„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<strong>Web Audio API</strong> „ÇíÁõ¥Êé•Âà∂Âæ°„Åó„ÄÅJavaScript„Ç≥„Éº„Éâ„Åã„ÇâÊ≠£Âº¶Ê≥¢„ÉªÁü©ÂΩ¢Ê≥¢„Éª„Éé„Ç§„Ç∫„Çí„É™„Ç¢„É´„Çø„Ç§„É†ÁîüÊàê„Åó„Å¶ÊºîÂ•è„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mono text-[10px]">
                <div class="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                  <div class="text-rose-200 font-bold">BGM Sequencer</div>
                  Oscillators (Saw/Square) + Gain Envelope + Delay „Åß„ÉÅ„ÉÉ„Éó„ÉÅ„É•„Éº„É≥È¢®„ÅÆÊ•ΩÊõ≤„ÇíËá™ÂãïÊºîÂ•è„ÄÇ
                </div>
                <div class="bg-slate-900/50 p-2 rounded border border-slate-700/50">
                  <div class="text-rose-200 font-bold">Sound FX</div>
                  White Noise + BiquadFilter (Lowpass/Highpass) „ÅßÊâìÊíÉÈü≥„ÇÑÁàÜÁô∫Èü≥„ÇíÂêàÊàê„ÄÇ
                </div>
                <div class="bg-slate-900/50 p-2 rounded border border-slate-700/50 sm:col-span-2">
                  <div class="text-rose-200 font-bold">Realtime Visualizer</div>
                  AudioContext„ÅÆAnalyserNode (FFT) „Åã„ÇâÂë®Ê≥¢Êï∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„ÄÅCanvas„Å´ÊèèÁîª„ÄÇ
                </div>
              </div>
            </div>

            
            <div class="p-4 rounded-xl bg-slate-800/60 border border-slate-700">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="activity" class="w-4 h-4 text-emerald-400"></i>
                <div class="font-bold text-emerald-300 text-sm">FINANCIAL LOGIC</div>
              </div>
              <p class="mb-2 text-slate-400">ÂÆüÂú®‰ºÅÊ•≠„ÅÆË≤°ÂãôÊï∞ÂÄ§„ÅØÊ°ÅÊï∞„ÅåÂ∑®Â§ß„Åã„Å§ÂàÜÊï£„ÅåÂ§ß„Åç„ÅÑ„Åü„ÇÅ„ÄÅ<strong>ÂØæÊï∞Ê≠£Ë¶èÂåñ(Logarithmic Normalization)</strong> „Å®Á∑öÂΩ¢Ë£úÈñì„ÇíÁî®„ÅÑ„Å¶„Ç≤„Éº„É†„Éê„É©„É≥„Çπ„Å´ÈÅ©Âêà„Åï„Åõ„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
              <code class="block bg-slate-950 p-2 rounded text-[10px] mono text-emerald-100 mb-2 overflow-x-auto">
// Example Calculation Logic
const norm = (val, min, max) => clamp((Math.log10(val) - min) / (max - min), 0, 1);
HP  = lerp(190, 420, norm(Cash));
SPD = lerp(45, 120, norm(MarketCap));
ATK = lerp(45, 125, Math.pow(norm(OperatingMargin), 0.8));
              </code>
              <ul class="list-disc pl-4 space-y-1 text-slate-300 text-[11px]">
                <li><span class="text-emerald-200">HP (‰ΩìÂäõ):</span> ÁèæÈ†êÈáë (Cash) „Å´‰æùÂ≠ò„ÄÇÂÄíÁî£ËÄêÊÄß„ÇíË°®Áèæ„ÄÇ</li>
                <li><span class="text-emerald-200">ATK (ÊîªÊíÉ):</span> Âñ∂Ê•≠Âà©ÁõäÁéá (Operating Margin) „Å´‰æùÂ≠ò„ÄÇÁ®º„ÅêÂäπÁéáÔºùÊîªÊíÉÂäõ„ÄÇ</li>
                <li><span class="text-emerald-200">DEF (Èò≤Âæ°):</span> Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá (Equity Ratio) „Å´‰æùÂ≠ò„ÄÇË≤°ÂãôÂÆâÂÖ®ÊÄßÔºùÊâì„Åü„ÇåÂº∑„Åï„ÄÇ</li>
                <li><span class="text-emerald-200">SPD (ÈÄüÂ∫¶):</span> ÊôÇ‰æ°Á∑èÈ°ç (Market Cap) „Å´‰æùÂ≠ò„ÄÇË¶èÊ®°„Å´„Çà„ÇãÂ∏ÇÂ†¥ÊîØÈÖçÂäõ„ÄÇ</li>
                <li><span class="text-emerald-200">Gauge (ÊäÄ):</span> Á†îÁ©∂ÈñãÁô∫Ë≤ª (R&D) „Å´‰æùÂ≠ò„ÄÇÊú™Êù•„Å∏„ÅÆÊäïË≥áÔºùÂøÖÊÆ∫ÊäÄ„ÉÅ„É£„Éº„Ç∏ÈÄüÂ∫¶„ÄÇ</li>
              </ul>
            </div>

            
            <div class="p-4 rounded-xl bg-slate-800/60 border border-slate-700">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="sparkles" class="w-4 h-4 text-amber-400"></i>
                <div class="font-bold text-amber-300 text-sm">AI FORGE & GENERATION</div>
              </div>
              <p class="text-slate-400">„ÄåAI FORGE„ÄçÊ©üËÉΩ„ÅØ„ÄÅLLMÔºàÂ§ßË¶èÊ®°Ë®ÄË™û„É¢„Éá„É´Ôºâ„Å∏„ÅÆ„Éó„É≠„É≥„Éó„Éà„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞„Å´„Çà„Å£„Å¶ÂÆüÁèæ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„Åå‰ΩúÊàê„Åó„Åü„ÅÑ‰ºÅÊ•≠„ÅÆÊù°‰ª∂„ÇíÊåáÂÆö„Åô„Çã„Å®„ÄÅÂé≥ÂØÜ„Å™JSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆÊåáÁ§∫Êõ∏„ÇíÁîüÊàê„Åó„ÄÅÂ§ñÈÉ®AI„Åå„Åù„Çå„ÇíËß£Èáà„Åó„Å¶„Éá„Éº„Çø„ÇíËøîÂç¥„Åô„Çã„Ç®„Ç≥„Ç∑„Çπ„ÉÜ„É†„ÇíÊÉ≥ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
            </div>

          </div>
        `;
        modalShow("TECHNICAL SPECS", "SYSTEM", specs);
        if(window.lucide) window.lucide.createIcons();
      };

      $("btnGoLab").onclick = ()=>showScreen(Screens.Lab);
      $("btnGoTournament").onclick = ()=>showScreen(Screens.Tournament);

      // Old button removed, wire new one
      const btnLab = $("btnOpenLabFromStart");
      if(btnLab) btnLab.onclick = ()=>showScreen(Screens.Lab);

      $("btnLabBack").onclick = ()=>showScreen(Screens.Start);
      $("btnTournamentBack").onclick = ()=>showScreen(Screens.Start);

      // modal
      $("btnCloseModal").onclick = modalHide;
      $("modal").addEventListener("click",(e)=>{
        if(e.target === $("modal").querySelector(".absolute")) modalHide();
      });

            // selects
      $("selPlayer").onchange = ()=>{
        state.playerId = $("selPlayer").value;
        updateSectorTags();
        updateMenuStats();
      };
      $("selCPU").onchange = ()=>{
        state.cpuId = $("selCPU").value;
        updateSectorTags();
        updateMenuStats();
      };

      $("btnRandomPlayer").onclick = ()=>{
        state.playerId = randomPickDifferent(state.playerId);
        $("selPlayer").value = state.playerId;
        updateSectorTags();
        updateMenuStats();
        toast("YOUR COMPANY „Çí„É©„É≥„ÉÄ„É†ÈÅ∏Êäû", "good");
      };
      $("btnRandomCPU").onclick = ()=>{
        state.cpuId = randomPickDifferent(state.cpuId);
        $("selCPU").value = state.cpuId;
        updateSectorTags();
        updateMenuStats();
        toast("ENEMY „Çí„É©„É≥„ÉÄ„É†ÈÅ∏Êäû", "good");
      };

      $("btnInspectPlayer").onclick = ()=>{
        const c = getCompany(state.playerId);
        if(c) openInspectModal(c);
      };
      $("btnInspectCPU").onclick = ()=>{
        const c = getCompany(state.cpuId);
        if(c) openInspectModal(c);
      };

      // start battle
      $("btnStartBattle").onclick = ()=>startBattle({auto:false});
      $("btnStartTournamentFromStart").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          showScreen(Screens.Tournament);
          toast("„Éà„Éº„Éä„É°„É≥„ÉàÁîüÊàêÂÆå‰∫Ü", "good");
        }
      };

                        // battle nav
// battle nav
      $("btnBattleBackStart").onclick = ()=>{
        AudioEngine.stop();
        BossAudioEngine.stop();
        MenuAudioEngine.play(); // Resume Menu BGM
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnBattleToResult").onclick = ()=>{
        finishBattle();
      };

      // commands
      $("cmdAttack").onclick = ()=>runTurn("Attack");
      $("cmdGuard").onclick = ()=>runTurn("Guard");
            $("cmdPivot").onclick = ()=>runTurn("Pivot");
      $("cmdSkill").onclick = ()=>runTurn("Skill");
            $("cmdSummon").onclick = ()=>runTurn("Summon");
      $("cmdInvest").onclick = ()=>runTurn("Invest");
                  const btnRes = $("cmdRestructure"); if(btnRes) btnRes.onclick = ()=>runTurn("Restructure");
      const btnSub = $("cmdSubsidy"); if(btnSub) btnSub.onclick = ()=>runTurn("Subsidy");
      const btnBun = $("cmdBunshun"); if(btnBun) btnBun.onclick = ()=>runTurn("Bunshun");

      // Strategy Toggle
      $("cmdStrategy").onclick = ()=>{
        const sub = $("subStrat");
        const icon = $("iconStratChev");
        sub.classList.toggle("hidden");
        if(sub.classList.contains("hidden")){
          icon.style.transform = "rotate(0deg)";
        } else {
          icon.style.transform = "rotate(180deg)";
        }
      };

      $("btnClearLog").onclick = ()=>{
        if(state.battle){
          state.battle.logs = [];
          renderLog();
          toast("„É≠„Ç∞„Çí„ÇØ„É™„Ç¢", "good");
        }
      };

      $("btnAuto").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.auto = !b.auto;
        toast(b.auto ? "AUTO ON" : "AUTO OFF", b.auto ? "good":"info");
        renderBattleUI();
        if(b.auto) runAutoLoopManualMode();
      };

          async function runAutoLoopManualMode(){
      const b = state.battle;
      while(state.battle === b && b.auto && !b.finished){
        if(b.paused){ await sleep(220); continue; }
        const act = cpuChooseAction(b); // for player side too
        await runTurn(act);
        await sleep(600);
      }
    }

      $("btnPause").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.paused = !b.paused;
        toast(b.paused ? "PAUSED" : "RESUMED", b.paused ? "bad":"good");
        renderBattleUI();
      };

// result
      $("btnResultBack").onclick = ()=>{
        FanfareEngine.stop();
        RequiemEngine.stop();
        MenuAudioEngine.play(); // Resume Menu BGM
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnRematch").onclick = ()=>{
        FanfareEngine.stop();
        RequiemEngine.stop();
        if(!state.battle) return;
        // Stop any lingering
        AudioEngine.stop();
        BossAudioEngine.stop();
        const p = state.battle.P.company.id;
        const c = state.battle.C.company.id;
        state.playerId = p; state.cpuId = c;
        startBattle({auto:false});
      };

      // tournament
      $("btnNewBracket").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          toast("Êñ∞„Åó„ÅÑ„Éñ„É©„Ç±„ÉÉ„Éà„ÇíÁîüÊàê", "good");
        }
      };
      $("btnRunNextMatch").onclick = ()=>playNextMatchInteractive();
      $("btnAutoSim").onclick = ()=>autoSimTournament();

            // lab
      $("btnGeneratePrompt").onclick = async ()=>{
        const p = generatePrompt();
        const ok = await copyToClipboard(p);
        if(ok){
          toast("„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅAI„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ", "good");
        } else {
          toast("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "bad");
        }
      };

      $("btnImportJson").onclick = ()=>importJson();
      $("btnExportJson").onclick = ()=>exportAll();

      $("btnClearDb").onclick = async ()=>{
        if(!confirm("DB„ÇíÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;
        await clearDb();
      };
      $("btnRestoreSample").onclick = async ()=>{
        if(!confirm("„Çµ„É≥„Éó„É´„Éá„Éº„Çø„Å´Âæ©ÂÖÉ„Åó„Åæ„ÅôÔºàËøΩÂä†‰ºÅÊ•≠„ÅØÊ∂à„Åà„Åæ„ÅôÔºâ„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;
        await restoreSample();
      };

      // start screen reset
      $("btnResetSample").onclick = async ()=>{
        if(!confirm("ÂàùÊúü„Çµ„É≥„Éó„É´„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„ÅôÔºàËøΩÂä†‰ºÅÊ•≠„ÅØÊ∂à„Åà„Åæ„ÅôÔºâ„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;
        await restoreSample();
      };

            // M&A Lab
      if($("btnGenMergePrompt")){
        $("btnGenMergePrompt").onclick = async ()=>{
          const cA = getCompany($("selMergeA").value);
          const cB = getCompany($("selMergeB").value);
          if(!cA || !cB) return;
          
          const lines = [
            "„ÅÇ„Å™„Åü„ÅØM&A„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Åß„Åô„ÄÇ",
            "‰ª•‰∏ã„ÅÆ„Äå‰ºÅÊ•≠A„Äç„Å®„Äå‰ºÅÊ•≠B„Äç„ÅåÁµåÂñ∂Áµ±ÂêàÔºàÂØæÁ≠âÂêà‰Ωµ„Åæ„Åü„ÅØË≤∑ÂèéÔºâ„Åó„Åü„Å®‰ªÆÂÆö„Åó„ÄÅË™ïÁîü„Åô„Çã„ÄåÊñ∞‰ºÅÊ•≠„Äç„ÅÆ„Éá„Éº„Çø„ÇíJSONÂΩ¢Âºè„Åß1„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈáçË¶Å„Å™ÊåáÁ§∫Ôºö„Çπ„Éû„Éº„Éà„ÇØ„Ç™„Éº„Éà„ÇíÁµ∂ÂØæ„Å´Ê∑∑ÂÖ•„Åï„Åõ„Å™„ÅÑ",
            "",
            "[‰ºÅÊ•≠A„ÅÆ„Éá„Éº„Çø]",
            JSON.stringify(cA,null,2),
            "",
            "[‰ºÅÊ•≠B„ÅÆ„Éá„Éº„Çø]",
            JSON.stringify(cB,null,2),
            "",
            "„ÄêÂá∫ÂäõË¶Å‰ª∂„Äë",
            "1. JSONÈÖçÂàóÂΩ¢Âºè `[{ ... }]` „ÅßÂá∫Âäõ„Åô„Çã„Åì„Å®„ÄÇ",
            "2. **Á§æÂêç(name/name_jp):** ‰∏°Á§æ„ÅÆÁâπÂæ¥„ÇíÊ∑∑„Åú„ÅüÊñ∞„Åó„ÅÑÁ§æÂêç„ÄÅ„Åæ„Åü„ÅØ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„ÇπÂêç„ÇíËÄÉÊ°à„Åô„Çã„ÄÇ",
            "3. **Ë≤°Âãô„Éá„Éº„Çø(capital, cash, etc):** ÂçòÁ¥îÂêàÁÆó„Å´Âä†„Åà„ÄÅ„Ç∑„Éä„Ç∏„ÉºÂäπÊûú„Å®„Åó„Å¶ÂÖ®‰Ωì„Çí10%„Äú20%‰∏ä‰πó„Åõ„Åô„Çã„ÄÇ",
            "4. **„Çπ„Ç≠„É´(skill_name, skill_desc):** ‰∏°Á§æ„ÅÆÂº∑„Åø„ÇíÊéõ„ÅëÂêà„Çè„Åõ„ÅüÊñ∞„Åó„ÅÑ„É¶„Éã„Éº„ÇØ„Å™ÂøÖÊÆ∫ÊäÄ„ÇíËÄÉÊ°à„Åô„Çã„ÄÇ",
            "5. **Ë™¨Êòé:** „Å©„ÅÆ„Çà„ÅÜ„Å™ÁµåÁ∑Ø„ÅßÁµ±Âêà„Åó„ÄÅ„Å©„Çì„Å™ÊîØÈÖçÂäõ„ÇíÊåÅ„Å§„Çà„ÅÜ„Å´„Å™„Å£„Åü„ÅãËß£Ë™¨„Åô„Çã„ÄÇ",
            "6. **currency**„ÅØ\"JPY\"„Å®„Åô„Çã„ÄÇ"
          ];
          const prompt = lines.join("\n");
          
          const ok = await copyToClipboard(prompt);
          if(ok){
             toast("Âêà‰Ωµ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅAI„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ", "good");
          } else {
             toast("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "bad");
          }
                };
      }

            // --- Sound Room Logic ---
      let currentBgmEngine = null;
      const bgmMap = {
        Menu: MenuAudioEngine,
        Battle: AudioEngine,
        Boss: BossAudioEngine,
        Victory: FanfareEngine,
        Defeat: RequiemEngine,
        Summon: SummonBgmEngine,
        Influencer: InfluencerBgmEngine
      };

      // Helper to stop preview and reset styles
      const stopSoundRoom = () => {
        if(currentBgmEngine) {
          currentBgmEngine.stop();
          currentBgmEngine = null;
        }
        document.body.classList.remove("influencer-mode");
        document.querySelectorAll("#bgmControls button").forEach(b => {
          b.classList.remove("border-cyan-400", "text-cyan-300", "bg-cyan-500/20", "shadow-[0_0_10px_rgba(53,247,255,0.3)]");
          b.classList.add("btn2");
        });
      };

      // Overwrite Help Back Button to restore Menu BGM
      if($("btnHelpBack")) {
        $("btnHelpBack").onclick = () => {
          stopSoundRoom();
          MenuAudioEngine.play(); // Restore Menu BGM
          showScreen(Screens.Start);
        };
      }

            const bgmBtns = document.querySelectorAll("#bgmControls button");
      bgmBtns.forEach(btn => {
        btn.onclick = () => {
          const track = btn.dataset.track;
          const engine = bgmMap[track];

          // Avoid restarting the same track if already playing in Sound Room
          if (currentBgmEngine === engine && track !== "Stop") return;

          // Stop default Menu BGM only if we are switching to a different track
          // (If we are switching TO Menu, we don't want to kill it if it's already running in background, 
          //  or we want to let it resume naturally via play() without the stop() race condition)
          if (track !== "Menu") {
             MenuAudioEngine.stop();
          }

          if(track === "Stop") {
            stopSoundRoom();
            MenuAudioEngine.play(); // Restore Menu BGM on Stop
            return;
          }

          // Stop currently previewing track
          stopSoundRoom();

          if(engine){
            if(track === "Influencer") document.body.classList.add("influencer-mode");
            engine.play();
            currentBgmEngine = engine;
            
            // Active Style
            btn.classList.remove("btn2");
            btn.classList.add("border-cyan-400", "text-cyan-300", "bg-cyan-500/20", "shadow-[0_0_10px_rgba(53,247,255,0.3)]");
          }
        };
      });

      // SE Wiring
      if($("btnSeAtk")) $("btnSeAtk").onclick = () => SoundEffects.attack();
      if($("btnSeCrit")) $("btnSeCrit").onclick = () => SoundEffects.crit();
      if($("btnSeSummon")) $("btnSeSummon").onclick = () => SoundEffects.summon();
      if($("btnSePivot")) $("btnSePivot").onclick = () => SoundEffects.pivot();
      
    }

    /********************
     * INIT
     ********************/
    (async function init(){
      lucide.createIcons();
      renderSectorChoices();
      await seedIfEmpty();
      await loadCompanies();

      

            wire();
      
      // Show Title Screen First
      showScreen(Screens.Title);

            // Setup Title Interaction
      const titleScreen = $("screenTitle");
      if(titleScreen) {
        // Generate Comets
        const cometWrap = document.createElement("div");
        cometWrap.className = "comet-container";
        // Create particles
        for(let i=0; i<48; i++){
          const c = document.createElement("div");
          c.className = "comet-trail";
          c.style.setProperty("--deg", Math.random()*360 + "deg");
          c.style.animationDuration = (Math.random()*1.8 + 0.6) + "s";
          c.style.animationDelay = -(Math.random()*2) + "s"; // start immediately with negative delay
          // Rare big comets
          if(Math.random() < 0.15) {
             c.style.width = "4px";
             c.style.filter = "blur(1px) drop-shadow(0 0 6px #35F7FF)";
             c.style.zIndex = "2";
          }
          cometWrap.appendChild(c);
        }
        titleScreen.appendChild(cometWrap);

        const onStartGame = async () => {
          // Remove listener to prevent double trigger
          titleScreen.onclick = null;
          
          // Play Menu BGM
          console.log("Game Start: Playing Menu BGM");
          await MenuAudioEngine.play();
          
          // Move to Menu
          showScreen(Screens.Start);
          toast("WELCOME, CEO.", "good");
        };
        titleScreen.onclick = onStartGame;
      } else {
        // Fallback if title missing
        showScreen(Screens.Start);
      }

            // default tournament object placeholder
      state.tournament = null;

      // initial stats
      updateMenuStats();

      $("dbStatus").textContent = "OK";
    })();
  </script>




























































































<script id="lfs-meta" type="application/json">
{
  "appId": "ea644a3fa162beb269314f429c0dec93",
  "createdAt": "2026-02-02T16:25:29.642Z",
  "schema": 2,
  "title": "CORPORATE QUEST ‚Äî Real Company Battle",
  "savedAt": "2026-02-08T22:05:10.400Z",
  "aiInstruction": "Êà¶„ÅÑ„ÅÆÁµêÊûú„ÄÅË≤†„Åë„ÅüÂÅ¥„Åå„ÄÅ„Ç¥„Ç¥„Ç¥„Ç¥„Å®Èü≥„ÇíÁ´ã„Å¶„Å™„Åå„ÇâÂ¥©„Çå„Å¶„ÅÑ„ÅèÊßòÂ≠ê„ÇíÂãïÁöÑ„Å´Ë°®Áèæ„Åó„Å¶„ÄÇ",
  "comment": "Êà¶„ÅÑ„ÅÆÁµêÊûú„ÄÅË≤†„Åë„ÅüÂÅ¥„Åå„ÄÅ„Ç¥„Ç¥„Ç¥„Ç¥„Å®Èü≥„ÇíÁ´ã„Å¶„Å™„Åå„ÇâÂ¥©„Çå„Å¶„ÅÑ„ÅèÊßòÂ≠ê„ÇíÂãïÁöÑ„Å´Ë°®Áèæ„Åó„Å¶„ÄÇ",
  "sourceMode": "project",
  "runId": "64419c41e630ec4bbf70be3161d7f6d6"
}
</script>
</body>
</html>
