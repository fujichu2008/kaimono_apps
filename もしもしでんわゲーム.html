<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>もしもしでんわゲーム</title>
<meta name="theme-color" content="#2b6ff0">
<style>
:root{
  --bg:#f3f7ff; --card:#ffffff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b6ff0; --accent-2:#2056c7; --good:#10b981; --warn:#ef4444; --lcd:#eaf1ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial;
  display:flex;align-items:center;justify-content:center;padding:16px;
}
.app{width:min(520px,92vw);background:var(--card);border:1px solid #e5ecff;border-radius:24px;box-shadow:0 10px 30px rgba(43,111,240,.12);overflow:hidden}
.header{padding:14px 18px;background:linear-gradient(180deg,#fff 0%,#f7faff 100%);border-bottom:1px solid #e9f0ff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.title .tel{width:34px;height:34px;border-radius:10px;background:var(--accent);display:grid;place-items:center;color:#fff;box-shadow:0 6px 16px rgba(43,111,240,.25)}
.level{display:flex;gap:8px;align-items:center}
.level button{border:1px solid #d9e6ff;background:#fff;color:#244;cursor:pointer;padding:8px 12px;border-radius:999px;font-weight:600}
.level button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.namebox{font-size:12px;color:var(--muted)}
.namebox input{width:8.5em;border:1px solid #d9e6ff;border-radius:8px;padding:4px 8px;margin-left:6px}

/* LCD */
.lcd{margin:16px; padding:14px;border-radius:16px;background:var(--lcd);border:1px solid #d9e6ff;min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center; position:relative; overflow:hidden}
.lcd .msg{font-size:18px}
.lcd .big{font-size:22px;font-weight:800}
.btn{appearance:none;cursor:pointer;user-select:none;outline:none;border:none;background:var(--accent);color:#fff;padding:12px 20px;border-radius:999px;font-weight:800;box-shadow:0 8px 20px rgba(43,111,240,.25)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.btn.ghost{background:#fff;color:#244;border:1px solid #e1e8ff}

/* Phone Face */
.phone{padding:4px 16px 18px}
.symbol{display:grid;place-items:center;margin-bottom:10px}
.dial-btn{
  width:110px;height:110px;border-radius:999px;background:linear-gradient(180deg,#2b6ff0,#1848b4);
  display:grid;place-items:center;color:#fff;font-size:44px;font-weight:900;
  box-shadow:0 14px 28px rgba(43,111,240,.35), inset 0 0 12px rgba(255,255,255,.35);
  border:none;cursor:pointer
}
.dial-btn:disabled{filter:grayscale(.3) brightness(.9);opacity:.7;cursor:not-allowed}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.key{
  background:#fff;border:1px solid #d9e6ff;border-radius:16px;box-shadow:0 6px 14px rgba(0,0,0,.04);
  padding:16px 0;text-align:center;font-size:28px;font-weight:800;color:#0f172a;cursor:pointer;
  transition:transform .06s, box-shadow .2s, background .2s; user-select:none;
}
.key:active{transform:translateY(1px)}
.key.glow{background:#f0f7ff; box-shadow:0 0 0 4px rgba(43,111,240,.18), 0 6px 14px rgba(0,0,0,.06)}
.key[disabled]{opacity:.35;pointer-events:none}

/* footer controls */
.controls{display:flex;justify-content:center;gap:10px;padding:2px 16px 18px}

/* Confetti */
.confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
.petal{position:absolute; width:10px; height:14px; background:#ff7eb6; opacity:.9; border-radius:8px 8px 12px 12px; animation:fall var(--dur) linear forwards}
.petal::after{content:""; position:absolute; inset:0; border-radius:inherit; background:rgba(255,255,255,.35)}
@keyframes fall{0%{transform:translate(var(--x,0),-20px) rotate(0deg)}100%{transform:translate(var(--xend,0), calc(100vh + 40px)) rotate(540deg)}}

/* score color step */
.lcd.step2{background:#e5ffe9;border-color:#c9f7d5}     /* 2-3点 */
.lcd.step4{background:#fffbe8;border-color:#ffe3a7}     /* 4点 */
.lcd.step5{background:#fff0f5;border-color:#ffc1d9}     /* 5点 */

.small{font-size:.875rem;color:var(--muted)}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="title">
      <div class="tel">☎</div><div>もしもしでんわゲーム</div>
    </div>
    <div class="level">
      <button class="active" data-level="easy" id="btnEasy">やさしい</button>
      <button data-level="normal" id="btnNormal">ふつう</button>
    </div>
  </div>

  <div class="lcd" id="lcd">
    <div class="confetti" id="confetti"></div>
    <div class="msg" id="msg">
      <div class="big">スタート！</div>
      <div class="small">レベルをえらんで、はじめてね</div>
      <div style="margin-top:12px"><button class="btn" id="startBtn">スタート</button></div>
    </div>
  </div>

  <div class="phone">
    <div class="symbol">
      <!-- 発信用 ☎ ボタン（提出ボタン） -->
      <button class="dial-btn" id="dialBtn" title="でんわをかける" disabled>☎</button>
    </div>
    <div class="keypad" id="keypad">
      <button class="key" data-num="1">1</button>
      <button class="key" data-num="2">2</button>
      <button class="key" data-num="3">3</button>
      <button class="key" data-num="4">4</button>
      <button class="key" data-num="5">5</button>
      <button class="key" data-num="6">6</button>
      <button class="key" data-num="7">7</button>
      <button class="key" data-num="8">8</button>
      <button class="key" data-num="9">9</button>
      <div></div>
      <button class="key" data-num="0">0</button>
      <div></div>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="clearBtn" title="入力を消す">入力クリア</button>
    <button class="btn ghost" id="resetBtn" title="ゲームをリセット">リセット</button>
  </div>

  <div class="header" style="border-top:1px solid #e9f0ff;border-bottom:0">
    <div class="namebox">
      あいてのなまえ：
      <input id="kidName" value="あやかちゃん" aria-label="呼びかける名前">
    </div>
    <div class="small">5回れんぞくのゲームです</div>
  </div>
</div>

<script>
/* ====== 読み上げユーティリティ ====== */
const kanaMap = {"0":"ぜろ","1":"いち","2":"に","3":"さん","4":"よん","5":"ご","6":"ろく","7":"なな","8":"はち","9":"きゅう"};
let jpVoice = null;

function pickJapaneseVoice(){
  const list = speechSynthesis.getVoices();
  jpVoice = list.find(v => /ja-JP/i.test(v.lang)) || list.find(v=>/ja/i.test(v.lang)) || null;
}
if ('speechSynthesis' in window) {
  pickJapaneseVoice();
  window.speechSynthesis.onvoiceschanged = pickJapaneseVoice;
}

function speak(text, {rate=0.9, pitch=1, volume=1, onend}={}){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  if(jpVoice) u.voice = jpVoice;
  u.lang = jpVoice?.lang || 'ja-JP';
  u.rate = rate; u.pitch = pitch; u.volume = volume;
  if(typeof onend === 'function'){ u.onend = onend; }
  speechSynthesis.speak(u);
}
function cancelSpeak(){ if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
function readDigitsAsKana(digits){ return digits.split('').map(d=>kanaMap[d]||d).join('、'); }

/* ====== 参照 ====== */
const lcd = document.getElementById('lcd');
const msg = document.getElementById('msg');
const startBtn = document.getElementById('startBtn');
const keypad = document.getElementById('keypad');
const dialBtn = document.getElementById('dialBtn');
const clearBtn = document.getElementById('clearBtn');
const resetBtn = document.getElementById('resetBtn');
const btnEasy = document.getElementById('btnEasy');
const btnNormal = document.getElementById('btnNormal');
const nameInput = document.getElementById('kidName');
const confetti = document.getElementById('confetti');

/* ====== 状態 ====== */
let level = 'easy';           // 'easy' 1桁 / 'normal' 2桁
let round = 0;                // 1..5
let score = 0;                // 0..5
let targetDigits = '';        // お題
let typedDigits = '';         // 入力中
let canInput = false;         // 入力可フラグ
let inGame = false;

/* ====== Web Audio：電子リンガー（プルルル風） ====== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/** 電子リング音（プルルル）を合成して鳴らす */
function playPurururu({
  rings = 1,          // 何回「プルル」するか（1〜2がおすすめ）
  ringOn = 1.2,       // 1回の鳴動長（秒）
  ringOff = 0.15,     // 鳴動間の無音（秒）
  freq = 950,         // 基本周波数（Hz）
  waveform = 'triangle', // 'sine'|'triangle'|'square' など
  vibratoHz = 18,     // 揺れの速さ（Hz）
  vibratoDepth = 0.5, // 揺れの深さ（0〜1）
  volume = 0.35       // 音量（0〜1）
} = {}) {
  return new Promise(async (resolve)=>{
    try { if (audioCtx.state === 'suspended') await audioCtx.resume(); } catch(e){}
    const master = audioCtx.createGain(); master.gain.value = 0; master.connect(audioCtx.destination);

    // キャリア
    const osc = audioCtx.createOscillator(); osc.type = waveform; osc.frequency.value = freq;

    // AMでブルル感
    const lfo = audioCtx.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = vibratoHz;
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = vibratoDepth * volume;
    lfo.connect(lfoGain).connect(master.gain);

    // 耳あたりを柔らかく
    const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 1800; filt.Q.value = 0.7;

    osc.connect(filt).connect(master);

    const now = audioCtx.currentTime;
    osc.start(now); lfo.start(now);

    // エンベロープ
    let t = now;
    for (let i=0; i<rings; i++) {
      master.gain.setValueAtTime(0, t);
      master.gain.linearRampToValueAtTime(volume, t + 0.02);
      master.gain.setValueAtTime(volume, t + ringOn - 0.05);
      master.gain.linearRampToValueAtTime(0, t + ringOn);
      t += ringOn + ringOff;
    }

    const stopAt = t + 0.02;
    osc.stop(stopAt); lfo.stop(stopAt);
    setTimeout(()=>{ master.disconnect(); resolve(); }, (stopAt - now) * 1000 + 50);
  });
}

/* ====== 成功パターン：300種類を動的生成 ======
   - 子ども向け：短い・やさしい・前向き
   - LCD（短文 + 絵文字OK）と Voice（絵文字ナシ）の2要素
   - テンプレを組み合わせ、重複排除してシャッフル→300件にスライス
================================================ */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function uniqByJSON(list){
  const seen=new Set(); const out=[];
  for(const o of list){
    const k=JSON.stringify(o);
    if(!seen.has(k)){ seen.add(k); out.push(o); }
  }
  return out;
}
function T(s){ return s; } // tiny helper

const lcdBases = [
  "つながった！","でんわ かかったよ！","せいこう！","ばっちり！","おみごと！","はなまる！",
  "キラキラでんわ✨","ピカピカでんわ✨","にっこにこ！","ナイス！","ぐっじょぶ！","パーフェクト！",
  "ミッション クリア！","ビンゴ！","OK！","たいへん よくできました","100てん！","ごうかく！",
  "だいせいこう！","バッチグー！","スター！","ヒーロー！","チャンピオン！","マスター！",
  "こえ とどいた！","つうしんOK！","ピンポーン！","にこにこ でんわ","いいでんわ！","やったー！",
  "うまくできた！","ぴったり！","できたね！","すごい！","すてき！","いいかんじ！",
  "レベルアップ！","ばんざい！","ハイタッチ！","よく きけたね！","ばっちり きまった！","やる〜！",
  "にこにこ たいむ","キラキラ たいむ","にっこり！","いいおと！","こえ が きこえた！","とどいたよ！",
  "せいかい！","ばっちり あってた！"
];
const lcdDecor = [""," 🎉"," 🌟"," ✨"," 💫"," 🎈"," 🌈"," 🐣"," 🐻"," 🐥"," 🍀"," 💐"];

const voiceGreets = [ "こんにちは","もしもし","やっほー","やあ","ハロー" ];
const voiceBodiesA = [
  "、{name}！つながったよ！","、{name}！でんわ、かかったよ！","、{name}！せいこうだよ！",
  "、{name}！ばっちりできたね！","、{name}！ぴったり あってたよ！","、{name}！こえが とどいたよ！",
  "、{name}！すごいね！","、{name}！えらいね！","、{name}！とっても じょうず！",
  "、{name}！そのちょうし！","、{name}！きょうも げんき！","、{name}！ハイタッチ！",
  "、{name}！にこにこ〜！","、{name}！ありがとう！","、{name}！グッドジョブ！",
  "、{name}！とどいた とどいた！","、{name}！おみごと！","、{name}！キラキラ〜！",
  "、{name}！よく きけたね！","、{name}！ばっちり きまったよ！"
];
const voiceTails = [ "", " そのちょうし！"," さいこう！"," えらい！"," かんぺき！"," すごい！"," うれしいな！"," にっこり！" ];

const seedPairs = [
  {lcd:T("つながった！"), voice:T("{name}、やったね！つながったよ！")},
  {lcd:T("でんわ かかったよ！"), voice:T("こんにちは、{name}！でんわ、かかったよ！")},
  {lcd:T("はなまる！"), voice:T("{name}、はなまる！とっても じょうず！")},
  {lcd:T("おみごと！"), voice:T("{name}、おみごと！ばっちり できたね！")},
  {lcd:T("ピンポーン！"), voice:T("ピンポーン！{name}、せいかいだよ！")}
];

let successLines = []; // ここに最終300件を格納
function buildSuccessLines(){
  const pool = [];
  // 1) シード
  for(const p of seedPairs){ pool.push({lcd:p.lcd, voice:p.voice}); }
  // 2) 組み合わせ生成
  for(const base of lcdBases){
    for(const deco of lcdDecor){
      const lcd = (base + deco).trim();
      for(const g of voiceGreets){
        for(const b of voiceBodiesA){
          for(const t of voiceTails){
            const voice = `${g}${b}${t}`.replace(/\s+/g,' ').trim();
            pool.push({lcd, voice});
            if(pool.length>2000) break;
          }
          if(pool.length>2000) break;
        }
        if(pool.length>2000) break;
      }
      if(pool.length>2000) break;
    }
    if(pool.length>2000) break;
  }
  const unique = uniqByJSON(pool);
  shuffle(unique);
  successLines = unique.slice(0, 300);
  while(successLines.length < 300){
    successLines = successLines.concat(seedPairs).slice(0,300);
  }
}

/* ====== 失敗パターン（50件） ====== */
const failLines = [
  {lcd:T("まちがいだったよ"), voice:T("あれれ、{name}。まちがいだったよ。")},
  {lcd:T("おしい！"), voice:T("おしい！{name}、もうすこし！")},
  {lcd:T("だいじょうぶ！"), voice:T("だいじょうぶ！{name}、つぎは できるよ！")},
  {lcd:T("ゆっくり ためそう"), voice:T("ゆっくり ためしてみよう、{name}。")},
  {lcd:T("もういっかい！"), voice:T("もういっかい やってみよう、{name}！")},
  {lcd:T("きにしないでね"), voice:T("きにしないでね、{name}。だいじょうぶ！")},
  {lcd:T("つぎは うまくいくよ"), voice:T("つぎは うまくいくよ、{name}！")},
  {lcd:T("いっしょに やろう"), voice:T("いっしょに やろうね、{name}！")},
  {lcd:T("すって はいて"), voice:T("すって〜 はいて〜。{name}、おちついていこう！")},
  {lcd:T("ちいさな しっぱいOK"), voice:T("ちいさな しっぱいは OKだよ、{name}。")},
  {lcd:T("おとを よくきこう"), voice:T("おとを よくきこう、{name}。もういちど！")},
  {lcd:T("ちがっていたよ"), voice:T("{name}、ちがっていたよ。つぎ ためそう！")},
  {lcd:T("あわてなくてOK"), voice:T("あわてなくてOK、{name}。ゆっくりで いいよ！")},
  {lcd:T("ひとやすみしてOK"), voice:T("ひとやすみしても いいよ、{name}。")},
  {lcd:T("ちょっと ずれたね"), voice:T("ちょっと ずれたね、{name}。つぎ いける！")},
  {lcd:T("おぼえていこう"), voice:T("すこしずつ おぼえていこう、{name}。")},
  {lcd:T("ここから リスタート"), voice:T("ここから リスタートだよ、{name}！")},
  {lcd:T("にこにこ で もういちど"), voice:T("にこにこで もういちど いこう、{name}！")},
  {lcd:T("チャレンジ たいせつ"), voice:T("チャレンジ たいせつ！{name}、えらい！")},
  {lcd:T("ゆびで かぞえてみよう"), voice:T("ゆびで かぞえてみよう、{name}。")},
  {lcd:T("よく がんばったよ"), voice:T("よく がんばったよ、{name}。")},
  {lcd:T("ちいさく ふんばろう"), voice:T("ちいさく ふんばろう、{name}。")},
  {lcd:T("きいて まねしてみよう"), voice:T("きいて まねしてみよう、{name}。")},
  {lcd:T("へいき へいき"), voice:T("へいき へいき！{name}、つぎ いこ！")},
  {lcd:T("なれると できるよ"), voice:T("なれると できるよ、{name}。")},
  {lcd:T("ちょっと ちがっただけ"), voice:T("ちょっと ちがっただけだよ、{name}。")},
  {lcd:T("おと を ききなおそう"), voice:T("おとを ききなおそう、{name}。")},
  {lcd:T("おちつこっか"), voice:T("おちつこっか、{name}。")},
  {lcd:T("だんだん よくなるよ"), voice:T("だんだん よくなるよ、{name}！")},
  {lcd:T("できる きみなら"), voice:T("できる！{name}なら できるよ！")},
  {lcd:T("いまは れんしゅう"), voice:T("いまは れんしゅうタイムだよ、{name}。")},
  {lcd:T("おして かくにんしよう"), voice:T("おして かくにんしてみよう、{name}。")},
  {lcd:T("ゆっくりで だいじょうぶ"), voice:T("ゆっくりで だいじょうぶ、{name}。")},
  {lcd:T("おててを みよう"), voice:T("おててを みよう、{name}。じょうずに おせるよ。")},
  {lcd:T("ちいさな ちょうせん"), voice:T("ちいさな ちょうせん、{name} すごい！")},
  {lcd:T("もう できそう！"), voice:T("もう できそう！{name}！")},
  {lcd:T("きこえた すうじを もういちど"), voice:T("きこえた すうじを もういちど、{name}。")},
  {lcd:T("ふかふか きもちで"), voice:T("ふかふか きもちで いこう、{name}。")},
  {lcd:T("ここで くるり"), voice:T("ここで くるり、きりかえよう、{name}。")},
  {lcd:T("すぐ よくなるよ"), voice:T("すぐ よくなるよ、{name}。")},
  {lcd:T("おしいね〜"), voice:T("おしいね〜、{name}。")},
  {lcd:T("きに ならないよ"), voice:T("きに ならないよ、{name}。")},
  {lcd:T("なぞって いうれんしゅう"), voice:T("なぞって いう れんしゅう してみよう、{name}。")},
  {lcd:T("やれば できる"), voice:T("やれば できる！{name}、ふぁいと！")},
  {lcd:T("いまのは おまけ"), voice:T("いまのは おまけに しちゃおう、{name}。")},
  {lcd:T("なにごとも れんしゅう"), voice:T("なにごとも れんしゅう！{name}、いこう！")},
  {lcd:T("すてっぷ ばい すてっぷ"), voice:T("すてっぷ ばい すてっぷ、{name}！")}
];

/* ====== スコア評価コメント（複数バリエーション） ====== */
const scoreComments = {
  0: [
    {text:"ざんねん、0点！また、がんばろう！", voice:"ざんねん、0てん！また、がんばろう！"},
    {text:"きょうは れんしゅうデー！つぎに つながるよ！", voice:"きょうは れんしゅうデー！つぎに つながるよ！"},
    {text:"スタート ラインに たったよ！", voice:"スタート ラインに たったよ！"},
    {text:"だいじょうぶ。はじめの一歩！", voice:"だいじょうぶ。はじめの いっぽ！"},
    {text:"ここから がんばろう！", voice:"ここから がんばろう！"}
  ],
  1: [
    {text:"よし、1点！よくやった！", voice:"よし、1てん！よくやった！"},
    {text:"ちいさな 1ぽ！すてき！", voice:"ちいさな いっぽ！すてき！"},
    {text:"はじめの しるし、できた！", voice:"はじめの しるし、できた！"},
    {text:"このちょうしで いこう！", voice:"この ちょうしで いこう！"},
    {text:"いいスタート！", voice:"いいスタート！"}
  ],
  2: [
    {text:"お、2点！だんだん覚えてきたね！", voice:"お、2てん！だんだん おぼえてきたね！"},
    {text:"ぐっど！2こ できた！", voice:"ぐっど！2こ できた！"},
    {text:"ふえてきたよ、にこにこ！", voice:"ふえてきたよ、にこにこ！"},
    {text:"ゆっくり じょうずに なってる！", voice:"ゆっくり じょうずに なってる！"},
    {text:"2点、すごい！", voice:"2てん、すごい！"}
  ],
  3: [
    {text:"いいね、3点！その調子！", voice:"いいね、3てん！そのちょうし！"},
    {text:"なかまではんぶん！いいかんじ！", voice:"なかまではんぶん！いいかんじ！"},
    {text:"3こ できた！えらい！", voice:"3こ できた！えらい！"},
    {text:"のってきた！このまま GO！", voice:"のってきた！このまま ゴー！"},
    {text:"3点、にっこり！", voice:"3てん、にっこり！"}
  ],
  4: [
    {text:"すごい、4点！あと一歩でかんぺき！", voice:"すごい、4てん！あと いっぽで かんぺき！"},
    {text:"あとちょっと！どきどき！", voice:"あと ちょっと！どきどき！"},
    {text:"4点、きらきら！", voice:"4てん、きらきら！"},
    {text:"ラスト いっしょに がんばろう！", voice:"ラスト いっしょに がんばろう！"},
    {text:"さいごまで すてき！", voice:"さいごまで すてき！"}
  ],
  5: [
    {text:"やった、5点！満点だ！", voice:"やった、5てん！まんてんだ！"},
    {text:"パーフェクト！はなまる！", voice:"パーフェクト！はなまる！"},
    {text:"100てん の えがお！", voice:"100てん の えがお！"},
    {text:"キラキラ まんてん！", voice:"キラキラ まんてん！"},
    {text:"たいへん よく できました！", voice:"たいへん よく できました！"}
  ]
};

/* ====== 初期化：成功300件のプール作成 ====== */
buildSuccessLines();

/* ====== この先は Part 2/2 へ（進行・判定・演出ロジック） ====== */
</script>

<script>
/* =========================
   Part 2/2 : 進行ロジック
   ========================= */

/* ---- ユーティリティ ---- */
function replaceName(t, name){ return (t||"").split("{name}").join(name); }
function makeRandomDigits(len){ let s=''; for(let i=0;i<len;i++){ s += Math.floor(Math.random()*10).toString(); } return s; }
function flashKey(el){ el.classList.add('glow'); setTimeout(()=>el.classList.remove('glow'), 200); }

/* ---- メッセージ選択 ---- */
function pickSuccessLine(name){
  const i = Math.floor(Math.random()*successLines.length);
  return {
    lcd: replaceName(successLines[i].lcd, name),
    voice: replaceName(successLines[i].voice, name)
  };
}
function pickFailLine(name){
  const i = Math.floor(Math.random()*failLines.length);
  return {
    lcd: replaceName(failLines[i].lcd, name),
    voice: replaceName(failLines[i].voice, name)
  };
}
function pickScoreLine(sc){
  const list = scoreComments[sc] || [{text:`${sc}点`, voice:`${sc}てん`}];
  const i = Math.floor(Math.random()*list.length);
  return list[i];
}

/* ---- 画面更新 ---- */
function updateLCDInputHint(){
  const span = document.querySelector('#typedHint span');
  if(!span) return;
  span.textContent = typedDigits ? typedDigits.split('').join(' ') : '（まだ）';
}

/* ---- 進行制御 ---- */
function setReady(){
  lcd.classList.remove('step2','step4','step5');
  msg.innerHTML = `
    <div class="big">スタート！</div>
    <div class="small">レベル：<b>${level==='easy'?'やさしい（1けた）':'ふつう（2けた）'}</b></div>
    <div style="margin-top:12px"><button class="btn" id="startBtn2">スタート</button></div>`;
  document.getElementById('startBtn2').addEventListener('click', startGame);
  dialBtn.disabled = true;
}

function startGame(){
  cancelSpeak();
  inGame = true; score = 0; round = 0;
  lcd.classList.remove('step2','step4','step5');
  nextRound();
}

function nextRound(){
  round++;
  if(round>5){ endGame(); return; }

  typedDigits = '';
  const len = (level==='easy')?1:2;
  targetDigits = makeRandomDigits(len);

  msg.innerHTML = `
    <div class="big">ラウンド ${round} / 5</div>
    <div class="small">よくきいて、すうじを おしてから、☎を おしてね</div>
    <div class="small code" id="typedHint">あなたの入力：<span>（まだ）</span></div>
  `;

  // お題を読み上げ
  cancelSpeak();
  const lead = "でんわを、かけてね。ばんごうは、";
  speak(lead, {rate:0.88, onend:()=>{
    const kana = readDigitsAsKana(targetDigits);
    speak(kana, {rate:0.9});
  }});

  canInput = true;
  dialBtn.disabled = true;
  updateLCDInputHint();
}

/* ---- 判定（☎押下で発火） ---- */
function handleJudgeWithDial(ok){
  const kName = (nameInput.value?.trim() || "おともだち");
  cancelSpeak();
  canInput = false;
  dialBtn.disabled = true;

  if(ok){
    score++;
    const line = pickSuccessLine(kName);
    // プルルルは「Web Audioの電子音」で再生 → 終了後に成功ボイス
    msg.innerHTML = `<div class="big">プルルルル…</div><div class="small">${line.lcd}</div>`;
    playPurururu({ rings: 1, ringOn: 1.2, ringOff: 0.15 }).then(()=>{
      speak(line.voice, {
        rate: 0.95,
        onend: () => setTimeout(() => nextRound(), 350)
      });
    });
  }else{
    const line = pickFailLine(kName);
    msg.innerHTML = `<div class="big">あれれ…</div><div class="small">${line.lcd}</div>`;
    speak(line.voice, {rate:0.95, onend: () => setTimeout(()=> nextRound(), 300)});
  }
}

/* ---- 結果表示＆演出 ---- */
function burstConfetti(){
  const count = 80;
  for(let i=0;i<count;i++){
    const p = document.createElement('div'); p.className = 'petal';
    const x = Math.random()*window.innerWidth;
    const drift = (Math.random()*160-80)+'px';
    const dur = (5+Math.random()*3)+'s';
    p.style.left = x+'px';
    p.style.setProperty('--x','0px');
    p.style.setProperty('--xend',drift);
    p.style.setProperty('--dur',dur);
    const colors = ['#ff7eb6','#ffd1e6','#ffc1d9','#ff9fc9'];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    confetti.appendChild(p);
    setTimeout(()=>p.remove(), 8000);
  }
}

function endGame(){
  inGame = false; canInput = false;
  lcd.classList.remove('step2','step4','step5');
  if(score>=2 && score<=3) lcd.classList.add('step2');
  if(score===4) lcd.classList.add('step4');
  if(score===5){ lcd.classList.add('step5'); burstConfetti(); }

  const message = pickScoreLine(score);
  msg.innerHTML = `
    <div class="big">${message.text}</div>
    <div style="margin-top:8px;font-size:15px">点数：<b>${score} / 5</b></div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
      <button class="btn" id="againBtn">もういちど</button>
      <button class="btn secondary" id="changeLevel">レベルをえらぶ</button>
    </div>
  `;
  cancelSpeak(); speak(message.voice, {rate:0.95});
  document.getElementById('againBtn').addEventListener('click', startGame);
  document.getElementById('changeLevel').addEventListener('click', setReady);
}

/* ---- イベント配線 ---- */
// レベル切替
btnEasy.addEventListener('click', () => {
  level='easy'; btnEasy.classList.add('active'); btnNormal.classList.remove('active');
  if(!inGame) setReady();
});
btnNormal.addEventListener('click', () => {
  level='normal'; btnNormal.classList.add('active'); btnEasy.classList.remove('active');
  if(!inGame) setReady();
});

// スタート／クリア／リセット
startBtn?.addEventListener('click', startGame);
clearBtn.addEventListener('click', () => { if(!canInput) return; typedDigits=''; updateLCDInputHint(); dialBtn.disabled = true; });
resetBtn.addEventListener('click', resetGame);

// 数字キー：押した瞬間よみあげ
keypad.addEventListener('click', (e)=>{
  const key = e.target.closest('.key');
  if(!key || !canInput) return;
  const n = key.dataset.num;
  flashKey(key);
  cancelSpeak();
  speak(kanaMap[n] || n, {rate:0.95});
  typedDigits += n;
  updateLCDInputHint();

  const needLen = (level==='easy') ? 1 : 2;
  dialBtn.disabled = (typedDigits.length !== needLen);
});

// ☎ボタン：提出
dialBtn.addEventListener('click', ()=>{
  if(!canInput) return;
  const needLen = (level==='easy') ? 1 : 2;
  if(typedDigits.length !== needLen) return;
  const ok = (typedDigits === targetDigits);
  handleJudgeWithDial(ok);
});

/* ---- リセット ---- */
function resetGame(){
  cancelSpeak();
  inGame=false; canInput=false; round=0; score=0; typedDigits=''; targetDigits='';
  confetti.querySelectorAll('.petal').forEach(n=>n.remove());
  setReady();
}

/* ---- 初期化 ---- */
setReady();

/* iOS初回無音 & AudioContext 解放対策（最初のタッチで解放） */
document.addEventListener('touchstart', async function once(){
  try { if (audioCtx.state === 'suspended') await audioCtx.resume(); } catch(e){}
  cancelSpeak();
  document.removeEventListener('touchstart', once);
}, {passive:true});
</script>
</body>
</html>


