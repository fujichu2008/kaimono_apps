<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ã‚‚ã—ã‚‚ã—ã§ã‚“ã‚ã‚²ãƒ¼ãƒ </title>
<meta name="theme-color" content="#2b6ff0">
<style>
:root{
  --bg:#f3f7ff; --card:#ffffff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b6ff0; --accent-2:#2056c7; --good:#10b981; --warn:#ef4444; --lcd:#eaf1ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial;
  display:flex;align-items:center;justify-content:center;padding:16px;
}
.app{width:min(520px,92vw);background:var(--card);border:1px solid #e5ecff;border-radius:24px;box-shadow:0 10px 30px rgba(43,111,240,.12);overflow:hidden}
.header{padding:14px 18px;background:linear-gradient(180deg,#fff 0%,#f7faff 100%);border-bottom:1px solid #e9f0ff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.title .tel{width:34px;height:34px;border-radius:10px;background:var(--accent);display:grid;place-items:center;color:#fff;box-shadow:0 6px 16px rgba(43,111,240,.25)}
.level{display:flex;gap:8px;align-items:center}
.level button{border:1px solid #d9e6ff;background:#fff;color:#244;cursor:pointer;padding:8px 12px;border-radius:999px;font-weight:600}
.level button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.namebox{font-size:12px;color:var(--muted)}
.namebox input{width:8.5em;border:1px solid #d9e6ff;border-radius:8px;padding:4px 8px;margin-left:6px}

/* LCD */
.lcd{margin:16px; padding:14px;border-radius:16px;background:var(--lcd);border:1px solid #d9e6ff;min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center; position:relative; overflow:hidden}
.lcd .msg{font-size:18px}
.lcd .big{font-size:22px;font-weight:800}
.btn{appearance:none;cursor:pointer;user-select:none;outline:none;border:none;background:var(--accent);color:#fff;padding:12px 20px;border-radius:999px;font-weight:800;box-shadow:0 8px 20px rgba(43,111,240,.25)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.btn.ghost{background:#fff;color:#244;border:1px solid #e1e8ff}

/* Phone Face */
.phone{padding:4px 16px 18px}
.symbol{display:grid;place-items:center;margin-bottom:10px}
.dial-btn{
  width:110px;height:110px;border-radius:999px;background:linear-gradient(180deg,#2b6ff0,#1848b4);
  display:grid;place-items:center;color:#fff;font-size:44px;font-weight:900;
  box-shadow:0 14px 28px rgba(43,111,240,.35), inset 0 0 12px rgba(255,255,255,.35);
  border:none;cursor:pointer
}
.dial-btn:disabled{filter:grayscale(.3) brightness(.9);opacity:.7;cursor:not-allowed}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.key{
  background:#fff;border:1px solid #d9e6ff;border-radius:16px;box-shadow:0 6px 14px rgba(0,0,0,.04);
  padding:16px 0;text-align:center;font-size:28px;font-weight:800;color:#0f172a;cursor:pointer;
  transition:transform .06s, box-shadow .2s, background .2s; user-select:none;
}
.key:active{transform:translateY(1px)}
.key.glow{background:#f0f7ff; box-shadow:0 0 0 4px rgba(43,111,240,.18), 0 6px 14px rgba(0,0,0,.06)}
.key[disabled]{opacity:.35;pointer-events:none}

/* footer controls */
.controls{display:flex;justify-content:center;gap:10px;padding:2px 16px 18px}

/* Confetti */
.confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
.petal{position:absolute; width:10px; height:14px; background:#ff7eb6; opacity:.9; border-radius:8px 8px 12px 12px; animation:fall var(--dur) linear forwards}
.petal::after{content:""; position:absolute; inset:0; border-radius:inherit; background:rgba(255,255,255,.35)}
@keyframes fall{0%{transform:translate(var(--x,0),-20px) rotate(0deg)}100%{transform:translate(var(--xend,0), calc(100vh + 40px)) rotate(540deg)}}

/* score color step */
.lcd.step2{background:#e5ffe9;border-color:#c9f7d5}     /* 2-3ç‚¹ */
.lcd.step4{background:#fffbe8;border-color:#ffe3a7}     /* 4ç‚¹ */
.lcd.step5{background:#fff0f5;border-color:#ffc1d9}     /* 5ç‚¹ */

.small{font-size:.875rem;color:var(--muted)}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="title">
      <div class="tel">â˜</div><div>ã‚‚ã—ã‚‚ã—ã§ã‚“ã‚ã‚²ãƒ¼ãƒ </div>
    </div>
    <div class="level">
      <button class="active" data-level="easy" id="btnEasy">ã‚„ã•ã—ã„</button>
      <button data-level="normal" id="btnNormal">ãµã¤ã†</button>
    </div>
  </div>

  <div class="lcd" id="lcd">
    <div class="confetti" id="confetti"></div>
    <div class="msg" id="msg">
      <div class="big">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
      <div class="small">ãƒ¬ãƒ™ãƒ«ã‚’ãˆã‚‰ã‚“ã§ã€ã¯ã˜ã‚ã¦ã­</div>
      <div style="margin-top:12px"><button class="btn" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>
    </div>
  </div>

  <div class="phone">
    <div class="symbol">
      <!-- ç™ºä¿¡ç”¨ â˜ ãƒœã‚¿ãƒ³ï¼ˆæå‡ºãƒœã‚¿ãƒ³ï¼‰ -->
      <button class="dial-btn" id="dialBtn" title="ã§ã‚“ã‚ã‚’ã‹ã‘ã‚‹" disabled>â˜</button>
    </div>
    <div class="keypad" id="keypad">
      <button class="key" data-num="1">1</button>
      <button class="key" data-num="2">2</button>
      <button class="key" data-num="3">3</button>
      <button class="key" data-num="4">4</button>
      <button class="key" data-num="5">5</button>
      <button class="key" data-num="6">6</button>
      <button class="key" data-num="7">7</button>
      <button class="key" data-num="8">8</button>
      <button class="key" data-num="9">9</button>
      <div></div>
      <button class="key" data-num="0">0</button>
      <div></div>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="clearBtn" title="å…¥åŠ›ã‚’æ¶ˆã™">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
    <button class="btn ghost" id="resetBtn" title="ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div class="header" style="border-top:1px solid #e9f0ff;border-bottom:0">
    <div class="namebox">
      ã‚ã„ã¦ã®ãªã¾ãˆï¼š
      <input id="kidName" value="ã‚ã‚„ã‹ã¡ã‚ƒã‚“" aria-label="å‘¼ã³ã‹ã‘ã‚‹åå‰">
    </div>
    <div class="small">5å›ã‚Œã‚“ããã®ã‚²ãƒ¼ãƒ ã§ã™</div>
  </div>
</div>

<script>
/* ====== èª­ã¿ä¸Šã’ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const kanaMap = {"0":"ãœã‚","1":"ã„ã¡","2":"ã«","3":"ã•ã‚“","4":"ã‚ˆã‚“","5":"ã”","6":"ã‚ã","7":"ãªãª","8":"ã¯ã¡","9":"ãã‚…ã†"};
let jpVoice = null;

function pickJapaneseVoice(){
  const list = speechSynthesis.getVoices();
  jpVoice = list.find(v => /ja-JP/i.test(v.lang)) || list.find(v=>/ja/i.test(v.lang)) || null;
}
if ('speechSynthesis' in window) {
  pickJapaneseVoice();
  window.speechSynthesis.onvoiceschanged = pickJapaneseVoice;
}

function speak(text, {rate=0.9, pitch=1, volume=1, onend}={}){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  if(jpVoice) u.voice = jpVoice;
  u.lang = jpVoice?.lang || 'ja-JP';
  u.rate = rate; u.pitch = pitch; u.volume = volume;
  if(typeof onend === 'function'){ u.onend = onend; }
  speechSynthesis.speak(u);
}
function cancelSpeak(){ if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
function readDigitsAsKana(digits){ return digits.split('').map(d=>kanaMap[d]||d).join('ã€'); }

/* ====== å‚ç…§ ====== */
const lcd = document.getElementById('lcd');
const msg = document.getElementById('msg');
const startBtn = document.getElementById('startBtn');
const keypad = document.getElementById('keypad');
const dialBtn = document.getElementById('dialBtn');
const clearBtn = document.getElementById('clearBtn');
const resetBtn = document.getElementById('resetBtn');
const btnEasy = document.getElementById('btnEasy');
const btnNormal = document.getElementById('btnNormal');
const nameInput = document.getElementById('kidName');
const confetti = document.getElementById('confetti');

/* ====== çŠ¶æ…‹ ====== */
let level = 'easy';           // 'easy' 1æ¡ / 'normal' 2æ¡
let round = 0;                // 1..5
let score = 0;                // 0..5
let targetDigits = '';        // ãŠé¡Œ
let typedDigits = '';         // å…¥åŠ›ä¸­
let canInput = false;         // å…¥åŠ›å¯ãƒ•ãƒ©ã‚°
let inGame = false;

/* ====== Web Audioï¼šé›»å­ãƒªãƒ³ã‚¬ãƒ¼ï¼ˆãƒ—ãƒ«ãƒ«ãƒ«é¢¨ï¼‰ ====== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/** é›»å­ãƒªãƒ³ã‚°éŸ³ï¼ˆãƒ—ãƒ«ãƒ«ãƒ«ï¼‰ã‚’åˆæˆã—ã¦é³´ã‚‰ã™ */
function playPurururu({
  rings = 1,          // ä½•å›ã€Œãƒ—ãƒ«ãƒ«ã€ã™ã‚‹ã‹ï¼ˆ1ã€œ2ãŒãŠã™ã™ã‚ï¼‰
  ringOn = 1.2,       // 1å›ã®é³´å‹•é•·ï¼ˆç§’ï¼‰
  ringOff = 0.15,     // é³´å‹•é–“ã®ç„¡éŸ³ï¼ˆç§’ï¼‰
  freq = 950,         // åŸºæœ¬å‘¨æ³¢æ•°ï¼ˆHzï¼‰
  waveform = 'triangle', // 'sine'|'triangle'|'square' ãªã©
  vibratoHz = 18,     // æºã‚Œã®é€Ÿã•ï¼ˆHzï¼‰
  vibratoDepth = 0.5, // æºã‚Œã®æ·±ã•ï¼ˆ0ã€œ1ï¼‰
  volume = 0.35       // éŸ³é‡ï¼ˆ0ã€œ1ï¼‰
} = {}) {
  return new Promise(async (resolve)=>{
    try { if (audioCtx.state === 'suspended') await audioCtx.resume(); } catch(e){}
    const master = audioCtx.createGain(); master.gain.value = 0; master.connect(audioCtx.destination);

    // ã‚­ãƒ£ãƒªã‚¢
    const osc = audioCtx.createOscillator(); osc.type = waveform; osc.frequency.value = freq;

    // AMã§ãƒ–ãƒ«ãƒ«æ„Ÿ
    const lfo = audioCtx.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = vibratoHz;
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = vibratoDepth * volume;
    lfo.connect(lfoGain).connect(master.gain);

    // è€³ã‚ãŸã‚Šã‚’æŸ”ã‚‰ã‹ã
    const filt = audioCtx.createBiquadFilter(); filt.type = 'lowpass'; filt.frequency.value = 1800; filt.Q.value = 0.7;

    osc.connect(filt).connect(master);

    const now = audioCtx.currentTime;
    osc.start(now); lfo.start(now);

    // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—
    let t = now;
    for (let i=0; i<rings; i++) {
      master.gain.setValueAtTime(0, t);
      master.gain.linearRampToValueAtTime(volume, t + 0.02);
      master.gain.setValueAtTime(volume, t + ringOn - 0.05);
      master.gain.linearRampToValueAtTime(0, t + ringOn);
      t += ringOn + ringOff;
    }

    const stopAt = t + 0.02;
    osc.stop(stopAt); lfo.stop(stopAt);
    setTimeout(()=>{ master.disconnect(); resolve(); }, (stopAt - now) * 1000 + 50);
  });
}

/* ====== æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š300ç¨®é¡ã‚’å‹•çš„ç”Ÿæˆ ======
   - å­ã©ã‚‚å‘ã‘ï¼šçŸ­ã„ãƒ»ã‚„ã•ã—ã„ãƒ»å‰å‘ã
   - LCDï¼ˆçŸ­æ–‡ + çµµæ–‡å­—OKï¼‰ã¨ Voiceï¼ˆçµµæ–‡å­—ãƒŠã‚·ï¼‰ã®2è¦ç´ 
   - ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’çµ„ã¿åˆã‚ã›ã€é‡è¤‡æ’é™¤ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«â†’300ä»¶ã«ã‚¹ãƒ©ã‚¤ã‚¹
================================================ */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function uniqByJSON(list){
  const seen=new Set(); const out=[];
  for(const o of list){
    const k=JSON.stringify(o);
    if(!seen.has(k)){ seen.add(k); out.push(o); }
  }
  return out;
}
function T(s){ return s; } // tiny helper

const lcdBases = [
  "ã¤ãªãŒã£ãŸï¼","ã§ã‚“ã‚ ã‹ã‹ã£ãŸã‚ˆï¼","ã›ã„ã“ã†ï¼","ã°ã£ã¡ã‚Šï¼","ãŠã¿ã”ã¨ï¼","ã¯ãªã¾ã‚‹ï¼",
  "ã‚­ãƒ©ã‚­ãƒ©ã§ã‚“ã‚âœ¨","ãƒ”ã‚«ãƒ”ã‚«ã§ã‚“ã‚âœ¨","ã«ã£ã“ã«ã“ï¼","ãƒŠã‚¤ã‚¹ï¼","ãã£ã˜ã‚‡ã¶ï¼","ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼",
  "ãƒŸãƒƒã‚·ãƒ§ãƒ³ ã‚¯ãƒªã‚¢ï¼","ãƒ“ãƒ³ã‚´ï¼","OKï¼","ãŸã„ã¸ã‚“ ã‚ˆãã§ãã¾ã—ãŸ","100ã¦ã‚“ï¼","ã”ã†ã‹ãï¼",
  "ã ã„ã›ã„ã“ã†ï¼","ãƒãƒƒãƒã‚°ãƒ¼ï¼","ã‚¹ã‚¿ãƒ¼ï¼","ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼","ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ï¼","ãƒã‚¹ã‚¿ãƒ¼ï¼",
  "ã“ãˆ ã¨ã©ã„ãŸï¼","ã¤ã†ã—ã‚“OKï¼","ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼","ã«ã“ã«ã“ ã§ã‚“ã‚","ã„ã„ã§ã‚“ã‚ï¼","ã‚„ã£ãŸãƒ¼ï¼",
  "ã†ã¾ãã§ããŸï¼","ã´ã£ãŸã‚Šï¼","ã§ããŸã­ï¼","ã™ã”ã„ï¼","ã™ã¦ãï¼","ã„ã„ã‹ã‚“ã˜ï¼",
  "ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼","ã°ã‚“ã–ã„ï¼","ãƒã‚¤ã‚¿ãƒƒãƒï¼","ã‚ˆã ãã‘ãŸã­ï¼","ã°ã£ã¡ã‚Š ãã¾ã£ãŸï¼","ã‚„ã‚‹ã€œï¼",
  "ã«ã“ã«ã“ ãŸã„ã‚€","ã‚­ãƒ©ã‚­ãƒ© ãŸã„ã‚€","ã«ã£ã“ã‚Šï¼","ã„ã„ãŠã¨ï¼","ã“ãˆ ãŒ ãã“ãˆãŸï¼","ã¨ã©ã„ãŸã‚ˆï¼",
  "ã›ã„ã‹ã„ï¼","ã°ã£ã¡ã‚Š ã‚ã£ã¦ãŸï¼"
];
const lcdDecor = [""," ğŸ‰"," ğŸŒŸ"," âœ¨"," ğŸ’«"," ğŸˆ"," ğŸŒˆ"," ğŸ£"," ğŸ»"," ğŸ¥"," ğŸ€"," ğŸ’"];

const voiceGreets = [ "ã“ã‚“ã«ã¡ã¯","ã‚‚ã—ã‚‚ã—","ã‚„ã£ã»ãƒ¼","ã‚„ã‚","ãƒãƒ­ãƒ¼" ];
const voiceBodiesA = [
  "ã€{name}ï¼ã¤ãªãŒã£ãŸã‚ˆï¼","ã€{name}ï¼ã§ã‚“ã‚ã€ã‹ã‹ã£ãŸã‚ˆï¼","ã€{name}ï¼ã›ã„ã“ã†ã ã‚ˆï¼",
  "ã€{name}ï¼ã°ã£ã¡ã‚Šã§ããŸã­ï¼","ã€{name}ï¼ã´ã£ãŸã‚Š ã‚ã£ã¦ãŸã‚ˆï¼","ã€{name}ï¼ã“ãˆãŒ ã¨ã©ã„ãŸã‚ˆï¼",
  "ã€{name}ï¼ã™ã”ã„ã­ï¼","ã€{name}ï¼ãˆã‚‰ã„ã­ï¼","ã€{name}ï¼ã¨ã£ã¦ã‚‚ ã˜ã‚‡ã†ãšï¼",
  "ã€{name}ï¼ãã®ã¡ã‚‡ã†ã—ï¼","ã€{name}ï¼ãã‚‡ã†ã‚‚ ã’ã‚“ãï¼","ã€{name}ï¼ãƒã‚¤ã‚¿ãƒƒãƒï¼",
  "ã€{name}ï¼ã«ã“ã«ã“ã€œï¼","ã€{name}ï¼ã‚ã‚ŠãŒã¨ã†ï¼","ã€{name}ï¼ã‚°ãƒƒãƒ‰ã‚¸ãƒ§ãƒ–ï¼",
  "ã€{name}ï¼ã¨ã©ã„ãŸ ã¨ã©ã„ãŸï¼","ã€{name}ï¼ãŠã¿ã”ã¨ï¼","ã€{name}ï¼ã‚­ãƒ©ã‚­ãƒ©ã€œï¼",
  "ã€{name}ï¼ã‚ˆã ãã‘ãŸã­ï¼","ã€{name}ï¼ã°ã£ã¡ã‚Š ãã¾ã£ãŸã‚ˆï¼"
];
const voiceTails = [ "", " ãã®ã¡ã‚‡ã†ã—ï¼"," ã•ã„ã“ã†ï¼"," ãˆã‚‰ã„ï¼"," ã‹ã‚“ãºãï¼"," ã™ã”ã„ï¼"," ã†ã‚Œã—ã„ãªï¼"," ã«ã£ã“ã‚Šï¼" ];

const seedPairs = [
  {lcd:T("ã¤ãªãŒã£ãŸï¼"), voice:T("{name}ã€ã‚„ã£ãŸã­ï¼ã¤ãªãŒã£ãŸã‚ˆï¼")},
  {lcd:T("ã§ã‚“ã‚ ã‹ã‹ã£ãŸã‚ˆï¼"), voice:T("ã“ã‚“ã«ã¡ã¯ã€{name}ï¼ã§ã‚“ã‚ã€ã‹ã‹ã£ãŸã‚ˆï¼")},
  {lcd:T("ã¯ãªã¾ã‚‹ï¼"), voice:T("{name}ã€ã¯ãªã¾ã‚‹ï¼ã¨ã£ã¦ã‚‚ ã˜ã‚‡ã†ãšï¼")},
  {lcd:T("ãŠã¿ã”ã¨ï¼"), voice:T("{name}ã€ãŠã¿ã”ã¨ï¼ã°ã£ã¡ã‚Š ã§ããŸã­ï¼")},
  {lcd:T("ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼"), voice:T("ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼{name}ã€ã›ã„ã‹ã„ã ã‚ˆï¼")}
];

let successLines = []; // ã“ã“ã«æœ€çµ‚300ä»¶ã‚’æ ¼ç´
function buildSuccessLines(){
  const pool = [];
  // 1) ã‚·ãƒ¼ãƒ‰
  for(const p of seedPairs){ pool.push({lcd:p.lcd, voice:p.voice}); }
  // 2) çµ„ã¿åˆã‚ã›ç”Ÿæˆ
  for(const base of lcdBases){
    for(const deco of lcdDecor){
      const lcd = (base + deco).trim();
      for(const g of voiceGreets){
        for(const b of voiceBodiesA){
          for(const t of voiceTails){
            const voice = `${g}${b}${t}`.replace(/\s+/g,' ').trim();
            pool.push({lcd, voice});
            if(pool.length>2000) break;
          }
          if(pool.length>2000) break;
        }
        if(pool.length>2000) break;
      }
      if(pool.length>2000) break;
    }
    if(pool.length>2000) break;
  }
  const unique = uniqByJSON(pool);
  shuffle(unique);
  successLines = unique.slice(0, 300);
  while(successLines.length < 300){
    successLines = successLines.concat(seedPairs).slice(0,300);
  }
}

/* ====== å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ50ä»¶ï¼‰ ====== */
const failLines = [
  {lcd:T("ã¾ã¡ãŒã„ã ã£ãŸã‚ˆ"), voice:T("ã‚ã‚Œã‚Œã€{name}ã€‚ã¾ã¡ãŒã„ã ã£ãŸã‚ˆã€‚")},
  {lcd:T("ãŠã—ã„ï¼"), voice:T("ãŠã—ã„ï¼{name}ã€ã‚‚ã†ã™ã“ã—ï¼")},
  {lcd:T("ã ã„ã˜ã‚‡ã†ã¶ï¼"), voice:T("ã ã„ã˜ã‚‡ã†ã¶ï¼{name}ã€ã¤ãã¯ ã§ãã‚‹ã‚ˆï¼")},
  {lcd:T("ã‚†ã£ãã‚Š ãŸã‚ãã†"), voice:T("ã‚†ã£ãã‚Š ãŸã‚ã—ã¦ã¿ã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã‚‚ã†ã„ã£ã‹ã„ï¼"), voice:T("ã‚‚ã†ã„ã£ã‹ã„ ã‚„ã£ã¦ã¿ã‚ˆã†ã€{name}ï¼")},
  {lcd:T("ãã«ã—ãªã„ã§ã­"), voice:T("ãã«ã—ãªã„ã§ã­ã€{name}ã€‚ã ã„ã˜ã‚‡ã†ã¶ï¼")},
  {lcd:T("ã¤ãã¯ ã†ã¾ãã„ãã‚ˆ"), voice:T("ã¤ãã¯ ã†ã¾ãã„ãã‚ˆã€{name}ï¼")},
  {lcd:T("ã„ã£ã—ã‚‡ã« ã‚„ã‚ã†"), voice:T("ã„ã£ã—ã‚‡ã« ã‚„ã‚ã†ã­ã€{name}ï¼")},
  {lcd:T("ã™ã£ã¦ ã¯ã„ã¦"), voice:T("ã™ã£ã¦ã€œ ã¯ã„ã¦ã€œã€‚{name}ã€ãŠã¡ã¤ã„ã¦ã„ã“ã†ï¼")},
  {lcd:T("ã¡ã„ã•ãª ã—ã£ã±ã„OK"), voice:T("ã¡ã„ã•ãª ã—ã£ã±ã„ã¯ OKã ã‚ˆã€{name}ã€‚")},
  {lcd:T("ãŠã¨ã‚’ ã‚ˆããã“ã†"), voice:T("ãŠã¨ã‚’ ã‚ˆããã“ã†ã€{name}ã€‚ã‚‚ã†ã„ã¡ã©ï¼")},
  {lcd:T("ã¡ãŒã£ã¦ã„ãŸã‚ˆ"), voice:T("{name}ã€ã¡ãŒã£ã¦ã„ãŸã‚ˆã€‚ã¤ã ãŸã‚ãã†ï¼")},
  {lcd:T("ã‚ã‚ã¦ãªãã¦OK"), voice:T("ã‚ã‚ã¦ãªãã¦OKã€{name}ã€‚ã‚†ã£ãã‚Šã§ ã„ã„ã‚ˆï¼")},
  {lcd:T("ã²ã¨ã‚„ã™ã¿ã—ã¦OK"), voice:T("ã²ã¨ã‚„ã™ã¿ã—ã¦ã‚‚ ã„ã„ã‚ˆã€{name}ã€‚")},
  {lcd:T("ã¡ã‚‡ã£ã¨ ãšã‚ŒãŸã­"), voice:T("ã¡ã‚‡ã£ã¨ ãšã‚ŒãŸã­ã€{name}ã€‚ã¤ã ã„ã‘ã‚‹ï¼")},
  {lcd:T("ãŠã¼ãˆã¦ã„ã“ã†"), voice:T("ã™ã“ã—ãšã¤ ãŠã¼ãˆã¦ã„ã“ã†ã€{name}ã€‚")},
  {lcd:T("ã“ã“ã‹ã‚‰ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ"), voice:T("ã“ã“ã‹ã‚‰ ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã ã‚ˆã€{name}ï¼")},
  {lcd:T("ã«ã“ã«ã“ ã§ ã‚‚ã†ã„ã¡ã©"), voice:T("ã«ã“ã«ã“ã§ ã‚‚ã†ã„ã¡ã© ã„ã“ã†ã€{name}ï¼")},
  {lcd:T("ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ãŸã„ã›ã¤"), voice:T("ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ãŸã„ã›ã¤ï¼{name}ã€ãˆã‚‰ã„ï¼")},
  {lcd:T("ã‚†ã³ã§ ã‹ããˆã¦ã¿ã‚ˆã†"), voice:T("ã‚†ã³ã§ ã‹ããˆã¦ã¿ã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã‚ˆã ãŒã‚“ã°ã£ãŸã‚ˆ"), voice:T("ã‚ˆã ãŒã‚“ã°ã£ãŸã‚ˆã€{name}ã€‚")},
  {lcd:T("ã¡ã„ã•ã ãµã‚“ã°ã‚ã†"), voice:T("ã¡ã„ã•ã ãµã‚“ã°ã‚ã†ã€{name}ã€‚")},
  {lcd:T("ãã„ã¦ ã¾ã­ã—ã¦ã¿ã‚ˆã†"), voice:T("ãã„ã¦ ã¾ã­ã—ã¦ã¿ã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã¸ã„ã ã¸ã„ã"), voice:T("ã¸ã„ã ã¸ã„ãï¼{name}ã€ã¤ã ã„ã“ï¼")},
  {lcd:T("ãªã‚Œã‚‹ã¨ ã§ãã‚‹ã‚ˆ"), voice:T("ãªã‚Œã‚‹ã¨ ã§ãã‚‹ã‚ˆã€{name}ã€‚")},
  {lcd:T("ã¡ã‚‡ã£ã¨ ã¡ãŒã£ãŸã ã‘"), voice:T("ã¡ã‚‡ã£ã¨ ã¡ãŒã£ãŸã ã‘ã ã‚ˆã€{name}ã€‚")},
  {lcd:T("ãŠã¨ ã‚’ ãããªãŠãã†"), voice:T("ãŠã¨ã‚’ ãããªãŠãã†ã€{name}ã€‚")},
  {lcd:T("ãŠã¡ã¤ã“ã£ã‹"), voice:T("ãŠã¡ã¤ã“ã£ã‹ã€{name}ã€‚")},
  {lcd:T("ã ã‚“ã ã‚“ ã‚ˆããªã‚‹ã‚ˆ"), voice:T("ã ã‚“ã ã‚“ ã‚ˆããªã‚‹ã‚ˆã€{name}ï¼")},
  {lcd:T("ã§ãã‚‹ ãã¿ãªã‚‰"), voice:T("ã§ãã‚‹ï¼{name}ãªã‚‰ ã§ãã‚‹ã‚ˆï¼")},
  {lcd:T("ã„ã¾ã¯ ã‚Œã‚“ã—ã‚…ã†"), voice:T("ã„ã¾ã¯ ã‚Œã‚“ã—ã‚…ã†ã‚¿ã‚¤ãƒ ã ã‚ˆã€{name}ã€‚")},
  {lcd:T("ãŠã—ã¦ ã‹ãã«ã‚“ã—ã‚ˆã†"), voice:T("ãŠã—ã¦ ã‹ãã«ã‚“ã—ã¦ã¿ã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã‚†ã£ãã‚Šã§ ã ã„ã˜ã‚‡ã†ã¶"), voice:T("ã‚†ã£ãã‚Šã§ ã ã„ã˜ã‚‡ã†ã¶ã€{name}ã€‚")},
  {lcd:T("ãŠã¦ã¦ã‚’ ã¿ã‚ˆã†"), voice:T("ãŠã¦ã¦ã‚’ ã¿ã‚ˆã†ã€{name}ã€‚ã˜ã‚‡ã†ãšã« ãŠã›ã‚‹ã‚ˆã€‚")},
  {lcd:T("ã¡ã„ã•ãª ã¡ã‚‡ã†ã›ã‚“"), voice:T("ã¡ã„ã•ãª ã¡ã‚‡ã†ã›ã‚“ã€{name} ã™ã”ã„ï¼")},
  {lcd:T("ã‚‚ã† ã§ããã†ï¼"), voice:T("ã‚‚ã† ã§ããã†ï¼{name}ï¼")},
  {lcd:T("ãã“ãˆãŸ ã™ã†ã˜ã‚’ ã‚‚ã†ã„ã¡ã©"), voice:T("ãã“ãˆãŸ ã™ã†ã˜ã‚’ ã‚‚ã†ã„ã¡ã©ã€{name}ã€‚")},
  {lcd:T("ãµã‹ãµã‹ ãã‚‚ã¡ã§"), voice:T("ãµã‹ãµã‹ ãã‚‚ã¡ã§ ã„ã“ã†ã€{name}ã€‚")},
  {lcd:T("ã“ã“ã§ ãã‚‹ã‚Š"), voice:T("ã“ã“ã§ ãã‚‹ã‚Šã€ãã‚Šã‹ãˆã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã™ã ã‚ˆããªã‚‹ã‚ˆ"), voice:T("ã™ã ã‚ˆããªã‚‹ã‚ˆã€{name}ã€‚")},
  {lcd:T("ãŠã—ã„ã­ã€œ"), voice:T("ãŠã—ã„ã­ã€œã€{name}ã€‚")},
  {lcd:T("ãã« ãªã‚‰ãªã„ã‚ˆ"), voice:T("ãã« ãªã‚‰ãªã„ã‚ˆã€{name}ã€‚")},
  {lcd:T("ãªãã£ã¦ ã„ã†ã‚Œã‚“ã—ã‚…ã†"), voice:T("ãªãã£ã¦ ã„ã† ã‚Œã‚“ã—ã‚…ã† ã—ã¦ã¿ã‚ˆã†ã€{name}ã€‚")},
  {lcd:T("ã‚„ã‚Œã° ã§ãã‚‹"), voice:T("ã‚„ã‚Œã° ã§ãã‚‹ï¼{name}ã€ãµãã„ã¨ï¼")},
  {lcd:T("ã„ã¾ã®ã¯ ãŠã¾ã‘"), voice:T("ã„ã¾ã®ã¯ ãŠã¾ã‘ã« ã—ã¡ã‚ƒãŠã†ã€{name}ã€‚")},
  {lcd:T("ãªã«ã”ã¨ã‚‚ ã‚Œã‚“ã—ã‚…ã†"), voice:T("ãªã«ã”ã¨ã‚‚ ã‚Œã‚“ã—ã‚…ã†ï¼{name}ã€ã„ã“ã†ï¼")},
  {lcd:T("ã™ã¦ã£ã· ã°ã„ ã™ã¦ã£ã·"), voice:T("ã™ã¦ã£ã· ã°ã„ ã™ã¦ã£ã·ã€{name}ï¼")}
];

/* ====== ã‚¹ã‚³ã‚¢è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè¤‡æ•°ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ ====== */
const scoreComments = {
  0: [
    {text:"ã–ã‚“ã­ã‚“ã€0ç‚¹ï¼ã¾ãŸã€ãŒã‚“ã°ã‚ã†ï¼", voice:"ã–ã‚“ã­ã‚“ã€0ã¦ã‚“ï¼ã¾ãŸã€ãŒã‚“ã°ã‚ã†ï¼"},
    {text:"ãã‚‡ã†ã¯ ã‚Œã‚“ã—ã‚…ã†ãƒ‡ãƒ¼ï¼ã¤ãã« ã¤ãªãŒã‚‹ã‚ˆï¼", voice:"ãã‚‡ã†ã¯ ã‚Œã‚“ã—ã‚…ã†ãƒ‡ãƒ¼ï¼ã¤ãã« ã¤ãªãŒã‚‹ã‚ˆï¼"},
    {text:"ã‚¹ã‚¿ãƒ¼ãƒˆ ãƒ©ã‚¤ãƒ³ã« ãŸã£ãŸã‚ˆï¼", voice:"ã‚¹ã‚¿ãƒ¼ãƒˆ ãƒ©ã‚¤ãƒ³ã« ãŸã£ãŸã‚ˆï¼"},
    {text:"ã ã„ã˜ã‚‡ã†ã¶ã€‚ã¯ã˜ã‚ã®ä¸€æ­©ï¼", voice:"ã ã„ã˜ã‚‡ã†ã¶ã€‚ã¯ã˜ã‚ã® ã„ã£ã½ï¼"},
    {text:"ã“ã“ã‹ã‚‰ ãŒã‚“ã°ã‚ã†ï¼", voice:"ã“ã“ã‹ã‚‰ ãŒã‚“ã°ã‚ã†ï¼"}
  ],
  1: [
    {text:"ã‚ˆã—ã€1ç‚¹ï¼ã‚ˆãã‚„ã£ãŸï¼", voice:"ã‚ˆã—ã€1ã¦ã‚“ï¼ã‚ˆãã‚„ã£ãŸï¼"},
    {text:"ã¡ã„ã•ãª 1ã½ï¼ã™ã¦ãï¼", voice:"ã¡ã„ã•ãª ã„ã£ã½ï¼ã™ã¦ãï¼"},
    {text:"ã¯ã˜ã‚ã® ã—ã‚‹ã—ã€ã§ããŸï¼", voice:"ã¯ã˜ã‚ã® ã—ã‚‹ã—ã€ã§ããŸï¼"},
    {text:"ã“ã®ã¡ã‚‡ã†ã—ã§ ã„ã“ã†ï¼", voice:"ã“ã® ã¡ã‚‡ã†ã—ã§ ã„ã“ã†ï¼"},
    {text:"ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆï¼", voice:"ã„ã„ã‚¹ã‚¿ãƒ¼ãƒˆï¼"}
  ],
  2: [
    {text:"ãŠã€2ç‚¹ï¼ã ã‚“ã ã‚“è¦šãˆã¦ããŸã­ï¼", voice:"ãŠã€2ã¦ã‚“ï¼ã ã‚“ã ã‚“ ãŠã¼ãˆã¦ããŸã­ï¼"},
    {text:"ãã£ã©ï¼2ã“ ã§ããŸï¼", voice:"ãã£ã©ï¼2ã“ ã§ããŸï¼"},
    {text:"ãµãˆã¦ããŸã‚ˆã€ã«ã“ã«ã“ï¼", voice:"ãµãˆã¦ããŸã‚ˆã€ã«ã“ã«ã“ï¼"},
    {text:"ã‚†ã£ãã‚Š ã˜ã‚‡ã†ãšã« ãªã£ã¦ã‚‹ï¼", voice:"ã‚†ã£ãã‚Š ã˜ã‚‡ã†ãšã« ãªã£ã¦ã‚‹ï¼"},
    {text:"2ç‚¹ã€ã™ã”ã„ï¼", voice:"2ã¦ã‚“ã€ã™ã”ã„ï¼"}
  ],
  3: [
    {text:"ã„ã„ã­ã€3ç‚¹ï¼ãã®èª¿å­ï¼", voice:"ã„ã„ã­ã€3ã¦ã‚“ï¼ãã®ã¡ã‚‡ã†ã—ï¼"},
    {text:"ãªã‹ã¾ã§ã¯ã‚“ã¶ã‚“ï¼ã„ã„ã‹ã‚“ã˜ï¼", voice:"ãªã‹ã¾ã§ã¯ã‚“ã¶ã‚“ï¼ã„ã„ã‹ã‚“ã˜ï¼"},
    {text:"3ã“ ã§ããŸï¼ãˆã‚‰ã„ï¼", voice:"3ã“ ã§ããŸï¼ãˆã‚‰ã„ï¼"},
    {text:"ã®ã£ã¦ããŸï¼ã“ã®ã¾ã¾ GOï¼", voice:"ã®ã£ã¦ããŸï¼ã“ã®ã¾ã¾ ã‚´ãƒ¼ï¼"},
    {text:"3ç‚¹ã€ã«ã£ã“ã‚Šï¼", voice:"3ã¦ã‚“ã€ã«ã£ã“ã‚Šï¼"}
  ],
  4: [
    {text:"ã™ã”ã„ã€4ç‚¹ï¼ã‚ã¨ä¸€æ­©ã§ã‹ã‚“ãºãï¼", voice:"ã™ã”ã„ã€4ã¦ã‚“ï¼ã‚ã¨ ã„ã£ã½ã§ ã‹ã‚“ãºãï¼"},
    {text:"ã‚ã¨ã¡ã‚‡ã£ã¨ï¼ã©ãã©ãï¼", voice:"ã‚ã¨ ã¡ã‚‡ã£ã¨ï¼ã©ãã©ãï¼"},
    {text:"4ç‚¹ã€ãã‚‰ãã‚‰ï¼", voice:"4ã¦ã‚“ã€ãã‚‰ãã‚‰ï¼"},
    {text:"ãƒ©ã‚¹ãƒˆ ã„ã£ã—ã‚‡ã« ãŒã‚“ã°ã‚ã†ï¼", voice:"ãƒ©ã‚¹ãƒˆ ã„ã£ã—ã‚‡ã« ãŒã‚“ã°ã‚ã†ï¼"},
    {text:"ã•ã„ã”ã¾ã§ ã™ã¦ãï¼", voice:"ã•ã„ã”ã¾ã§ ã™ã¦ãï¼"}
  ],
  5: [
    {text:"ã‚„ã£ãŸã€5ç‚¹ï¼æº€ç‚¹ã ï¼", voice:"ã‚„ã£ãŸã€5ã¦ã‚“ï¼ã¾ã‚“ã¦ã‚“ã ï¼"},
    {text:"ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã¯ãªã¾ã‚‹ï¼", voice:"ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã¯ãªã¾ã‚‹ï¼"},
    {text:"100ã¦ã‚“ ã® ãˆãŒãŠï¼", voice:"100ã¦ã‚“ ã® ãˆãŒãŠï¼"},
    {text:"ã‚­ãƒ©ã‚­ãƒ© ã¾ã‚“ã¦ã‚“ï¼", voice:"ã‚­ãƒ©ã‚­ãƒ© ã¾ã‚“ã¦ã‚“ï¼"},
    {text:"ãŸã„ã¸ã‚“ ã‚ˆã ã§ãã¾ã—ãŸï¼", voice:"ãŸã„ã¸ã‚“ ã‚ˆã ã§ãã¾ã—ãŸï¼"}
  ]
};

/* ====== åˆæœŸåŒ–ï¼šæˆåŠŸ300ä»¶ã®ãƒ—ãƒ¼ãƒ«ä½œæˆ ====== */
buildSuccessLines();

/* ====== ã“ã®å…ˆã¯ Part 2/2 ã¸ï¼ˆé€²è¡Œãƒ»åˆ¤å®šãƒ»æ¼”å‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ====== */
</script>

<script>
/* =========================
   Part 2/2 : é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯
   ========================= */

/* ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---- */
function replaceName(t, name){ return (t||"").split("{name}").join(name); }
function makeRandomDigits(len){ let s=''; for(let i=0;i<len;i++){ s += Math.floor(Math.random()*10).toString(); } return s; }
function flashKey(el){ el.classList.add('glow'); setTimeout(()=>el.classList.remove('glow'), 200); }

/* ---- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é¸æŠ ---- */
function pickSuccessLine(name){
  const i = Math.floor(Math.random()*successLines.length);
  return {
    lcd: replaceName(successLines[i].lcd, name),
    voice: replaceName(successLines[i].voice, name)
  };
}
function pickFailLine(name){
  const i = Math.floor(Math.random()*failLines.length);
  return {
    lcd: replaceName(failLines[i].lcd, name),
    voice: replaceName(failLines[i].voice, name)
  };
}
function pickScoreLine(sc){
  const list = scoreComments[sc] || [{text:`${sc}ç‚¹`, voice:`${sc}ã¦ã‚“`}];
  const i = Math.floor(Math.random()*list.length);
  return list[i];
}

/* ---- ç”»é¢æ›´æ–° ---- */
function updateLCDInputHint(){
  const span = document.querySelector('#typedHint span');
  if(!span) return;
  span.textContent = typedDigits ? typedDigits.split('').join(' ') : 'ï¼ˆã¾ã ï¼‰';
}

/* ---- é€²è¡Œåˆ¶å¾¡ ---- */
function setReady(){
  lcd.classList.remove('step2','step4','step5');
  msg.innerHTML = `
    <div class="big">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
    <div class="small">ãƒ¬ãƒ™ãƒ«ï¼š<b>${level==='easy'?'ã‚„ã•ã—ã„ï¼ˆ1ã‘ãŸï¼‰':'ãµã¤ã†ï¼ˆ2ã‘ãŸï¼‰'}</b></div>
    <div style="margin-top:12px"><button class="btn" id="startBtn2">ã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>`;
  document.getElementById('startBtn2').addEventListener('click', startGame);
  dialBtn.disabled = true;
}

function startGame(){
  cancelSpeak();
  inGame = true; score = 0; round = 0;
  lcd.classList.remove('step2','step4','step5');
  nextRound();
}

function nextRound(){
  round++;
  if(round>5){ endGame(); return; }

  typedDigits = '';
  const len = (level==='easy')?1:2;
  targetDigits = makeRandomDigits(len);

  msg.innerHTML = `
    <div class="big">ãƒ©ã‚¦ãƒ³ãƒ‰ ${round} / 5</div>
    <div class="small">ã‚ˆããã„ã¦ã€ã™ã†ã˜ã‚’ ãŠã—ã¦ã‹ã‚‰ã€â˜ã‚’ ãŠã—ã¦ã­</div>
    <div class="small code" id="typedHint">ã‚ãªãŸã®å…¥åŠ›ï¼š<span>ï¼ˆã¾ã ï¼‰</span></div>
  `;

  // ãŠé¡Œã‚’èª­ã¿ä¸Šã’
  cancelSpeak();
  const lead = "ã§ã‚“ã‚ã‚’ã€ã‹ã‘ã¦ã­ã€‚ã°ã‚“ã”ã†ã¯ã€";
  speak(lead, {rate:0.88, onend:()=>{
    const kana = readDigitsAsKana(targetDigits);
    speak(kana, {rate:0.9});
  }});

  canInput = true;
  dialBtn.disabled = true;
  updateLCDInputHint();
}

/* ---- åˆ¤å®šï¼ˆâ˜æŠ¼ä¸‹ã§ç™ºç«ï¼‰ ---- */
function handleJudgeWithDial(ok){
  const kName = (nameInput.value?.trim() || "ãŠã¨ã‚‚ã ã¡");
  cancelSpeak();
  canInput = false;
  dialBtn.disabled = true;

  if(ok){
    score++;
    const line = pickSuccessLine(kName);
    // ãƒ—ãƒ«ãƒ«ãƒ«ã¯ã€ŒWeb Audioã®é›»å­éŸ³ã€ã§å†ç”Ÿ â†’ çµ‚äº†å¾Œã«æˆåŠŸãƒœã‚¤ã‚¹
    msg.innerHTML = `<div class="big">ãƒ—ãƒ«ãƒ«ãƒ«ãƒ«â€¦</div><div class="small">${line.lcd}</div>`;
    playPurururu({ rings: 1, ringOn: 1.2, ringOff: 0.15 }).then(()=>{
      speak(line.voice, {
        rate: 0.95,
        onend: () => setTimeout(() => nextRound(), 350)
      });
    });
  }else{
    const line = pickFailLine(kName);
    msg.innerHTML = `<div class="big">ã‚ã‚Œã‚Œâ€¦</div><div class="small">${line.lcd}</div>`;
    speak(line.voice, {rate:0.95, onend: () => setTimeout(()=> nextRound(), 300)});
  }
}

/* ---- çµæœè¡¨ç¤ºï¼†æ¼”å‡º ---- */
function burstConfetti(){
  const count = 80;
  for(let i=0;i<count;i++){
    const p = document.createElement('div'); p.className = 'petal';
    const x = Math.random()*window.innerWidth;
    const drift = (Math.random()*160-80)+'px';
    const dur = (5+Math.random()*3)+'s';
    p.style.left = x+'px';
    p.style.setProperty('--x','0px');
    p.style.setProperty('--xend',drift);
    p.style.setProperty('--dur',dur);
    const colors = ['#ff7eb6','#ffd1e6','#ffc1d9','#ff9fc9'];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    confetti.appendChild(p);
    setTimeout(()=>p.remove(), 8000);
  }
}

function endGame(){
  inGame = false; canInput = false;
  lcd.classList.remove('step2','step4','step5');
  if(score>=2 && score<=3) lcd.classList.add('step2');
  if(score===4) lcd.classList.add('step4');
  if(score===5){ lcd.classList.add('step5'); burstConfetti(); }

  const message = pickScoreLine(score);
  msg.innerHTML = `
    <div class="big">${message.text}</div>
    <div style="margin-top:8px;font-size:15px">ç‚¹æ•°ï¼š<b>${score} / 5</b></div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
      <button class="btn" id="againBtn">ã‚‚ã†ã„ã¡ã©</button>
      <button class="btn secondary" id="changeLevel">ãƒ¬ãƒ™ãƒ«ã‚’ãˆã‚‰ã¶</button>
    </div>
  `;
  cancelSpeak(); speak(message.voice, {rate:0.95});
  document.getElementById('againBtn').addEventListener('click', startGame);
  document.getElementById('changeLevel').addEventListener('click', setReady);
}

/* ---- ã‚¤ãƒ™ãƒ³ãƒˆé…ç·š ---- */
// ãƒ¬ãƒ™ãƒ«åˆ‡æ›¿
btnEasy.addEventListener('click', () => {
  level='easy'; btnEasy.classList.add('active'); btnNormal.classList.remove('active');
  if(!inGame) setReady();
});
btnNormal.addEventListener('click', () => {
  level='normal'; btnNormal.classList.add('active'); btnEasy.classList.remove('active');
  if(!inGame) setReady();
});

// ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã‚¯ãƒªã‚¢ï¼ãƒªã‚»ãƒƒãƒˆ
startBtn?.addEventListener('click', startGame);
clearBtn.addEventListener('click', () => { if(!canInput) return; typedDigits=''; updateLCDInputHint(); dialBtn.disabled = true; });
resetBtn.addEventListener('click', resetGame);

// æ•°å­—ã‚­ãƒ¼ï¼šæŠ¼ã—ãŸç¬é–“ã‚ˆã¿ã‚ã’
keypad.addEventListener('click', (e)=>{
  const key = e.target.closest('.key');
  if(!key || !canInput) return;
  const n = key.dataset.num;
  flashKey(key);
  cancelSpeak();
  speak(kanaMap[n] || n, {rate:0.95});
  typedDigits += n;
  updateLCDInputHint();

  const needLen = (level==='easy') ? 1 : 2;
  dialBtn.disabled = (typedDigits.length !== needLen);
});

// â˜ãƒœã‚¿ãƒ³ï¼šæå‡º
dialBtn.addEventListener('click', ()=>{
  if(!canInput) return;
  const needLen = (level==='easy') ? 1 : 2;
  if(typedDigits.length !== needLen) return;
  const ok = (typedDigits === targetDigits);
  handleJudgeWithDial(ok);
});

/* ---- ãƒªã‚»ãƒƒãƒˆ ---- */
function resetGame(){
  cancelSpeak();
  inGame=false; canInput=false; round=0; score=0; typedDigits=''; targetDigits='';
  confetti.querySelectorAll('.petal').forEach(n=>n.remove());
  setReady();
}

/* ---- åˆæœŸåŒ– ---- */
setReady();

/* iOSåˆå›ç„¡éŸ³ & AudioContext è§£æ”¾å¯¾ç­–ï¼ˆæœ€åˆã®ã‚¿ãƒƒãƒã§è§£æ”¾ï¼‰ */
document.addEventListener('touchstart', async function once(){
  try { if (audioCtx.state === 'suspended') await audioCtx.resume(); } catch(e){}
  cancelSpeak();
  document.removeEventListener('touchstart', once);
}, {passive:true});
</script>
</body>
</html>


