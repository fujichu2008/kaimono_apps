<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>もしもしでんわゲーム</title>
<meta name="theme-color" content="#2b6ff0">
<style>
:root{
  --bg:#f3f7ff; --card:#ffffff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#2b6ff0; --accent-2:#2056c7; --good:#10b981; --warn:#ef4444; --lcd:#eaf1ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,Arial;
  display:flex;align-items:center;justify-content:center;padding:16px;
}
.app{width:min(520px,92vw);background:var(--card);border:1px solid #e5ecff;border-radius:24px;box-shadow:0 10px 30px rgba(43,111,240,.12);overflow:hidden}
.header{padding:14px 18px;background:linear-gradient(180deg,#fff 0%,#f7faff 100%);border-bottom:1px solid #e9f0ff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.title{display:flex;align-items:center;gap:10px;font-weight:700}
.title .tel{width:34px;height:34px;border-radius:10px;background:var(--accent);display:grid;place-items:center;color:#fff;box-shadow:0 6px 16px rgba(43,111,240,.25)}
.level{display:flex;gap:8px;align-items:center}
.level button{border:1px solid #d9e6ff;background:#fff;color:#244;cursor:pointer;padding:8px 12px;border-radius:999px;font-weight:600}
.level button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.namebox{font-size:12px;color:var(--muted)}
.namebox input{width:8em;border:1px solid #d9e6ff;border-radius:8px;padding:4px 8px;margin-left:6px}

/* LCD */
.lcd{margin:16px; padding:14px;border-radius:16px;background:var(--lcd);border:1px solid #d9e6ff;min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center; position:relative; overflow:hidden}
.lcd .msg{font-size:18px}
.lcd .big{font-size:22px;font-weight:800}
.btn{appearance:none;cursor:pointer;user-select:none;outline:none;border:none;background:var(--accent);color:#fff;padding:12px 20px;border-radius:999px;font-weight:800;box-shadow:0 8px 20px rgba(43,111,240,.25)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.btn.ghost{background:#fff;color:#244;border:1px solid #e1e8ff}

/* Phone Face */
.phone{padding:4px 16px 18px}
.symbol{display:grid;place-items:center;margin-bottom:10px}
.dial-btn{
  width:110px;height:110px;border-radius:999px;background:linear-gradient(180deg,#2b6ff0,#1848b4);
  display:grid;place-items:center;color:#fff;font-size:44px;font-weight:900;
  box-shadow:0 14px 28px rgba(43,111,240,.35), inset 0 0 12px rgba(255,255,255,.35);
  border:none;cursor:pointer
}
.dial-btn:disabled{filter:grayscale(.3) brightness(.9);opacity:.7;cursor:not-allowed}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.key{
  background:#fff;border:1px solid #d9e6ff;border-radius:16px;box-shadow:0 6px 14px rgba(0,0,0,.04);
  padding:16px 0;text-align:center;font-size:28px;font-weight:800;color:#0f172a;cursor:pointer;
  transition:transform .06s, box-shadow .2s, background .2s; user-select:none;
}
.key:active{transform:translateY(1px)}
.key.glow{background:#f0f7ff; box-shadow:0 0 0 4px rgba(43,111,240,.18), 0 6px 14px rgba(0,0,0,.06)}
.key[disabled]{opacity:.35;pointer-events:none}

/* footer controls */
.controls{display:flex;justify-content:center;gap:10px;padding:2px 16px 18px}

/* Confetti */
.confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
.petal{position:absolute; width:10px; height:14px; background:#ff7eb6; opacity:.9; border-radius:8px 8px 12px 12px; animation:fall var(--dur) linear forwards}
.petal::after{content:""; position:absolute; inset:0; border-radius:inherit; background:rgba(255,255,255,.35)}
@keyframes fall{0%{transform:translate(var(--x,0),-20px) rotate(0deg)}100%{transform:translate(var(--xend,0), calc(100vh + 40px)) rotate(540deg)}}

/* score color step */
.lcd.step2{background:#e5ffe9;border-color:#c9f7d5}     /* 2-3点 */
.lcd.step4{background:#fffbe8;border-color:#ffe3a7}     /* 4点 */
.lcd.step5{background:#fff0f5;border-color:#ffc1d9}     /* 5点 */

.small{font-size:.875rem;color:var(--muted)}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="title">
      <div class="tel">☎</div><div>もしもしでんわゲーム</div>
    </div>
    <div class="level">
      <button class="active" data-level="easy" id="btnEasy">やさしい</button>
      <button data-level="normal" id="btnNormal">ふつう</button>
    </div>
  </div>

  <div class="lcd" id="lcd">
    <div class="confetti" id="confetti"></div>
    <div class="msg" id="msg">
      <div class="big">スタート！</div>
      <div class="small">レベルをえらんで、はじめてね</div>
      <div style="margin-top:12px">
        <button class="btn" id="startBtn">スタート</button>
      </div>
    </div>
  </div>

  <div class="phone">
    <div class="symbol">
      <!-- 発信用 ☎ ボタン（提出ボタン） -->
      <button class="dial-btn" id="dialBtn" title="でんわをかける" disabled>☎</button>
    </div>
    <div class="keypad" id="keypad">
      <button class="key" data-num="1">1</button>
      <button class="key" data-num="2">2</button>
      <button class="key" data-num="3">3</button>
      <button class="key" data-num="4">4</button>
      <button class="key" data-num="5">5</button>
      <button class="key" data-num="6">6</button>
      <button class="key" data-num="7">7</button>
      <button class="key" data-num="8">8</button>
      <button class="key" data-num="9">9</button>
      <div></div>
      <button class="key" data-num="0">0</button>
      <div></div>
    </div>
  </div>

  <div class="controls">
    <button class="btn ghost" id="clearBtn" title="入力を消す">入力クリア</button>
    <button class="btn ghost" id="resetBtn" title="ゲームをリセット">リセット</button>
  </div>

  <div class="header" style="border-top:1px solid #e9f0ff;border-bottom:0">
    <div class="namebox">
      あいてのなまえ：
      <input id="kidName" value="あやかちゃん" aria-label="呼びかける名前">
    </div>
    <div class="small">5回れんぞくのゲームです</div>
  </div>
</div>

<script>
/* ====== 読み上げユーティリティ ====== */
const kanaMap = {"0":"ぜろ","1":"いち","2":"に","3":"さん","4":"よん","5":"ご","6":"ろく","7":"なな","8":"はち","9":"きゅう"};
let jpVoice = null;

function pickJapaneseVoice(){
  const list = speechSynthesis.getVoices();
  jpVoice = list.find(v => /ja-JP/i.test(v.lang)) || list.find(v=>/ja/i.test(v.lang)) || null;
}
if ('speechSynthesis' in window) {
  pickJapaneseVoice();
  window.speechSynthesis.onvoiceschanged = pickJapaneseVoice;
}

function speak(text, {rate=0.9, pitch=1, volume=1, onend}={}){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  if(jpVoice) u.voice = jpVoice;
  u.lang = jpVoice?.lang || 'ja-JP';
  u.rate = rate; u.pitch = pitch; u.volume = volume;
  if(typeof onend === 'function'){ u.onend = onend; }
  speechSynthesis.speak(u);
}
function cancelSpeak(){ if('speechSynthesis' in window){ speechSynthesis.cancel(); } }
function readDigitsAsKana(digits){ return digits.split('').map(d=>kanaMap[d]||d).join('、'); }

/* ====== 参照 ====== */
const lcd = document.getElementById('lcd');
const msg = document.getElementById('msg');
const startBtn = document.getElementById('startBtn');
const keypad = document.getElementById('keypad');
const dialBtn = document.getElementById('dialBtn');
const clearBtn = document.getElementById('clearBtn');
const resetBtn = document.getElementById('resetBtn');
const btnEasy = document.getElementById('btnEasy');
const btnNormal = document.getElementById('btnNormal');
const nameInput = document.getElementById('kidName');
const confetti = document.getElementById('confetti');

/* ====== 状態 ====== */
let level = 'easy';           // 'easy' 1桁 / 'normal' 2桁
let round = 0;                // 1..5
let score = 0;                // 0..5
let targetDigits = '';        // お題
let typedDigits = '';         // 入力中
let canInput = false;         // 入力可フラグ
let inGame = false;

btnEasy.addEventListener('click', () => { level='easy'; btnEasy.classList.add('active'); btnNormal.classList.remove('active'); if(!inGame) setReady(); });
btnNormal.addEventListener('click', () => { level='normal'; btnNormal.classList.add('active'); btnEasy.classList.remove('active'); if(!inGame) setReady(); });

resetBtn.addEventListener('click', resetGame);
clearBtn.addEventListener('click', () => { if(!canInput) return; typedDigits=''; updateLCDInputHint(); dialBtn.disabled = true; });
startBtn?.addEventListener('click', startGame);

/* ====== 数字入力：押したら即 読み上げ（直前はキャンセル） ====== */
keypad.addEventListener('click', (e)=>{
  const key = e.target.closest('.key');
  if(!key || !canInput) return;
  const n = key.dataset.num;
  flashKey(key);
  cancelSpeak();
  speak(kanaMap[n] || n, {rate:0.95});
  typedDigits += n;
  updateLCDInputHint();
  // 指定桁数に達したらダイヤル可能
  const needLen = (level==='easy') ? 1 : 2;
  dialBtn.disabled = (typedDigits.length !== needLen);
});

/* ====== ☎ 発信（提出）→ 正誤判定 ====== */
dialBtn.addEventListener('click', ()=>{
  if(!canInput) return;
  const needLen = (level==='easy') ? 1 : 2;
  if(typedDigits.length !== needLen) return; // 念のため
  canInput = false;
  const ok = (typedDigits === targetDigits);
  handleJudgeWithDial(ok);
});

function flashKey(el){ el.classList.add('glow'); setTimeout(()=>el.classList.remove('glow'), 200); }

/* ====== 進行 ====== */
function setReady(){
  lcd.classList.remove('step2','step4','step5');
  msg.innerHTML = `
    <div class="big">スタート！</div>
    <div class="small">レベル：<b>${level==='easy'?'やさしい（1けた）':'ふつう（2けた）'}</b></div>
    <div style="margin-top:12px"><button class="btn" id="startBtn2">スタート</button></div>`;
  document.getElementById('startBtn2').addEventListener('click', startGame);
  dialBtn.disabled = true;
}

function startGame(){
  cancelSpeak();
  inGame = true; score = 0; round = 0;
  lcd.classList.remove('step2','step4','step5');
  nextRound();
}

function nextRound(){
  round++;
  if(round>5){ endGame(); return; }
  typedDigits = '';
  const len = (level==='easy')?1:2;
  targetDigits = makeRandomDigits(len);
  // 表示
  msg.innerHTML = `
    <div class="big">ラウンド ${round} / 5</div>
    <div class="small">よくきいて、すうじを おしてから、☎を おしてね</div>
    <div class="small code" id="typedHint">あなたの入力：<span>（まだ）</span></div>
  `;
  // 読み上げ
  cancelSpeak();
  const lead = "でんわを、かけてね。ばんごうは、";
  speak(lead, {rate:0.88, onend:()=>{
    const kana = readDigitsAsKana(targetDigits);
    speak(kana, {rate:0.9});
  }});
  // 入力許可
  canInput = true;
  dialBtn.disabled = true;
  updateLCDInputHint();
}

function updateLCDInputHint(){
  const span = document.querySelector('#typedHint span');
  if(!span) return;
  span.textContent = typedDigits ? typedDigits.split('').join(' ') : '（まだ）';
}

/* ====== 判定（☎発信版） ====== */
function handleJudgeWithDial(ok){
  const kName = nameInput.value?.trim() || "おともだち";
  cancelSpeak();

  // 入力を完全停止
  canInput = false;
  dialBtn.disabled = true;

  if(ok){
    score++;
    // 表示
    msg.innerHTML = `<div class="big">プルルルル…</div><div class="small">でんわ かかったよ！</div>`;

    // 発話：プルルルル → あいさつ → （発話完了を待ってから）次ラウンド
    speak("プルルルルルル…", {
      rate: 1.0,
      onend: () => {
        speak(`こんにちは、${kName}！でんわ、かかったよ！`, {
          rate: 0.95,
          onend: () => {
            // 少し間をおいてから次へ（連続読上げの切れ味を良くする）
            setTimeout(() => nextRound(), 350);
          }
        });
      }
    });

  } else {
    // 表示
    msg.innerHTML = `<div class="big">あれれ…</div><div class="small">まちがいだよ</div>`;

    // 発話が終わってから次へ
    speak("あれれ、まちがいだよ。", {
      rate: 0.95,
      onend: () => {
        setTimeout(() => nextRound(), 300);
      }
    });
  }
}


function endGame(){
  inGame = false; canInput = false;
  lcd.classList.remove('step2','step4','step5');
  if(score>=2 && score<=3) lcd.classList.add('step2');
  if(score===4) lcd.classList.add('step4');
  if(score===5){ lcd.classList.add('step5'); burstConfetti(); }

  const message = scoreMessage(score);
  msg.innerHTML = `
    <div class="big">${message.text}</div>
    <div style="margin-top:8px;font-size:15px">点数：<b>${score} / 5</b></div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
      <button class="btn" id="againBtn">もういちど</button>
      <button class="btn secondary" id="changeLevel">レベルをえらぶ</button>
    </div>
  `;
  cancelSpeak(); speak(message.voice, {rate:0.95});
  document.getElementById('againBtn').addEventListener('click', startGame);
  document.getElementById('changeLevel').addEventListener('click', setReady);
}

/* ====== 補助 ====== */
function makeRandomDigits(len){ let s=''; for(let i=0;i<len;i++){ s += Math.floor(Math.random()*10).toString(); } return s; }
function scoreMessage(sc){
  switch(sc){
    case 0: return {text:"ざんねん、0点！また、がんばろう！", voice:"ざんねん、0てん！また、がんばろう！"};
    case 1: return {text:"よし、1点！よくやった！", voice:"よし、1てん！よくやった！"};
    case 2: return {text:"お、2点！だんだんおぼえてきたね！", voice:"お、2てん！だんだん おぼえてきたね！"};
    case 3: return {text:"いいね、3点！そのちょうし！", voice:"いいね、3てん！そのちょうし！"};
    case 4: return {text:"すごい、4点！あといっぽで かんぺき！", voice:"すごい、4てん！あと いっぽで かんぺき！"};
    case 5: return {text:"やった、5点！まんてんだ！", voice:"やった、5てん！まんてんだ！"};
    default: return {text:`${sc}点`,voice:`${sc}てん`};
  }
}

/* ====== 花吹雪 ====== */
function burstConfetti(){
  const count = 80;
  for(let i=0;i<count;i++){
    const p = document.createElement('div'); p.className = 'petal';
    const x = Math.random()*window.innerWidth;
    const drift = (Math.random()*160-80)+'px';
    const dur = (5+Math.random()*3)+'s';
    p.style.left = x+'px';
    p.style.setProperty('--x','0px');
    p.style.setProperty('--xend',drift);
    p.style.setProperty('--dur',dur);
    const colors = ['#ff7eb6','#ffd1e6','#ffc1d9','#ff9fc9'];
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    confetti.appendChild(p);
    setTimeout(()=>p.remove(), 8000);
  }
}

/* ====== リセット ====== */
function resetGame(){
  cancelSpeak();
  inGame=false; canInput=false; round=0; score=0; typedDigits=''; targetDigits='';
  confetti.querySelectorAll('.petal').forEach(n=>n.remove());
  setReady();
}

// 初期
setReady();

/* iOS初回無音対策：初回タッチで権限解放 */
document.addEventListener('touchstart', function once(){ cancelSpeak(); document.removeEventListener('touchstart', once); }, {passive:true});
</script>
</body>
</html>

