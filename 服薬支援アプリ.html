<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>æœè–¬ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼šã¾ã¡è‚²æˆ</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f4f8ff; --card:#ffffff; --line:#e3ecff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --ok:#16a34a; --warn:#ef4444; --pill:#eaf2ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Arial}
button{font:inherit}

/* Header */
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff 0%,#f6f9ff 100%);border-bottom:1px solid var(--line);padding:10px 14px}
.brand{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.brand h1{font-size:18px;margin:0}
.brand .meta{font-size:12px;color:var(--muted)}

/* Tabs */
.tabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:56px;z-index:9}
.tab{flex:1}
.tab button{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.tab button.active{border-color:var(--accent);box-shadow:0 0 0 2px #185adb20}

main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:10px;align-items:center}
.kpi .big{font-size:26px;font-weight:700}
.kpi .sub{font-size:12px;color:var(--muted)}

/* Big action buttons */
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.bigbtn{position:relative;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;min-height:76px}
.bigbtn .title{font-size:13px;color:var(--muted)}
.bigbtn .state{font-size:20px;font-weight:700}
.bigbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px #185adb22}
.bigbtn.done{background:#f5fff7;border-color:#c6f6d5}
.bigbtn.late{background:#fff8f0;border-color:#fed7aa}
.bigbtn .pulse{position:absolute;inset:0;border-radius:16px;pointer-events:none;}

/* City View (homeå†…ã«çµ±åˆ) */
#cityWrap{position:relative;height:340px;overflow:hidden;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,#a8d1ff 0%,#d7ecff 50%,#d5f0d2 50%,#c9e8c4 100%)}
#sky{position:absolute;inset:0 0 50% 0;overflow:hidden}
#land{position:absolute;inset:50% 0 0 0;overflow:hidden;background:linear-gradient(180deg,#d5f0d2 0%,#c9e8c4 100%)}
/* â˜… ãƒŸãƒ‹ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼šrenderCityã®ã‚¯ãƒªã‚¢å¯¾è±¡å¤– */
#microLayer{position:absolute;inset:0;pointer-events:none}
.obj{position:absolute;user-select:none;line-height:1}
.twinkle{animation:twinkle 2.2s infinite ease-in-out}
@keyframes twinkle{0%,100%{opacity:.15;transform:scale(.9)}50%{opacity:1;transform:scale(1)}}
.cloud{animation:cloud 60s linear infinite}
@keyframes cloud{0%{transform:translateX(-20%)}100%{transform:translateX(120%)}}
.bird{animation:bird 18s linear infinite}
@keyframes bird{0%{transform:translateX(-10vw) translateY(0)}50%{transform:translateX(50vw) translateY(-8px)}100%{transform:translateX(110vw) translateY(0)}}
.plane{animation:plane 25s linear infinite}
@keyframes plane{0%{transform:translateX(110vw)}100%{transform:translateX(-120vw)}}
/* è»Šã¯å³â†’å·¦ã¸åè»¢ */
.car{animation:car 14s linear infinite}
@keyframes car{0%{transform:translateX(20vw)}100%{transform:translateX(-120vw)}}
.slow{animation-duration:22s}
.fast{animation-duration:9s}

/* Celebration */
#celebration{position:fixed;inset:0;pointer-events:none;display:none}
.confetti{position:absolute;will-change:transform;animation:fall linear forwards}
@keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* Settings */
label.switch{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
input[type="date"]{padding:8px;border:1px solid var(--line);border-radius:10px}
.toggle{width:42px;height:24px;border-radius:999px;background:#e5efff;position:relative;transition:.2s}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px #0002;transition:.2s}
input[type="checkbox"].sm:checked + .toggle{background:#b9d3ff}
input[type="checkbox"].sm:checked + .toggle::after{left:20px}
.save{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px}
.danger{background:#fff;color:#ef4444;border:1px solid #fecaca;padding:10px 14px;border-radius:12px}
.danger:hover{filter:brightness(0.98)}

/* History */
#historyGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.dot{aspect-ratio:1;width:100%;border-radius:6px;background:#edf2ff;border:1px solid var(--line);position:relative}
.dot.m::before,.dot.n::before,.dot.e::before{content:"";position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#c7d2fe;top:6px}
.dot.n::after{content:"";position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#93c5fd;top:16px}
.dot.e .tail{position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#60a5fa;bottom:6px}
.done .dot{background:#dcfce7;border-color:#a7f3d0}

/* è¡°é€€æ™‚ã®ã‚„ã‚„æš—è»¢ãƒ»ã—ã¼ã¿ */
.city-dim{filter:brightness(0.96) saturate(0.92); transform:scale(0.985); transition:.6s}

/* === Chicken glow === */
.glow {
  position: relative;
  animation: glowPulse 1.8s ease-in-out infinite;
  filter:
    drop-shadow(0 0 4px rgba(255,215,0,.85))
    drop-shadow(0 0 9px rgba(255,200,0,.55));
}
@keyframes glowPulse {
  0%,100% { transform: scale(1);   filter: drop-shadow(0 0 3px rgba(255,215,0,.8)) drop-shadow(0 0 7px rgba(255,200,0,.5)); }
  50%     { transform: scale(1.06); filter: drop-shadow(0 0 8px rgba(255,230,120,.95)) drop-shadow(0 0 14px rgba(255,210,80,.65)); }
}

@media (max-width:480px){
  #cityWrap{height:280px}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>æœè–¬ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼šã¾ã¡è‚²æˆ</h1>
    <div class="meta" id="rankBadge">ãƒ©ãƒ³ã‚¯: -</div>
    <div class="meta" id="daysLeft">æ®‹ã‚Šæ—¥æ•°: -</div>
  </div>
</header>

<!-- Tabsï¼šå…ˆé ­ã‚’ã€Œè‚²æˆã€ã« -->
<nav class="tabs">
  <div class="tab"><button class="active" data-tab="home">è‚²æˆ</button></div>
  <div class="tab"><button data-tab="history">å±¥æ­´</button></div>
  <div class="tab"><button data-tab="settings">è¨­å®š</button></div>
</nav>

<main>
  <!-- Home -->
  <section id="home" class="view">
    <div class="card kpi">
      <div class="big" id="rateVal">--%</div>
      <div>
        <div class="sub">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</div>
        <div class="small" id="comment">ã‚³ãƒ¡ãƒ³ãƒˆâ€¦</div>
      </div>
      <div style="margin-left:auto" class="badge" id="streakBadge">é€£ç¶š0æ—¥</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="small">ä»Šæ—¥ã¯â€¦ <span id="todaySummary">-</span></div>
        <div class="badge">ãƒŸãƒƒã‚·ãƒ§ãƒ³çµ‚äº† <span id="missionEnd">-</span></div>
      </div>
      <div class="grid3" style="margin-top:10px">
        <button class="bigbtn" id="btnM" data-slot="m">
          <div class="title">æœ</div>
          <div class="state" data-state>â€”</div>
          <div class="pulse"></div>
        </button>
        <button class="bigbtn" id="btnN" data-slot="n">
          <div class="title">æ˜¼</div>
          <div class="state" data-state>â€”</div>
          <div class="pulse"></div>
        </button>
        <button class="bigbtn" id="btnE" data-slot="e">
          <div class="title">å¤•</div>
          <div class="state" data-state>â€”</div>
          <div class="pulse"></div>
        </button>
      </div>
      <div class="small" style="margin-top:8px">â€» å½“æ—¥å†…ã¯é…åˆ»å®Œäº†ã‚‚å¯ã€‚é•·æŠ¼ã—ã§å–ã‚Šæ¶ˆã—</div>
    </div>

    <!-- çµ±åˆã—ãŸè¡—ãƒ“ãƒ¥ãƒ¼ -->
    <div class="card" style="margin-top:10px">
      <div id="cityWrap">
        <div id="sky"></div>
        <div id="land"></div>
        <!-- â˜… ãƒŸãƒ‹ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¯ãƒªã‚¢ã•ã‚Œãªã„ï¼‰ -->
        <div id="microLayer"></div>
      </div>
      <div class="small" style="margin-top:6px">æœŸé–“ã«åˆã‚ã›ã¦â€œã˜ã‚ã£â€ã¨æˆé•·ã€‚100%ã§åŒã˜æœ€çµ‚å½¢ã«åˆ°é”ã—ã¾ã™ã€‚</div>
    </div>
  </section>

  <!-- History -->
  <section id="history" class="view" style="display:none">
    <div class="card">
      <div class="row"><div class="small">ç›´è¿‘7æ—¥ï¼ˆä¸Š:æœ / ä¸­:æ˜¼ / ä¸‹:å¤•ï¼‰</div></div>
      <div id="historyGrid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="view" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <div class="small">é–‹å§‹æ—¥</div>
          <input type="date" id="startDate">
        </div>
        <div>
          <div class="small">çµ‚äº†æ—¥</div>
          <input type="date" id="endDate">
        </div>
      </div>
      <div class="row" style="margin-top:10px;gap:12px">
        <label class="switch"><input id="freqM" type="checkbox" class="sm"><span class="toggle"></span> æœ</label>
        <label class="switch"><input id="freqN" type="checkbox" class="sm"><span class="toggle"></span> æ˜¼</label>
        <label class="switch"><input id="freqE" type="checkbox" class="sm"><span class="toggle"></span> å¤•</label>
      </div>
      <div class="row" style="margin-top:12px;justify-content:space-between;gap:8px">
        <div>
          <button class="save" id="saveSettings">ä¿å­˜</button>
          <span class="small" id="saveMsg" style="margin-left:8px"></span>
        </div>
        <button class="danger" id="resetAll" title="è¨­å®šã¨è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã€èµ·ç‚¹ã‚’ä»Šæ—¥ãƒ»çµ‚ç‚¹ã‚’1é€±é–“å¾Œã«ä»®è¨­å®š">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="small" style="margin-top:8px">â€» å€‹äººæƒ…å ±ã¯ä¿æŒã—ã¾ã›ã‚“ã€‚ç«¯æœ«å†…ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ã€‚</div>
    </div>
  </section>
</main>

<div id="celebration"></div>
<footer class="small">v4 ä¿å­˜å‹Ã—æœŸé–“æ­£è¦åŒ–Ã—å­£ç¯€Ã—UFOÃ—ãƒŸãƒ‹ã‚¤ãƒ™ãƒ³ãƒˆÃ—ãƒ‹ãƒ¯ãƒˆãƒªç‰©èªÃ—2æ™‚ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼</footer>

<script>
/* ========= Storage Keys ========= */
const LS_SETTINGS = 'MEDCITY_settings_v1';
const LS_LOG = 'MEDCITY_log_v1'; // { 'YYYY-MM-DD': {m:true/false, n:..., e:..., ts:{m:epoch,...}} }
const LS_META = 'MEDCITY_meta_v1'; // {streak,bestStreak,seed,celebed?}

/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];

/* â˜… 2æ™‚ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼å¯¾å¿œã®æ—¥ä»˜ã‚­ãƒ¼ */
function todayStr(d=new Date()){
  const dt = new Date(d);
  if(dt.getHours() < 2){ dt.setDate(dt.getDate() - 1); }
  return dt.toLocaleDateString('sv-SE'); // YYYY-MM-DD
}

function parseDate(str){ const [y,m,dd]=str.split('-').map(Number); return new Date(y, m-1, dd); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function lerp(a,b,t){ return a+(b-a)*t }
function isWeekend(d=new Date()){ const w=d.getDay(); return w===0||w===6; }

/* PRNG seeded */
function makeRand(seed){ let s = seed|0 || 123456789; return function(){ s ^= s<<13; s ^= s>>>17; s ^= s<<5; return (s>>>0)/4294967296; } }

/* ========= Time Slots ========= */
function slotOf(now=new Date()){
  const h = now.getHours();
  // æ—¥ä»˜åˆ‡æ›¿ã¯åˆå‰2æ™‚ï¼š2ã€œ10æ™‚=æœ / 11ã€œ16=æ˜¼ / ãã‚Œä»¥å¤–=å¤•
  if (h>=2 && h<=10) return 'm';
  if (h>=11 && h<=16) return 'n';
  return 'e';
}

/* ========= Load / Save ========= */
function load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ========= Defaults ========= */
function ensureDefaults(){
  const s = load(LS_SETTINGS);
  if(!s){
    const start = todayStr();
    const end = todayStr(new Date(Date.now()+1000*60*60*24*27)); // 28æ—¥å¾Œ
    save(LS_SETTINGS, {startDate:start, endDate:end, freq:{m:true,n:false,e:true}});
  }
  if(!load(LS_LOG)) save(LS_LOG, {});
  if(!load(LS_META)) save(LS_META, {streak:0,bestStreak:0,seed:Math.floor(Math.random()*1e9)});
}

/* ========= Stats ========= */
function calcStats(upToToday=true){
  const settings = load(LS_SETTINGS, {});
  const log = load(LS_LOG, {});
  if(!settings.startDate||!settings.endDate) return {rate:0, planned:0, done:0, streak:0, best:0};
  const start = parseDate(settings.startDate);
  const end = parseDate(settings.endDate);
  const today = new Date();
  const last = upToToday ? new Date(today.getFullYear(), today.getMonth(), today.getDate()) : end;
  const days = Math.floor((last - start)/86400000) + 1;
  const freqCount = ['m','n','e'].filter(k=>settings.freq[k]).length;
  const planned = clamp(days,0,1e6) * freqCount;
  let done=0;
  Object.entries(log).forEach(([d,val])=>{
    const dt = parseDate(d);
    if(dt<=last){ done += ['m','n','e'].reduce((acc,k)=>acc + (val[k]?1:0),0); }
  });
  const rate = planned? Math.round(done*100/planned) : 0;
  const meta = load(LS_META, {streak:0,bestStreak:0});
  return {rate, planned, done, streak:meta.streak, best:meta.bestStreak};
}

function daysLeft(){
  const {endDate} = load(LS_SETTINGS, {});
  if(!endDate) return '-';
  const t = new Date(); const end = parseDate(endDate);
  const diff = Math.ceil((end - new Date(t.getFullYear(),t.getMonth(),t.getDate()))/86400000);
  return diff>=0? diff : 0;
}
function missionEndStr(){ const s=load(LS_SETTINGS,{}); return s?.endDate||'-' }

/* ========= Progress (for nuanced comments) ========= */
function progressInfo(){
  const s = load(LS_SETTINGS,{});
  if(!s?.startDate || !s?.endDate) return {p:0, isLastDay:false};
  const start = parseDate(s.startDate);
  const end   = parseDate(s.endDate);
  const today = new Date();
  const clampDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const totalDays = Math.max(1, Math.floor((end - start)/86400000) + 1);
  const elapsed   = Math.min(totalDays, Math.max(1, Math.floor((clampDate - start)/86400000) + 1));
  const p = Math.min(1, Math.max(0, elapsed / totalDays));
  const isLastDay = clampDate.toDateString() === end.toDateString();
  return {p, isLastDay, totalDays, elapsed};
}

// ç›´è¿‘3æ—¥ã®å®Œäº†ç‡(0..1)
function recentScore(){
  const s = load(LS_SETTINGS,{});
  const log = load(LS_LOG,{});
  if(!s?.startDate) return 0;
  const enabled = ['m','n','e'].filter(k=>s.freq?.[k]);
  if(enabled.length===0) return 0;

  let done=0, planned=0;
  for(let i=0;i<3;i++){
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = todayStr(d);
    const rec = log[key] || {};
    planned += enabled.length;
    done += enabled.reduce((a,k)=>a + (rec[k]?1:0), 0);
  }
  return planned? done/planned : 0;
}

// ä»Šæ—¥ã®é€²æ—(0..1)
function todayProgress01(){
  const s = load(LS_SETTINGS,{});
  const {states} = todayState();
  const enabled = ['m','n','e'].filter(k=>s?.freq?.[k]);
  if(enabled.length===0) return 0;
  const done = enabled.filter(k=>states[k]==='å®Œäº†').length;
  return done / enabled.length;
}

/* ===== å­£ç¯€ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š ===== */
function getSeasonalFlags(date=new Date()){
  const y = date.getFullYear();
  const m = date.getMonth()+1;
  const d = date.getDate();
  const ymd = (M,D)=> new Date(y, M-1, D);
  const inRange = (fromM,fromD,toM,toD) => {
    const t = new Date(y, m-1, d);
    return t >= ymd(fromM,fromD) && t <= ymd(toM,toD);
  };
  const isHalloween = inRange(10,25,10,31);
  const isChristmas = inRange(12,20,12,26);
  const isNewYear   = inRange(1,1,1,3);
  const isNewFiscal = inRange(3,25,4,7);
  return { isHalloween, isChristmas, isNewYear, isNewFiscal };
}

/* ========= City Healthï¼ˆè¡°é€€/å›å¾©æ¼”å‡ºç”¨ï¼‰ ========= */
function cityHealth(){
  const s = load(LS_SETTINGS,{}), log = load(LS_LOG,{});
  const enabled = ['m','n','e'].filter(k=>s?.freq?.[k]);
  if(enabled.length===0) return 0.8;

  // ç›´è¿‘7æ—¥ã®é‡ã¿ä»˜ãé”æˆç‡
  let done=0, planned=0;
  for(let i=0;i<7;i++){
    const d = new Date(); d.setDate(d.getDate()-i);
    const w = 1 - i*0.1; // æœ€è¿‘é‡è¦–
    const rec = log[todayStr(d)] || {};
    planned += enabled.length * w;
    done    += enabled.reduce((a,k)=>a + (rec[k]?1:0), 0) * w;
  }
  const rate7 = planned>0 ? (done/planned) : 0.8;

  const meta = load(LS_META,{streak:0});
  const streakBoost = Math.min(1, meta.streak/14);

  const {states} = todayState();
  const sdone = enabled.filter(k=>states[k]==='å®Œäº†').length / enabled.length;

  let penalty = 0;
  const brokeStreakToday = (meta.streak===0);
  if(brokeStreakToday) penalty += 0.15;
  if(sdone < 1)        penalty += (1 - sdone)*0.1;

  let h = Math.max(0, Math.min(1, 0.6*rate7 + 0.3*streakBoost + 0.1*sdone - penalty ));
  const recoveryBoost = Math.min(0.25, meta.streak * 0.02);
  h = Math.min(1, h + recoveryBoost);
  return h;
}

/* ========= Comments & Rank ========= */
function commentFor(rate, p, isLastDay, streak){
  if(rate === 100){
    if(isLastDay) return 'å®Œèµ°100%ğŸ‰ æœ€é«˜ã®ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ï¼éƒ½å¸‚ã«ä¼èª¬ãŒåˆ»ã¾ã‚Œã¾ã—ãŸâœ¨';
    if(p < 0.25)  return 'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥100%ï¼ã“ã®ãƒªã‚ºãƒ ã‚’ã¾ãšã¯1é€±é–“ã‚­ãƒ¼ãƒ—ğŸ’ª';
    if(p < 0.5)   return 'å‰åŠ100%ã€ç´ æ™´ã‚‰ã—ã„ï¼ä¸­ç›¤ã‚‚ã‚¢ãƒ©ãƒ¼ãƒ ã§å®‰å®šã‚’ğŸ“…';
    if(p < 0.9)   return 'çµ‚ç›¤ç›®å‰ã®100%ï¼é€±æœ«ã®æºã‚‰ãã«æ³¨æ„ã—ã¦é§†ã‘æŠœã‘ã‚ˆã†ğŸ';
    return          'ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆã‚‚100%ï¼å¤§èŠ±ç«ãŒè¦‹ãˆã¦ããŸğŸ†';
  }
  if(streak>=3 && rate<90) {
    const base = 'å›å¾©ä¸­ï¼ã“ã®èª¿å­ã§é€£ç¶šæœè–¬ã‚’ç¶šã‘ã‚ˆã†ğŸ”¥ ';
    if(rate<40) return base + 'ã¾ãšã¯æœå›ºå®šã§æ³¢ã‚’ä½œã‚ã†ğŸ‘£';
    if(rate<60) return base + 'å¤œã®æŒ¯ã‚Šè¿”ã‚Šï¼‹ãƒªãƒã‚¤ãƒ³ãƒ‰ã§å®‰å®šã¸ğŸŒ™';
    if(rate<75) return base + 'é£Ÿå¾Œå›ºå®šã‚„æœè–¬ãƒˆãƒ¬ã‚¤ã§ãƒªã‚ºãƒ ç¶­æŒğŸ½ï¸';
  }
  if(rate < 40) return p < 0.2 ? 'ã¾ãšã¯æœã ã‘å›ºå®šã§ã€Œç¶šã‘ã‚‹ã€ã‚’æœ€å„ªå…ˆã«ğŸ‘£' : 'ã“ã“ãŒè¸ã‚“å¼µã‚Šã©ã“ã‚ï¼å°ã•ãªä»•çµ„ã¿åŒ–ã§å·»ãè¿”ã—ğŸ”';
  if(rate < 60) return p < 0.5 ? 'åŠåˆ†è¶Šãˆã®èŠ½ğŸŒ± ãƒªãƒã‚¤ãƒ³ãƒ‰ã§ä¼¸ã°ãã†' : 'çµ‚ç›¤ã®ä¼¸ã³ä»£å¤§ï¼å¤œã®æŒ¯ã‚Šè¿”ã‚Šã§å–ã‚Šã“ã¼ã—ã‚¼ãƒ­ğŸŒ™';
  if(rate < 75) return p < 0.5 ? 'è‰¯ã„æ³¢ï¼é£Ÿå¾Œå›ºå®šã‚„æœè–¬ãƒˆãƒ¬ã‚¤ã§å®‰å®šğŸ½ï¸' : 'çµ‚ç›¤ã®75%ã¯ä¾¡å€¤å¤§ï¼ä¼‘æ—¥ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å›ºå®šâ°';
  if(rate < 90) return p < 0.5 ? 'ä¸Šä½å¸¯ã¸ï¼ãƒˆãƒªã‚¬ãƒ¼ç¿’æ…£ã¨ã‚»ãƒƒãƒˆã§ğŸ“Œ' : '90%ç›®å‰ï¼â€œé…åˆ»OKâ€ã‚‚è³¢ãæ´»ç”¨ğŸ•’';
  if(rate < 95) return p < 0.75 ? 'ãƒã‚¤ãƒ¬ãƒ™ãƒ«å¸¯ã€æ²¹æ–­ã«æ³¨æ„ï¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã§ç¢ºå®Ÿã«âœ…' : '95%ç›®å‰ï¼å¯ã‚‹å‰ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã§ä»•ä¸Šã’ğŸŒ™';
  return 'ãƒ—ãƒ­ç´šï¼ã‚ã¨åƒ…ã‹ã§100%ã€‚ç„¦ã‚‰ãšä¸€ã¤ãšã¤ç¢ºå®Ÿã«ğŸ§­';
}

function rankFor(rate, streak){
  if(rate>=95 && streak>=14) return 'çŸ¥äº‹';
  if(rate>=85 && streak>=7) return 'å¸‚é•·';
  if(rate>=70) return 'ç”ºé•·';
  return 'æ‘é•·';
}

/* ========= Today state ========= */
function todayState(){
  const settings = load(LS_SETTINGS, {}); const log = load(LS_LOG, {});
  const dStr = todayStr();
  const rec = log[dStr] || {m:false,n:false,e:false,ts:{}};
  const active = slotOf(new Date());
  const states = {m:'â€”',n:'â€”',e:'â€”'};
  ['m','n','e'].forEach(k=>{
    if(!settings.freq[k]) { states[k] = 'â€”'; return; }
    states[k] = rec[k] ? 'å®Œäº†' : 'æœª';
  });
  return {active, states, rec};
}

/* ========= Update UIï¼ˆä¸Šéƒ¨KPIãªã©ï¼‰ ========= */
function renderAll(){
    const {rate: baseRate, streak} = calcStats();
  const cityForView = loadCity() || defaultCityState();
  const rate = Math.round( clamp( (baseRate*0.7 + (cityForView.gp||0)*0.6), 0, 100 ) );

  const {p, isLastDay} = progressInfo();
  $('#rateVal').textContent = rate+"%";
  $('#comment').textContent = commentFor(rate, p, isLastDay, streak);
  const f = getSeasonalFlags();
  if(f.isHalloween) $('#comment').textContent += ' ğŸƒ ãƒãƒ­ã‚¦ã‚£ãƒ³WEEKã€å¤œæ›´ã‹ã—ã«æ³¨æ„ï¼';
  if(f.isChristmas) $('#comment').textContent += ' ğŸ„ ã‚¯ãƒªã‚¹ãƒã‚¹WEEKã€äºˆå®šå‰ã«æœè–¬ãƒã‚§ãƒƒã‚¯ï¼';
  if(f.isNewYear)   $('#comment').textContent += ' ğŸ ä¸‰ãŒæ—¥ã¯ç”Ÿæ´»ãƒªã‚ºãƒ ãŒä¹±ã‚ŒãŒã¡ã€‚æœå›ºå®šã§ï¼';
  if(f.isNewFiscal) $('#comment').textContent += ' ğŸŒ¸ æ–°å¹´åº¦ã¯æ–°ç¿’æ…£ã®ä½œã‚Šã©ãã€‚ãƒˆãƒªã‚¬ãƒ¼è¡Œå‹•ã‚’æ±ºã‚ã‚ˆã†ï¼';

  $('#streakBadge').textContent = `é€£ç¶š${streak}æ—¥`;
  $('#rankBadge').textContent = `ãƒ©ãƒ³ã‚¯: ${rankFor(rate, streak)}`;
  $('#daysLeft').textContent = `æ®‹ã‚Šæ—¥æ•°: ${daysLeft()}`;
  $('#missionEnd').textContent = missionEndStr();

  const settings = load(LS_SETTINGS, {});
  const {active, states} = todayState();
  const map = {m:'#btnM', n:'#btnN', e:'#btnE'};
  for(const k of ['m','n','e']){
    const el = $(map[k]);
    const stateEl = el.querySelector('[data-state]');
    el.classList.remove('active','done','late');
    el.disabled = !settings.freq[k];
    stateEl.textContent = settings.freq[k] ? states[k] : 'å¯¾è±¡å¤–';
    if(!settings.freq[k]) continue;
    if(states[k]==='å®Œäº†') el.classList.add('done');
    else if(k===active) el.classList.add('active');
    else el.classList.add('late');
  }

  renderHistory();
  renderCity();
  updateTodaySummary();
}

function updateTodaySummary(){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const {states} = todayState();
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const done = enabled.filter(k=>states[k]==='å®Œäº†').length;
  $('#todaySummary').textContent = `${done}/${enabled.length} å®Œäº†`;
}

/* ========= Celebration ========= */
function miniCelebrate(count=14){
  const c = $('#celebration'); if(!c) return;
  c.innerHTML=''; c.style.display='block';
  for(let i=0;i<count;i++){
    const s=document.createElement('div'); s.className='confetti';
    s.textContent = ['âœ¨','â­','ğŸ’«'][Math.floor(Math.random()*3)];
    s.style.left = (Math.random()*100)+'%'; s.style.top = '-5%';
    s.style.fontSize = (10 + Math.random()*14)+'px';
    s.style.animationDuration = (1.2 + Math.random()*1.2)+'s';
    c.appendChild(s);
  }
  setTimeout(()=>{c.style.display='none'}, 1800);
}

function celebrate(tier){
  const c = $('#celebration'); c.innerHTML=''; c.style.display='block';
  const count = tier>=4? 160 : tier>=3? 100 : tier>=2? 60 : 30;
  for(let i=0;i<count;i++){
    const s=document.createElement('div'); s.className='confetti'; s.textContent = ['âœ¨','ğŸŠ','ğŸ‰','â­','ğŸ’«'][Math.floor(Math.random()*5)];
    s.style.left = (Math.random()*100)+'%'; s.style.top = '-5%'; s.style.fontSize = (12 + Math.random()*20)+'px';
    s.style.animationDuration = (2 + Math.random()*2.5)+'s';
    c.appendChild(s);
  }
  setTimeout(()=>{c.style.display='none'}, 3500);
}

function checkFinishCelebration(){
  const s = load(LS_SETTINGS,{}); if(!s?.endDate) return;
  const today = new Date(); const end = parseDate(s.endDate);
  const meta = load(LS_META,{celebed:false});
  if(today.toDateString() === end.toDateString() && !meta.celebed){
    const {rate} = calcStats(false);
    let tier=1; if(rate<60) tier=1; else if(rate<80) tier=2; else if(rate<95) tier=3; else if(rate<100) tier=4; else tier=5;
    celebrate(tier);
    meta.celebed = true; save(LS_META, meta);
  }
}

/* ========= History ========= */
function renderHistory(){
  const grid = $('#historyGrid'); if(!grid) return;
  grid.innerHTML = '';
  const s = load(LS_SETTINGS,{}); const log = load(LS_LOG,{});
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i); const key = todayStr(d);
    const rec = log[key] || {m:false,n:false,e:false};
    const col = document.createElement('div'); col.style.display='grid'; col.style.gridTemplateRows='repeat(3,1fr)'; col.style.gap='6px';
    const mk = (k)=>{
      const wrap = document.createElement('div'); wrap.className = 'dotWrap';
      const dot = document.createElement('div'); dot.className = 'dot ' + k; if(rec[k]) wrap.classList.add('done');
      if(k==='e'){ const t=document.createElement('div'); t.className='tail'; dot.appendChild(t); }
      wrap.appendChild(dot); return wrap;
    }
    if(enabled.includes('m')) col.appendChild(mk('m')); else col.appendChild(document.createElement('div'));
    if(enabled.includes('n')) col.appendChild(mk('n')); else col.appendChild(document.createElement('div'));
    if(enabled.includes('e')) col.appendChild(mk('e')); else col.appendChild(document.createElement('div'));
    grid.appendChild(col);
  }
}

/* ======== ä¿å­˜å‹ã®è¡—ãƒ‡ãƒ¼ã‚¿ ======== */
const LS_CITY = 'MEDCITY_city_v1';
function loadCity(def){ try{ return JSON.parse(localStorage.getItem(LS_CITY)) ?? def }catch{ return def } }
function saveCity(v){ localStorage.setItem(LS_CITY, JSON.stringify(v)) }
function seededRand(seed){ let s = seed|0; return ()=>{ s ^= s<<13; s ^= s>>>17; s ^= s<<5; return (s>>>0)/4294967296; }; }
function seededRandN(seed, category, idx){
  let h = 2166136261>>>0;
  for (let i=0;i<category.length;i++){ h ^= category.charCodeAt(i); h = Math.imul(h, 16777619); }
  h ^= idx; h = Math.imul(h, 16777619);
  const r = seededRand((seed ^ h)>>>0);
  return r;
}
function defaultCityState(){
  return {
    dayKey: todayStr(),
    seed: Math.floor(Math.random()*1e9),
    gp: 0,
    counts: { buildings: 4, trees: 18, people: 6, animals: 2, ruins: 0, landmarks: 0 },
    chicken: {         // ğŸ” ãƒŸãƒ‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆå…‰ã‚‹æ¼”å‡ºï¼‰
      stage: null,     // null | 'egg' | 'chick' | 'hen'
      rare: false,     // ã‚«ãƒ©ãƒ•ãƒ«åµâ†’ãƒ¬ã‚¢ã²ã‚ˆã“/ãƒ‹ãƒ¯ãƒˆãƒª
      twins: false,    // åŒå­åµ
      pos: null,       // {left:%, bottom:%}
      hatched: 0
    },
    rareUnlocked: []   // ãƒ¬ã‚¢å»ºé€ ç‰©IDï¼ˆğŸ—½/ğŸ•Œ/ğŸŸï¸/ğŸ°/ğŸ—¼ï¼‰
  };
}
/* ========= City Rendering ========= */
function renderCity(){
  const {rate, streak} = calcStats();
  const {p} = progressInfo();
  const health = cityHealth();

  const sky = $('#sky'); const land = $('#land'); const micro = $('#microLayer');
  if(sky) sky.innerHTML=''; 
  if(land) land.innerHTML='';
  // microLayerã¯renderCityã§ã¯æ¶ˆã•ãªã„ï¼ˆãƒŸãƒ‹ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ï¼‰

  // BG gradients according to time
  const [t1,t2] = (()=>{
    const h=new Date().getHours();
    if(h>=2 && h<=10) return ['#bfe1ff','#e6f3ff'];
    if(h>=11 && h<=16) return ['#9bd1ff','#d6ecff'];
    if(h>=17 && h<=23) return ['#ffb38a','#c8cfff'];
    return ['#0b1020','#0e1640'];
  })();
  $('#cityWrap').style.background = `linear-gradient(180deg, ${t1} 0%, ${t2} 50%, #d5f0d2 50%, #c9e8c4 100%)`;

  const meta = load(LS_META,{seed:123});
  const rnd = makeRand(meta.seed + Math.floor(Date.now()/86400000));

  // ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ˜Ÿã€é›²ã€é³¥ãªã©ï¼‰
  const isNight = (new Date().getHours()>=19 || new Date().getHours()<4);
  if(isNight){
    const stars = Math.round(lerp(3, 40, clamp((rate-60)/40,0,1)));
    for(let i=0;i<stars;i++){
      const s=document.createElement('div'); s.className='obj twinkle'; s.textContent='âœ¦';
      s.style.left = Math.floor(rnd()*100)+'%'; s.style.top = Math.floor(rnd()*48)+'%'; 
      s.style.opacity = (0.2 + rnd()*0.8).toFixed(2);
      s.style.fontSize = (10 + rnd()*16)+'px';
      sky.appendChild(s);
    }
    if(rate>=90 && rnd()<0.3){
      addSkyObj('ğŸŒ ','obj', sky, {top:(10+rnd()*20)+'%', left:'-10%', animation:'plane 8s linear infinite'});
    }
  } else {
    const clouds = 2 + Math.floor(lerp(0,3, clamp(rate/100,0,1)));
    for(let i=0;i<clouds;i++) addSkyObj('â˜ï¸','obj cloud', sky, {top:(5+rnd()*35)+'%', left:(-20 + rnd()*100)+'%'});
    if(rate>=60){ addSkyObj('ğŸ¦','obj bird', sky, {top:(10+rnd()*20)+'%', left:'-10%'}); }
    if(rate>=85 && rnd()<0.4) addSkyObj('âœˆï¸','obj plane', sky, {top:(10+rnd()*20)+'%', left:'110%'}); 
    if(rate>=95 && rnd()<0.05) addSkyObj('ğŸ›¸','obj plane', sky, {top:(20+rnd()*15)+'%', left:'110%'}); // UFOç¨€ã‚¤ãƒ™ãƒ³ãƒˆ
  }

  // é“è·¯
  const road = document.createElement('div'); road.className='obj';
  road.style.left='-10%'; road.style.bottom='18%'; road.style.width='120%'; road.style.height='40px';
  road.style.background='#9aa3b2'; road.style.borderTop='3px solid #cbd5e1'; road.style.borderBottom='3px solid #727b88';
  land.appendChild(road);

  // è»Š
  const carCount = Math.floor(lerp(0,4, clamp((rate-50)/50,0,1)));
  for(let i=0;i<carCount;i++){
    addLandObj(['ğŸš—','ğŸš™','ğŸš•','ğŸ›»','ğŸšŒ'][Math.floor(rnd()*5)], 'obj car '+(rnd()<0.3?'fast':(rnd()<0.5?'slow':'')), land, {bottom:'22%', left:(20 + rnd()*50)+'%'});
  }

  // æ¨¹æœ¨ã¨äºº
  const density = Math.floor(lerp(2, 20, clamp(rate/100,0,1)));
  for(let i=0;i<density;i++){
    const y= 4 + Math.floor(rnd()*20);
    addLandObj(rnd()<0.75?'ğŸŒ³':'ğŸŒ²','obj',land,{left:(2 + rnd()*96)+'%', bottom:(y+'%')});
    if(rnd()<0.35) addLandObj(['ğŸ§','ğŸš¶','ğŸ•º','ğŸ’ƒ'][Math.floor(rnd()*4)],'obj',land,{left:(2 + rnd()*96)+'%', bottom:(6 + rnd()*8)+'%'});
  }

  // å»ºç‰©
  const tier = cityTier(rate);
  const builds = buildingsForTier(tier);
  builds.forEach(b=>{
    const el = document.createElement('div'); 
    el.className='obj'; 
    el.textContent=b;
    el.style.left=(2 + rnd()*92)+'%'; el.style.bottom=(18 + rnd()*18)+'%';
    // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¤§ãã•èª¿æ•´
    const size = 20 + tier*3;
    el.style.fontSize = size+'px';
    land.appendChild(el);
  });

  // é«˜é”æˆç‡ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
  if(rate>=95){ addLandObj('ğŸ¡','obj',land,{left:'8%', bottom:'26%', fontSize:'28px'}); addLandObj('â›²','obj',land,{left:'82%', bottom:'22%', fontSize:'24px'}); }

  // è¡°é€€æ¼”å‡º
  const wrap = $('#cityWrap');
  if(wrap){
    if(health < 0.6) wrap.classList.add('city-dim'); else wrap.classList.remove('city-dim');
  }

  // ãƒ‹ãƒ¯ãƒˆãƒªç‰©èªã®è¡¨ç¤º
  renderChickenStory(land);
}

function cityTier(rate){
  if(rate>=95) return 6; if(rate>=90) return 5; if(rate>=75) return 4; if(rate>=60) return 3; if(rate>=40) return 2; if(rate>=20) return 1; return 0;
}
function buildingsForTier(t){
  const tbl=[
    ['ğŸ›–'],
    ['ğŸ ','ğŸšï¸'],
    ['ğŸ ','ğŸ¡','ğŸª'],
    ['ğŸ¢','ğŸ«','ğŸ¬'],
    ['ğŸ¢','ğŸ­','ğŸ›ï¸','ğŸ¥'],
    ['ğŸ—¼','ğŸ°','ğŸŸï¸','ğŸ›•'],
    ['ğŸ°','ğŸ—½','ğŸ•Œ','â›©ï¸']
  ];
  return tbl[Math.min(t, tbl.length-1)];
}
function addSkyObj(emoji, cls, parent, style){ const el=document.createElement('div'); el.className=cls; el.textContent=emoji; Object.assign(el.style, style); parent.appendChild(el); }
function addLandObj(emoji, cls, parent, style){ const el=document.createElement('div'); el.className=cls; el.textContent=emoji; Object.assign(el.style, style); parent.appendChild(el); }

/* ========= ãƒ‹ãƒ¯ãƒˆãƒªç‰©èª ========= */
function renderChickenStory(land){
  const city = loadCity() || defaultCityState();
  if(!city.chicken || !city.chicken.stage) return;

  const pos = city.chicken.pos || {left:'50%', bottom:'22%'};
  let emoji = 'ğŸ¥š';
  if(city.chicken.stage==='chick') emoji = city.chicken.rare? 'ğŸ¤âœ¨':'ğŸ£';
  if(city.chicken.stage==='hen')   emoji = city.chicken.rare? 'ğŸ“âœ¨':'ğŸ“';

  const el=document.createElement('div');
  el.className='obj glow'; el.textContent=emoji;
  Object.assign(el.style, pos);
  el.style.fontSize = city.chicken.stage==='hen' ? '28px':'22px';
  land.appendChild(el);
}

// æˆé•·åˆ¤å®š
function checkChickenStoryEvent(trigger){
  const city = loadCity() || defaultCityState();
  const {rate} = calcStats();
  const {p} = progressInfo();

  // é–‹å§‹æ¡ä»¶
  if(!city.chicken.stage && p>=0.1 && rate>=75){
    if(Math.random()<0.33){
      city.chicken.stage='egg';
      city.chicken.pos={left:(10+Math.random()*80)+'%', bottom:'22%'};
      saveCity(city);
      toast('è¡—ã®ç‰‡éš…ã«åµğŸ¥šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼');
      return;
    }
  }
  if(city.chicken.stage==='egg' && Math.random()<progressBasedChance()){
    city.chicken.stage='chick';
    city.chicken.rare = (Math.random()<0.05);
    saveCity(city);
    toast('åµãŒã‹ãˆã£ã¦ã²ã‚ˆã“èª•ç”ŸğŸ£ï¼');
  } else if(city.chicken.stage==='chick' && Math.random()<progressBasedChance()){
    city.chicken.stage='hen';
    saveCity(city);
    toast('ã²ã‚ˆã“ãŒç«‹æ´¾ãªãƒ‹ãƒ¯ãƒˆãƒªğŸ“ã«æˆé•·ï¼');
  } else if(city.chicken.stage==='hen' && Math.random()<0.25){
    toast('ãƒ‹ãƒ¯ãƒˆãƒªãŒåµğŸ¥šã‚’ç”£ã¿ã¾ã—ãŸï¼');
  }
}
function progressBasedChance(){
  const {totalDays} = progressInfo();
  if(totalDays <= 14) return 0.5;
  if(totalDays <= 60) return 0.3;
  return 0.2;
}
function toast(msg){
  const f=document.createElement('div'); f.textContent=msg;
  f.style.position='fixed'; f.style.bottom='20px'; f.style.left='50%'; f.style.transform='translateX(-50%)';
  f.style.background='#333'; f.style.color='#fff'; f.style.padding='6px 10px'; f.style.borderRadius='6px';
  f.style.fontSize='14px'; f.style.zIndex=1000; f.style.opacity=0.9;
  document.body.appendChild(f); setTimeout(()=>{f.remove()},2000);
}

/* ========= City helpers: roll & progress & micro events ========= */

// æ—¥ä»˜ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«è¡—ãƒ‡ãƒ¼ã‚¿ã‚‚å½“æ—¥ã«æ›´æ–°ï¼ˆè»½ã„åŠ£åŒ–ãƒ»å›å¾©ï¼‰
function ensureCityRolledToToday(){
  let city = loadCity() || defaultCityState();
  const nowKey = todayStr();
  if (city.dayKey !== nowKey){
    // çµŒéæ—¥æ•°ã¶ã‚“ã ã‘å¾®æ¸›ï¼ˆæœ€è¿‘ã®é”æˆãŒé«˜ã„ã»ã©æ¸›å°‘ã¯ç·©ã„ï¼‰
    const daysGap = 1; // 2æ™‚ãƒ­ãƒ¼ãƒ«ã§1æ—¥ãšã¤é€²ã‚€æƒ³å®š
    const recent = recentScore(); // 0..1
    const decay = Math.max(0, Math.round(6 * daysGap * (1 - recent))); // 0..6/æ—¥
    city.gp = Math.max(0, (city.gp||0) - decay);
    city.dayKey = nowKey;
    saveCity(city);
  }
}

// æœè–¬å®Œäº†æ™‚ã«è¡—ã®â€œæˆé•·ãƒã‚¤ãƒ³ãƒˆ(gp)â€ã‚’åŠ ç‚¹ï¼ˆå³æ™‚ã®è‚²ã¡æ„Ÿï¼‰
function syncCityToProgress(city){
  const add =
    // ä»Šæ—¥ã®é€²æ—ï¼ˆ0..1ï¼‰ã¨ç›´è¿‘ã®å®‰å®šåº¦ã§ã‚¦ã‚¨ã‚¤ãƒˆ
    Math.round(6 + 10 * todayProgress01() * (0.5 + 0.5*recentScore()));
  city.gp = Math.min(100, (city.gp||0) + add);
  saveCity(city);
}

// 1å›ã®â€œã‚µãƒ—ãƒ©ã‚¤ã‚ºâ€æ¼”å‡ºï¼ˆmicroLayerã«å®‰å…¨ã«è¿½åŠ ï¼‰
function triggerMicroEvent(){
  const layer = document.getElementById('microLayer');
  if(!layer) return;
  // æ—¢å­˜ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã®ã‚’æƒé™¤
  while(layer.childElementCount > 8){ layer.removeChild(layer.firstChild); }

  const pack = [
    // ã‹ã‚ã„ã„å°ã‚¤ãƒ™ãƒ³ãƒˆç¾¤ï¼ˆå¤œã¯æ˜Ÿã€æ˜¼ã¯é¢¨èˆ¹ãªã©ï¼‰
    ['ğŸˆ','ğŸˆ','ğŸˆ','ğŸŠ'],  // é¢¨èˆ¹/ãŠç¥ã„
    ['ğŸ•Šï¸','ğŸ•Šï¸','ğŸ’«'],     // å°é³¥ï¼†ãã‚‰ã‚ã
    ['ğŸ†','âœ¨','â­'],        // èŠ±ç«/ãã‚‰ã‚ã
    ['ğŸŒŸ','ğŸ’','âœ¨']        // ãã‚‰ã‚ãã‚»ãƒƒãƒˆ
  ];
  const choice = pack[Math.floor(Math.random()*pack.length)];

  choice.forEach((emoji, idx)=>{
    const el = document.createElement('div');
    el.className = 'obj';
    el.textContent = emoji;
    const left = (10 + Math.random()*80);
    const bottom = (18 + Math.random()*24);
    el.style.left = left + '%';
    el.style.bottom = bottom + '%';
    el.style.fontSize = (18 + Math.random()*14) + 'px';
    el.style.opacity = 0.0;
    el.style.transition = 'transform 1.2s ease-out, opacity 1.2s ease-out';

    layer.appendChild(el);
    // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§ãµã‚ã£ã¨å‡ºç¾
    requestAnimationFrame(()=>{
      el.style.opacity = 1;
      el.style.transform = 'translateY(-18px)';
    });
    // å°‘ã—é…ã‚Œã¦æ¶ˆã™
    setTimeout(()=>{
      el.style.opacity = 0;
      el.style.transform = 'translateY(-36px)';
      setTimeout(()=> el.remove(), 700);
    }, 1400 + idx*120);
  });
}


<!-- ========= ã“ã“ã‹ã‚‰ 3/3 ãƒ–ãƒ­ãƒƒã‚¯ç›® ========= -->

/* ========= Tabs ========= */
$$('.tab button').forEach(btn=>btn.addEventListener('click', ()=>{
  $$('.tab button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const t = btn.dataset.tab; $$('.view').forEach(v=>v.style.display='none'); $('#'+t).style.display='block';
  if(t==='home') renderCity();
}));

/* ========= Settings ========= */
function loadSettingsUI(){
  const s=load(LS_SETTINGS,{});
  $('#startDate').value = s.startDate || todayStr();
  $('#endDate').value = s.endDate || todayStr(new Date(Date.now()+86400000*27));
  $('#freqM').checked = !!s.freq?.m; $('#freqN').checked=!!s.freq?.n; $('#freqE').checked=!!s.freq?.e;
}
$('#saveSettings').addEventListener('click', ()=>{
  const s={ startDate: $('#startDate').value, endDate: $('#endDate').value, freq:{ m:$('#freqM').checked, n:$('#freqN').checked, e:$('#freqE').checked } };
  save(LS_SETTINGS, s); $('#saveMsg').textContent='ä¿å­˜ã—ã¾ã—ãŸ'; setTimeout(()=>$('#saveMsg').textContent='',1500);
  recomputeStreak(); renderAll();
});

// ãƒªã‚»ãƒƒãƒˆï¼ˆè¨­å®šã¨è¨˜éŒ²ã‚’åˆæœŸåŒ–ï¼šèµ·ç‚¹=ä»Šæ—¥ã€çµ‚ç‚¹=1é€±é–“å¾Œã€freqã‚¯ãƒªã‚¢ï¼‹è¡—ã‚‚åˆæœŸåŒ–ï¼‰
$('#resetAll').addEventListener('click', ()=>{
  if(!confirm('è¨­å®šã¨è¨˜éŒ²ã‚’åˆæœŸåŒ–ã—ã€èµ·ç‚¹ã‚’ä»Šæ—¥ãƒ»çµ‚ç‚¹ã‚’1é€±é–“å¾Œã«ä»®è¨­å®šã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  const newSettings = {
    startDate: todayStr(),
    endDate: todayStr(new Date(Date.now()+86400000*7)),
    freq: {m:false,n:false,e:false}
  };
  save(LS_SETTINGS, newSettings);
  save(LS_LOG, {});
  save(LS_META, {streak:0,bestStreak:0,seed:Math.floor(Math.random()*1e9)});
  saveCity(defaultCityState());

  // è¨­å®šã‚¿ãƒ–ã¸
  $$('.tab button').forEach(b=>b.classList.remove('active'));
  const btnSettings = [...$$('.tab button')].find(b=>b.dataset.tab==='settings');
  if(btnSettings){ btnSettings.classList.add('active'); }
  $$('.view').forEach(v=>v.style.display='none'); $('#settings').style.display='block';
  loadSettingsUI(); recomputeStreak(); renderAll();
  $('#saveMsg').textContent='åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚é »åº¦ã‚’é¸ã‚“ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
  setTimeout(()=>$('#saveMsg').textContent='', 3000);
});

/* ========= Button interactions ========= */
['#btnM','#btnN','#btnE'].forEach(sel=>{
  const el=$(sel); const slot=el.dataset.slot;
  el.addEventListener('click', ()=>{ const s=load(LS_SETTINGS,{}); if(!s.freq[slot]) return; toggleDone(slot); });
  let t=null; el.addEventListener('touchstart',()=>{t=setTimeout(()=>toggleDone(slot),600)});
  el.addEventListener('touchend',()=>{ if(t){clearTimeout(t); t=null;} });
});

/* ========= å³æ™‚UIåæ˜ ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆç«¶åˆå¯¾ç­–ï¼‰ ========= */
function markSlotUI(slot, done){
  const map = {m:'#btnM', n:'#btnN', e:'#btnE'};
  const el = document.querySelector(map[slot]);
  if(!el) return;
  const stateEl = el.querySelector('[data-state]');
  if(stateEl) stateEl.textContent = done ? 'å®Œäº†' : 'æœª';
  el.classList.toggle('done', !!done);
  el.classList.remove('active','late');
  if(!done){
    const a = slotOf(new Date());
    el.classList.add(slot===a ? 'active' : 'late');
  }
}

/* ========= Log opsï¼ˆå³æ™‚UIï¼‹ç«¶åˆå›é¿æ¸ˆã¿ï¼‰ ========= */
function toggleDone(slot){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const log = load(LS_LOG,{}); const d = todayStr();
  if(!log[d]) log[d] = {m:false,n:false,e:false,ts:{}};

  const before = !!log[d][slot];
  log[d][slot] = !before;
  log[d].ts[slot] = log[d][slot] ? Date.now() : null;
  save(LS_LOG, log);

  // â˜… å…ˆã«UIã‚’â€œãã®å ´ã§â€ç¢ºå®šåæ˜ ï¼ˆç«¶åˆå¯¾ç­–ï¼‰
  markSlotUI(slot, log[d][slot]);

  if(!before && log[d][slot]){
    // æœè–¬æˆåŠŸæ™‚ã®æ¼”å‡ºï¼ˆå°‘ã—é…å»¶ã—ã¦ä»–ã®å†æç”»ã¨è¡çªã—ãªã„ã‚ˆã†ã«ï¼‰
    const meta = load(LS_META,{seed:1,streak:0,bestStreak:0});
    meta.seed = (meta.seed||1) + 3;
    save(LS_META, meta);

    setTimeout(()=> miniCelebrate(12), 0);

    // ä¿å­˜å‹ã®è¡—ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸å°‘ã—å¯„ã›ã‚‹
    const city = loadCity() || defaultCityState();
    syncCityToProgress(city);

    // ãƒŸãƒ‹ã‚¤ãƒ™ãƒ³ãƒˆã¯æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§
    const fire = window.__microEventForce || (Math.random() < 1/3);
    if (fire) setTimeout(()=> requestAnimationFrame(()=> triggerMicroEvent()), 0);

    // ãƒ¬ã‚¢å»ºé€ ç‰©ã®è§£æ”¾æŠ½é¸ï¼ˆ25%ï¼‰
    if (Math.random() < 0.25) tryUnlockRareLandmark('complete');

    // ğŸ” ãƒ‹ãƒ¯ãƒˆãƒªç‰©èªï¼šå®Œäº†æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ é€²è¡Œï¼ˆé…å»¶ï¼‰
    setTimeout(()=> checkChickenStoryEvent('complete'), 0);
  }

  recomputeStreak();
  // â˜… å…¨ä½“å†æç”»ã¯æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§
  requestAnimationFrame(()=> renderAll());
  maybeNightCombo();
  checkFinishCelebration();
}

function recomputeStreak(){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const log = load(LS_LOG,{});
  let streak=0; const now = new Date();
  for(let i=0;i<3650;i++){
    const d = new Date(now.getFullYear(),now.getMonth(),now.getDate()-i);
    const key = todayStr(d);
    const rec = log[key];
    const ok = rec && enabled.every(k=>rec[k]);
    if(ok) streak++; else break;
  }
  const meta = load(LS_META,{streak:0,bestStreak:0});
  meta.streak = streak; meta.bestStreak = Math.max(meta.bestStreak||0, streak);
  save(LS_META, meta);
}

function maybeNightCombo(){
  const s = load(LS_SETTINGS,{}); const log=load(LS_LOG,{}); const t=todayStr();
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const rec = log[t];
  if(rec && enabled.length>0 && enabled.every(k=>rec[k])){
    const meta = load(LS_META,{}); meta.seed = (meta.seed||1) + 7; save(LS_META, meta);
  }
}

/* ========= Init ========= */
ensureDefaults();
loadSettingsUI();
recomputeStreak();
renderAll();
checkFinishCelebration();

// 20ç§’ã”ã¨ã«è»½ãæ›´æ–°ï¼ˆãƒ›ãƒ¼ãƒ è¡¨ç¤ºæ™‚ï¼‰
setInterval(()=>{
  const homeShown = $('#home') && $('#home').style.display !== 'none';
  if(homeShown) renderCity();
}, 20*1000);

/* ===== 2:00 ãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼æ¤œçŸ¥ ===== */
function getDayKey(){ return todayStr(); }
function refreshIfDayChanged(){
  const nowKey = getDayKey();
  if (window.__currentDayKey !== nowKey){
    window.__currentDayKey = nowKey;
    ensureCityRolledToToday(); // â˜… æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰è¡—ã‚‚é€²ã‚ã‚‹
    recomputeStreak();
    renderAll();
  }
}
function scheduleNextRolloverTick(hour=2){
  const now = new Date();
  const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0, 1, 0); // +1ç§’
  if (now >= target) target.setDate(target.getDate()+1);
  const ms = target - now;
  clearTimeout(window.__rolloverTimer);
  window.__rolloverTimer = setTimeout(()=>{
    refreshIfDayChanged();
    scheduleNextRolloverTick(hour);
  }, ms);
}
window.__currentDayKey = getDayKey();
document.addEventListener('visibilitychange', ()=> { if (document.visibilityState === 'visible'){ refreshIfDayChanged(); }});
window.addEventListener('focus', refreshIfDayChanged);
window.addEventListener('pageshow', refreshIfDayChanged);
window.addEventListener('orientationchange', refreshIfDayChanged);
scheduleNextRolloverTick(2);

// iOSã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æ™‚ã¯1åˆ†ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ
const isIOSStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
if (isIOSStandalone){
  setInterval(()=> { if (document.visibilityState==='visible') refreshIfDayChanged(); }, 60*1000);
}

</script>
</body>
</html>
<!-- ========= ã“ã“ã¾ã§ 3/3 ãƒ–ãƒ­ãƒƒã‚¯ç›® ========= -->
