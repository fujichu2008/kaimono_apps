<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>投薬ミッション：まち育成</title>
<meta name="theme-color" content="#185adb">
<style>
:root{
  --bg:#f4f8ff; --card:#ffffff; --line:#e3ecff; --text:#0f172a; --muted:#5b6b8a;
  --accent:#185adb; --accent-2:#0e49c7; --ok:#16a34a; --warn:#ef4444; --pill:#eaf2ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, Arial}
button{font:inherit}

/* Header */
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff 0%,#f6f9ff 100%);border-bottom:1px solid var(--line);padding:10px 14px}
.brand{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.brand h1{font-size:18px;margin:0}
.brand .meta{font-size:12px;color:var(--muted)}

/* Tabs */
.tabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:56px;z-index:9}
.tab{flex:1}
.tab button{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.tab button.active{border-color:var(--accent);box-shadow:0 0 0 2px #185adb20}

main{padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:10px;align-items:center}
.kpi .big{font-size:28px;font-weight:700}
.kpi .sub{font-size:12px;color:var(--muted)}

/* Big action buttons */
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.bigbtn{position:relative;border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff;min-height:86px}
.bigbtn .title{font-size:14px;color:var(--muted)}
.bigbtn .state{font-size:22px;font-weight:700}
.bigbtn.active{border-color:var(--accent);box-shadow:0 0 0 3px #185adb22}
.bigbtn.done{background:#f5fff7;border-color:#c6f6d5}
.bigbtn.late{background:#fff8f0;border-color:#fed7aa}
.bigbtn .pulse{position:absolute;inset:0;border-radius:16px;pointer-events:none;}

/* City View */
#cityWrap{position:relative;height:380px;overflow:hidden;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,#a8d1ff 0%,#d7ecff 50%,#d5f0d2 50%,#c9e8c4 100%)}
#sky{position:absolute;inset:0 0 50% 0;overflow:hidden}
#land{position:absolute;inset:50% 0 0 0;overflow:hidden;background:linear-gradient(180deg,#d5f0d2 0%,#c9e8c4 100%)}
.obj{position:absolute;user-select:none}
.twinkle{animation:twinkle 2.2s infinite ease-in-out}
@keyframes twinkle{0%,100%{opacity:.15;transform:scale(.9)}50%{opacity:1;transform:scale(1)}}
.cloud{animation:cloud 60s linear infinite}
@keyframes cloud{0%{transform:translateX(-20%)}100%{transform:translateX(120%)}}
.bird{animation:bird 18s linear infinite}
@keyframes bird{0%{transform:translateX(-10vw) translateY(0)}50%{transform:translateX(50vw) translateY(-8px)}100%{transform:translateX(110vw) translateY(0)}}
.plane{animation:plane 25s linear infinite}
@keyframes plane{0%{transform:translateX(110vw)}100%{transform:translateX(-120vw)}}
.car{animation:car 14s linear infinite}
@keyframes car{0%{transform:translateX(-20vw)}100%{transform:translateX(120vw)}}
.slow{animation-duration:22s}
.fast{animation-duration:9s}

/* Celebration */
#celebration{position:fixed;inset:0;pointer-events:none;display:none}
.confetti{position:absolute;will-change:transform;animation:fall linear forwards}
@keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* Settings */
label.switch{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
input[type="date"]{padding:8px;border:1px solid var(--line);border-radius:10px}
.toggle{width:42px;height:24px;border-radius:999px;background:#e5efff;position:relative;transition:.2s}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px #0002;transition:.2s}
input[type="checkbox"].sm:checked + .toggle{background:#b9d3ff}
input[type="checkbox"].sm:checked + .toggle::after{left:20px}
.save{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:12px}

/* History */
#historyGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.dot{aspect-ratio:1;width:100%;border-radius:6px;background:#edf2ff;border:1px solid var(--line);position:relative}
.dot.m::before,.dot.n::before,.dot.e::before{content:"";position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#c7d2fe;top:6px}
.dot.n::after{content:"";position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#93c5fd;top:16px}
.dot.e .tail{position:absolute;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;background:#60a5fa;bottom:6px}
.done .dot{background:#dcfce7;border-color:#a7f3d0}

footer.small{padding:12px;color:var(--muted);text-align:center}

@media (max-width:480px){
  #cityWrap{height:330px}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <h1>投薬ミッション：まち育成</h1>
    <div class="meta" id="rankBadge">ランク: -</div>
    <div class="meta" id="daysLeft">残り日数: -</div>
  </div>
</header>
<nav class="tabs">
  <div class="tab"><button class="active" data-tab="home">今日</button></div>
  <div class="tab"><button data-tab="city">街</button></div>
  <div class="tab"><button data-tab="history">履歴</button></div>
  <div class="tab"><button data-tab="settings">設定</button></div>
</nav>

<main>
  <!-- Home -->
  <section id="home" class="view">
    <div class="card kpi">
      <div class="big" id="rateVal">--%</div>
      <div>
        <div class="sub">コンプリート率</div>
        <div class="small" id="comment">コメント…</div>
      </div>
      <div style="margin-left:auto" class="badge" id="streakBadge">連続日数: 0</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="small">今日は… <span id="todaySummary">-</span></div>
        <div class="badge">ミッション終了 <span id="missionEnd">-</span></div>
      </div>
      <div class="grid3" style="margin-top:10px">
        <button class="bigbtn" id="btnM" data-slot="m">
          <div class="title">朝</div>
          <div class="state" data-state>—</div>
          <div class="pulse"></div>
        </button>
        <button class="bigbtn" id="btnN" data-slot="n">
          <div class="title">昼</div>
          <div class="state" data-state>—</div>
          <div class="pulse"></div>
        </button>
        <button class="bigbtn" id="btnE" data-slot="e">
          <div class="title">夕</div>
          <div class="state" data-state>—</div>
          <div class="pulse"></div>
        </button>
      </div>
      <div class="small" style="margin-top:8px">※ 当日内は遅刻完了も可。長押しで取り消し</div>
    </div>
  </section>

  <!-- City -->
  <section id="city" class="view" style="display:none">
    <div id="cityWrap" class="card">
      <div id="sky"></div>
      <div id="land"></div>
    </div>
    <div class="small" style="margin-top:6px">達成率と連続日数に応じて街が発展します。</div>
  </section>

  <!-- History -->
  <section id="history" class="view" style="display:none">
    <div class="card">
      <div class="row"><div class="small">直近7日（上:朝 / 中:昼 / 下:夕）</div></div>
      <div id="historyGrid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="view" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <div class="small">開始日</div>
          <input type="date" id="startDate">
        </div>
        <div>
          <div class="small">終了日</div>
          <input type="date" id="endDate">
        </div>
      </div>
      <div class="row" style="margin-top:10px;gap:12px">
        <label class="switch"><input id="freqM" type="checkbox" class="sm"><span class="toggle"></span> 朝</label>
        <label class="switch"><input id="freqN" type="checkbox" class="sm"><span class="toggle"></span> 昼</label>
        <label class="switch"><input id="freqE" type="checkbox" class="sm"><span class="toggle"></span> 夕</label>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="save" id="saveSettings">保存</button>
        <div class="small" id="saveMsg" style="margin-left:8px"></div>
      </div>
      <div class="small" style="margin-top:8px">※ 個人情報は保持しません。端末内ローカルのみ保存。</div>
    </div>
  </section>
</main>

<div id="celebration"></div>
<footer class="small">v1 MVP – シンプル操作 × 都市育成</footer>

<script>
/* ========= Storage Keys ========= */
const LS_SETTINGS = 'MEDCITY_settings_v1';
const LS_LOG = 'MEDCITY_log_v1'; // { 'YYYY-MM-DD': {m:true/false, n:..., e:..., ts:{m:epoch,...}} }
const LS_META = 'MEDCITY_meta_v1'; // {streak,bestStreak,seed}

/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const todayStr = (d=new Date()) => d.toLocaleDateString('sv-SE'); // YYYY-MM-DD
function parseDate(str){ const [y,m,dd]=str.split('-').map(Number); return new Date(y, m-1, dd); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function lerp(a,b,t){ return a+(b-a)*t }

/* PRNG seeded */
function makeRand(seed){ let s = seed|0 || 123456789; return function(){ s ^= s<<13; s ^= s>>>17; s ^= s<<5; return (s>>>0)/4294967296; } }

/* ========= Time Slots ========= */
function slotOf(now=new Date()){
  const h = now.getHours();
  if (h>=4 && h<=10) return 'm';
  if (h>=11 && h<=16) return 'n';
  return 'e';
}

/* ========= Load / Save ========= */
function load(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ========= Defaults ========= */
function ensureDefaults(){
  const s = load(LS_SETTINGS);
  if(!s){
    const start = todayStr();
    const end = todayStr(new Date(Date.now()+1000*60*60*24*27)); // 28日後
    save(LS_SETTINGS, {startDate:start, endDate:end, freq:{m:true,n:false,e:true}});
  }
  if(!load(LS_LOG)) save(LS_LOG, {});
  if(!load(LS_META)) save(LS_META, {streak:0,bestStreak:0,seed:Math.floor(Math.random()*1e9)});
}

/* ========= Stats ========= */
function calcStats(upToToday=true){
  const settings = load(LS_SETTINGS, {});
  const log = load(LS_LOG, {});
  if(!settings.startDate||!settings.endDate) return {rate:0, planned:0, done:0, streak:0, best:0};
  const start = parseDate(settings.startDate);
  const end = parseDate(settings.endDate);
  const today = new Date();
  const last = upToToday ? new Date(today.getFullYear(), today.getMonth(), today.getDate()) : end;
  const days = Math.floor((last - start)/86400000) + 1;
  const freqCount = ['m','n','e'].filter(k=>settings.freq[k]).length;
  const planned = clamp(days,0,1e6) * freqCount;
  let done=0;
  Object.entries(log).forEach(([d,val])=>{
    const dt = parseDate(d);
    if(dt<=last){ done += ['m','n','e'].reduce((acc,k)=>acc + (val[k]?1:0),0); }
  });
  const rate = planned? Math.round(done*100/planned) : 0;
  const meta = load(LS_META, {streak:0,bestStreak:0});
  return {rate, planned, done, streak:meta.streak, best:meta.bestStreak};
}

function daysLeft(){
  const {endDate} = load(LS_SETTINGS, {});
  if(!endDate) return '-';
  const t = new Date(); const end = parseDate(endDate);
  const diff = Math.ceil((end - new Date(t.getFullYear(),t.getMonth(),t.getDate()))/86400000);
  return diff>=0? diff : 0;
}

function missionEndStr(){ const s=load(LS_SETTINGS,{}); return s?.endDate||'-' }

/* ========= Comments & Rank ========= */
function commentFor(rate){
  if(rate<40) return '最初の一歩を続けよう。朝だけ固定にしてみる？';
  if(rate<60) return '半分越え！次は昼も固定でリズムづくり👏';
  if(rate<75) return 'いい波！食後リマインドでさらに安定🍽️';
  if(rate<90) return 'かなり安定！週末のズレに注意で90%台へ👀';
  if(rate<95) return 'ハイレベル！寝る前チェックで取りこぼしゼロ🌙';
  if(rate<100) return 'プロ級！大花火まであと少し🎆';
  return 'ミッション完了！あなたの都市が伝説に✨';
}

function rankFor(rate, streak){
  // 村長→町長→市長→知事
  if(rate>=95 && streak>=14) return '知事';
  if(rate>=85 && streak>=7) return '市長';
  if(rate>=70) return '町長';
  return '村長';
}

/* ========= Today state ========= */
function todayState(){
  const settings = load(LS_SETTINGS, {}); const log = load(LS_LOG, {});
  const dStr = todayStr();
  const rec = log[dStr] || {m:false,n:false,e:false,ts:{}};
  const active = slotOf(new Date());
  const states = {m:'—',n:'—',e:'—'}; // — / 完了 / 未 / （頻度外）
  ['m','n','e'].forEach(k=>{
    if(!settings.freq[k]) { states[k] = '—'; return; }
    states[k] = rec[k] ? '完了' : '未';
  });
  return {active, states, rec};
}

/* ========= Update UI ========= */
function renderAll(){
  const {rate, streak} = calcStats();
  $('#rateVal').textContent = rate+"%";
  $('#comment').textContent = commentFor(rate);
  $('#streakBadge').textContent = `連続日数: ${streak}`;
  $('#rankBadge').textContent = `ランク: ${rankFor(rate, streak)}`;
  $('#daysLeft').textContent = `残り日数: ${daysLeft()}`;
  $('#missionEnd').textContent = missionEndStr();

  const settings = load(LS_SETTINGS, {});
  const {active, states} = todayState();
  const map = {m:'#btnM', n:'#btnN', e:'#btnE'};
  for(const k of ['m','n','e']){
    const el = $(map[k]);
    const stateEl = el.querySelector('[data-state]');
    el.classList.remove('active','done','late');
    el.disabled = !settings.freq[k];
    stateEl.textContent = settings.freq[k] ? states[k] : '対象外';
    if(!settings.freq[k]) continue;
    if(states[k]==='完了') el.classList.add('done');
    else if(k===active) el.classList.add('active');
    else el.classList.add('late');
  }

  renderHistory();
  renderCity();
  updateTodaySummary();
}

function updateTodaySummary(){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const {states} = todayState();
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const done = enabled.filter(k=>states[k]==='完了').length;
  $('#todaySummary').textContent = `${done}/${enabled.length} 完了`;
}

/* ========= Log ops ========= */
function toggleDone(slot){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const log = load(LS_LOG,{}); const d = todayStr();
  if(!log[d]) log[d] = {m:false,n:false,e:false,ts:{}};
  log[d][slot] = !log[d][slot];
  log[d].ts[slot] = log[d][slot] ? Date.now() : null;
  save(LS_LOG, log);

  // streak recompute once per day boundary, simple approach
  recomputeStreak();
  renderAll();
  maybeNightCombo();
  checkFinishCelebration();
}

function recomputeStreak(){
  const s = load(LS_SETTINGS,{}); if(!s?.startDate) return;
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const log = load(LS_LOG,{});
  let streak=0; const today = new Date();
  for(let i=0;i<3650;i++){
    const d = new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    const key = todayStr(d);
    const rec = log[key];
    const ok = rec && enabled.every(k=>rec[k]);
    if(ok) streak++; else break;
  }
  const meta = load(LS_META,{streak:0,bestStreak:0});
  meta.streak = streak; meta.bestStreak = Math.max(meta.bestStreak||0, streak);
  save(LS_META, meta);
}

/* ========= History ========= */
function renderHistory(){
  const grid = $('#historyGrid'); grid.innerHTML = '';
  const s = load(LS_SETTINGS,{}); const log = load(LS_LOG,{});
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i); const key = todayStr(d);
    const rec = log[key] || {m:false,n:false,e:false};
    const col = document.createElement('div'); col.style.display='grid'; col.style.gridTemplateRows='repeat(3,1fr)'; col.style.gap='6px';
    const mk = (k)=>{
      const wrap = document.createElement('div'); wrap.className = 'dotWrap';
      const dot = document.createElement('div'); dot.className = 'dot ' + k; if(rec[k]) wrap.classList.add('done');
      if(k==='e'){ const t=document.createElement('div'); t.className='tail'; dot.appendChild(t); }
      wrap.appendChild(dot); return wrap;
    }
    if(enabled.includes('m')) col.appendChild(mk('m')); else col.appendChild(document.createElement('div'));
    if(enabled.includes('n')) col.appendChild(mk('n')); else col.appendChild(document.createElement('div'));
    if(enabled.includes('e')) col.appendChild(mk('e')); else col.appendChild(document.createElement('div'));
    grid.appendChild(col);
  }
}

/* ========= City Rendering ========= */
function skyColorByTime(){
  const h = new Date().getHours();
  if(h<11) return ['#a8d1ff','#d7ecff']; // 朝
  if(h<17) return ['#7ec8ff','#cde8ff']; // 昼
  if(h<24) return ['#f5a98d','#a6c0ff']; // 夕
  return ['#0b1020','#111c3a']; // 深夜（理論上未到達）
}

function renderCity(){
  const {rate, streak} = calcStats();
  const sky = $('#sky'); const land = $('#land');
  sky.innerHTML=''; land.innerHTML='';

  // BG gradients according to time
  const [t1,t2] = (()=>{
    const h=new Date().getHours();
    if(h>=4 && h<=10) return ['#bfe1ff','#e6f3ff'];
    if(h>=11 && h<=16) return ['#9bd1ff','#d6ecff'];
    if(h>=17 && h<=23) return ['#ffb38a','#c8cfff'];
    return ['#0b1020','#0e1640'];
  })();
  $('#cityWrap').style.background = `linear-gradient(180deg, ${t1} 0%, ${t2} 50%, #d5f0d2 50%, #c9e8c4 100%)`;

  const meta = load(LS_META,{seed:123});
  const rnd = makeRand(meta.seed + Math.floor(Date.now()/86400000)); // 日替わり

  // Sky objects
  const stars = Math.round(lerp(3, 40, clamp((rate-60)/40,0,1)));
  const isNight = (new Date().getHours()>=19 || new Date().getHours()<4);
  if(isNight){
    for(let i=0;i<stars;i++){
      const s=document.createElement('div'); s.className='obj twinkle'; s.textContent='✦';
      s.style.left = Math.floor(rnd()*100)+'%'; s.style.top = Math.floor(rnd()*48)+'%'; s.style.opacity = (0.2 + rnd()*0.8).toFixed(2);
      s.style.fontSize = (10 + rnd()*16)+'px'; sky.appendChild(s);
    }
    if(rate>=90 && rnd()<0.3){ addSkyObj('🌠','obj', sky, {top: (10+rnd()*20)+'%', left:'-10%', animation:'plane 8s linear infinite'}); }
  } else {
    // clouds
    const clouds = 2 + Math.floor(lerp(0,3, clamp(rate/100,0,1)));
    for(let i=0;i<clouds;i++) addSkyObj('☁️','obj cloud', sky, {top: (5+rnd()*35)+'%', left:(-20 + rnd()*100)+'%'});
    // birds
    if(rate>=60){ addSkyObj('🐦‍⬛','obj bird', sky, {top:(10+rnd()*20)+'%', left:'-10%'}); }
    if(rate>=85 && rnd()<0.4) addSkyObj('✈️','obj plane', sky, {top:(10+rnd()*20)+'%', left:'110%'});
    if(rate>=95 && rnd()<0.1) addSkyObj('🐉','obj plane', sky, {top:(20+rnd()*15)+'%', left:'110%'});
  }

  // Land base: road
  const road = document.createElement('div'); road.className='obj'; road.style.left='-10%'; road.style.bottom='18%'; road.style.width='120%'; road.style.height='40px'; road.style.background='#9aa3b2'; road.style.borderTop='3px solid #cbd5e1'; road.style.borderBottom='3px solid #727b88'; land.appendChild(road);
  // cars
  const carCount = Math.floor(lerp(0,4, clamp((rate-50)/50,0,1)));
  for(let i=0;i<carCount;i++){
    addLandObj(['🚗','🚙','🚕','🛻','🚌'][Math.floor(rnd()*5)], 'obj car '+(rnd()<0.3?'fast':(rnd()<0.5?'slow':'')), land, {bottom:'22%', left:(-20 - rnd()*50)+'%'});
  }

  // Trees & people density
  const density = Math.floor(lerp(2, 20, clamp(rate/100,0,1)));
  for(let i=0;i<density;i++){
    const y= 4 + Math.floor(rnd()*20);
    addLandObj(rnd()<0.75?'🌳':'🌲','obj',land,{left:(2 + rnd()*96)+'%', bottom:(y+'%')});
    if(rnd()<0.35) addLandObj(['🧍','🧍‍♂️','🧍‍♀️','🚶','🕺','💃'][Math.floor(rnd()*6)],'obj',land,{left:(2 + rnd()*96)+'%', bottom:(6 + rnd()*8)+'%'});
  }

  // Buildings by tier
  const tier = cityTier(rate);
  const builds = buildingsForTier(tier);
  builds.forEach(b=>addLandObj(b,'obj',land,{left:(2 + rnd()*92)+'%', bottom:(18 + rnd()*18)+'%'}));

  // Landmarks at high rates
  if(rate>=95){ addLandObj('🎡','obj',land,{left:'8%', bottom:'26%'}); addLandObj('⛲','obj',land,{left:'82%', bottom:'22%'}); }
  if(rate>=90 && (load(LS_META,{}).streak||0)>=7){ addLandObj('🚆','obj fast', land, {left:'-10%', bottom:'36%', animation:'car 10s linear infinite'}); }

  // Random small events
  if(rnd()<0.15) addLandObj('🐕','obj', land, {left:(2 + rnd()*92)+'%', bottom:'20%'});
  if(rnd()<0.1) addLandObj('🎈','obj', land, {left:(2 + rnd()*92)+'%', bottom:'40%'});
}

function cityTier(rate){
  if(rate>=95) return 6; if(rate>=90) return 5; if(rate>=75) return 4; if(rate>=60) return 3; if(rate>=40) return 2; if(rate>=20) return 1; return 0;
}
function buildingsForTier(t){
  const tbl=[
    ['🛖'],
    ['🏠','🏚️'],
    ['🏠','🏡','🏪'],
    ['🏢','🏫','🏬'],
    ['🏢','🏭','🏛️','🏥'],
    ['🗼','🏰','🏟️','🛕'],
    ['🏰','🗽','🕌','⛩️']
  ];
  return tbl[Math.min(t, tbl.length-1)];
}
function addSkyObj(emoji, cls, parent, style){ const el=document.createElement('div'); el.className=cls; el.textContent=emoji; Object.assign(el.style, style); parent.appendChild(el); }
function addLandObj(emoji, cls, parent, style){ const el=document.createElement('div'); el.className=cls; el.textContent=emoji; Object.assign(el.style, style); parent.appendChild(el); }

/* ========= Celebration ========= */
function celebrate(tier){
  const c = $('#celebration'); c.innerHTML=''; c.style.display='block';
  const count = tier>=4? 160 : tier>=3? 100 : tier>=2? 60 : 30;
  for(let i=0;i<count;i++){
    const s=document.createElement('div'); s.className='confetti'; s.textContent = ['✨','🎊','🎉','⭐','💫'][Math.floor(Math.random()*5)];
    s.style.left = (Math.random()*100)+'%'; s.style.top = '-5%'; s.style.fontSize = (12 + Math.random()*20)+'px';
    s.style.animationDuration = (2 + Math.random()*2.5)+'s';
    c.appendChild(s);
  }
  setTimeout(()=>{c.style.display='none'}, 3500);
}

function checkFinishCelebration(){
  const s = load(LS_SETTINGS,{}); if(!s?.endDate) return;
  const today = new Date(); const end = parseDate(s.endDate);
  // 期間を過ぎた“その日”に1回だけ判定（簡易版）
  const meta = load(LS_META,{celebed:false});
  if(today.toDateString() === end.toDateString() && !meta.celebed){
    const {rate} = calcStats(false); // 期間末まで
    let tier=1; if(rate<60) tier=1; else if(rate<80) tier=2; else if(rate<95) tier=3; else if(rate<100) tier=4; else tier=5;
    celebrate(tier);
    meta.celebed = true; save(LS_META, meta);
  }
}

function maybeNightCombo(){
  // 1日フルコンボで夜に流れ星を増やす演出（軽量フラグ）
  const s = load(LS_SETTINGS,{}); const log=load(LS_LOG,{}); const t=todayStr();
  const enabled = ['m','n','e'].filter(k=>s.freq[k]);
  const rec = log[t];
  if(rec && enabled.length>0 && enabled.every(k=>rec[k])){
    const meta = load(LS_META,{}); meta.seed = (meta.seed||1) + 7; save(LS_META, meta);
  }
}

/* ========= Tabs ========= */
$$('.tab button').forEach(btn=>btn.addEventListener('click', ()=>{
  $$('.tab button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const t = btn.dataset.tab; $$('.view').forEach(v=>v.style.display='none'); $('#'+t).style.display='block';
  if(t==='city') renderCity();
}));

/* ========= Settings ========= */
function loadSettingsUI(){
  const s=load(LS_SETTINGS,{});
  $('#startDate').value = s.startDate || todayStr();
  $('#endDate').value = s.endDate || todayStr(new Date(Date.now()+86400000*27));
  $('#freqM').checked = !!s.freq?.m; $('#freqN').checked=!!s.freq?.n; $('#freqE').checked=!!s.freq?.e;
}
$('#saveSettings').addEventListener('click', ()=>{
  const s={ startDate: $('#startDate').value, endDate: $('#endDate').value, freq:{ m:$('#freqM').checked, n:$('#freqN').checked, e:$('#freqE').checked } };
  save(LS_SETTINGS, s); $('#saveMsg').textContent='保存しました'; setTimeout(()=>$('#saveMsg').textContent='',1500);
  recomputeStreak(); renderAll();
});

/* ========= Button interactions ========= */
['#btnM','#btnN','#btnE'].forEach(sel=>{
  const el=$(sel); const slot=el.dataset.slot;
  // tap to toggle
  el.addEventListener('click', ()=>{ const s=load(LS_SETTINGS,{}); if(!s.freq[slot]) return; toggleDone(slot); });
  // long-press to undo quickly (same toggle)
  let t=null; el.addEventListener('touchstart',()=>{t=setTimeout(()=>toggleDone(slot),600)});
  el.addEventListener('touchend',()=>{ if(t){clearTimeout(t); t=null;} });
});

/* ========= Init ========= */
ensureDefaults();
loadSettingsUI();
recomputeStreak();
renderAll();
checkFinishCelebration();

// Refresh UI each hour-ish for sky
setInterval(()=>{ if($('#city').style.display!=='none') renderCity(); }, 60*1000);
</script>
</body>
</html>