<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CORPORATE QUEST — Real Company Battle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- canvas-confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1223;
      --panel:#0C152B;
      --line:#1E2B4F;
      --neon:#35F7FF;
      --neon2:#A78BFA;
      --warn:#FBBF24;
      --good:#34D399;
      --bad:#FB7185;
      --text:#D6E2FF;
      --muted:#93A4C8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body{height:100%; background: radial-gradient(1200px 600px at 20% 10%, rgba(53,247,255,.08), transparent 55%),
                                 radial-gradient(900px 500px at 70% 20%, rgba(167,139,250,.10), transparent 60%),
                                 linear-gradient(180deg,var(--bg0),var(--bg1));
              color:var(--text);}
    .safe-pad{padding-bottom: max(16px, env(safe-area-inset-bottom)); padding-top: max(16px, env(safe-area-inset-top));}
    .panel{
      background: linear-gradient(180deg, rgba(12,21,43,.88), rgba(7,10,18,.72));
      border:1px solid rgba(53,247,255,.16);
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 24px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .panel2{
      background: linear-gradient(180deg, rgba(12,21,43,.80), rgba(11,18,35,.50));
      border:1px solid rgba(148,163,184,.18);
    }
    .scanline{
      position:absolute; inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.02) 0px,
        rgba(255,255,255,.02) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      mix-blend-mode: overlay;
      opacity:.35;
      border-radius: 18px;
    }
    .neon-border{
      border:1px solid rgba(53,247,255,.25);
      box-shadow: 0 0 0 1px rgba(53,247,255,.14), 0 0 24px rgba(53,247,255,.10);
    }
    .chip{
      font-family: var(--mono);
      letter-spacing:.02em;
      border:1px solid rgba(53,247,255,.22);
      background: rgba(53,247,255,.06);
      color: #CFFBFF;
    }
    .mono{font-family: var(--mono);}
    .ticker{
      position: relative;
      overflow:hidden;
      border-top:1px solid rgba(148,163,184,.12);
      border-bottom:1px solid rgba(148,163,184,.12);
      background: rgba(2,6,23,.55);
    }
    .ticker .track{
      display:flex; gap:32px;
      white-space:nowrap;
      will-change: transform;
      animation: scroll 22s linear infinite;
      padding: 10px 0;
      font-family: var(--mono);
      color: rgba(214,226,255,.85);
      text-shadow: 0 0 12px rgba(53,247,255,.12);
    }
    @keyframes scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .btn{
      border:1px solid rgba(53,247,255,.22);
      background: linear-gradient(180deg, rgba(53,247,255,.12), rgba(53,247,255,.04));
      box-shadow: 0 0 0 1px rgba(167,139,250,.10);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn:hover{filter: brightness(1.15); border-color: rgba(53,247,255,.40);}
    .btn:active{transform: translateY(1px) scale(.99);}

    .btn2{
      border:1px solid rgba(167,139,250,.26);
      background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.05));
      box-shadow: 0 0 0 1px rgba(53,247,255,.08);
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    .btn2:hover{filter: brightness(1.15); border-color: rgba(167,139,250,.42);}
    .btn2:active{transform: translateY(1px) scale(.99);}

    .btnDanger{
      border:1px solid rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.05));
    }

    .glowText{
      text-shadow: 0 0 18px rgba(53,247,255,.22), 0 0 32px rgba(167,139,250,.12);
    }

    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.18);
      overflow:hidden;
      position: relative;
    }
    .bar > .fill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(53,247,255,.95), rgba(167,139,250,.92));
      box-shadow: 0 0 20px rgba(53,247,255,.16);
      transition: width .45s cubic-bezier(.2,.9,.2,1);
    }
    .bar > .fill.hp{
      background: linear-gradient(90deg, rgba(52,211,153,.95), rgba(53,247,255,.80));
    }
    .bar > .fill.danger{
      background: linear-gradient(90deg, rgba(251,113,133,.95), rgba(245,158,11,.65));
    }

    .shake{ animation: shake .35s ease-in-out; }
    @keyframes shake{
      0%{transform: translate(0,0);}
      20%{transform: translate(-6px,2px);}
      40%{transform: translate(6px,-2px);}
      60%{transform: translate(-4px,-2px);}
      80%{transform: translate(4px,2px);}
      100%{transform: translate(0,0);}
    }

    .flash{
      position: relative;
    }
    .flash::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 18px;
      background: radial-gradient(700px 300px at 30% 20%, rgba(53,247,255,.28), transparent 60%),
                  radial-gradient(500px 300px at 70% 50%, rgba(167,139,250,.20), transparent 65%);
      opacity: 0;
      pointer-events:none;
      animation: flash .55s ease-out;
    }
    @keyframes flash{
      0%{opacity:.9;}
      100%{opacity:0;}
    }

    .crit{
      animation: pop .38s ease-out;
    }
    @keyframes pop{
      0%{transform: scale(.92); opacity:.75;}
      60%{transform: scale(1.04); opacity:1;}
      100%{transform: scale(1); opacity:1;}
    }

    .floatDmg{
      position:absolute;
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing:.02em;
      text-shadow: 0 0 18px rgba(53,247,255,.18);
      animation: floatUp .95s ease-out forwards;
      pointer-events:none;
      user-select:none;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) scale(.98); opacity: 0; }
      15%{ opacity: 1; }
      100%{ transform: translateY(-38px) scale(1.02); opacity: 0; }
    }

    .logoWrap{
      width: 96px; height: 96px;
      border-radius: 18px;
      border:1px solid rgba(53,247,255,.22);
      background: radial-gradient(220px 160px at 30% 20%, rgba(53,247,255,.12), transparent 55%),
                  radial-gradient(220px 160px at 70% 60%, rgba(167,139,250,.12), transparent 60%),
                  rgba(2,6,23,.65);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow: 0 0 0 1px rgba(167,139,250,.10), 0 18px 60px rgba(0,0,0,.35);
      position: relative;
    }
    .logoWrap img{width: 82%; height: 82%; object-fit: contain; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));}
    .logoFallback{
      width: 80px; height: 80px; border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      font-weight: 800;
      font-size: 30px;
      letter-spacing: .02em;
      color: rgba(207,251,255,.95);
      background: linear-gradient(180deg, rgba(53,247,255,.14), rgba(167,139,250,.10));
      border:1px solid rgba(53,247,255,.18);
      text-shadow: 0 0 18px rgba(53,247,255,.24);
    }

    .kbd{
      font-family: var(--mono);
      border:1px solid rgba(148,163,184,.22);
      background: rgba(148,163,184,.08);
      padding:.15rem .35rem;
      border-radius: .5rem;
      color: rgba(214,226,255,.92);
      font-size: 12px;
    }

    .tag{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(148,163,184,.06);
      color: rgba(214,226,255,.86);
      font-family: var(--mono);
      font-size: 12px;
      padding: .15rem .45rem;
      border-radius: 999px;
    }

    textarea{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(53,247,255,.35);
      box-shadow: 0 0 0 3px rgba(53,247,255,.08);
    }
    select,input{
      background: rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.22);
      outline:none;
    }
        select:focus,input:focus{
      border-color: rgba(53,247,255,.35);
      box-shadow: 0 0 0 3px rgba(53,247,255,.08);
    }

    .quake { animation: quake 0.8s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes quake {
      10%, 90% { transform: translate3d(-3px, 0, 0) rotate(1deg); }
      20%, 80% { transform: translate3d(5px, 0, 0) rotate(-1deg); }
      30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotate(2deg); }
      40%, 60% { transform: translate3d(8px, 0, 0) rotate(-2deg); }
    }
    .glitch-anim { animation: glitch-skew 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; }
    @keyframes glitch-skew {
      0% { transform: skew(0deg); }
      20% { transform: skew(-2deg); }
      40% { transform: skew(2deg); }
      60% { transform: skew(-1deg); }
      80% { transform: skew(1deg); }
      100% { transform: skew(0deg); }
    }

    .hidden{display:none;}

            /* --- POKEMON-STYLE BATTLE CSS --- */
    .battle-stage {
      position: relative;
      height: 380px;
      background: linear-gradient(180deg, #0f172a 0%, #020617 60%);
      perspective: 600px;
      overflow: hidden;
    }
    /* 3D Grid Floor Effect - Enhanced Visibility */
    .battle-stage::after {
      content:""; position:absolute; inset:-100%; top:35%;
      background:
        linear-gradient(180deg, rgba(2,6,23,0) 0%, rgba(2,6,23,1) 80%),
        repeating-linear-gradient(90deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px),
        repeating-linear-gradient(0deg, rgba(53,247,255,0.15) 0px, rgba(53,247,255,0.15) 1px, transparent 1px, transparent 50px);
      transform: rotateX(75deg);
      z-index: 2;
      pointer-events: none;
      mask-image: linear-gradient(to bottom, transparent 0%, black 20%);
    }
    /* City Scape */
    .city-wrap {
      position: absolute; top: 0; left: 0; right: 0; height: 100%;
      pointer-events: none; z-index: 1;
      transform-style: preserve-3d;
    }
    .building {
      position: absolute; bottom: 35%; /* align with grid horizon */
      background: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(2,6,23,1) 100%);
      border-top: 1px solid rgba(53,247,255,0.3);
      box-shadow: 0 0 15px rgba(0,0,0,0.8);
      transform-origin: bottom center;
    }
    .building::after {
      content:""; position:absolute; inset:0;
      background-image: radial-gradient(rgba(167,139,250,0.3) 1px, transparent 1px);
      background-size: 4px 6px;
      opacity: 0.6;
    }
    /* Ground Effects */
    .stage-ground-p {
      position: absolute; bottom: -30px; left: -10%; width: 320px; height: 100px;
      background: rgba(53,247,255,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(53,247,255,0.1); box-shadow: 0 0 30px rgba(53,247,255,0.05);
    }
    .stage-ground-c {
      position: absolute; top: 40px; right: -5%; width: 280px; height: 90px;
      background: rgba(167,139,250,0.05); border-radius: 50%; transform: rotateX(60deg);
      border: 1px solid rgba(167,139,250,0.1); box-shadow: 0 0 30px rgba(167,139,250,0.05);
    }
        /* Sprites - Centered */
    .sprite-wrap {
      position: absolute;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      filter: drop-shadow(0 24px 48px rgba(0,0,0,0.7));
      z-index: 10;
    }
    /* Move inward (30%) to avoid overlap with HUD and reduce emptiness */
    .pos-p { bottom: 60px; left: 30%; }
    .pos-c { top: 70px; right: 30%; z-index: 5; }
    
    /* HUDs - Corner Anchor */
    .hud-wrap {
      position: absolute; width: 260px; padding: 12px 16px;
      background: rgba(15,23,42,0.85); border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px; backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      pointer-events: none; /* click through */
      z-index: 30;
    }
    /* Player HUD: Left Bottom corner */
    .hud-p { bottom: 16px; left: 16px; border-left: 4px solid #35F7FF; transform: translateZ(20px); }
    /* CPU HUD: Right Top corner */
    .hud-c { top: 16px; right: 16px; border-right: 4px solid #A78BFA; transform: scale(0.95); opacity: 0.95; }

    /* Center Effect */
    .center-ring {
      position: absolute; top: 60%; left: 50%; width: 400px; height: 400px;
      transform: translate(-50%, -50%) rotateX(60deg);
      border: 2px dashed rgba(53,247,255,0.12);
      border-radius: 50%;
      animation: spin-slow 30s linear infinite;
      z-index: 2;
      pointer-events: none;
    }
    .center-ring::after {
      content:""; position:absolute; inset:40px; border: 1px solid rgba(167,139,250,0.15); border-radius: 50%;
    }

        /* Shadows - Aligned with Sprites */
    .shadow-marker {
      position: absolute; width: 100px; height: 24px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.7) 0%, transparent 70%);
      border-radius: 50%; z-index: 3;
      animation: shadow-scale 4s ease-in-out infinite;
    }
    /* Aligned with new sprite positions (30%) */
    .sh-p { bottom: 60px; left: 30%; margin-left: 10px; }
    .sh-c { top: 150px; right: 30%; margin-right: 10px; }

    /* Animations */
    @keyframes spin-slow { 0%{transform:translate(-50%, -50%) rotateX(60deg) rotate(0deg);} 100%{transform:translate(-50%, -50%) rotateX(60deg) rotate(360deg);} }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-14px);} }
    @keyframes shadow-scale { 0%,100%{transform:scale(1); opacity:0.6;} 50%{transform:scale(0.8); opacity:0.4;} }

        /* Direction Variables for Sprites (P: LeftBottom->RightTop, C: RightTop->LeftBottom) */
    .pos-p { --tx: 1; --ty: -1; }
    .pos-c { --tx: -1; --ty: 1; }

    /* Standard Attack */
    @keyframes lunge { 
      0%{transform:translate(0,0) scale(1);} 
      40%{transform:translate(calc(80px*var(--tx)), calc(80px*var(--ty))) scale(1.15);} 
      100%{transform:translate(0,0) scale(1);} 
    }
    .atk-anim { animation: lunge 0.5s ease-in-out !important; }

    /* --- 20 UNIQUE SKILL MOTIONS --- */
    .skill-anim { animation-duration: 1.8s !important; animation-timing-function: ease-in-out !important; z-index: 100; }

    /* 1. Smash: Power charge and heavy hit */
    @keyframes m-smash { 0%{transform:scale(1)} 30%{transform:translate(calc(-30px*var(--tx)),calc(-30px*var(--ty))) scale(0.8); filter:brightness(2) drop-shadow(0 0 20px white)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.6)} 100%{transform:scale(1)} }
    /* 2. Rush: Vibration and rapid dash */
    @keyframes m-rush { 0%{transform:scale(1)} 20%{transform:translate(calc(-10px*var(--tx)),0) skew(10deg)} 40%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty))) scale(1.1)} 45%{transform:translate(0,0)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 3. Sonic: Disappear and strike */
    @keyframes m-sonic { 0%{transform:scale(1); opacity:1} 30%{transform:scale(0.1); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5); opacity:1; filter:contrast(2)} 100%{transform:scale(1)} }
    /* 4. Snipe: Stationary charge and recoil */
    @keyframes m-snipe { 0%{transform:scale(1)} 40%{transform:scale(0.9); filter:brightness(3)} 45%{transform:translate(calc(-40px*var(--tx)),calc(-40px*var(--ty))) scale(1); filter:hue-rotate(90deg)} 100%{transform:scale(1)} }
    /* 5. Drill: Spin attack */
    @keyframes m-drill { 0%{transform:rotate(0)} 30%{transform:rotate(360deg) scale(0.5)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) rotate(1080deg) scale(1.3)} 100%{transform:rotate(0)} }
    /* 6. Jump: High arch */
    @keyframes m-jump { 0%{transform:scale(1)} 30%{transform:translateY(-150px) scale(1.2)} 60%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }
    /* 7. Zigzag */
    @keyframes m-zigzag { 0%{transform:translate(0,0)} 20%{transform:translate(calc(40px*var(--tx)),calc(-40px*var(--ty)))} 40%{transform:translate(calc(80px*var(--tx)),calc(40px*var(--ty)))} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.3)} 100%{transform:translate(0,0)} }
    /* 8. Tackle: Simple heavy charge */
    @keyframes m-tackle { 0%{transform:scale(1)} 25%{transform:rotate(calc(-15deg*var(--tx)))} 50%{transform:translate(calc(190px*var(--tx)),calc(190px*var(--ty))) scale(1.4)} 100%{transform:scale(1)} }
    /* 9. Uppercut */
    @keyframes m-uppercut { 0%{transform:translate(0,0)} 30%{transform:translate(0, 50px) scale(0.8)} 50%{transform:translate(calc(150px*var(--tx)), -150px) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 10. Meteor: From sky */
    @keyframes m-meteor { 0%{transform:translate(0,0)} 20%{transform:translateY(-200px) scale(0.5); opacity:0} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.6); opacity:1} 100%{transform:translate(0,0)} }
    /* 11. Shadow: Vibration blur */
    @keyframes m-shadow { 0%{transform:scale(1)} 30%{transform:translate(calc(10px*var(--tx)),0); filter:blur(4px)} 50%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.2); filter:blur(0)} 100%{transform:scale(1)} }
    /* 12. Giant: Giant growth */
    @keyframes m-giant { 0%{transform:scale(1)} 40%{transform:scale(2.2); filter:brightness(1.5); z-index:100} 60%{transform:translate(calc(80px*var(--tx)),calc(80px*var(--ty))) scale(2.2)} 100%{transform:scale(1)} }
    /* 13. Helix: Spiral */
    @keyframes m-helix { 0%{transform:rotate(0)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(calc(360deg*var(--tx)))} 100%{transform:translate(0,0)} }
    /* 14. Impact: Slow start fast hit */
    @keyframes m-impact { 0%{transform:scale(1)} 50%{transform:translate(calc(50px*var(--tx)),calc(50px*var(--ty))) scale(1)} 55%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.8); filter:invert(1)} 100%{transform:scale(1)} }
    /* 15. Wobble */
    @keyframes m-wobble { 0%{transform:rotate(0)} 25%{transform:rotate(20deg)} 50%{transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) rotate(-20deg) scale(1.4)} 100%{transform:rotate(0)} }
    /* 16. Charge: Long wait */
    @keyframes m-charge { 0%{transform:scale(1)} 40%{transform:scale(0.6); filter:brightness(0.5)} 45%{transform:scale(1.2); filter:brightness(2)} 50%{transform:translate(calc(200px*var(--tx)),calc(200px*var(--ty)))} 100%{transform:scale(1)} }
    /* 17. Boomerang */
    @keyframes m-boomerang { 0%{transform:rotate(0)} 40%{transform:translate(calc(100px*var(--tx)), -100px) rotate(180deg)} 60%{transform:translate(calc(200px*var(--tx)),calc(100px*var(--ty))) rotate(360deg)} 100%{transform:rotate(0)} }
    /* 18. Frenzy: Random shake */
    @keyframes m-frenzy { 0%{transform:translate(0,0)} 20%{transform:translate(20px, -20px)} 40%{transform:translate(-20px, 20px)} 60%{transform:translate(calc(180px*var(--tx)),calc(180px*var(--ty))) scale(1.5)} 100%{transform:translate(0,0)} }
    /* 19. Stealth: Fade out in */
    @keyframes m-stealth { 0%{opacity:1} 20%{opacity:0.2; transform:scale(0.8)} 50%{opacity:1; transform:translate(calc(160px*var(--tx)),calc(160px*var(--ty))) scale(1.3)} 100%{opacity:1} }
    /* 20. Pulse */
    @keyframes m-pulse { 0%{transform:scale(1)} 20%{transform:scale(1.4)} 40%{transform:scale(0.8)} 60%{transform:translate(calc(170px*var(--tx)),calc(170px*var(--ty))) scale(1.5)} 100%{transform:scale(1)} }

    .dmg-anim { animation: shake 0.45s ease-in-out; filter: brightness(2.5) hue-rotate(180deg) !important; }
    .guard-anim { filter: brightness(1.3) drop-shadow(0 0 15px rgba(53,247,255,0.6)) !important; transform: scale(0.95); }

    /* Battle Toast Log */
    .battle-toast-wrap {
      position: absolute; top: 10px; left: 0; right: 0;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      pointer-events: none; z-index: 50;
    }
    .battle-toast {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(53, 247, 255, 0.3);
      color: #e2e8f0;
      padding: 6px 12px;
      border-radius: 99px;
      font-family: var(--mono);
      font-size: 11px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      animation: toast-in 0.3s ease-out forwards;
      max-width: 90%; text-align: center;
    }
    @keyframes toast-in { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
    @keyframes toast-out { to{opacity:0; transform:translateY(-10px);} }
  </style>
</head>
<body class="safe-pad">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Header -->
    <header class="flex items-center justify-between gap-3 py-3">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl neon-border flex items-center justify-center relative overflow-hidden"
             style="background: radial-gradient(180px 120px at 30% 20%, rgba(53,247,255,.16), transparent 60%),
                            radial-gradient(180px 120px at 70% 60%, rgba(167,139,250,.16), transparent 60%),
                            rgba(2,6,23,.65);">
          <div class="scanline" style="border-radius:16px;"></div>
          <span class="mono font-black text-lg glowText">CQ</span>
        </div>
        <div>
          <div class="text-xl sm:text-2xl font-black tracking-tight glowText">CORPORATE QUEST</div>
          <div class="text-xs sm:text-sm text-slate-300/80 mono">Real Company Battle • Bloomberg × Cyberpunk • Single HTML</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnGoStart" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="home" class="w-4 h-4"></i><span class="mono">START</span>
        </button>
        <button id="btnGoLab" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="sparkles" class="w-4 h-4"></i><span class="mono">AI FORGE</span>
        </button>
        <button id="btnGoTournament" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
          <i data-lucide="trophy" class="w-4 h-4"></i><span class="mono">TOURNAMENT</span>
        </button>
      </div>
    </header>

    <!-- Ticker -->
    <div class="ticker rounded-2xl panel2 overflow-hidden mb-4">
      <div class="track" id="tickerTrack"></div>
    </div>

    <!-- Main -->
    <main class="grid grid-cols-1 gap-4">

      <!-- START SCREEN -->
      <section id="screenStart" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden">
        <div class="scanline"></div>

        <div class="flex flex-col lg:flex-row gap-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-3">
              <span class="tag">MODE</span>
              <span class="mono text-sm text-slate-200/90">CPU対戦 / 企業を選んで即バトル</span>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="panel2 rounded-2xl p-4">
                <div class="flex items-center justify-between">
                  <div class="mono text-sm text-slate-200/90">YOUR COMPANY</div>
                  <span class="tag" id="tagYourSector">—</span>
                </div>
                <div class="mt-2">
                  <select id="selPlayer" class="w-full rounded-xl px-3 py-2 mono text-sm">
                  </select>
                </div>
                <div class="mt-3 flex gap-2">
                  <button id="btnRandomPlayer" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                  </button>
                  <button id="btnInspectPlayer" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                  </button>
                </div>
              </div>

              <div class="panel2 rounded-2xl p-4">
                <div class="flex items-center justify-between">
                  <div class="mono text-sm text-slate-200/90">ENEMY (CPU)</div>
                  <span class="tag" id="tagCpuSector">—</span>
                </div>
                <div class="mt-2">
                  <select id="selCPU" class="w-full rounded-xl px-3 py-2 mono text-sm">
                  </select>
                </div>
                <div class="mt-3 flex gap-2">
                  <button id="btnRandomCPU" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="shuffle" class="w-4 h-4"></i><span class="mono">RANDOM</span>
                  </button>
                  <button id="btnInspectCPU" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="scan" class="w-4 h-4"></i><span class="mono">INSPECT</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button id="btnStartBattle" class="btn px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2 flex-1">
                <i data-lucide="swords" class="w-5 h-5"></i>
                <span class="mono font-bold">ENGAGE — CPU MATCH</span>
              </button>
              <button id="btnStartTournamentFromStart" class="btn2 px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2 flex-1">
                <i data-lucide="trophy" class="w-5 h-5"></i>
                <span class="mono font-bold">INITIATE — 8 CORP TOURNAMENT</span>
              </button>
            </div>

            <div class="mt-4 panel2 rounded-2xl p-4">
              <div class="mono text-sm text-slate-200/90 mb-2">STATUS CONVERSION (財務→戦闘)</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm text-slate-200/85">
                <div class="flex items-center gap-2"><span class="tag">HP</span><span>現預金残高 (Cash)</span></div>
                <div class="flex items-center gap-2"><span class="tag">ATK</span><span>営業利益率 (Operating Margin)</span></div>
                <div class="flex items-center gap-2"><span class="tag">DEF</span><span>自己資本比率 (Equity Ratio)</span></div>
                <div class="flex items-center gap-2"><span class="tag">SPD</span><span>従業員数 or 時価総額</span></div>
                <div class="flex items-center gap-2"><span class="tag">SKILL</span><span>研究開発費 (R&amp;D)</span></div>
                <div class="flex items-center gap-2"><span class="tag">FX</span><span>外資は円換算 (AI追加時)</span></div>
              </div>
              <div class="mt-2 text-xs text-slate-300/70 mono">
                ※ゲーム用に「レンジ圧縮（対数/クリップ/正規化）」を行い、極端な差が出すぎないように調整しています。
              </div>
            </div>
          </div>

          <div class="w-full lg:w-[380px] panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.25"></div>
            <div class="flex items-center justify-between">
              <div class="mono text-sm text-slate-200/90">QUICK INTEL</div>
              <span class="tag" id="intelTag">READY</span>
            </div>
            <div id="intelBox" class="mt-3 space-y-2">
              <div class="text-slate-300/80 text-sm">企業を <span class="kbd">INSPECT</span> すると、財務指標と戦闘ステータスをここに表示します。</div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <button id="btnOpenLabFromIntel" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center justify-center gap-2">
                <i data-lucide="sparkles" class="w-4 h-4"></i><span class="mono">AI FORGE</span>
              </button>
              <button id="btnResetSample" class="btnDanger px-3 py-2 rounded-xl text-sm flex items-center justify-center gap-2">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i><span class="mono">RESET</span>
              </button>
            </div>

            <div class="mt-3 text-xs text-slate-300/65 mono">
              RESETはIndexedDB内の企業データを初期サンプルに戻します（追加企業も消えます）。
            </div>
          </div>
        </div>
      </section>

      <!-- BATTLE SCREEN -->
      <section id="screenBattle" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="tag">BATTLE</span>
              <span class="mono text-sm text-slate-200/90" id="battleSubtitle">—</span>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnBattleToResult" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="flag" class="w-4 h-4"></i><span class="mono">FORCE END</span>
              </button>
              <button id="btnBattleBackStart" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
                <i data-lucide="corner-down-left" class="w-4 h-4"></i><span class="mono">EXIT</span>
              </button>
            </div>
          </div>

          <!-- arena -->
          
          <div id="arena" class="panel2 rounded-2xl relative overflow-hidden bg-slate-900">
            <div class="scanline" style="opacity:.10"></div>
            
            
            <div id="battleToastAnchor" class="battle-toast-wrap"></div>
            
            <div class="battle-stage">
              
              <div id="cityScape" class="city-wrap"></div>
              
              
              <div class="center-ring"></div>

              
              <div class="stage-ground-c" style="z-index:3"></div>
              <div class="stage-ground-p" style="z-index:3"></div>
              
              
              <div class="shadow-marker sh-c"></div>
              <div class="shadow-marker sh-p"></div>

              
              
              <div class="hud-wrap hud-c">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="nameCPU">CPU</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdC">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-500" id="hpBarCPU" style="width:100%"></div>
                </div>
                <div class="flex justify-between text-[10px] mono text-slate-300">
                  <span id="hpTextCPU">HP --/--</span>
                  <span class="text-xs text-violet-300">R&amp;D <span id="skTextCPU">0</span>%</span>
                </div>
                <div class="hidden" id="sectorCPU"></div><div class="hidden" id="rawCPU"></div><div class="hidden" id="skBarCPU"></div>
                <div class="hidden" id="statAtkC"></div><div class="hidden" id="statDefC"></div>
              </div>
                            
              <div id="spriteCPU" class="sprite-wrap pos-c" style="animation: float 4s ease-in-out infinite reverse;">
                 <div class="logoWrap w-20 h-20 sm:w-28 sm:h-28 rounded-2xl border-2 border-white/10" id="logoWrapCPU"></div>
                 <div class="mt-2 flex justify-center flex-wrap gap-1" id="buffsCPU"></div>
              </div>

              
              
              <div id="spritePlayer" class="sprite-wrap pos-p" style="animation: float 4s ease-in-out infinite;">
                 <div class="mb-2 flex justify-center flex-wrap-reverse gap-1" id="buffsPlayer"></div>
                 <div class="logoWrap w-24 h-24 sm:w-36 sm:h-36 rounded-2xl border-2 border-cyan-400/30" id="logoWrapPlayer"></div>
              </div>
              <div class="hud-wrap hud-p">
                <div class="flex justify-between items-baseline mb-1">
                  <div class="font-black text-sm sm:text-base truncate w-32" id="namePlayer">PLAYER</div>
                  <div class="mono text-xs text-slate-400">Lv.<span id="statSpdP">--</span></div>
                </div>
                <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden mb-1 border border-slate-600/50">
                  <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 transition-all duration-500" id="hpBarPlayer" style="width:100%"></div>
                </div>
                <div class="flex justify-between text-[10px] mono text-slate-300 mb-1">
                  <span id="hpTextPlayer">HP --/--</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-[10px] font-bold text-violet-300">R&amp;D</div>
                  <div class="flex-1 bg-slate-800 h-1.5 rounded-full overflow-hidden border border-slate-600">
                    <div class="h-full bg-violet-500 shadow-[0_0_10px_#A78BFA] transition-all duration-300" id="skBarPlayer" style="width:0%"></div>
                  </div>
                  <div class="text-[10px] mono text-violet-200" id="skTextPlayer">0%</div>
                </div>
                <div class="mt-2 flex gap-3 text-[10px] mono text-slate-400 justify-end">
                  <div>ATK <span id="statAtkP" class="text-slate-200 font-bold">--</span></div>
                  <div>DEF <span id="statDefP" class="text-slate-200 font-bold">--</span></div>
                </div>
                <div class="hidden" id="sectorPlayer"></div><div class="hidden" id="rawPlayer"></div>
              </div>
            </div>
          </div>

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <!-- Commands -->
              <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
                <div class="scanline" style="opacity:.10"></div>
                <div class="flex items-center justify-between">
                  <div class="mono text-sm text-slate-200/90">COMMAND</div>
                  <span class="tag" id="turnTag">—</span>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <button id="cmdAttack" class="btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4"></i><span class="mono">Attack</span>
                  </button>
                  <button id="cmdGuard" class="btn2 px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="shield" class="w-4 h-4"></i><span class="mono">Guard</span>
                  </button>
                  <button id="cmdSkill" class="btn2 px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="flame" class="w-4 h-4"></i><span class="mono">Skill</span>
                  </button>
                  <button id="cmdPivot" class="btn px-3 py-3 rounded-2xl text-sm flex items-center justify-center gap-2">
                    <i data-lucide="move-right" class="w-4 h-4"></i><span class="mono">Pivot</span>
                  </button>
                </div>

                <div class="mt-3 panel2 rounded-2xl p-3 text-xs text-slate-300/75 mono leading-relaxed">
                  <div>• Attack: 市場攻勢（安定ダメージ）</div>
                  <div>• Guard: 財務固め（被ダメ軽減＆DEF上昇）</div>
                  <div>• Skill: 経営資源投入（R&amp;Dゲージ消費で大技）</div>
                  <div>• Pivot: 事業転換（ATK/SPDを一時強化・読み替え）</div>
                </div>

                <div class="mt-3 flex gap-2">
                  <button id="btnAuto" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="bot" class="w-4 h-4"></i><span class="mono">AUTO</span>
                  </button>
                  <button id="btnPause" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                    <i data-lucide="pause" class="w-4 h-4"></i><span class="mono">PAUSE</span>
                  </button>
                </div>
              </div>

              <!-- Log -->
              <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
                <div class="scanline" style="opacity:.10"></div>
                <div class="flex items-center justify-between gap-2">
                  <div class="mono text-sm text-slate-200/90">BATTLE LOG</div>
                  <div class="flex items-center gap-2">
                    <span class="tag" id="logHint">LIVE</span>
                    <button id="btnClearLog" class="btn2 px-2.5 py-2 rounded-xl text-sm flex items-center gap-2">
                      <i data-lucide="trash-2" class="w-4 h-4"></i><span class="mono">CLEAR</span>
                    </button>
                  </div>
                </div>
                <div id="logBox" class="mt-3 h-[240px] sm:h-[280px] overflow-auto pr-1 space-y-2"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RESULT SCREEN -->
            
      <section id="screenResult" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="max-w-4xl mx-auto w-full">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-sky-500/20 border border-emerald-500/30 flex items-center justify-center shadow-[0_0_15px_rgba(16,185,129,0.15)]">
                <i data-lucide="trophy" class="w-6 h-6 text-emerald-300"></i>
              </div>
              <div>
                <span class="tag mb-1">BATTLE RESULT</span>
                <div class="mono text-lg sm:text-xl text-slate-100 font-black glowText" id="resultTitle">—</div>
              </div>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
              <button id="btnRematch" class="btn px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="repeat" class="w-4 h-4"></i><span class="mono">REMATCH</span>
              </button>
              <button id="btnResultBack" class="btn2 px-4 py-2.5 rounded-xl text-sm flex-1 sm:flex-initial flex items-center justify-center gap-2">
                <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            
            <div class="panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                <i data-lucide="activity" class="w-4 h-4 text-slate-400"></i>
                <div class="mono text-sm text-slate-200/90 font-bold">STATS LOG</div>
              </div>
              <div id="resultSnapshot" class="space-y-2 flex-1 text-sm"></div>
            </div>
            
            
            <div class="md:col-span-2 panel2 rounded-2xl p-5 relative overflow-hidden flex flex-col">
              <div class="scanline" style="opacity:.10"></div>
              <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                 <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                 <div class="mono text-sm text-slate-200/90 font-bold">FINANCIAL ANALYSIS</div>
              </div>
              <div id="resultExplainer" class="text-slate-200/90 leading-relaxed text-sm space-y-4 flex-1"></div>
              <div class="mt-5 pt-3 border-t border-slate-700/50 text-[10px] text-slate-400/60 mono text-center">
                ※この分析はゲーム内のパラメータに基づいた架空のものです。実際の投資判断には使用しないでください。
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TOURNAMENT SCREEN -->
      <section id="screenTournament" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="tag">TOURNAMENT</span>
            <div class="mono text-sm text-slate-200/90">8社シングルエリミネーション</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnNewBracket" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="dice-5" class="w-4 h-4"></i><span class="mono">NEW BRACKET</span>
            </button>
            <button id="btnRunNextMatch" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="play" class="w-4 h-4"></i><span class="mono">PLAY NEXT</span>
            </button>
            <button id="btnAutoSim" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="fast-forward" class="w-4 h-4"></i><span class="mono">AUTO SIM</span>
            </button>
            <button id="btnTournamentBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">BRACKET</div>
            <div id="bracketBox" class="mt-3"></div>
          </div>
          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="mono text-sm text-slate-200/90">TOURNAMENT LOG</div>
            <div id="tLog" class="mt-3 h-[320px] overflow-auto pr-1 space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- AI FORGE SCREEN -->
      <section id="screenLab" class="panel rounded-2xl p-4 sm:p-6 relative overflow-hidden hidden">
        <div class="scanline"></div>

        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="tag">AI FORGE</span>
            <div class="mono text-sm text-slate-200/90">企業情報を“無限拡張”するカッコいい追加機能</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLabBack" class="btn px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="home" class="w-4 h-4"></i><span class="mono">BACK</span>
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="flex items-center justify-between">
              <div class="mono text-sm text-slate-200/90">① PROMPT GENERATOR — “CORP INTEL FORGE”</div>
              <span class="tag">COPY</span>
            </div>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="mono text-xs text-slate-300/75">追加件数</label>
                <input id="labCount" type="number" min="1" max="50" value="5" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1" />
              </div>
              <div>
                <label class="mono text-xs text-slate-300/75">地域</label>
                <select id="labRegion" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1">
                  <option value="JP" selected>日本（できれば日経400級）</option>
                  <option value="GLOBAL">海外（外資）</option>
                  <option value="MIX">ミックス</option>
                </select>
              </div>
                            <div class="sm:col-span-2">
                <label class="mono text-xs text-slate-300/75">業種（複数選択OK）</label>
                <div id="sectorChoices" class="mt-2 flex flex-wrap gap-2"></div>
              </div>
              <div class="sm:col-span-2">
                <label class="mono text-xs text-slate-300/75">カスタム指示（自由記述）</label>
                <textarea id="labCustom" rows="2" class="w-full rounded-xl px-3 py-2 mono text-sm mt-1" placeholder="例: 半導体関連の企業を中心に、時価総額高めで作ってください。"></textarea>
              </div>
            </div>

            

            <div class="mt-3">
              <button id="btnGeneratePrompt" class="btn px-4 py-3 rounded-2xl text-base w-full flex items-center justify-center gap-2">
                <i data-lucide="wand-2" class="w-5 h-5"></i><span class="mono font-bold">GENERATE PROMPT</span>
              </button>
            </div>

            <div class="mt-3">
              <textarea id="labPrompt" rows="10" class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" placeholder="ここにプロンプトが生成されます…"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="btnCopyPrompt" class="btn2 px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="copy" class="w-4 h-4"></i><span class="mono">COPY PROMPT</span>
                </button>
                <button id="btnClearPrompt" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="eraser" class="w-4 h-4"></i><span class="mono">CLEAR</span>
                </button>
              </div>
            </div>
          </div>

          <div class="panel2 rounded-2xl p-4 relative overflow-hidden">
            <div class="scanline" style="opacity:.10"></div>
            <div class="flex items-center justify-between">
              <div class="mono text-sm text-slate-200/90">② JSON IMPORT — “DATA INJECTION PORT”</div>
              <span class="tag">PASTE</span>
            </div>

            <div class="mt-3 text-sm text-slate-200/80 leading-relaxed">
              AIから返ってきた <span class="kbd">JSON配列</span> を貼り付けて <span class="kbd">IMPORT</span>。企業を無限に追加できます。
            </div>

            <div class="mt-3">
              <textarea id="labJson" rows="12" class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" placeholder='例:
[
  {
    "name":"Example Corp",
    "name_jp":"例株式会社",
    "domain":"example.com",
    "sector":"Tech",
    "currency":"JPY",
    "cash": 1200,
    "operating_margin": 18.5,
    "equity_ratio": 52.0,
    "market_cap": 18000,
    "employees": 12000,
    "rnd": 900
  }
]
※cash/market_cap/rnd は「十億円(=billion JPY)」単位推奨'></textarea>
            </div>

            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
              <button id="btnImportJson" class="btn px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2">
                <i data-lucide="download" class="w-5 h-5"></i><span class="mono font-bold">IMPORT</span>
              </button>
              <button id="btnExportJson" class="btn2 px-4 py-3 rounded-2xl text-base flex items-center justify-center gap-2">
                <i data-lucide="upload" class="w-5 h-5"></i><span class="mono font-bold">EXPORT ALL</span>
              </button>
            </div>

            <div class="mt-3 panel2 rounded-2xl p-3">
              <div class="mono text-xs text-slate-300/75">DATABASE</div>
              <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div class="panel2 rounded-xl p-2">
                  <div class="mono text-[10px] text-slate-300/75">COMPANIES</div>
                  <div class="mono font-black text-lg" id="dbCount">0</div>
                </div>
                <div class="panel2 rounded-xl p-2">
                  <div class="mono text-[10px] text-slate-300/75">STATUS</div>
                  <div class="mono font-black text-lg" id="dbStatus">OK</div>
                </div>
              </div>
              <div class="mt-2 flex gap-2">
                <button id="btnClearDb" class="btnDanger px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="trash" class="w-4 h-4"></i><span class="mono">CLEAR DB</span>
                </button>
                <button id="btnRestoreSample" class="btn px-3 py-2 rounded-xl text-sm flex-1 flex items-center justify-center gap-2">
                  <i data-lucide="refresh-ccw" class="w-4 h-4"></i><span class="mono">RESTORE SAMPLE</span>
                </button>
              </div>
            </div>

            <div class="mt-3 text-xs text-slate-300/65 mono">
              IndexedDBに保存されるため、ページを閉じても企業プールは残ります。
            </div>
          </div>
        </div>
      </section>

      <!-- MODAL -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center px-4 z-[80]">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative w-full max-w-2xl panel rounded-2xl p-4 sm:p-6 overflow-hidden">
          <div class="scanline"></div>
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="tag" id="modalTag">INFO</span>
              <div class="mono text-sm text-slate-200/90" id="modalTitle">—</div>
            </div>
            <button id="btnCloseModal" class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2">
              <i data-lucide="x" class="w-4 h-4"></i><span class="mono">CLOSE</span>
            </button>
          </div>
          <div id="modalBody" class="mt-3"></div>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[90] hidden">
        <div id="toastInner" class="panel2 rounded-2xl px-4 py-3 mono text-sm"></div>
      </div>

    </main>

    <footer class="py-6 text-xs text-slate-300/65 mono">
      CORPORATE QUEST • Single HTML • Logos by Clearbit • Data persisted via IndexedDB • UI for AppStudio
    </footer>
  </div>

  <script>
    /********************
     * UTIL
     ********************/
    const $ = (id)=>document.getElementById(id);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const rnd = (min,max)=>Math.random()*(max-min)+min;
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const fmt = (n, d=0)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const nowIso = ()=>new Date().toISOString();

    function hashStr(s){
      let h=2166136261>>>0;
      for(let i=0;i<s.length;i++){
        h^=s.charCodeAt(i);
        h = Math.imul(h,16777619);
      }
      return h>>>0;
    }
    function seededRand(seed){
      // xorshift32
      let x = seed>>>0;
      return ()=> {
        x ^= x << 13; x >>>= 0;
        x ^= x >> 17; x >>>= 0;
        x ^= x << 5;  x >>>= 0;
        return (x>>>0) / 4294967296;
      };
    }

    function toast(msg, kind="info"){
      const el = $("toast");
      const inner = $("toastInner");
      inner.textContent = msg;
      inner.style.borderColor = kind==="bad" ? "rgba(251,113,133,.35)" : kind==="good" ? "rgba(52,211,153,.30)" : "rgba(53,247,255,.22)";
      el.classList.remove("hidden");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.add("hidden"), 2100);
    }

    function copyToClipboard(text){
      return navigator.clipboard?.writeText(text).then(()=>true).catch(()=>false);
    }

    /********************
     * SECTORS & SKILLS
     ********************/
        const MOTIONS = [
      "m-smash", "m-rush", "m-sonic", "m-snipe", "m-drill",
      "m-jump", "m-zigzag", "m-tackle", "m-uppercut", "m-meteor",
      "m-shadow", "m-giant", "m-helix", "m-impact", "m-wobble",
      "m-charge", "m-boomerang", "m-frenzy", "m-stealth", "m-pulse"
    ];

    const SECTORS = [
      {key:"Tech", label:"Tech / Electronics"},
      {key:"Auto", label:"Automotive"},
      {key:"Finance", label:"Finance"},
      {key:"Retail", label:"Retail"},
      {key:"Telecom", label:"Telecom"},
      {key:"Industrial", label:"Industrial / Manufacturing"},
      {key:"Pharma", label:"Pharma / Healthcare"},
      {key:"Energy", label:"Energy / Utilities"},
    ];

    /* スキルの効果ロジック定義 (Archetypes) */
    const SKILL_ARCHETYPES = {
      "BURST": { mult: 1.8, pierce: 0.15, fx: "NEON", desc:"高火力・貫通攻撃" },
      "GUARD": { mult: 1.2, buff:{key:"guard", val:0.6}, fx:"AURA", desc:"攻撃＋強力な防御" },
      "SPEED": { mult: 1.4, buff:{key:"spd_up", val:0.25}, fx:"SPARK", desc:"攻撃＋SPD大幅上昇" },
      "DRAIN": { mult: 1.3, drain:0.4, fx:"GLITCH", desc:"HP吸収攻撃" },
      "DOT":   { mult: 1.3, debuff:{key:"bleed", val:0.04}, fx:"STORM", desc:"攻撃＋継続ダメージ" },
      "JAM":   { mult: 1.3, debuff:{key:"spd_down", val:-0.25}, fx:"GLITCH", desc:"攻撃＋敵SPD低下" },
      "BUFF":  { mult: 1.4, buff:{key:"atk_up", val:0.2}, fx:"WAVE", desc:"攻撃＋ATK上昇" },
    };

        /* --- NEW: COMBO SKILLS & MARKET EVENTS --- */
    const COMBO_SKILLS = {
      "Industrial_Auto": { name: "Steel Price Shock", desc: "鋼材価格の強制値上げ（特大ダメ＋敵DEF↓）", mult: 1.9, fx: "IMPACT", debuff: {key:"def_down", val:-0.25} },
      "Tech_Finance": { name: "DeFi Hack", desc: "分散型金融ハック（HP吸収）", mult: 1.5, fx: "GLITCH", drain: 0.3 },
      "Energy_Industrial": { name: "Power Crunch", desc: "電力供給絞り込み（敵SPD↓）", mult: 1.7, fx: "ARC", debuff: {key:"spd_down", val:-0.3} },
      "Retail_Tech": { name: "Direct-to-Consumer", desc: "中抜き戦略（ゲージ回収）", mult: 1.5, fx: "WAVE", gauge: 25 },
      "Telecom_Tech": { name: "Infrastructure Tax", desc: "インフラ利用料徴収（敵ゲージ没収）", mult: 1.6, fx: "GLITCH", gaugeEnemy: -25 },
      "Auto_Energy": { name: "EV Shift", desc: "脱炭素シフト（攻勢バフ）", mult: 1.6, fx: "SPARK", buff: {key:"atk_up", val:0.25} },
      "Pharma_Finance": { name: "M&A Defense", desc: "買収防衛策（強固な守り）", mult: 1.2, fx: "STORM", buff: {key:"guard", val:0.5} },
      "Finance_Retail": { name: "Credit Crunch", desc: "貸し渋り（敵攻撃↓）", mult: 1.5, fx: "AURA", debuff: {key:"atk_down", val:-0.2} }
    };

            const MARKET_EVENTS = [
      { name: "Bull Market", text: "好景気到来！市場心理が改善", type:"good", func:(b)=>{
        b.fx(null, "MONEY"); b.fx(null, "FLASH_GREEN");
        b.gainSkill(b.P, 20); b.gainSkill(b.C, 20); return "両社のR&Dゲージ増加 (+20)";
      }},
      { name: "Recession", text: "景気後退…需要減退", type:"bad", func:(b)=>{
        b.fx(null, "CRASH"); b.fx(null, "FLASH_RED");
        b.damage(b.P, Math.floor(b.P.maxHP*0.08), {isDot:true}); b.damage(b.C, Math.floor(b.C.maxHP*0.08), {isDot:true}); return "両社にダメージ (8%)";
      }},
      { name: "Tech Bubble Burst", text: "テックバブル崩壊", type:"bad", func:(b)=>{ 
          b.fx(null, "GLITCH"); b.fx(null, "CRASH");
          [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Telecom") b.spendSkill(u, 40); });
          return "Tech/Telecom企業のゲージ減少 (-40)"; 
      }},
      { name: "Supply Chain Crisis", text: "サプライチェーン混乱", type:"bad", func:(b)=>{
          b.fx(null, "QUAKE");
          [b.P, b.C].forEach(u=>{ if(u.company.sector==="Auto"||u.company.sector==="Industrial"||u.company.sector==="Retail") b.addBuff(u, {key:"spd_down", name:"CRISIS", turns:2, meta:{spd:-0.3}}); });
          return "Auto/Ind/RetailのSPD大幅低下";
      }},
      { name: "Geopolitical Tension", text: "地政学リスク増大", type:"bad", func:(b)=>{
          b.fx(null, "QUAKE"); b.fx(null, "FLASH_RED");
          [b.P, b.C].forEach(u=>{ if(u.company.sector==="Energy"||u.company.sector==="Finance") b.addBuff(u, {key:"def_up", name:"HEDGE", turns:3, meta:{def:0.3}}); });
          return "Energy/Financeが防御態勢 (DEF↑)";
      }},
      { name: "AI Innovation Wave", text: "AIイノベーションの波", type:"good", func:(b)=>{
          b.fx(null, "NEON"); b.fx(null, "FLASH_NEON");
          [b.P, b.C].forEach(u=>{ if(u.company.sector==="Tech"||u.company.sector==="Pharma") b.addBuff(u, {key:"crit_up", name:"AI", turns:3, meta:{crit:0.25}}); });
          return "Tech/Pharmaのクリ率上昇";
      }},
      { name: "Subcontract Act Inspection", text: "中小企業庁が下請法検査を実施！", type:"bad", func:(b)=>{
        b.fx(null, "GLITCH"); b.fx(null, "FLASH_RED");
        let msg = "";
        [b.P, b.C].forEach(u=>{
          if(["Auto","Industrial","Retail","Tech","Telecom"].includes(u.company.sector)){
            if(Math.random() < 0.4){
              b.addBuff(u, {key:"stun", name:"STOP", turns:1, meta:{}});
              msg += `${b.nameOf(u)}は営業停止処分(1ターン)！ `;
            }
          }
        });
        return msg || "指摘事項なし。";
      }},
      { name: "Tariff War", text: "トランプ前大統領(?)が関税法を発動！", type:"bad", func:(b)=>{
        b.fx(null, "CRASH"); b.fx(null, "QUAKE");
        let msg = "";
        [b.P, b.C].forEach(u=>{
          if(["Auto","Industrial","Tech"].includes(u.company.sector)){
            if(Math.random() < 0.3){
              msg += `${b.nameOf(u)}はTACO(Tuesday Taco?)で回避！ `;
            } else {
              const dmg = Math.floor(u.maxHP * 0.12);
              b.damage(u, dmg, {fx:"IMPACT"});
              msg += `${b.nameOf(u)}に関税ダメージ(-${dmg}) `;
            }
          }
        });
        return msg || "影響なし。";
      }},
      { name: "Embezzlement Scandal", text: "巨額横領事件が発生！", type:"bad", func:(b)=>{
        b.fx(null, "FLASH_RED"); b.fx(null, "STORM");
        let msg = "";
        [b.P, b.C].forEach(u=>{
          let chance = u.company.sector==="Finance" ? 0.5 : 0.1;
          if(Math.random() < chance){
            const dmg = Math.floor(u.maxHP * 0.15);
            b.damage(u, dmg, {isDot:true});
            b.addBuff(u, {key:"def_down", name:"SCANDAL", turns:3, meta:{def:-0.25}});
            msg += `${b.nameOf(u)}で不祥事発覚！信用失墜(-${dmg}, DEF↓) `;
          }
        });
        return msg || "内部統制は機能している。";
      }},
      { name: "China Shock", text: "中国市場からの余剰材が流入！", type:"bad", func:(b)=>{
        b.fx(null, "WAVE"); b.fx(null, "QUAKE");
        let msg = "";
        [b.P, b.C].forEach(u=>{
          if(["Industrial","Auto","Tech"].includes(u.company.sector)){
            b.addBuff(u, {key:"atk_down", name:"DUMPING", turns:3, meta:{atk:-0.2}});
            const dmg = Math.floor(u.maxHP * 0.05);
            b.damage(u, dmg);
            msg += `${b.nameOf(u)}は価格競争に巻き込まれた(-${dmg}, ATK↓) `;
          }
        });
        return msg || "市場への影響は軽微。";
      }}
    ];

    const SECTOR_SKILLS = {
      Tech: {
        name: "Quantum Launch",
        desc: "AI/新製品で市場を焼き尽くす（大ダメージ＋クリ率UP）",
        fx: "NEON",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"crit_up", name:"CRIT↑", turns:2, meta:{crit:0.14}});
          return {mult: 1.75, pierce: 0.10};
        }
      },
      Auto: {
        name: "Supply Chain Blitz",
        desc: "供給網最適化（中ダメージ＋自己回復）",
        fx: "SPARK",
        apply: (ctx)=> {
          const heal = Math.floor(ctx.user.maxHP * 0.08);
          ctx.heal(ctx.user, heal, "SC BLITZ");
          return {mult: 1.45, pierce: 0.05};
        }
      },
      Finance: {
        name: "Capital Shield",
        desc: "資本政策（小ダメージ＋強Guard）",
        fx: "AURA",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"guard", name:"GUARD+", turns:2, meta:{dr:0.55, def:0.18}});
          return {mult: 1.10, pierce: 0.00};
        }
      },
      Retail: {
        name: "Brand Surge",
        desc: "ブランド旋風（中ダメージ＋SPD上昇）",
        fx: "WAVE",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"spd_up", name:"SPD↑", turns:3, meta:{spd:0.18}});
          return {mult: 1.35, pierce: 0.02};
        }
      },
      Telecom: {
        name: "Network Jam",
        desc: "ネットワーク妨害（中ダメージ＋敵SPD低下）",
        fx: "GLITCH",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"spd_down", name:"SPD↓", turns:2, meta:{spd:-0.20}});
          return {mult: 1.30, pierce: 0.06};
        }
      },
      Industrial: {
        name: "Lean Strike",
        desc: "改善活動（中ダメージ＋DEF上昇）",
        fx: "IMPACT",
        apply: (ctx)=> {
          ctx.addBuff(ctx.user, {key:"def_up", name:"DEF↑", turns:3, meta:{def:0.20}});
          return {mult: 1.30, pierce: 0.04};
        }
      },
      Pharma: {
        name: "Patent Storm",
        desc: "特許・パイプライン（大ダメージ＋継続圧力）",
        fx: "STORM",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"bleed", name:"PIPELINE", turns:3, meta:{dot:0.035}});
          return {mult: 1.60, pierce: 0.08};
        }
      },
      Energy: {
        name: "Grid Overload",
        desc: "インフラ強制（中ダメージ＋敵DEF低下）",
        fx: "ARC",
        apply: (ctx)=> {
          ctx.addBuff(ctx.enemy, {key:"def_down", name:"DEF↓", turns:2, meta:{def:-0.18}});
          return {mult: 1.35, pierce: 0.06};
        }
      }
    };

    /********************
     * SAMPLE DATA (approx; billion JPY)
     * cash / market_cap / rnd are in "billion JPY"
     ********************/
const SAMPLE_COMPANIES = [
      {
        id:"jp-toyota",
        name:"Toyota Motor", name_jp:"トヨタ自動車", domain:"toyota.co.jp", sector:"Auto", currency:"JPY",
        cash: 8500, operating_margin: 10.0, equity_ratio: 40.0, market_cap: 45000, employees: 375000, rnd: 1200,
        skill_name: "KAIZEN Flow", skill_desc: "『改善』の連鎖による神速の供給網", skill_type: "SPEED",
        attacks: [
          {name:"Just-in-Time", desc:"在庫ゼロの超効率供給"},
          {name:"Hybrid Drive", desc:"全方位戦略のシナジー"},
          {name:"Andon Cord", desc:"品質異常を即座に検知"}
        ]
      },
      {
        id:"jp-sony",
        name:"Sony Group", name_jp:"ソニーグループ", domain:"sony.com", sector:"Tech", currency:"JPY",
        cash: 3200, operating_margin: 12.0, equity_ratio: 35.0, market_cap: 18000, employees: 110000, rnd: 900,
        skill_name: "Kando Resonance", skill_desc: "テクノロジーと感動の融合で市場を席巻", skill_type: "BURST",
        attacks: [
          {name:"CMOS Sensor", desc:"世界No.1シェアの眼"},
          {name:"Content IP", desc:"ゲーム・アニメ・音楽の複合力"},
          {name:"Hardware Design", desc:"洗練されたプロダクト"}
        ]
      },
      {
        id:"jp-keyence",
        name:"KEYENCE", name_jp:"キーエンス", domain:"keyence.co.jp", sector:"Industrial", currency:"JPY",
        cash: 2400, operating_margin: 52.0, equity_ratio: 88.0, market_cap: 17000, employees: 9000, rnd: 120,
        skill_name: "Super High Margin", skill_desc: "圧倒的付加価値で利益を吸い上げる", skill_type: "DRAIN",
        attacks: [
          {name:"Direct Sales", desc:"代理店を通さない直販体制"},
          {name:"Consultative", desc:"潜在ニーズを掘り起こす提案"},
          {name:"Same Day Ship", desc:"即納体制による機会損失ゼロ"}
        ]
      },
      {
        id:"jp-fastretailing",
        name:"Fast Retailing", name_jp:"ファーストリテイリング", domain:"fastretailing.com", sector:"Retail", currency:"JPY",
        cash: 1100, operating_margin: 16.0, equity_ratio: 55.0, market_cap: 12000, employees: 60000, rnd: 80,
        skill_name: "LifeWear Platform", skill_desc: "あらゆる生活に浸透するインフラ化", skill_type: "BUFF",
        attacks: [
          {name:"SPA Model", desc:"企画から販売まで一気通貫"},
          {name:"Global Flagship", desc:"世界主要都市への出店攻勢"},
          {name:"Functional Fabric", desc:"ヒートテック等の素材革新"}
        ]
      },
      {
        id:"jp-softbank",
        name:"SoftBank Group", name_jp:"ソフトバンクグループ", domain:"softbank.jp", sector:"Telecom", currency:"JPY",
        cash: 4200, operating_margin: 9.0, equity_ratio: 24.0, market_cap: 9000, employees: 65000, rnd: 300,
        skill_name: "Unicorn Bet", skill_desc: "群集心理を操るハイリスク投資", skill_type: "BURST",
        attacks: [
          {name:"Vision Fund", desc:"巨額資本による市場レバレッジ"},
          {name:"Arm Chip", desc:"半導体設計の独占的地位"},
          {name:"Debt Leverage", desc:"借入を最大活用した拡大"}
        ]
      },
      {
        id:"jp-recruit",
        name:"Recruit Holdings", name_jp:"リクルートホールディングス", domain:"recruit.co.jp", sector:"Tech", currency:"JPY",
        cash: 1400, operating_margin: 18.0, equity_ratio: 50.0, market_cap: 10000, employees: 51000, rnd: 250,
        skill_name: "Ribbon Matching", skill_desc: "リボンモデルで市場の自由度を支配", skill_type: "JAM",
        attacks: [
          {name:"Ribbon Model", desc:"ユーザーとクライアントを囲い込み"},
          {name:"Global HR", desc:"Indeed等による世界的求人網"},
          {name:"Entrepreneurship", desc:"社内起業家による新規事業"}
        ]
      },
      {
        id:"jp-ntt",
        name:"NTT", name_jp:"日本電信電話（NTT）", domain:"ntt.co.jp", sector:"Telecom", currency:"JPY",
        cash: 1700, operating_margin: 16.0, equity_ratio: 28.0, market_cap: 14000, employees: 320000, rnd: 500,
        skill_name: "Optical Shield", skill_desc: "光構想(IOWN)による鉄壁の通信要塞", skill_type: "GUARD",
        attacks: [
          {name:"IOWN Concept", desc:"次世代光通信基盤"},
          {name:"Real Estate", desc:"膨大な保有不動産の活用"},
          {name:"Stable Dividend", desc:"安定配当による株主求心力"}
        ]
      },
      {
        id:"jp-mufg",
        name:"MUFG", name_jp:"三菱UFJフィナンシャル・グループ", domain:"mufg.jp", sector:"Finance", currency:"JPY",
        cash: 6000, operating_margin: 6.0, equity_ratio: 6.0, market_cap: 16000, employees: 160000, rnd: 90,
        skill_name: "Red Bank Vault", skill_desc: "盤石な資本基盤による完全防御", skill_type: "GUARD",
        attacks: [
          {name:"Global Network", desc:"海外銀行買収による多角化"},
          {name:"Main Bank", desc:"圧倒的な法人顧客基盤"},
          {name:"Cross-Selling", desc:"グループ総合力による提案"}
        ]
      },
      {
        id:"jp-hitachi",
        name:"Hitachi", name_jp:"日立製作所", domain:"hitachi.com", sector:"Industrial", currency:"JPY",
        cash: 1500, operating_margin: 9.5, equity_ratio: 32.0, market_cap: 12000, employees: 320000, rnd: 450,
        skill_name: "Lumada Grid", skill_desc: "社会インフラDXでじわじわ侵食", skill_type: "DOT",
        attacks: [
          {name:"Lumada", desc:"顧客データを価値に変えるDX"},
          {name:"Portfolio Shuffle", desc:"事業の選択と集中"},
          {name:"Green Energy", desc:"送電・鉄道などの環境インフラ"}
        ]
      },
      {
        id:"jp-takeda",
        name:"Takeda", name_jp:"武田薬品工業", domain:"takeda.com", sector:"Pharma", currency:"JPY",
        cash: 900, operating_margin: 14.0, equity_ratio: 28.0, market_cap: 6000, employees: 50000, rnd: 480,
        skill_name: "Shonan Pipeline", skill_desc: "創薬イノベーションで活力を吸収", skill_type: "DRAIN",
        attacks: [
          {name:"Mega M&A", desc:"巨額買収によるパイプライン獲得"},
          {name:"Rare Disease", desc:"希少疾患領域への集中"},
          {name:"Global Trials", desc:"世界規模の治験ネットワーク"}
        ]
      }
    ];

    /********************
     * IndexedDB
     ********************/
    const DB_NAME = "corporate_quest_db";
    const DB_VER = 1;
    const STORE_COMP = "companies";
    const STORE_META = "meta";

    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = (e)=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE_COMP)){
            db.createObjectStore(STORE_COMP, {keyPath:"id"});
          }
          if(!db.objectStoreNames.contains(STORE_META)){
            db.createObjectStore(STORE_META, {keyPath:"key"});
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function dbGetAll(store){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readonly");
        const st = tx.objectStore(store);
        const req = st.getAll();
        req.onsuccess = ()=>resolve(req.result||[]);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function dbPut(store, obj){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
        tx.objectStore(store).put(obj);
      });
    }

    async function dbPutMany(store, arr){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        const st = tx.objectStore(store);
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
        for(const x of arr) st.put(x);
      });
    }

    async function dbClear(store){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(store,"readwrite");
        const st = tx.objectStore(store);
        const req = st.clear();
        req.onsuccess = ()=>resolve(true);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function metaGet(key){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(STORE_META,"readonly");
        const st = tx.objectStore(STORE_META);
        const req = st.get(key);
        req.onsuccess = ()=>resolve(req.result?.value);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function metaSet(key, value){
      return dbPut(STORE_META, {key, value, updatedAt: nowIso()});
    }

    /********************
     * GAME STATE
     ********************/
    const Screens = {
      Start: "screenStart",
      Battle: "screenBattle",
      Result: "screenResult",
      Tournament: "screenTournament",
      Lab: "screenLab",
    };

    const state = {
      companies: [],
      playerId: null,
      cpuId: null,

      // battle runtime
      battle: null,

      // tournament
      tournament: null,

      // settings
      fx: {USD:150, EUR:165, GBP:190}
    };

    function showScreen(key){
      for(const k of Object.values(Screens)){
        const el = $(k);
        if(el) el.classList.add("hidden");
      }
      $(key).classList.remove("hidden");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function getCompany(id){
      return state.companies.find(c=>c.id===id);
    }

    function companyLabel(c){
      return `${c.name_jp || c.name} / ${c.name}`;
    }

    function initialsFor(c){
      const s = (c.name_jp || c.name || "CO").trim();
      const letters = s.replace(/株式会社/g,"").replace(/\s+/g," ").trim();
      // prefer roman initials if available
      if(/[A-Za-z]/.test(c.name||"")){
        const words = (c.name||"").split(/\s+/).filter(Boolean);
        const init = words.slice(0,2).map(w=>w[0].toUpperCase()).join("");
        return init || (c.name||"C")[0].toUpperCase();
      }
      // Japanese: take first 2 characters excluding symbols
      const jp = letters.replace(/[^\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}A-Za-z0-9]/gu,"");
      return jp.slice(0,2) || "CQ";
    }

        function makeLogo(el, c){
      el.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "w-full h-full flex items-center justify-center relative";
      const img = document.createElement("img");
      img.alt = c.name;
      /* unavatar.io を使用してロゴ取得率を向上させます */
      img.src = `https://unavatar.io/${c.domain}?fallback=false`;
      img.onerror = ()=>{
        img.remove();
        const fb = document.createElement("div");
        fb.className = "logoFallback";
        fb.textContent = initialsFor(c);
        wrap.appendChild(fb);
      };
      wrap.appendChild(img);
      el.appendChild(wrap);
    }

    /********************
     * FINANCIAL -> GAME STAT
     *
     * Inputs: cash, market_cap, rnd (billion JPY); margins/ratios (%)
     * Output: hp/atk/def/spd, skillMax, gaugeGain
     ********************/
    function buildScaler(companies){
      // Build normalization ranges from current pool.
      const cash = companies.map(c=>+c.cash||0);
      const mcap = companies.map(c=>+c.market_cap||0);
      const rndv = companies.map(c=>+c.rnd||0);
      const om = companies.map(c=>+c.operating_margin||0);
      const eq = companies.map(c=>+c.equity_ratio||0);

      const minmax = (arr)=>({min: Math.min(...arr), max: Math.max(...arr)});
      const aCash = minmax(cash);
      const aMcap = minmax(mcap);
      const aRnd  = minmax(rndv);
      const aOm   = minmax(om);
      const aEq   = minmax(eq);

      // avoid zero-range
      function norm(v, a){
        if(!isFinite(v)) v = 0;
        const d = (a.max - a.min);
        if(d <= 1e-9) return 0.5;
        return clamp((v - a.min) / d, 0, 1);
      }

      return {aCash,aMcap,aRnd,aOm,aEq,norm};
    }

    function deriveStats(c, scaler){
      // compress huge values with log
      const cash = Math.log10((+c.cash||1) + 1);
      const mcap = Math.log10((+c.market_cap||1) + 1);
      const rndv = Math.log10((+c.rnd||1) + 1);

      const cashN = scaler.norm(cash, {min: Math.log10(scaler.aCash.min+1), max: Math.log10(scaler.aCash.max+1)});
      const mcapN = scaler.norm(mcap, {min: Math.log10(scaler.aMcap.min+1), max: Math.log10(scaler.aMcap.max+1)});
      const rndN  = scaler.norm(rndv, {min: Math.log10(scaler.aRnd.min+1),  max: Math.log10(scaler.aRnd.max+1)});

      const omN = scaler.norm(+c.operating_margin||0, scaler.aOm);
      const eqN = scaler.norm(+c.equity_ratio||0, scaler.aEq);

      // HP: 180..420
      const hp = Math.round(lerp(190, 420, cashN));
      // ATK: 40..120 (om matters; keyence etc will be strong)
      const atk = Math.round(lerp(45, 125, Math.pow(omN, 0.80)));
      // DEF: 35..120
      const def = Math.round(lerp(38, 120, Math.pow(eqN, 0.85)));
      // SPD: 40..120 (market cap / employees proxy)
      const spd = Math.round(lerp(45, 120, Math.pow(mcapN, 0.78)));

      // Skill Gauge max: 100 fixed; fill speed depends on rnd and spd
      const skillMax = 100;
      const gaugeGain = Math.round(lerp(8, 20, (rndN*0.70 + mcapN*0.30)));

      // extra: employee used in tooltip only (or later)
      return {hp, atk, def, spd, skillMax, gaugeGain, cashN, mcapN, rndN, omN, eqN};
    }

    /********************
     * BATTLE ENGINE
     ********************/
        function makeFighter(c, scaler){
      const st = deriveStats(c, scaler);
      // Assign random motion deterministically based on ID if not present
      if(!c.motion) c.motion = MOTIONS[hashStr(c.id || c.name) % MOTIONS.length];
      
      return {
        company: c,
        base: st,
        maxHP: st.hp,
        hp: st.hp,
        atk: st.atk,
        def: st.def,
        spd: st.spd,
        skillMax: st.skillMax,
        skill: Math.round(st.gaugeGain * 2), // start with some gauge
        gaugeGain: st.gaugeGain,
        buffs: []
      };
    }

    function addBuff(target, buff){
      // if same key exists, refresh stronger / longer
      const ex = target.buffs.find(b=>b.key===buff.key);
      if(ex){
        ex.turns = Math.max(ex.turns, buff.turns);
        ex.meta = {...ex.meta, ...buff.meta};
        ex.name = buff.name;
      } else {
        target.buffs.push({...buff});
      }
    }

    function tickBuffs(target){
      for(const b of target.buffs){
        b.turns -= 1;
      }
      target.buffs = target.buffs.filter(b=>b.turns>0);
    }

    function getBuffValue(target, key, field, defVal=0){
      const b = target.buffs.find(x=>x.key===key);
      if(!b) return defVal;
      return (b.meta && b.meta[field] != null) ? b.meta[field] : defVal;
    }

    function computeMods(target){
      // aggregate multiplicative-ish modifiers
      let atkM = 1, defM = 1, spdM = 1, critAdd = 0, dr = 0;
      for(const b of target.buffs){
        if(b.meta?.atk) atkM += b.meta.atk;
        if(b.meta?.def) defM += b.meta.def;
        if(b.meta?.spd) spdM += b.meta.spd;
        if(b.meta?.crit) critAdd += b.meta.crit;
        if(b.meta?.dr) dr = Math.max(dr, b.meta.dr);
      }
      return {atkM, defM, spdM, critAdd, dr};
    }

    function damageFormula(attacker, defender, opts={}){
      const modsA = computeMods(attacker);
      const modsD = computeMods(defender);

      const atk = attacker.atk * modsA.atkM;
      const def = defender.def * modsD.defM;

      const base = atk * rnd(0.85, 1.15);
      const pierce = opts.pierce ?? 0.0;

      // reduction by DEF; keep it bounded
      const reducedDef = def * (1 - pierce);
      const mitigation = clamp(reducedDef / (reducedDef + 120), 0.10, 0.70); // 10%..70% reduction
      let dmg = base * (1 - mitigation);

      // guard damage reduction
      const dr = Math.max(modsD.dr, opts.forceDR ?? 0);
      dmg = dmg * (1 - clamp(dr, 0, 0.75));

      // skill multiplier
      if(opts.mult) dmg *= opts.mult;

      // crit chance based on SPD advantage + buffs
      const spdA = attacker.spd * modsA.spdM;
      const spdD = defender.spd * modsD.spdM;
      const adv = clamp((spdA - spdD) / 160, -0.10, 0.18);
      const critChance = clamp(0.06 + adv + modsA.critAdd, 0.03, 0.35);
      const isCrit = Math.random() < critChance;

      if(isCrit) dmg *= rnd(1.35, 1.60);

      dmg = Math.round(clamp(dmg, 6, 260));
      return {dmg, isCrit, critChance};
    }

    function applyDot(battle){
      // bleed DOT on each turn start
      for(const side of ["P","C"]){
        const t = side==="P" ? battle.P : battle.C;
        const bleed = t.buffs.find(b=>b.key==="bleed");
        if(bleed){
          const dot = bleed.meta?.dot ?? 0.03;
          const amount = Math.max(6, Math.round(t.maxHP * dot));
          battle.damage(t, amount, {label:"PIPELINE DOT", isDot:true});
          battle.log(`${battle.nameOf(t)} のパイプライン圧力が継続ダメージ！ <span class="text-rose-300">-${amount}</span>`);
        }
      }
    }

    function battleCreate(playerCompany, cpuCompany){
      const scaler = buildScaler(state.companies);
      const P = makeFighter(playerCompany, scaler);
      const C = makeFighter(cpuCompany, scaler);

      const battle = {
        scaler,
        P, C,
        turn: 1,
        paused: false,
        auto: false,
        finished: false,
        winner: null,
        lastAction: null,
        logs: [],
        seed: hashStr(playerCompany.id + "|" + cpuCompany.id + "|" + nowIso()),
        nameOf: (f)=> f.company.name_jp || f.company.name,
        enemyOf: (f)=> (f===P ? C : P),

        addBuff: (t,b)=>addBuff(t,b),

        heal: (t, amount, label="HEAL")=>{
          const prev = t.hp;
          t.hp = clamp(t.hp + amount, 0, t.maxHP);
          const real = t.hp - prev;
          if(real>0){
            battle.showFloat(t, `+${real}`, "good");
            battle.fx(t===P ? "P":"C", "AURA");
            battle.log(`${battle.nameOf(t)} が資金を確保（${label}） <span class="text-emerald-300">+${real}</span>`);
          }
        },

        damage: (t, amount, meta={})=>{
          const prev = t.hp;
          t.hp = clamp(t.hp - amount, 0, t.maxHP);
          const real = prev - t.hp;
          battle.showFloat(t, `-${real}`, meta.isDot ? "bad" : "bad");
          if(!meta.isDot) battle.fx(t===P ? "P":"C", meta.fx || "IMPACT");
          return real;
        },

        spendSkill: (t, cost)=>{ t.skill = clamp(t.skill - cost, 0, t.skillMax); },
        gainSkill: (t, g)=>{ t.skill = clamp(t.skill + g, 0, t.skillMax); },

                log: (html)=>{
          battle.logs.push({t:Date.now(), html});
          renderLog();
          showBattleToast(html);
        },

        showFloat: (t, text, tone)=>{
          const arena = $("arena");
          const box = document.createElement("div");
          box.className = "floatDmg";
          box.style.color = tone==="good" ? "rgba(52,211,153,.95)" : "rgba(251,113,133,.95)";
          const side = (t===P) ? "P" : "C";
          const rect = arena.getBoundingClientRect();
          // place near logo
          const target = side==="P" ? $("logoWrapPlayer") : $("logoWrapCPU");
          const tr = target.getBoundingClientRect();
          const x = (tr.left - rect.left) + tr.width*0.55 + rnd(-10, 18);
          const y = (tr.top - rect.top) + tr.height*0.18 + rnd(-6, 8);
          box.style.left = x + "px";
          box.style.top = y + "px";
          box.textContent = text;
          arena.appendChild(box);
          setTimeout(()=>box.remove(), 980);
        },

                fx: (side, type)=>{
          const arena = $("arena");
          // Reset anims
          arena.classList.remove("flash", "shake", "quake", "glitch-anim");
          void arena.offsetWidth; // trigger reflow

          // --- 1. Screen Animations ---
          if(type==="IMPACT") arena.classList.add("shake");
          if(type==="QUAKE") arena.classList.add("quake");
          if(type==="GLITCH" || type==="ARC"){
            arena.classList.add("glitch-anim");
            setTimeout(()=>arena.classList.remove("glitch-anim"), 600);
          }

          // --- 2. Color Flash Overlays ---
          let flashColor = null;
          if(type==="NEON" || type==="FLASH_NEON" || type==="ARC") flashColor = "rgba(53,247,255,0.35)";
          if(type==="FLASH_RED") flashColor = "rgba(251,113,133,0.35)";
          if(type==="FLASH_GREEN") flashColor = "rgba(52,211,153,0.3)";

          if(flashColor){
            const overlay = document.createElement("div");
            overlay.className = "absolute inset-0 z-20 pointer-events-none transition-opacity duration-500 ease-out opacity-0";
            overlay.style.background = `radial-gradient(circle, ${flashColor}, transparent)`;
            arena.appendChild(overlay);
            requestAnimationFrame(()=>{
              overlay.classList.remove("opacity-0"); overlay.classList.add("opacity-100");
              setTimeout(()=>{
                overlay.classList.remove("opacity-100"); overlay.classList.add("opacity-0");
                setTimeout(()=>overlay.remove(), 500);
              }, 200);
            });
          } else if(type!=="QUAKE" && type!=="GLITCH" && !type.startsWith("FLASH")) {
            // default flash
            arena.classList.add("flash");
          }

          // --- 3. Particles (Confetti) ---
          const x = side==="P" ? 0.28 : side==="C" ? 0.72 : 0.5;
          const y = 0.4;

          if(type==="NEON" || type==="ARC" || type==="GLITCH" || type==="FLASH_NEON"){
            confetti({particleCount: 65, spread: 60, startVelocity: 35, colors:['#35F7FF', '#A78BFA', '#FFFFFF'], origin: {x,y}});
          }
          else if(type==="STORM"){
            confetti({particleCount: 60, spread: 90, startVelocity: 25, gravity:1.5, colors:['#94A3B8', '#475569'], origin: {x,y:0.2}});
          }
          else if(type==="SPARK" || type==="WAVE"){
            confetti({particleCount: 45, spread: 45, startVelocity: 30, decay:0.9, colors:['#FBBF24', '#FFFFFF'], origin: {x,y}});
          }
          else if(type==="MONEY"){
            confetti({particleCount: 50, spread: 60, startVelocity: 25, gravity:0.8, shapes:['square'], colors:['#34D399'], origin: {x:0.5,y:0.2}});
          }
          else if(type==="CRASH"){
            confetti({particleCount: 40, spread: 100, startVelocity: 20, gravity:1.8, colors:['#000000', '#FB7185'], origin: {x:0.5,y:0.2}});
          }
        }
      };

      return battle;
    }

    function renderBuffChips(f, el){
      el.innerHTML = "";
      const mods = computeMods(f);
      // show a tiny derived view; but keep chips for active buffs
      for(const b of f.buffs){
        const chip = document.createElement("div");
        chip.className = "tag";
        chip.textContent = `${b.name}×${b.turns}`;
        el.appendChild(chip);
      }
      // show hidden baseline? no.
    }

    function renderBattleUI(){
      const b = state.battle;
      if(!b) return;

      const P = b.P, C = b.C;

      $("battleSubtitle").textContent = `${b.nameOf(P)} vs ${b.nameOf(C)} • TURN ${b.turn}`;
      $("turnTag").textContent = b.paused ? "PAUSED" : (b.auto ? "AUTO" : "MANUAL");

      // Simple Names
      $("namePlayer").textContent = b.nameOf(P);
      $("nameCPU").textContent = b.nameOf(C);

      // Logos - Check emptiness to avoid flickering reload
      if(!$(`logoWrapPlayer`).hasChildNodes()) makeLogo($(`logoWrapPlayer`), P.company);
      if(!$(`logoWrapCPU`).hasChildNodes()) makeLogo($(`logoWrapCPU`), C.company);

      // HP Bars
      const pHpPct = clamp((P.hp / P.maxHP) * 100, 0, 100);
      const cHpPct = clamp((C.hp / C.maxHP) * 100, 0, 100);
      $("hpBarPlayer").style.width = `${pHpPct}%`;
      $("hpBarCPU").style.width = `${cHpPct}%`;

      $("hpTextPlayer").textContent = `${P.hp}/${P.maxHP}`;
      $("hpTextCPU").textContent = `${C.hp}/${C.maxHP}`;
      
      // Danger colors logic
      const dangerCol = "linear-gradient(90deg, #FB7185, #F59E0B)";
      const okColP = "linear-gradient(90deg, #06B6D4, #3B82F6)";
      const okColC = "linear-gradient(90deg, #F43F5E, #F59E0B)";
      
      $("hpBarPlayer").style.background = pHpPct < 25 ? dangerCol : okColP;
      $("hpBarCPU").style.background = cHpPct < 25 ? dangerCol : okColC;

      // Skill Bars
      const pSkPct = clamp((P.skill / P.skillMax) * 100, 0, 100);
      const cSkPct = clamp((C.skill / C.skillMax) * 100, 0, 100);
      
      // Player HUD
      $("skBarPlayer").style.width = `${pSkPct}%`;
      $("skTextPlayer").textContent = `${Math.floor(pSkPct)}%`;
      
      // CPU HUD (Simplified)
      $("skTextCPU").textContent = `${Math.floor(cSkPct)}`;

      // Stats
      $("statAtkP").textContent = P.atk;
      $("statDefP").textContent = P.def;
      $("statSpdP").textContent = P.spd;
      $("statSpdC").textContent = C.spd;

      renderBuffChips(P, $("buffsPlayer"));
      renderBuffChips(C, $("buffsCPU"));

      // Commands
      const canAct = !b.finished && !b.paused && !b.auto;
      $("cmdAttack").disabled = !canAct;
      $("cmdGuard").disabled = !canAct;
      $("cmdPivot").disabled = !canAct;
      $("cmdSkill").disabled = !canAct || (P.skill < 60);
      $("cmdSkill").classList.toggle("opacity-50", P.skill < 60);
    }

    function renderLog(){
      const box = $("logBox");
      const b = state.battle;
      if(!b) return;
      box.innerHTML = "";
      const frag = document.createDocumentFragment();
      const logs = b.logs.slice(-120); // keep last
      for(const L of logs){
        const row = document.createElement("div");
        row.className = "panel2 rounded-2xl p-3 text-sm leading-relaxed";
        row.innerHTML = `<div class="mono text-[10px] text-slate-300/70">${new Date(L.t).toLocaleTimeString()}</div>
                         <div class="text-slate-100/90">${L.html}</div>`;
        frag.appendChild(row);
      }
      box.appendChild(frag);
            box.scrollTop = box.scrollHeight;
    }

    function showBattleToast(html){
      const anchor = $("battleToastAnchor");
      if(!anchor) return;
      const el = document.createElement("div");
      el.className = "battle-toast";
      el.innerHTML = html;
      anchor.appendChild(el);
      // Keep only recent toasts
      if(anchor.children.length > 3) anchor.removeChild(anchor.firstChild);
      
      setTimeout(()=>{
        el.style.animation = "toast-out 0.4s ease-in forwards";
        setTimeout(()=>el.remove(), 400);
      }, 3500);
    }

    function cpuChooseAction(b){
      const cpu = b.C;
      const pl = b.P;

      const cpuHpPct = cpu.hp / cpu.maxHP;
      const plHpPct = pl.hp / pl.maxHP;

      const cpuMods = computeMods(cpu);
      const plMods = computeMods(pl);

      // Heuristics
      const canSkill = cpu.skill >= 60;
      const wantGuard = cpuHpPct < 0.35 || (cpuHpPct < 0.5 && pl.skill >= 70);
      const wantSkill = canSkill && (plHpPct < 0.55 || cpuHpPct < 0.55);
      const wantPivot = cpuHpPct >= 0.45 && (cpuMods.atkM < 1.12) && (Math.random() < 0.40);

      // If under DOT or debuffs, sometimes pivot
      const underPressure = cpu.buffs.some(x=>x.key==="bleed" || x.key==="def_down" || x.key==="spd_down");
      if(underPressure && Math.random() < 0.30) return "Pivot";

      if(wantSkill && Math.random() < 0.75) return "Skill";
      if(wantGuard && Math.random() < 0.70) return "Guard";
      if(wantPivot) return "Pivot";

      // default attack with a little randomness
      return (Math.random() < 0.12 && canSkill) ? "Skill" : "Attack";
    }

        async function runTurn(playerAction){
      const b = state.battle;
      if(!b || b.finished || b.paused) return;

      const P = b.P, C = b.C;

      // --- MARKET EVENT (Random Occurrence) ---
      if(b.turn > 1 && !b.finished && Math.random() < 0.25){
        const evt = pick(MARKET_EVENTS);
        const effectText = evt.func(b);
        const color = evt.type==="good" ? "text-emerald-300" : "text-rose-300";
        b.log(`<span class="tag">NEWS</span> <span class="${color}">${evt.name}</span>: ${evt.text}<br/><span class="text-xs text-slate-300/60">➥ ${effectText}</span>`);
        renderBattleUI();
        await sleep(600);
      }

      // apply dots at start of turn
      applyDot(b);

      // if someone died by DOT
      if(P.hp<=0 || C.hp<=0){
        return finishBattle();
      }

      // auto-gain gauge each turn
      b.gainSkill(P, P.gaugeGain);
      b.gainSkill(C, C.gaugeGain);

      // Decide order: SPD + small randomness
      const mP = computeMods(P), mC = computeMods(C);
      const spP = P.spd * mP.spdM + rnd(-6, 6);
      const spC = C.spd * mC.spdM + rnd(-6, 6);

      const first = spP >= spC ? "P" : "C";
      const second = first==="P" ? "C" : "P";

      const cpuAction = cpuChooseAction(b);

      b.log(`<span class="mono text-slate-300/75">TURN ${b.turn}</span> • 先手: <b>${first==="P" ? b.nameOf(P) : b.nameOf(C)}</b>`);

      // execute two actions
      const actMap = {P: playerAction, C: cpuAction};

            async function exec(side){
        if(b.finished) return;
        const user = side==="P" ? P : C;
        const enemy = side==="P" ? C : P;
        const action = actMap[side];

                // Check Stun
        const isStunned = user.buffs.some(x=>x.key==="stun");
        if(isStunned){
          b.log(`${b.nameOf(user)} は<span class="text-rose-300 font-bold">営業停止中</span>で動けない！`);
          await sleep(800);
          return;
        }

        // apply action
        await performAction(b, user, enemy, action, side);
        renderBattleUI();
        await sleep(900);

        if(enemy.hp<=0 || user.hp<=0){
          finishBattle();
        }
      }

      await exec(first);
      await exec(second);

      // tick buffs at end of turn
      if(!b.finished){
        tickBuffs(P);
        tickBuffs(C);
        b.turn += 1;
        renderBattleUI();
      }
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function performAction(b, user, enemy, action, side){
      const userName = b.nameOf(user);
      const enemyName = b.nameOf(enemy);

            // --- ANIMATION SEQUENCE ---
      const spriteUser = side==="P" ? $("spritePlayer") : $("spriteCPU");
      const spriteEnemy = side==="P" ? $("spriteCPU") : $("spritePlayer");
      
      if(action==="Skill"){
        // Special Motion
        const motion = user.company.motion || "m-smash";
        spriteUser.style.animationName = motion;
        spriteUser.classList.add("skill-anim");
        
        // Wait for impact point (approx 50-60% of 1.8s)
        await sleep(1000);
        
        spriteUser.style.animationName = "";
        spriteUser.classList.remove("skill-anim");
      }
      else if(action==="Attack" || action==="Pivot"){
        // Standard Attack
        spriteUser.classList.add("atk-anim");
        await sleep(500);
        spriteUser.classList.remove("atk-anim");
      }
      else if(action==="Guard"){
        // Guard Shield
        spriteUser.classList.add("guard-anim");
        setTimeout(()=>spriteUser.classList.remove("guard-anim"), 600);
      }

      const sector = user.company.sector;
      const skillDef = SECTOR_SKILLS[sector] || SECTOR_SKILLS.Tech;
      
      // Helper to trigger hit anim
      const hitEnemy = () => {
         spriteEnemy.classList.add("dmg-anim");
         setTimeout(()=>spriteEnemy.classList.remove("dmg-anim"), 450);
      };

            if(action==="Attack"){
        const {dmg, isCrit} = damageFormula(user, enemy, {});
        hitEnemy(); // VISUAL
        b.damage(enemy, dmg, {fx:"IMPACT"});

        // Determine attack name/desc
        let atkName = "市場攻勢";
        let atkDesc = "";
        const c = user.company;
        if(c.attacks && Array.isArray(c.attacks) && c.attacks.length > 0){
            const a = pick(c.attacks);
            atkName = a.name;
            atkDesc = a.desc;
        }

        let msg = `${userName} の <b>${atkName}</b>！`;
        if(atkDesc) msg += ` <span class="text-[10px] text-slate-300/60">(${atkDesc})</span>`;
        if(isCrit) msg = `<span class="text-violet-300 mono font-black">CRIT</span> ` + msg;
        msg += `<br/><span class="text-rose-300 font-bold text-lg">-${dmg}</span>`;

        b.log(msg);
        if(isCrit) b.fx(side, "NEON");
      }
      else if(action==="Guard"){
        // add guard buff + slight skill gain
        b.addBuff(user, {key:"guard", name:"GUARD", turns:1, meta:{dr:0.45, def:0.12}});
        b.gainSkill(user, 10);
        b.log(`${userName} が財務固め！ <span class="text-emerald-300">被ダメ軽減</span> &amp; <span class="text-sky-300">DEF↑</span>`);
        b.fx(side, "AURA");
      }
      else if(action==="Pivot"){
        // Pivot: shift stance - atk/spd up, def slightly down; also gain skill
        b.addBuff(user, {key:"pivot", name:"PIVOT", turns:3, meta:{atk:0.18, spd:0.16, def:-0.08}});
        b.gainSkill(user, 14);
        b.log(`${userName} が事業転換！ <span class="text-sky-300">ATK↑ SPD↑</span>（短期）`);
        b.fx(side, "GLITCH");
      }
      else       if(action==="Skill"){
        const cost = 60;
        if(user.skill < cost){
          // fallback attack
          const {dmg} = damageFormula(user, enemy, {});
          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx:"IMPACT"});
          b.log(`${userName} は資源不足…代わりに攻勢！ <span class="text-rose-300">-${dmg}</span>`);
          return;
        }
        b.spendSkill(user, cost);

        // CHECK COMBO SKILL FIRST
        const comboKey = `${user.company.sector}_${enemy.company.sector}`;
        const combo = COMBO_SKILLS[comboKey];

        if(combo){
          // Combo Execution
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: combo.mult, pierce: 0.1});
          let extraMsg = "";
          
          // Drain
          if(combo.drain){
             const absorb = Math.round(dmg * combo.drain);
             b.heal(user, absorb, "DRAIN");
             extraMsg += ` / 吸収+${absorb}`;
          }
          // Gauge Gain
          if(combo.gauge) b.gainSkill(user, combo.gauge);
          // Gauge Drain
          if(combo.gaugeEnemy) b.gainSkill(enemy, combo.gaugeEnemy);
          // Buff/Debuff
          if(combo.buff) b.addBuff(user, {key:combo.buff.key, name:"COMBO+", turns:3, meta:{[combo.buff.key.replace("_up","")]: combo.buff.val}});
          if(combo.debuff) b.addBuff(enemy, {key:combo.debuff.key, name:"COMBO-", turns:3, meta:{[combo.debuff.key.replace("_down","")]: combo.debuff.val}});

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: combo.fx || "NEON"});
          b.log(`${userName} の<span class="text-amber-300 font-bold">業界コンボ技</span>！ <b>${combo.name}</b>！<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${combo.desc}${extraMsg})</span>`);
          b.fx(side, combo.fx || "NEON");

        } else {
          // --- COMPANY UNIQUE SKILL ---
          // Load skill data from company object, fallback to archetype default
          const sType = user.company.skill_type || "BURST";
          const arch = SKILL_ARCHETYPES[sType] || SKILL_ARCHETYPES["BURST"];
          const sName = user.company.skill_name || "Corporate Strike";
          const sDesc = user.company.skill_desc || arch.desc;

          // Execute Logic based on Archetype
          const {dmg, isCrit} = damageFormula(user, enemy, {mult: arch.mult, pierce: arch.pierce||0});
          let extra = "";

          if(arch.drain){
            const healAmt = Math.floor(dmg * arch.drain);
            b.heal(user, healAmt, "DRAIN");
            extra = " / 吸収";
          }
          if(arch.buff){
            b.addBuff(user, {key:arch.buff.key, name:"SKILL+", turns:3, meta:{[arch.buff.key.replace("_up","")]: arch.buff.val}});
            extra = " / 強化";
          }
          if(arch.debuff){
            b.addBuff(enemy, {key:arch.debuff.key, name:"SKILL-", turns:3, meta:{[arch.debuff.key.replace("_down","")]: arch.debuff.val}});
            extra = " / 弱体化";
          }

          hitEnemy(); // VISUAL
          b.damage(enemy, dmg, {fx: arch.fx});
          b.log(`${userName} の必殺技！ <b>${sName}</b>！<br/><span class="text-rose-300 font-black text-lg">-${dmg}</span> <span class="text-slate-300/70 mono">(${sDesc})</span>`);
          b.fx(side, arch.fx);
        }
      }

      // immediate finish check
      if(enemy.hp<=0 || user.hp<=0){
        // handled in caller
      }
    }

        async function finishBattle(){
      const b = state.battle;
      if(!b || b.finished) return;
      b.finished = true;
      const P = b.P, C = b.C;
      b.winner = (P.hp > C.hp) ? "P" : (C.hp > P.hp) ? "C" : "DRAW";
      if(b.winner==="P"){
        b.log(`<span class="mono font-black text-emerald-300">VICTORY</span> — ${b.nameOf(P)} が市場を制圧！`);
        confetti({particleCount: 160, spread: 70, startVelocity: 42, scalar: 0.95, origin:{x:0.28, y:0.35}});
      } else if(b.winner==="C"){
        b.log(`<span class="mono font-black text-rose-300">DEFEAT</span> — ${b.nameOf(C)} が主導権を掌握…`);
        confetti({particleCount: 120, spread: 55, startVelocity: 32, scalar: 0.9, origin:{x:0.72, y:0.35}});
      } else {
        b.log(`<span class="mono font-black text-amber-300">DRAW</span> — 市場は膠着。`);
      }
      renderBattleUI();
      await sleep(2200);
      buildResult();
      showScreen(Screens.Result);
    }

    /********************
     * RESULT EXPLAINER
     ********************/
    function buildResult(){
      const b = state.battle;
      if(!b) return;
      const P = b.P, C = b.C;

      const win = b.winner;
      const winner = win==="P" ? P : win==="C" ? C : null;
      const loser  = win==="P" ? C : win==="C" ? P : null;

      $("resultTitle").textContent = win==="DRAW"
        ? `DRAW — ${b.nameOf(P)} vs ${b.nameOf(C)}`
        : `${win==="P" ? "YOU WIN" : "YOU LOSE"} — ${b.nameOf(P)} vs ${b.nameOf(C)}`;

      // snapshot
      const snap = $("resultSnapshot");
      snap.innerHTML = "";
      const rows = [
        {k:"HP (Cash)", p:`${P.maxHP}→${P.hp}`, c:`${C.maxHP}→${C.hp}`},
        {k:"ATK (OM)", p:`${P.atk}`, c:`${C.atk}`},
        {k:"DEF (Equity)", p:`${P.def}`, c:`${C.def}`},
        {k:"SPD (Scale)", p:`${P.spd}`, c:`${C.spd}`},
        {k:"R&D Gauge", p:`${P.gaugeGain}/turn`, c:`${C.gaugeGain}/turn`},
      ];
      for(const r of rows){
        const card = document.createElement("div");
        card.className = "panel2 rounded-2xl p-3";
        card.innerHTML = `
          <div class="mono text-[10px] text-slate-300/75">${r.k}</div>
          <div class="mt-1 grid grid-cols-2 gap-2">
            <div class="mono text-sm"><span class="text-sky-300">YOU</span> ${r.p}</div>
            <div class="mono text-sm text-right"><span class="text-violet-300">CPU</span> ${r.c}</div>
          </div>
        `;
        snap.appendChild(card);
      }

      // explainer
      const exp = $("resultExplainer");
      if(win==="DRAW"){
        exp.innerHTML = `
          <div class="text-base font-bold glowText">拮抗（DRAW）</div>
          <div class="mt-2">
            両社の<strong>Cash(HP)</strong>と<strong>Operating Margin(ATK)</strong>が近いレンジに収まり、決定打が出にくい展開でした。<br/>
            次は <span class="kbd">Skill</span> のタイミング（R&amp;Dゲージ）を先読みして、<strong>Guard→Skill</strong> の流れを作ると勝ちやすくなります。
          </div>
        `;
        return;
      }

      // Key causes (finance perspective)
      const causes = [];
      const dAtk = (winner.atk - loser.atk);
      const dDef = (winner.def - loser.def);
      const dHp  = (winner.maxHP - loser.maxHP);
      const dSk  = (winner.gaugeGain - loser.gaugeGain);
      const dSpd = (winner.spd - loser.spd);

      // choose top 3 by impact heuristic
      const impact = [
        {k:"ATK", v: Math.abs(dAtk), text: dAtk>=0
          ? `営業利益率が高く、攻勢（ATK）が優位。ダメージ期待値が積み上がりました。`
          : `営業利益率で劣り、通常攻撃で押し切れない局面が多発。`},
        {k:"DEF", v: Math.abs(dDef), text: dDef>=0
          ? `自己資本比率が高く、守り（DEF）が硬い。Guardとの相性も良く、被弾を抑制。`
          : `自己資本比率で劣り、Guardしても焼け石に水になりがち。`},
        {k:"HP", v: Math.abs(dHp), text: dHp>=0
          ? `現預金（Cash）が厚く、HPが高い。長期戦で優位。`
          : `現預金（Cash）が薄く、事故（CRIT/Skill）で崩れやすい。`},
        {k:"SKILL", v: Math.abs(dSk), text: dSk>=0
          ? `R&amp;Dが厚くゲージ回収が速い。Skill回数で主導権を握りました。`
          : `R&amp;Dが薄くゲージが溜まりにくい。Skill差がじわじわ響きました。`},
        {k:"SPD", v: Math.abs(dSpd), text: dSpd>=0
          ? `規模（SPD）が上で先手を取りやすい。クリティカル率にも寄与。`
          : `規模（SPD）で劣り、先手を取られて展開が後手になりやすい。`},
      ].sort((a,b)=>b.v-a.v).slice(0,3);

      for(const it of impact){
        causes.push(`<li class="mt-1">${it.text}</li>`);
      }

      const winnerName = b.nameOf(winner);
      const loserName = b.nameOf(loser);

      const sectorSkill = winner.company.skill_name || "Skill";
      const sectorLabel = winner.company.sector;

      exp.innerHTML = `
        <div class="text-base font-bold glowText">${winnerName} の勝因（財務×戦略）</div>
        <div class="mt-2">
          このバトルでは、<strong>${winnerName}</strong> が <span class="tag">${sectorLabel}</span> の特性を活かし、
          <strong>${sectorSkill}</strong> を軸に優位を作りました。
        </div>
        <div class="mt-3 panel2 rounded-2xl p-3">
          <div class="mono text-xs text-slate-300/75 mb-2">TOP CAUSES</div>
          <ul class="list-disc pl-5">
            ${causes.join("")}
          </ul>
        </div>
        <div class="mt-3">
          <span class="mono text-slate-300/75">次の改善案：</span><br/>
          ${win==="P"
            ? `勝った側は <strong>Guardで事故を回避 → Skillで決める</strong> を徹底すると安定します。`
            : `負けた側は <strong>序盤Guardで耐えてゲージを貯め、Skill回数を増やす</strong> と逆転しやすいです。`
          }
        </div>
      `;
    }

    /********************
     * START / INSPECT
     ********************/
    function buildIntel(c){
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      const sName = c.skill_name || "Unknown";
      $("intelTag").textContent = "INTEL";
      $("intelBox").innerHTML = `
        <div class="flex items-center gap-3">
          <div class="logoWrap" style="width:72px;height:72px" id="intelLogo"></div>
          <div class="min-w-0">
            <div class="font-black text-lg glowText truncate">${c.name_jp || c.name}</div>
            <div class="mono text-xs text-slate-300/75">${c.name} • ${c.sector}</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div class="panel2 rounded-xl p-2">
            <div class="mono text-[10px] text-slate-300/75">FIN: CASH</div>
            <div class="mono font-black text-lg">¥${fmt(c.cash,0)}B</div>
          </div>
          <div class="panel2 rounded-xl p-2">
            <div class="mono text-[10px] text-slate-300/75">FIN: R&amp;D</div>
            <div class="mono font-black text-lg">¥${fmt(c.rnd,0)}B</div>
          </div>
          <div class="panel2 rounded-xl p-2">
            <div class="mono text-[10px] text-slate-300/75">OM</div>
            <div class="mono font-black text-lg">${fmt(c.operating_margin,1)}%</div>
          </div>
          <div class="panel2 rounded-xl p-2">
            <div class="mono text-[10px] text-slate-300/75">EQUITY</div>
            <div class="mono font-black text-lg">${fmt(c.equity_ratio,1)}%</div>
          </div>
        </div>

        <div class="mt-3 panel2 rounded-2xl p-3">
          <div class="mono text-xs text-slate-300/75 mb-2">BATTLE STATS</div>
          <div class="grid grid-cols-3 gap-2 text-sm">
            <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">HP</div><div class="mono font-black text-lg">${st.hp}</div></div>
            <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">ATK</div><div class="mono font-black text-lg">${st.atk}</div></div>
            <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">DEF</div><div class="mono font-black text-lg">${st.def}</div></div>
            <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">SPD</div><div class="mono font-black text-lg">${st.spd}</div></div>
            <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">GAUGE</div><div class="mono font-black text-lg">+${st.gaugeGain}</div></div>
            <div class="panel2 rounded-xl p-2 col-span-3 mt-1 bg-slate-800/50"><div class="mono text-[10px] text-slate-300/75">UNIQUE SKILL</div><div class="mono font-bold text-base text-sky-200">${c.skill_name || sName}</div><div class="text-[10px] text-slate-400 truncate">${c.skill_desc || "-"}</div></div>
          </div>
        </div>
      `;
      makeLogo($("intelLogo"), c);
    }

    function modalShow(title, tag, html){
      $("modalTitle").textContent = title;
      $("modalTag").textContent = tag;
      $("modalBody").innerHTML = html;
      $("modal").classList.remove("hidden");
      $("modal").classList.add("flex");
    }
    function modalHide(){
      $("modal").classList.add("hidden");
      $("modal").classList.remove("flex");
    }

    function openInspectModal(c){
      const scaler = buildScaler(state.companies);
      const st = deriveStats(c, scaler);
      const sName = c.skill_name || "Unknown";
      const sDesc = c.skill_desc || "-";
      const sType = c.skill_type || "BURST";
      const html = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="panel2 rounded-2xl p-4">
            <div class="flex items-center gap-3">
              <div class="logoWrap" style="width:84px;height:84px" id="mLogo"></div>
              <div class="min-w-0">
                <div class="font-black text-xl glowText truncate">${c.name_jp || c.name}</div>
                <div class="mono text-xs text-slate-300/75">${c.name} • ${c.domain}</div>
                <div class="mt-1"><span class="tag">${c.sector}</span></div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">CASH (B JPY)</div><div class="mono font-black text-lg">¥${fmt(c.cash,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">R&amp;D (B JPY)</div><div class="mono font-black text-lg">¥${fmt(c.rnd,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">OP MARGIN</div><div class="mono font-black text-lg">${fmt(c.operating_margin,1)}%</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">EQUITY</div><div class="mono font-black text-lg">${fmt(c.equity_ratio,1)}%</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">MKT CAP (B JPY)</div><div class="mono font-black text-lg">¥${fmt(c.market_cap,0)}B</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">EMPLOYEES</div><div class="mono font-black text-lg">${fmt(c.employees,0)}</div></div>
            </div>
          </div>

          <div class="panel2 rounded-2xl p-4">
            <div class="mono text-sm text-slate-200/90">GAME STATS</div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">HP</div><div class="mono font-black text-lg">${st.hp}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">ATK</div><div class="mono font-black text-lg">${st.atk}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">DEF</div><div class="mono font-black text-lg">${st.def}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">SPD</div><div class="mono font-black text-lg">${st.spd}</div></div>
              <div class="panel2 rounded-xl p-2"><div class="mono text-[10px] text-slate-300/75">GAUGE</div><div class="mono font-black text-lg">+${st.gaugeGain}</div></div>
              <div class="panel2 rounded-xl p-2 col-span-3 mt-1 bg-slate-800/50"><div class="mono text-[10px] text-slate-300/75">UNIQUE SKILL</div><div class="mono font-bold text-base text-sky-200">${c.skill_name || sName}</div><div class="text-[10px] text-slate-400 truncate">${c.skill_desc || "-"}</div></div>
          </div>

                        <div class="mt-3 panel2 rounded-2xl p-3 text-sm text-slate-200/85 leading-relaxed">
              <div class="mono text-xs text-slate-300/75 mb-1">SKILL PROFILE</div>
              <b>${sName}</b>：${sDesc}
              <div class="mt-2 text-xs text-slate-300/70 mono">
                ※Cash/MarketCap/R&amp;Dは対数圧縮してHP/SPD/ゲージ速度に反映しています（極端な差を抑えるため）。
              </div>
            </div>
          </div>
        </div>
      `;
      modalShow("CORPORATE INTEL", "INSPECT", html);
      setTimeout(()=>makeLogo($("mLogo"), c), 0);
    }

    /********************
     * TOURNAMENT
     ********************/
    function tournamentCreate(){
      const pool = [...state.companies];
      if(pool.length < 8){
        toast("企業が8社未満です。AI FORGEで追加してください。", "bad");
        return null;
      }
      // pick 8 unique
      const s = seededRand(Date.now() ^ (pool.length<<8));
      pool.sort(()=>s()-0.5);
      const eight = pool.slice(0,8).map(c=>c.id);

      // bracket: qf (4), sf (2), f(1)
      const t = {
        ids: eight,
        qf: [
          {a:eight[0], b:eight[1], w:null},
          {a:eight[2], b:eight[3], w:null},
          {a:eight[4], b:eight[5], w:null},
          {a:eight[6], b:eight[7], w:null},
        ],
        sf: [
          {a:null, b:null, w:null},
          {a:null, b:null, w:null},
        ],
        f: [{a:null, b:null, w:null}],
        champion: null,
        log: []
      };
      return t;
    }

    function bracketHtmlMatch(m, label){
      const a = m.a ? (getCompany(m.a)?.name_jp || getCompany(m.a)?.name) : "—";
      const b = m.b ? (getCompany(m.b)?.name_jp || getCompany(m.b)?.name) : "—";
      const w = m.w ? (getCompany(m.w)?.name_jp || getCompany(m.w)?.name) : null;

      return `
        <div class="panel2 rounded-2xl p-3">
          <div class="mono text-[10px] text-slate-300/75">${label}</div>
          <div class="mt-2 grid grid-cols-[1fr_auto_1fr] items-center gap-2">
            <div class="mono text-sm ${w===m.a ? 'text-emerald-300 font-black':''} truncate">${a}</div>
            <div class="mono text-xs text-slate-300/80">vs</div>
            <div class="mono text-sm text-right ${w===m.b ? 'text-emerald-300 font-black':''} truncate">${b}</div>
          </div>
          <div class="mt-2 mono text-xs text-slate-300/70">${w ? `WINNER: <span class="text-emerald-300">${w}</span>` : `PENDING`}</div>
        </div>
      `;
    }

    function renderTournament(){
      const t = state.tournament;
      if(!t){ $("bracketBox").innerHTML = ""; return; }

      // feed forward
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;

      t.f[0].a = t.sf[0].w;
      t.f[0].b = t.sf[1].w;

      t.champion = t.f[0].w;

      const box = $("bracketBox");
      box.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Quarterfinals</div>
            ${t.qf.map((m,i)=>bracketHtmlMatch(m, `QF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Semifinals</div>
            ${t.sf.map((m,i)=>bracketHtmlMatch(m, `SF${i+1}`)).join("")}
          </div>
          <div class="space-y-3">
            <div class="mono text-sm text-slate-200/90">Final</div>
            ${bracketHtmlMatch(t.f[0], "FINAL")}
            <div class="panel2 rounded-2xl p-3">
              <div class="mono text-[10px] text-slate-300/75">CHAMPION</div>
              <div class="mt-2 font-black text-xl glowText">${t.champion ? (getCompany(t.champion)?.name_jp || getCompany(t.champion)?.name) : "—"}</div>
              <div class="mono text-xs text-slate-300/70 mt-1">${t.champion ? "市場の覇者が確定。" : "まだ未確定。"}</div>
            </div>
          </div>
        </div>
      `;

      // tournament log
      $("tLog").innerHTML = t.log.slice(-80).map(x=>`
        <div class="panel2 rounded-2xl p-3 text-sm">
          <div class="mono text-[10px] text-slate-300/70">${x.time}</div>
          <div class="text-slate-100/90">${x.msg}</div>
        </div>
      `).join("");
      $("tLog").scrollTop = $("tLog").scrollHeight;
    }

    function tlog(msg){
      const t = state.tournament;
      if(!t) return;
      t.log.push({time:new Date().toLocaleTimeString(), msg});
      renderTournament();
    }

    function getNextMatch(){
      const t = state.tournament;
      if(!t) return null;

      // QF pending
      for(const m of t.qf){
        if(!m.w) return {round:"qf", m};
      }
      // SF pending if both sides ready
      for(const m of t.sf){
        if(!m.w && m.a && m.b) return {round:"sf", m};
      }
      // Final
      if(!t.f[0].w && t.f[0].a && t.f[0].b) return {round:"f", m:t.f[0]};
      return null;
    }

    function simulateMatch(aId, bId){
      // quick simulation using derived stats and random
      const scaler = buildScaler(state.companies);
      const A = makeFighter(getCompany(aId), scaler);
      const B = makeFighter(getCompany(bId), scaler);

      // simulate up to 30 turns
      for(let t=1;t<=30;t++){
        // dot-like but simplified
        A.skill = clamp(A.skill + A.gaugeGain, 0, 100);
        B.skill = clamp(B.skill + B.gaugeGain, 0, 100);

        const order = (A.spd + rnd(-5,5) >= B.spd + rnd(-5,5)) ? [A,B] : [B,A];
        for(const u of order){
          const e = (u===A)?B:A;
          if(e.hp<=0 || u.hp<=0) break;

          // choose action
          const hpPct = u.hp/u.maxHP;
          let act = "Attack";
          if(u.skill>=60 && (e.hp/e.maxHP<0.6 || hpPct<0.6) && Math.random()<0.7) act="Skill";
          else if(hpPct<0.35 && Math.random()<0.7) act="Guard";
          else if(Math.random()<0.18) act="Pivot";

          if(act==="Guard"){
            addBuff(u,{key:"guard",name:"GUARD",turns:1,meta:{dr:0.45,def:0.12}});
            u.skill = clamp(u.skill+10,0,100);
          } else if(act==="Pivot"){
            addBuff(u,{key:"pivot",name:"PIVOT",turns:3,meta:{atk:0.18, spd:0.16, def:-0.08}});
            u.skill = clamp(u.skill+14,0,100);
          } else if(act==="Skill"){
            u.skill -= 60;
            const {dmg} = damageFormula(u,e,{mult:1.45,pierce:0.05});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          } else {
            const {dmg} = damageFormula(u,e,{});
            e.hp = clamp(e.hp - dmg, 0, e.maxHP);
          }

          // tick at end of each action? keep simple
          tickBuffs(u); tickBuffs(e);
        }
        if(A.hp<=0 || B.hp<=0) break;
      }
      if(A.hp===B.hp) return (Math.random()<0.5)?aId:bId;
      return (A.hp > B.hp) ? aId : bId;
    }

    async function playNextMatchInteractive(){
      const next = getNextMatch();
      if(!next){
        toast("次の試合はありません（終了）。", "good");
        return;
      }
      const {m} = next;
      if(!m.a || !m.b){
        toast("対戦カードが揃っていません。", "bad");
        return;
      }

      // Start interactive battle: player controls left side automatically? In tournament, we let AUTO run as spectator.
      const A = getCompany(m.a);
      const B = getCompany(m.b);

      // Set battle with A as "player" side but auto
      state.playerId = A.id;
      state.cpuId = B.id;
      startBattle({auto:true, tournamentCtx: {match: m, round: next.round}});
    }

    async function autoSimTournament(){
      const t = state.tournament;
      if(!t) return;

      // QF
      for(const m of t.qf){
        if(!m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`QF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> → <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // SF
      t.sf[0].a = t.qf[0].w; t.sf[0].b = t.qf[1].w;
      t.sf[1].a = t.qf[2].w; t.sf[1].b = t.qf[3].w;
      for(const m of t.sf){
        if(m.a && m.b && !m.w){
          m.w = simulateMatch(m.a, m.b);
          tlog(`SF: <b>${getCompany(m.a).name_jp || getCompany(m.a).name}</b> vs <b>${getCompany(m.b).name_jp || getCompany(m.b).name}</b> → <span class="text-emerald-300">WIN: ${getCompany(m.w).name_jp || getCompany(m.w).name}</span>`);
        }
      }
      renderTournament();

      // Final
      t.f[0].a = t.sf[0].w; t.f[0].b = t.sf[1].w;
      if(t.f[0].a && t.f[0].b && !t.f[0].w){
        t.f[0].w = simulateMatch(t.f[0].a, t.f[0].b);
        tlog(`FINAL: <b>${getCompany(t.f[0].a).name_jp || getCompany(t.f[0].a).name}</b> vs <b>${getCompany(t.f[0].b).name_jp || getCompany(t.f[0].b).name}</b> → <span class="text-emerald-300">CHAMPION: ${getCompany(t.f[0].w).name_jp || getCompany(t.f[0].w).name}</span>`);
        confetti({particleCount: 220, spread: 80, startVelocity: 44, scalar: 1.0, origin:{x:0.5, y:0.32}});
      }
      renderTournament();
    }

    /********************
     * LAB (AI FORGE)
     ********************/
    function renderSectorChoices(){
      const box = $("sectorChoices");
      box.innerHTML = "";
      for(const s of SECTORS){
        const b = document.createElement("button");
        b.className = "tag";
        b.textContent = s.key;
        b.dataset.key = s.key;
        b.dataset.on = "1";
        b.style.cursor = "pointer";
        b.onclick = ()=>{
          const on = b.dataset.on === "1";
          b.dataset.on = on ? "0" : "1";
          b.style.borderColor = on ? "rgba(148,163,184,.20)" : "rgba(53,247,255,.35)";
          b.style.background = on ? "rgba(148,163,184,.06)" : "rgba(53,247,255,.08)";
          b.style.color = on ? "rgba(214,226,255,.86)" : "#CFFBFF";
        };
        // default: on
        b.style.borderColor = "rgba(53,247,255,.35)";
        b.style.background = "rgba(53,247,255,.08)";
        b.style.color = "#CFFBFF";
        box.appendChild(b);
      }
    }

    function selectedSectors(){
      return [...$("sectorChoices").querySelectorAll("button")].filter(b=>b.dataset.on==="1").map(b=>b.dataset.key);
    }

            function generatePrompt(){
      const count = clamp(parseInt($("labCount").value||"5",10),1,50);
      const region = $("labRegion").value;
      const custom = $("labCustom").value.trim();
      const secs = selectedSectors();

            const fields = [
        `"name" (英語社名)`,
        `"name_jp" (日本語社名)`,
        `"domain" (企業ドメイン)`,
        `"sector" (以下から選択: ${SECTORS.map(s=>s.key).join(", ")})`,
        `"currency" (固定で "JPY" とする)`,
        `"cash" (現預金 billion JPY)`,
        `"operating_margin" (営業利益率 %)`,
        `"equity_ratio" (自己資本比率 %)`,
        `"market_cap" (時価総額 billion JPY)`,
        `"employees" (従業員数)`,
        `"rnd" (研究開発費 billion JPY)`,
        `"skill_name" (その企業の実際の製品・技術・経営用語を用いた、ファンがニヤリとする必殺技名)`,
        `"skill_desc" (その技がなぜ強いのか、企業の定性的な強みや歴史背景を絡めた解説)`,
        `"skill_type" (以下から選択: BURST, GUARD, SPEED, DRAIN, DOT, JAM, BUFF)`,
        `"attacks": [ {"name":"攻撃技名", "desc":"その攻撃のビジネス的背景"} ] (その企業の事業や特徴を表す通常攻撃を3パターン用意する)`
      ];

      const sectorClause = secs.length ? `業種は可能なら次から優先して選ぶ: ${secs.join(", ")}` : "業種はバランスよく選ぶ";
      const regionClause = region==="JP"
        ? "日本企業を中心に（できれば日経インデックス400級の実在企業から）"
        : region==="GLOBAL"
          ? "海外の実在企業を中心に"
          : "日本企業と海外企業を混ぜて";

      const customClause = custom ? `\n【追加指示】\n${custom}\n` : "";

      const prompt = `
あなたは財務データ作成のプロです。以下の仕様で、実在企業のサンプル財務データを作ってください。
${customClause}
【出力条件】
- 出力は「純粋なJSON配列のみ」（Markdown・コードフェンスは禁止）
- 企業数: ${count}社
- 対象: ${regionClause}
- ${sectorClause}
- それぞれのオブジェクトは以下フィールドを必ず含める:
  ${fields.map(f=>"  - "+f).join("\n")}

【重要：通貨と金額について】
- 対象がどの国の企業であっても（中国、米国、欧州など）、金額(cash, market_cap, rnd)は全て**「日本円（10億円単位/billion JPY）」に現在のレートで換算**して出力してください。
- currency は必ず "JPY" としてください。

【注意】
- domain は logo.clearbit.com でロゴ取得に使います。公式サイトに近いドメインを選んでください。
`.trim();

      return prompt;
    }

        function normalizeImportedCompany(x){
      // Accept flexible keys; ensure required.
      const name = (x.name || x.name_en || "").toString().trim();
      const name_jp = (x.name_jp || x.jp || x.nameJa || "").toString().trim();
      const domain = (x.domain || "").toString().trim().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
      const sector = (x.sector || "").toString().trim();

      function num(v, def=0){
        const n = Number(v);
        return isFinite(n) ? n : def;
      }

      let cash = num(x.cash);
      let market_cap = num(x.market_cap);
      let rndv = num(x.rnd);

      const obj = {
        id: x.id ? String(x.id) : `imp-${hashStr(name+"|"+domain+"|"+Date.now()).toString(16)}`,
        name: name || (domain ? domain.split(".")[0].toUpperCase() : "Company"),
        name_jp: name_jp || "",
        domain: domain || "example.com",
        sector: SECTORS.some(s=>s.key===sector) ? sector : "Tech",
        currency: "JPY",
        cash: Math.max(0, cash),
        operating_margin: clamp(num(x.operating_margin, 8), 0, 70),
        equity_ratio: clamp(num(x.equity_ratio, 30), 0, 95),
        market_cap: Math.max(0, market_cap),
        employees: Math.max(0, Math.round(num(x.employees, 10000))),
        rnd: Math.max(0, rndv),
                // Skill Import
        skill_name: (x.skill_name || "Corporate Impact").toString().trim(),
        skill_desc: (x.skill_desc || "Standard strategic move.").toString().trim(),
        skill_type: ["BURST","GUARD","SPEED","DRAIN","DOT","JAM","BUFF"].includes(x.skill_type) ? x.skill_type : "BURST",
        // Attacks Import
        attacks: Array.isArray(x.attacks) ? x.attacks.map(a=>({
            name: (a.name||"Attack").toString().trim(),
            desc: (a.desc||"").toString().trim()
        })).slice(0,3) : []
      };

      return obj;
    }

    async function importJson(){
      const text = $("labJson").value.trim();
      if(!text){
        toast("JSONを貼り付けてください。", "bad");
        return;
      }
      let arr;
      try{
        arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error("not array");
      }catch(e){
        toast("JSONの解析に失敗しました。配列になっていますか？", "bad");
        $("dbStatus").textContent = "JSON ERR";
        return;
      }

            const normalized = arr.map(x=>normalizeImportedCompany(x));

      // merge by id (put)
      await dbPutMany(STORE_COMP, normalized);
      await loadCompanies();
      $("dbStatus").textContent = "IMPORTED";
      toast(`IMPORT完了: ${normalized.length}社`, "good");
      $("labJson").value = "";
    }

    async function exportAll(){
      const arr = state.companies;
      const json = JSON.stringify(arr, null, 2);
      // show in modal for copy
      modalShow("EXPORT ALL", "JSON", `
        <div class="text-sm text-slate-200/85 mb-2">現在の企業プール（IndexedDB）をJSONで出力しました。</div>
        <textarea class="w-full rounded-2xl p-3 mono text-xs leading-relaxed" rows="14">${json.replace(/</g,"&lt;")}</textarea>
        <div class="mt-2 flex gap-2">
          <button class="btn2 px-3 py-2 rounded-xl text-sm flex items-center gap-2" id="btnCopyExport">
            <i data-lucide="copy" class="w-4 h-4"></i><span class="mono">COPY</span>
          </button>
        </div>
      `);
      lucide.createIcons();
      setTimeout(()=>{
        const btn = $("btnCopyExport");
        if(btn){
          btn.onclick = async ()=>{
            const ok = await copyToClipboard(json);
            toast(ok ? "コピーしました。" : "コピーに失敗しました。", ok?"good":"bad");
          };
        }
      },0);
    }

    /********************
     * LOAD / INIT
     ********************/
    async function seedIfEmpty(){
      const existing = await dbGetAll(STORE_COMP);
      if(existing.length === 0){
        await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);
      }
      // load settings
      const fx = await metaGet("fx");
      if(fx && typeof fx==="object"){
        state.fx = {...state.fx, ...fx};
      } else {
        await metaSet("fx", state.fx);
      }
    }

    async function loadCompanies(){
      const all = await dbGetAll(STORE_COMP);
      // stable sort by name
      all.sort((a,b)=> (a.name_jp||a.name).localeCompare((b.name_jp||b.name), "ja"));
      state.companies = all;
      $("dbCount").textContent = all.length;
      renderSelects();
      buildTicker();
    }

    function renderSelects(){
      const selP = $("selPlayer");
      const selC = $("selCPU");
      selP.innerHTML = "";
      selC.innerHTML = "";
      for(const c of state.companies){
        const opt1 = document.createElement("option");
        opt1.value = c.id;
        opt1.textContent = companyLabel(c);
        const opt2 = opt1.cloneNode(true);
        selP.appendChild(opt1);
        selC.appendChild(opt2);
      }

      // default picks
      if(!state.playerId || !getCompany(state.playerId)){
        state.playerId = state.companies[0]?.id || null;
      }
      if(!state.cpuId || !getCompany(state.cpuId)){
        state.cpuId = state.companies[1]?.id || state.companies[0]?.id || null;
      }
      selP.value = state.playerId;
      selC.value = state.cpuId;

      updateSectorTags();
      // refresh intel
      const c = getCompany(state.playerId);
      if(c) buildIntel(c);
    }

    function updateSectorTags(){
      const p = getCompany($("selPlayer").value);
      const c = getCompany($("selCPU").value);
      $("tagYourSector").textContent = p?.sector || "—";
      $("tagCpuSector").textContent = c?.sector || "—";
    }

    function buildTicker(){
      const msgs = [];
      const s = seededRand(Date.now());
      // Make a pseudo Bloomberg tape from pool
      const pool = [...state.companies];
      pool.sort(()=>s()-0.5);
      for(let i=0;i<Math.min(10,pool.length);i++){
        const c = pool[i];
        const bias = (c.operating_margin - 10) * 0.18 + (c.equity_ratio - 30) * 0.06;
        const change = clamp(rnd(-2.0, 2.8) + bias*0.12, -4.9, 6.2);
        const col = change>=0 ? "text-emerald-300" : "text-rose-300";
        msgs.push(`<span class="${col}">${(c.name||"").slice(0,10).toUpperCase()}</span> <span class="text-slate-200/80">Δ</span> <span class="${col}">${change>=0?"+":""}${change.toFixed(2)}%</span>`);
      }
      // duplicate for seamless scroll
      const track = $("tickerTrack");
      track.innerHTML = (msgs.concat(msgs)).map(m=>`<span class="mx-2">${m}</span>`).join("");
    }

    /********************
     * ACTIONS
     ********************/
        function randomPickDifferent(currentId){
      const ids = state.companies.map(c=>c.id).filter(id=>id!==currentId);
      return ids.length ? pick(ids) : currentId;
    }

    function generateCityScape(){
      const wrap = $("cityScape");
      if(!wrap) return;
      wrap.innerHTML = "";
      // Generate random buildings
      const count = 40;
      for(let i=0; i<count; i++){
        const b = document.createElement("div");
        b.className = "building";
        // Random properties
        const h = rnd(60, 240); // height
        const w = rnd(20, 70);  // width
        const l = rnd(-10, 110); // left position %
        const dist = rnd(0.5, 1.0); // distance scale factor
        
        b.style.height = `${h * dist}px`;
        b.style.width = `${w * dist}px`;
        b.style.left = `${l}%`;
        b.style.zIndex = Math.floor(dist * 100);
        b.style.opacity = dist * 0.8;
        b.style.filter = `blur(${(1-dist)*2}px)`;
        
        // Random window lights color
        if(Math.random() > 0.7) {
           b.style.borderTopColor = "rgba(167,139,250,0.6)";
        }
        wrap.appendChild(b);
      }
    }

    function startBattle({auto=false, tournamentCtx=null}={}){
      const p = getCompany(state.playerId);
      const c = getCompany(state.cpuId);
      if(!p || !c){
        toast("企業が選択されていません。", "bad");
        return;
      }
      if(p.id === c.id){
        toast("同じ企業同士は選べません。", "bad");
        return;
      }

      state.battle = battleCreate(p, c);
      state.battle.logs = [];
      state.battle.turn = 1;
      state.battle.auto = !!auto;
      state.battle.paused = false;
      state.battle.tournamentCtx = tournamentCtx;

            // initial log
      state.battle.log(`<span class="tag">OPENING</span> <b>${p.name_jp || p.name}</b> が出撃。敵は <b>${c.name_jp || c.name}</b>。`);
      state.battle.log(`<div class="mt-1 text-xs grid grid-cols-2 gap-2"><div class="text-sky-300">[P] ${p.skill_name}</div><div class="text-rose-300 text-right">[C] ${c.skill_name}</div></div>`);
      
      generateCityScape(); // Draw background city
      renderBattleUI();
      showScreen(Screens.Battle);

      if(auto){
        toast("AUTO観戦モード", "good");
        runAutoLoop();
      }
    }

        async function runAutoLoop(){
      const b = state.battle;
      if(!b) return;
      while(state.battle === b && !b.finished){
        if(b.paused){ await sleep(200); continue; }
        const act = cpuChooseAction(b); // for player side too, in auto
        await runTurn(act);
        await sleep(600);
      }
      // if tournament context, commit winner to bracket
      if(b?.tournamentCtx && b.finished){
        const {match, round} = b.tournamentCtx;
        const wId = (b.winner==="P") ? state.playerId : (b.winner==="C") ? state.cpuId : (Math.random()<0.5 ? state.playerId : state.cpuId);
        match.w = wId;

        const wn = getCompany(wId)?.name_jp || getCompany(wId)?.name;
        tlog(`${round.toUpperCase()}: <b>${getCompany(match.a).name_jp || getCompany(match.a).name}</b> vs <b>${getCompany(match.b).name_jp || getCompany(match.b).name}</b> → <span class="text-emerald-300">WIN: ${wn}</span>`);
        renderTournament();

        // if champion decided
        if(state.tournament?.f?.[0]?.w){
          confetti({particleCount: 240, spread: 85, startVelocity: 44, scalar: 1.05, origin:{x:0.5, y:0.32}});
          tlog(`<span class="mono font-black text-emerald-300">CHAMPION</span> — ${getCompany(state.tournament.f[0].w).name_jp || getCompany(state.tournament.f[0].w).name}`);
        }
      }
    }

    /********************
     * RESET / RESTORE
     ********************/
    async function restoreSample(){
      await dbClear(STORE_COMP);
      await dbPutMany(STORE_COMP, SAMPLE_COMPANIES);
      await loadCompanies();
      toast("サンプルデータに復元しました。", "good");
    }

    async function clearDb(){
      await dbClear(STORE_COMP);
      await loadCompanies();
      toast("DBをクリアしました。", "bad");
    }

    /********************
     * HOOKS
     ********************/
    function wire(){
      // nav
      $("btnGoStart").onclick = ()=>showScreen(Screens.Start);
      $("btnGoLab").onclick = ()=>showScreen(Screens.Lab);
      $("btnGoTournament").onclick = ()=>showScreen(Screens.Tournament);

      $("btnOpenLabFromIntel").onclick = ()=>showScreen(Screens.Lab);
      $("btnLabBack").onclick = ()=>showScreen(Screens.Start);

      $("btnTournamentBack").onclick = ()=>showScreen(Screens.Start);

      // modal
      $("btnCloseModal").onclick = modalHide;
      $("modal").addEventListener("click",(e)=>{
        if(e.target === $("modal").querySelector(".absolute")) modalHide();
      });

      // selects
      $("selPlayer").onchange = ()=>{
        state.playerId = $("selPlayer").value;
        updateSectorTags();
        const c = getCompany(state.playerId);
        if(c) buildIntel(c);
      };
      $("selCPU").onchange = ()=>{
        state.cpuId = $("selCPU").value;
        updateSectorTags();
      };

      $("btnRandomPlayer").onclick = ()=>{
        state.playerId = randomPickDifferent(state.playerId);
        $("selPlayer").value = state.playerId;
        updateSectorTags();
        buildIntel(getCompany(state.playerId));
        toast("YOUR COMPANY をランダム選択", "good");
      };
      $("btnRandomCPU").onclick = ()=>{
        state.cpuId = randomPickDifferent(state.cpuId);
        $("selCPU").value = state.cpuId;
        updateSectorTags();
        toast("ENEMY をランダム選択", "good");
      };

      $("btnInspectPlayer").onclick = ()=>{
        const c = getCompany(state.playerId);
        if(c) openInspectModal(c);
      };
      $("btnInspectCPU").onclick = ()=>{
        const c = getCompany(state.cpuId);
        if(c) openInspectModal(c);
      };

      // start battle
      $("btnStartBattle").onclick = ()=>startBattle({auto:false});
      $("btnStartTournamentFromStart").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          showScreen(Screens.Tournament);
          toast("トーナメント生成完了", "good");
        }
      };

      // battle nav
      $("btnBattleBackStart").onclick = ()=>{
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnBattleToResult").onclick = ()=>{
        finishBattle();
      };

      // commands
      $("cmdAttack").onclick = ()=>runTurn("Attack");
      $("cmdGuard").onclick = ()=>runTurn("Guard");
      $("cmdPivot").onclick = ()=>runTurn("Pivot");
      $("cmdSkill").onclick = ()=>runTurn("Skill");

      $("btnClearLog").onclick = ()=>{
        if(state.battle){
          state.battle.logs = [];
          renderLog();
          toast("ログをクリア", "good");
        }
      };

      $("btnAuto").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.auto = !b.auto;
        toast(b.auto ? "AUTO ON" : "AUTO OFF", b.auto ? "good":"info");
        renderBattleUI();
        if(b.auto) runAutoLoopManualMode();
      };

          async function runAutoLoopManualMode(){
      const b = state.battle;
      while(state.battle === b && b.auto && !b.finished){
        if(b.paused){ await sleep(220); continue; }
        const act = cpuChooseAction(b); // for player side too
        await runTurn(act);
        await sleep(600);
      }
    }

      $("btnPause").onclick = ()=>{
        const b = state.battle;
        if(!b || b.finished) return;
        b.paused = !b.paused;
        toast(b.paused ? "PAUSED" : "RESUMED", b.paused ? "bad":"good");
        renderBattleUI();
      };

      // result
      $("btnResultBack").onclick = ()=>{
        state.battle = null;
        showScreen(Screens.Start);
      };
      $("btnRematch").onclick = ()=>{
        if(!state.battle) return;
        const p = state.battle.P.company.id;
        const c = state.battle.C.company.id;
        state.playerId = p; state.cpuId = c;
        startBattle({auto:false});
      };

      // tournament
      $("btnNewBracket").onclick = ()=>{
        state.tournament = tournamentCreate();
        if(state.tournament){
          renderTournament();
          toast("新しいブラケットを生成", "good");
        }
      };
      $("btnRunNextMatch").onclick = ()=>playNextMatchInteractive();
      $("btnAutoSim").onclick = ()=>autoSimTournament();

      // lab
      $("btnGeneratePrompt").onclick = ()=>{
        const p = generatePrompt();
        $("labPrompt").value = p;
        toast("プロンプト生成完了", "good");
      };
      $("btnCopyPrompt").onclick = async ()=>{
        const t = $("labPrompt").value.trim();
        if(!t){ toast("先にプロンプトを生成してください。","bad"); return; }
        const ok = await copyToClipboard(t);
        toast(ok ? "コピーしました。" : "コピーに失敗しました。", ok?"good":"bad");
      };
      $("btnClearPrompt").onclick = ()=>{$("labPrompt").value=""; toast("クリア","good");};

      $("btnImportJson").onclick = ()=>importJson();
      $("btnExportJson").onclick = ()=>exportAll();

      $("btnClearDb").onclick = async ()=>{
        if(!confirm("DBを全消去します。よろしいですか？")) return;
        await clearDb();
      };
      $("btnRestoreSample").onclick = async ()=>{
        if(!confirm("サンプルデータに復元します（追加企業は消えます）。よろしいですか？")) return;
        await restoreSample();
      };

      // start screen reset
      $("btnResetSample").onclick = async ()=>{
        if(!confirm("初期サンプルにリセットします（追加企業は消えます）。よろしいですか？")) return;
        await restoreSample();
      };

      
    }

    /********************
     * INIT
     ********************/
    (async function init(){
      lucide.createIcons();
      renderSectorChoices();
      await seedIfEmpty();
      await loadCompanies();

      

      wire();
      showScreen(Screens.Start);

      // default tournament object placeholder
      state.tournament = null;

      // initial intel
      const c = getCompany(state.playerId);
      if(c) buildIntel(c);

      $("dbStatus").textContent = "OK";
      toast("READY", "good");
    })();
  </script>













<script id="lfs-meta" type="application/json">
{
  "appId": "ea644a3fa162beb269314f429c0dec93",
  "createdAt": "2026-02-02T16:25:29.642Z",
  "schema": 2,
  "title": "CORPORATE QUEST — Real Company Battle",
  "savedAt": "2026-02-02T22:31:27.189Z",
  "aiInstruction": "Result画面が横に間延びした形になっており修正。",
  "comment": "Result画面が横に間延びした形になっており修正。",
  "sourceMode": "project",
  "runId": "76a09b8881d8672e591c82b684309dbc"
}
</script>
</body>
</html>
