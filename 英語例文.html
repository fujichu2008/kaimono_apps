<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no" />
<title>SpeakSceneï¼ˆTOEIC S ä¾‹æ–‡ç®¡ç†ï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --card:#121826; --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --warn:#ffb020; --danger:#ff4d4f; --star:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(#0c0f14,#0c1220);color:var(--ink);
    font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif}
  header{position:sticky;top:0;z-index:10;background:rgba(12,15,20,.8);backdrop-filter:saturate(1.2) blur(10px);
    border-bottom:1px solid var(--line);padding:10px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  h1{font-size:18px;margin:0;flex:1}
  nav{display:flex;gap:8px}
  nav button{appearance:none;border:1px solid var(--line);background:#0e1525;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:14px}
  nav button.active{border-color:var(--pri);box-shadow:0 0 0 2px rgba(77,163,255,.15) inset}
  main{padding:12px}
  .wrap{max-width:880px;margin:0 auto}
  section{display:none}
  section.active{display:block}
  .row{display:grid;gap:10px}
  @media(min-width:640px){ .row.two{grid-template-columns:1fr 1fr} }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
  input[type="text"], input[type="search"], textarea, select{
    width:100%;background:var(--card);border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:10px;font-size:16px;outline:none
  }
  textarea{min-height:84px;resize:vertical}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{appearance:none;border:1px solid var(--line);background:#10192b;color:var(--ink);
    padding:10px 12px;border-radius:12px;font-size:16px}
  .btn.pri{background:linear-gradient(180deg,#1b3b64,#10223b);border-color:#285082}
  .btn.ok{background:linear-gradient(180deg,#115a2b,#0f2e1b);border-color:#1d7a44}
  .btn.warn{background:linear-gradient(180deg,#5d430f,#2f230a);border-color:#7d5a14}
  .btn.danger{background:linear-gradient(180deg,#5a1313,#2b0f0f);border-color:#7a1d1d}
  .grid{display:grid;gap:10px}
  .filters{display:grid;gap:8px;margin-bottom:12px}
  @media(min-width:640px){ .filters{grid-template-columns:1fr 120px 120px 180px auto} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card h3{margin:0 0 6px 0;font-size:16px}
  .meta{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tools button{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1726;color:var(--ink)}
  .flag{padding:2px 6px;border-radius:6px;border:1px solid var(--line);font-size:12px}
  .fav{color:var(--star)}
  dialog{width:min(560px,92vw);border:1px solid var(--line);border-radius:16px;background:#0f1524;color:var(--ink);padding:14px}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .tiny{font-size:12px;color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>SpeakScene</h1>
  <nav>
    <button id="nav-create" class="active">ç™»éŒ²</button>
    <button id="nav-list">ä¸€è¦§</button>
    <button id="nav-settings">è¨­å®š</button>
    <button id="btn-unlock" title="iPhoneåˆå›ã¯æŠ¼ã—ã¦ãã ã•ã„">ğŸ”Š éŸ³å£°ON</button>
  </nav>
</header>

<main class="wrap">
  <!-- ç™»éŒ²ç”»é¢ -->
  <section id="view-create" class="active">
    <div class="row two">
      <div>
        <label>è‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰</label>
        <textarea id="en" placeholder="ä¾‹ï¼šGiven our tight schedule, I suggest outsourcing the inspection to meet the deadline."></textarea>
      </div>
      <div>
        <label>å’Œè¨³ï¼ˆJapaneseï¼æ‰‹å…¥åŠ›ï¼‰</label>
        <textarea id="ja" placeholder="ä¾‹ï¼šå·¥ç¨‹ãŒå³ã—ã„ãŸã‚ã€ç· åˆ‡ã‚’å®ˆã‚‹ã«ã¯æ¤œæŸ»ã‚’å¤–éƒ¨å§”è¨—ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚"></textarea>
      </div>
    </div>

    <div class="row two">
      <div>
        <label>å…·ä½“çš„ãªå ´é¢ï¼ˆSceneï¼‰</label>
        <input id="scene" type="text" placeholder="ä¾‹ï¼šè¨­å‚™æ®ä»˜ã®å·¥ç¨‹ä¼šè­°ã§å¤–éƒ¨æ¤œæŸ»ã‚’ææ¡ˆ" />
      </div>
      <div>
        <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°å¯ / TOEIC Sæƒ³å®šï¼‰</label>
        <select id="cats" multiple size="6">
          <option>Picture</option>
          <option>Q&A</option>
          <option>Response</option>
          <option>Solution</option>
          <option>Opinion</option>
          <option>Task/Flow</option>
          <option>Business Scene</option>
        </select>
        <div class="tiny">â€» Ctrl/âŒ˜ ã§è¤‡æ•°é¸æŠ</div>
      </div>
    </div>

    <div class="row two">
      <div>
        <label>ã‚¿ã‚°ï¼ˆcomma, separatedï¼‰</label>
        <input id="tags" type="text" placeholder="ä¾‹ï¼šèª¿é”, ç´æœŸ, å¤–æ³¨" />
      </div>
      <div>
        <label>CEFRï¼ˆç›®å®‰ï¼‰</label>
        <select id="cefr">
          <option value="">æŒ‡å®šãªã—</option>
          <option>A2</option>
          <option>B1</option>
          <option>B2</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>ãƒ¡ãƒ¢ï¼ˆç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰</label>
        <input id="notes" type="text" placeholder="ä¾‹ï¼šã‚³ã‚¹ãƒˆå‰Šæ¸›ã®è«–æ‹ ã‚’å…¥ã‚Œã‚‹ã¨è‰¯ã„" />
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btn-preview">â–¶ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ</button>
      <button class="btn pri" id="btn-save">ä¿å­˜</button>
      <button class="btn" id="btn-clear">ã‚¯ãƒªã‚¢</button>
    </div>
  </section>

  <!-- ä¸€è¦§ç”»é¢ -->
  <section id="view-list">
    <div class="filters">
      <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆè‹±/å’Œ/å ´é¢/ã‚¿ã‚°ï¼‰" />
      <select id="f-cat"><option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option></select>
      <select id="f-level">
        <option value="">CEFR: ã™ã¹ã¦</option>
        <option>A2</option><option>B1</option><option>B2</option>
      </select>
      <select id="sort">
        <option value="updatedAt">ä¸¦ã³: æ›´æ–°â†“</option>
        <option value="createdAt">ä¸¦ã³: ä½œæˆâ†“</option>
        <option value="playCount">ä¸¦ã³: å†ç”Ÿå›æ•°â†“</option>
        <option value="english">ä¸¦ã³: è‹±æ–‡ Aâ†’Z</option>
      </select>
      <div class="actions">
        <button class="btn" id="btn-export">Export</button>
        <label class="btn" for="file-import">Import</label>
        <input id="file-import" type="file" accept=".json" class="hidden">
      </div>
    </div>
    <div class="grid" id="cards"></div>
  </section>
</main>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="dlg-settings">
  <form method="dialog">
    <h3 style="margin:0 0 8px">éŸ³å£°ãƒ»å†ç”Ÿè¨­å®š</h3>
    <div class="row two">
      <div>
        <label>Voice</label>
        <select id="voice"></select>
        <div class="tiny">â€» åˆå›ã¯ã€ŒğŸ”ŠéŸ³å£°ONã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å£°ãŒå–å¾—ã•ã‚Œã¾ã™ï¼ˆiOSï¼‰</div>
      </div>
      <div>
        <label>Language hint</label>
        <select id="lang">
          <option value="">Auto</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ja-JP">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Rate</label>
        <input id="rate" type="range" min="0.5" max="2" step="0.1">
      </div>
      <div>
        <label>Pitch</label>
        <input id="pitch" type="range" min="0" max="2" step="0.1">
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Volume</label>
        <input id="volume" type="range" min="0" max="1" step="0.1">
      </div>
      <div>
        <label>Gapï¼ˆæ¬¡ãƒ‘ãƒ¼ãƒˆã¾ã§ã®é–“åˆã„ç§’ï¼‰</label>
        <input id="gap" type="number" min="0" max="5" step="0.5">
      </div>
    </div>
    <div class="row two">
      <div>
        <label>Repeatï¼ˆè‹±èªã®ç¹°ã‚Šè¿”ã—å›æ•°ï¼‰</label>
        <input id="repeat" type="number" min="1" max="5" step="1">
      </div>
      <div>
        <label>èª­ã¿ä¸Šã’å¯¾è±¡</label>
        <select id="speak-target">
          <option value="en">è‹±èªã®ã¿</option>
          <option value="ja">å’Œè¨³ã®ã¿</option>
          <option value="both">è‹± â†’ é–“ â†’ å’Œ</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="btn ok" id="save-settings">ä¿å­˜</button>
      <button class="btn right" value="close">é–‰ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<script>
/* =========================
   Utilities
========================= */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const uid = ()=>crypto.randomUUID();
const now = ()=>Date.now();
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function escapeHTML(s=''){
  return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
// iOSåˆ¤å®šï¼ˆå……åˆ†ã«å®Ÿç”¨çš„ãªç°¡æ˜“åˆ¤å®šï¼‰
const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent) ||
              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

/* =========================
   State & Settings (localStorage)
========================= */
const LS_SETTINGS = 'speakscene_settings_v1';
const defaultSettings = {
  ttsLang: '', voiceName: '', rate: 1.0, pitch: 1.0, volume: 1.0,
  gapSec: 1.0, repeat: 1, speakTarget: 'en'
};
let settings = loadSettings();

function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}');
    return Object.assign({}, defaultSettings, s);
  }catch(e){ return {...defaultSettings}; }
}
function saveSettings(){
  localStorage.setItem(LS_SETTINGS, JSON.stringify(settings));
}

/* =========================
   IndexedDB (sentences)
========================= */
const DB_NAME = 'speakscene_db';
const DB_VER  = 1;
const STORE   = 'sentences';

let db;
openDB();

function openDB(){
  const req = indexedDB.open(DB_NAME, DB_VER);
  req.onupgradeneeded = e=>{
    const db = e.target.result;
    if(!db.objectStoreNames.contains(STORE)){
      const os = db.createObjectStore(STORE,{keyPath:'id'});
      os.createIndex('createdAt','createdAt',{unique:false});
      os.createIndex('updatedAt','updatedAt',{unique:false});
      os.createIndex('english','english',{unique:false});
      os.createIndex('playCount','playCount',{unique:false});
    }
  };
  req.onsuccess = e=>{ db = e.target.result; refreshList(); fillCategoryFilter(); };
  req.onerror = e=>{ console.error('DB open error', e); alert('DBåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'); };
}

function store(mode='readonly'){ return db.transaction([STORE], mode).objectStore(STORE); }
const addSentence    = item => new Promise((res)=> store('readwrite').add(item).onsuccess=()=>res());
const updateSentence = item => new Promise((res)=> store('readwrite').put(item).onsuccess=()=>res());
const deleteSentence = id   => new Promise((res)=> store('readwrite').delete(id).onsuccess=()=>res());
const getAll         = ()=> new Promise((res,rej)=>{ const r=store().getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=rej; });
const getOne         = id  => new Promise((res,rej)=>{ const r=store().get(id); r.onsuccess=()=>res(r.result||null); r.onerror=rej; });

/* =========================
   Navigation
========================= */
const views = { create: $('#view-create'), list: $('#view-list') };
function show(view){
  Object.values(views).forEach(v=>v.classList.remove('active'));
  views[view].classList.add('active');
}
$('#nav-create').onclick=()=>{ setActiveNav('nav-create'); show('create'); };
$('#nav-list').onclick=()=>{ setActiveNav('nav-list'); show('list'); refreshList(); };
$('#nav-settings').onclick=()=>{ setActiveNav(); openSettings(); };
function setActiveNav(id){
  $$('nav button').forEach(b=>b.classList.remove('active'));
  if(id) $('#'+id).classList.add('active');
}

/* =========================
   Create form (save / clear / preview)
========================= */
function defaultSaveHandler(){
  $('#btn-save').onclick = async ()=>{
    const english = $('#en').value.trim();
    if(!english){ alert('è‹±èªä¾‹æ–‡ã¯å¿…é ˆã§ã™'); return; }
    const item = collectFormToItem();
    item.id = uid();
    item.createdAt = now();
    item.updatedAt = now();
    item.favorite = false;
    item.playCount = 0;
    await addSentence(item);
    clearForm(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
    fillCategoryFilter();
    refreshList();
    setActiveNav('nav-list'); show('list');
  };
}
function collectFormToItem(base={}){
  const japanese = $('#ja').value.trim();
  const scene = $('#scene').value.trim();
  const categories = Array.from($('#cats').selectedOptions).map(o=>o.value);
  const tags = $('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const cefr = $('#cefr').value || '';
  const notes = $('#notes').value.trim();
  const english = $('#en').value.trim();
  return Object.assign(base, { english, japanese, scene, categories, tags, cefr, notes });
}
function clearForm(){
  ['en','ja','scene','tags','notes'].forEach(id=>$('#'+id).value='');
  Array.from($('#cats').options).forEach(o=>o.selected=false);
  $('#cefr').value='';
}
$('#btn-clear').onclick = ()=> clearForm();
$('#btn-preview').onclick = async ()=>{
  const en = ($('#en').value.trim() || '').substring(0,400);
  const ja = $('#ja').value.trim();
  if(!en && !ja){ alert('è‹±èªä¾‹æ–‡ã‹å’Œè¨³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  await speakFlow({english: en, japanese: ja});
};
defaultSaveHandler();

/* =========================
   List view & filters
========================= */
const fCat = $('#f-cat');
const fLevel = $('#f-level');
const q = $('#q');
const sortSel = $('#sort');
[fCat,fLevel,q,sortSel].forEach(el=> el.oninput = ()=>refreshList());

async function fillCategoryFilter(){
  const rows = await getAll();
  const cats = new Set();
  rows.forEach(r=>(r.categories||[]).forEach(c=>cats.add(c)));
  fCat.innerHTML = `<option value="">ã‚«ãƒ†ã‚´ãƒª: ã™ã¹ã¦</option>` +
    Array.from(cats).sort().map(c=>`<option>${escapeHTML(c)}</option>`).join('');
}

async function refreshList(){
  if(!db) return;
  const rows = await getAll();
  const kw = q.value.trim().toLowerCase();
  const cat = fCat.value;
  const level = fLevel.value;

  let list = rows.filter(r=>{
    if(cat && !(r.categories||[]).includes(cat)) return false;
    if(level && r.cefr!==level) return false;
    if(kw){
      const hay = [r.english,r.japanese,r.scene,(r.tags||[]).join(' ')].join(' ').toLowerCase();
      if(!hay.includes(kw)) return false;
    }
    return true;
  });

  const s = sortSel.value;
  list.sort((a,b)=>{
    if(s==='english') return (a.english||'').localeCompare(b.english||'');
    return (b[s]||0) - (a[s]||0);
  });

  renderCards(list);
}

function renderCards(list){
  const root = $('#cards');
  root.innerHTML = '';
  if(list.length===0){
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = '<div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®<strong>ç™»éŒ²</strong>ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    root.appendChild(div);
    return;
  }
  for(const r of list){
    const card = document.createElement('div');
    card.className='card';
    const cats = (r.categories||[]).map(c=>`<span class="chip">${escapeHTML(c)}</span>`).join(' ');
    const tags = (r.tags||[]).map(t=>`<span class="chip">#${escapeHTML(t)}</span>`).join(' ');
    card.innerHTML = `
      <h3>${escapeHTML(r.english)}</h3>
      ${r.japanese ? `<div class="tiny">(${escapeHTML(r.japanese)})</div>`:''}
      <div class="meta">
        <span class="flag">${r.cefr||'CEFRãªã—'}</span>
        ${r.scene? `<span class="flag">${escapeHTML(r.scene)}</span>`:''}
        <span class="flag">å†ç”Ÿ ${r.playCount||0}</span>
        ${r.favorite? `<span class="flag fav">â˜…ãŠæ°—ã«å…¥ã‚Š</span>`:''}
      </div>
      <div class="chips">${cats}</div>
      <div class="chips" style="margin-top:4px">${tags}</div>
      <div class="tools">
        <button data-act="play" data-id="${r.id}">â–¶ï¸ å†ç”Ÿ</button>
        <button data-act="fav" data-id="${r.id}">${r.favorite?'â˜…ãŠæ°—ã«å…¥ã‚Šè§£é™¤':'â˜†ãŠæ°—ã«å…¥ã‚Š'}</button>
        <button data-act="edit" data-id="${r.id}">âœ ç·¨é›†</button>
        <button data-act="dup" data-id="${r.id}">â§‰ è¤‡è£½</button>
        <button data-act="del" data-id="${r.id}">ğŸ—‘ å‰Šé™¤</button>
      </div>
    `;
    root.appendChild(card);
  }

  root.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const row = await getOne(id);
      if(!row) return;

      if(act==='play'){
        await speakFlow(row);
        row.playCount = (row.playCount||0)+1;
        row.updatedAt = now();
        await updateSentence(row);
        refreshList();

      }else if(act==='fav'){
        row.favorite = !row.favorite;
        row.updatedAt = now();
        await updateSentence(row);
        refreshList();

      }else if(act==='edit'){
        // load to form
        setActiveNav('nav-create'); show('create');
        $('#en').value = row.english||'';
        $('#ja').value = row.japanese||'';
        $('#scene').value = row.scene||'';
        Array.from($('#cats').options).forEach(o=>o.selected=(row.categories||[]).includes(o.value));
        $('#tags').value = (row.tags||[]).join(', ');
        $('#cefr').value = row.cefr||'';
        $('#notes').value = row.notes||'';

        // temporary override save button for update
        $('#btn-save').onclick = async ()=>{
          const english = $('#en').value.trim();
          if(!english){ alert('è‹±èªä¾‹æ–‡ã¯å¿…é ˆã§ã™'); return; }
          collectFormToItem(row);
          row.updatedAt = now();
          await updateSentence(row);
          alert('æ›´æ–°ã—ã¾ã—ãŸ');
          defaultSaveHandler(); // restore default handler
          clearForm();
          setActiveNav('nav-list'); show('list'); refreshList();
          fillCategoryFilter();
        };

      }else if(act==='dup'){
        const clone = {...row, id:uid(), createdAt:now(), updatedAt:now(), favorite:false, playCount:0};
        await addSentence(clone);
        fillCategoryFilter(); refreshList();

      }else if(act==='del'){
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
          await deleteSentence(id);
          fillCategoryFilter(); refreshList();
        }
      }
    };
  });
}

/* =========================
   Export / Import
========================= */
$('#btn-export').onclick = async ()=>{
  const data = await getAll();
  const blob = new Blob([JSON.stringify({sentences:data},null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `speakscene_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
};
$('#file-import').onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  try{
    const json = JSON.parse(text);
    if(!json.sentences || !Array.isArray(json.sentences)) throw new Error('format');
    if(!confirm(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã¨é‡è¤‡ã™ã‚‹å ´åˆã¯æ–°è¦IDã§è¿½åŠ ã—ã¾ã™ã€‚`)) return;
    for(const r of json.sentences){
      const item = {
        id: uid(),
        english: r.english||'',
        japanese: r.japanese||'',
        scene: r.scene||'',
        categories: Array.isArray(r.categories)? r.categories:[],
        tags: Array.isArray(r.tags)? r.tags:[],
        cefr: r.cefr||'',
        notes: r.notes||'',
        favorite: !!r.favorite, playCount: Number(r.playCount||0),
        createdAt: now(), updatedAt: now()
      };
      await addSentence(item);
    }
    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
    fillCategoryFilter(); refreshList();
  }catch(err){
    alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™');
  }finally{ e.target.value=''; }
};

/* =========================
   TTSï¼ˆiPhoneè§£éŒ å¯¾å¿œï¼‰
========================= */
let voices = [];
speechSynthesis.onvoiceschanged = ()=> loadVoices();

function loadVoices(){
  voices = speechSynthesis.getVoices() || [];
  renderVoiceList();
}
function renderVoiceList(){
  const sel = $('#voice');
  const prev = settings.voiceName || '';
  sel.innerHTML='';
  const list = voices
    .filter(v=>!settings.ttsLang || v.lang.startsWith(settings.ttsLang))
    .sort((a,b)=>a.lang.localeCompare(b.lang)||a.name.localeCompare(b.name));
  for(const v of list){
    const opt = document.createElement('option');
    opt.value = v.name; opt.textContent = `${v.name} (${v.lang})${v.default?' â˜…':''}`;
    sel.appendChild(opt);
  }
  sel.value = prev;
}
function pickVoice(){
  const target = settings.voiceName;
  const hint = settings.ttsLang;
  let v = null;
  if(target) v = voices.find(x=>x.name===target) || null;
  if(!v && hint) v = voices.find(x=>x.lang.startsWith(hint)) || null;
  if(!v) v = voices.find(x=>x.default) || voices[0] || null;
  return v;
}

// iPhoneåˆå›ã€Œè§£éŒ ã€ãƒœã‚¿ãƒ³
$('#btn-unlock').onclick = async ()=>{
  try {
    try { speechSynthesis.cancel(); } catch(e) {}
    const warm = new SpeechSynthesisUtterance(' ');
    warm.volume = 0.01;
    warm.rate = 1.0; warm.pitch = 1.0;
    warm.lang = settings.ttsLang || 'en-US';
    warm.onend = ()=>{
      loadVoices();
      alert('éŸ³å£°ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚å†ç”Ÿã§ãã¾ã™ã€‚');
    };
    speechSynthesis.speak(warm);
  } catch (e) {
    alert('éŸ³å£°ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
    console.error(e);
  }
};

// å®‰å…¨ç‰ˆ speak
function speak(text,{voice,rate,pitch,volume}={}){
  return new Promise((res)=>{
    if(!text){ res(); return; }

    // voices ãŒç©ºãªã‚‰å†å–å¾—
    if(!voices || voices.length === 0){
      voices = speechSynthesis.getVoices() || [];
    }

    const u = new SpeechSynthesisUtterance(text);
    const v = voice || pickVoice();
    if(v) u.voice = v;

    // è¨€èªãƒ’ãƒ³ãƒˆ
    if(!u.lang){
      u.lang = settings.ttsLang || (/[a-zA-Z]/.test(text) ? 'en-US' : 'ja-JP');
    }

    u.rate   = rate  ?? settings.rate;
    u.pitch  = pitch ?? settings.pitch;
    u.volume = volume?? settings.volume;

    u.onend   = res;
    u.onerror = (e)=>{ console.warn('TTS error', e); res(); };

    // è©±ã—ä¸­ã ã‘ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆiOSã®ç„¡éŸ³åŒ–å›é¿ï¼‰
    if (speechSynthesis.speaking) {
      try { speechSynthesis.cancel(); } catch(e){}
    }

    if (isIOS) {
      setTimeout(()=> speechSynthesis.speak(u), 0);
    } else {
      speechSynthesis.speak(u);
    }
  });
}

// é€£ç¶šå†ç”Ÿãƒ•ãƒ­ãƒ¼ï¼ˆè‹±â†’é–“â†’å’Œ ãªã©ï¼‰
async function speakFlow(row){
  try { speechSynthesis.resume(); } catch(e){}
  const en = (row.english||'').trim();
  const ja = (row.japanese||'').trim();
  const gap = Math.max(0, Number(settings.gapSec||0))*1000;
  const rep = Math.max(1, parseInt(settings.repeat||1,10));
  const tgt = settings.speakTarget || 'en';

  if(tgt==='en'){
    for(let i=0;i<rep;i++){ await speak(en); if(i<rep-1 && gap) await sleep(gap); }
  }else if(tgt==='ja'){
    await speak(ja);
  }else{ // both
    for(let i=0;i<rep;i++){ await speak(en); if(gap) await sleep(gap); }
    if(ja){ await speak(ja); }
  }
}

/* =========================
   Settings dialog
========================= */
function openSettings(){
  loadVoices();
  $('#lang').value = settings.ttsLang||'';
  $('#rate').value = settings.rate;
  $('#pitch').value = settings.pitch;
  $('#volume').value = settings.volume;
  $('#gap').value = settings.gapSec;
  $('#repeat').value = settings.repeat;
  $('#speak-target').value = settings.speakTarget;
  $('#dlg-settings').showModal();
}
$('#save-settings').onclick = (ev)=>{
  ev.preventDefault();
  settings.ttsLang = $('#lang').value;
  settings.voiceName = $('#voice').value || '';
  settings.rate = Number($('#rate').value)||1.0;
  settings.pitch= Number($('#pitch').value)||1.0;
  settings.volume= Number($('#volume').value)||1.0;
  settings.gapSec= Number($('#gap').value)||0;
  settings.repeat= Math.max(1, parseInt($('#repeat').value||'1',10));
  settings.speakTarget = $('#speak-target').value||'en';
  saveSettings();
  renderVoiceList();
  $('#dlg-settings').close();
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
};

/* =========================
   Boot
========================= */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible') loadVoices();
});
window.addEventListener('pageshow', ()=> loadVoices());
</script>
</body>
</html>
