<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no"/>
<title>SpeakJudgeï¼ˆè‹±èªç™ºè©±åˆ¤å®šï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --bg2:#0b1220;
    --card:#121826; --card2:#0f1524;
    --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --mid:#ffb020; --danger:#ff4d4f; --ghost:#76839b;
    --shadow: 0 12px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif; color:var(--ink);
    background:radial-gradient(circle at 15% 10%, rgba(123,92,255,.18), transparent 45%),
               radial-gradient(circle at 85% 20%, rgba(77,163,255,.18), transparent 50%),
               linear-gradient(var(--bg), var(--bg2));
  }
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(12,15,20,.88);
    backdrop-filter:saturate(1.2) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .topbar{max-width:980px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:10px;}
  .dot{
    width:18px; height:18px; border-radius:999px;
    background:radial-gradient(circle at 30% 20%, #fff, #7b5cff 40%, #2b4dff 80%);
    box-shadow:0 0 16px rgba(83,130,255,.7);
  }
  h1{margin:0; font-size:16px; letter-spacing:.03em}
  .sub{color:var(--muted); font-size:12px; margin-left:auto}
  main{max-width:980px; margin:0 auto; padding:12px 12px 60px;}
  .grid{display:grid; gap:12px;}
  @media(min-width:900px){ .grid{grid-template-columns: 360px 1fr;} }

  .card{
    background:linear-gradient(145deg, var(--card), #0c1220);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    box-shadow: var(--shadow);
  }
  .card h2{margin:0 0 8px 0; font-size:14px}
  .tiny{color:var(--muted); font-size:12px; line-height:1.55}
  .row{display:grid; gap:10px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="search"], input[type="text"], select, textarea{
    width:100%; padding:10px 11px; border-radius:12px;
    background:rgba(18,24,38,.85);
    border:1px solid var(--line);
    color:var(--ink);
    outline:none;
    font-size:15px;
  }
  textarea{min-height:84px; resize:vertical}
  .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .btn{
    appearance:none; border:1px solid var(--line);
    background:#10192b; color:var(--ink);
    padding:10px 12px; border-radius:14px;
    cursor:pointer; user-select:none;
    transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(255,255,255,.06)}
  .btn.pri{background:linear-gradient(180deg,#1b3b64,#10223b); border-color:#285082}
  .btn.ok{background:linear-gradient(180deg,#115a2b,#0f2e1b); border-color:#1d7a44}
  .btn.warn{background:linear-gradient(180deg,#5d430f,#2f230a); border-color:#7d5a14}
  .btn.danger{background:linear-gradient(180deg,#5a1313,#2b0f0f); border-color:#7a1d1d}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none}

  .list{
    display:grid; gap:8px;
    max-height:66vh; overflow:auto; padding-right:4px;
  }
  .item{
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 10px 9px;
    background:rgba(15,21,36,.85);
    cursor:pointer;
    transition:border-color .15s ease, transform .08s ease, box-shadow .15s ease;
  }
  .item:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(255,255,255,.06)}
  .item.active{border-color:rgba(77,163,255,.8); box-shadow:0 0 0 1px rgba(77,163,255,.35)}
  .scene{font-size:13px; font-weight:600; margin:0 0 4px 0}
  .preview{font-size:12px; color:var(--muted); margin:0}

  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(14,21,37,.85);
    font-size:12px;
    font-variant-numeric:tabular-nums;
  }

  .panel-title{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    justify-content:space-between;
    margin-bottom:8px;
  }
  .panel-title .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .panel-title .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

  .textBox{
    border:1px dashed rgba(255,255,255,.12);
    border-radius:14px;
    padding:10px 10px;
    background:rgba(10,14,24,.55);
    line-height:1.9;
    white-space:pre-wrap;
    max-height:34vh;
    overflow:auto;
  }

  .diffWrap{display:grid; gap:10px}
  @media(min-width:720px){ .diffWrap{grid-template-columns:1fr 1fr;} }
  .diffCard{
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px;
    background:rgba(15,21,36,.82);
  }
  .diffCard h3{margin:0 0 6px 0; font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.03em}
  .words{line-height:2.0; word-break:break-word}
  .w{
    display:inline-block;
    padding:0 .18em;
    margin:.06em .04em;
    border-radius:.35em;
    border:1px solid transparent;
    font-variant-numeric:tabular-nums;
  }
  .w.ok{color: #dfffea; background:rgba(23,201,100,.12); border-color:rgba(23,201,100,.18)}
  .w.mid{color: #fff3d7; background:rgba(255,176,32,.13); border-color:rgba(255,176,32,.18)}
  .w.bad{color: #ffe2e2; background:rgba(255,77,79,.12); border-color:rgba(255,77,79,.18)}
  .w.miss{color: #c5ccda; background:rgba(118,131,155,.10); border-color:rgba(118,131,155,.14); text-decoration:line-through; opacity:.9}
  .w.extra{color: #fff0d2; background:rgba(255,176,32,.10); border-color:rgba(255,176,32,.16)}
  .w.muted{color:var(--muted)}
  .scoreBox{
    display:grid; gap:10px;
    grid-template-columns: 140px 1fr;
    align-items:center;
  }
  .scoreNum{
    font-size:44px; font-weight:800; letter-spacing:.02em;
    line-height:1;
  }
  .scoreLabel{font-size:12px; color:var(--muted); margin-top:4px}
  .bar{
    height:14px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(10,14,24,.55);
    overflow:hidden;
  }
  .bar > i{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg,#ff4d4f,#ffb020,#17c964,#4da3ff);
  }
  .kpis{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px;
    background:rgba(10,14,24,.9);
    border:1px solid var(--line);
    padding:10px 12px;
    border-radius:14px;
    box-shadow: var(--shadow);
    color:var(--ink);
    font-size:13px;
    max-width:min(720px, 92vw);
    opacity:0; pointer-events:none;
    transition:opacity .2s ease, transform .2s ease;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  footer{position:fixed; left:0; right:0; bottom:6px; text-align:center; font-size:11px; color:#8591a6; pointer-events:none}
  .hr{height:1px; background:rgba(36,48,71,.9); margin:10px 0}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="dot"></div>
    <h1>SpeakJudge</h1>
    <div class="sub">è‹±èªç™ºè©±åˆ¤å®šï¼ˆImport: SpeakNote Export JSONï¼‰</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Left: Import & List -->
    <section class="card">
      <h2>ğŸ“¥ Import / ä¾‹æ–‡ä¸€è¦§</h2>
      <div class="row">
        <div>
          <label>SpeakNoteã®Export JSONã‚’èª­ã¿è¾¼ã‚€</label>
          <div class="actions">
            <label class="btn pri" for="file-json">JSONã‚’é¸æŠ</label>
            <input id="file-json" type="file" accept=".json" style="display:none">
            <button class="btn" id="btn-demo">ãƒ‡ãƒ¢ä¾‹æ–‡</button>
            <button class="btn danger" id="btn-clear">å…¨æ¶ˆå»</button>
          </div>
          <div class="tiny" style="margin-top:8px">
            å–ã‚Šè¾¼ã¿å¾Œã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚<br>
            â€» ãƒã‚¤ã‚¯åˆ©ç”¨ & éŸ³å£°èªè­˜ã¯ <b>HTTPS</b>ï¼ˆã¾ãŸã¯localhostï¼‰æ¨å¥¨ã€‚
          </div>
        </div>

        <div>
          <label>æ¤œç´¢ï¼ˆScene / English / Tag / Categoryï¼‰</label>
          <input id="q" type="search" placeholder="ä¾‹ï¼šprocurement / self-intro / ç´æœŸ ãªã©">
        </div>

        <div class="actions" style="justify-content:space-between">
          <span class="badge">ğŸ“š ä»¶æ•°ï¼š<b id="count">0</b></span>
          <span class="badge">ğŸ™ï¸ éŸ³å£°èªè­˜ï¼š<b id="sr-badge">åˆ¤å®šä¸­â€¦</b></span>
        </div>

        <div class="list" id="list"></div>
      </div>
    </section>

    <!-- Right: Practice -->
    <section class="card">
      <div class="panel-title">
        <div class="left">
          <h2 style="margin:0">ğŸ¯ ç™ºè©±åˆ¤å®š</h2>
          <span class="badge">è¨€èªï¼š
            <select id="lang" style="padding:6px 10px; border-radius:999px; font-size:12px">
              <option value="en-US" selected>en-US</option>
              <option value="en-GB">en-GB</option>
              <option value="en-AU">en-AU</option>
              <option value="en-CA">en-CA</option>
            </select>
          </span>
        </div>
        <div class="right">
          <button class="btn ok" id="btn-start">ğŸ™ï¸ ç™ºè©±é–‹å§‹</button>
          <button class="btn danger" id="btn-stop">â¹ï¸ ç™ºè©±çµ‚äº†ï¼†æ¡ç‚¹</button>
          <button class="btn" id="btn-reset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ãŠæ‰‹æœ¬ï¼ˆEnglishï¼‰</label>
          <div id="refBox" class="textBox">å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>
          <div class="tiny" style="margin-top:6px">
            ã‚³ãƒ„ï¼šè‡ªç„¶ã«èª­ã‚ã‚‹é€Ÿåº¦ã§ã€åŒºåˆ‡ã‚Šï¼ˆå¥ï¼‰ã”ã¨ã«æ¯ç¶™ãã€‚<br>
            ã€Œé€šã˜ã‚‹æŒ‡æ•°ã€ã¯ â€œå˜èªã®ä¸€è‡´åº¦ + è¿‘ã„ç™ºéŸ³(æ¨å®š) + æ¬ è½/ä½™è¨ˆãªèªã®ãƒšãƒŠãƒ«ãƒ†ã‚£â€ ã‚’ç·åˆã—ãŸç›®å®‰ã§ã™ã€‚
          </div>
        </div>

        <div>
          <label>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—ãŠã“ã—ï¼ˆä¸­é–“è¡¨ç¤ºï¼‰</label>
          <div id="liveBox" class="textBox" style="min-height:86px"></div>
          <div class="actions" style="margin-top:8px">
            <span class="badge">çŠ¶æ…‹ï¼š<b id="state">å¾…æ©Ÿ</b></span>
            <span class="badge">æœ€çµ‚ãƒ†ã‚­ã‚¹ãƒˆï¼š<b id="finalLen">0</b> words</span>
          </div>

          <div class="hr"></div>

          <div id="scoreArea" class="card" style="box-shadow:none; padding:12px; background:rgba(15,21,36,.75)">
            <div class="scoreBox">
              <div>
                <div class="scoreNum" id="scoreNum">--</div>
                <div class="scoreLabel">é€šã˜ã‚‹æŒ‡æ•°ï¼ˆ/100ï¼‰</div>
              </div>
              <div>
                <div class="bar"><i id="barFill"></i></div>
                <div class="kpis" id="kpis"></div>
              </div>
            </div>
            <div class="tiny" id="scoreMsg" style="margin-top:10px"></div>
          </div>

          <div class="hr"></div>

          <div class="diffWrap">
            <div class="diffCard">
              <h3>Originalï¼ˆè‰²ï¼šé€šã˜ãŸ/è¿‘ã„/é•ã†/æ¬ è½ï¼‰</h3>
              <div class="words" id="diffRef"></div>
            </div>
            <div class="diffCard">
              <h3>Recognizedï¼ˆè‰²ï¼šé€šã˜ãŸ/è¿‘ã„/é•ã†/ä½™è¨ˆï¼‰</h3>
              <div class="words" id="diffHyp"></div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>ğŸ” æ‰‹å‹•è²¼ã‚Šä»˜ã‘æ¡ç‚¹ï¼ˆéŸ³å£°èªè­˜ãŒéå¯¾å¿œã®ç«¯æœ«å‘ã‘ï¼‰</label>
              <textarea id="manualHyp" placeholder="ï¼ˆä¾‹ï¼‰ã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰éŸ³å£°å…¥åŠ›ã§æ–‡ç« ã‚’å…¥ã‚Œã¦ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ¡ç‚¹"></textarea>
              <div class="actions" style="margin-top:8px">
                <button class="btn warn" id="btn-score-manual">âœï¸ ã“ã®å†…å®¹ã§æ¡ç‚¹</button>
              </div>
              <div class="tiny" id="manualHint" style="margin-top:6px"></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>
<footer>(C)Hisashi Fujinaka All Rights Reserved. All Code is generated by AI.</footer>

<script>
/* =========================
   Utilities
========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const LS_KEY = 'speakjudge_sentences_v1';

function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function toast(msg){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.classList.remove('show'), 2200);
}
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

function normalizeText(s){
  s = (s || '').toString();
  // Normalize quotes
  s = s.replace(/[â€œâ€]/g,'"').replace(/[â€™]/g,"'").replace(/[â€˜]/g,"'");
  // Replace hyphens with space (often ASR splits)
  s = s.replace(/[-â€-â€“â€”]/g, ' ');
  // Remove punctuation except apostrophe inside words
  s = s.replace(/[^A-Za-z0-9'\s]/g, ' ');
  // Collapse
  s = s.replace(/\s+/g,' ').trim().toLowerCase();
  return s;
}
function words(s){
  const n = normalizeText(s);
  if(!n) return [];
  return n.split(' ').filter(Boolean);
}

/* =========================
   Import / Storage
========================= */
let data = loadSaved();
let currentId = null;

function loadSaved(){
  try{
    const raw = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    return Array.isArray(raw) ? raw : [];
  }catch(e){ return []; }
}
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(_){}
}
function uid(){ return (crypto?.randomUUID?.() || ('id_'+Math.random().toString(16).slice(2))); }

function extractRows(json){
  if(Array.isArray(json)) return json;
  if(json && Array.isArray(json.items)) return json.items;
  if(json && Array.isArray(json.sentences)) return json.sentences;
  if(json && Array.isArray(json.rows)) return json.rows;
  if(json && json.data && Array.isArray(json.data)) return json.data;
  if(json && json.payload && Array.isArray(json.payload)) return json.payload;
  return [];
}
function mapRow(r){
  const english = (r.english ?? r.en ?? r.text ?? r.sentence ?? r.content ?? '').toString();
  const scene = (r.scene ?? r.title ?? r.context ?? r.situation ?? '').toString();
  const tags = Array.isArray(r.tags) ? r.tags.map(String) : (typeof r.tags === 'string' ? r.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);
  const categories = Array.isArray(r.categories) ? r.categories.map(String) : (Array.isArray(r.cats) ? r.cats.map(String) : []);
  const id = (r.id ? String(r.id) : uid());
  return { id, scene, english, tags, categories, _src:r };
}
function importJson(json){
  const rows = extractRows(json).map(mapRow).filter(x => x.english && x.english.trim());
  if(!rows.length) throw new Error('no_rows');
  // Merge by id (prefer imported), otherwise append
  const byId = new Map(data.map(x => [x.id, x]));
  for(const r of rows){
    byId.set(r.id, r);
  }
  data = Array.from(byId.values());
  save();
  renderList();
  toast(`Importå®Œäº†ï¼š${rows.length}ä»¶ï¼ˆåˆè¨ˆ ${data.length}ä»¶ï¼‰`);
}

/* =========================
   List UI
========================= */
function renderList(){
  const q = ($('#q').value || '').trim().toLowerCase();
  const root = $('#list');
  root.innerHTML = '';
  const filtered = data
    .filter(r=>{
      if(!q) return true;
      const hay = [
        r.scene||'',
        r.english||'',
        (r.tags||[]).join(' '),
        (r.categories||[]).join(' ')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    })
    .sort((a,b)=> (a.scene||'').localeCompare(b.scene||''));

  $('#count').textContent = filtered.length;

  if(!filtered.length){
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<p class="scene">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="preview">å·¦ä¸Šã®ã€ŒJSONã‚’é¸æŠã€ã‹ã€Œãƒ‡ãƒ¢ä¾‹æ–‡ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>`;
    root.appendChild(div);
    return;
  }

  for(const r of filtered){
    const div = document.createElement('div');
    div.className = 'item' + (r.id === currentId ? ' active' : '');
    const prev = (r.english||'').replace(/\s+/g,' ').trim().slice(0, 90);
    div.innerHTML = `
      <p class="scene">${escapeHTML(r.scene || 'ï¼ˆSceneãªã—ï¼‰')}</p>
      <p class="preview">${escapeHTML(prev)}${(r.english||'').length>90?'â€¦':''}</p>
    `;
    div.onclick = ()=> selectItem(r.id);
    root.appendChild(div);
  }
}
$('#q').addEventListener('input', renderList);

function selectItem(id){
  const r = data.find(x=>x.id===id);
  if(!r) return;
  currentId = id;
  stopRecognition(true);
  resetResultOnly();
  $('#refBox').textContent = r.english.trim();
  $('#manualHyp').value = '';
  $('#liveBox').textContent = '';
  $('#state').textContent = 'å¾…æ©Ÿ';
  $('#finalLen').textContent = '0';
  renderList();
  toast('ä¾‹æ–‡ã‚’é¸æŠã—ã¾ã—ãŸ');
}

/* =========================
   Speech Recognition
========================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
let listening = false;
let stopRequested = false;
let finalText = '';
let interimText = '';

function srSupported(){
  return !!SpeechRecognition;
}
function updateSrBadge(){
  $('#sr-badge').textContent = srSupported() ? 'å¯¾å¿œï¼ˆChromeæ¨å¥¨ï¼‰' : 'éå¯¾å¿œï¼ˆæ‰‹å‹•è²¼ã‚Šä»˜ã‘å¯ï¼‰';
  $('#manualHint').innerHTML = srSupported()
    ? 'ï¼ˆéŸ³å£°èªè­˜ãŒä½¿ãˆã‚‹å ´åˆã§ã‚‚ã€ç²¾åº¦ãŒä½ã„ã¨ãã¯ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦æ¡ç‚¹ã§ãã¾ã™ï¼‰'
    : 'ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Speech APIéå¯¾å¿œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>ä»£æ›¿ï¼šã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€Œãƒã‚¤ã‚¯ã€ã§è‹±æ–‡ã‚’éŸ³å£°å…¥åŠ› â†’ ã“ã“ã«è²¼ã‚Šä»˜ã‘ â†’ æ¡ç‚¹ã€‚';
}
updateSrBadge();

function setButtons(){
  $('#btn-start').disabled = !currentId || listening || !srSupported();
  $('#btn-stop').disabled  = !currentId || !listening || !srSupported();
}

function createRecognizer(){
  const r = new SpeechRecognition();
  r.lang = $('#lang').value || 'en-US';
  r.interimResults = true;
  r.continuous = true;
  // r.maxAlternatives = 1; // not supported everywhere
  r.onresult = (ev)=>{
    let finalBuf = finalText;
    let interimBuf = '';

    for(let i=ev.resultIndex; i<ev.results.length; i++){
      const res = ev.results[i];
      const txt = (res[0]?.transcript || '').trim();
      if(!txt) continue;

      if(res.isFinal){
        finalBuf = (finalBuf + ' ' + txt).trim();
      }else{
        interimBuf = (interimBuf + ' ' + txt).trim();
      }
    }
    finalText = finalBuf;
    interimText = interimBuf;

    const combined = (finalText + ' ' + interimText).trim();
    $('#liveBox').textContent = combined;
    $('#finalLen').textContent = String(words(finalText).length);
  };
  r.onerror = (ev)=>{
    const msg = ev?.error ? `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${ev.error}` : 'éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼';
    toast(msg);
    $('#state').textContent = 'ã‚¨ãƒ©ãƒ¼';
    // ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã¯ onend ãŒæ¥ãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§å¿µã®ãŸã‚
    listening = false;
    setButtons();
  };
  r.onend = ()=>{
    const wasStop = stopRequested;
    stopRequested = false;
    listening = false;
    setButtons();

    if(wasStop){
      // æ¡ç‚¹ã¯åœæ­¢å¾Œã«å®Ÿè¡Œï¼ˆfinalTextãŒç¢ºå®šã—ã‚„ã™ã„ï¼‰
      const hyp = (finalText || $('#liveBox').textContent || '').trim();
      if(!hyp){
        toast('èªè­˜çµæœãŒç©ºã§ã™ã€‚ã‚‚ã†ä¸€åº¦è©¦ã™ã‹ã€æ‰‹å‹•è²¼ã‚Šä»˜ã‘æ¡ç‚¹ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
        $('#state').textContent = 'å¾…æ©Ÿ';
        return;
      }
      $('#state').textContent = 'æ¡ç‚¹ä¸­â€¦';
      setTimeout(()=>{
        scoreAndRender(hyp);
        $('#state').textContent = 'å¾…æ©Ÿ';
      }, 60);
    }else{
      $('#state').textContent = 'å¾…æ©Ÿ';
    }
  };
  return r;
}

async function startRecognition(){
  if(!srSupported()){
    toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™ã€‚æ‰‹å‹•è²¼ã‚Šä»˜ã‘æ¡ç‚¹ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
    return;
  }
  if(!currentId){
    toast('å…ˆã«ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
    return;
  }
  stopRecognition(true);
  resetResultOnly();

  finalText = '';
  interimText = '';
  $('#liveBox').textContent = '';
  $('#finalLen').textContent = '0';
  $('#state').textContent = 'è´å–ä¸­â€¦';

  rec = createRecognizer();
  listening = true;
  stopRequested = false;
  setButtons();

  try{
    rec.start();
    toast('ç™ºè©±ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
  }catch(e){
    listening = false;
    setButtons();
    toast('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/HTTPS/ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œã‚’ç¢ºèªï¼‰');
    $('#state').textContent = 'å¾…æ©Ÿ';
  }
}

function stopRecognition(silent=false){
  if(rec){
    try{ rec.onresult = rec.onerror = rec.onend = null; }catch(_){}
    try{ rec.stop(); }catch(_){}
    rec = null;
  }
  if(listening && !silent){
    toast('åœæ­¢ã—ã¾ã—ãŸ');
  }
  listening = false;
  stopRequested = false;
  setButtons();
}
function stopAndScore(){
  if(!rec || !listening){
    toast('ç™ºè©±ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  stopRequested = true;
  $('#state').textContent = 'åœæ­¢ä¸­â€¦';
  try{ rec.stop(); }catch(_){
    // å³æ™‚çµ‚äº†ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const hyp = (finalText || $('#liveBox').textContent || '').trim();
    if(hyp){
      scoreAndRender(hyp);
      $('#state').textContent = 'å¾…æ©Ÿ';
    }
    listening = false;
    setButtons();
  }
}

$('#lang').addEventListener('change', ()=>{
  if(listening){
    toast('è¨€èªè¨­å®šã‚’åæ˜ ã™ã‚‹ãŸã‚ã€ã„ã£ãŸã‚“åœæ­¢ã—ã¾ã™');
    stopRecognition(true);
    $('#state').textContent = 'å¾…æ©Ÿ';
  }
});

$('#btn-start').onclick = startRecognition;
$('#btn-stop').onclick  = stopAndScore;
$('#btn-reset').onclick = ()=>{
  stopRecognition(true);
  resetAll();
  toast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
};

function resetResultOnly(){
  $('#scoreNum').textContent = '--';
  $('#barFill').style.width = '0%';
  $('#kpis').innerHTML = '';
  $('#scoreMsg').textContent = '';
  $('#diffRef').innerHTML = '';
  $('#diffHyp').innerHTML = '';
}
function resetAll(){
  resetResultOnly();
  finalText = '';
  interimText = '';
  $('#liveBox').textContent = '';
  $('#manualHyp').value = '';
  $('#finalLen').textContent = '0';
  $('#state').textContent = 'å¾…æ©Ÿ';
  setButtons();
}

/* =========================
   Scoring / Diff (word-level alignment with similarity)
========================= */
function levenshtein(a,b){
  a = a||''; b=b||'';
  const n=a.length, m=b.length;
  if(n===0) return m;
  if(m===0) return n;
  const dp = new Array(m+1);
  for(let j=0;j<=m;j++) dp[j]=j;
  for(let i=1;i<=n;i++){
    let prev = dp[0];
    dp[0]=i;
    for(let j=1;j<=m;j++){
      const tmp = dp[j];
      const cost = (a[i-1]===b[j-1]) ? 0 : 1;
      dp[j] = Math.min(
        dp[j] + 1,        // del
        dp[j-1] + 1,      // ins
        prev + cost       // sub
      );
      prev = tmp;
    }
  }
  return dp[m];
}
function wordSim(a,b){
  if(!a && !b) return 1;
  if(!a || !b) return 0;
  if(a===b) return 1;
  const maxLen = Math.max(a.length, b.length);
  if(maxLen===0) return 1;
  const d = levenshtein(a,b);
  return clamp(1 - (d/maxLen), 0, 1);
}

function alignWords(ref, hyp){
  const n = ref.length, m = hyp.length;
  // dp cost
  const dp = Array.from({length:n+1}, ()=> new Array(m+1).fill(0));
  const bt = Array.from({length:n+1}, ()=> new Array(m+1).fill(null));

  for(let i=1;i<=n;i++){ dp[i][0]=i; bt[i][0]={op:'del'}; }
  for(let j=1;j<=m;j++){ dp[0][j]=j; bt[0][j]={op:'ins'}; }

  for(let i=1;i<=n;i++){
    for(let j=1;j<=m;j++){
      const sim = wordSim(ref[i-1], hyp[j-1]);
      const subCost = 1 - sim;          // 0..1
      const delCost = 1;                // missing ref word
      const insCost = 1;                // extra hyp word

      const a = dp[i-1][j] + delCost;
      const b = dp[i][j-1] + insCost;
      const c = dp[i-1][j-1] + subCost;

      let best = c, op='sub', s=sim;
      if(a < best){ best=a; op='del'; s=0; }
      if(b < best){ best=b; op='ins'; s=0; }

      dp[i][j]=best;
      bt[i][j]={op, sim:s};
    }
  }

  // backtrack
  const ops = [];
  let i=n, j=m;
  while(i>0 || j>0){
    const step = bt[i][j] || {op: (i>0?'del':'ins'), sim:0};
    if(step.op==='sub'){
      ops.push({op:'sub', ref:ref[i-1], hyp:hyp[j-1], sim:step.sim});
      i--; j--;
    }else if(step.op==='del'){
      ops.push({op:'del', ref:ref[i-1], hyp:null, sim:0});
      i--;
    }else{
      ops.push({op:'ins', ref:null, hyp:hyp[j-1], sim:0});
      j--;
    }
  }
  ops.reverse();

  const maxLen = Math.max(n, m, 1);
  const dist = dp[n][m];
  const score = Math.round(100 * (1 - dist / maxLen));
  return { ops, dist, score: clamp(score, 0, 100) };
}

function clsBySim(sim){
  if(sim >= 0.85) return 'ok';
  if(sim >= 0.65) return 'mid';
  return 'bad';
}

function scoreMessage(score){
  if(score >= 95) return 'ğŸŸ¢ ã»ã¼å®Œç’§ã€‚è‡ªç„¶ãªé€Ÿåº¦ã§ã‚‚å´©ã‚Œã«ãã„ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚';
  if(score >= 88) return 'ğŸŸ¢ ã‹ãªã‚Šé€šã˜ã¾ã™ã€‚å¼±ã„èªï¼ˆé»„è‰²ï¼‰ã‚’æ½°ã™ã¨ã•ã‚‰ã«å®‰å®šã—ã¾ã™ã€‚';
  if(score >= 78) return 'ğŸŸ¡ æ¦‚ã­é€šã˜ã¾ã™ã€‚èµ¤ã„èªã‚’ã€Œã‚†ã£ãã‚Šãƒ»ã¯ã£ãã‚Šã€â†’é€Ÿåº¦UPãŒåŠ¹ãã¾ã™ã€‚';
  if(score >= 65) return 'ğŸŸ  è¦æ”¹å–„ã€‚æ¬ è½ï¼ˆå–ã‚Šã“ã¼ã—ï¼‰ã‚’æ¸›ã‚‰ã™ã¨ä¸€æ°—ã«ä¼¸ã³ã¾ã™ã€‚';
  return 'ğŸ”´ ã¾ãšã¯çŸ­ã„å¥ã”ã¨ã«åŒºåˆ‡ã£ã¦ã€æ­£ç¢ºã•å„ªå…ˆã§ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚';
}

function scoreAndRender(hypText){
  const r = data.find(x=>x.id===currentId);
  if(!r || !r.english) return;

  const refText = r.english;
  const refW = words(refText);
  const hypW = words(hypText);

  if(!refW.length){
    toast('ãŠæ‰‹æœ¬ã®è‹±æ–‡ãŒç©ºã§ã™');
    return;
  }

  const {ops, score} = alignWords(refW, hypW);

  // Counters
  let ok=0, mid=0, bad=0, miss=0, extra=0;
  for(const o of ops){
    if(o.op==='sub'){
      const c = clsBySim(o.sim);
      if(c==='ok') ok++;
      else if(c==='mid') mid++;
      else bad++;
    }else if(o.op==='del') miss++;
    else if(o.op==='ins') extra++;
  }

  // Render diffs
  const refHtml = [];
  const hypHtml = [];
  for(const o of ops){
    if(o.op==='sub'){
      const c = clsBySim(o.sim);
      refHtml.push(`<span class="w ${c}" title="â‰’ ${escapeHTML(o.hyp)} (${Math.round(o.sim*100)}%)">${escapeHTML(o.ref)}</span>`);
      hypHtml.push(`<span class="w ${c}" title="â‰’ ${escapeHTML(o.ref)} (${Math.round(o.sim*100)}%)">${escapeHTML(o.hyp)}</span>`);
    }else if(o.op==='del'){
      refHtml.push(`<span class="w miss" title="æ¬ è½ï¼ˆè¨€ãˆã¦ã„ãªã„å¯èƒ½æ€§ï¼‰">${escapeHTML(o.ref)}</span>`);
      // hyp: nothing
    }else{
      hypHtml.push(`<span class="w extra" title="ä½™è¨ˆï¼ˆãŠæ‰‹æœ¬ã«ãªã„èªï¼‰">${escapeHTML(o.hyp)}</span>`);
    }
  }

  $('#diffRef').innerHTML = refHtml.join(' ');
  $('#diffHyp').innerHTML = hypHtml.join(' ');

  // Score UI
  $('#scoreNum').textContent = String(score);
  $('#barFill').style.width = score + '%';

  const kpis = [
    {label:'OK', val:ok, cls:'ok'},
    {label:'è¿‘ã„', val:mid, cls:'mid'},
    {label:'é•ã†', val:bad, cls:'bad'},
    {label:'æ¬ è½', val:miss, cls:'miss'},
    {label:'ä½™è¨ˆ', val:extra, cls:'extra'},
    {label:'Words(ref)', val:refW.length, cls:'muted'}
  ];
  $('#kpis').innerHTML = kpis.map(k=>`
    <span class="badge"><span class="w ${k.cls}" style="border-color:transparent; background:transparent; padding:0; margin:0">${k.label}</span> <b>${k.val}</b></span>
  `).join('');

  $('#scoreMsg').textContent = scoreMessage(score);

  // Put hyp to manual textarea (for reuse)
  $('#manualHyp').value = hypText;

  toast(`é€šã˜ã‚‹æŒ‡æ•°ï¼š${score}/100`);
}

/* =========================
   Manual score
========================= */
$('#btn-score-manual').onclick = ()=>{
  if(!currentId){
    toast('å…ˆã«ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
    return;
  }
  const txt = ($('#manualHyp').value || '').trim();
  if(!txt){
    toast('æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™ã€‚');
    return;
  }
  stopRecognition(true);
  scoreAndRender(txt);
};

/* =========================
   File import / Demo / Clear
========================= */
$('#file-json').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0];
  ev.target.value = '';
  if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    importJson(json);
    // auto select first
    if(!currentId && data[0]) selectItem(data[0].id);
  }catch(e){
    console.error(e);
    toast('Importã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONå½¢å¼/å†…å®¹ã‚’ç¢ºèªï¼‰');
  }
});

$('#btn-demo').onclick = ()=>{
  const demo = [
    { id: uid(), scene:'Self-introduction', english:'Hello, my name is Hisashi. I work in the procurement department, and I manage capital equipment contracts.' , tags:['self-intro'], categories:['è‡ªå·±ç´¹ä»‹']},
    { id: uid(), scene:'Meeting update', english:'We understand your request, but changing the approval deadline will significantly increase schedule risk. We need an alternative plan.' , tags:['meeting'], categories:['æ„è¦‹']},
    { id: uid(), scene:'Hobby (biotope)', english:'On weekends, I enjoy gardening and building a small biotope in my backyard. It helps me relax and recharge.' , tags:['hobby'], categories:['ä¼‘æ—¥ãƒ»è¶£å‘³']},
  ];
  data = demo;
  save();
  renderList();
  selectItem(demo[0].id);
  toast('ãƒ‡ãƒ¢ä¾‹æ–‡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
};

$('#btn-clear').onclick = ()=>{
  if(!confirm('ä¿å­˜æ¸ˆã¿ã®ä¾‹æ–‡ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  stopRecognition(true);
  data = [];
  currentId = null;
  save();
  renderList();
  $('#refBox').textContent = 'å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
  resetAll();
  toast('å…¨æ¶ˆå»ã—ã¾ã—ãŸ');
};

/* =========================
   Init
========================= */
renderList();
if(data[0]) selectItem(data[0].id);
setButtons();
</script>
</body>
</html>
