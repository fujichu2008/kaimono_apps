<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no"/>
<title>SpeakJudgeï¼ˆè‹±èªç™ºè©±åˆ¤å®šï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --bg2:#0b1220;
    --card:#121826; --card2:#0f1524;
    --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --mid:#ffb020; --danger:#ff4d4f; --ghost:#76839b;
    --shadow: 0 12px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif; color:var(--ink);
    background:radial-gradient(circle at 15% 10%, rgba(123,92,255,.18), transparent 45%),
               radial-gradient(circle at 85% 20%, rgba(77,163,255,.18), transparent 50%),
               linear-gradient(var(--bg), var(--bg2));
  }
  body.modalOpen{overflow:hidden}
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(12,15,20,.88);
    backdrop-filter:saturate(1.2) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .topbar{max-width:980px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:10px;}
  .dot{
    width:18px; height:18px; border-radius:999px;
    background:radial-gradient(circle at 30% 20%, #fff, #7b5cff 40%, #2b4dff 80%);
    box-shadow:0 0 16px rgba(83,130,255,.7);
  }
  h1{margin:0; font-size:16px; letter-spacing:.03em}
  .sub{color:var(--muted); font-size:12px; margin-left:auto}
  main{max-width:980px; margin:0 auto; padding:12px 12px 60px;}
  .grid{display:grid; gap:12px;}
  @media(min-width:900px){ .grid{grid-template-columns: 360px 1fr;} }

  .card{
    background:linear-gradient(145deg, var(--card), #0c1220);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    box-shadow: var(--shadow);
  }
  .card h2{margin:0 0 8px 0; font-size:14px}
  .tiny{color:var(--muted); font-size:12px; line-height:1.55}
  .row{display:grid; gap:10px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="search"], input[type="text"], textarea, select{
    width:100%; padding:10px 11px; border-radius:12px;
    background:rgba(18,24,38,.85);
    border:1px solid var(--line);
    color:var(--ink);
    outline:none;
    font-size:15px;
  }
  textarea{min-height:120px; resize:vertical; line-height:1.6}
  .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .actions.right{justify-content:flex-end}
  .btn{
    appearance:none; border:1px solid var(--line);
    background:#10192b; color:var(--ink);
    padding:10px 12px; border-radius:14px;
    cursor:pointer; user-select:none;
    transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(255,255,255,.06)}
  .btn.pri{background:linear-gradient(180deg,#1b3b64,#10223b); border-color:#285082}
  .btn.ok{background:linear-gradient(180deg,#115a2b,#0f2e1b); border-color:#1d7a44}
  .btn.warn{background:linear-gradient(180deg,#5d430f,#2f230a); border-color:#7d5a14}
  .btn.danger{background:linear-gradient(180deg,#5a1313,#2b0f0f); border-color:#7a1d1d}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none}

  .list{
    display:grid; gap:8px;
    max-height:66vh; overflow:auto; padding-right:4px;
  }
  .item{
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 10px 9px;
    background:rgba(15,21,36,.85);
    cursor:pointer;
    transition:border-color .15s ease, transform .08s ease, box-shadow .15s ease;
  }
  .item:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(255,255,255,.06)}
  .item.active{border-color:rgba(77,163,255,.8); box-shadow:0 0 0 1px rgba(77,163,255,.35)}
  .scene{font-size:13px; font-weight:600; margin:0 0 4px 0}
  .preview{font-size:12px; color:var(--muted); margin:0}

  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(14,21,37,.85);
    font-size:12px;
    font-variant-numeric:tabular-nums;
  }

  .panel-title{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    justify-content:space-between;
    margin-bottom:8px;
  }
  .panel-title .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .panel-title .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

  .textBox{
    border:1px dashed rgba(255,255,255,.12);
    border-radius:14px;
    padding:10px 10px;
    background:rgba(10,14,24,.55);
    line-height:1.9;
    white-space:pre-wrap;
    overflow:auto;
  }
  /* 5è¡Œç¨‹åº¦å›ºå®š */
  #liveBox{
    height: 9.6em;
    max-height: 9.6em;
  }

  .diffWrap{display:grid; gap:10px}
  @media(min-width:720px){ .diffWrap{grid-template-columns:1fr 1fr;} }
  .diffCard{
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px;
    background:rgba(15,21,36,.82);
  }
  .diffCard h3{margin:0 0 6px 0; font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.03em}
  .words{line-height:2.0; word-break:break-word}
  .w{
    display:inline-block;
    padding:0 .18em;
    margin:.06em .04em;
    border-radius:.35em;
    border:1px solid transparent;
    font-variant-numeric:tabular-nums;
  }
  .w.ok{color: #dfffea; background:rgba(23,201,100,.12); border-color:rgba(23,201,100,.18)}
  .w.mid{color: #fff3d7; background:rgba(255,176,32,.13); border-color:rgba(255,176,32,.18)}
  .w.bad{color: #ffe2e2; background:rgba(255,77,79,.12); border-color:rgba(255,77,79,.18)}
  .w.miss{color: #c5ccda; background:rgba(118,131,155,.10); border-color:rgba(118,131,155,.14); text-decoration:line-through; opacity:.9}
  .w.extra{color: #fff0d2; background:rgba(255,176,32,.10); border-color:rgba(255,176,32,.16)}
  .w.muted{color:var(--muted)}

  /* clickable token (TTS) */
  .tok{
    cursor:pointer;
    border-bottom:1px dotted rgba(255,255,255,.18);
    transition: background .12s ease, border-color .12s ease, transform .08s ease;
  }
  .tok:hover{
    border-bottom-color: rgba(77,163,255,.65);
    background: rgba(77,163,255,.10);
  }
  .tok:active{ transform: translateY(1px); }

  .scoreBox{
    display:grid; gap:10px;
    grid-template-columns: 140px 1fr;
    align-items:center;
  }
  .scoreNum{
    font-size:44px; font-weight:800; letter-spacing:.02em;
    line-height:1;
  }
  .scoreLabel{font-size:12px; color:var(--muted); margin-top:4px}
  .bar{
    height:14px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(10,14,24,.55);
    overflow:hidden;
  }
  .bar > i{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg,#ff4d4f,#ffb020,#17c964,#4da3ff);
  }
  .kpis{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

  .playRow{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    margin-top:10px;
  }
  .mini{
    font-size:12px; color:var(--muted);
  }
  audio{width:min(420px, 100%); height:34px}

  .ttsRow{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    margin-top:8px;
  }
  .rangeWrap{
    display:flex; align-items:center; gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(14,21,37,.85);
  }
  input[type="range"]{ width:140px; }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px;
    background:rgba(10,14,24,.9);
    border:1px solid var(--line);
    padding:10px 12px;
    border-radius:14px;
    box-shadow: var(--shadow);
    color:var(--ink);
    font-size:13px;
    max-width:min(720px, 92vw);
    opacity:0; pointer-events:none;
    transition:opacity .2s ease, transform .2s ease;
    z-index:120;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  footer{position:fixed; left:0; right:0; bottom:6px; text-align:center; font-size:11px; color:#8591a6; pointer-events:none}
  .hr{height:1px; background:rgba(36,48,71,.9); margin:10px 0}

  /* ===== Modal (simple) ===== */
  .modal{
    position:fixed; inset:0;
    background:rgba(0,0,0,.58);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:110;
  }
  .modal.show{display:flex}
  .modalCard{
    width:min(720px, 92vw);
    border:1px solid var(--line);
    border-radius:18px;
    background:linear-gradient(145deg, var(--card), #0c1220);
    box-shadow: var(--shadow);
    padding:12px;
  }
  .modalHead{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom:8px;
  }
  .modalHead h3{margin:0; font-size:14px}
  .modalGrid{display:grid; gap:10px}
  .modalFoot{
    display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    margin-top:10px;
  }
  details{
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    background:rgba(10,14,24,.35);
    padding:8px 10px;
  }
  details > summary{
    cursor:pointer;
    color:var(--muted);
    font-size:12px;
    user-select:none;
  }
  .hintRow{
    display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;
    align-items:center;
  }
  .countPill{
    font-size:12px;
    color:var(--muted);
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(14,21,37,.85);
    font-variant-numeric:tabular-nums;
  }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="dot"></div>
    <h1>SpeakJudge</h1>
    <div class="sub">è‹±èªç™ºè©±åˆ¤å®šï¼ˆImport: SpeakNote Export JSON / å˜ç‹¬ç™»éŒ²OKï¼‰</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- Left -->
    <section class="card">
      <h2>ğŸ“š ä¾‹æ–‡ä¸€è¦§</h2>
      <div class="row">
        <div>
          <label>Importï¼ˆSpeakNote Export JSONï¼‰</label>
          <div class="actions">
            <label class="btn pri" for="file-json">JSONã‚’é¸æŠ</label>
            <input id="file-json" type="file" accept=".json" style="display:none">
            <button class="btn ok" id="btn-add">â• ä¾‹æ–‡ç™»éŒ²</button>
            <button class="btn" id="btn-demo">ãƒ‡ãƒ¢</button>
            <button class="btn danger" id="btn-clear">å…¨æ¶ˆå»</button>
          </div>
          <div class="tiny" style="margin-top:8px">
            å–ã‚Šè¾¼ã¿/ç™»éŒ²å¾Œã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚<br>
            â€» ãƒã‚¤ã‚¯åˆ©ç”¨ & éŸ³å£°èªè­˜/éŒ²éŸ³ã¯ <b>HTTPS</b>ï¼ˆã¾ãŸã¯localhostï¼‰æ¨å¥¨ã€‚
          </div>
        </div>

        <div>
          <label>æ¤œç´¢ï¼ˆScene / English / Tag / Categoryï¼‰</label>
          <input id="q" type="search" placeholder="ä¾‹ï¼šprocurement / self-intro / delivery ãªã©">
        </div>

        <div class="actions" style="justify-content:space-between">
          <span class="badge">ğŸ“š ä»¶æ•°ï¼š<b id="count">0</b></span>
          <span class="badge">ğŸ™ï¸ éŸ³å£°èªè­˜ï¼š<b id="sr-badge">åˆ¤å®šä¸­â€¦</b></span>
          <span class="badge">âºï¸ éŒ²éŸ³ï¼š<b id="rec-badge">åˆ¤å®šä¸­â€¦</b></span>
        </div>

        <div class="list" id="list"></div>
      </div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="panel-title">
        <div class="left">
          <h2 style="margin:0">ğŸ¯ ç™ºè©±åˆ¤å®š</h2>
          <span class="badge">è¨€èªï¼š
            <select id="lang" style="padding:6px 10px; border-radius:999px; font-size:12px">
              <option value="en-US" selected>en-US</option>
              <option value="en-GB">en-GB</option>
              <option value="en-AU">en-AU</option>
              <option value="en-CA">en-CA</option>
            </select>
          </span>
        </div>
        <div class="right">
          <button class="btn ghost" id="btn-edit" disabled>âœï¸ ä¾‹æ–‡</button>
          <button class="btn ok" id="btn-start">ğŸ™ï¸ ç™ºè©±é–‹å§‹</button>
          <button class="btn danger" id="btn-stop">â¹ï¸ ç™ºè©±çµ‚äº†ï¼†æ¡ç‚¹</button>
          <button class="btn" id="btn-reset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ãŠæ‰‹æœ¬ï¼ˆEnglishï¼‰â€” <span class="tiny">å˜èªã‚¯ãƒªãƒƒã‚¯ã§ç™ºè©±</span></label>
          <div id="refBox" class="textBox">å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>

          <div class="ttsRow">
            <button class="btn pri" id="btn-tts-sent" disabled>ğŸ”Š åŸæ–‡ã‚’ç™ºè©±</button>
            <button class="btn ghost" id="btn-tts-stop" disabled>â¹ ç™ºè©±åœæ­¢</button>
            <span class="rangeWrap">
              <span class="tiny">é€Ÿåº¦</span>
              <input id="ttsRate" type="range" min="0.6" max="1.4" step="0.05">
              <b id="ttsRateLabel" style="font-variant-numeric:tabular-nums">x1.00</b>
            </span>
            <span class="badge">TTSï¼š<b id="tts-badge">åˆ¤å®šä¸­â€¦</b></span>
          </div>

          <div class="tiny" style="margin-top:6px">
            ã‚³ãƒ„ï¼šè‡ªç„¶ã«èª­ã‚ã‚‹é€Ÿåº¦ã§ã€åŒºåˆ‡ã‚Šï¼ˆå¥ï¼‰ã”ã¨ã«æ¯ç¶™ãã€‚<br>
            ã€Œé€šã˜ã‚‹æŒ‡æ•°ã€ã¯ â€œå˜èªã®ä¸€è‡´åº¦ + è¿‘ã„ç™ºéŸ³(æ¨å®š) + æ¬ è½/ä½™è¨ˆãªèªã®ãƒšãƒŠãƒ«ãƒ†ã‚£â€ ã®ç›®å®‰ã§ã™ã€‚
          </div>
        </div>

        <div>
          <label>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—ãŠã“ã—ï¼ˆ5è¡Œãƒ»è¿½å°¾ï¼‰</label>
          <div id="liveBox" class="textBox"></div>
          <div class="actions" style="margin-top:8px">
            <span class="badge">çŠ¶æ…‹ï¼š<b id="state">å¾…æ©Ÿ</b></span>
            <span class="badge">æœ€çµ‚ãƒ†ã‚­ã‚¹ãƒˆï¼š<b id="finalLen">0</b> words</span>
          </div>

          <div class="hr"></div>

          <div id="scoreArea" class="card" style="box-shadow:none; padding:12px; background:rgba(15,21,36,.75)">
            <div class="scoreBox">
              <div>
                <div class="scoreNum" id="scoreNum">--</div>
                <div class="scoreLabel">é€šã˜ã‚‹æŒ‡æ•°ï¼ˆ/100ï¼‰</div>
              </div>
              <div>
                <div class="bar"><i id="barFill"></i></div>
                <div class="kpis" id="kpis"></div>

                <div class="playRow">
                  <button class="btn pri" id="btn-play" disabled>â–¶ è‡ªåˆ†ã®ç™ºè©±ã‚’å†ç”Ÿ</button>
                  <button class="btn ghost" id="btn-clear-audio" disabled>ğŸ—‘ï¸ éŒ²éŸ³ã‚’ç ´æ£„</button>
                  <span class="badge">âºï¸ éŒ²éŸ³çŠ¶æ…‹ï¼š<b id="recState">ãªã—</b></span>
                </div>
                <audio id="audio" controls style="display:none"></audio>
                <div class="mini" id="playHint">ï¼ˆç™ºè©±é–‹å§‹ã¨åŒæ™‚ã«éŒ²éŸ³ã—ã€çµ‚äº†ã§åœæ­¢ã—ã¾ã™ã€‚ã‚»ãƒ³ãƒ†ãƒ³ã‚¹å¤‰æ›´ã§éŒ²éŸ³ã¯è‡ªå‹•ç ´æ£„ã•ã‚Œã¾ã™ã€‚ï¼‰</div>
              </div>
            </div>

            <div class="tiny" id="scoreMsg" style="margin-top:10px"></div>
          </div>

          <div class="hr"></div>

          <div class="diffWrap">
            <div class="diffCard">
              <h3>Originalï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å˜èªç™ºè©±ï¼‰</h3>
              <div class="words" id="diffRef"></div>
            </div>
            <div class="diffCard">
              <h3>Recognizedï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å˜èªç™ºè©±ï¼‰</h3>
              <div class="words" id="diffHyp"></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>
</main>

<!-- ===== Popup: Add/Edit sentence ===== -->
<div class="modal" id="sentModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="sentTitle">
    <div class="modalHead">
      <h3 id="sentTitle">â• ä¾‹æ–‡ç™»éŒ²</h3>
      <button class="btn ghost" id="btn-modal-x">âœ•</button>
    </div>

    <div class="modalGrid">
      <div>
        <label>å ´é¢ï¼ˆSceneï¼‰</label>
        <input id="mScene" type="text" placeholder="ä¾‹ï¼šMeeting update / Delivery terms / Self-introduction">
      </div>

      <div>
        <div class="hintRow">
          <label style="margin:0">è‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰</label>
          <span class="countPill" id="mCount">0 chars</span>
        </div>
        <textarea id="mEnglish" placeholder="ä¾‹ï¼šWe need to confirm the delivery schedule before issuing the purchase order."></textarea>
      </div>

      <details>
        <summary>ä»»æ„ï¼ˆTag / Categoryï¼‰</summary>
        <div style="margin-top:8px; display:grid; gap:10px">
          <div>
            <label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="mTags" type="text" placeholder="ä¾‹ï¼šprocurement, meeting, delivery">
          </div>
          <div>
            <label>ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="mCats" type="text" placeholder="ä¾‹ï¼šè‡ªå·±ç´¹ä»‹, æ„è¦‹, ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç·´ç¿’">
          </div>
          <div class="tiny">
            â€» ã‚¿ã‚°/ã‚«ãƒ†ã‚´ãƒªã¯æ¤œç´¢ã«ä½¿ãˆã¾ã™ï¼ˆSpeakNoteäº’æ›ã®ãŸã‚ã«ä¿æŒï¼‰ã€‚
          </div>
        </div>
      </details>

      <div class="tiny">
        ãƒ’ãƒ³ãƒˆï¼šçŸ­ãã¦ã‚‚OKã€‚ã¾ãšç™»éŒ²â†’å¾Œã§å¢—ã‚„ã™ã€ãŒé€Ÿã„ã§ã™ã€‚
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn danger" id="btn-modal-del" style="display:none">ğŸ—‘ï¸ å‰Šé™¤</button>
      <button class="btn" id="btn-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn pri" id="btn-modal-save">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<footer>(C)Hisashi Fujinaka All Rights Reserved. All Code is generated by AI.</footer>

<script>
/* =========================
   Utilities
========================= */
const $ = s => document.querySelector(s);
const LS_KEY = 'speakjudge_sentences_v1';
const LS_TTS_RATE = 'speakjudge_tts_rate_v1';

function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function toast(msg){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.classList.remove('show'), 2200);
}
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function parseCsv(s){
  return (s||'')
    .split(',')
    .map(x=>x.trim())
    .filter(Boolean);
}

/* =========================
   Text normalize
========================= */
function normalizeText(s){
  s = (s || '').toString();
  s = s.replace(/[â€œâ€]/g,'"').replace(/[â€™]/g,"'").replace(/[â€˜]/g,"'");
  s = s.replace(/[-â€-â€“â€”]/g, ' ');
  s = s.replace(/[^A-Za-z0-9'\s]/g, ' ');
  s = s.replace(/\s+/g,' ').trim().toLowerCase();
  return s;
}
function words(s){
  const n = normalizeText(s);
  if(!n) return [];
  return n.split(' ').filter(Boolean);
}

/* =========================
   Storage / Import
========================= */
let data = loadSaved();
let currentId = null;

function loadSaved(){
  try{
    const raw = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    return Array.isArray(raw) ? raw : [];
  }catch(e){ return []; }
}
function save(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch(_){}
}
function uid(){ return (crypto?.randomUUID?.() || ('id_'+Math.random().toString(16).slice(2))); }

function extractRows(json){
  if(Array.isArray(json)) return json;
  if(json && Array.isArray(json.items)) return json.items;
  if(json && Array.isArray(json.sentences)) return json.sentences;
  if(json && Array.isArray(json.rows)) return json.rows;
  if(json && json.data && Array.isArray(json.data)) return json.data;
  if(json && json.payload && Array.isArray(json.payload)) return json.payload;
  return [];
}
function mapRow(r){
  const english = (r.english ?? r.en ?? r.text ?? r.sentence ?? r.content ?? '').toString();
  const scene = (r.scene ?? r.title ?? r.context ?? r.situation ?? '').toString();
  const tags = Array.isArray(r.tags) ? r.tags.map(String) : (typeof r.tags === 'string' ? r.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);
  const categories = Array.isArray(r.categories) ? r.categories.map(String) : (Array.isArray(r.cats) ? r.cats.map(String) : []);
  const id = (r.id ? String(r.id) : uid());
  return { id, scene, english, tags, categories, _src:r };
}
function importJson(json){
  const rows = extractRows(json).map(mapRow).filter(x => x.english && x.english.trim());
  if(!rows.length) throw new Error('no_rows');
  const byId = new Map(data.map(x => [x.id, x]));
  for(const r of rows){ byId.set(r.id, r); }
  data = Array.from(byId.values());
  save();
  renderList();
  toast(`Importå®Œäº†ï¼š${rows.length}ä»¶ï¼ˆåˆè¨ˆ ${data.length}ä»¶ï¼‰`);
}

/* =========================
   Popup (Add/Edit)
========================= */
const modal = $('#sentModal');
function openModal(mode, editId=null){
  // mode: 'add' | 'edit'
  modal.dataset.mode = mode;
  modal.dataset.editId = editId || '';

  const isEdit = mode === 'edit' && !!editId;
  $('#sentTitle').textContent = isEdit ? 'âœï¸ ä¾‹æ–‡ã‚’ç·¨é›†' : 'â• ä¾‹æ–‡ç™»éŒ²';
  $('#btn-modal-del').style.display = isEdit ? 'inline-flex' : 'none';

  if(isEdit){
    const r = data.find(x=>x.id===editId);
    $('#mScene').value = (r?.scene || '');
    $('#mEnglish').value = (r?.english || '');
    $('#mTags').value = (r?.tags || []).join(', ');
    $('#mCats').value = (r?.categories || []).join(', ');
  }else{
    $('#mScene').value = '';
    $('#mEnglish').value = '';
    $('#mTags').value = '';
    $('#mCats').value = '';
  }
  updateModalCount();

  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
  document.body.classList.add('modalOpen');

  setTimeout(()=>$('#mScene').focus(), 0);
}
function closeModal(){
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
  document.body.classList.remove('modalOpen');
}
function updateModalCount(){
  const n = ($('#mEnglish').value || '').length;
  $('#mCount').textContent = `${n} chars`;
}
$('#mEnglish').addEventListener('input', updateModalCount);

$('#btn-modal-x').onclick = closeModal;
$('#btn-modal-cancel').onclick = closeModal;
modal.addEventListener('click', (ev)=>{
  if(ev.target === modal) closeModal();
});
document.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape' && modal.classList.contains('show')) closeModal();
});

function upsertSentenceFromModal(){
  const sceneRaw = ($('#mScene').value || '').trim();
  const englishRaw = ($('#mEnglish').value || '').trim();
  const tags = parseCsv($('#mTags').value);
  const categories = parseCsv($('#mCats').value);

  if(!englishRaw){
    toast('è‹±èªä¾‹æ–‡ï¼ˆEnglishï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    $('#mEnglish').focus();
    return;
  }
  const scene = sceneRaw || 'General';

  const mode = modal.dataset.mode || 'add';
  const editId = modal.dataset.editId || '';

  if(mode === 'edit' && editId){
    const idx = data.findIndex(x=>x.id===editId);
    if(idx >= 0){
      data[idx] = { ...data[idx], scene, english: englishRaw, tags, categories };
      save();
      renderList();
      if(currentId === editId) renderReferenceText(englishRaw);
      toast('æ›´æ–°ã—ã¾ã—ãŸ');
      closeModal();
      return;
    }
  }

  const id = uid();
  const row = { id, scene, english: englishRaw, tags, categories };
  data.push(row);
  save();
  renderList();
  selectItem(id);
  toast('ç™»éŒ²ã—ã¾ã—ãŸ');
  closeModal();
}

function deleteSentenceFromModal(){
  const editId = modal.dataset.editId || '';
  if(!editId) return;
  const r = data.find(x=>x.id===editId);
  const title = r?.scene ? `ã€Œ${r.scene}ã€` : 'ã“ã®ä¾‹æ–‡';
  if(!confirm(`${title} ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  stopRecognition(true);
  clearRecording(true);
  stopSpeech();

  data = data.filter(x=>x.id !== editId);
  save();

  if(currentId === editId){
    currentId = null;
    $('#refBox').textContent = 'å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
    resetAll();
  }
  renderList();
  if(!currentId && data[0]) selectItem(data[0].id);

  toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  closeModal();
}

$('#btn-modal-save').onclick = upsertSentenceFromModal;
$('#btn-modal-del').onclick = deleteSentenceFromModal;

/* =========================
   List UI
========================= */
function renderList(){
  const q = ($('#q').value || '').trim().toLowerCase();
  const root = $('#list');
  root.innerHTML = '';
  const filtered = data
    .filter(r=>{
      if(!q) return true;
      const hay = [
        r.scene||'',
        r.english||'',
        (r.tags||[]).join(' '),
        (r.categories||[]).join(' ')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    })
    .sort((a,b)=> (a.scene||'').localeCompare(b.scene||''));

  $('#count').textContent = filtered.length;

  if(!filtered.length){
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<p class="scene">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p><p class="preview">ã€ŒJSONã‚’é¸æŠã€ã¾ãŸã¯ã€Œä¾‹æ–‡ç™»éŒ²ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>`;
    root.appendChild(div);
    return;
  }

  for(const r of filtered){
    const div = document.createElement('div');
    div.className = 'item' + (r.id === currentId ? ' active' : '');
    const prev = (r.english||'').replace(/\s+/g,' ').trim().slice(0, 90);
    div.innerHTML = `
      <p class="scene">${escapeHTML(r.scene || 'ï¼ˆSceneãªã—ï¼‰')}</p>
      <p class="preview">${escapeHTML(prev)}${(r.english||'').length>90?'â€¦':''}</p>
    `;
    div.onclick = ()=> selectItem(r.id);
    root.appendChild(div);
  }
}
$('#q').addEventListener('input', renderList);

/* =========================
   TTS (word click + sentence speak + speed)
========================= */
const hasTTS = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
let ttsUnlocked = false;
let voicesCache = [];
let speaking = false;

function updateTtsBadge(){
  $('#tts-badge').textContent = hasTTS ? 'å¯¾å¿œ' : 'éå¯¾å¿œ';
}
updateTtsBadge();

function loadVoices(){
  if(!hasTTS) return [];
  const v = speechSynthesis.getVoices() || [];
  voicesCache = v;
  return v;
}
if(hasTTS){
  loadVoices();
  speechSynthesis.onvoiceschanged = ()=>loadVoices();
}

function pickVoice(lang){
  if(!hasTTS) return null;
  const v = voicesCache?.length ? voicesCache : loadVoices();
  if(!v?.length) return null;
  const ll = (lang || 'en-US').toLowerCase();

  // iOS: Samanthaå„ªå…ˆ
  const iosSamantha = v.find(x => (x.lang||'').toLowerCase().startsWith(ll.slice(0,2)) && /samantha/i.test(x.name||''));
  if(iosSamantha) return iosSamantha;

  // en-USå„ªå…ˆ
  const exact = v.find(x => (x.lang||'').toLowerCase() === ll);
  if(exact) return exact;

  // enç³»
  const en = v.find(x => (x.lang||'').toLowerCase().startsWith('en'));
  return en || v[0];
}

function ttsRate(){
  const r = parseFloat($('#ttsRate').value || '1');
  return clamp(isFinite(r)?r:1, 0.6, 1.4);
}

function ensureTtsUnlocked(){
  if(!hasTTS) return false;
  if(ttsUnlocked) return true;

  // iOSå‘ã‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å†…ã§çŸ­ã„ç™ºè©±ã‚’1å›ã ã‘
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance('ok');
    u.lang = $('#lang').value || 'en-US';
    u.voice = pickVoice(u.lang);
    u.rate = 1.0;
    u.volume = 0.05;
    speechSynthesis.speak(u);
    setTimeout(()=>speechSynthesis.cancel(), 120);
    ttsUnlocked = true;
    return true;
  }catch(e){
    return false;
  }
}

function stopSpeech(){
  if(!hasTTS) return;
  try{ speechSynthesis.cancel(); }catch(_){}
  speaking = false;
  $('#btn-tts-stop').disabled = true;
}

function speakText(text){
  if(!hasTTS) { toast('ã“ã®ç’°å¢ƒã¯TTSéå¯¾å¿œã§ã™'); return; }
  if(!text || !text.trim()) return;

  ensureTtsUnlocked();

  stopSpeech();
  const u = new SpeechSynthesisUtterance(text.trim());
  u.lang = $('#lang').value || 'en-US';
  u.voice = pickVoice(u.lang);
  u.rate = ttsRate();
  u.pitch = 1.0;
  u.onstart = ()=>{ speaking = true; $('#btn-tts-stop').disabled = false; };
  u.onend = ()=>{ speaking = false; $('#btn-tts-stop').disabled = true; };
  u.onerror = ()=>{ speaking = false; $('#btn-tts-stop').disabled = true; };
  try{
    speechSynthesis.speak(u);
  }catch(e){
    toast('TTSå†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/* ---- clickable word token rendering ---- */
function tokenizeForDisplay(s){
  // keep punctuation as plain text nodes; words become clickable spans
  // word: letters/numbers/apostrophe
  const parts = [];
  let i=0;
  while(i < s.length){
    const ch = s[i];
    const isWordChar = /[A-Za-z0-9']/;
    if(isWordChar.test(ch)){
      let j=i+1;
      while(j < s.length && isWordChar.test(s[j])) j++;
      parts.push({type:'word', text:s.slice(i,j)});
      i = j;
    }else{
      let j=i+1;
      while(j < s.length && !isWordChar.test(s[j])) j++;
      parts.push({type:'sep', text:s.slice(i,j)});
      i = j;
    }
  }
  return parts;
}
function renderReferenceText(english){
  const box = $('#refBox');
  if(!english){ box.textContent = 'å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'; return; }
  const parts = tokenizeForDisplay(english);
  const html = parts.map(p=>{
    if(p.type==='word'){
      const safe = escapeHTML(p.text);
      return `<span class="tok" data-say="${safe}" title="click to speak">${safe}</span>`;
    }
    return escapeHTML(p.text);
  }).join('');
  box.innerHTML = html;
}

/* word click delegation (ref + diffs) */
function normalizeSpeakWord(w){
  const s = (w||'').toString().trim();
  if(!s) return '';
  return s;
}
document.addEventListener('click', (ev)=>{
  const t = ev.target;
  if(!(t instanceof HTMLElement)) return;
  const say = t.getAttribute('data-say');
  if(!say) return;
  const w = normalizeSpeakWord(say);
  if(!w) return;
  speakText(w);
});

/* =========================
   Selection
========================= */
function selectItem(id){
  const r = data.find(x=>x.id===id);
  if(!r) return;
  currentId = id;

  clearRecording(true);
  stopRecognition(true);
  stopSpeech();

  resetResultOnly();
  renderReferenceText((r.english||'').trim());
  $('#liveBox').textContent = '';
  $('#state').textContent = 'å¾…æ©Ÿ';
  $('#finalLen').textContent = '0';

  $('#btn-tts-sent').disabled = false;
  $('#btn-tts-stop').disabled = true;

  renderList();
  setButtons();
  toast('ä¾‹æ–‡ã‚’é¸æŠã—ã¾ã—ãŸ');
}

/* =========================
   Speech Recognition
========================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
let listening = false;
let stopRequested = false;
let finalText = '';
let interimText = '';

function srSupported(){ return !!SpeechRecognition; }
function updateSrBadge(){
  $('#sr-badge').textContent = srSupported() ? 'å¯¾å¿œï¼ˆChromeæ¨å¥¨ï¼‰' : 'éå¯¾å¿œ';
}
updateSrBadge();

/* =========================
   Recording (MediaRecorder)
========================= */
let mediaStream = null;
let mediaRecorder = null;
let audioChunks = [];
let audioUrl = null;
let audioReady = false;

function recSupported(){
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.MediaRecorder);
}
function pickAudioMime(){
  const cands = [
    'audio/webm;codecs=opus',
    'audio/webm',
    'audio/mp4',
    'audio/ogg;codecs=opus',
    'audio/ogg'
  ];
  for(const m of cands){
    try{
      if(MediaRecorder.isTypeSupported(m)) return m;
    }catch(_){}
  }
  return '';
}
function updateRecBadge(){
  $('#rec-badge').textContent = recSupported() ? 'å¯¾å¿œ' : 'éå¯¾å¿œ';
}
updateRecBadge();

function setRecUI(stateText){
  $('#recState').textContent = stateText;
  const btnPlay = $('#btn-play');
  const btnClear = $('#btn-clear-audio');
  btnPlay.disabled = !audioReady;
  btnClear.disabled = !audioReady;
  $('#audio').style.display = audioReady ? 'block' : 'none';
}

function clearRecording(silent=false){
  try{
    if(mediaRecorder && mediaRecorder.state !== 'inactive'){
      mediaRecorder.ondataavailable = null;
      mediaRecorder.onstop = null;
      mediaRecorder.stop();
    }
  }catch(_){}
  mediaRecorder = null;
  audioChunks = [];
  audioReady = false;

  if(audioUrl){
    try{ URL.revokeObjectURL(audioUrl); }catch(_){}
    audioUrl = null;
  }
  const a = $('#audio');
  a.pause();
  a.removeAttribute('src');
  a.load();

  if(mediaStream){
    try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
    mediaStream = null;
  }
  setRecUI('ãªã—');
  if(!silent) toast('éŒ²éŸ³ã‚’ç ´æ£„ã—ã¾ã—ãŸ');
}

async function startRecording(){
  clearRecording(true);
  if(!recSupported()){
    setRecUI('éå¯¾å¿œ');
    return false;
  }
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  }catch(e){
    setRecUI('æ¨©é™ãªã—');
    return false;
  }

  audioChunks = [];
  const mime = pickAudioMime();
  try{
    mediaRecorder = mime ? new MediaRecorder(mediaStream, { mimeType: mime }) : new MediaRecorder(mediaStream);
  }catch(e){
    try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
    mediaStream = null;
    setRecUI('å¤±æ•—');
    return false;
  }

  mediaRecorder.ondataavailable = (ev)=>{
    if(ev.data && ev.data.size > 0) audioChunks.push(ev.data);
  };
  mediaRecorder.onstop = ()=>{
    try{
      const blob = new Blob(audioChunks, { type: mediaRecorder?.mimeType || 'audio/webm' });
      audioUrl = URL.createObjectURL(blob);
      const a = $('#audio');
      a.src = audioUrl;
      audioReady = true;
      setRecUI('éŒ²éŸ³ã‚ã‚Š');
    }catch(e){
      audioReady = false;
      setRecUI('å¤±æ•—');
    }finally{
      if(mediaStream){
        try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
        mediaStream = null;
      }
    }
  };

  try{
    mediaRecorder.start(200);
    setRecUI('éŒ²éŸ³ä¸­');
    return true;
  }catch(e){
    setRecUI('å¤±æ•—');
    try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
    mediaStream = null;
    mediaRecorder = null;
    return false;
  }
}
function stopRecording(){
  if(mediaRecorder && mediaRecorder.state !== 'inactive'){
    try{ mediaRecorder.stop(); }catch(_){}
  }else{
    if(mediaStream){
      try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      mediaStream = null;
    }
  }
}

/* =========================
   Buttons enable/disable
========================= */
function setButtons(){
  $('#btn-start').disabled = !currentId || listening || !srSupported();
  $('#btn-stop').disabled  = !currentId || !listening || !srSupported();
  $('#btn-tts-sent').disabled = !currentId || !hasTTS;
  $('#btn-tts-stop').disabled = !speaking;
  $('#btn-edit').disabled = !currentId;
}
setButtons();

/* =========================
   Recognizer lifecycle
========================= */
function createRecognizer(){
  const r = new SpeechRecognition();
  r.lang = $('#lang').value || 'en-US';
  r.interimResults = true;
  r.continuous = true;

  r.onresult = (ev)=>{
    let finalBuf = finalText;
    let interimBuf = '';

    for(let i=ev.resultIndex; i<ev.results.length; i++){
      const res = ev.results[i];
      const txt = (res[0]?.transcript || '').trim();
      if(!txt) continue;
      if(res.isFinal) finalBuf = (finalBuf + ' ' + txt).trim();
      else interimBuf = (interimBuf + ' ' + txt).trim();
    }
    finalText = finalBuf;
    interimText = interimBuf;

    const combined = (finalText + ' ' + interimText).trim();
    const live = $('#liveBox');
    live.textContent = combined;
    live.scrollTop = live.scrollHeight;
    $('#finalLen').textContent = String(words(finalText).length);
  };

  r.onerror = (ev)=>{
    const msg = ev?.error ? `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${ev.error}` : 'éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼';
    toast(msg);
    $('#state').textContent = 'ã‚¨ãƒ©ãƒ¼';
    listening = false;
    setButtons();
    stopRecording();
  };

  r.onend = ()=>{
    const wasStop = stopRequested;
    stopRequested = false;
    listening = false;
    setButtons();

    if(wasStop){
      const hyp = (finalText || $('#liveBox').textContent || '').trim();
      if(!hyp){
        toast('èªè­˜çµæœãŒç©ºã§ã™ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
        $('#state').textContent = 'å¾…æ©Ÿ';
        return;
      }
      $('#state').textContent = 'æ¡ç‚¹ä¸­â€¦';
      setTimeout(()=>{
        scoreAndRender(hyp);
        $('#state').textContent = 'å¾…æ©Ÿ';
      }, 60);
    }else{
      $('#state').textContent = 'å¾…æ©Ÿ';
    }
  };

  return r;
}

async function startRecognition(){
  if(!srSupported()){
    toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™ã€‚');
    return;
  }
  if(!currentId){
    toast('å…ˆã«ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
    return;
  }

  ensureTtsUnlocked();
  stopRecognition(true);
  resetResultOnly();

  finalText = '';
  interimText = '';
  $('#liveBox').textContent = '';
  $('#finalLen').textContent = '0';
  $('#state').textContent = 'æº–å‚™ä¸­â€¦';

  await startRecording();

  rec = createRecognizer();
  listening = true;
  stopRequested = false;
  setButtons();

  try{
    rec.start();
    $('#state').textContent = 'è´å–ä¸­â€¦';
    toast('ç™ºè©±ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆéŒ²éŸ³ã‚‚é–‹å§‹ï¼‰');
  }catch(e){
    listening = false;
    setButtons();
    $('#state').textContent = 'å¾…æ©Ÿ';
    toast('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/HTTPS/ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œã‚’ç¢ºèªï¼‰');
    stopRecording();
  }
}

function stopRecognition(silent=false){
  if(rec){
    try{ rec.onresult = rec.onerror = rec.onend = null; }catch(_){}
    try{ rec.stop(); }catch(_){}
    rec = null;
  }
  listening = false;
  stopRequested = false;
  setButtons();
  if(!silent) toast('åœæ­¢ã—ã¾ã—ãŸ');
}

function stopAndScore(){
  if(!rec || !listening){
    toast('ç™ºè©±ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  stopRequested = true;
  $('#state').textContent = 'åœæ­¢ä¸­â€¦';

  stopRecording();
  try{
    rec.stop();
  }catch(_){
    const hyp = (finalText || $('#liveBox').textContent || '').trim();
    if(hyp){
      scoreAndRender(hyp);
      $('#state').textContent = 'å¾…æ©Ÿ';
    }
    listening = false;
    setButtons();
  }
}

$('#lang').addEventListener('change', ()=>{
  if(listening){
    toast('è¨€èªè¨­å®šã‚’åæ˜ ã™ã‚‹ãŸã‚ã€ã„ã£ãŸã‚“åœæ­¢ã—ã¾ã™');
    stopAndScore();
  }
});

$('#btn-start').onclick = startRecognition;
$('#btn-stop').onclick  = stopAndScore;
$('#btn-reset').onclick = ()=>{
  stopRecognition(true);
  clearRecording(true);
  stopSpeech();
  resetAll();
  toast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
};

/* =========================
   Edit/Add buttons
========================= */
$('#btn-add').onclick = ()=>{
  ensureTtsUnlocked();
  openModal('add');
};
$('#btn-edit').onclick = ()=>{
  if(!currentId) return;
  ensureTtsUnlocked();
  openModal('edit', currentId);
};

/* =========================
   TTS UI
========================= */
$('#btn-tts-sent').onclick = ()=>{
  const r = data.find(x=>x.id===currentId);
  if(!r?.english) return;
  speakText(r.english);
};
$('#btn-tts-stop').onclick = ()=> stopSpeech();

/* speed */
(function initTtsRate(){
  const saved = parseFloat(localStorage.getItem(LS_TTS_RATE) || '1');
  const v = clamp(isFinite(saved)?saved:1, 0.6, 1.4);
  $('#ttsRate').value = String(v);
  $('#ttsRateLabel').textContent = 'x' + v.toFixed(2);
})();
$('#ttsRate').addEventListener('input', ()=>{
  const v = ttsRate();
  $('#ttsRateLabel').textContent = 'x' + v.toFixed(2);
});
$('#ttsRate').addEventListener('change', ()=>{
  const v = ttsRate();
  try{ localStorage.setItem(LS_TTS_RATE, String(v)); }catch(_){}
});

/* =========================
   Playback controls (recording)
========================= */
$('#btn-play').onclick = ()=>{
  const a = $('#audio');
  if(!audioReady || !a.src){
    toast('éŒ²éŸ³ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  if(a.paused){
    a.play().catch(()=>toast('å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ'));
    $('#btn-play').textContent = 'â¸ å†ç”Ÿåœæ­¢';
  }else{
    a.pause();
    $('#btn-play').textContent = 'â–¶ è‡ªåˆ†ã®ç™ºè©±ã‚’å†ç”Ÿ';
  }
};
$('#audio').addEventListener('ended', ()=>{
  $('#btn-play').textContent = 'â–¶ è‡ªåˆ†ã®ç™ºè©±ã‚’å†ç”Ÿ';
});
$('#btn-clear-audio').onclick = ()=>{
  clearRecording(false);
  $('#btn-play').textContent = 'â–¶ è‡ªåˆ†ã®ç™ºè©±ã‚’å†ç”Ÿ';
};

/* =========================
   Reset UI
========================= */
function resetResultOnly(){
  $('#scoreNum').textContent = '--';
  $('#barFill').style.width = '0%';
  $('#kpis').innerHTML = '';
  $('#scoreMsg').textContent = '';
  $('#diffRef').innerHTML = '';
  $('#diffHyp').innerHTML = '';
  $('#btn-play').textContent = 'â–¶ è‡ªåˆ†ã®ç™ºè©±ã‚’å†ç”Ÿ';
}
function resetAll(){
  resetResultOnly();
  finalText = '';
  interimText = '';
  $('#liveBox').textContent = '';
  $('#finalLen').textContent = '0';
  $('#state').textContent = 'å¾…æ©Ÿ';
  setButtons();
  setRecUI(audioReady ? 'éŒ²éŸ³ã‚ã‚Š' : 'ãªã—');
}

/* =========================
   Scoring / Diff
========================= */
function levenshtein(a,b){
  a = a||''; b=b||'';
  const n=a.length, m=b.length;
  if(n===0) return m;
  if(m===0) return n;
  const dp = new Array(m+1);
  for(let j=0;j<=m;j++) dp[j]=j;
  for(let i=1;i<=n;i++){
    let prev = dp[0];
    dp[0]=i;
    for(let j=1;j<=m;j++){
      const tmp = dp[j];
      const cost = (a[i-1]===b[j-1]) ? 0 : 1;
      dp[j] = Math.min(
        dp[j] + 1,
        dp[j-1] + 1,
        prev + cost
      );
      prev = tmp;
    }
  }
  return dp[m];
}
function wordSim(a,b){
  if(!a && !b) return 1;
  if(!a || !b) return 0;
  if(a===b) return 1;
  const maxLen = Math.max(a.length, b.length);
  if(maxLen===0) return 1;
  const d = levenshtein(a,b);
  return clamp(1 - (d/maxLen), 0, 1);
}
function alignWords(ref, hyp){
  const n = ref.length, m = hyp.length;
  const dp = Array.from({length:n+1}, ()=> new Array(m+1).fill(0));
  const bt = Array.from({length:n+1}, ()=> new Array(m+1).fill(null));

  for(let i=1;i<=n;i++){ dp[i][0]=i; bt[i][0]={op:'del'}; }
  for(let j=1;j<=m;j++){ dp[0][j]=j; bt[0][j]={op:'ins'}; }

  for(let i=1;i<=n;i++){
    for(let j=1;j<=m;j++){
      const sim = wordSim(ref[i-1], hyp[j-1]);
      const subCost = 1 - sim;
      const delCost = 1;
      const insCost = 1;

      const a = dp[i-1][j] + delCost;
      const b = dp[i][j-1] + insCost;
      const c = dp[i-1][j-1] + subCost;

      let best = c, op='sub', s=sim;
      if(a < best){ best=a; op='del'; s=0; }
      if(b < best){ best=b; op='ins'; s=0; }

      dp[i][j]=best;
      bt[i][j]={op, sim:s};
    }
  }

  const ops = [];
  let i=n, j=m;
  while(i>0 || j>0){
    const step = bt[i][j] || {op: (i>0?'del':'ins'), sim:0};
    if(step.op==='sub'){
      ops.push({op:'sub', ref:ref[i-1], hyp:hyp[j-1], sim:step.sim});
      i--; j--;
    }else if(step.op==='del'){
      ops.push({op:'del', ref:ref[i-1], hyp:null, sim:0});
      i--;
    }else{
      ops.push({op:'ins', ref:null, hyp:hyp[j-1], sim:0});
      j--;
    }
  }
  ops.reverse();

  const maxLen = Math.max(n, m, 1);
  const dist = dp[n][m];
  const score = Math.round(100 * (1 - dist / maxLen));
  return { ops, dist, score: clamp(score, 0, 100) };
}
function clsBySim(sim){
  if(sim >= 0.85) return 'ok';
  if(sim >= 0.65) return 'mid';
  return 'bad';
}
function scoreMessage(score){
  if(score >= 95) return 'ğŸŸ¢ ã»ã¼å®Œç’§ã€‚è‡ªç„¶ãªé€Ÿåº¦ã§ã‚‚å´©ã‚Œã«ãã„ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚';
  if(score >= 88) return 'ğŸŸ¢ ã‹ãªã‚Šé€šã˜ã¾ã™ã€‚å¼±ã„èªï¼ˆé»„è‰²ï¼‰ã‚’æ½°ã™ã¨ã•ã‚‰ã«å®‰å®šã—ã¾ã™ã€‚';
  if(score >= 78) return 'ğŸŸ¡ æ¦‚ã­é€šã˜ã¾ã™ã€‚èµ¤ã„èªã‚’ã€Œã‚†ã£ãã‚Šãƒ»ã¯ã£ãã‚Šã€â†’é€Ÿåº¦UPãŒåŠ¹ãã¾ã™ã€‚';
  if(score >= 65) return 'ğŸŸ  è¦æ”¹å–„ã€‚æ¬ è½ï¼ˆå–ã‚Šã“ã¼ã—ï¼‰ã‚’æ¸›ã‚‰ã™ã¨ä¸€æ°—ã«ä¼¸ã³ã¾ã™ã€‚';
  return 'ğŸ”´ ã¾ãšã¯çŸ­ã„å¥ã”ã¨ã«åŒºåˆ‡ã£ã¦ã€æ­£ç¢ºã•å„ªå…ˆã§ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚';
}
function scoreAndRender(hypText){
  const r = data.find(x=>x.id===currentId);
  if(!r || !r.english) return;

  const refText = r.english;
  const refW = words(refText);
  const hypW = words(hypText);

  if(!refW.length){
    toast('ãŠæ‰‹æœ¬ã®è‹±æ–‡ãŒç©ºã§ã™');
    return;
  }

  const {ops, score} = alignWords(refW, hypW);

  let ok=0, mid=0, bad=0, miss=0, extra=0;
  for(const o of ops){
    if(o.op==='sub'){
      const c = clsBySim(o.sim);
      if(c==='ok') ok++;
      else if(c==='mid') mid++;
      else bad++;
    }else if(o.op==='del') miss++;
    else if(o.op==='ins') extra++;
  }

  const refHtml = [];
  const hypHtml = [];
  for(const o of ops){
    if(o.op==='sub'){
      const c = clsBySim(o.sim);
      const refSafe = escapeHTML(o.ref);
      const hypSafe = escapeHTML(o.hyp);
      refHtml.push(`<span class="w ${c} tok" data-say="${refSafe}" title="click to speak">${refSafe}</span>`);
      hypHtml.push(`<span class="w ${c} tok" data-say="${hypSafe}" title="click to speak">${hypSafe}</span>`);
    }else if(o.op==='del'){
      const refSafe = escapeHTML(o.ref);
      refHtml.push(`<span class="w miss tok" data-say="${refSafe}" title="click to speak">${refSafe}</span>`);
    }else{
      const hypSafe = escapeHTML(o.hyp);
      hypHtml.push(`<span class="w extra tok" data-say="${hypSafe}" title="click to speak">${hypSafe}</span>`);
    }
  }

  $('#diffRef').innerHTML = refHtml.join(' ');
  $('#diffHyp').innerHTML = hypHtml.join(' ');

  $('#scoreNum').textContent = String(score);
  $('#barFill').style.width = score + '%';

  const kpis = [
    {label:'OK', val:ok, cls:'ok'},
    {label:'è¿‘ã„', val:mid, cls:'mid'},
    {label:'é•ã†', val:bad, cls:'bad'},
    {label:'æ¬ è½', val:miss, cls:'miss'},
    {label:'ä½™è¨ˆ', val:extra, cls:'extra'},
    {label:'Words(ref)', val:refW.length, cls:'muted'}
  ];
  $('#kpis').innerHTML = kpis.map(k=>`
    <span class="badge"><span class="w ${k.cls}" style="border-color:transparent; background:transparent; padding:0; margin:0">${k.label}</span> <b>${k.val}</b></span>
  `).join('');

  $('#scoreMsg').textContent = scoreMessage(score);
  toast(`é€šã˜ã‚‹æŒ‡æ•°ï¼š${score}/100`);
}

/* =========================
   File import / Demo / Clear
========================= */
$('#file-json').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0];
  ev.target.value = '';
  if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    importJson(json);
    if(!currentId && data[0]) selectItem(data[0].id);
  }catch(e){
    console.error(e);
    toast('Importã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONå½¢å¼/å†…å®¹ã‚’ç¢ºèªï¼‰');
  }
});

$('#btn-demo').onclick = ()=>{
  const demo = [
    { id: uid(), scene:'Self-introduction', english:'Hello, my name is Hisashi. I work in the procurement department, and I manage capital equipment contracts.' , tags:['self-intro'], categories:['è‡ªå·±ç´¹ä»‹']},
    { id: uid(), scene:'Meeting update', english:'We understand your request, but changing the approval deadline will significantly increase schedule risk. We need an alternative plan.' , tags:['meeting'], categories:['æ„è¦‹']},
    { id: uid(), scene:'Hobby (biotope)', english:'On weekends, I enjoy gardening and building a small biotope in my backyard. It helps me relax and recharge.' , tags:['hobby'], categories:['ä¼‘æ—¥ãƒ»è¶£å‘³']},
  ];
  data = demo;
  save();
  renderList();
  selectItem(demo[0].id);
  toast('ãƒ‡ãƒ¢ä¾‹æ–‡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
};

$('#btn-clear').onclick = ()=>{
  if(!confirm('ä¿å­˜æ¸ˆã¿ã®ä¾‹æ–‡ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
  stopRecognition(true);
  clearRecording(true);
  stopSpeech();
  data = [];
  currentId = null;
  save();
  renderList();
  $('#refBox').textContent = 'å·¦ã®ä¸€è¦§ã‹ã‚‰ä¾‹æ–‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
  resetAll();
  $('#btn-tts-sent').disabled = true;
  $('#btn-tts-stop').disabled = true;
  $('#btn-edit').disabled = true;
  toast('å…¨æ¶ˆå»ã—ã¾ã—ãŸ');
};

/* =========================
   Init
========================= */
renderList();
if(data[0]) selectItem(data[0].id);
setButtons();
setRecUI('ãªã—');
$('#btn-tts-sent').disabled = !hasTTS || !currentId;
$('#btn-tts-stop').disabled = true;
</script>
</body>
</html>

