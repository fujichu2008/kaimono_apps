<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, viewport-fit=cover, user-scalable=no" />
<title>TOEIC Speaking Q8-10 Trainerï¼ˆè³‡æ–™èª­è§£ç‰¹åŒ–ï¼‰</title>
<style>
  :root{
    --bg:#0c0f14; --bg2:#0b1220;
    --card:#121826; --card2:#0f1524;
    --ink:#e8eefc; --muted:#a7b0c2; --line:#243047;
    --pri:#4da3ff; --ok:#17c964; --warn:#ffb020; --danger:#ff4d4f; --ghost:#76839b;
    --shadow: 0 14px 34px rgba(0,0,0,.35);
    --r:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2)); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, Arial;}
  a{color:inherit}
  button, input, select { font: inherit; }
  .app{min-height:100%; display:flex; flex-direction:column;}
  header{
    position:sticky; top:0; z-index:50;
    padding: 14px 14px 10px;
    background: rgba(12,15,20,.78);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(36,48,71,.65);
  }
  .row{display:flex; align-items:center; gap:10px;}
  .grow{flex:1}
  .title{
    font-weight:800; letter-spacing:.2px; line-height:1.1;
    font-size: 16px;
  }
  .subtitle{color:var(--muted); font-size:12px; margin-top:2px}
  .pilltabs{
    display:flex; gap:8px; padding:8px; border-radius:999px;
    background: rgba(18,24,38,.8);
    border:1px solid rgba(36,48,71,.75);
    width: fit-content;
    box-shadow: var(--shadow);
  }
  .pilltabs button{
    border:0; background:transparent; color:var(--muted);
    padding:8px 12px; border-radius:999px;
    cursor:pointer; transition:.15s;
    font-weight:700; font-size:12px;
  }
  .pilltabs button.active{
    background: rgba(77,163,255,.16);
    color: var(--ink);
    border:1px solid rgba(77,163,255,.35);
  }
  main{flex:1; padding: 12px 12px 18px; max-width: 1100px; width:100%; margin:0 auto;}
  .grid{display:grid; gap:12px;}
  @media (min-width: 920px){
    .grid.cols2{grid-template-columns: 1.1fr .9fr;}
  }
  .card{
    background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(15,21,36,.92));
    border:1px solid rgba(36,48,71,.8);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    padding: 12px;
  }
  .card h3{margin:0 0 6px; font-size:13px; letter-spacing:.2px}
  .muted{color:var(--muted)}
  .hr{height:1px; background: rgba(36,48,71,.7); margin:10px 0;}
  .btn{
    border:1px solid rgba(36,48,71,.9);
    background: rgba(18,24,38,.65);
    color: var(--ink);
    border-radius: 12px;
    padding: 10px 12px;
    cursor:pointer;
    transition:.15s;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
  }
  .btn:hover{transform: translateY(-1px); border-color: rgba(77,163,255,.55);}
  .btn:disabled{opacity:.5; cursor:not-allowed; transform:none;}
  .btn.pri{
    background: linear-gradient(180deg, rgba(77,163,255,.95), rgba(77,163,255,.75));
    border-color: rgba(77,163,255,.75);
    color: #06101f;
    font-weight:900;
  }
  .btn.ok{
    background: linear-gradient(180deg, rgba(23,201,100,.95), rgba(23,201,100,.75));
    border-color: rgba(23,201,100,.65);
    color: #06130c;
    font-weight:900;
  }
  .btn.danger{
    background: linear-gradient(180deg, rgba(255,77,79,.95), rgba(255,77,79,.72));
    border-color: rgba(255,77,79,.65);
    color: #1a0606;
    font-weight:900;
  }
  .btn.ghost{background: rgba(118,131,155,.12); border-color: rgba(118,131,155,.35); color: var(--ink);}
  .btn.small{padding:7px 10px; border-radius: 10px; font-size:12px;}
  .btn.icon{padding:8px 10px; border-radius: 12px; font-size:12px;}
  .kpi{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(118,131,155,.12);
    border:1px solid rgba(118,131,155,.35);
    color: var(--ink);
    font-size: 12px;
  }
  .chip strong{font-weight:900}
  .drop{
    border: 1px dashed rgba(77,163,255,.55);
    background: rgba(77,163,255,.08);
    border-radius: var(--r);
    padding: 14px;
    text-align:center;
  }
  .drop.dragover{background: rgba(77,163,255,.14); border-color: rgba(77,163,255,.75);}
  .list{display:flex; flex-direction:column; gap:10px;}
  .item{
    border:1px solid rgba(36,48,71,.75);
    background: rgba(15,21,36,.55);
    border-radius: 14px;
    padding: 10px;
  }
  .item .top{display:flex; align-items:flex-start; gap:10px;}
  .item .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
  .item .name{font-weight:900; font-size:13px; line-height:1.2}
  .item .sub{font-size:12px; color:var(--muted); margin-top:2px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .material{
    white-space: pre-wrap;
    font-size: 13px;
    line-height: 1.55;
  }
  .material code{background: rgba(118,131,155,.15); padding:2px 4px; border-radius: 6px;}
  .material table{width:100%; border-collapse: collapse; margin:8px 0;}
  .material th,.material td{border:1px solid rgba(36,48,71,.6); padding:6px; font-size: 12px;}
  .material th{background: rgba(118,131,155,.10);}
  .bigTimer{
    font-size: 34px;
    font-weight: 1000;
    letter-spacing: .5px;
  }
  .statusLine{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(36,48,71,.8);
    background: rgba(18,24,38,.55);
    font-size: 12px;
  }
  .badge.ok{border-color: rgba(23,201,100,.6); background: rgba(23,201,100,.12);}
  .badge.warn{border-color: rgba(255,176,32,.6); background: rgba(255,176,32,.12);}
  .badge.danger{border-color: rgba(255,77,79,.6); background: rgba(255,77,79,.12);}
  .qbox{
    border:1px solid rgba(36,48,71,.8);
    background: rgba(12,18,32,.45);
    border-radius: 14px;
    padding: 10px;
  }
  .qtitle{font-weight: 950; margin: 0 0 6px; font-size: 13px;}
  .qtext{font-size: 14px; line-height: 1.45;}
  .flexcol{display:flex; flex-direction:column; gap:10px;}
  .twoCol{display:grid; gap:10px;}
  @media(min-width: 920px){
    .twoCol{grid-template-columns: 1fr 1fr;}
  }
  .textarea{
    width:100%; min-height: 120px; resize: vertical;
    border-radius: 14px;
    border:1px solid rgba(36,48,71,.85);
    background: rgba(10,14,22,.7);
    color: var(--ink);
    padding: 10px;
    line-height: 1.5;
    font-size: 12px;
  }
  .toast{
    position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
    background: rgba(18,24,38,.92);
    border:1px solid rgba(36,48,71,.85);
    color: var(--ink);
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: var(--shadow);
    display:none;
    z-index: 100;
    max-width: min(92vw, 980px);
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
    font-size: 12px;
  }
  .toast.show{display:block; animation: pop .18s ease-out;}
  @keyframes pop{from{transform: translateX(-50%) translateY(8px); opacity:.2} to{transform: translateX(-50%) translateY(0); opacity:1}}
  .warnbox{
    border-radius: var(--r);
    border: 1px solid rgba(255,176,32,.55);
    background: rgba(255,176,32,.08);
    padding: 10px;
    color: var(--ink);
    font-size: 12px;
    line-height: 1.45;
  }
  .dangerbox{
    border-radius: var(--r);
    border: 1px solid rgba(255,77,79,.55);
    background: rgba(255,77,79,.08);
    padding: 10px;
    color: var(--ink);
    font-size: 12px;
    line-height: 1.45;
  }
  .footnote{color: var(--muted); font-size: 11px; line-height: 1.45;}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="row">
      <div class="grow">
        <div class="title">TOEIC Speaking Q8â€“10 Trainerï¼ˆè³‡æ–™èª­è§£ç‰¹åŒ–ï¼‰</div>
        <div class="subtitle">JSONå–è¾¼ â†’ æœ¬ç•ªã‚¿ã‚¤ãƒ  â†’ éŒ²éŸ³ï¼‹æ–‡å­—èµ·ã“ã— â†’ Review â†’ ChatGPTè©•ä¾¡</div>
      </div>
      <div class="pilltabs" role="tablist" aria-label="tabs">
        <button id="tabBank" class="active" type="button">Bank</button>
        <button id="tabRun" type="button">Run</button>
        <button id="tabReview" type="button">Review</button>
        <button id="tabSettings" type="button">Settings</button>
      </div>
    </div>
  </header>

  <main>
    <!-- BANK -->
    <section id="viewBank" class="grid cols2">
      <div class="card">
        <h3>â‘  Problem Bankï¼ˆJSONæŠ•å…¥ãƒ»ç®¡ç†ï¼‰</h3>
        <div class="drop" id="dropZone">
          <div style="font-weight:900; margin-bottom:6px;">JSONã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
          <div class="muted" style="font-size:12px;">ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§å–ã‚Šè¾¼ã¿ï¼ˆ10ã‚»ãƒƒãƒˆã§ã‚‚è¤‡æ•°ã§ã‚‚OKï¼‰</div>
          <div style="margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <button class="btn pri small" id="btnPickJson" type="button">Import JSON</button>
            <input id="filePick" type="file" accept="application/json" style="display:none" />
            <button class="btn small" id="btnCopyGenPrompt" type="button">å•é¡Œç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <div class="footnote" style="margin-top:10px;">
            â€»ã“ã®ã‚¢ãƒ—ãƒªã¯ã€Œæ–‡å­—èµ·ã“ã—ç„¡ã—ï¼æ‰‹å…¥åŠ›ã€ã‚’ç”¨æ„ã—ã¾ã›ã‚“ã€‚SpeechRecognitionéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚
          </div>

          <!-- è¿½åŠ ï¼šJSONã‚³ãƒ¼ãƒ‰ç›´æ¥å–ã‚Šè¾¼ã¿ -->
          <div class="hr"></div>
          <div class="qbox" style="text-align:left;">
            <div class="qtitle">JSONã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾å–ã‚Šè¾¼ã¿</div>
            <div class="muted" style="font-size:12px; line-height:1.55; margin-bottom:8px;">
              ChatGPTã®å‡ºåŠ›JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ç„¡ã—ã§Importã§ãã¾ã™ï¼ˆ{sets:[...]} ã¾ãŸã¯ã‚»ãƒƒãƒˆé…åˆ—ï¼‰ã€‚
            </div>
            <textarea class="textarea mono" id="jsonPaste" placeholder='ã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹ï¼š{"schema_version":"1.0", "sets":[ ... ]}ï¼‰'></textarea>
            <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn pri small" id="btnImportJsonText" type="button">Paste JSONã‚’Import</button>
              <button class="btn small" id="btnClearJsonPaste" type="button">ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="footnote" style="margin-top:8px;">
              â€»ã“ã®ç‰ˆã¯ã€Œå¤šå°‘ã®æ··å…¥ï¼ˆ```jsonã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹/å‰å¾Œã®èª¬æ˜æ–‡/ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆï¼‰ã€ã‚’è‡ªå‹•ã§é™¤å»ã—ã¦Importã—ã¾ã™ã€‚<br/>
              â€»ã¾ãŸã€JSONæ–‡å­—åˆ—ä¸­ã«â€œç”Ÿã®æ”¹è¡Œâ€ãŒæ··ã–ã£ã¦ã„ã¦ã‚‚è‡ªå‹•ã§ <code>\n</code> ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¾ã™ã€‚
            </div>
          </div>
          <!-- /è¿½åŠ ï¼šJSONã‚³ãƒ¼ãƒ‰ç›´æ¥å–ã‚Šè¾¼ã¿ -->

        </div>

        <div class="hr"></div>

        <div class="kpi">
          <span class="chip">ç™»éŒ²ã‚»ãƒƒãƒˆæ•°ï¼š<strong id="kpiSets">0</strong></span>
          <span class="chip">æœ€çµ‚å–ã‚Šè¾¼ã¿ï¼š<strong id="kpiLastImport">-</strong></span>
          <span class="chip">ãƒ–ãƒ©ã‚¦ã‚¶ï¼š<strong id="kpiBrowser">-</strong></span>
        </div>

        <div class="hr"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="btnStartRandom" type="button">ğŸ² Randomã§é–‹å§‹</button>
          <button class="btn ghost" id="btnExportAll" type="button">Exportï¼ˆå…¨ã‚»ãƒƒãƒˆJSONï¼‰</button>
        </div>
        <div class="footnote" style="margin-top:10px;">
          Exportã¯ã€ç¾åœ¨DBã«å…¥ã£ã¦ã„ã‚‹ã‚»ãƒƒãƒˆã‚’JSONã§æ›¸ãå‡ºã—ã¾ã™ï¼ˆChatGPTç”Ÿæˆç‰©ã®å†åˆ©ç”¨ç”¨ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <h3>â‘¡ ã‚»ãƒƒãƒˆä¸€è¦§ï¼ˆé¸æŠã—ã¦é–‹å§‹ï¼‰</h3>
        <div class="warnbox" id="supportBox" style="display:none;"></div>
        <div class="list" id="setList"></div>
        <div class="muted" id="emptyMsg" style="font-size:12px; display:none;">ã¾ã ã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚JSONã‚’æŠ•å…¥ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    </section>

    <!-- RUN -->
    <section id="viewRun" style="display:none;">
      <div class="grid cols2">
        <div class="card">
          <h3>è³‡æ–™ï¼ˆ45ç§’ï¼‰ï¼å¸¸æ™‚å‚ç…§</h3>
          <div class="statusLine">
            <span class="badge" id="runSetBadge">Set: -</span>
            <span class="badge" id="phaseBadge">Phase: -</span>
          </div>
          <div class="hr"></div>
          <div class="material" id="materialView"></div>
        </div>

        <div class="card flexcol">
          <div>
            <h3>é€²è¡Œ</h3>
            <div class="statusLine">
              <div>
                <div class="bigTimer" id="bigTimer">--</div>
                <div class="muted" style="font-size:12px;" id="timerHint">-</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn small" id="btnTtsToggle" type="button">ğŸ”Š TTS: ON</button>
                <button class="btn small" id="btnAbortRun" type="button">ä¸­æ–­</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="qbox">
            <div class="qtitle" id="qTitle">-</div>
            <div class="qtext" id="qText">-</div>
            <div class="hr"></div>
            <div class="muted" style="font-size:12px;" id="recStatus">éŒ²éŸ³ï¼š- / æ–‡å­—èµ·ã“ã—ï¼š-</div>
          </div>

          <div class="hr"></div>

          <div class="warnbox" id="micWarn" style="display:none;"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn pri" id="btnRunStart" type="button">â–¶ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹</button>
            <button class="btn ghost" id="btnRunRestart" type="button" disabled>ã‚„ã‚Šç›´ã—</button>
            <button class="btn ok" id="btnGoReview" type="button" disabled>Reviewã¸</button>
          </div>

          <div class="footnote">
            æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šè³‡æ–™45ç§’ â†’ Q8(3+15) â†’ Q9(3+15) â†’ Q10(è³ªå•2å›+3+30)ã€‚<br/>
            â€»ã€Œå›ç­”ä¸­ã®æ–‡å­—èµ·ã“ã—ã¯ç”»é¢ã«å‡ºã—ã¾ã›ã‚“ã€ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è“„ç©ã—ã€çµ‚äº†å¾Œã«Reviewã§è¡¨ç¤ºï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- REVIEW -->
    <section id="viewReview" style="display:none;">
      <div class="card">
        <div class="row">
          <div class="grow">
            <h3 style="margin:0 0 4px;">Reviewï¼ˆè³‡æ–™ï¼‹è¨­å•ï¼‹éŒ²éŸ³ï¼‹æ–‡å­—èµ·ã“ã—ï¼‹æ¨¡ç¯„è§£ç­”ï¼‰</h3>
            <div class="muted" style="font-size:12px;" id="reviewMeta">-</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn small" id="btnCopyEvalPrompt" type="button">è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn small" id="btnBackToBank" type="button">Bankã¸</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="grid cols2">
          <div class="card" style="box-shadow:none;">
            <h3>è³‡æ–™</h3>
            <div class="material" id="reviewMaterial"></div>
          </div>
          <div class="card" style="box-shadow:none;">
            <h3>è©•ä¾¡ä¾é ¼ã«å«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿</h3>
            <div class="muted" style="font-size:12px; line-height:1.6;">
              - è³‡æ–™ / è¨­å• / ASRæ–‡å­—èµ·ã“ã—ï¼ˆã‚ãªãŸã®å›ç­”ï¼‰ã‚’åŸ‹ã‚è¾¼ã‚“ã ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚<br/>
              - ChatGPTã¸è²¼ã‚Šä»˜ã‘ã¦æ¡ç‚¹ãƒ»æ”¹å–„æ¡ˆãƒ»100ç‚¹æ¨¡ç¯„è§£ç­”ã¾ã§å–å¾—ã§ãã¾ã™ã€‚
            </div>
            <div class="hr"></div>
            <textarea class="textarea mono" id="evalPromptPreview" readonly></textarea>
            <div class="footnote">â€»ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã¯ã“ã®æ¬„ã®å…¨æ–‡ã§ã™ã€‚</div>
          </div>
        </div>
        <div class="hr"></div>
        <div id="reviewQuestions" class="grid" style="gap:12px;"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="viewSettings" style="display:none;">
      <div class="grid cols2">
        <div class="card">
          <h3>è¨­å®š</h3>
          <div class="row" style="align-items:flex-start;">
            <div class="grow">
              <div style="font-weight:900; margin-bottom:6px;">TTSï¼ˆè³ªå•èª­ã¿ä¸Šã’ï¼‰</div>
              <div class="muted" style="font-size:12px; line-height:1.6;">
                Q10ã¯è³ªå•ãŒ2å›æµã‚Œã‚‹æƒ³å®šã®ãŸã‚ã€TTSã§2å›èª­ã¿ã¾ã™ã€‚<br/>
                ç”»é¢ä¸Šã®TTS ON/OFFã§åˆ‡ã‚Šæ›¿ãˆå¯ã€‚
              </div>
              <div class="hr"></div>
              <label class="muted" style="font-size:12px;">TTSé€Ÿåº¦ï¼ˆrateï¼‰</label>
              <div class="row" style="margin-top:6px;">
                <input id="ttsRate" type="range" min="0.7" max="1.2" step="0.05" value="1.0" style="width:100%;">
                <span class="badge" id="ttsRateBadge">1.0</span>
              </div>
              <div class="hr"></div>
              <label class="muted" style="font-size:12px;">èªè­˜è¨€èªï¼ˆSpeechRecognitionï¼‰</label>
              <div class="row" style="margin-top:6px; flex-wrap:wrap;">
                <select id="asrLang" class="btn small" style="cursor:pointer;">
                  <option value="en-US">en-US</option>
                  <option value="en-GB">en-GB</option>
                  <option value="en-AU">en-AU</option>
                </select>
                <span class="muted" style="font-size:12px;">â€»åŸºæœ¬ã¯ en-US æ¨å¥¨</span>
              </div>

              <div class="hr"></div>
              <div style="font-weight:900; margin-bottom:6px;">DBç®¡ç†</div>
              <div class="muted" style="font-size:12px; line-height:1.6; margin-bottom:10px;">
                å–ã‚Šè¾¼ã¿æ¸ˆã¿ã‚»ãƒƒãƒˆï¼ˆProblem Bankï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã¯ã§ãã¾ã›ã‚“ã€‚
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn danger" id="btnClearAll" type="button">å…¨å‰Šé™¤ï¼ˆDBåˆæœŸåŒ–ï¼‰</button>
              </div>
              <div class="footnote" style="margin-top:8px;">
                â€»DBå‰Šé™¤å¾Œã¯è‡ªå‹•ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>å‹•ä½œè¦ä»¶ãƒã‚§ãƒƒã‚¯</h3>
          <div id="capList" class="flexcol"></div>
          <div class="hr"></div>
          <div class="dangerbox">
            <div style="font-weight:900; margin-bottom:4px;">ã“ã®ã‚¢ãƒ—ãƒªã®æ–¹é‡</div>
            ã€Œæ–‡å­—èµ·ã“ã—ç„¡ã—ï¼æ‰‹å…¥åŠ›ã€ãƒ«ãƒ¼ãƒˆã¯ä½œã‚Šã¾ã›ã‚“ã€‚<br/>
            SpeechRecognitionãŒä½¿ãˆãªã„ç’°å¢ƒã§ã¯ç·´ç¿’è‡ªä½“ãŒæˆç«‹ã—ãªã„ãŸã‚ã€èµ·å‹•ã§ããªã„ä»•æ§˜ã§ã™ã€‚
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>
</div>

<script>
/* =========================
   Utilities
========================= */
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const nowISO = ()=> new Date().toISOString();
const fmtTime = (d)=> {
  try{
    const dt = new Date(d);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const day = String(dt.getDate()).padStart(2,'0');
    const hh = String(dt.getHours()).padStart(2,'0');
    const mm = String(dt.getMinutes()).padStart(2,'0');
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }catch(e){ return '-'; }
};
function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>t.classList.remove("show"), 2200);
}
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = txt;
    ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.select();
    try{
      document.execCommand("copy");
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      return true;
    }catch(err){
      toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      return false;
    }finally{
      document.body.removeChild(ta);
    }
  }
}

/* =========================
   Capability (No fallback!)
========================= */
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasSpeechRecognition = !!SpeechRec;
const hasMediaRecorder = !!window.MediaRecorder;
const isSecure = window.isSecureContext;
const isEdgeOrChrome = /Edg|Chrome/.test(navigator.userAgent);

/* =========================
   iOS detection (WebKit)
========================= */
const isIOS = /iP(hone|od|ad)/.test(navigator.userAgent) || (navigator.userAgent.includes("Mac") && ("ontouchend" in document));
const isWebKit = /AppleWebKit/.test(navigator.userAgent) && !/Chrome\/\d+/.test(navigator.userAgent);

/* =========================
   IndexedDB
========================= */
const DB_NAME = "toeic_q8q10_trainer_db_v1";
const DB_VER = 1;
const STORE_SETS = "sets";
const STORE_META = "meta";

function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (ev)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE_SETS)){
        const st = db.createObjectStore(STORE_SETS, { keyPath: "set_id" });
        st.createIndex("by_title", "title", { unique:false });
        st.createIndex("by_imported_at", "imported_at", { unique:false });
      }
      if(!db.objectStoreNames.contains(STORE_META)){
        db.createObjectStore(STORE_META, { keyPath: "key" });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbTx(mode, storeNames, fn){
  const db = await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(storeNames, mode);
    const stores = storeNames.map(n=>tx.objectStore(n));
    let out;
    Promise.resolve().then(()=> fn(tx, ...stores)).then(v=> out=v);
    tx.oncomplete = ()=> { db.close(); resolve(out); };
    tx.onerror = ()=> { const e=tx.error; db.close(); reject(e); };
    tx.onabort = ()=> { const e=tx.error; db.close(); reject(e); };
  });
}
async function metaSet(key, val){
  return idbTx("readwrite",[STORE_META], async (tx, meta)=>{
    meta.put({key, val});
  });
}
async function metaGet(key){
  return idbTx("readonly",[STORE_META], async (tx, meta)=>{
    return new Promise((resolve,reject)=>{
      const r = meta.get(key);
      r.onsuccess = ()=> resolve(r.result ? r.result.val : null);
      r.onerror = ()=> reject(r.error);
    });
  });
}
async function setsPutMany(sets){
  return idbTx("readwrite",[STORE_SETS], async (tx, st)=>{
    for(const s of sets){
      st.put(s);
    }
  });
}
async function setsGetAll(){
  return idbTx("readonly",[STORE_SETS], async (tx, st)=>{
    return new Promise((resolve,reject)=>{
      const r = st.getAll();
      r.onsuccess = ()=> resolve(r.result || []);
      r.onerror = ()=> reject(r.error);
    });
  });
}
async function setsDelete(set_id){
  return idbTx("readwrite",[STORE_SETS], async (tx, st)=>{
    st.delete(set_id);
  });
}
async function dbClearAll(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.deleteDatabase(DB_NAME);
    req.onsuccess = ()=> resolve(true);
    req.onerror = ()=> reject(req.error);
    req.onblocked = ()=> reject(new Error("DB delete blocked"));
  });
}

/* =========================
   Schema / Import
========================= */

/** æ–‡å­—åˆ—å¤–ã®JSONé–‹å§‹è¨˜å·({/[)ã‚’æ¢ã™ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ãŒæ··ã–ã£ã¦ã‚‚OKã«ã™ã‚‹ï¼‰ */
function findFirstJsonOpenOutsideStrings(s){
  let inStr=false, esc=false;
  for(let i=0;i<s.length;i++){
    const ch = s[i];
    if(inStr){
      if(esc){ esc=false; continue; }
      if(ch==="\\"){ esc=true; continue; }
      if(ch==="\""){ inStr=false; continue; }
    }else{
      if(ch==="\""){ inStr=true; continue; }
      if(ch==="{" || ch==="[") return i;
    }
  }
  return -1;
}
/** æ–‡å­—åˆ—å¤–ã®JSONçµ‚ç«¯è¨˜å·(}/])ã‚’æ¢ã™ */
function findLastJsonCloseOutsideStrings(s){
  let inStr=false, esc=false;
  let last=-1;
  for(let i=0;i<s.length;i++){
    const ch = s[i];
    if(inStr){
      if(esc){ esc=false; continue; }
      if(ch==="\\"){ esc=true; continue; }
      if(ch==="\""){ inStr=false; continue; }
    }else{
      if(ch==="\""){ inStr=true; continue; }
      if(ch==="}" || ch==="]") last=i;
    }
  }
  return last;
}

/**
 * JSONæ–‡å­—åˆ—ä¸­ã«ã€Œç”Ÿã®æ”¹è¡Œã€ãŒæ··ã–ã£ã¦ã‚‚parseã§ãã‚‹ã‚ˆã†ã«
 * æ–‡å­—åˆ—å†…ã® \n/\t ãªã©ã®åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã€‚
 */
function escapeRawControlsInsideJsonStrings(s){
  let out = "";
  let inStr = false;
  let esc = false;
  for(let i=0;i<s.length;i++){
    const ch = s[i];

    if(!inStr){
      if(ch === "\""){
        inStr = true;
        out += ch;
      }else{
        out += ch;
      }
      continue;
    }

    // in string
    if(esc){
      out += ch;
      esc = false;
      continue;
    }
    if(ch === "\\"){
      out += ch;
      esc = true;
      continue;
    }
    if(ch === "\""){
      inStr = false;
      out += ch;
      continue;
    }

    // åˆ¶å¾¡æ–‡å­—ã‚’å®‰å…¨ã«
    if(ch === "\n"){ out += "\\n"; continue; }
    if(ch === "\r"){ /* drop */ continue; }
    if(ch === "\t"){ out += "\\t"; continue; }

    const code = ch.charCodeAt(0);
    if(code < 0x20){
      out += "\\u" + code.toString(16).padStart(4,"0");
      continue;
    }
    out += ch;
  }
  return out;
}

/**
 * è²¼ã‚Šä»˜ã‘ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€ŒJSON.parseã§ãã‚‹çŠ¶æ…‹ã€ã¸æ­£è¦åŒ–
 * - BOMé™¤å»
 * - ```json ... ``` ã®é™¤å»
 * - å‰å¾Œã®èª¬æ˜æ–‡ã‚’é™¤å»ï¼ˆæœ€åˆã® {/[ ã‹ã‚‰æœ€å¾Œã® }/] ã¾ã§ã‚’æŠ½å‡ºï¼‰
 * - ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆç½®æ›
 * - æ–‡å­—åˆ—å†…ã®ç”Ÿæ”¹è¡Œã‚’ \n ã«å¤‰æ›
 */
function sanitizeJsonText(raw){
  let s = String(raw ?? "");
  s = s.replace(/^\uFEFF/, "");      // BOM
  s = s.replace(/\r\n?/g, "\n");     // normalize
  s = s.trim();
  if(!s) throw new Error("å…¥åŠ›ãŒç©ºã§ã™ã€‚");

  // ã¾ãšæœ€åˆã® ``` ... ``` ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Œã°ä¸­èº«ã‚’å„ªå…ˆ
  const fence = s.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
  if(fence && fence[1]){
    s = String(fence[1]).trim();
  }

  // ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆç­‰ï¼ˆã‚³ãƒ”ãƒ¼å…ƒæ¬¡ç¬¬ï¼‰
  s = s.replace(/[â€œâ€]/g, "\"").replace(/[â€˜â€™]/g, "'");

  // å‰å¾Œã«æ–‡ç« ãŒæ··ã–ã£ã¦ã„ã¦ã‚‚ã€JSONæœ¬ä½“ã ã‘ã‚’åˆ‡ã‚Šå‡ºã™
  const st = findFirstJsonOpenOutsideStrings(s);
  if(st >= 0) s = s.slice(st);
  const ed = findLastJsonCloseOutsideStrings(s);
  if(ed >= 0) s = s.slice(0, ed + 1);
  s = s.trim();

  // ãã‚Œã§ã‚‚JSONã‚‰ã—ããªã„
  if(!s.startsWith("{") && !s.startsWith("[")){
    throw new Error("JSONã®é–‹å§‹è¨˜å·ï¼ˆ{ ã¾ãŸã¯ [ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è²¼ã‚Šä»˜ã‘å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }

  // æ–‡å­—åˆ—å†…ã®ç”Ÿæ”¹è¡Œãƒ»åˆ¶å¾¡æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  s = escapeRawControlsInsideJsonStrings(s);

  return s;
}

function parsePosFromJsonErrorMessage(msg, text){
  // Chromeç³»: "... at position N"
  let m = String(msg||"").match(/position\s+(\d+)/i);
  if(m) return {pos: Number(m[1])};

  // Safari: "line X column Y"
  m = String(msg||"").match(/line\s+(\d+)\s*column\s+(\d+)/i);
  if(m){
    const line = Number(m[1]);
    const col  = Number(m[2]);
    if(Number.isFinite(line) && Number.isFinite(col)){
      const lines = String(text||"").split("\n");
      let p = 0;
      for(let i=0;i<Math.max(0,line-1) && i<lines.length;i++){
        p += lines[i].length + 1;
      }
      p += Math.max(0, col-1);
      return {pos: p, line, col};
    }
  }
  return {pos: null};
}

function buildJsonParseError(err, cleanedText){
  const msg = (err && err.message) ? err.message : String(err);
  const {pos} = parsePosFromJsonErrorMessage(msg, cleanedText);

  if(typeof pos === "number" && Number.isFinite(pos) && pos >= 0){
    const start = Math.max(0, pos - 80);
    const end   = Math.min(cleanedText.length, pos + 80);
    const frag  = cleanedText.slice(start, end);
    const caret = " ".repeat(Math.max(0, pos - start)) + "^";
    return `${msg}

--- error around here ---
${frag}
${caret}

ãƒ’ãƒ³ãƒˆï¼š
- ChatGPTã®å‡ºåŠ›ã« \`\`\`json ...\`\`\` ãŒä»˜ã„ã¦ã„ã¦ã‚‚OKï¼ˆè‡ªå‹•é™¤å»ã—ã¾ã™ï¼‰
- ãŸã ã— JSONæ–‡å­—åˆ—ã®é€”ä¸­ã«ä½™è¨ˆãªã€Œ"ã€ã‚„æ¬ ã‘ãŸæ‹¬å¼§ãŒã‚ã‚‹ã¨å¤±æ•—ã—ã¾ã™
- ã‚‚ã— body_markdown ç­‰ã®æ–‡å­—åˆ—ä¸­ã«ç”Ÿæ”¹è¡ŒãŒå…¥ã£ã¦ã„ã¦ã‚‚ã€ã“ã®ç‰ˆã¯è‡ªå‹•ã§ \\n ã«ç›´ã—ã¾ã™`;
  }
  return `${msg}

ãƒ’ãƒ³ãƒˆï¼š
- \`\`\`json\`\`\` ãƒ•ã‚§ãƒ³ã‚¹ã‚„å‰å¾Œã®èª¬æ˜æ–‡ãŒæ··ã–ã£ã¦ã„ã¦ã‚‚OKãªã¯ãšã§ã™ãŒã€è²¼ã‚Šä»˜ã‘é€”ä¸­ã§æ¬ ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- ã¾ãšã¯å…ˆé ­ãŒ { ã‹ [ ã§å§‹ã¾ã‚Šã€æœ«å°¾ãŒ } ã‹ ] ã§çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`;
}

function parseJsonLenient(raw){
  const cleaned = sanitizeJsonText(raw);
  try{
    return { json: JSON.parse(cleaned), cleaned };
  }catch(e){
    throw new Error(buildJsonParseError(e, cleaned));
  }
}

function normalizeImported(json){
  const sets = Array.isArray(json) ? json : (json && Array.isArray(json.sets) ? json.sets : null);
  if(!sets) throw new Error("JSONå½¢å¼ãŒä¸æ­£ã§ã™ã€‚{sets:[...]} ã¾ãŸã¯ã‚»ãƒƒãƒˆé…åˆ—ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚");

  const out = [];
  for(let i=0;i<sets.length;i++){
    const s = sets[i];
    if(!s) continue;
    const set_id = String(s.set_id || "").trim();
    if(!set_id) throw new Error(`set_id ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆindex=${i}ï¼‰`);

    if(!s.material || !s.material.body_markdown) throw new Error(`material.body_markdown ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆset_id=${set_id}ï¼‰`);
    if(!Array.isArray(s.questions) || s.questions.length !== 3) throw new Error(`questions ã¯3ã¤å¿…è¦ã§ã™ï¼ˆset_id=${set_id}ï¼‰`);

    const qs = s.questions.map(q=>({
      q_index: Number(q.q_index),
      prep_sec: Number(q.prep_sec ?? 3),
      answer_sec: Number(q.answer_sec),
      ask_twice: !!q.ask_twice,
      question_text: String(q.question_text || ""),
      expected_points: Array.isArray(q.expected_points) ? q.expected_points.map(String) : [],
      model_answer: String(q.model_answer || "")
    }));
    const idxs = qs.map(q=>q.q_index).sort((a,b)=>a-b).join(",");
    if(idxs !== "8,9,10") throw new Error(`q_index ã¯ 8,9,10 ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆset_id=${set_id} / got=${idxs}ï¼‰`);
    for(const q of qs){
      if(!q.question_text) throw new Error(`question_text ãŒç©ºã§ã™ï¼ˆset_id=${set_id}, q=${q.q_index}ï¼‰`);
      if(!(q.answer_sec===15 || q.answer_sec===30)) throw new Error(`answer_sec ã¯ 15 or 30ï¼ˆset_id=${set_id}, q=${q.q_index}ï¼‰`);
    }

    const normalized = {
      set_id,
      title: String(s.title || set_id),
      difficulty: String(s.difficulty || "mid"),
      tags: Array.isArray(s.tags) ? s.tags.map(String) : [],
      imported_at: nowISO(),
      material: {
        title: String(s.material.title || "Material"),
        context: String(s.material.context || ""),
        body_markdown: String(s.material.body_markdown),
        read_time_sec: Number(s.material.read_time_sec ?? 45)
      },
      questions: qs
    };
    out.push(normalized);
  }
  return out;
}

/* =========================
   TTS (FIXED: iOS freeze-proof)
========================= */
let TTS_ON = true;

/**
 * iOSã§èµ·ããŒã¡ãªã€ŒonendãŒæ¥ãªã„ / awaitãŒæ°¸é ã«çµ‚ã‚ã‚‰ãªã„ã€ã‚’æ½°ã™ãŸã‚ã®TTSã‚¨ãƒ³ã‚¸ãƒ³
 * - user gestureã§è§£éŒ ï¼ˆAudioContext resume + tiny utteranceï¼‰
 * - é•·æ–‡åˆ†å‰²ï¼ˆchunkï¼‰
 * - watchdog timeoutï¼ˆå¿…ãšresolveï¼‰
 * - cancelç›´å¾Œã®å¾…æ©Ÿã‚’é•·ã‚ã«
 */
const TTSEngine = (() => {
  let _voices = [];
  let _voicesReady = false;
  let _unlocked = false;
  let _token = 0;
  let _queue = Promise.resolve();
  let _ac = null;

  function supported(){
    return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
  }

  function cancel(){
    _token++;
    try{ speechSynthesis.cancel(); }catch(e){}
    // iOSã§ cancel ãŒåŠ¹ã‹ãªã„ã‚±ãƒ¼ã‚¹ã®ä¿é™º
    try{ speechSynthesis.pause(); speechSynthesis.resume(); }catch(e){}
  }

  function _estimateTimeoutMs(text, rate){
    const r = Math.max(0.6, Number(rate)||1);
    // é›‘ã«ï¼šæ–‡å­—æ•°ã«æ¯”ä¾‹ + å›ºå®šã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼ˆä¸Šé™ã‚ã‚Šï¼‰
    const ms = 600 + (String(text||"").length * (38 / r));
    return Math.max(1400, Math.min(14000, Math.floor(ms)));
  }

  function _splitText(text){
    const s = String(text||"").trim();
    if(!s) return [];
    // å¥èª­ç‚¹/çµ‚æ­¢ã§åˆ†å‰²ã—ã¤ã¤ã€é•·ã„å¡Šã¯ã•ã‚‰ã«åˆ‡ã‚‹
    const rough = s
      .replace(/\s+/g," ")
      .split(/(?<=[\.\!\?\ã€‚\ï¼\ï¼Ÿ])\s+/);

    const out = [];
    const MAX = 130; // iOSã§é•·æ–‡ãŒä¸å®‰å®šãªãŸã‚å°ã•ã‚
    for(const part of rough){
      let p = part.trim();
      while(p.length > MAX){
        // ã¾ãšã‚«ãƒ³ãƒã§åˆ‡ã‚Œã‚‹ãªã‚‰åˆ‡ã‚‹
        let cut = p.lastIndexOf(",", MAX);
        if(cut < 40) cut = p.lastIndexOf(";", MAX);
        if(cut < 40) cut = MAX;
        out.push(p.slice(0, cut+1).trim());
        p = p.slice(cut+1).trim();
      }
      if(p) out.push(p);
    }
    return out;
  }

  function _pickVoice(lang="en-US"){
    if(!_voices || !_voices.length) return null;
    const want = String(lang).toLowerCase();

    const sameLang = _voices.filter(v => String(v.lang||"").toLowerCase() === want);
    const enAny = _voices.filter(v => String(v.lang||"").toLowerCase().startsWith("en"));
    const pool = sameLang.length ? sameLang : (enAny.length ? enAny : _voices);

    // localServiceå„ªå…ˆï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éŸ³å£°ã£ã½ã„ã‚‚ã®ã‚’é¿ã‘ã‚‹ï¼‰
    const local = pool.filter(v => v.localService);

    if(isIOS){
      // iOSã¯ Samantha ãŒæ¯”è¼ƒçš„å®‰å®šï¼ˆç„¡ã‘ã‚Œã°local defaultï¼‰
      const sam = (sameLang.length ? sameLang : pool).find(v => /Samantha/i.test(v.name||"") && /en-us/i.test(v.lang||""));
      if(sam) return sam;
    }

    const pickFrom = local.length ? local : pool;
    const def = pickFrom.find(v => v.default);
    return def || pickFrom[0] || null;
  }

  async function _waitVoices(timeoutMs=2200){
    if(!supported()) return [];
    try{
      const v0 = speechSynthesis.getVoices();
      if(v0 && v0.length) return v0;
    }catch(e){}
    return new Promise((resolve)=>{
      let done = false;
      const finish = ()=>{
        if(done) return;
        done = true;
        try{ speechSynthesis.onvoiceschanged = null; }catch(e){}
        let vv = [];
        try{ vv = speechSynthesis.getVoices() || []; }catch(e){}
        resolve(vv);
      };
      try{ speechSynthesis.onvoiceschanged = finish; }catch(e){}
      setTimeout(finish, timeoutMs);
    });
  }

  async function _loadVoices(){
    if(!supported()) return [];
    _voices = await _waitVoices(2500);
    _voicesReady = true;
    return _voices;
  }

  async function _resumeAudioContext(){
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return;
      if(!_ac) _ac = new AC();
      if(_ac.state === "suspended"){
        await _ac.resume();
      }
    }catch(e){}
  }

  async function unlock(){
    if(_unlocked) return true;
    if(!supported()) return false;

    await _resumeAudioContext();
    await _loadVoices();

    // iOSã®ã€Œæœ€åˆã®ç™ºè©±ã€å•é¡Œï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ä¸­ã«æ¥µçŸ­ã„ç™ºè©±â†’å³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    try{
      cancel();
      await sleep(50);

      const u = new SpeechSynthesisUtterance("ok");
      u.lang = "en-US";
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 0.01; // 0ã ã¨è§£éŒ ã«ãªã‚‰ãªã„æ©Ÿç¨®ãŒã‚ã‚‹
      const v = _pickVoice("en-US");
      if(v) u.voice = v;

      let settled = false;
      await new Promise((resolve)=>{
        const t = setTimeout(()=>{
          if(settled) return;
          settled = true;
          try{ speechSynthesis.cancel(); }catch(e){}
          resolve();
        }, 700);
        u.onend = ()=>{ if(settled) return; settled=true; clearTimeout(t); resolve(); };
        u.onerror = ()=>{ if(settled) return; settled=true; clearTimeout(t); resolve(); };
        try{
          speechSynthesis.speak(u);
          try{ speechSynthesis.resume(); }catch(e){}
        }catch(e){
          clearTimeout(t);
          resolve();
        }
      });

      cancel();
      await sleep(80);
      _unlocked = true;
      return true;
    }catch(e){
      _unlocked = true; // å¤±æ•—ã—ã¦ã‚‚ã€Œå¾…ãŸãªã„ã€æ–¹ãŒé‡è¦
      return true;
    }
  }

  async function _speakChunk(text, {rate=1.0, lang="en-US", timeoutMs=null, tokenAtStart=0}={}){
    if(!supported()) return false;
    const myToken = tokenAtStart;
    if(myToken !== _token) return false;

    if(!_voicesReady) await _loadVoices();
    if(isIOS) await _resumeAudioContext();

    const tmo = timeoutMs ?? _estimateTimeoutMs(text, rate);

    return new Promise((resolve)=>{
      let done = false;
      const finish = (ok)=>{
        if(done) return;
        done = true;
        clearTimeout(wd);
        resolve(!!ok);
      };

      const u = new SpeechSynthesisUtterance(String(text));
      u.lang = lang;
      u.rate = Math.max(0.7, Math.min(1.2, Number(rate)||1.0));
      u.pitch = 1.0;
      u.volume = 1.0;

      const v = _pickVoice(lang);
      if(v) u.voice = v;

      u.onend = ()=> finish(true);
      u.onerror = ()=> finish(false);

      // watchdog: onendãŒæ¥ãªãã¦ã‚‚å¿…ãšæŠœã‘ã‚‹
      const wd = setTimeout(()=>{
        try{ speechSynthesis.cancel(); }catch(e){}
        try{ speechSynthesis.pause(); speechSynthesis.resume(); }catch(e){}
        finish(false);
      }, tmo);

      try{
        speechSynthesis.speak(u);
        try{ speechSynthesis.resume(); }catch(e){}
      }catch(e){
        finish(false);
      }
    });
  }

  async function speak(text, {rate=1.0, lang="en-US", interrupt=true, timeoutMs=null}={}){
    if(!TTS_ON) return true;
    if(!supported()) return false;

    // iOSã¯æ¯å›ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§è§£éŒ æ¸ˆã¿ã€å‰æãŒå´©ã‚Œã†ã‚‹ã®ã§ã€ã“ã“ã§ã‚‚ä¸€å¿œunlock
    if(isIOS && !_unlocked){
      // â€»ã“ã“ã§ user gesture ã§ãªã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ãŒã€unlockãŒå¤±æ•—ã—ã¦ã‚‚å…ˆã¸é€²ã‚€
      await unlock();
    }else if(!_voicesReady){
      await _loadVoices();
    }

    if(interrupt) cancel();

    // cancelç›´å¾Œã¯iOSãŒè½ã¡/å›ºã¾ã‚Šã‚„ã™ã„ã®ã§å°‘ã—å¾…ã¤
    await sleep(isIOS ? 180 : 60);

    const myToken = _token;
    const chunks = _splitText(text);
    if(!chunks.length) return true;

    for(const c of chunks){
      if(myToken !== _token) return false;
      const ok = await _speakChunk(c, {
        rate, lang,
        timeoutMs: timeoutMs ?? _estimateTimeoutMs(c, rate),
        tokenAtStart: myToken
      });
      // iOSã¯é–“éš”ã‚’ç©ºã‘ãŸæ–¹ãŒå®‰å®š
      await sleep(isIOS ? 130 : 40);
      if(myToken !== _token) return false;
      if(!ok){
        // å¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„
      }
    }
    return true;
  }

  // é€£æ‰“å¯¾ç­–ï¼šå†…éƒ¨ã‚­ãƒ¥ãƒ¼ã§é †ç•ªã«æµã™
  function speakQueued(text, opts){
    _queue = _queue.then(()=> speak(text, opts)).catch(()=>false);
    return _queue;
  }

  return { supported, unlock, cancel, speak, speakQueued };
})();

document.addEventListener("visibilitychange", ()=>{
  if(document.hidden){
    try{ TTSEngine.cancel(); }catch(e){}
  }
});

document.addEventListener("pointerdown", async ()=>{
  if(TTS_ON && TTSEngine.supported()){
    await TTSEngine.unlock();
  }
}, {once:true});

/* =========================
   Recorder + SpeechRecognition (No fallback)
========================= */
async function getMicStream(){
  return navigator.mediaDevices.getUserMedia({ audio: true });
}

function pickMime(){
  const cand = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/ogg;codecs=opus",
    "audio/ogg"
  ];
  for(const m of cand){
    if(MediaRecorder.isTypeSupported(m)) return m;
  }
  return "";
}

function createRecognizer(lang="en-US"){
  const rec = new SpeechRec();
  rec.lang = lang;
  rec.continuous = true;
  rec.interimResults = true;
  rec.maxAlternatives = 1;
  return rec;
}

async function recordWithASR({answerSec, asrLang}){
  const stream = await getMicStream();

  const mimeType = pickMime();
  const chunks = [];
  const mr = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  let transcript = "";
  let finalTranscript = "";
  let active = true;

  const recog = createRecognizer(asrLang);

  recog.onresult = (ev)=>{
    let interim = "";
    for(let i=ev.resultIndex; i<ev.results.length; i++){
      const res = ev.results[i];
      const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
      if(res.isFinal){
        finalTranscript += txt.trim() + " ";
      }else{
        interim += txt;
      }
    }
    transcript = (finalTranscript + interim).trim();
  };

  recog.onerror = (ev)=>{
    // ignore
  };

  recog.onend = ()=>{
    if(active){
      try{ recog.start(); }catch(e){}
    }
  };

  mr.ondataavailable = (ev)=>{
    if(ev.data && ev.data.size>0) chunks.push(ev.data);
  };

  function stopTracks(){
    try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
  }

  mr.start(250);
  try{ recog.start(); }catch(e){}

  await sleep(answerSec * 1000);

  active = false;
  await new Promise((resolve)=>{
    mr.onstop = ()=> resolve(true);
    try{ mr.stop(); }catch(e){ resolve(true); }
  });
  try{ recog.stop(); }catch(e){}
  stopTracks();

  const blob = new Blob(chunks, { type: mimeType || "audio/webm" });
  const asrText = transcript.trim();

  return { blob, asrText };
}

/* =========================
   App State
========================= */
let bankSets = [];
let currentSet = null;
let currentRun = null;
let lastReview = null;

function runId(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `RUN-${y}${m}${day}-${hh}${mm}${ss}`;
}

/* =========================
   Views / Tabs
========================= */
function setActiveTab(tabId){
  for(const b of [$("#tabBank"), $("#tabRun"), $("#tabReview"), $("#tabSettings")]){
    b.classList.remove("active");
  }
  $(tabId).classList.add("active");
}
function showView(name){
  $("#viewBank").style.display = (name==="bank") ? "" : "none";
  $("#viewRun").style.display = (name==="run") ? "" : "none";
  $("#viewReview").style.display = (name==="review") ? "" : "none";
  $("#viewSettings").style.display = (name==="settings") ? "" : "none";
}

/* =========================
   Rendering
========================= */
function renderSupportBox(){
  const box = $("#supportBox");
  const problems = [];
  if(!isSecure) problems.push("ã“ã®ãƒšãƒ¼ã‚¸ã¯ secure context ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆhttps ã¾ãŸã¯ localhost ãŒå¿…è¦ã§ã™ï¼‰ã€‚ãƒã‚¤ã‚¯æ¨©é™ãŒå‡ºãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
  if(!hasMediaRecorder) problems.push("MediaRecorder ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆéŒ²éŸ³ä¸å¯ï¼‰ã€‚");
  if(!hasSpeechRecognition) problems.push("SpeechRecognition ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆæ–‡å­—èµ·ã“ã—ä¸å¯ï¼‰ã€‚ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ãªã®ã§å‹•ä½œã§ãã¾ã›ã‚“ã€‚");
  if(problems.length){
    box.style.display = "";
    box.innerHTML = `<div style="font-weight:900; margin-bottom:4px;">å‹•ä½œè¦ä»¶NG</div><ul style="margin:0; padding-left:18px; line-height:1.55;">${
      problems.map(p=>`<li>${p}</li>`).join("")
    }</ul>`;
  }else{
    box.style.display = "none";
    box.textContent = "";
  }
}

function renderBank(){
  $("#kpiSets").textContent = String(bankSets.length);
  const last = metaGet("last_import");
  last.then(v=> $("#kpiLastImport").textContent = v ? fmtTime(v) : "-");
  $("#kpiBrowser").textContent = isEdgeOrChrome ? "Edge/Chromeç³»" : "ãã®ä»–";

  const list = $("#setList");
  list.innerHTML = "";
  $("#emptyMsg").style.display = bankSets.length ? "none" : "";
  for(const s of bankSets.sort((a,b)=> (b.imported_at||"").localeCompare(a.imported_at||""))){
    const el = document.createElement("div");
    el.className = "item";
    const tags = (s.tags||[]).slice(0,8).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("");
    el.innerHTML = `
      <div class="top">
        <div class="grow">
          <div class="name">${escapeHtml(s.title || s.set_id)}</div>
          <div class="sub mono">${escapeHtml(s.set_id)} ãƒ» imported ${escapeHtml(fmtTime(s.imported_at))}</div>
          <div class="meta">
            <span class="chip">difficulty: <strong>${escapeHtml(s.difficulty || "mid")}</strong></span>
            ${tags}
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
          <button class="btn pri small" data-act="start" data-id="${escapeAttr(s.set_id)}">é–‹å§‹</button>
          <button class="btn small" data-act="delete" data-id="${escapeAttr(s.set_id)}">å‰Šé™¤</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  }

  list.onclick = async (ev)=>{
    const btn = ev.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");
    if(!act || !id) return;
    if(act==="start"){
      const s = bankSets.find(x=>x.set_id===id);
      if(!s) return;
      await openRunWithSet(s);
    }else if(act==="delete"){
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${id}`)) return;
      await setsDelete(id);
      bankSets = await setsGetAll();
      renderBank();
      toast("å‰Šé™¤ã—ã¾ã—ãŸ");
    }
  };
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}
function escapeAttr(s){
  return escapeHtml(s).replace(/"/g, "&quot;");
}

function mdToHtml(md){
  const lines = String(md||"").split(/\r?\n/);
  const out = [];
  let i=0;
  while(i<lines.length){
    const line = lines[i];
    const isTableRow = /^\s*\|.*\|\s*$/.test(line);
    if(isTableRow){
      const rows = [];
      while(i<lines.length && /^\s*\|.*\|\s*$/.test(lines[i])){ rows.push(lines[i]); i++; }
      const parsed = rows.map(r=> r.trim().slice(1,-1).split("|").map(c=>c.trim()));
      const sepIdx = parsed.findIndex(r=> r.every(c=> /^:?-{3,}:?$/.test(c)));
      let head = parsed[0];
      let bodyRows = parsed.slice(1);
      if(sepIdx===1){
        head = parsed[0];
        bodyRows = parsed.slice(2);
      }
      const th = head.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
      const tb = bodyRows.map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(c)}</td>`).join("")}</tr>`).join("");
      out.push(`<table><thead><tr>${th}</tr></thead><tbody>${tb}</tbody></table>`);
      continue;
    }

    const esc = escapeHtml(line).replace(/`([^`]+)`/g, (_,c)=>`<code>${escapeHtml(c)}</code>`);
    if(esc.trim()===""){
      out.push(`<div style="height:8px;"></div>`);
    }else{
      out.push(`<div>${esc}</div>`);
    }
    i++;
  }
  return out.join("");
}

/* =========================
   Run Flow (Strict)
========================= */
let runAbort = false;
let isRunning = false;

function setPhase(phase){
  $("#phaseBadge").textContent = `Phase: ${phase}`;
}

function setTimer(sec, hint){
  $("#bigTimer").textContent = String(sec).padStart(2,'0');
  $("#timerHint").textContent = hint || "";
}

async function countdown(sec, hint){
  for(let s=sec; s>=0; s--){
    setTimer(s, hint);
    await sleep(1000);
    if(runAbort) throw new Error("aborted");
  }
}

async function openRunWithSet(setObj){
  currentSet = setObj;
  lastReview = null;
  currentRun = null;

  $("#runSetBadge").textContent = `Set: ${setObj.set_id}`;
  $("#materialView").innerHTML = `
    <div style="font-weight:950; font-size:14px; margin-bottom:4px;">${escapeHtml(setObj.material.title || "Material")}</div>
    <div class="muted" style="font-size:12px; line-height:1.5; margin-bottom:10px;">${escapeHtml(setObj.material.context || "")}</div>
    <div class="material">${mdToHtml(setObj.material.body_markdown)}</div>
  `;
  $("#qTitle").textContent = "-";
  $("#qText").textContent = "-";
  $("#recStatus").textContent = "éŒ²éŸ³ï¼š- / æ–‡å­—èµ·ã“ã—ï¼š-";

  $("#btnGoReview").disabled = true;
  $("#btnRunRestart").disabled = true;

  setPhase("Ready");
  setTimer("--", "é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„");

  setActiveTab("#tabRun");
  showView("run");
}

async function runSession(){
  if(!currentSet) return;
  if(isRunning) return;
  if(!hasSpeechRecognition || !hasMediaRecorder){
    toast("ã“ã®ç’°å¢ƒã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ï¼ˆSpeechRecognition/MediaRecorderå¿…é ˆï¼‰");
    return;
  }

  runAbort = false;
  isRunning = true;
  $("#btnRunStart").disabled = true;
  $("#btnRunRestart").disabled = true;
  $("#btnGoReview").disabled = true;

  $("#micWarn").style.display = "none";
  $("#micWarn").textContent = "";

  TTSEngine.cancel();

  const asrLang = $("#asrLang").value || "en-US";
  const ttsRate = Number($("#ttsRate").value || 1.0);

  const run = {
    run_id: runId(),
    set_id: currentSet.set_id,
    started_at: nowISO(),
    answers: []
  };

  try{
    setPhase("Read Material (45s)");
    $("#qTitle").textContent = "Material";
    $("#qText").textContent = "Read the material silently. (45 seconds)";
    $("#recStatus").textContent = "éŒ²éŸ³ï¼š- / æ–‡å­—èµ·ã“ã—ï¼š-";

    await countdown(currentSet.material.read_time_sec ?? 45, "è³‡æ–™ã‚’èª­ã‚€ï¼ˆ45ç§’ï¼‰");

    const qs = [...currentSet.questions].sort((a,b)=>a.q_index-b.q_index);

    for(const q of qs){
      if(runAbort) throw new Error("aborted");
      const qIndex = q.q_index;

      setPhase(`Q${qIndex}`);
      $("#qTitle").textContent = `Question ${qIndex}`;
      $("#qText").textContent = q.question_text;
      $("#recStatus").textContent = "éŒ²éŸ³ï¼šå¾…æ©Ÿ / æ–‡å­—èµ·ã“ã—ï¼šå¾…æ©Ÿ";

      if(TTS_ON && TTSEngine.supported()){
        $("#timerHint").textContent = (qIndex === 10 && q.ask_twice) ? "Q10ã®è³ªå•ã‚’2å›èª­ã¿ä¸Šã’ä¸­" : `Q${qIndex} è³ªå•èª­ã¿ä¸Šã’`;
        setTimer("--", "TTS...");

        if(qIndex === 10 && q.ask_twice){
          await TTSEngine.speak(q.question_text, {rate: ttsRate, lang:"en-US", interrupt:true});
          await sleep(220);
          await TTSEngine.speak(q.question_text, {rate: ttsRate, lang:"en-US", interrupt:true});
          await sleep(250);
        }else{
          await TTSEngine.speak(q.question_text, {rate: ttsRate, lang:"en-US", interrupt:true});
          await sleep(200);
        }
      }

      setPhase(`Q${qIndex} - Preparation (${q.prep_sec}s)`);
      $("#recStatus").textContent = "éŒ²éŸ³ï¼šå¾…æ©Ÿ / æ–‡å­—èµ·ã“ã—ï¼šå¾…æ©Ÿ";
      await countdown(q.prep_sec ?? 3, "æº–å‚™");

      setPhase(`Q${qIndex} - Answer (${q.answer_sec}s)`);
      $("#recStatus").textContent = "éŒ²éŸ³ï¼šéŒ²éŸ³ä¸­â€¦ / æ–‡å­—èµ·ã“ã—ï¼šãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰â€¦";

      const recPromise = recordWithASR({answerSec: q.answer_sec, asrLang});
      for(let s=q.answer_sec; s>=0; s--){
        setTimer(s, "å›ç­”ä¸­ï¼ˆéŒ²éŸ³ï¼‹æ–‡å­—èµ·ã“ã—ï¼‰");
        await sleep(1000);
        if(runAbort) throw new Error("aborted");
      }
      const { blob, asrText } = await recPromise;

      if(!asrText){
        throw new Error(`SpeechRecognitionã§æ–‡å­—èµ·ã“ã—ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆQ${qIndex}ï¼‰ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š/æ¨©é™/è¨€èªè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
      }

      run.answers.push({
        q_index: qIndex,
        recorded_at: nowISO(),
        audio_blob: blob,
        asr_text: asrText
      });

      $("#recStatus").textContent = "éŒ²éŸ³ï¼šå®Œäº† / æ–‡å­—èµ·ã“ã—ï¼šå®Œäº†";
      await sleep(400);
    }

    setPhase("Completed");
    setTimer("--", "å®Œäº†ã—ã¾ã—ãŸã€‚Reviewã¸é€²ã‚ã¾ã™ã€‚");
    $("#qTitle").textContent = "Done";
    $("#qText").textContent = "All questions completed.";
    $("#btnGoReview").disabled = false;
    $("#btnRunRestart").disabled = false;

    currentRun = run;
    lastReview = buildReview(run, currentSet);

    toast("å®Œäº†ï¼");
  }catch(e){
    const msg = (e && e.message) ? e.message : String(e);
    if(msg==="aborted" || msg.includes("aborted")){
      toast("ä¸­æ–­ã—ã¾ã—ãŸ");
    }else{
      $("#micWarn").style.display = "";
      $("#micWarn").textContent = msg;
      toast("ã‚¨ãƒ©ãƒ¼");
    }
    setPhase("Stopped");
    setTimer("--", "åœæ­¢");
    $("#btnRunRestart").disabled = false;
  }finally{
    isRunning = false;
    $("#btnRunStart").disabled = false;
    TTSEngine.cancel();
  }
}

function buildReview(run, setObj){
  const answers = run.answers.map(a=>({
    q_index: a.q_index,
    asr_text: a.asr_text,
    audio_url: URL.createObjectURL(a.audio_blob),
    recorded_at: a.recorded_at
  }));
  return {
    run_id: run.run_id,
    started_at: run.started_at,
    set: setObj,
    answers
  };
}

function buildEvalPrompt(review){
  const s = review.set;
  const matTitle = s.material.title || "Material";
  const ctx = s.material.context || "";
  const mat = s.material.body_markdown || "";

  const qs = [...s.questions].sort((a,b)=>a.q_index-b.q_index);
  const ansMap = new Map(review.answers.map(a=>[a.q_index, a]));

  const blocks = qs.map(q=>{
    const a = ansMap.get(q.q_index);
    return [
      `ã€Q${q.q_index}ã€‘`,
      `Question: ${q.question_text}`,
      `My answer (ASR): ${a ? a.asr_text : "(missing)"}`,
      `Expected points: ${Array.isArray(q.expected_points) ? q.expected_points.join(" / ") : ""}`,
      `Model answer: ${q.model_answer || ""}`
    ].join("\n");
  }).join("\n\n");

  return `ã‚ãªãŸã¯ TOEIC Speaking ã®æ¡ç‚¹å®˜ã§ã™ã€‚
ç§ã¯ã€ŒQ8â€“10ï¼ˆæç¤ºæƒ…å ±ã«åŸºã¥ãå¿œç­”ï¼‰ã€å°‚ç”¨ç·´ç¿’ã‚¢ãƒ—ãƒªã§ç·´ç¿’ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è³‡æ–™ã¨è¨­å•ã«å¯¾ã—ã€ç§ã®å›ç­”ï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰ã‚’TOEICåŸºæº–ã§å³ã—ã‚ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

# è©•ä¾¡è¦³ç‚¹
- è³‡æ–™ã«åŸºã¥ã„ã¦ã„ã‚‹ã‹ï¼ˆæ­£ç¢ºæ€§ï¼‰
- è¨­å•ã¸ã®ç­”ãˆã«ãªã£ã¦ã„ã‚‹ã‹ï¼ˆé–¢é€£æ€§ï¼‰
- å¿…è¦æƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ã‹ï¼ˆå®Œæˆåº¦ï¼‰
- 15ç§’/30ç§’ã§åã¾ã‚‹è‡ªç„¶ã•ï¼ˆç°¡æ½”ã•ã€æµæš¢ã•ï¼‰
- æ–‡æ³•/èªå½™/è¨€ã„å›ã—ã®è‡ªç„¶ã•
â€»ç™ºéŸ³ã¯éŸ³å£°ãŒãªã„ãŸã‚æ¨å®šã‚³ãƒ¡ãƒ³ãƒˆã«ç•™ã‚ã¦ã‚ˆã„ï¼ˆASRã®å´©ã‚Œã‚’æ ¹æ‹ ã«ã—ã™ããªã„ï¼‰

# å‡ºåŠ›å½¢å¼
- Q8: ã‚¹ã‚³ã‚¢(0-100) / è‰¯ã„ç‚¹ / è¶³ã‚Šãªã„ç‚¹ / æ”¹å–„ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆ / 100ç‚¹æ¨¡ç¯„å›ç­”
- Q9: åŒä¸Š
- Q10: åŒä¸Š
- æœ€å¾Œã«ã€Œæ¬¡ã®1ã‚»ãƒƒãƒˆã§æ„è­˜ã™ã‚‹3ç‚¹ã€

---è³‡æ–™---
Title: ${matTitle}
Context: ${ctx}

${mat}

---è¨­å•ã¨ç§ã®å›ç­”ï¼ˆASRï¼‰---
${blocks}
`;
}

/* =========================
   Review Render
========================= */
function renderReview(){
  if(!lastReview){
    $("#reviewMeta").textContent = "ã¾ã Reviewãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Runã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚";
    $("#reviewMaterial").innerHTML = "";
    $("#reviewQuestions").innerHTML = "";
    $("#evalPromptPreview").value = "";
    return;
  }
  const r = lastReview;
  $("#reviewMeta").textContent = `run_id=${r.run_id} ãƒ» started=${fmtTime(r.started_at)} ãƒ» set=${r.set.set_id}`;
  $("#reviewMaterial").innerHTML = `
    <div style="font-weight:950; font-size:14px; margin-bottom:4px;">${escapeHtml(r.set.material.title || "Material")}</div>
    <div class="muted" style="font-size:12px; line-height:1.5; margin-bottom:10px;">${escapeHtml(r.set.material.context || "")}</div>
    <div class="material">${mdToHtml(r.set.material.body_markdown)}</div>
  `;

  const prompt = buildEvalPrompt(r);
  $("#evalPromptPreview").value = prompt;

  const qsWrap = $("#reviewQuestions");
  qsWrap.innerHTML = "";

  const qs = [...r.set.questions].sort((a,b)=>a.q_index-b.q_index);
  const ansMap = new Map(r.answers.map(a=>[a.q_index, a]));

  for(const q of qs){
    const a = ansMap.get(q.q_index);
    const hasModel = !!(q.model_answer && String(q.model_answer).trim());
    const card = document.createElement("div");
    card.className = "card";
    card.style.boxShadow = "none";
    card.innerHTML = `
      <div class="row" style="align-items:flex-start;">
        <div class="grow">
          <div style="font-weight:950; font-size:14px; margin-bottom:4px;">Q${q.q_index}</div>
          <div class="qbox">
            <div class="qtitle">Question</div>
            <div class="qtext">${escapeHtml(q.question_text)}</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          ${hasModel ? `<button class="btn small" data-ttsmodel="${q.q_index}">ğŸ”Š æ¨¡ç¯„</button>` : ``}
          ${a ? `<button class="btn small" data-play="${q.q_index}">â–¶ å†ç”Ÿ</button>` : ``}
          ${a ? `<button class="btn small" data-copyasr="${q.q_index}">ASRã‚³ãƒ”ãƒ¼</button>` : ``}
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCol">
        <div>
          <div class="muted" style="font-size:12px; margin-bottom:6px;">ã‚ãªãŸã®å›ç­”ï¼ˆASRï¼‰</div>
          <textarea class="textarea mono" readonly>${escapeHtml(a ? a.asr_text : "(missing)")}</textarea>
        </div>
        <div>
          <div class="muted" style="font-size:12px; margin-bottom:6px;">æ¨¡ç¯„è§£ç­”</div>
          <textarea class="textarea mono" readonly>${escapeHtml(q.model_answer || "")}</textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted" style="font-size:12px; margin-bottom:6px;">æœŸå¾…è¦ç´ ï¼ˆexpected_pointsï¼‰</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        ${(q.expected_points||[]).map(p=>`<span class="chip">â€¢ ${escapeHtml(p)}</span>`).join("") || `<span class="muted">ï¼ˆãªã—ï¼‰</span>`}
      </div>

      <audio id="aud_${q.q_index}" preload="none" src="${a ? a.audio_url : ""}"></audio>
      <div class="footnote" style="margin-top:8px;">
        recorded: ${escapeHtml(a ? fmtTime(a.recorded_at) : "-")}
      </div>
    `;
    qsWrap.appendChild(card);
  }

  qsWrap.onclick = async (ev)=>{
    const ttsBtn = ev.target.closest("button[data-ttsmodel]");
    if(ttsBtn){
      const idx = Number(ttsBtn.getAttribute("data-ttsmodel"));
      if(!TTSEngine.supported()){
        toast("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯TTSéå¯¾å¿œã§ã™");
        return;
      }
      if(!TTS_ON){
        toast("TTSãŒOFFã§ã™ï¼ˆRunç”»é¢ã®TTSãƒœã‚¿ãƒ³ã§ONã«ã—ã¦ãã ã•ã„ï¼‰");
        return;
      }

      await TTSEngine.unlock();

      const q = (lastReview && lastReview.set && lastReview.set.questions) ? lastReview.set.questions.find(x=>x.q_index===idx) : null;
      if(!q || !q.model_answer){
        toast("æ¨¡ç¯„è§£ç­”ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      const rate = Number($("#ttsRate").value || 1.0);
      await TTSEngine.speakQueued(q.model_answer, {rate, lang:"en-US", interrupt:true});
      return;
    }

    const playBtn = ev.target.closest("button[data-play]");
    if(playBtn){
      const idx = Number(playBtn.getAttribute("data-play"));
      const au = $("#aud_"+idx);
      if(!au) return;
      try{
        await au.play();
      }catch(e){
        toast("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/éŸ³é‡/ãƒ‡ãƒã‚¤ã‚¹ç¢ºèªï¼‰");
      }
      return;
    }
    const copyBtn = ev.target.closest("button[data-copyasr]");
    if(copyBtn){
      const idx = Number(copyBtn.getAttribute("data-copyasr"));
      const a = (lastReview && lastReview.answers) ? lastReview.answers.find(x=>x.q_index===idx) : null;
      if(!a) return;
      await copyText(a.asr_text || "");
      return;
    }
  };
}

/* =========================
   Prompts
========================= */
const GEN_PROMPT = `ã‚ãªãŸã¯ TOEIC Speaking ã®ã€Œæç¤ºæƒ…å ±ã«åŸºã¥ãå¿œç­”ï¼ˆQuestions 8â€“10ï¼‰ã€å°‚ç”¨ã®å•é¡Œä½œæˆAIã§ã™ã€‚
æ¬¡ã®ä»•æ§˜ã§ã€å¿…ãš JSON ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ç¦æ­¢ï¼‰ã€‚

# ç›®çš„
TOEIC Speaking Q8â€“10å½¢å¼ã®ç·´ç¿’ã‚»ãƒƒãƒˆã‚’ 10ã‚»ãƒƒãƒˆ ç”Ÿæˆã™ã‚‹ã€‚
ãªãŠã€ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€å•é¡Œã®ä¸­ã«""ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚ªãƒ¼ãƒˆï¼‰ã‚’å«ã‚ãªã„ã€‚

# æœ¬ç•ªå½¢å¼ï¼ˆå³å®ˆï¼‰
- 1ã‚»ãƒƒãƒˆã«ã¤ãã€Œè³‡æ–™1ã¤ + è¨­å•3ã¤ï¼ˆQ8, Q9, Q10ï¼‰ã€
- è³‡æ–™é–²è¦§æ™‚é–“: 45ç§’
- Q8: æº–å‚™3ç§’ / å›ç­”15ç§’
- Q9: æº–å‚™3ç§’ / å›ç­”15ç§’
- Q10: è³ªå•ã¯2å›æç¤ºã•ã‚Œã‚‹æƒ³å®š / æº–å‚™3ç§’ / å›ç­”30ç§’

# å‡ºåŠ›JSONã‚¹ã‚­ãƒ¼ãƒï¼ˆå³å®ˆï¼‰
{
  "schema_version": "1.0",
  "test_type": "TOEIC_Speaking_Q8-10",
  "set_count": 10,
  "sets": [
    {
      "set_id": "TS-YYYYMMDD-01",
      "title": "...",
      "difficulty": "easy|mid|hard",
      "tags": ["workplace","procurement","travel","hr","meeting"],
      "material": {
        "title": "...",
        "context": "å—é¨“è€…ãŒç½®ã‹ã‚ŒãŸçŠ¶æ³ï¼ˆ1-2æ–‡ï¼‰",
        "body_markdown": "è³‡æ–™ï¼ˆè¡¨/ãƒ¡ãƒ¼ãƒ«/æ¡ˆå†…ï¼‰ã‚’Markdownã§ã€‚æƒ…å ±ã¯éä¸è¶³ãªãã€‚å›ºæœ‰åè©/æ—¥æ™‚/ä¾¡æ ¼/å ´æ‰€ã‚’å«ã‚ã‚‹ã€‚",
        "read_time_sec": 45
      },
      "questions": [
        {
          "q_index": 8,
          "prep_sec": 3,
          "answer_sec": 15,
          "ask_twice": false,
          "question_text": "...?",
          "expected_points": ["è³‡æ–™ã‹ã‚‰æ‹¾ã†ã¹ãè¦ç‚¹ã‚’3-6å€‹"],
          "model_answer": "15ç§’ã§è¨€ã„åˆ‡ã‚Œã‚‹è‡ªç„¶ãªè‹±èªï¼ˆ1-2æ–‡ä¸­å¿ƒï¼‰"
        },
        {
          "q_index": 9,
          "prep_sec": 3,
          "answer_sec": 15,
          "ask_twice": false,
          "question_text": "...?",
          "expected_points": ["..."],
          "model_answer": "..."
        },
        {
          "q_index": 10,
          "prep_sec": 3,
          "answer_sec": 30,
          "ask_twice": true,
          "question_text": "...?",
          "expected_points": ["è³‡æ–™ã‹ã‚‰æ‹¾ã†ã¹ãè¦ç‚¹ã‚’4-8å€‹"],
          "model_answer": "30ç§’ã§è‡ªç„¶ã«èª¬æ˜ï¼ˆ2-4æ–‡ï¼‰"
        }
      ]
    }
  ]
}

# è¿½åŠ æ¡ä»¶
- 10ã‚»ãƒƒãƒˆã¯å†…å®¹ãŒè¢«ã‚‰ãªã„ï¼ˆè³‡æ–™ã‚¿ã‚¤ãƒ—/å ´é¢/æ•°å­—ã®ç¨®é¡ã‚’åˆ†æ•£ï¼‰
- è³‡æ–™ã¯ã€Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã€ã€Œæ–™é‡‘è¡¨ã€ã€Œç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã€ã€Œã‚¤ãƒ™ãƒ³ãƒˆæ¡ˆå†…ã€ã€Œå‡ºå¼µè¡Œç¨‹ã€ã€Œä¼šè­°å®¤äºˆç´„ã€ãªã©ã€å®Ÿå‹™çš„ãªã‚‚ã®
- æ¨¡ç¯„è§£ç­”ã¯è³‡æ–™ä»¥å¤–ã‚’æé€ ã—ãªã„ï¼ˆè³‡æ–™æ ¹æ‹ 100%ï¼‰
- è‹±èªã¯ãƒ“ã‚¸ãƒã‚¹è‡ªç„¶ä½“ã€‚é›£èªã‚’ä½¿ã„ã™ããªã„ã€‚

å‡ºåŠ›ã¯JSONã®ã¿ã€‚`;

/* =========================
   Export
========================= */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1200);
}

/* =========================
   Events
========================= */
$("#tabBank").onclick = ()=>{ setActiveTab("#tabBank"); showView("bank"); };
$("#tabRun").onclick = ()=>{ setActiveTab("#tabRun"); showView("run"); };
$("#tabReview").onclick = ()=>{ setActiveTab("#tabReview"); showView("review"); renderReview(); };
$("#tabSettings").onclick = ()=>{ setActiveTab("#tabSettings"); showView("settings"); };

$("#btnPickJson").onclick = ()=> $("#filePick").click();
$("#filePick").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  await importJsonFile(f);
  ev.target.value = "";
});

const dz = $("#dropZone");
dz.addEventListener("dragover",(ev)=>{ ev.preventDefault(); dz.classList.add("dragover"); });
dz.addEventListener("dragleave",()=> dz.classList.remove("dragover"));
dz.addEventListener("drop", async (ev)=>{
  ev.preventDefault();
  dz.classList.remove("dragover");
  const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
  if(!f) return;
  await importJsonFile(f);
});

async function importJsonFile(file){
  try{
    const raw = await file.text();
    const { json } = parseJsonLenient(raw);
    const sets = normalizeImported(json);

    await setsPutMany(sets);
    await metaSet("last_import", nowISO());

    bankSets = await setsGetAll();
    renderBank();
    toast(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${sets.length}ã‚»ãƒƒãƒˆ`);
  }catch(e){
    toast("å–ã‚Šè¾¼ã¿å¤±æ•—");
    alert(`Import Error:\n${e.message || e}`);
  }
}

async function importJsonText(rawText){
  try{
    const raw = String(rawText||"");
    const { json } = parseJsonLenient(raw);
    const sets = normalizeImported(json);

    await setsPutMany(sets);
    await metaSet("last_import", nowISO());

    bankSets = await setsGetAll();
    renderBank();
    toast(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${sets.length}ã‚»ãƒƒãƒˆ`);
    return true;
  }catch(e){
    toast("å–ã‚Šè¾¼ã¿å¤±æ•—");
    alert(`Import Error:\n${e.message || e}`);
    return false;
  }
}

$("#btnImportJsonText").onclick = async ()=>{
  const txt = ($("#jsonPaste").value || "");
  if(!txt.trim()){
    toast("è²¼ã‚Šä»˜ã‘ãŒç©ºã§ã™");
    return;
  }
  await importJsonText(txt);
};

$("#btnClearJsonPaste").onclick = ()=>{
  $("#jsonPaste").value = "";
  toast("ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
};

$("#btnStartRandom").onclick = async ()=>{
  if(!bankSets.length){ toast("ã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const s = bankSets[Math.floor(Math.random()*bankSets.length)];
  await openRunWithSet(s);
};

$("#btnExportAll").onclick = async ()=>{
  if(!bankSets.length){ toast("ã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const payload = {
    schema_version: "1.0",
    exported_at: nowISO(),
    set_count: bankSets.length,
    sets: bankSets
  };
  downloadText(`toeic_q8q10_sets_export_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2));
  toast("Exportã—ã¾ã—ãŸ");
};

$("#btnClearAll").onclick = async ()=>{
  if(!confirm("DBã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆå–ã‚Šè¾¼ã¿æ¸ˆã¿ã‚»ãƒƒãƒˆãŒæ¶ˆãˆã¾ã™ï¼‰")) return;
  try{
    await dbClearAll();
    bankSets = [];
    toast("DBã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    location.reload();
  }catch(e){
    alert("DBåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (e.message||e));
  }
};

$("#btnCopyGenPrompt").onclick = async ()=>{
  await copyText(GEN_PROMPT);
};

$("#btnRunStart").onclick = async ()=>{
  try{
    if(TTS_ON && TTSEngine.supported()){
      await TTSEngine.unlock();
    }
  }catch(e){}

  try{
    if(!isSecure){
      $("#micWarn").style.display = "";
      $("#micWarn").textContent = "https ã¾ãŸã¯ localhost ã§é–‹ã„ã¦ãã ã•ã„ï¼ˆsecure contextå¿…é ˆï¼‰";
      return;
    }
    if(!hasSpeechRecognition){
      $("#micWarn").style.display = "";
      $("#micWarn").textContent = "SpeechRecognitionãŒä½¿ãˆã¾ã›ã‚“ã€‚ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ã®ãŸã‚å‹•ä½œã§ãã¾ã›ã‚“ã€‚Edge/Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚";
      return;
    }
    if(!hasMediaRecorder){
      $("#micWarn").style.display = "";
      $("#micWarn").textContent = "MediaRecorderãŒä½¿ãˆã¾ã›ã‚“ï¼ˆéŒ²éŸ³ä¸å¯ï¼‰ã€‚";
      return;
    }
    const st = await getMicStream();
    st.getTracks().forEach(t=>t.stop());
  }catch(e){
    $("#micWarn").style.display = "";
    $("#micWarn").textContent = "ãƒã‚¤ã‚¯æ¨©é™ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    return;
  }
  await runSession();
};

$("#btnAbortRun").onclick = ()=>{
  if(!isRunning){
    toast("å®Ÿè¡Œä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  runAbort = true;
  TTSEngine.cancel();
  toast("ä¸­æ–­è¦æ±‚â€¦");
};

$("#btnRunRestart").onclick = async ()=>{
  if(!currentSet) return;
  runAbort = true;
  TTSEngine.cancel();
  await sleep(150);
  await openRunWithSet(currentSet);
  toast("ã‚„ã‚Šç›´ã—æº–å‚™å®Œäº†");
};

$("#btnGoReview").onclick = ()=>{
  setActiveTab("#tabReview");
  showView("review");
  renderReview();
};

$("#btnBackToBank").onclick = ()=>{
  setActiveTab("#tabBank");
  showView("bank");
};

$("#btnCopyEvalPrompt").onclick = async ()=>{
  const txt = $("#evalPromptPreview").value || "";
  if(!txt){ toast("Reviewãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  await copyText(txt);
};

$("#btnTtsToggle").onclick = ()=>{
  TTS_ON = !TTS_ON;
  $("#btnTtsToggle").textContent = TTS_ON ? "ğŸ”Š TTS: ON" : "ğŸ”‡ TTS: OFF";
  toast(TTS_ON ? "TTS ON" : "TTS OFF");
  if(!TTS_ON) TTSEngine.cancel();
};

$("#ttsRate").addEventListener("input", ()=>{
  $("#ttsRateBadge").textContent = String($("#ttsRate").value);
});

/* =========================
   Settings - capability list
========================= */
function renderCapabilities(){
  const cap = $("#capList");
  cap.innerHTML = "";
  const items = [
    {name:"Secure Context (https/localhost)", ok:isSecure, note:"ãƒã‚¤ã‚¯æ¨©é™ã¨Web Speechã®å‰æ"},
    {name:"MediaRecorder (éŒ²éŸ³)", ok:hasMediaRecorder, note:"éŒ²éŸ³ãŒå¿…é ˆ"},
    {name:"SpeechRecognition (æ–‡å­—èµ·ã“ã—)", ok:hasSpeechRecognition, note:"ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç„¡ã—ã€‚å¿…é ˆ"},
    {name:"Browser hint", ok:isEdgeOrChrome, note:"Edge/Chromeç³»æ¨å¥¨ï¼ˆASRå®‰å®šï¼‰"},
    {name:"TTS (speechSynthesis)", ok:TTSEngine.supported(), note:"iOSã¯watchdog/åˆ†å‰²ã§ãƒ•ãƒªãƒ¼ã‚ºå›é¿"},
  ];
  for(const it of items){
    const d = document.createElement("div");
    d.className = "badge " + (it.ok ? "ok" : "danger");
    d.style.justifyContent = "space-between";
    d.style.gap = "12px";
    d.innerHTML = `<span style="font-weight:900">${escapeHtml(it.name)}</span>
                   <span class="muted" style="font-size:12px">${it.ok ? "OK" : "NG"} ãƒ» ${escapeHtml(it.note)}</span>`;
    cap.appendChild(d);
  }
}

/* =========================
   Boot
========================= */
(async function boot(){
  renderSupportBox();
  renderCapabilities();

  if(!hasSpeechRecognition){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ SpeechRecognitionï¼ˆWeb Speech APIï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\næœ¬ã‚¢ãƒ—ãƒªã¯ã€Œæ–‡å­—èµ·ã“ã—ç„¡ã—ï¼æ‰‹å…¥åŠ›ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æŒãŸãªã„ãŸã‚ã€åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nEdge / Chromeï¼ˆPCï¼‰ã§é–‹ã„ã¦ãã ã•ã„ã€‚");
  }

  try{
    bankSets = await setsGetAll();
  }catch(e){
    console.warn(e);
  }
  renderBank();

  setActiveTab("#tabBank");
  showView("bank");
})();
</script>
</body>
</html>
