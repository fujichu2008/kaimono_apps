<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>ゆるビート（8レーン×ドレミ民謡風）</title>
<meta name="theme-color" content="#7dc4ff">
<style>
  :root{
    --bg-top:#e9f5ff; --bg-bottom:#cfe9ff; --line:#cfe3ff; --text:#0f172a;
    --lane-gap:6px; --hitline:#0ea5e9; --note:#1f2937; --good:#22c55e; --warn:#f59e0b;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    color:var(--text);
    background:linear-gradient(var(--bg-top), var(--bg-bottom));
    touch-action: manipulation;
  }
  .app{max-width:980px; margin:0 auto; padding:12px; min-height:100%; display:flex; flex-direction:column; gap:12px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px}
  header h1{font-size:20px; margin:0; white-space:nowrap}
  header .score{
    display:flex; align-items:center; gap:10px; font-weight:700;
  }
  .card{
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  .row > *{flex:0 0 auto}
  .btn{
    background:#0ea5e9; color:#fff; border:none; border-radius:999px; padding:12px 18px; font-size:16px; font-weight:700;
    box-shadow:0 4px 0 #0986bb; cursor:pointer; transition:transform .05s ease; user-select:none;
  }
  .btn:active{transform:translateY(2px); box-shadow:0 2px 0 #0986bb}
  .btn.secondary{background:#10b981; box-shadow:0 4px 0 #0b9468}
  .btn.ghost{background:#eef6ff; color:#0f172a; box-shadow:none; border:1px solid var(--line)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer}
  .pill input{display:none}
  .pill.active{outline:2px solid #0ea5e9; background:#f0fbff}
  .grid{
    display:grid; grid-template-columns: repeat(8, 1fr); gap:var(--lane-gap);
    height:64vh; min-height:420px; position:relative; isolation:isolate;
    background:linear-gradient(rgba(255,255,255,.6), rgba(255,255,255,.6));
    border:1px solid var(--line); border-radius:12px; overflow:hidden;
  }
  .lane{
    background:rgba(255,255,255,.8);
    border-left:1px dashed rgba(14,165,233,.15);
    border-right:1px dashed rgba(14,165,233,.15);
    position:relative;
  }
  .lane::after{
    content:attr(data-label);
    position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
    font-weight:800; font-size:12px; opacity:.7; letter-spacing:.02em;
    background:rgba(255,255,255,.8); padding:2px 6px; border-radius:6px; border:1px solid var(--line);
  }
  .hitline{
    position:absolute; left:0; right:0; bottom:72px; height:10px; border-top:4px solid var(--hitline); pointer-events:none;
    box-shadow:0 0 0 4px rgba(14,165,233,.06) inset;
  }
  .note{
    position:absolute; left:0; width:100%; height:34px; border-radius:10px;
    transform:translateY(-60px);
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:16px; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.3);
    will-change: transform;
  }
  /* レーン色（色覚配慮：形も後述で出す） */
  .lane.l0{background:linear-gradient(#ffe6e6,#fff)}   /* ド 赤 */
  .lane.l1{background:linear-gradient(#ffeede,#fff)}   /* レ 橙 */
  .lane.l2{background:linear-gradient(#fff7d6,#fff)}   /* ミ 黄 */
  .lane.l3{background:linear-gradient(#eaffea,#fff)}   /* ファ 緑 */
  .lane.l4{background:linear-gradient(#e7f1ff,#fff)}   /* ソ 青 */
  .lane.l5{background:linear-gradient(#f0e7ff,#fff)}   /* ラ 紫 */
  .lane.l6{background:linear-gradient(#f7f7f7,#fff)}   /* シ 白 */
  .lane.l7{background:linear-gradient(#ebebeb,#fff)}   /* 高ド 黒 */
  .note.n0{background:#ef4444} .note.n1{background:#fb923c} .note.n2{background:#f59e0b}
  .note.n3{background:#22c55e} .note.n4{background:#3b82f6} .note.n5{background:#a855f7}
  .note.n6{background:#9ca3af} .note.n7{background:#111827}
  .shape{position:absolute; inset:4px; border:3px solid rgba(255,255,255,.85); border-radius:8px}
  .shape.star{border-radius:50%; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)}
  .shape.tri{clip-path: polygon(50% 6%, 94% 94%, 6% 94%)}
  .shape.dia{transform: rotate(45deg)}
  .shape.heart{clip-path:path("M24 4c-6 0-10 5-10 10 0 10 10 14 10 14s10-4 10-14c0-5-4-10-10-10z")}
  .shape.double{border-style:double}
  .hud{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .hud .tag{
    background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-weight:700; font-size:13px;
  }
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; opacity:0;
    transition:opacity .25s ease, transform .25s ease; z-index:50; box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
  .overlay{
    position:fixed; inset:0; background:rgba(255,255,255,.8); display:none; align-items:center; justify-content:center; z-index:40;
  }
  .overlay.show{display:flex}
  .result{
    background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px; width:min(560px,90vw);
    text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .result h2{margin:4px 0 8px}
  .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:60}
  .confetti i{position:absolute; width:10px; height:16px; background:#0ea5e9; opacity:.9; transform:translateY(-20px) rotate(0deg)}
  /* タイトル/設定 */
  .setup .group{display:flex; flex-wrap:wrap; gap:8px}
  .setup h3{margin:0 0 6px}
  .instrument{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px}
  .instrument .opt{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; cursor:pointer; background:#fff}
  .instrument .opt.active{outline:2px solid #10b981; background:#f6fffb}
  .muted{opacity:.65}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>🎶 ゆるビート - 8レーン×ドレミ民謡風</h1>
    <div class="score">
      <div class="hud">
        <span class="tag">楽器: <b id="hudInstrument">🎹 ピアノ</b></span>
        <span class="tag">難易度: <b id="hudDiff">やさしい</b></span>
        <span class="tag">曲: <b id="hudSong">—</b></span>
        <span class="tag">BPM: <b id="hudBpm">—</b></span>
      </div>
      <div class="pill"><span>⭐</span> <span id="hudScore">0</span></div>
    </div>
  </header>

  <section id="setup" class="card setup">
    <h2 style="margin:0 0 8px">はじめる</h2>
    <div class="row">
      <div style="flex:1 1 320px">
        <h3>楽器をえらぶ</h3>
        <div id="instWrap" class="instrument"></div>
      </div>
      <div style="flex:1 1 220px">
        <h3>むずかしさ</h3>
        <div class="group" id="diffWrap">
          <label class="pill active"><input type="radio" name="diff" value="easy" checked>やさしい</label>
          <label class="pill"><input type="radio" name="diff" value="normal">ふつう</label>
        </div>
        <h3 style="margin-top:12px">モード</h3>
        <div class="group" id="modeWrap">
          <label class="pill active"><input type="radio" name="mode" value="melody" checked>メロディであそぶ</label>
          <label class="pill"><input type="radio" name="mode" value="free">フリードラム</label>
        </div>
        <div style="margin-top:12px" class="muted">※ はじめのタップで音が出せるようになります（iPadの仕様）</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="btn">▶ スタート（ランダム選曲）</button>
      <button id="btnHow" class="btn ghost">❓ あそびかた</button>
    </div>
  </section>

  <section id="howto" class="card" style="display:none">
    <h2 style="margin:0 0 8px">あそびかた</h2>
    <ol style="margin:8px 0 0 20px">
      <li>上からおちてくるノーツ（♪）が、下の線にきたら、同じレーンをタップ！</li>
      <li>線の中でたたければ <b>1点</b>。コンボで紙ふぶき！</li>
      <li>むずかしいときは「やさしい」をえらんでね。</li>
    </ol>
  </section>

  <section id="stage" class="card" style="display:none">
    <div class="grid" id="grid"></div>
    <div class="hitline" id="hitline"></div>
    <div class="row" style="justify-content:space-between; margin-top:8px">
      <div class="hud">
        <span class="tag" id="hudTime">00:00</span>
        <span class="tag">Combo: <b id="hudCombo">0</b></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnPause">⏸ 一時停止</button>
        <button class="btn secondary" id="btnQuit">🏁 やめる</button>
      </div>
    </div>
  </section>

  <div class="overlay" id="overlay">
    <div class="result">
      <h2>おつかれさま！</h2>
      <p style="margin:6px 0 14px">スコア <b id="resScore">0</b>　コンボ <b id="resCombo">0</b></p>
      <div style="font-size:28px; margin:2px 0 10px" id="resStars">⭐</div>
      <div class="row" style="justify-content:center">
        <button class="btn" id="btnRetry">🔁 もう1曲！</button>
        <button class="btn ghost" id="btnBack">⬅ タイトルに戻る</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Great!</div>
  <div class="confetti" id="confetti"></div>
</div>

<script>
(()=>{
// ====== 音まわり（WebAudio） ======
let audioCtx=null, masterGain=null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.9;
    masterGain.connect(audioCtx.destination);
  }
  if(audioCtx.state==='suspended') audioCtx.resume();
}
const A4=440;
function freqFromSemitone(semi){ return A4*Math.pow(2, semi/12); }
// C4..C5 ドレミファソラシド
const SEMI = { C4:-9, D4:-7, E4:-5, F4:-4, G4:-2, A4:0, B4:2, C5:3 };
const LANE_TO_SEMI = [SEMI.C4,SEMI.D4,SEMI.E4,SEMI.F4,SEMI.G4,SEMI.A4,SEMI.B4,SEMI.C5];
const LANE_FREQ = LANE_TO_SEMI.map(semi=>freqFromSemitone(semi));

// 楽器定義（絵文字・名前・プレイヤー関数）
const INSTRUMENTS = [
  { id:'piano', label:'🎹 ピアノ', play:(f,d=0.28,v=1)=>{
      ensureAudio();
      const now = audioCtx.currentTime;
      const o1=audioCtx.createOscillator(), g1=audioCtx.createGain();
      o1.type='triangle'; o1.frequency.value=f;
      g1.gain.setValueAtTime(0, now);
      g1.gain.linearRampToValueAtTime(0.9*v, now+0.01);
      g1.gain.exponentialRampToValueAtTime(0.0001, now + d);
      o1.connect(g1); g1.connect(masterGain);
      o1.start(now); o1.stop(now+d+0.02);
  }},
  { id:'bell', label:'🔔 ベル', play:(f,d=0.6,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      // FMベル
      const car=audioCtx.createOscillator();
      const mod=audioCtx.createOscillator();
      const mg=audioCtx.createGain();
      const cg=audioCtx.createGain();
      car.type='sine'; mod.type='sine';
      car.frequency.value=f; mod.frequency.value=f*2;
      mg.gain.value=f*4;
      mod.connect(mg); mg.connect(car.frequency);
      cg.gain.setValueAtTime(0,now);
      cg.gain.linearRampToValueAtTime(0.8*v, now+0.01);
      cg.gain.exponentialRampToValueAtTime(0.0001, now+d);
      car.connect(cg); cg.connect(masterGain);
      car.start(now); mod.start(now);
      car.stop(now+d+0.05); mod.stop(now+d+0.05);
  }},
  { id:'maracas', label:'🪇 マラカス', play:(f,d=0.18,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*d, audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,3);
      const src=audioCtx.createBufferSource(); src.buffer=buf;
      const bp=audioCtx.createBiquadFilter(); bp.type='highpass'; bp.frequency.value=6000;
      const g=audioCtx.createGain(); g.gain.value=0.7*v;
      src.connect(bp); bp.connect(g); g.connect(masterGain);
      src.start(now);
  }},
  { id:'drum', label:'🥁 ドラム', play:(f,d=0.2,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sine';
      const g=audioCtx.createGain(); g.gain.value=0.9*v;
      o.frequency.setValueAtTime(f*0.5, now);
      o.frequency.exponentialRampToValueAtTime(60, now+d);
      g.gain.setValueAtTime(0.9*v, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
  }},
  { id:'taiko', label:'🪘 たいこ', play:(f,d=0.28,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sine';
      const n=audioCtx.createBufferSource();
      const g=audioCtx.createGain(); const g2=audioCtx.createGain();
      // sine body
      o.frequency.setValueAtTime(f*0.8, now);
      o.frequency.exponentialRampToValueAtTime(80, now+d);
      g.gain.setValueAtTime(0.9*v, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      // noise click
      const len=d; const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*len, audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2);
      n.buffer=buf; const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
      g2.gain.setValueAtTime(0.5*v, now);
      g2.gain.exponentialRampToValueAtTime(0.0001, now+d*0.6);
      o.connect(g); g.connect(masterGain);
      n.connect(hp); hp.connect(g2); g2.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
      n.start(now); n.stop(now+d*0.6);
  }},
  { id:'trumpet', label:'🎺 トランペット', play:(f,d=0.3,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sawtooth'; const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1600;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.8*v, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(lp); lp.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
  }},
  { id:'sax', label:'🎷 サックス', play:(f,d=0.35,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sawtooth'; const g=audioCtx.createGain(); const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200;
      const lfo=audioCtx.createOscillator(); const lfg=audioCtx.createGain(); lfo.frequency.value=5; lfg.gain.value=3;
      lfo.connect(lfg); lfg.connect(o.frequency);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.85*v, now+0.035);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(lp); lp.connect(g); g.connect(masterGain);
      o.start(now); lfo.start(now); o.stop(now+d+0.05); lfo.stop(now+d+0.05);
  }},
  { id:'violin', label:'🎻 バイオリン', play:(f,d=0.42,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='triangle'; const g=audioCtx.createGain();
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.75*v, now+0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.05);
  }},
];

// ====== UI 元素 ======
const els = {
  grid: document.getElementById('grid'),
  hitline: document.getElementById('hitline'),
  setup: document.getElementById('setup'),
  stage: document.getElementById('stage'),
  how: document.getElementById('howto'),
  toast: document.getElementById('toast'),
  confetti: document.getElementById('confetti'),
  overlay: document.getElementById('overlay'),
  resScore: document.getElementById('resScore'),
  resCombo: document.getElementById('resCombo'),
  resStars: document.getElementById('resStars'),
  hud: {
    score: document.getElementById('hudScore'),
    bpm: document.getElementById('hudBpm'),
    song: document.getElementById('hudSong'),
    combo: document.getElementById('hudCombo'),
    time: document.getElementById('hudTime'),
    inst: document.getElementById('hudInstrument'),
    diff: document.getElementById('hudDiff'),
  }
};

// ====== セットアップUI ======
const instWrap = document.getElementById('instWrap');
INSTRUMENTS.forEach((it,idx)=>{
  const div=document.createElement('div');
  div.className='opt'+(idx===0?' active':'');
  div.dataset.id=it.id;
  div.innerHTML=`<b style="font-size:20px">${it.label.split(' ')[0]}</b> <span>${it.label.split(' ')[1]||''}</span>`;
  div.addEventListener('click', ()=>{
    document.querySelectorAll('.instrument .opt').forEach(n=>n.classList.remove('active'));
    div.classList.add('active');
    state.instrument = it.id;
    els.hud.inst.textContent = it.label;
  });
  instWrap.appendChild(div);
});
document.getElementById('diffWrap').addEventListener('click', e=>{
  if(e.target.closest('label')){
    document.querySelectorAll('#diffWrap .pill').forEach(n=>n.classList.remove('active'));
    e.target.closest('label').classList.add('active');
    const v=e.target.closest('label').querySelector('input').value;
    state.diff=v; els.hud.diff.textContent = (v==='easy'?'やさしい':'ふつう');
  }
});
document.getElementById('modeWrap').addEventListener('click', e=>{
  if(e.target.closest('label')){
    document.querySelectorAll('#modeWrap .pill').forEach(n=>n.classList.remove('active'));
    e.target.closest('label').classList.add('active');
    state.mode=e.target.closest('label').querySelector('input').value;
  }
});

// ====== ステージ（8レーン描画） ======
const LANE_LABELS = ['ド','レ','ミ','ファ','ソ','ラ','シ','ド'];
function buildGrid(){
  els.grid.innerHTML='';
  for(let i=0;i<8;i++){
    const lane=document.createElement('div');
    lane.className=`lane l${i}`;
    lane.dataset.index=i;
    lane.setAttribute('data-label', `${LANE_LABELS[i]} / ${['●','◆','▲','■','★','❤','♫','◎'][i]}`);
    els.grid.appendChild(lane);
  }
}
buildGrid();

// ====== 曲バンク（民謡“風”30曲） ======
// 著作権に抵触しないよう「和風ペンタトニック・民謡風」をシード生成。
// 30曲ぶんの「安定したメロディ」を毎回同じ内容で作ります。
function seedRng(seed){ let s=seed|0; return ()=> (s=(s*48271)%0x7fffffff)/0x7fffffff; }
function makeFolkSong(seed){
  const rnd=seedRng(seed);
  const title=`民謡風 #${String(seed).padStart(2,'0')}`;
  const bpm = Math.floor(80 + rnd()*30); // 80-110
  // 主にヨナ抜き長音階（C D E G A）中心に、時々F/Bで色を付ける
  const pool=[0,1,2,4,5,7]; // lane index候補（時々3,6を混ぜる）
  const notes=[];
  const bars=8; // 8小節×4拍
  let cur = 0| (rnd()*pool.length);
  const addNote=(beat,lane,len)=>{
    notes.push({t:beat, lane, len});
  };
  let beat=0;
  for(let m=0;m<bars;m++){
    for(let q=0;q<4;q++){
      // 4拍子の各拍を 1 or 1/2音にする
      const subdivision = rnd()<0.35 ? 2 : 1;
      for(let s=0;s<subdivision;s++){
        // ステップ移動 -1/0/+1
        const delta = (rnd()<0.5?0:(rnd()<0.5?-1:1));
        cur = Math.max(0, Math.min(7, (pool[cur%pool.length] + delta)));
        if(rnd()<0.12) cur = 3; // 時々ファ
        if(rnd()<0.10) cur = 6; // 時々シ
        addNote(beat, cur, 1/subdivision);
        beat += 1/subdivision;
      }
    }
  }
  return {title,bpm, notes};
}
const SONG_BANK = Array.from({length:30}, (_,i)=>makeFolkSong(i+1));

// ====== ゲーム状態 ======
const state = {
  instrument: INSTRUMENTS[0].id,
  diff: 'easy',
  mode: 'melody',
  playing: false,
  startAt: 0,
  song: null,
  notes: [],  // {t (sec), lane, len, hit?}
  yForTime: 0,
  score: 0, combo: 0, bestCombo: 0,
  animId: 0
};

// ====== ノーツ配置と描画 ======
const pxPerSec = 220; // 1秒で落ちるピクセル（後で自動補正）
function secPerBeat(bpm){return 60/bpm;}
function scheduleSong(song){
  const spb = secPerBeat(song.bpm);
  state.notes = song.notes.map(n=>({
    time: n.t * spb, lane: n.lane, len: n.len*spb,
    elt: null, hit:false, judged:false
  }));
  // ノーツDOM生成
  const lanes = els.grid.children;
  state.notes.forEach(n=>{
    const note=document.createElement('div');
    note.className=`note n${n.lane}`;
    // 形ガイド（色覚配慮）
    const shape=document.createElement('div');
    shape.className='shape '+(['','dia','tri','','star','heart','','double'][n.lane]||'');
    note.appendChild(shape);
    // 絵文字ワンポイント
    note.dataset.lane = n.lane;
    n.elt = note;
    lanes[n.lane].appendChild(note);
  });
}

// ====== 判定 ======
function judgeWindowMs(){ return state.diff==='easy'? 250 : 150; }
function hitlineY(){
  const rect = els.grid.getBoundingClientRect();
  const hr = els.hitline.getBoundingClientRect();
  return hr.top - rect.top; // grid内のY
}
function yFromTime(now, scheduled){
  // scheduled（開始からの秒）に向けて落下。ライン位置で 0 誤差になるよう調整
  const dt = now - (state.startAt + scheduled);
  return hitlineY() + dt * pxPerSec; // dt>0 で下
}
function prettyTime(sec){
  sec=Math.max(0,sec|0); const m=String((sec/60)|0).padStart(2,'0'), s=String(sec%60).padStart(2,'0'); return `${m}:${s}`;
}

// ====== 再生（タップ時の鳴音） ======
function currentInstrument(){ return INSTRUMENTS.find(i=>i.id===state.instrument) || INSTRUMENTS[0]; }
function playLane(lane, vel=1){
  const f = LANE_FREQ[lane];
  currentInstrument().play(f, undefined, vel);
}

// ====== 入力（タップ→判定） ======
function onPointerDown(e){
  if(!state.playing){ ensureAudio(); return; }
  ensureAudio();

  const rect=els.grid.getBoundingClientRect();
  const x = (e.clientX!==undefined?e.clientX:e.touches?.[0]?.clientX) - rect.left;
  const lane = Math.floor(x / (rect.width/8));
  if(lane<0 || lane>7) return;

  // 近い未判定ノーツを探す
  const tNow = audioCtx ? audioCtx.currentTime - state.startAt : performance.now()/1000 - state.startAt;
  const win = judgeWindowMs()/1000;
  let best=null, bestAbs=1e9;
  for(const n of state.notes){
    if(n.lane!==lane || n.hit || n.judged) continue;
    const diff = tNow - n.time;
    const abs = Math.abs(diff);
    if(abs<bestAbs){ best=n; bestAbs=abs; }
  }
  if(best && bestAbs<=win){
    // ヒット！
    best.hit=true; best.judged=true;
    if(best.elt){ best.elt.style.opacity=.4; best.elt.style.scale='0.9'; best.elt.style.filter='saturate(1.4)'; }
    state.score += 1; state.combo += 1; state.bestCombo = Math.max(state.bestCombo, state.combo);
    els.hud.score.textContent=state.score;
    els.hud.combo.textContent=state.combo;
    playLane(lane, 1);
    if(state.combo%10===0) confetti(24);
    toast(state.combo%10===0 ? 'やった！コンボ+'+state.combo : 'Good!');
  }else{
    // ミス（減点はしない・コンボだけ切る）
    state.combo=0; els.hud.combo.textContent=state.combo;
    toast('つぎは うまくいくよ！');
  }
}
els.grid.addEventListener('pointerdown', onPointerDown, {passive:true});
els.grid.addEventListener('touchstart', onPointerDown, {passive:true});

// ====== メインループ ======
function loop(){
  const rect=els.grid.getBoundingClientRect();
  const now = audioCtx ? audioCtx.currentTime : performance.now()/1000;
  const local = now - state.startAt;

  // ノーツ位置更新
  const lanes = els.grid.children;
  const hY = hitlineY();
  for(const n of state.notes){
    if(!n.elt) continue;
    const y = yFromTime(now, n.time);
    // 出現前は上、過ぎたら下へフェード
    if(y < -50){ n.elt.style.transform=`translateY(-60px)`; continue; }
    n.elt.style.transform=`translateY(${y}px)`;
    if(!n.judged && local - n.time > (judgeWindowMs()/1000)){
      // 判定窓を過ぎたらミス扱い（コンボ切れはタップ時のみ。ここはビジュアルのみ）
      n.judged=true;
      n.elt.style.opacity=.3;
    }
  }
  // タイマー表示
  els.hud.time.textContent = prettyTime(local);

  // 曲の終了判定
  const last = state.notes[state.notes.length-1];
  if(last && local > (last.time + 3)){ // 余韻3s
    endSong();
    return;
  }
  state.animId = requestAnimationFrame(loop);
}

// ====== Toast & Confetti ======
let toastTimer=0;
function toast(msg){
  const t=els.toast; t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'), 900);
}
function confetti(num=36){
  const root=els.confetti, W=window.innerWidth, H=window.innerHeight;
  for(let i=0;i<num;i++){
    const el=document.createElement('i');
    el.style.left = (Math.random()*W)+'px';
    el.style.top = (-20 - Math.random()*40)+'px';
    el.style.background = ['#10b981','#f59e0b','#3b82f6','#ef4444','#a855f7'][i%5];
    el.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`;
    root.appendChild(el);
    const dy = H + 50 + Math.random()*200;
    const rot = 360 + Math.random()*720;
    const dur = 1200 + Math.random()*1200;
    el.animate([
      { transform: el.style.transform, opacity:1 },
      { transform: `translateY(${dy}px) rotate(${rot}deg)`, opacity:0.9 }
    ], { duration: dur, easing:'ease-out' }).onfinish = ()=> el.remove();
  }
}

// ====== 開始・終了 ======
function startSong(){
  ensureAudio();
  state.playing=true; state.score=0; state.combo=0; state.bestCombo=0;
  els.hud.score.textContent='0'; els.hud.combo.textContent='0';
  els.overlay.classList.remove('show');

  // ランダム選曲
  const song = SONG_BANK[(Math.random()*SONG_BANK.length)|0];
  state.song = song;
  els.hud.song.textContent=song.title; els.hud.bpm.textContent=song.bpm;

  // 準備
  buildGrid();
  scheduleSong(song);

  // Audio基準時間
  const now = audioCtx.currentTime;
  state.startAt = now + 0.7; // カウントイン
  // カウントインSE（ピピピ）
  setTimeout(()=>playLane(4,0.6), 150); // ソ
  setTimeout(()=>playLane(4,0.6), 350);
  setTimeout(()=>playLane(4,0.6), 550);

  // ループ開始
  cancelAnimationFrame(state.animId);
  state.animId = requestAnimationFrame(loop);
}
function endSong(){
  state.playing=false;
  cancelAnimationFrame(state.animId);
  // 星判定（ゆるく）
  const hitCount = state.score;
  const total = state.notes.length;
  const ratio = total? (hitCount/total):0;
  const stars = ratio>=0.8? '★★★' : ratio>=0.5? '★★' : '★';
  if(ratio>=0.8) confetti(60);
  els.resScore.textContent = state.score;
  els.resCombo.textContent = state.bestCombo;
  els.resStars.textContent = stars;
  els.overlay.classList.add('show');
}

// ====== 画面遷移ボタン ======
document.getElementById('btnStart').addEventListener('click', ()=>{
  els.setup.style.display='none';
  els.how.style.display='none';
  els.stage.style.display='block';
  startSong();
});
document.getElementById('btnHow').addEventListener('click', ()=>{
  const v = getComputedStyle(document.getElementById('howto')).display;
  document.getElementById('howto').style.display = v==='none'?'block':'none';
});
document.getElementById('btnPause').addEventListener('click', ()=>{
  if(!audioCtx) return;
  if(audioCtx.state==='running'){ audioCtx.suspend(); toast('⏸ 一時停止'); }
  else { audioCtx.resume(); toast('▶ 再開'); }
});
document.getElementById('btnQuit').addEventListener('click', ()=>{
  endSong();
});
document.getElementById('btnRetry').addEventListener('click', ()=>{
  els.overlay.classList.remove('show');
  startSong();
});
document.getElementById('btnBack').addEventListener('click', ()=>{
  els.overlay.classList.remove('show');
  els.stage.style.display='none';
  els.setup.style.display='block';
});

// ====== 画面リサイズ時のライン再計算 ======
window.addEventListener('resize', ()=>{ /* レイアウトは自動。判定ラインは都度取得 */ }, {passive:true});

// ====== 初回タッチでAudio許可（iPad Safari対策） ======
window.addEventListener('pointerdown', ensureAudio, {once:true, passive:true});
})();
</script>
</body>
</html>
