<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>ã‚†ã‚‹ãƒ“ãƒ¼ãƒˆï¼ˆ8ãƒ¬ãƒ¼ãƒ³Ã—ãƒ‰ãƒ¬ãƒŸæ°‘è¬¡é¢¨ï¼‰</title>
<meta name="theme-color" content="#7dc4ff">
<style>
  :root{
    --bg-top:#e9f5ff; --bg-bottom:#cfe9ff; --line:#cfe3ff; --text:#0f172a;
    --lane-gap:6px; --hitline:#0ea5e9; --note:#1f2937; --good:#22c55e; --warn:#f59e0b;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    color:var(--text);
    background:linear-gradient(var(--bg-top), var(--bg-bottom));
    touch-action: manipulation;
  }
  .app{max-width:980px; margin:0 auto; padding:12px; min-height:100%; display:flex; flex-direction:column; gap:12px}
  header{display:flex; align-items:center; justify-content:space-between; gap:8px}
  header h1{font-size:20px; margin:0; white-space:nowrap}
  header .score{
    display:flex; align-items:center; gap:10px; font-weight:700;
  }
  .card{
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  .row > *{flex:0 0 auto}
  .btn{
    background:#0ea5e9; color:#fff; border:none; border-radius:999px; padding:12px 18px; font-size:16px; font-weight:700;
    box-shadow:0 4px 0 #0986bb; cursor:pointer; transition:transform .05s ease; user-select:none;
  }
  .btn:active{transform:translateY(2px); box-shadow:0 2px 0 #0986bb}
  .btn.secondary{background:#10b981; box-shadow:0 4px 0 #0b9468}
  .btn.ghost{background:#eef6ff; color:#0f172a; box-shadow:none; border:1px solid var(--line)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer}
  .pill input{display:none}
  .pill.active{outline:2px solid #0ea5e9; background:#f0fbff}
  .grid{
    display:grid; grid-template-columns: repeat(8, 1fr); gap:var(--lane-gap);
    height:64vh; min-height:420px; position:relative; isolation:isolate;
    background:linear-gradient(rgba(255,255,255,.6), rgba(255,255,255,.6));
    border:1px solid var(--line); border-radius:12px; overflow:hidden;
  }
  .lane{
    background:rgba(255,255,255,.8);
    border-left:1px dashed rgba(14,165,233,.15);
    border-right:1px dashed rgba(14,165,233,.15);
    position:relative;
  }
  .lane::after{
    content:attr(data-label);
    position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
    font-weight:800; font-size:12px; opacity:.7; letter-spacing:.02em;
    background:rgba(255,255,255,.8); padding:2px 6px; border-radius:6px; border:1px solid var(--line);
  }
  .hitline{
    position:absolute; left:0; right:0; bottom:72px; height:10px; border-top:4px solid var(--hitline); pointer-events:none;
    box-shadow:0 0 0 4px rgba(14,165,233,.06) inset;
  }
  .note{
    position:absolute; left:0; width:100%; height:34px; border-radius:10px;
    transform:translateY(-60px);
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:16px; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.3);
    will-change: transform;
  }
  /* ãƒ¬ãƒ¼ãƒ³è‰²ï¼ˆè‰²è¦šé…æ…®ï¼šå½¢ã‚‚å¾Œè¿°ã§å‡ºã™ï¼‰ */
  .lane.l0{background:linear-gradient(#ffe6e6,#fff)}   /* ãƒ‰ èµ¤ */
  .lane.l1{background:linear-gradient(#ffeede,#fff)}   /* ãƒ¬ æ©™ */
  .lane.l2{background:linear-gradient(#fff7d6,#fff)}   /* ãƒŸ é»„ */
  .lane.l3{background:linear-gradient(#eaffea,#fff)}   /* ãƒ•ã‚¡ ç·‘ */
  .lane.l4{background:linear-gradient(#e7f1ff,#fff)}   /* ã‚½ é’ */
  .lane.l5{background:linear-gradient(#f0e7ff,#fff)}   /* ãƒ© ç´« */
  .lane.l6{background:linear-gradient(#f7f7f7,#fff)}   /* ã‚· ç™½ */
  .lane.l7{background:linear-gradient(#ebebeb,#fff)}   /* é«˜ãƒ‰ é»’ */
  .note.n0{background:#ef4444} .note.n1{background:#fb923c} .note.n2{background:#f59e0b}
  .note.n3{background:#22c55e} .note.n4{background:#3b82f6} .note.n5{background:#a855f7}
  .note.n6{background:#9ca3af} .note.n7{background:#111827}
  .shape{position:absolute; inset:4px; border:3px solid rgba(255,255,255,.85); border-radius:8px}
  .shape.star{border-radius:50%; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)}
  .shape.tri{clip-path: polygon(50% 6%, 94% 94%, 6% 94%)}
  .shape.dia{transform: rotate(45deg)}
  .shape.heart{clip-path:path("M24 4c-6 0-10 5-10 10 0 10 10 14 10 14s10-4 10-14c0-5-4-10-10-10z")}
  .shape.double{border-style:double}
  .hud{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .hud .tag{
    background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-weight:700; font-size:13px;
  }
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700; opacity:0;
    transition:opacity .25s ease, transform .25s ease; z-index:50; box-shadow:0 6px 20px rgba(0,0,0,.25);
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
  .overlay{
    position:fixed; inset:0; background:rgba(255,255,255,.8); display:none; align-items:center; justify-content:center; z-index:40;
  }
  .overlay.show{display:flex}
  .result{
    background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px; width:min(560px,90vw);
    text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .result h2{margin:4px 0 8px}
  .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:60}
  .confetti i{position:absolute; width:10px; height:16px; background:#0ea5e9; opacity:.9; transform:translateY(-20px) rotate(0deg)}
  /* ã‚¿ã‚¤ãƒˆãƒ«/è¨­å®š */
  .setup .group{display:flex; flex-wrap:wrap; gap:8px}
  .setup h3{margin:0 0 6px}
  .instrument{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px}
  .instrument .opt{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; cursor:pointer; background:#fff}
  .instrument .opt.active{outline:2px solid #10b981; background:#f6fffb}
  .muted{opacity:.65}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸ¶ ã‚†ã‚‹ãƒ“ãƒ¼ãƒˆ - 8ãƒ¬ãƒ¼ãƒ³Ã—ãƒ‰ãƒ¬ãƒŸæ°‘è¬¡é¢¨</h1>
    <div class="score">
      <div class="hud">
        <span class="tag">æ¥½å™¨: <b id="hudInstrument">ğŸ¹ ãƒ”ã‚¢ãƒ</b></span>
        <span class="tag">é›£æ˜“åº¦: <b id="hudDiff">ã‚„ã•ã—ã„</b></span>
        <span class="tag">æ›²: <b id="hudSong">â€”</b></span>
        <span class="tag">BPM: <b id="hudBpm">â€”</b></span>
      </div>
      <div class="pill"><span>â­</span> <span id="hudScore">0</span></div>
    </div>
  </header>

  <section id="setup" class="card setup">
    <h2 style="margin:0 0 8px">ã¯ã˜ã‚ã‚‹</h2>
    <div class="row">
      <div style="flex:1 1 320px">
        <h3>æ¥½å™¨ã‚’ãˆã‚‰ã¶</h3>
        <div id="instWrap" class="instrument"></div>
      </div>
      <div style="flex:1 1 220px">
        <h3>ã‚€ãšã‹ã—ã•</h3>
        <div class="group" id="diffWrap">
          <label class="pill active"><input type="radio" name="diff" value="easy" checked>ã‚„ã•ã—ã„</label>
          <label class="pill"><input type="radio" name="diff" value="normal">ãµã¤ã†</label>
        </div>
        <h3 style="margin-top:12px">ãƒ¢ãƒ¼ãƒ‰</h3>
        <div class="group" id="modeWrap">
          <label class="pill active"><input type="radio" name="mode" value="melody" checked>ãƒ¡ãƒ­ãƒ‡ã‚£ã§ã‚ãã¶</label>
          <label class="pill"><input type="radio" name="mode" value="free">ãƒ•ãƒªãƒ¼ãƒ‰ãƒ©ãƒ </label>
        </div>
        <div style="margin-top:12px" class="muted">â€» ã¯ã˜ã‚ã®ã‚¿ãƒƒãƒ—ã§éŸ³ãŒå‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆiPadã®ä»•æ§˜ï¼‰</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ é¸æ›²ï¼‰</button>
      <button id="btnHow" class="btn ghost">â“ ã‚ãã³ã‹ãŸ</button>
    </div>
  </section>

  <section id="howto" class="card" style="display:none">
    <h2 style="margin:0 0 8px">ã‚ãã³ã‹ãŸ</h2>
    <ol style="margin:8px 0 0 20px">
      <li>ä¸Šã‹ã‚‰ãŠã¡ã¦ãã‚‹ãƒãƒ¼ãƒ„ï¼ˆâ™ªï¼‰ãŒã€ä¸‹ã®ç·šã«ããŸã‚‰ã€åŒã˜ãƒ¬ãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼</li>
      <li>ç·šã®ä¸­ã§ãŸãŸã‘ã‚Œã° <b>1ç‚¹</b>ã€‚ã‚³ãƒ³ãƒœã§ç´™ãµã¶ãï¼</li>
      <li>ã‚€ãšã‹ã—ã„ã¨ãã¯ã€Œã‚„ã•ã—ã„ã€ã‚’ãˆã‚‰ã‚“ã§ã­ã€‚</li>
    </ol>
  </section>

  <section id="stage" class="card" style="display:none">
    <div class="grid" id="grid"></div>
    <div class="hitline" id="hitline"></div>
    <div class="row" style="justify-content:space-between; margin-top:8px">
      <div class="hud">
        <span class="tag" id="hudTime">00:00</span>
        <span class="tag">Combo: <b id="hudCombo">0</b></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnPause">â¸ ä¸€æ™‚åœæ­¢</button>
        <button class="btn secondary" id="btnQuit">ğŸ ã‚„ã‚ã‚‹</button>
      </div>
    </div>
  </section>

  <div class="overlay" id="overlay">
    <div class="result">
      <h2>ãŠã¤ã‹ã‚Œã•ã¾ï¼</h2>
      <p style="margin:6px 0 14px">ã‚¹ã‚³ã‚¢ <b id="resScore">0</b>ã€€ã‚³ãƒ³ãƒœ <b id="resCombo">0</b></p>
      <div style="font-size:28px; margin:2px 0 10px" id="resStars">â­</div>
      <div class="row" style="justify-content:center">
        <button class="btn" id="btnRetry">ğŸ” ã‚‚ã†1æ›²ï¼</button>
        <button class="btn ghost" id="btnBack">â¬… ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Great!</div>
  <div class="confetti" id="confetti"></div>
</div>

<script>
(()=>{
// ====== éŸ³ã¾ã‚ã‚Šï¼ˆWebAudioï¼‰ ======
let audioCtx=null, masterGain=null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.9;
    masterGain.connect(audioCtx.destination);
  }
  if(audioCtx.state==='suspended') audioCtx.resume();
}
const A4=440;
function freqFromSemitone(semi){ return A4*Math.pow(2, semi/12); }
// C4..C5 ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰
const SEMI = { C4:-9, D4:-7, E4:-5, F4:-4, G4:-2, A4:0, B4:2, C5:3 };
const LANE_TO_SEMI = [SEMI.C4,SEMI.D4,SEMI.E4,SEMI.F4,SEMI.G4,SEMI.A4,SEMI.B4,SEMI.C5];
const LANE_FREQ = LANE_TO_SEMI.map(semi=>freqFromSemitone(semi));

// æ¥½å™¨å®šç¾©ï¼ˆçµµæ–‡å­—ãƒ»åå‰ãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢æ•°ï¼‰
const INSTRUMENTS = [
  { id:'piano', label:'ğŸ¹ ãƒ”ã‚¢ãƒ', play:(f,d=0.28,v=1)=>{
      ensureAudio();
      const now = audioCtx.currentTime;
      const o1=audioCtx.createOscillator(), g1=audioCtx.createGain();
      o1.type='triangle'; o1.frequency.value=f;
      g1.gain.setValueAtTime(0, now);
      g1.gain.linearRampToValueAtTime(0.9*v, now+0.01);
      g1.gain.exponentialRampToValueAtTime(0.0001, now + d);
      o1.connect(g1); g1.connect(masterGain);
      o1.start(now); o1.stop(now+d+0.02);
  }},
  { id:'bell', label:'ğŸ”” ãƒ™ãƒ«', play:(f,d=0.6,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      // FMãƒ™ãƒ«
      const car=audioCtx.createOscillator();
      const mod=audioCtx.createOscillator();
      const mg=audioCtx.createGain();
      const cg=audioCtx.createGain();
      car.type='sine'; mod.type='sine';
      car.frequency.value=f; mod.frequency.value=f*2;
      mg.gain.value=f*4;
      mod.connect(mg); mg.connect(car.frequency);
      cg.gain.setValueAtTime(0,now);
      cg.gain.linearRampToValueAtTime(0.8*v, now+0.01);
      cg.gain.exponentialRampToValueAtTime(0.0001, now+d);
      car.connect(cg); cg.connect(masterGain);
      car.start(now); mod.start(now);
      car.stop(now+d+0.05); mod.stop(now+d+0.05);
  }},
  { id:'maracas', label:'ğŸª‡ ãƒãƒ©ã‚«ã‚¹', play:(f,d=0.18,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*d, audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,3);
      const src=audioCtx.createBufferSource(); src.buffer=buf;
      const bp=audioCtx.createBiquadFilter(); bp.type='highpass'; bp.frequency.value=6000;
      const g=audioCtx.createGain(); g.gain.value=0.7*v;
      src.connect(bp); bp.connect(g); g.connect(masterGain);
      src.start(now);
  }},
  { id:'drum', label:'ğŸ¥ ãƒ‰ãƒ©ãƒ ', play:(f,d=0.2,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sine';
      const g=audioCtx.createGain(); g.gain.value=0.9*v;
      o.frequency.setValueAtTime(f*0.5, now);
      o.frequency.exponentialRampToValueAtTime(60, now+d);
      g.gain.setValueAtTime(0.9*v, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
  }},
  { id:'taiko', label:'ğŸª˜ ãŸã„ã“', play:(f,d=0.28,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sine';
      const n=audioCtx.createBufferSource();
      const g=audioCtx.createGain(); const g2=audioCtx.createGain();
      // sine body
      o.frequency.setValueAtTime(f*0.8, now);
      o.frequency.exponentialRampToValueAtTime(80, now+d);
      g.gain.setValueAtTime(0.9*v, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      // noise click
      const len=d; const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*len, audioCtx.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2);
      n.buffer=buf; const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
      g2.gain.setValueAtTime(0.5*v, now);
      g2.gain.exponentialRampToValueAtTime(0.0001, now+d*0.6);
      o.connect(g); g.connect(masterGain);
      n.connect(hp); hp.connect(g2); g2.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
      n.start(now); n.stop(now+d*0.6);
  }},
  { id:'trumpet', label:'ğŸº ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ', play:(f,d=0.3,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sawtooth'; const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1600;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.8*v, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(lp); lp.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.02);
  }},
  { id:'sax', label:'ğŸ· ã‚µãƒƒã‚¯ã‚¹', play:(f,d=0.35,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='sawtooth'; const g=audioCtx.createGain(); const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200;
      const lfo=audioCtx.createOscillator(); const lfg=audioCtx.createGain(); lfo.frequency.value=5; lfg.gain.value=3;
      lfo.connect(lfg); lfg.connect(o.frequency);
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.85*v, now+0.035);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(lp); lp.connect(g); g.connect(masterGain);
      o.start(now); lfo.start(now); o.stop(now+d+0.05); lfo.stop(now+d+0.05);
  }},
  { id:'violin', label:'ğŸ» ãƒã‚¤ã‚ªãƒªãƒ³', play:(f,d=0.42,v=1)=>{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); o.type='triangle'; const g=audioCtx.createGain();
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.75*v, now+0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, now+d);
      o.frequency.value=f; o.connect(g); g.connect(masterGain);
      o.start(now); o.stop(now+d+0.05);
  }},
];

// ====== UI å…ƒç´  ======
const els = {
  grid: document.getElementById('grid'),
  hitline: document.getElementById('hitline'),
  setup: document.getElementById('setup'),
  stage: document.getElementById('stage'),
  how: document.getElementById('howto'),
  toast: document.getElementById('toast'),
  confetti: document.getElementById('confetti'),
  overlay: document.getElementById('overlay'),
  resScore: document.getElementById('resScore'),
  resCombo: document.getElementById('resCombo'),
  resStars: document.getElementById('resStars'),
  hud: {
    score: document.getElementById('hudScore'),
    bpm: document.getElementById('hudBpm'),
    song: document.getElementById('hudSong'),
    combo: document.getElementById('hudCombo'),
    time: document.getElementById('hudTime'),
    inst: document.getElementById('hudInstrument'),
    diff: document.getElementById('hudDiff'),
  }
};

// ====== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—UI ======
const instWrap = document.getElementById('instWrap');
INSTRUMENTS.forEach((it,idx)=>{
  const div=document.createElement('div');
  div.className='opt'+(idx===0?' active':'');
  div.dataset.id=it.id;
  div.innerHTML=`<b style="font-size:20px">${it.label.split(' ')[0]}</b> <span>${it.label.split(' ')[1]||''}</span>`;
  div.addEventListener('click', ()=>{
    document.querySelectorAll('.instrument .opt').forEach(n=>n.classList.remove('active'));
    div.classList.add('active');
    state.instrument = it.id;
    els.hud.inst.textContent = it.label;
  });
  instWrap.appendChild(div);
});
document.getElementById('diffWrap').addEventListener('click', e=>{
  if(e.target.closest('label')){
    document.querySelectorAll('#diffWrap .pill').forEach(n=>n.classList.remove('active'));
    e.target.closest('label').classList.add('active');
    const v=e.target.closest('label').querySelector('input').value;
    state.diff=v; els.hud.diff.textContent = (v==='easy'?'ã‚„ã•ã—ã„':'ãµã¤ã†');
  }
});
document.getElementById('modeWrap').addEventListener('click', e=>{
  if(e.target.closest('label')){
    document.querySelectorAll('#modeWrap .pill').forEach(n=>n.classList.remove('active'));
    e.target.closest('label').classList.add('active');
    state.mode=e.target.closest('label').querySelector('input').value;
  }
});

// ====== ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ8ãƒ¬ãƒ¼ãƒ³æç”»ï¼‰ ======
const LANE_LABELS = ['ãƒ‰','ãƒ¬','ãƒŸ','ãƒ•ã‚¡','ã‚½','ãƒ©','ã‚·','ãƒ‰'];
function buildGrid(){
  els.grid.innerHTML='';
  for(let i=0;i<8;i++){
    const lane=document.createElement('div');
    lane.className=`lane l${i}`;
    lane.dataset.index=i;
    lane.setAttribute('data-label', `${LANE_LABELS[i]} / ${['â—','â—†','â–²','â– ','â˜…','â¤','â™«','â—'][i]}`);
    els.grid.appendChild(lane);
  }
}
buildGrid();

// ====== æ›²ãƒãƒ³ã‚¯ï¼ˆæ°‘è¬¡â€œé¢¨â€30æ›²ï¼‰ ======
// è‘—ä½œæ¨©ã«æŠµè§¦ã—ãªã„ã‚ˆã†ã€Œå’Œé¢¨ãƒšãƒ³ã‚¿ãƒˆãƒ‹ãƒƒã‚¯ãƒ»æ°‘è¬¡é¢¨ã€ã‚’ã‚·ãƒ¼ãƒ‰ç”Ÿæˆã€‚
// 30æ›²ã¶ã‚“ã®ã€Œå®‰å®šã—ãŸãƒ¡ãƒ­ãƒ‡ã‚£ã€ã‚’æ¯å›åŒã˜å†…å®¹ã§ä½œã‚Šã¾ã™ã€‚
function seedRng(seed){ let s=seed|0; return ()=> (s=(s*48271)%0x7fffffff)/0x7fffffff; }
function makeFolkSong(seed){
  const rnd=seedRng(seed);
  const title=`æ°‘è¬¡é¢¨ #${String(seed).padStart(2,'0')}`;
  const bpm = Math.floor(80 + rnd()*30); // 80-110
  // ä¸»ã«ãƒ¨ãƒŠæŠœãé•·éŸ³éšï¼ˆC D E G Aï¼‰ä¸­å¿ƒã«ã€æ™‚ã€…F/Bã§è‰²ã‚’ä»˜ã‘ã‚‹
  const pool=[0,1,2,4,5,7]; // lane indexå€™è£œï¼ˆæ™‚ã€…3,6ã‚’æ··ãœã‚‹ï¼‰
  const notes=[];
  const bars=8; // 8å°ç¯€Ã—4æ‹
  let cur = 0| (rnd()*pool.length);
  const addNote=(beat,lane,len)=>{
    notes.push({t:beat, lane, len});
  };
  let beat=0;
  for(let m=0;m<bars;m++){
    for(let q=0;q<4;q++){
      // 4æ‹å­ã®å„æ‹ã‚’ 1 or 1/2éŸ³ã«ã™ã‚‹
      const subdivision = rnd()<0.35 ? 2 : 1;
      for(let s=0;s<subdivision;s++){
        // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹• -1/0/+1
        const delta = (rnd()<0.5?0:(rnd()<0.5?-1:1));
        cur = Math.max(0, Math.min(7, (pool[cur%pool.length] + delta)));
        if(rnd()<0.12) cur = 3; // æ™‚ã€…ãƒ•ã‚¡
        if(rnd()<0.10) cur = 6; // æ™‚ã€…ã‚·
        addNote(beat, cur, 1/subdivision);
        beat += 1/subdivision;
      }
    }
  }
  return {title,bpm, notes};
}
const SONG_BANK = Array.from({length:30}, (_,i)=>makeFolkSong(i+1));

// ====== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ======
const state = {
  instrument: INSTRUMENTS[0].id,
  diff: 'easy',
  mode: 'melody',
  playing: false,
  startAt: 0,
  song: null,
  notes: [],  // {t (sec), lane, len, hit?}
  yForTime: 0,
  score: 0, combo: 0, bestCombo: 0,
  animId: 0
};

// ====== ãƒãƒ¼ãƒ„é…ç½®ã¨æç”» ======
const pxPerSec = 220; // 1ç§’ã§è½ã¡ã‚‹ãƒ”ã‚¯ã‚»ãƒ«ï¼ˆå¾Œã§è‡ªå‹•è£œæ­£ï¼‰
function secPerBeat(bpm){return 60/bpm;}
function scheduleSong(song){
  const spb = secPerBeat(song.bpm);
  state.notes = song.notes.map(n=>({
    time: n.t * spb, lane: n.lane, len: n.len*spb,
    elt: null, hit:false, judged:false
  }));
  // ãƒãƒ¼ãƒ„DOMç”Ÿæˆ
  const lanes = els.grid.children;
  state.notes.forEach(n=>{
    const note=document.createElement('div');
    note.className=`note n${n.lane}`;
    // å½¢ã‚¬ã‚¤ãƒ‰ï¼ˆè‰²è¦šé…æ…®ï¼‰
    const shape=document.createElement('div');
    shape.className='shape '+(['','dia','tri','','star','heart','','double'][n.lane]||'');
    note.appendChild(shape);
    // çµµæ–‡å­—ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆ
    note.dataset.lane = n.lane;
    n.elt = note;
    lanes[n.lane].appendChild(note);
  });
}

// ====== åˆ¤å®š ======
function judgeWindowMs(){ return state.diff==='easy'? 250 : 150; }
function hitlineY(){
  const rect = els.grid.getBoundingClientRect();
  const hr = els.hitline.getBoundingClientRect();
  return hr.top - rect.top; // gridå†…ã®Y
}
function yFromTime(now, scheduled){
  // scheduledï¼ˆé–‹å§‹ã‹ã‚‰ã®ç§’ï¼‰ã«å‘ã‘ã¦è½ä¸‹ã€‚ãƒ©ã‚¤ãƒ³ä½ç½®ã§ 0 èª¤å·®ã«ãªã‚‹ã‚ˆã†èª¿æ•´
  const dt = now - (state.startAt + scheduled);
  return hitlineY() + dt * pxPerSec; // dt>0 ã§ä¸‹
}
function prettyTime(sec){
  sec=Math.max(0,sec|0); const m=String((sec/60)|0).padStart(2,'0'), s=String(sec%60).padStart(2,'0'); return `${m}:${s}`;
}

// ====== å†ç”Ÿï¼ˆã‚¿ãƒƒãƒ—æ™‚ã®é³´éŸ³ï¼‰ ======
function currentInstrument(){ return INSTRUMENTS.find(i=>i.id===state.instrument) || INSTRUMENTS[0]; }
function playLane(lane, vel=1){
  const f = LANE_FREQ[lane];
  currentInstrument().play(f, undefined, vel);
}

// ====== å…¥åŠ›ï¼ˆã‚¿ãƒƒãƒ—â†’åˆ¤å®šï¼‰ ======
function onPointerDown(e){
  if(!state.playing){ ensureAudio(); return; }
  ensureAudio();

  const rect=els.grid.getBoundingClientRect();
  const x = (e.clientX!==undefined?e.clientX:e.touches?.[0]?.clientX) - rect.left;
  const lane = Math.floor(x / (rect.width/8));
  if(lane<0 || lane>7) return;

  // è¿‘ã„æœªåˆ¤å®šãƒãƒ¼ãƒ„ã‚’æ¢ã™
  const tNow = audioCtx ? audioCtx.currentTime - state.startAt : performance.now()/1000 - state.startAt;
  const win = judgeWindowMs()/1000;
  let best=null, bestAbs=1e9;
  for(const n of state.notes){
    if(n.lane!==lane || n.hit || n.judged) continue;
    const diff = tNow - n.time;
    const abs = Math.abs(diff);
    if(abs<bestAbs){ best=n; bestAbs=abs; }
  }
  if(best && bestAbs<=win){
    // ãƒ’ãƒƒãƒˆï¼
    best.hit=true; best.judged=true;
    if(best.elt){ best.elt.style.opacity=.4; best.elt.style.scale='0.9'; best.elt.style.filter='saturate(1.4)'; }
    state.score += 1; state.combo += 1; state.bestCombo = Math.max(state.bestCombo, state.combo);
    els.hud.score.textContent=state.score;
    els.hud.combo.textContent=state.combo;
    playLane(lane, 1);
    if(state.combo%10===0) confetti(24);
    toast(state.combo%10===0 ? 'ã‚„ã£ãŸï¼ã‚³ãƒ³ãƒœ+'+state.combo : 'Good!');
  }else{
    // ãƒŸã‚¹ï¼ˆæ¸›ç‚¹ã¯ã—ãªã„ãƒ»ã‚³ãƒ³ãƒœã ã‘åˆ‡ã‚‹ï¼‰
    state.combo=0; els.hud.combo.textContent=state.combo;
    toast('ã¤ãã¯ ã†ã¾ãã„ãã‚ˆï¼');
  }
}
els.grid.addEventListener('pointerdown', onPointerDown, {passive:true});
els.grid.addEventListener('touchstart', onPointerDown, {passive:true});

// ====== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ======
function loop(){
  const rect=els.grid.getBoundingClientRect();
  const now = audioCtx ? audioCtx.currentTime : performance.now()/1000;
  const local = now - state.startAt;

  // ãƒãƒ¼ãƒ„ä½ç½®æ›´æ–°
  const lanes = els.grid.children;
  const hY = hitlineY();
  for(const n of state.notes){
    if(!n.elt) continue;
    const y = yFromTime(now, n.time);
    // å‡ºç¾å‰ã¯ä¸Šã€éããŸã‚‰ä¸‹ã¸ãƒ•ã‚§ãƒ¼ãƒ‰
    if(y < -50){ n.elt.style.transform=`translateY(-60px)`; continue; }
    n.elt.style.transform=`translateY(${y}px)`;
    if(!n.judged && local - n.time > (judgeWindowMs()/1000)){
      // åˆ¤å®šçª“ã‚’éããŸã‚‰ãƒŸã‚¹æ‰±ã„ï¼ˆã‚³ãƒ³ãƒœåˆ‡ã‚Œã¯ã‚¿ãƒƒãƒ—æ™‚ã®ã¿ã€‚ã“ã“ã¯ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã®ã¿ï¼‰
      n.judged=true;
      n.elt.style.opacity=.3;
    }
  }
  // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º
  els.hud.time.textContent = prettyTime(local);

  // æ›²ã®çµ‚äº†åˆ¤å®š
  const last = state.notes[state.notes.length-1];
  if(last && local > (last.time + 3)){ // ä½™éŸ»3s
    endSong();
    return;
  }
  state.animId = requestAnimationFrame(loop);
}

// ====== Toast & Confetti ======
let toastTimer=0;
function toast(msg){
  const t=els.toast; t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'), 900);
}
function confetti(num=36){
  const root=els.confetti, W=window.innerWidth, H=window.innerHeight;
  for(let i=0;i<num;i++){
    const el=document.createElement('i');
    el.style.left = (Math.random()*W)+'px';
    el.style.top = (-20 - Math.random()*40)+'px';
    el.style.background = ['#10b981','#f59e0b','#3b82f6','#ef4444','#a855f7'][i%5];
    el.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`;
    root.appendChild(el);
    const dy = H + 50 + Math.random()*200;
    const rot = 360 + Math.random()*720;
    const dur = 1200 + Math.random()*1200;
    el.animate([
      { transform: el.style.transform, opacity:1 },
      { transform: `translateY(${dy}px) rotate(${rot}deg)`, opacity:0.9 }
    ], { duration: dur, easing:'ease-out' }).onfinish = ()=> el.remove();
  }
}

// ====== é–‹å§‹ãƒ»çµ‚äº† ======
function startSong(){
  ensureAudio();
  state.playing=true; state.score=0; state.combo=0; state.bestCombo=0;
  els.hud.score.textContent='0'; els.hud.combo.textContent='0';
  els.overlay.classList.remove('show');

  // ãƒ©ãƒ³ãƒ€ãƒ é¸æ›²
  const song = SONG_BANK[(Math.random()*SONG_BANK.length)|0];
  state.song = song;
  els.hud.song.textContent=song.title; els.hud.bpm.textContent=song.bpm;

  // æº–å‚™
  buildGrid();
  scheduleSong(song);

  // AudioåŸºæº–æ™‚é–“
  const now = audioCtx.currentTime;
  state.startAt = now + 0.7; // ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³
  // ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³SEï¼ˆãƒ”ãƒ”ãƒ”ï¼‰
  setTimeout(()=>playLane(4,0.6), 150); // ã‚½
  setTimeout(()=>playLane(4,0.6), 350);
  setTimeout(()=>playLane(4,0.6), 550);

  // ãƒ«ãƒ¼ãƒ—é–‹å§‹
  cancelAnimationFrame(state.animId);
  state.animId = requestAnimationFrame(loop);
}
function endSong(){
  state.playing=false;
  cancelAnimationFrame(state.animId);
  // æ˜Ÿåˆ¤å®šï¼ˆã‚†ã‚‹ãï¼‰
  const hitCount = state.score;
  const total = state.notes.length;
  const ratio = total? (hitCount/total):0;
  const stars = ratio>=0.8? 'â˜…â˜…â˜…' : ratio>=0.5? 'â˜…â˜…' : 'â˜…';
  if(ratio>=0.8) confetti(60);
  els.resScore.textContent = state.score;
  els.resCombo.textContent = state.bestCombo;
  els.resStars.textContent = stars;
  els.overlay.classList.add('show');
}

// ====== ç”»é¢é·ç§»ãƒœã‚¿ãƒ³ ======
document.getElementById('btnStart').addEventListener('click', ()=>{
  els.setup.style.display='none';
  els.how.style.display='none';
  els.stage.style.display='block';
  startSong();
});
document.getElementById('btnHow').addEventListener('click', ()=>{
  const v = getComputedStyle(document.getElementById('howto')).display;
  document.getElementById('howto').style.display = v==='none'?'block':'none';
});
document.getElementById('btnPause').addEventListener('click', ()=>{
  if(!audioCtx) return;
  if(audioCtx.state==='running'){ audioCtx.suspend(); toast('â¸ ä¸€æ™‚åœæ­¢'); }
  else { audioCtx.resume(); toast('â–¶ å†é–‹'); }
});
document.getElementById('btnQuit').addEventListener('click', ()=>{
  endSong();
});
document.getElementById('btnRetry').addEventListener('click', ()=>{
  els.overlay.classList.remove('show');
  startSong();
});
document.getElementById('btnBack').addEventListener('click', ()=>{
  els.overlay.classList.remove('show');
  els.stage.style.display='none';
  els.setup.style.display='block';
});

// ====== ç”»é¢ãƒªã‚µã‚¤ã‚ºæ™‚ã®ãƒ©ã‚¤ãƒ³å†è¨ˆç®— ======
window.addEventListener('resize', ()=>{ /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯è‡ªå‹•ã€‚åˆ¤å®šãƒ©ã‚¤ãƒ³ã¯éƒ½åº¦å–å¾— */ }, {passive:true});

// ====== åˆå›ã‚¿ãƒƒãƒã§Audioè¨±å¯ï¼ˆiPad Safariå¯¾ç­–ï¼‰ ======
window.addEventListener('pointerdown', ensureAudio, {once:true, passive:true});
})();
</script>
</body>
</html>
