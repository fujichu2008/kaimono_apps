<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>HTMLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆiPhoneå¯¾å¿œãƒ»1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</title>
<meta name="theme-color" content="#0b1222" />
<style>
  :root{
    --bg:#0b1222; --panel:#0f172a; --text:#e6ecff; --muted:#93a4c6;
    --accent:#6ea8fe; --ok:#35d69b; --warn:#ff6b6b; --btn:#1f2a44; --btn2:#152038;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif}
  .app{min-height:100%;display:flex;flex-direction:column}
  header{padding:12px env(safe-area-inset-right) 12px env(safe-area-inset-left);border-bottom:1px solid #1a2540;background:linear-gradient(180deg,#0c1326,#0b1222)}
  h1{font-size:16px;margin:0;letter-spacing:.03em}
  .sub{font-size:12px;color:var(--muted);margin-top:2px}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button,.ghost{
    appearance:none;border:none;outline:none;border-radius:10px;
    padding:12px 14px;background:var(--btn);color:var(--text);font-weight:600;
    font-size:14px;letter-spacing:.02em;touch-action:manipulation
  }
  button:active{transform:translateY(1px)}
  .run{background:linear-gradient(180deg,#3a9ef7,#1d72f2);color:#041428}
  .open{background:var(--ok);color:#041c14}
  .ghost{background:var(--btn2);opacity:.9}
  .warn{background:var(--warn);color:#1a0f12}

  main{flex:1;display:flex;flex-direction:column;padding:12px env(safe-area-inset-right) 12px env(safe-area-inset-left);gap:12px}
  .editor{
    flex:1;background:var(--panel);border:1px solid #1b2742;border-radius:12px;
    display:flex;flex-direction:column;overflow:hidden;min-height:40vh
  }
  .editor .head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #1b2742;background:#0e162e}
  .editor .head span{font-size:12px;color:var(--muted)}
  select{background:#0e162e;color:var(--text);border:1px solid #1b2742;border-radius:8px;padding:8px}
  textarea{
    flex:1;width:100%;resize:none;background:transparent;color:var(--text);
    border:none;outline:none;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:13px;line-height:1.5
  }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ */
  .screen{position:fixed;inset:0;display:none;z-index:20;background:#000}
  .screen.active{display:block}
  .screen .topbar{
    position:fixed;top:0;left:0;right:0;display:flex;gap:8px;align-items:center;
    padding:12px calc(10px + env(safe-area-inset-right)) 12px calc(10px + env(safe-area-inset-left));
    background:linear-gradient(180deg,rgba(5,8,16,.95),rgba(5,8,16,.55));
    backdrop-filter:saturate(1.2) blur(6px);-webkit-backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid rgba(110,168,254,.18)
  }
  .screen .topbar button{padding:10px 12px}
  .screen iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;background:#fff}

  .hint{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>HTMLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <div class="sub">ãƒ†ã‚­ã‚¹ãƒˆã«HTML/CSS/JSã‚’å…¥åŠ› â†’ å®Ÿè¡Œ ã§è¡¨ç¤ºç”»é¢ã¸é·ç§»ï¼ˆiPhoneå¯¾å¿œï¼‰</div>
    <div class="toolbar">
      <button class="run" id="runBtn">å®Ÿè¡Œã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸</button>
      <button class="open" id="openTabBtn">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
      <button class="ghost" id="saveBtn">ä¿å­˜</button>
      <button class="ghost" id="loadBtn">èª­è¾¼</button>
      <button class="ghost warn" id="clearBtn">å…¨æ¶ˆå»</button>
    </div>
  </header>

  <main>
    <div class="editor" id="editor">
      <div class="head">
        <span>ã‚µãƒ³ãƒ—ãƒ«ï¼š</span>
        <select id="samples">
          <option value="">ï¼ˆé¸æŠã™ã‚‹ã¨ã‚¨ãƒ‡ã‚£ã‚¿ã«æŒ¿å…¥ï¼‰</option>
          <option value="hello">Hello, worldï¼ˆæœ€å°ï¼‰</option>
          <option value="canvas">Canvas èŠ±ç«ãƒ‡ãƒ¢</option>
          <option value="audio">WebAudio ãƒ“ãƒ¼ãƒ—</option>
        </select>
        <span class="hint">â€»ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã€‚JSã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ã§å‹•ä½œã€‚</span>
      </div>
      <textarea id="code" spellcheck="false" placeholder="ã“ã“ã«HTMLã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚CSSã‚‚&lt;style&gt;ã€JSã‚‚&lt;script&gt;ã§OKã§ã™ã€‚&#10;ä¾‹ï¼š&#10;&lt;!doctype html&gt;..."></textarea>
    </div>
    <div class="row">
      <div class="hint">ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®‰å…¨ã®ãŸã‚ <code>iframe sandbox</code> ã§å®Ÿè¡Œã—ã¾ã™ï¼ˆè¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒ‡ãƒ¼ã‚¿ã¸ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰ã€‚<br>
      ãƒ»å¤–éƒ¨ã‚µã‚¤ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯CORSç­‰ã§åˆ¶ç´„ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
      ãƒ»ã‚¨ãƒ©ãƒ¼ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…ã®èµ¤å¸¯ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
  </main>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ -->
  <div class="screen" id="screen">
    <div class="topbar">
      <button id="backBtn">â† ã‚¨ãƒ‡ã‚£ã‚¿ã¸æˆ»ã‚‹</button>
      <button id="reloadBtn">å†å®Ÿè¡Œ</button>
      <button id="openAgainBtn">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
    </div>
    <iframe id="preview" sandbox="allow-scripts allow-forms allow-modals allow-pointer-lock allow-popups allow-downloads allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<script>
(function(){
  const ta = document.getElementById('code');
  const runBtn = document.getElementById('runBtn');
  const openBtn = document.getElementById('openTabBtn');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const samples = document.getElementById('samples');

  const screen = document.getElementById('screen');
  const backBtn = document.getElementById('backBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const openAgainBtn = document.getElementById('openAgainBtn');
  const iframe = document.getElementById('preview');

  const LS_KEY = 'htmlsim_code_v1';

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ/å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰
  const defaultCode = `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My HTML</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,'Hiragino Sans','Noto Sans JP',sans-serif;background:#101826;color:#e6ecff;display:grid;place-items:center;height:100vh}
  .card{padding:24px;border-radius:16px;background:#111c35;box-shadow:0 12px 40px rgba(0,0,0,.35);text-align:center}
  h1{margin:0 0 6px}
  p{margin:6px 0 0;color:#9fb0d6}
  button{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;background:#35d69b;color:#102016;font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <h1>Hello, world ğŸ‘‹</h1>
    <p>ã“ã“ã«è‡ªç”±ã«HTML/CSS/JSã‚’æ›¸ã‘ã¾ã™ã€‚</p>
    <button onclick="alert('å®Ÿè¡Œã§ãã¦ã¾ã™ï¼')">ã‚¢ãƒ©ãƒ¼ãƒˆ</button>
  </div>
  <script>
    console.log('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã®ç¢ºèª');
  <\/script>
</body>
</html>`;

  ta.value = localStorage.getItem(LS_KEY) || defaultCode;

  // ã‚µãƒ³ãƒ—ãƒ«æŒ¿å…¥
  samples.addEventListener('change', (e)=>{
    const v = e.target.value;
    if(!v) return;
    const map = {
      hello: defaultCode,
      canvas: `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Canvas Fireworks</title>
<style>html,body{height:100%;margin:0;background:#000}canvas{display:block;width:100%;height:100%}</style>
</head><body><canvas id="cv"></canvas>
<script>
const c=document.getElementById('cv'),x=c.getContext('2d');
function fit(){c.width=innerWidth;c.height=innerHeight} addEventListener('resize',fit);fit();
const pts=[];
function boom(cx,cy){for(let i=0;i<120;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*4;
pts.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:60+Math.random()*30});}}
setInterval(()=>boom(Math.random()*c.width,Math.random()*c.height),700);
function step(){x.fillStyle='rgba(0,0,0,0.2)';x.fillRect(0,0,c.width,c.height);
for(const p of pts){p.x+=p.vx;p.y+=p.vy;p.vy+=0.02;p.life--;
x.fillStyle='hsl('+((p.life*3)%360)+',100%,60%)';x.fillRect(p.x,p.y,2,2);}
for(let i=pts.length-1;i>=0;i--) if(pts[i].life<0) pts.splice(i,1);
requestAnimationFrame(step);} step();
<\/script></body></html>`,
      audio: `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebAudio Beep</title>
<style>body{margin:0;height:100vh;display:grid;place-items:center;background:#0e1322;color:#e6ecff;font-family:system-ui}</style>
</head><body>
<button id="b" style="padding:14px 18px;border-radius:12px;border:0;background:#35d69b;color:#102016;font-weight:700">Beep!</button>
<script>
let ctx;document.getElementById('b').onclick=()=>{
  ctx=ctx||new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='square'; o.frequency.value=880; g.gain.value=0.15; o.connect(g).connect(ctx.destination);
  o.start(); setTimeout(()=>o.stop(),180);
};
<\/script></body></html>`
    };
    ta.value = map[v] || ta.value;
    e.target.value = '';
  });

  // å®Ÿè¡Œï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã¸ã€Œé·ç§»ã€
  runBtn.addEventListener('click', ()=>{
    showPreview(ta.value);
  });

  // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã®ã¿è¨±å¯ã•ã‚Œã‚„ã™ã„ï¼‰
  openBtn.addEventListener('click', ()=>{
    openInNewTab(ta.value);
  });

  saveBtn.addEventListener('click', ()=>{
    localStorage.setItem(LS_KEY, ta.value);
    flash('ä¿å­˜ã—ã¾ã—ãŸã€‚');
  });

  loadBtn.addEventListener('click', ()=>{
    const v = localStorage.getItem(LS_KEY);
    if(v!=null){ ta.value = v; flash('èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚'); }
    else { flash('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); }
  });

  clearBtn.addEventListener('click', ()=>{
    if(confirm('ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
      ta.value = '';
    }
  });

  backBtn.addEventListener('click', ()=>{
    screen.classList.remove('active');
    // iOSã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¾©å¸°ã—ã‚„ã™ã„ã‚ˆã†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(()=>ta.focus(), 50);
  });

  reloadBtn.addEventListener('click', ()=>{
    showPreview(ta.value);
  });

  openAgainBtn.addEventListener('click', ()=>{
    openInNewTab(ta.value);
  });

  // ç”»é¢é·ç§»ã—ã¦iframeã§å®Ÿè¡Œ
  function showPreview(userHtml){
    screen.classList.add('active');
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ¼ä»˜ãã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä»˜ä¸ï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ã§å‹•ä½œï¼‰
    const wrapper = makeWrappedHTML(userHtml);
    // srcdocã«ç›´æ¥å…¥ã‚Œã‚‹
    iframe.srcdoc = wrapper;
  }

  // æ–°ã—ã„ã‚¿ãƒ–ã§å®Ÿè¡Œï¼ˆBlob URLï¼‰
  function openInNewTab(userHtml){
    const blob = new Blob([makeWrappedHTML(userHtml, /*inNewTab*/true)], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    // iOSã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if(!w){ flash('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã€Œå®Ÿè¡Œã€ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'); }
    // ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ã¾ã§URLã‚’ç¶­æŒ
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }

  // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸæ™‚ã«èµ¤å¸¯ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼
  function makeWrappedHTML(userHtml, inNewTab=false){
    const prelude = `<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  ._err{position:fixed;left:0;right:0;top:0;padding:10px 12px;background:#ff6b6b;color:#1a0f12;font-family:system-ui;z-index:99999;
    border-bottom:2px solid #c23b3b;box-shadow:0 8px 22px rgba(0,0,0,.25)}
  ._err b{margin-right:8px}
</style>
<script>
(function(){
  function bar(msg){
    var d = document.createElement('div'); d.className='_err';
    d.innerHTML = '<b>ã‚¨ãƒ©ãƒ¼</b>' + String(msg);
    document.body.appendChild(d);
    setTimeout(()=>{ d.remove(); }, 8000);
  }
  window.addEventListener('error', function(e){ bar(e.message||e.error); });
  window.addEventListener('unhandledrejection', function(e){ bar((e.reason&&e.reason.message)||e.reason||'Unhandled Rejection'); });
})();<\/script>`;
    const postlude = `</html>`;
    // ãã®ã¾ã¾çµåˆï¼ˆ<!doctype â€¦> ã§å§‹ã¾ã£ã¦ã„ã¦ã‚‚å•é¡Œãªã—ï¼‰
    return prelude + '\n' + userHtml + '\n' + postlude;
  }

  // å°ã•ãªãƒˆãƒ¼ã‚¹ãƒˆ
  let toastT = 0, toastEl;
  function flash(text){
    if(!toastEl){
      toastEl = document.createElement('div');
      Object.assign(toastEl.style,{
        position:'fixed',left:'50%',bottom:'calc(18px + env(safe-area-inset-bottom))',
        transform:'translateX(-50%)',background:'rgba(14,22,46,.95)',color:'#e6ecff',
        padding:'10px 14px',borderRadius:'12px',border:'1px solid #1b2742',
        boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:999999,fontSize:'13px'
      });
      document.body.appendChild(toastEl);
    }
    toastEl.textContent = text;
    toastEl.style.opacity = '1';
    clearTimeout(toastT);
    toastT = setTimeout(()=>toastEl.style.opacity='0', 1800);
  }

  // iPhoneå‘ã‘ï¼šå®Ÿè¡Œç›´å¾Œã«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒé‚ªé­”ãªå ´åˆã®é…æ…®
  document.addEventListener('touchend', (e)=>{
    const t = e.target;
    if(t===runBtn || t===openBtn){ document.activeElement.blur(); }
  }, {passive:true});
})();
</script>
</body>
</html>
