<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>HTMLシミュレーター（iPhone対応・1ファイル）</title>
<meta name="theme-color" content="#0b1222" />
<style>
  :root{
    --bg:#0b1222; --panel:#0f172a; --text:#e6ecff; --muted:#93a4c6;
    --accent:#6ea8fe; --ok:#35d69b; --warn:#ff6b6b; --btn:#1f2a44; --btn2:#152038;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif}
  .app{min-height:100%;display:flex;flex-direction:column}
  header{padding:12px env(safe-area-inset-right) 12px env(safe-area-inset-left);border-bottom:1px solid #1a2540;background:linear-gradient(180deg,#0c1326,#0b1222)}
  h1{font-size:16px;margin:0;letter-spacing:.03em}
  .sub{font-size:12px;color:var(--muted);margin-top:2px}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button,.ghost{
    appearance:none;border:none;outline:none;border-radius:10px;
    padding:12px 14px;background:var(--btn);color:var(--text);font-weight:600;
    font-size:14px;letter-spacing:.02em;touch-action:manipulation
  }
  button:active{transform:translateY(1px)}
  .run{background:linear-gradient(180deg,#3a9ef7,#1d72f2);color:#041428}
  .open{background:var(--ok);color:#041c14}
  .ghost{background:var(--btn2);opacity:.9}
  .warn{background:var(--warn);color:#1a0f12}

  main{flex:1;display:flex;flex-direction:column;padding:12px env(safe-area-inset-right) 12px env(safe-area-inset-left);gap:12px}
  .editor{
    flex:1;background:var(--panel);border:1px solid #1b2742;border-radius:12px;
    display:flex;flex-direction:column;overflow:hidden;min-height:40vh
  }
  .editor .head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #1b2742;background:#0e162e}
  .editor .head span{font-size:12px;color:var(--muted)}
  select{background:#0e162e;color:var(--text);border:1px solid #1b2742;border-radius:8px;padding:8px}
  textarea{
    flex:1;width:100%;resize:none;background:transparent;color:var(--text);
    border:none;outline:none;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:13px;line-height:1.5
  }

  /* プレビュー画面 */
  .screen{position:fixed;inset:0;display:none;z-index:20;background:#000}
  .screen.active{display:block}
  .screen .topbar{
    position:fixed;top:0;left:0;right:0;display:flex;gap:8px;align-items:center;
    padding:12px calc(10px + env(safe-area-inset-right)) 12px calc(10px + env(safe-area-inset-left));
    background:linear-gradient(180deg,rgba(5,8,16,.95),rgba(5,8,16,.55));
    backdrop-filter:saturate(1.2) blur(6px);-webkit-backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid rgba(110,168,254,.18)
  }
  .screen .topbar button{padding:10px 12px}
  .screen iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0;background:#fff}

  .hint{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>HTMLシミュレーター</h1>
    <div class="sub">テキストにHTML/CSS/JSを入力 → 実行 で表示画面へ遷移（iPhone対応）</div>
    <div class="toolbar">
      <button class="run" id="runBtn">実行してプレビューへ</button>
      <button class="open" id="openTabBtn">新しいタブで開く</button>
      <button class="ghost" id="saveBtn">保存</button>
      <button class="ghost" id="loadBtn">読込</button>
      <button class="ghost warn" id="clearBtn">全消去</button>
    </div>
  </header>

  <main>
    <div class="editor" id="editor">
      <div class="head">
        <span>サンプル：</span>
        <select id="samples">
          <option value="">（選択するとエディタに挿入）</option>
          <option value="hello">Hello, world（最小）</option>
          <option value="canvas">Canvas 花火デモ</option>
          <option value="audio">WebAudio ビープ</option>
        </select>
        <span class="hint">※ローカル保存は端末内（localStorage）。JSはサンドボックス内で動作。</span>
      </div>
      <textarea id="code" spellcheck="false" placeholder="ここにHTMLを書いてください。CSSも&lt;style&gt;、JSも&lt;script&gt;でOKです。&#10;例：&#10;&lt;!doctype html&gt;..."></textarea>
    </div>
    <div class="row">
      <div class="hint">・プレビューは安全のため <code>iframe sandbox</code> で実行します（親ウィンドウのデータへはアクセス不可）。<br>
      ・外部サイトへアクセスするコードはCORS等で制約されることがあります。<br>
      ・エラーはプレビュー内の赤帯で表示されます。</div>
    </div>
  </main>

  <!-- プレビュー画面 -->
  <div class="screen" id="screen">
    <div class="topbar">
      <button id="backBtn">← エディタへ戻る</button>
      <button id="reloadBtn">再実行</button>
      <button id="openAgainBtn">新しいタブで開く</button>
    </div>
    <iframe id="preview" sandbox="allow-scripts allow-forms allow-modals allow-pointer-lock allow-popups allow-downloads allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<script>
(function(){
  const ta = document.getElementById('code');
  const runBtn = document.getElementById('runBtn');
  const openBtn = document.getElementById('openTabBtn');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const samples = document.getElementById('samples');

  const screen = document.getElementById('screen');
  const backBtn = document.getElementById('backBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const openAgainBtn = document.getElementById('openAgainBtn');
  const iframe = document.getElementById('preview');

  const LS_KEY = 'htmlsim_code_v1';

  // デフォルト/前回のコードをロード
  const defaultCode = `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My HTML</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,'Hiragino Sans','Noto Sans JP',sans-serif;background:#101826;color:#e6ecff;display:grid;place-items:center;height:100vh}
  .card{padding:24px;border-radius:16px;background:#111c35;box-shadow:0 12px 40px rgba(0,0,0,.35);text-align:center}
  h1{margin:0 0 6px}
  p{margin:6px 0 0;color:#9fb0d6}
  button{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;background:#35d69b;color:#102016;font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <h1>Hello, world 👋</h1>
    <p>ここに自由にHTML/CSS/JSを書けます。</p>
    <button onclick="alert('実行できてます！')">アラート</button>
  </div>
  <script>
    console.log('コンソール出力の確認');
  <\/script>
</body>
</html>`;

  ta.value = localStorage.getItem(LS_KEY) || defaultCode;

  // サンプル挿入
  samples.addEventListener('change', (e)=>{
    const v = e.target.value;
    if(!v) return;
    const map = {
      hello: defaultCode,
      canvas: `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Canvas Fireworks</title>
<style>html,body{height:100%;margin:0;background:#000}canvas{display:block;width:100%;height:100%}</style>
</head><body><canvas id="cv"></canvas>
<script>
const c=document.getElementById('cv'),x=c.getContext('2d');
function fit(){c.width=innerWidth;c.height=innerHeight} addEventListener('resize',fit);fit();
const pts=[];
function boom(cx,cy){for(let i=0;i<120;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*4;
pts.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:60+Math.random()*30});}}
setInterval(()=>boom(Math.random()*c.width,Math.random()*c.height),700);
function step(){x.fillStyle='rgba(0,0,0,0.2)';x.fillRect(0,0,c.width,c.height);
for(const p of pts){p.x+=p.vx;p.y+=p.vy;p.vy+=0.02;p.life--;
x.fillStyle='hsl('+((p.life*3)%360)+',100%,60%)';x.fillRect(p.x,p.y,2,2);}
for(let i=pts.length-1;i>=0;i--) if(pts[i].life<0) pts.splice(i,1);
requestAnimationFrame(step);} step();
<\/script></body></html>`,
      audio: `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>WebAudio Beep</title>
<style>body{margin:0;height:100vh;display:grid;place-items:center;background:#0e1322;color:#e6ecff;font-family:system-ui}</style>
</head><body>
<button id="b" style="padding:14px 18px;border-radius:12px;border:0;background:#35d69b;color:#102016;font-weight:700">Beep!</button>
<script>
let ctx;document.getElementById('b').onclick=()=>{
  ctx=ctx||new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='square'; o.frequency.value=880; g.gain.value=0.15; o.connect(g).connect(ctx.destination);
  o.start(); setTimeout(()=>o.stop(),180);
};
<\/script></body></html>`
    };
    ta.value = map[v] || ta.value;
    e.target.value = '';
  });

  // 実行：プレビュー画面へ「遷移」
  runBtn.addEventListener('click', ()=>{
    showPreview(ta.value);
  });

  // 新しいタブで開く（ユーザー操作直後のみ許可されやすい）
  openBtn.addEventListener('click', ()=>{
    openInNewTab(ta.value);
  });

  saveBtn.addEventListener('click', ()=>{
    localStorage.setItem(LS_KEY, ta.value);
    flash('保存しました。');
  });

  loadBtn.addEventListener('click', ()=>{
    const v = localStorage.getItem(LS_KEY);
    if(v!=null){ ta.value = v; flash('読み込みました。'); }
    else { flash('保存されたデータがありません。'); }
  });

  clearBtn.addEventListener('click', ()=>{
    if(confirm('エディタ内容を消去します。よろしいですか？')){
      ta.value = '';
    }
  });

  backBtn.addEventListener('click', ()=>{
    screen.classList.remove('active');
    // iOSでキーボード復帰しやすいようフォーカス
    setTimeout(()=>ta.focus(), 50);
  });

  reloadBtn.addEventListener('click', ()=>{
    showPreview(ta.value);
  });

  openAgainBtn.addEventListener('click', ()=>{
    openInNewTab(ta.value);
  });

  // 画面遷移してiframeで実行
  function showPreview(userHtml){
    screen.classList.add('active');
    // エラーバー付きのラッパーを付与（サンドボックス内で動作）
    const wrapper = makeWrappedHTML(userHtml);
    // srcdocに直接入れる
    iframe.srcdoc = wrapper;
  }

  // 新しいタブで実行（Blob URL）
  function openInNewTab(userHtml){
    const blob = new Blob([makeWrappedHTML(userHtml, /*inNewTab*/true)], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    // iOSでブロックされた場合のフォールバック
    if(!w){ flash('ポップアップがブロックされました。「実行」からプレビューをご利用ください。'); }
    // タブを閉じるまでURLを維持
    setTimeout(()=>URL.revokeObjectURL(url), 60000);
  }

  // サンドボックス内でエラーが出た時に赤帯で表示するためのラッパー
  function makeWrappedHTML(userHtml, inNewTab=false){
    const prelude = `<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  ._err{position:fixed;left:0;right:0;top:0;padding:10px 12px;background:#ff6b6b;color:#1a0f12;font-family:system-ui;z-index:99999;
    border-bottom:2px solid #c23b3b;box-shadow:0 8px 22px rgba(0,0,0,.25)}
  ._err b{margin-right:8px}
</style>
<script>
(function(){
  function bar(msg){
    var d = document.createElement('div'); d.className='_err';
    d.innerHTML = '<b>エラー</b>' + String(msg);
    document.body.appendChild(d);
    setTimeout(()=>{ d.remove(); }, 8000);
  }
  window.addEventListener('error', function(e){ bar(e.message||e.error); });
  window.addEventListener('unhandledrejection', function(e){ bar((e.reason&&e.reason.message)||e.reason||'Unhandled Rejection'); });
})();<\/script>`;
    const postlude = `</html>`;
    // そのまま結合（<!doctype …> で始まっていても問題なし）
    return prelude + '\n' + userHtml + '\n' + postlude;
  }

  // 小さなトースト
  let toastT = 0, toastEl;
  function flash(text){
    if(!toastEl){
      toastEl = document.createElement('div');
      Object.assign(toastEl.style,{
        position:'fixed',left:'50%',bottom:'calc(18px + env(safe-area-inset-bottom))',
        transform:'translateX(-50%)',background:'rgba(14,22,46,.95)',color:'#e6ecff',
        padding:'10px 14px',borderRadius:'12px',border:'1px solid #1b2742',
        boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:999999,fontSize:'13px'
      });
      document.body.appendChild(toastEl);
    }
    toastEl.textContent = text;
    toastEl.style.opacity = '1';
    clearTimeout(toastT);
    toastT = setTimeout(()=>toastEl.style.opacity='0', 1800);
  }

  // iPhone向け：実行直後にキーボードが邪魔な場合の配慮
  document.addEventListener('touchend', (e)=>{
    const t = e.target;
    if(t===runBtn || t===openBtn){ document.activeElement.blur(); }
  }, {passive:true});
})();
</script>
</body>
</html>
