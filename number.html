<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Number Ear Gym - æ•°å­—ãƒ»æ—¥ä»˜ãƒ»æ™‚åˆ»ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç‰¹è¨“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#050814;
      --bg2:#060b1c;
      --card:#121826;
      --ink:#e8eefc;
      --muted:#9ba3b8;
      --accent:#4da3ff;
      --accent-soft:rgba(77,163,255,0.16);
      --danger:#ff4d4f;
      --ok:#17c964;
      --border:#252f49;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Meiryo",sans-serif;
      background:radial-gradient(circle at top,var(--bg2),var(--bg));
      color:var(--ink);
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:960px;
      margin:auto;
      padding:16px 16px 20px;
      border-radius:18px;
      background:linear-gradient(145deg,rgba(255,255,255,0.02),rgba(255,255,255,0.04));
      box-shadow:0 20px 45px rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.08);
    }

    header{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
      align-items:flex-end;
    }
    header h1{
      margin:0;
      font-size:1.4rem;
      letter-spacing:0.03em;
    }
    header p{
      margin:2px 0 0;
      font-size:0.82rem;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--accent-soft);
      background:rgba(10,34,71,0.7);
      font-size:0.72rem;
      color:var(--muted);
    }

    .mode-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .mode-label{
      font-size:0.86rem;
      color:var(--muted);
    }
    .mode-pill-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .mode-pill{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(10,23,46,0.9);
      border:1px solid var(--border);
      font-size:0.8rem;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      transition:background .15s,border-color .15s,color .15s,box-shadow .15s;
    }
    .mode-pill input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .mode-pill span.dot{
      width:8px;
      height:8px;
      border-radius:50%;
      border:2px solid var(--muted);
    }
    .mode-pill span.text{
      white-space:nowrap;
    }
    .mode-pill input:checked + .dot{
      border-color:transparent;
      background:var(--accent);
      box-shadow:0 0 10px rgba(77,163,255,0.8);
    }
    .mode-pill input:checked ~ .text{
      color:var(--ink);
    }
    .mode-pill input:checked ~ .pill-bg{
      background:linear-gradient(135deg,rgba(77,163,255,0.25),rgba(15,80,190,0.4));
    }
    .mode-pill .pill-bg{
      position:absolute;
      inset:0;
      border-radius:999px;
      z-index:-1;
      opacity:0.6;
      pointer-events:none;
    }

    .top-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      border-radius:999px;
      padding:8px 18px;
      font-size:0.9rem;
      font-weight:500;
      letter-spacing:0.02em;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:transform .06s,box-shadow .06s,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#4da3ff,#1a6dff);
      color:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,0.45);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(0,0,0,0.55);
    }
    .btn-primary:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(0,0,0,0.4);
    }
    .btn-ghost{
      background:rgba(12,20,40,0.9);
      color:var(--muted);
      border-radius:999px;
      padding-inline:10px;
      font-size:0.78rem;
    }
    .btn-ghost span.dot{
      width:6px;height:6px;border-radius:50%;background:#28c76f;
      box-shadow:0 0 8px rgba(40,199,111,0.8);
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,2.1fr) minmax(0,1.3fr);
      gap:14px;
    }
    @media (max-width:800px){
      .layout{
        grid-template-columns:minmax(0,1fr);
      }
    }

    .card{
      border-radius:16px;
      background:radial-gradient(circle at top left,rgba(255,255,255,0.04),rgba(8,14,32,0.9));
      border:1px solid rgba(255,255,255,0.05);
      padding:14px 14px 16px;
    }

    .card-title{
      font-size:0.9rem;
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
    }
    .card-title strong{ color:var(--ink); }

    .sentence-box{
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px 12px;
      background:rgba(4,10,28,0.9);
      min-height:64px;
      font-size:0.96rem;
      line-height:1.5;
      display:flex;
      align-items:center;
    }
    .sentence-placeholder{
      color:var(--muted);
      font-size:0.86rem;
    }

    .audio-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .btn-audio{
      flex:0 0 auto;
      border-radius:999px;
      padding:6px 12px;
      border:none;
      cursor:pointer;
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(9,22,45,0.9);
      color:var(--ink);
      border:1px solid var(--border);
    }
    .btn-audio small{
      font-size:0.72rem;
      color:var(--muted);
    }

    .choices-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media (max-width:520px){
      .choices-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .choice-btn{
      position:relative;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(9,22,45,0.9);
      color:var(--ink);
      padding:10px 12px;
      cursor:pointer;
      text-align:left;
      font-size:0.95rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      transition:background .12s,border-color .12s,transform .06s,box-shadow .06s;
    }
    .choice-btn span.label{
      font-weight:500;
    }
    .choice-btn span.tag{
      font-size:0.7rem;
      color:var(--muted);
    }
    .choice-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(0,0,0,0.45);
      border-color:var(--accent-soft);
    }
    .choice-btn:active{
      transform:translateY(0);
      box-shadow:0 3px 8px rgba(0,0,0,0.4);
    }
    .choice-btn.correct{
      border-color:rgba(23,201,100,0.9);
      background:linear-gradient(135deg,rgba(23,201,100,0.24),rgba(6,45,29,0.9));
    }
    .choice-btn.wrong{
      border-color:rgba(255,77,79,0.9);
      background:linear-gradient(135deg,rgba(255,77,79,0.2),rgba(45,8,13,0.9));
    }
    .choice-btn.disabled{
      opacity:0.6;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    .feedback{
      margin-top:10px;
      font-size:0.84rem;
      line-height:1.6;
      color:var(--muted);
    }
    .feedback strong{
      color:var(--ink);
    }
    .feedback .good{ color:var(--ok); }
    .feedback .bad{ color:var(--danger); }
    .feedback .script{
      margin-top:4px;
      padding-top:4px;
      border-top:1px dashed var(--border);
      font-size:0.82rem;
      color:var(--muted);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      font-size:0.8rem;
    }
    @media (max-width:520px){
      .stats-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .stat-card{
      border-radius:12px;
      padding:8px 10px;
      border:1px solid var(--border);
      background:rgba(5,12,30,0.95);
    }
    .stat-label{
      color:var(--muted);
      font-size:0.78rem;
    }
    .stat-main{
      display:flex;
      align-items:baseline;
      gap:6px;
      margin-top:3px;
    }
    .stat-main span.value{
      font-size:1.2rem;
      font-weight:600;
    }
    .stat-main span.unit{
      font-size:0.78rem;
      color:var(--muted);
    }
    .stat-detail{
      margin-top:2px;
      font-size:0.72rem;
      color:var(--muted);
    }
    .stat-mode-row{
      display:flex;
      justify-content:space-between;
      font-size:0.76rem;
      margin-top:4px;
    }
    .stat-mode-row span.mode{
      color:var(--muted);
    }
    .stat-mode-row span.rate{
      font-weight:500;
    }

    .hint{
      margin-top:8px;
      font-size:0.78rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Number Ear Gym</h1>
        <p>æ•°å­—ãƒ»æ—¥ä»˜ãƒ»æ™‚åˆ»ã®ã€Œèãå–ã‚Šã€ã«ç‰¹åŒ–ã—ãŸãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</p>
      </div>
      <div class="badge">
        <span>ğŸ§</span>
        <span>ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³æ¨å¥¨ãƒ»PCãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘</span>
      </div>
    </header>

    <div class="mode-row">
      <div class="mode-label">ãƒ¢ãƒ¼ãƒ‰ï¼š</div>
      <div class="mode-pill-group">
        <label class="mode-pill">
          <input type="radio" name="mode" value="mixed" checked>
          <span class="dot"></span>
          <span class="text">ç·åˆ</span>
          <span class="pill-bg"></span>
        </label>
        <label class="mode-pill">
          <input type="radio" name="mode" value="number">
          <span class="dot"></span>
          <span class="text">æ•°å­—ã®ã¿</span>
          <span class="pill-bg"></span>
        </label>
        <label class="mode-pill">
          <input type="radio" name="mode" value="date">
          <span class="dot"></span>
          <span class="text">å¹´æœˆæ—¥</span>
          <span class="pill-bg"></span>
        </label>
        <label class="mode-pill">
          <input type="radio" name="mode" value="time">
          <span class="dot"></span>
          <span class="text">æ™‚åˆ»</span>
          <span class="pill-bg"></span>
        </label>
      </div>
    </div>

    <div class="top-controls">
      <button id="nextBtn" class="btn btn-primary">
        <span>â–¶ å•é¡Œã‚¹ã‚¿ãƒ¼ãƒˆ / æ¬¡ã®å•é¡Œ</span>
      </button>
      <button id="resetStatsBtn" class="btn btn-ghost" title="æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™">
        <span class="dot"></span><span>æˆç¸¾ãƒªã‚»ãƒƒãƒˆ</span>
      </button>
    </div>

    <div class="layout">
      <!-- å·¦ï¼šå•é¡Œï¼†é¸æŠè‚¢ -->
      <section class="card">
        <h2 class="card-title">
          <strong>1. èã &amp; é¸ã¶</strong>
          <span>ï¼ æ–‡ä¸­ã®æ•°å­—ãƒ»æ—¥ä»˜ãƒ»æ™‚é–“ã‚’èãå–ã£ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã‚¿ãƒƒãƒ—</span>
        </h2>

        <div class="sentence-box">
          <div id="sentenceDisplay" class="sentence-placeholder">
            ã€Œå•é¡Œã‚¹ã‚¿ãƒ¼ãƒˆ / æ¬¡ã®å•é¡Œã€ã‚’æŠ¼ã™ã¨è‹±æ–‡ãŒè¡¨ç¤ºã•ã‚Œã€éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div class="audio-row">
          <button id="playNormalBtn" class="btn-audio" type="button">
            <span>â–¶ å†ç”Ÿ</span>
            <small>ãµã¤ã†</small>
          </button>
          <button id="playSlowBtn" class="btn-audio" type="button">
            <span>â–¶ å†ç”Ÿ</span>
            <small>ã‚†ã£ãã‚Š</small>
          </button>
        </div>

        <div class="choices-grid" id="choicesGrid">
          <button class="choice-btn" data-index="0">
            <span class="label">ï¼</span>
            <span class="tag">é¸æŠè‚¢ A</span>
          </button>
          <button class="choice-btn" data-index="1">
            <span class="label">ï¼</span>
            <span class="tag">é¸æŠè‚¢ B</span>
          </button>
          <button class="choice-btn" data-index="2">
            <span class="label">ï¼</span>
            <span class="tag">é¸æŠè‚¢ C</span>
          </button>
          <button class="choice-btn" data-index="3">
            <span class="label">ï¼</span>
            <span class="tag">é¸æŠè‚¢ D</span>
          </button>
        </div>

        <div id="feedback" class="feedback">
          æ­£è§£ãƒ»ä¸æ­£è§£ã®çµæœã‚„ã€è‹±æ–‡ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>
      </section>

      <!-- å³ï¼šæˆç¸¾ãƒ»ãƒ’ãƒ³ãƒˆ -->
      <aside class="card">
        <h2 class="card-title">
          <strong>2. æˆç¸¾ &amp; å¼±ç‚¹</strong>
          <span>ï¼ æ­£ç­”ç‡ã‚’è¦‹ãªãŒã‚‰ã€è‹¦æ‰‹ãƒšã‚¢ã‚’é‡ç‚¹çš„ã«åå¾©</span>
        </h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">å…¨ä½“ã®æ­£ç­”ç‡</div>
            <div class="stat-main">
              <span class="value" id="overallRate">-</span>
              <span class="unit">correct</span>
            </div>
            <div class="stat-detail">
              æ­£è§£ <span id="correctCount">0</span> / å‡ºé¡Œ <span id="totalCount">0</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">ãƒ¢ãƒ¼ãƒ‰åˆ¥ æ­£ç­”ç‡</div>
            <div class="stat-mode-row">
              <span class="mode">æ•°å­—</span>
              <span class="rate" id="numberRate">-</span>
            </div>
            <div class="stat-mode-row">
              <span class="mode">å¹´æœˆæ—¥</span>
              <span class="rate" id="dateRate">-</span>
            </div>
            <div class="stat-mode-row">
              <span class="mode">æ™‚åˆ»</span>
              <span class="rate" id="timeRate">-</span>
            </div>
          </div>
        </div>

        <div class="hint">
          ãƒ»<strong>15 / 50, 13 / 30, 18 / 80</strong> ãªã©ã€Œteen / -tyã€ã®èãåˆ†ã‘ã‚’æ„è­˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚<br>
          ãƒ»å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã¯ JavaScript å†…ã®é…åˆ—ã‚’å¢—ã‚„ã™ã“ã¨ã§ã€è‡ªç”±ã«æ‹¡å¼µã§ãã¾ã™ã€‚
        </div>
      </aside>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // ==========
      // ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬å¤§é‡ï¼‹ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ï¼‰
      // ==========

      // æ•°å­—ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆ15æœ¬ï¼‰
      // rangeMin / rangeMax ã§ãƒ©ãƒ³ãƒ€ãƒ ç¯„å›²ã€preferNumbers ã§å‡ºã‚„ã™ã„æ•°å­—ã‚’æŒ‡å®š
      const numberTemplates = [
        {
          id:"N1",
          template:"We need {NUM} more copies of this document.",
          rangeMin:3, rangeMax:40,
          preferNumbers:[5,10,15,20,25,30,35,40]
        },
        {
          id:"N2",
          template:"The company is planning to hire {NUM} new employees this year.",
          rangeMin:3, rangeMax:50,
          preferNumbers:[5,10,15,20,30,40,50]
        },
        {
          id:"N3",
          template:"They offered us a discount of {NUM} percent.",
          rangeMin:3, rangeMax:60,
          preferNumbers:[5,10,13,15,18,20,25,30,40,50]
        },
        {
          id:"N4",
          template:"Our budget for this project is {NUM} thousand dollars.",
          rangeMin:5, rangeMax:80,
          preferNumbers:[10,15,20,30,50,60,80]
        },
        {
          id:"N5",
          template:"We received {NUM} complaints about the new system.",
          rangeMin:0, rangeMax:50,
          preferNumbers:[3,5,10,13,15,20,30,40]
        },
        {
          id:"N6",
          template:"The warehouse currently holds {NUM} pallets of raw material.",
          rangeMin:5, rangeMax:120,
          preferNumbers:[10,15,20,30,40,50,80,100]
        },
        {
          id:"N7",
          template:"We shipped out {NUM} boxes yesterday.",
          rangeMin:5, rangeMax:80,
          preferNumbers:[10,15,18,20,30,50,60]
        },
        {
          id:"N8",
          template:"The survey was answered by {NUM} customers.",
          rangeMin:10, rangeMax:200,
          preferNumbers:[15,30,50,80,100,150,180,200]
        },
        {
          id:"N9",
          template:"The machine can produce {NUM} units per hour.",
          rangeMin:10, rangeMax:200,
          preferNumbers:[15,30,50,80,100,150,180]
        },
        {
          id:"N10",
          template:"We have worked with this supplier for {NUM} years.",
          rangeMin:1, rangeMax:20,
          preferNumbers:[3,5,10,13,15,18,20]
        },
        {
          id:"N11",
          template:"Sales increased by {NUM} percent compared with last year.",
          rangeMin:1, rangeMax:50,
          preferNumbers:[5,10,13,15,18,20,25,30,40,50]
        },
        {
          id:"N12",
          template:"We need to reduce the defect rate to below {NUM} percent.",
          rangeMin:1, rangeMax:20,
          preferNumbers:[3,5,8,10,13,15,18]
        },
        {
          id:"N13",
          template:"The training session will be limited to {NUM} participants.",
          rangeMin:5, rangeMax:80,
          preferNumbers:[10,15,20,30,40,50,60]
        },
        {
          id:"N14",
          template:"The contract runs for {NUM} months.",
          rangeMin:3, rangeMax:36,
          preferNumbers:[6,12,15,18,24,30,36]
        },
        {
          id:"N15",
          template:"Our team finished the task in {NUM} days.",
          rangeMin:1, rangeMax:30,
          preferNumbers:[2,3,5,10,13,15,18,20,25,30]
        }
      ];

      // æ—¥ä»˜ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆ10æœ¬ï¼‰
      const dateTemplates = [
        {
          id:"D1",
          template:"The meeting is scheduled on {DATE}.",
          months:["January","February","March","April"],
          days:[5,10,13,15,18,20,25,30]
        },
        {
          id:"D2",
          template:"The deadline has been extended to {DATE}.",
          months:["May","June","July","August"],
          days:[10,13,15,18,20,25,28,30]
        },
        {
          id:"D3",
          template:"Our team will visit the client on {DATE}.",
          months:["September","October","November"],
          days:[5,10,13,15,18,20,25,29]
        },
        {
          id:"D4",
          template:"The new system will go live on {DATE}.",
          months:["January","March","June","October"],
          days:[3,10,13,15,18,21,25,30]
        },
        {
          id:"D5",
          template:"Please submit your report by {DATE}.",
          months:["February","March","April","May"],
          days:[5,10,13,15,18,20,24,28]
        },
        {
          id:"D6",
          template:"The factory tour is planned for {DATE}.",
          months:["June","July","September"],
          days:[5,10,13,15,18,22,25,30]
        },
        {
          id:"D7",
          template:"The contract will be signed on {DATE}.",
          months:["January","April","July","November"],
          days:[5,10,13,15,18,20,25,30]
        },
        {
          id:"D8",
          template:"The maintenance work is scheduled on {DATE}.",
          months:["March","May","August","October"],
          days:[5,10,13,15,18,20,24,27]
        },
        {
          id:"D9",
          template:"Our next review will be held on {DATE}.",
          months:["February","May","September","December"],
          days:[5,10,13,15,18,20,25,30]
        },
        {
          id:"D10",
          template:"The training program will start on {DATE}.",
          months:["January","April","September"],
          days:[5,10,13,15,18,20,23,27]
        }
      ];

      // æ™‚åˆ»ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆ10æœ¬ï¼‰
      const timeTemplates = [
        {
          id:"T1",
          template:"The meeting will start at {TIME}.",
          hours:[8,9,10,11,13,14,15],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T2",
          template:"The train to Tokyo departs at {TIME}.",
          hours:[6,7,8,9,10,11],
          minutes:[5,10,15,30,40,50]
        },
        {
          id:"T3",
          template:"The store closes at {TIME}.",
          hours:[18,19,20,21],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T4",
          template:"The conference call will begin at {TIME}.",
          hours:[7,8,9,10,11,16,17],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T5",
          template:"Our team usually has lunch at {TIME}.",
          hours:[11,12,13,14],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T6",
          template:"The first shift starts at {TIME}.",
          hours:[6,7,8,9],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T7",
          template:"The last bus leaves at {TIME}.",
          hours:[20,21,22,23],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T8",
          template:"The presentation is scheduled for {TIME}.",
          hours:[9,10,11,13,14,15,16],
          minutes:[0,10,15,30,40,50]
        },
        {
          id:"T9",
          template:"The delivery is expected to arrive at {TIME}.",
          hours:[9,10,11,14,15,16,17],
          minutes:[0,10,15,30,45,50]
        },
        {
          id:"T10",
          template:"The customer service line opens at {TIME}.",
          hours:[8,9,10],
          minutes:[0,10,15,30,45,50]
        }
      ];

      // teen / -ty ã®èãé–“é•ãˆãƒšã‚¢ï¼ˆæ•°å­—ç”¨ï¼‰
      const CONFUSABLE_MAP = {
        13:[30],
        14:[40],
        15:[50,5],
        16:[60],
        17:[70],
        18:[80],
        19:[90],
        30:[13],
        40:[14],
        50:[15,5],
        60:[16],
        70:[17],
        80:[18],
        90:[19]
      };

      // æ™‚åˆ»ã®åˆ†ç”¨ï¼ˆ15 vs 50 ãªã©ï¼‰
      const MINUTE_CONF_MAP = {
        13:[30],
        15:[50],
        30:[13],
        50:[15]
      };

      // ==========
      // DOM å–å¾—
      // ==========
      const modeRadios = Array.from(document.querySelectorAll('input[name="mode"]'));
      const nextBtn = document.getElementById("nextBtn");
      const resetStatsBtn = document.getElementById("resetStatsBtn");

      const sentenceDisplay = document.getElementById("sentenceDisplay");
      const playNormalBtn = document.getElementById("playNormalBtn");
      const playSlowBtn = document.getElementById("playSlowBtn");

      const choiceButtons = Array.from(document.querySelectorAll(".choice-btn"));
      const feedbackEl = document.getElementById("feedback");

      const overallRateEl = document.getElementById("overallRate");
      const totalCountEl = document.getElementById("totalCount");
      const correctCountEl = document.getElementById("correctCount");
      const numberRateEl = document.getElementById("numberRate");
      const dateRateEl = document.getElementById("dateRate");
      const timeRateEl = document.getElementById("timeRate");

      // ==========
      // çŠ¶æ…‹ç®¡ç†
      // ==========
      const LS_KEY = "numberEarGymStats_v1";

      function createEmptyStats(){
        return {
          total:0,
          correct:0,
          byMode:{
            number:{total:0,correct:0},
            date:{total:0,correct:0},
            time:{total:0,correct:0}
          }
        };
      }

      let stats = createEmptyStats();

      function loadStats(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return;
          const obj = JSON.parse(raw);
          if(!obj || typeof obj !== "object") return;
          stats = createEmptyStats();
          if(typeof obj.total === "number") stats.total = obj.total;
          if(typeof obj.correct === "number") stats.correct = obj.correct;
          ["number","date","time"].forEach(m=>{
            if(obj.byMode && obj.byMode[m]){
              const s = obj.byMode[m];
              if(typeof s.total === "number") stats.byMode[m].total = s.total;
              if(typeof s.correct === "number") stats.byMode[m].correct = s.correct;
            }
          });
        }catch(e){
          console.warn("Failed to load stats:", e);
        }
      }

      function saveStats(){
        try{
          localStorage.setItem(LS_KEY, JSON.stringify(stats));
        }catch(e){
          console.warn("Failed to save stats:", e);
        }
      }

      function resetStats(){
        if(!confirm("æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
          return;
        }
        stats = createEmptyStats();
        saveStats();
        updateStatsView();
      }

      function formatRate(total, correct){
        if(!total) return "-";
        const p = Math.round((correct / total) * 100);
        return p + "%";
      }

      function updateStatsView(){
        overallRateEl.textContent = formatRate(stats.total, stats.correct);
        totalCountEl.textContent = stats.total;
        correctCountEl.textContent = stats.correct;

        numberRateEl.textContent = formatRate(stats.byMode.number.total, stats.byMode.number.correct);
        dateRateEl.textContent   = formatRate(stats.byMode.date.total, stats.byMode.date.correct);
        timeRateEl.textContent   = formatRate(stats.byMode.time.total, stats.byMode.time.correct);
      }

      // ==========
      // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
      // ==========
      function pickRandom(arr){
        return arr[Math.floor(Math.random()*arr.length)];
      }

      function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [a[i],a[j]]=[a[j],a[i]];
        }
        return a;
      }

      function getRandomInt(min, max){
        const lo = Math.ceil(min);
        const hi = Math.floor(max);
        return Math.floor(Math.random()*(hi-lo+1))+lo;
      }

      function getSelectedMode(){
        const checked = modeRadios.find(r => r.checked);
        return checked ? checked.value : "mixed";
      }

      function ordinalSuffix(d){
        const j = d % 10;
        const k = d % 100;
        if(j === 1 && k !== 11) return "st";
        if(j === 2 && k !== 12) return "nd";
        if(j === 3 && k !== 13) return "rd";
        return "th";
      }

      // ==========
      // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
      // ==========
      function randomNumberForTemplate(t){
        const hasRange = typeof t.rangeMin === "number" && typeof t.rangeMax === "number";
        let n;
        if(hasRange && Math.random() < 0.5){
          n = getRandomInt(t.rangeMin, t.rangeMax);
        }else if(Array.isArray(t.preferNumbers) && t.preferNumbers.length){
          n = pickRandom(t.preferNumbers);
        }else if(hasRange){
          n = getRandomInt(t.rangeMin, t.rangeMax);
        }else{
          n = 1;
        }
        if(n <= 0) n = 1;
        return n;
      }

      function randomDateForTemplate(t){
        const months = t.months && t.months.length ? t.months : ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const days = t.days && t.days.length ? t.days : [5,10,13,15,18,20,25,30];
        const month = pickRandom(months);
        const day = pickRandom(days);
        const str = month + " " + day + ordinalSuffix(day);
        return {month, day, str};
      }

      function randomTimeForTemplate(t){
        const hours = t.hours && t.hours.length ? t.hours : [8,9,10,11,13,14,15];
        const minutes = t.minutes && t.minutes.length ? t.minutes : [0,10,15,30,45,50];
        const hour = pickRandom(hours);
        const minute = pickRandom(minutes);
        const str = hour + ":" + String(minute).padStart(2,"0");
        return {hour, minute, str};
      }

      // ==========
      // é¸æŠè‚¢ç”Ÿæˆ
      // ==========
      function buildNumberChoices(correctNum, template){
        const correct = Number(correctNum);

        const basePoolSet = new Set();
        if(Array.isArray(template.preferNumbers)){
          template.preferNumbers.forEach(v => basePoolSet.add(v));
        }
        basePoolSet.add(correct);

        if(typeof template.rangeMin === "number" && typeof template.rangeMax === "number"){
          const neighbors = [correct-1,correct+1,correct-2,correct+2,correct-5,correct+5,correct-10,correct+10];
          neighbors.forEach(v=>{
            if(v >= template.rangeMin && v <= template.rangeMax){
              basePoolSet.add(v);
            }
          });
        }

        const basePool = Array.from(basePoolSet);
        const choiceSet = new Set();
        choiceSet.add(String(correct));

        const confs = CONFUSABLE_MAP[correct];
        if(Array.isArray(confs)){
          confs.forEach(v=>{
            if(basePool.indexOf(v) !== -1){
              choiceSet.add(String(v));
            }
          });
        }

        const others = basePool.filter(v => v !== correct);
        const sortedByNear = others.slice().sort((a,b)=>Math.abs(a-correct)-Math.abs(b-correct));
        for(const v of sortedByNear){
          if(choiceSet.size >= 4) break;
          choiceSet.add(String(v));
        }

        if(typeof template.rangeMin === "number" && typeof template.rangeMax === "number"){
          let guard = 0;
          while(choiceSet.size < 4 && guard < 50){
            guard++;
            const steps = [1,2,5,10];
            const step = pickRandom(steps);
            const sign = Math.random() < 0.5 ? -1 : 1;
            let cand = correct + sign*step;
            if(cand < template.rangeMin) cand = template.rangeMin;
            if(cand > template.rangeMax) cand = template.rangeMax;
            if(cand !== correct) choiceSet.add(String(cand));
          }
        }else{
          const fallback = [5,10,13,14,15,18,20,25,30,40,50,60,70,80,90,100,150];
          const fbShuffled = shuffle(fallback);
          for(const v of fbShuffled){
            if(choiceSet.size >= 4) break;
            if(v !== correct) choiceSet.add(String(v));
          }
        }

        const result = Array.from(choiceSet);
        return shuffle(result).slice(0,4);
      }

      function buildDateChoices(correctDateObj, template){
        const correctStr = correctDateObj.str;
        const month = correctDateObj.month;
        const day = correctDateObj.day;
        const choiceSet = new Set();
        choiceSet.add(correctStr);

        const days = template.days && template.days.length ? template.days : [5,10,13,15,18,20,25,30];
        const months = template.months && template.months.length ? template.months : ["January","February","March","April","May","June","July","August","September","October","November","December"];

        const otherDays = shuffle(days.filter(d => d !== day));
        for(const d of otherDays){
          if(choiceSet.size >= 4) break;
          const s = month + " " + d + ordinalSuffix(d);
          choiceSet.add(s);
        }

        if(choiceSet.size < 4){
          const otherMonths = shuffle(months.filter(m => m !== month));
          for(const m of otherMonths){
            if(choiceSet.size >= 4) break;
            const s = m + " " + day + ordinalSuffix(day);
            choiceSet.add(s);
          }
        }

        let guard = 0;
        while(choiceSet.size < 4 && guard < 50){
          guard++;
          const m = pickRandom(months);
          const d = pickRandom(days);
          const s = m + " " + d + ordinalSuffix(d);
          choiceSet.add(s);
        }

        return shuffle(Array.from(choiceSet)).slice(0,4);
      }

      function buildTimeChoices(correctTimeObj, template){
        const correctStr = correctTimeObj.str;
        const h = correctTimeObj.hour;
        const m = correctTimeObj.minute;
        const choiceSet = new Set();
        choiceSet.add(correctStr);

        const minutes = template.minutes && template.minutes.length ? template.minutes : [0,10,15,30,45,50];
        const hours = template.hours && template.hours.length ? template.hours : [6,7,8,9,10,11,12,13,14,15,16,17,18];

        const confs = MINUTE_CONF_MAP[m] || [];
        confs.forEach(cm=>{
          if(minutes.indexOf(cm) !== -1){
            const s = h + ":" + String(cm).padStart(2,"0");
            choiceSet.add(s);
          }
        });

        const otherMins = shuffle(minutes.filter(v => v !== m));
        for(const mm of otherMins){
          if(choiceSet.size >= 4) break;
          const s = h + ":" + String(mm).padStart(2,"0");
          choiceSet.add(s);
        }

        const hourNeighbors = [h-1,h+1];
        for(const hh of hourNeighbors){
          if(choiceSet.size >= 4) break;
          if(hh < 0 || hh > 23) continue;
          const s = hh + ":" + String(m).padStart(2,"0");
          choiceSet.add(s);
        }

        let guard = 0;
        while(choiceSet.size < 4 && guard < 50){
          guard++;
          const hh = pickRandom(hours);
          const mm = pickRandom(minutes);
          const s = hh + ":" + String(mm).padStart(2,"0");
          if(s !== correctStr){
            choiceSet.add(s);
          }
        }

        return shuffle(Array.from(choiceSet)).slice(0,4);
      }

      // ==========
      // å‡ºé¡Œãƒ­ã‚¸ãƒƒã‚¯
      // ==========
      let currentQuestion = null;
      let questionActive = false;

      function clearChoiceStyles(){
        choiceButtons.forEach(btn=>{
          btn.classList.remove("correct","wrong","disabled");
        });
      }

      function setChoicesEnabled(enabled){
        choiceButtons.forEach(btn=>{
          if(enabled){
            btn.classList.remove("disabled");
          }else{
            btn.classList.add("disabled");
          }
        });
      }

      function createQuestion(){
        const mode = getSelectedMode();
        const actualMode = mode === "mixed" ? pickRandom(["number","date","time"]) : mode;

        let template;
        let sentence = "";
        let correct = "";
        let choices = [];
        let displayModeLabel = "";

        if(actualMode === "number"){
          template = pickRandom(numberTemplates);
          const num = randomNumberForTemplate(template);
          correct = String(num);
          sentence = template.template.replace("{NUM}", correct);
          choices = buildNumberChoices(num, template);
          displayModeLabel = "æ•°å­—";
        }else if(actualMode === "date"){
          template = pickRandom(dateTemplates);
          const dObj = randomDateForTemplate(template);
          correct = dObj.str;
          sentence = template.template.replace("{DATE}", correct);
          choices = buildDateChoices(dObj, template);
          displayModeLabel = "å¹´æœˆæ—¥";
        }else{
          template = pickRandom(timeTemplates);
          const tObj = randomTimeForTemplate(template);
          correct = tObj.str;
          sentence = template.template.replace("{TIME}", correct);
          choices = buildTimeChoices(tObj, template);
          displayModeLabel = "æ™‚åˆ»";
        }

        currentQuestion = {
          mode:actualMode,
          sentence:sentence,
          correct:correct,
          choices:choices
        };

        // â˜…ã“ã“ã‚’å¤‰æ›´ï¼šå‡ºé¡Œæ™‚ã¯è‹±æ–‡ã‚’éš ã—ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã ã‘è¡¨ç¤º
sentenceDisplay.textContent = "éŸ³å£°ã‚’ã‚ˆãèã„ã¦ã€æ­£ã—ã„æ•°å­—ãƒ»æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ï¼ˆè‹±æ–‡ã¯å›ç­”å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰";

        clearChoiceStyles();

        if(choices.length < choiceButtons.length){
          while(choices.length < choiceButtons.length){
            choices.push("-");
          }
        }
        choiceButtons.forEach((btn, idx)=>{
          const labelSpan = btn.querySelector(".label");
          const tagSpan = btn.querySelector(".tag");
          labelSpan.textContent = choices[idx] != null ? choices[idx] : "-";
          const tagLetter = String.fromCharCode(65 + idx);
          tagSpan.textContent = "é¸æŠè‚¢ " + tagLetter;
        });

        feedbackEl.innerHTML =
          "<span>ãƒ¢ãƒ¼ãƒ‰ï¼š<strong>" + displayModeLabel +
          "</strong> ï¼ æ•°å­—ãƒ»æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’ã‚ˆãèã„ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</span>";

        questionActive = true;
        setChoicesEnabled(true);

        speakCurrentSentence(1.0);
      }

      // ==========
      // éŸ³å£°èª­ã¿ä¸Šã’
      // ==========
      let selectedVoice = null;

      function pickVoice(){
        if(!("speechSynthesis" in window)) return null;
        const voices = window.speechSynthesis.getVoices();
        if(!voices || !voices.length) return null;

        const enVoices = voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith("en"));
        const prefs = ["Samantha","Karen","Daniel","Alex","Microsoft","Google US English"];

        for(const name of prefs){
          const found = enVoices.find(v=>v.name.indexOf(name) !== -1);
          if(found) return found;
        }
        return enVoices[0] || voices[0];
      }

      function initVoices(){
        if(!("speechSynthesis" in window)) return;
        selectedVoice = pickVoice();
        if(!selectedVoice){
          setTimeout(function(){
            selectedVoice = pickVoice();
          },500);
        }
      }

      function speakCurrentSentence(rate){
        if(!currentQuestion) return;
        if(!("speechSynthesis" in window)){
          alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const s = currentQuestion.sentence;
        if(!s) return;

        window.speechSynthesis.cancel();

        const utt = new SpeechSynthesisUtterance(s);
        utt.rate = rate || 1.0;
        utt.lang = "en-US";
        if(selectedVoice) utt.voice = selectedVoice;
        window.speechSynthesis.speak(utt);
      }

      // ==========
      // å›ç­”å‡¦ç†
      // ==========
      function handleChoiceClick(btn){
        if(!questionActive || !currentQuestion) return;

        questionActive = false;
        setChoicesEnabled(false);

        const chosen = btn.querySelector(".label").textContent.trim();
        const correct = currentQuestion.correct;

        const isCorrect = (chosen === correct);

        stats.total += 1;
        const m = currentQuestion.mode;
        if(stats.byMode[m]){
          stats.byMode[m].total += 1;
        }
        if(isCorrect){
          stats.correct += 1;
          if(stats.byMode[m]){
            stats.byMode[m].correct += 1;
          }
        }
        saveStats();
        updateStatsView();

        clearChoiceStyles();
        choiceButtons.forEach(b=>{
          const label = b.querySelector(".label").textContent.trim();
          if(label === correct){
            b.classList.add("correct");
          }else{
            b.classList.add("disabled");
          }
        });
        if(!isCorrect){
          btn.classList.remove("disabled");
          btn.classList.add("wrong");
        }

        const msg = isCorrect
          ? "<span class='good'><strong>âœ… æ­£è§£ã§ã™ï¼</strong></span>"
          : "<span class='bad'><strong>âŒ æ®‹å¿µï¼</strong> æ­£è§£ã¯ <strong>" + correct + "</strong> ã§ã—ãŸã€‚</span>";

// â˜…ã“ã“ã‚’è¿½åŠ ï¼šå›ç­”å¾Œã«ã¯ã˜ã‚ã¦è‹±æ–‡å…¨æ–‡ã‚’è¡¨ç¤º
sentenceDisplay.textContent = currentQuestion.sentence;

        feedbackEl.innerHTML =
          msg +
          "<div class='script'><strong>è‹±æ–‡:</strong> " +
          currentQuestion.sentence +
          "</div>";
      }

      // ==========
      // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      // ==========
      nextBtn.addEventListener("click", function(){
        createQuestion();
      });

      resetStatsBtn.addEventListener("click", function(){
        resetStats();
      });

      playNormalBtn.addEventListener("click", function(){
        speakCurrentSentence(1.0);
      });

      playSlowBtn.addEventListener("click", function(){
        speakCurrentSentence(0.8);
      });

      choiceButtons.forEach(btn=>{
        btn.addEventListener("click", function(){
          handleChoiceClick(btn);
        });
      });

      if("speechSynthesis" in window){
        window.speechSynthesis.onvoiceschanged = function(){
          initVoices();
        };
      }
      initVoices();
      loadStats();
      updateStatsView();

    })();
  </script>
</body>
</html>
